import{t as c,d as X,e as ee,n as v,f as de,b as W,A as gn,s as la,h as da,j as A,k as qt,o as hn,u as Ie,p as We,q as ua,r as ma,a as pa,c as fa,i as ba,l as ga}from"./auth.js";import{r as yn,l as ha}from"./controller.js";/* empty css   */import{r as ya}from"./customers.js";import{e as va,i as Sa,g as ht,s as Ea,c as Ta,r as vn,m as wa,a as Sn,b as Aa,d as La,D as xa,f as ka,h as Bt,j as Ia,k as _a,u as $a}from"./projectsService.js";import{s as En}from"./events.js";const Ca={limit:200};let x=null,Wt=!1,Gt=!1,Xt=!1,Kt=!1,ot=null,it=null,ct=!1,oe="";function Tn(){const e=document.getElementById("calendar"),t=document.getElementById("calendar-panel")||e?.parentElement||null,n=document.getElementById("calendar-status");return{calendarEl:e,panelEl:t,statusEl:n}}function qa(){return typeof FullCalendar<"u"?FullCalendar:typeof window<"u"&&window.FullCalendar?window.FullCalendar:typeof globalThis<"u"&&globalThis.FullCalendar?globalThis.FullCalendar:null}function he({loading:e=!1,error:t="",empty:n=!1}={}){const{panelEl:a,statusEl:s}=Tn();if(!a||!s)return;const r=typeof t=="string"?t.trim().length>0:!!t,i=!e&&!r&&!!n,o=e||r||i;if(a.classList.toggle("is-loading",e),a.classList.toggle("has-error",r),a.classList.toggle("is-empty",i),!o){s.textContent="";return}let l="";e?l=c("calendar.status.loading","⏳ جارٍ تحميل الحجوزات..."):r?l=typeof t=="string"&&t.trim().length>0?t:c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً."):i&&(l=c("calendar.status.empty","لا توجد حجوزات لعرضها في هذه الفترة.")),s.textContent=l}function lt(){x&&(x.destroy(),x=null)}function Ba(e,t=null){if(!e||typeof e!="object")return null;const n=e.start??e.startDatetime??e.start_datetime??null,a=e.end??e.endDatetime??e.end_datetime??n;if(!n)return null;String(e.status??"").toLowerCase();const s=e.paidStatus??e.paid_status??null,r=e.paid!=null?e.paid:s==="paid",{effectiveConfirmed:i}=vn(e,t),o=e.reservationId??e.reservationCode??e.reservation_code??e.id??n,l=e.customerName??e.customer_name??"";let d=!!e.completed;if(!d&&a){const u=new Date(a);Number.isNaN(u.getTime())||(d=u<new Date)}return{id:e.id??o??n,start:n,end:a||n,paid:r,confirmed:i,completed:d,reservationId:o??"",customerName:l,raw:e}}function wn(e=[]){const{projects:t=[]}=ee(),n=new Map(t.map(a=>[String(a.id),a]));return e.map(a=>{const s=a?.projectId??a?.project_id??null,r=s!=null&&s!==""&&n.get(String(s))||null,i=Ba(a,r);if(!i)return null;const o=Pa({...a,paid:i.paid,confirmed:i.confirmed,completed:i.completed});return{id:i.id,title:"",start:i.start,end:i.end,backgroundColor:o.background,borderColor:o.border,textColor:o.text,display:"auto",extendedProps:{...a,paid:i.paid,confirmed:i.confirmed,completed:i.completed,reservationId:i.reservationId,customerName:i.customerName}}}).filter(Boolean)}function Qt(){return{today:c("calendar.buttons.today","اليوم"),month:c("calendar.buttons.month","شهر"),week:c("calendar.buttons.week","أسبوع"),day:c("calendar.buttons.day","يوم")}}async function Ma(){if(ct)return ht();ct=!0,oe="";try{await va({suppressError:!1,params:Ca})}catch(e){console.error("❌ [calendar] Failed to load reservations for calendar view",e),oe=Sa(e)?e.message:e instanceof Error&&e.message||""}finally{ct=!1}return ht()}function An(e){x&&x.batchRendering(()=>{x.removeAllEvents(),x.addEventSource(e)})}function Ln(e){const t={events:e};typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("calendar:updated",{detail:t})):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("calendar:updated",{detail:t}))}function xn(){const e=ht(),t=wn(e);if(!x){et();return}x.setOption("locale",X()),An(t),_e(),he({loading:!1,error:"",empty:t.length===0}),Ln(t)}function Da(){Wt||(document.addEventListener("language:changed",()=>{x&&x.setOption("locale",X()),et()}),Wt=!0),Gt||(document.addEventListener("reservations:changed",()=>{xn()}),Gt=!0)}function kn(){return typeof window>"u"?"dayGridMonth":window.innerWidth<=768?"listWeek":"dayGridMonth"}function _e(){if(!x)return;const e=kn();x.view?.type!==e&&x.changeView(e),x.updateSize()}function Ra(){Xt||typeof window>"u"||(window.addEventListener("resize",()=>{_e()}),Xt=!0)}function Na(){if(Kt||typeof MutationObserver>"u"||typeof document>"u")return;const e=()=>{it&&clearTimeout(it),it=setTimeout(()=>{x&&xn()},80)};ot=new MutationObserver(e),ot.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),document.body&&ot.observe(document.body,{attributes:!0,attributeFilter:["class"]}),Kt=!0}function Fa(){return typeof document>"u"?!1:document.documentElement?.classList.contains("dark-mode")||document.body?.classList.contains("dark-mode")}function Pa(){return Fa()?{background:"linear-gradient(135deg, rgba(59, 130, 246, 0.35), rgba(30, 58, 138, 0.7))",border:"rgba(59, 130, 246, 0.5)",text:"#e2e8f0"}:{background:"linear-gradient(135deg, #4361ee, #3a0ca3)",border:"#240c62",text:"#ffffff"}}function ja(e){const{reservationId:t,customerName:n,paid:a,confirmed:s,completed:r}=e.event.extendedProps,i=a===!0||a==="paid",o=s===!0||s==="true",l=document.createElement("div");l.className="fc-reservation-event";const d=o?c("calendar.badges.confirmed","مؤكد"):c("calendar.badges.pending","غير مؤكد"),u=i?c("calendar.badges.paid","مدفوع"):c("calendar.badges.unpaid","غير مدفوع"),m=c("calendar.badges.completed","منتهي"),p=c("calendar.labels.unknownCustomer","غير معروف");return l.innerHTML=`
    <div class="fc-reservation-id">${t}</div>
    <div class="fc-reservation-customer">${n||p}</div>
    <div class="fc-reservation-tags">
      <span class="badge ${o?"bg-success":"bg-warning text-dark"}">${d}</span>
      <span class="badge ${i?"bg-primary":"bg-danger"}">${u}</span>
      ${r?`<span class="badge bg-secondary">${m}</span>`:""}
    </div>
  `,{domNodes:[l]}}function Ha(e){const t=document.getElementById("calendar-reservation-details");if(!t){alert(c("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"));return}const n=e.confirmed===!0||e.confirmed==="true",a=e.paid===!0||e.paid==="paid",s=!!e.completed,r=n?c("calendar.badges.confirmed","مؤكد"):c("calendar.badges.pending","غير مؤكد"),i=a?c("calendar.badges.paid","مدفوع"):c("calendar.badges.unpaid","غير مدفوع"),o=c("calendar.badges.completed","منتهي"),l=X(),d=e.items||[],u=Ea()||[],m=new Map(u.map(y=>[String(y.id),y])),p=(e.technicians||[]).map(y=>m.get(String(y))).filter(Boolean),b=Ta(e.start,e.end),E=d.reduce((y,M)=>y+(M.qty||1)*(M.price||0),0)*b,S=(y={})=>{const M=[y.dailyWage,y.daily_rate,y.dailyRate,y.wage,y.rate];for(const xe of M){if(xe==null)continue;const Re=parseFloat(v(String(xe)));if(Number.isFinite(Re))return Re}return 0},L=p.reduce((y,M)=>y+S(M),0)*b,U=E+L,F=(()=>{const y=parseFloat(e.discount)||0;return y?e.discountType==="amount"?y:U*(y/100):0})(),ne=Math.max(0,U-F),ae=e.applyTax?ne*.15:0,V=e.cost??Math.round(ne+ae),B=c("calendar.labels.currencySuffix","ريال"),K=d.length?d.map((y,M)=>{const xe=y.image||y.imageUrl||y.img||"",Re=v(String(y.barcode||"-")),oa=v(String(y.qty||1)),ia=v(String(y.price||0)),ca=xe?`<img src="${xe}" alt="${y.desc||""}" class="reservation-modal-item-thumb">`:"-";return`
          <tr>
            <td>${v(String(M+1))}</td>
            <td>${Re}</td>
            <td>${y.desc||"-"}</td>
            <td>${oa}</td>
            <td>${ia} ${B}</td>
            <td>${ca}</td>
          </tr>
        `}).join(""):`<tr><td colspan="6" class="text-center">${c("calendar.labels.noEquipment","لا توجد معدات")}</td></tr>`,Q=[`<div>${c("calendar.summary.baseCost","💵 إجمالي المعدات: <strong>{value} ريال</strong>").replace("{value}",E.toFixed(2))}</div>`,`<div>${c("calendar.summary.crewTotal","😎 إجمالي الفريق: <strong>{value} ريال</strong>").replace("{value}",L.toFixed(2))}</div>`,`<div>${c("calendar.summary.duration","⏱️ عدد الأيام: <strong>{value}</strong>").replace("{value}",v(String(b)))}</div>`];if(F>0){const y=l==="en"?"%":"٪",M=e.discountType==="percent"?`${parseFloat(e.discount||0).toFixed(2)}${y}`:`${F.toFixed(2)} ${B}`;Q.push(`<div>${c("calendar.summary.discount","💸 الخصم: <strong>{value}</strong>").replace("{value}",M)}</div>`)}e.applyTax&&ae>0&&Q.push(`<div>${c("calendar.summary.tax","🧾 الضريبة (15%): <strong>{value} ريال</strong>").replace("{value}",ae.toFixed(2))}</div>`),Q.push(`<div>${c("calendar.summary.total","💰 المجموع النهائي: <strong>{value} ريال</strong>").replace("{value}",V.toFixed(2))}</div>`);const st=v(String(e.reservationId??e.id??"")),ta=e.start?v(de(e.start)):"-",na=e.end?v(de(e.end)):"-",aa=e.notes?v(e.notes):c("calendar.labels.noNotes","لا توجد ملاحظات"),ra=e.customerName||c("calendar.labels.unknownCustomer","غير معروف"),sa=[{icon:"🆔",label:c("calendar.labels.reservationId","رقم الحجز"),value:st},{icon:"👤",label:c("calendar.labels.customer","العميل"),value:ra},{icon:"🗓️",label:c("calendar.labels.start","بداية الحجز"),value:ta},{icon:"🗓️",label:c("calendar.labels.end","نهاية الحجز"),value:na},{icon:"📝",label:c("calendar.labels.notes","الملاحظات"),value:aa}];t.innerHTML=`
    <div class="calendar-reservation-status mb-3">
      <span class="badge ${n?"bg-success":"bg-warning text-dark"}">${r}</span>
      <span class="badge ${a?"bg-primary":"bg-danger"}">${i}</span>
      ${s?`<span class="badge bg-secondary">${o}</span>`:""}
    </div>
    <div class="calendar-reservation-info">
      ${sa.map(y=>`
        <div class="calendar-info-row">
          <span class="label">${y.icon} ${y.label}</span>
          <span class="value">${y.value}</span>
        </div>
      `).join("")}
    </div>
    <h6 class="calendar-section-title">${c("calendar.sections.crew","😎 الفريق الفني")}</h6>
    ${p.length?`<ul class="list-unstyled calendar-reservation-technicians">${p.map(y=>{const M=y.role?` — ${y.role}`:"";return`<li><strong>${y.name}</strong>${M}</li>`}).join("")}</ul>`:`<p class="calendar-empty-state">${c("calendar.emptyStates.noCrew","😎 لا يوجد فريق مرتبط بهذا الحجز.")}</p>`}
    <h6 class="calendar-section-title">${c("calendar.sections.equipment","📦 المعدات")}</h6>
    <div class="table-responsive reservation-modal-items-wrapper">
      <table class="table table-sm table-hover align-middle reservation-modal-items-table">
        <thead>
          <tr>
            <th>#</th>
            <th>${c("calendar.table.headers.barcode","الباركود")}</th>
            <th>${c("calendar.table.headers.description","الوصف")}</th>
            <th>${c("calendar.table.headers.quantity","الكمية")}</th>
            <th>${c("calendar.table.headers.price","السعر")}</th>
            <th>${c("calendar.table.headers.image","الصورة")}</th>
          </tr>
        </thead>
        <tbody>${K}</tbody>
      </table>
    </div>
    <div class="calendar-reservation-summary">
      ${Q.join("")}
    </div>
  `;const Yt=document.getElementById("calendarReservationModal");Yt&&window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(Yt).show():alert(c("calendar.alerts.cannotOpenModal","لا يمكن فتح نافذة التفاصيل"))}function et(){Da(),Ra(),Na();const{calendarEl:e}=Tn();if(!e)return;const t=qa();if(!t||typeof t.Calendar!="function"){const n=c("calendar.status.missingLibrary","تعذر تحميل مكتبة التقويم. يرجى تحديث الصفحة.");he({error:n}),lt();return}(async()=>{he({loading:!0});const n=await Ma();if(oe){const s=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");he({loading:!1,error:oe||s}),lt();return}const a=wn(n);x?(x.setOption("locale",X()),x.setOption("buttonText",Qt()),An(a)):(x=new t.Calendar(e,{initialView:kn(),locale:X(),timeZone:"local",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},buttonText:Qt(),events:a,eventContent:ja,eventClick(s){Ha(s.event.extendedProps)},windowResize:_e}),x.render()),_e(),Ln(a),he({loading:!1,error:"",empty:a.length===0}),setTimeout(()=>{_e()},120)})().catch(n=>{console.error("❌ [calendar] renderCalendar failed",n),oe=n instanceof Error&&n.message||oe||"";const a=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");he({loading:!1,error:oe||a}),lt()})}let yt=null,He=null,Oe=null;const g={range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null};let Zt=!1,Jt=!1,ve=null;const T={reservations:[],customers:[],equipment:[],technicians:[],projects:[],projectsMap:new Map};let ze=!1,Ge="";const D={icon:null,title:null,subtitle:null};let en=!1;const dt=new Map;let ut=null,mt=null,pt=null,Se=null;const w={trend:null,status:null,payment:null},re={filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[]},vt={code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0};let tn=!1,nn=!1,an=!1,In=[],ft=[],bt=[],rn=!1,P=null,j=null,sn=null,on=null;function f(e,t,n=t){const a=X()==="en"?n??t:t;return c(e,a)}function cn(){gt(),I(),setTimeout(()=>{gt(),I(),Ue()},0),setTimeout(()=>{gt(),I(),Ue()},60),Ue()}function ye(){g.range==="custom"&&I()}function gt(){yt=null,He=null,Oe=null}function Mt(){return(X()||"ar").toLowerCase().startsWith("ar")?"ar-EG":"en-US"}function _n(){const e=X();if(e!==yt||!He||!Oe){yt=e;const t=Mt();He=new Intl.NumberFormat(t,{maximumFractionDigits:0}),Oe=new Intl.NumberFormat(t,{style:"currency",currency:"SAR",maximumFractionDigits:0})}return{numberFormatter:He,currencyFormatter:Oe}}function Oa(e){const t=Mt();return new Intl.DateTimeFormat(t,{month:"short"}).format(e)}function St(e){const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return"";const n=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0");return`${n}-${a}-${s}`}function Dt(e){if(dt.has(e))return dt.get(e);const t=document.querySelector(`script[src="${e}"]`),n=new Promise((a,s)=>{const r=()=>{t&&(t.dataset.loaded="true"),a()},i=l=>s(l);if(t){if(t.dataset.loaded==="true"){a();return}t.addEventListener("load",r,{once:!0}),t.addEventListener("error",i,{once:!0});return}const o=document.createElement("script");o.src=e,o.async=!0,o.onload=()=>{o.dataset.loaded="true",a()},o.onerror=l=>s(l),document.head.appendChild(o)});return dt.set(e,n),n}function Rt(){return window.ApexCharts?Promise.resolve(window.ApexCharts):(ut||(ut=Dt("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),ut)}function za(){return window.html2pdf?Promise.resolve(window.html2pdf):(mt||(mt=Dt("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),mt)}function Ua(){return window.XLSX?Promise.resolve(window.XLSX):(pt||(pt=Dt("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),pt)}function Xe(){const e=document.documentElement;return e.classList.contains("dark")||e.dataset.theme==="dark"?"dark":"light"}function $n(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function Cn(e={}){const t=v(String(e?.barcode??"")).trim(),n=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:t,desc:n,description:n,name:e?.name??n,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function qn(e={}){const t=e?.title??e?.name??"",n=e?.project_code??e?.projectCode??"",a=e?.status??"",s=e?.confirmed===!0||Ke(a)==="confirmed"||Ke(a)==="completed";return{id:e?.id!=null?String(e.id):"",title:t,code:n,status:a,confirmed:s}}function Va(){if(typeof ee!="function")return!1;let e;try{e=ee()}catch(o){return console.warn("⚠️ [reports] Failed to access cached data",o),!1}if(!e||typeof e!="object")return!1;const{reservations:t=[],customers:n=[],equipment:a=[],technicians:s=[],projects:r=[]}=e;return t.length||n.length||a.length||s.length||r.length?(T.reservations=Array.isArray(t)?t.map(wa):[],T.customers=Array.isArray(n)?n.map($n):[],T.equipment=Array.isArray(a)?a.map(Cn):[],T.technicians=Array.isArray(s)?s.map(Sn):[],T.projects=Array.isArray(r)?r.map(qn):[],T.projectsMap=new Map(T.projects.map(o=>[o.id,o])),Se=new Map((T.technicians||[]).map(o=>[String(o.id),o])),!0):!1}const Ya=1440*60*1e3;function Wa(e,t){if(!e||!t)return 1;const n=new Date(e),a=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(a.getTime()))return 1;const s=a.getTime()-n.getTime();return s<=0?1:Math.max(1,Math.ceil(s/Ya))}function Ga(e){return e?(Se||(Se=new Map((T.technicians||[]).map(t=>[String(t.id),t]))),Se.get(String(e))||null):null}function Xa(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){if(n==null)continue;const a=Number.parseFloat(v(String(n)));if(Number.isFinite(a))return a}return 0}function De(e){if(!e)return{rentalDays:1,equipmentTotal:0,crewTotal:0,discountAmount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(e.__financials)return e.__financials;const t=Wa(e.start,e.end),a=(e.items||[]).reduce((B,K)=>{const Q=Number(K?.qty)||Number(K?.quantity)||1,st=Number(K?.price)||Number(K?.unit_price)||0;return B+Q*st},0)*t,r=(e.technicians||[]).reduce((B,K)=>{const Q=Ga(K);return B+Xa(Q)},0)*t,i=a+r,o=Number(e.discount)||0;let d=(e.discountType||e.discount_type||"percent")==="amount"?o:i*(o/100);(!Number.isFinite(d)||d<0)&&(d=0),d>i&&(d=i);const u=Math.max(0,i-d),m=e.applyTax===!0||e.apply_tax===!0||e.apply_tax===1||e.apply_tax==="1";let p=m?u*.15:0;(!Number.isFinite(p)||p<0)&&(p=0);const b=Number(e.cost),h=u+p;let E=Math.max(0,Math.round(h));if(Number.isFinite(b)&&b>0&&(E=b,m)){const B=E-u;Number.isFinite(B)&&B>=0&&(p=B)}const S=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share??null,$=S!=null?Number.parseFloat(v(String(S).replace("%","").trim())):NaN,L=e.companyShareEnabled??e.company_share_enabled??e.companyShareApplied??e.company_share_applied??null;let U=L!=null?L===!0||L===1||L==="1"||String(L).toLowerCase()==="true":Number.isFinite($)&&$>0,F=U&&Number.isFinite($)?Number($):0;m&&F<=0&&(F=xa,U=!0);const ne=F>0?Math.max(0,E*(F/100)):0,ae=Math.max(0,E-p-ne),V={rentalDays:t,equipmentTotal:a,crewTotal:r,discountAmount:d,taxableAmount:u,taxAmount:p,finalTotal:E,companySharePercent:F,companyShareAmount:ne,netProfit:ae};return e.__financials=V,V}function Bn(e){return e?.projectId&&T.projectsMap.get(String(e.projectId))||null}function Le(e){const t=Bn(e),n=vn(e,t),a=Ke(n.projectStatus);let s=Ke(e?.status??e?.reservationStatus??e?.reservation_status??e?.state??"");n.projectLinked&&a&&(s=a),(!s||s==="cancelled")&&(s=n.effectiveConfirmed?"confirmed":"pending"),(La(e)||a==="completed")&&(s="completed");const r=n.effectiveConfirmed||s==="confirmed"||s==="completed";r&&s!=="completed"&&(s="confirmed");const i=nr(e);return{statusValue:s,confirmed:r,paid:i}}async function Mn({silent:e=!1}={}){if(!ze){ze=!0,Ge="",e||I();try{const[t,n,a,s,r]=await Promise.all([W("/reservations/?limit=500"),W("/customers/?limit=500"),W("/equipment/?limit=500"),W("/technicians/?limit=500"),W("/projects/?limit=500")]);T.reservations=Array.isArray(t?.data)?t.data.map(i=>Aa(i)):[],T.customers=Array.isArray(n?.data)?n.data.map($n):[],T.equipment=Array.isArray(a?.data)?a.data.map(Cn):[],T.technicians=Array.isArray(s?.data)?s.data.map(Sn):[],T.projects=Array.isArray(r?.data)?r.data.map(qn):[],T.projectsMap=new Map(T.projects.map(i=>[i.id,i])),Se=new Map((T.technicians||[]).map(i=>[String(i.id),i]))}catch(t){console.error("❌ [reports] Failed to load reports data",t),Ge=t instanceof gn?t.message:c("reservations.reports.error.fetchFailed","تعذر تحميل بيانات التقارير، حاول لاحقاً"),T.reservations=[],T.customers=[],T.equipment=[],T.technicians=[],T.projects=[],T.projectsMap=new Map,Se=null}finally{ze=!1,I()}}}function ke(){Mn({silent:!0}).catch(e=>{console.error("❌ [reports] Background refresh failed",e)})}function Et({active:e,icon:t,title:n,subtitle:a}){const s=document.getElementById("reports-empty-state");if(!s)return;const r=s.querySelector(".reports-empty-icon"),i=s.querySelector("h4"),o=s.querySelector("p");D.icon===null&&r&&(D.icon=r.textContent),D.title===null&&i&&(D.title=i.textContent),D.subtitle===null&&o&&(D.subtitle=o.textContent),s.classList.toggle("active",!!e),s.classList.toggle("hidden",!e),!(!r||!i||!o)&&(e?(r.textContent=t!==void 0?t:D.icon??r.textContent,i.textContent=n!==void 0?n:D.title??i.textContent,o.textContent=a!==void 0?a:D.subtitle??o.textContent):(r.textContent=D.icon??r.textContent,i.textContent=D.title??i.textContent,o.textContent=D.subtitle??o.textContent))}function Ka(){if(Zt)return;Zt=!0;const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),n=document.getElementById("reports-payment-filter"),a=document.getElementById("reports-share-filter"),s=document.getElementById("reports-start"),r=document.getElementById("reports-end"),i=document.getElementById("reports-refresh"),o=document.getElementById("reports-custom-range"),l=document.getElementById("reports-search");if(!e)return;e.value=g.range,Va()&&I(),e.addEventListener("change",()=>{g.range=e.value,Tt(o,g.range==="custom"),g.range!=="custom"&&(g.start=null,g.end=null),I()}),t?.addEventListener("change",()=>{g.status=t.value,I()}),n?.addEventListener("change",()=>{g.payment=n.value,I()}),a?.addEventListener("change",()=>{g.share=a.value,I()}),l?.addEventListener("input",()=>{const u=l.value||"";ve&&clearTimeout(ve),ve=setTimeout(()=>{g.search=u,I()},220)}),s?.addEventListener("change",()=>{g.start=s.value||null,ye()}),r?.addEventListener("change",()=>{g.end=r.value||null,ye()}),i?.addEventListener("click",()=>{g.range==="custom"&&(g.start=s?.value||null,g.end=r?.value||null),I()}),Ue(s,r),Tt(o,!1),Jt||(document.addEventListener("language:changed",cn),document.addEventListener("language:translationsReady",cn),Jt=!0),en||(document.addEventListener("reservations:changed",ke),document.addEventListener("customers:changed",ke),document.addEventListener("equipment:changed",ke),document.addEventListener("projects:changed",ke),document.addEventListener("technicians:updated",ke),en=!0),fr(),br(),Sr(),rn||(document.addEventListener("theme:changed",()=>{setTimeout(()=>I(),0)}),rn=!0),Mn()}function tt(){const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),n=document.getElementById("reports-payment-filter"),a=document.getElementById("reports-share-filter"),s=document.getElementById("reports-search"),r=document.getElementById("reports-start"),i=document.getElementById("reports-end"),o=document.getElementById("reports-custom-range");e&&e.value!==g.range&&(e.value=g.range),t&&t.value!==g.status&&(t.value=g.status),n&&n.value!==g.payment&&(n.value=g.payment),a&&a.value!==g.share&&(a.value=g.share),s&&s.value!==g.search&&(s.value=g.search||""),r&&r.value!==(g.start||"")&&(r.value=g.start||""),i&&i.value!==(g.end||"")&&(i.value=g.end||""),Tt(o,g.range==="custom")}function I(){if(tt(),ze){Et({active:!0,icon:"⏳",title:c("reservations.reports.status.loading","جارٍ تحميل التقارير..."),subtitle:c("reservations.reports.status.loadingHint","قد يستغرق هذا بضع ثوانٍ.")});return}if(Ge){Et({active:!0,icon:"⚠️",title:Ge,subtitle:c("reservations.reports.status.retry","جرّب إعادة المحاولة أو تحديث الصفحة.")});return}const{reservations:e,customers:t,equipment:n,technicians:a}=T,s=Za(e,g,t,n,a),r=ar(s),i=rr(s),o=sr(s),l=or(s),d=ir(s,t),u=cr(s,n);Cr(r),Er(i),Tr(o),wr(l),Ar(d),Lr(u);const m=lr(s,t,a);wt(),qr(s.length===0),re.filtered=s,re.metrics=r,re.trend=i,re.statusBreakdown=o,re.paymentBreakdown=l,re.tableRows=m}function Ue(e,t){if(!window.flatpickr)return;e&&(sn=e),t&&(on=t);const n=sn,a=on;if(!n&&!a)return;const s=Qa(),r=i=>{const o={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...i};return s&&(o.locale=s),o};if(P&&(P.destroy(),P=null),j&&(j.destroy(),j=null),n&&(P=window.flatpickr(n,r({onChange(i,o){g.start=o||null,j&&(i?.length?j.set("minDate",i[0]):j.set("minDate",null)),ye()},onValueUpdate(i,o){g.start=o||null,ye()}}))),a&&(j=window.flatpickr(a,r({onChange(i,o){g.end=o||null,P&&(i?.length?P.set("maxDate",i[0]):P.set("maxDate",null)),ye()},onValueUpdate(i,o){g.end=o||null,ye()}}))),P&&n){P.setDate(n.value,!1);const i=j?.selectedDates?.[0]||a?.value;i&&P.set("maxDate",i)}if(j&&a){j.setDate(a.value,!1);const i=P?.selectedDates?.[0]||n?.value;i&&j.set("minDate",i)}}function Qa(){return(X()||"ar").toLowerCase().startsWith("ar")?window.flatpickr?.l10ns?.ar?"ar":null:window.flatpickr?.l10ns?.en?"en":null}function Tt(e,t){e&&(e.classList.toggle("active",!!t),e.classList.toggle("hidden",!t))}function Dn(e){return v(String(e||"")).toLowerCase().trim()}function Za(e,t,n,a,s){const{startDate:r,endDate:i}=er(t),o=Dn(t.search),l=!!o,d=new Map((n||[]).map(p=>[String(p.id),p])),u=new Map((a||[]).map(p=>[Qe(p?.barcode),p])),m=new Map((s||[]).map(p=>[String(p.id),p]));return(e||[]).filter(p=>{const b=p?.start?new Date(p.start):null;if(!b||Number.isNaN(b.getTime())||r&&b<r||i&&b>i)return!1;const{statusValue:h,confirmed:E,paid:S}=Le(p);if(t.status==="confirmed"&&!(h==="confirmed"||h==="completed"||E)||t.status==="pending"&&h!=="pending"||t.status==="completed"&&h!=="completed"||t.payment==="paid"&&!S||t.payment==="unpaid"&&S)return!1;if(t.share&&t.share!=="all"){const L=De(p).companySharePercent>0;if(t.share==="with"&&!L||t.share==="without"&&L)return!1}return!(l&&!Ja(p,o,d,u,m))})}function Ja(e,t,n,a,s){const r=[],i=e?.reservationId||e?.id;i&&r.push(i),e?.notes&&r.push(e.notes);const{statusValue:o,paid:l}=Le(e);o&&r.push(o);const d=e?.paymentStatus||e?.payment_status;d&&r.push(d),e?.paid!=null&&r.push(e.paid?"paid":"unpaid");const u=n.get(String(e?.customerId));u&&r.push(u.customerName,u.company_name||u.companyName,u.contact_person||"");const m=Bn(e);return m&&r.push(m.title,m.code,m.status),r.push(Rn(l)),(e?.items||[]).forEach(b=>{b?.desc&&r.push(b.desc),b?.barcode&&r.push(b.barcode);const h=a.get(Qe(b?.barcode));h&&r.push(h.desc,h.description,h.name)}),(e?.technicians||[]).forEach(b=>{const h=s.get(String(b));h&&r.push(h.name,h.role,h.department)}),Dn(r.filter(Boolean).join(" ")).includes(t)}function er({range:e,start:t,end:n}){const a=new Date;if(a.setHours(23,59,59,999),e==="custom"){const i=t?new Date(`${t}T00:00:00`):null,o=n?new Date(`${n}T23:59:59`):null;return{startDate:ln(i)?i:null,endDate:ln(o)?o:null}}let s=new Date(a),r=null;switch(e){case"last30":{r=new Date(a),r.setDate(r.getDate()-29);break}case"thisWeek":{const i=new Date(a),l=(i.getDay()-6+7)%7;i.setDate(i.getDate()-l),i.setHours(0,0,0,0);const d=new Date(i);d.setDate(i.getDate()+6),d.setHours(23,59,59,999),r=i,s.setTime(d.getTime());break}case"thisMonth":{r=new Date(a.getFullYear(),a.getMonth(),1);const i=new Date(a.getFullYear(),a.getMonth()+1,0);s.setTime(i.setHours(23,59,59,999));break}case"thisQuarter":{const i=Math.floor(a.getMonth()/3);r=new Date(a.getFullYear(),i*3,1);const o=new Date(a.getFullYear(),(i+1)*3,0);s.setTime(o.setHours(23,59,59,999));break}case"thisYear":{r=new Date(a.getFullYear(),0,1);const i=new Date(a.getFullYear(),12,0);s.setTime(i.setHours(23,59,59,999));break}case"all":default:r=null,s=null;break}return r&&r.setHours(0,0,0,0),{startDate:r,endDate:s}}function ln(e){return e instanceof Date&&!Number.isNaN(e.getTime())}const tr=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"]]),dn=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]);function Ke(e=""){const t=String(e).toLowerCase().trim();return t?tr.get(t)||t:""}function nr(e){const t=[e?.paymentStatus,e?.payment_status,e?.payment,e?.paymentState,e?.payment_state];for(const n of t){const a=String(n||"").toLowerCase().trim();if(a&&dn.has(a))return dn.get(a)}return e?.paid===!0||e?.paid==="true"}function ar(e){const t=e.length;let n=0,a=0,s=0,r=0,i=0,o=0,l=0;e.forEach(u=>{const{statusValue:m,confirmed:p,paid:b}=Le(u);m==="completed"&&(a+=1),p&&(n+=1),b&&(s+=1);const h=De(u);r+=h.finalTotal,i+=h.companyShareAmount,o+=h.taxAmount,l+=h.netProfit});const d=t?r/t:0;return{total:t,confirmed:n,completed:a,paidCount:s,revenue:r,average:d,companyShareTotal:i,taxTotal:o,netProfit:l}}function rr(e){const t=new Date,n=[];for(let a=5;a>=0;a-=1){const s=new Date(t.getFullYear(),t.getMonth()-a,1),r=s.getFullYear(),i=s.getMonth(),o=e.filter(E=>{const S=E?.start?new Date(E.start):null;return S&&S.getFullYear()===r&&S.getMonth()===i}),l=o.length;let d=0,u=0,m=0;o.forEach(E=>{const S=De(E);d+=S.finalTotal,u+=S.netProfit,m+=S.companyShareAmount});const p=Oa(s),b=new Date(s.getFullYear(),s.getMonth(),1),h=new Date(s.getFullYear(),s.getMonth()+1,0);n.push({label:p,count:l,revenue:d,netProfit:u,companyShare:m,periodStart:b,periodEnd:h,startInput:St(b),endInput:St(h)})}return n}function sr(e){const t={confirmed:0,pending:0,completed:0};(e||[]).forEach(i=>{const{statusValue:o,confirmed:l}=Le(i);o==="completed"?t.completed+=1:o==="confirmed"||l?t.confirmed+=1:t.pending+=1});const n=Math.max(1,(e||[]).length),a=t.confirmed,s=t.pending,r=t.completed;return[{label:f("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:a,percent:Math.round(a/n*100)||0,rawCount:a,className:"status-confirmed",filterKey:"confirmed"},{label:f("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:s,percent:Math.round(s/n*100)||0,rawCount:s,className:"status-pending",filterKey:"pending"},{label:f("reservations.reports.status.completedLabel","منتهية","Completed"),value:r,percent:Math.round(r/n*100)||0,rawCount:r,className:"status-completed",filterKey:"completed"}]}function or(e){const t=e.length||1,n=e.filter(s=>Le(s).paid).length,a=e.length-n;return[{label:f("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:n,percent:Math.round(n/t*100)||0,rawCount:n,className:"status-paid",filterKey:"paid"},{label:f("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:a,percent:Math.round(a/t*100)||0,rawCount:a,className:"status-unpaid",filterKey:"unpaid"}]}function ir(e,t){const n=new Map,a=new Map((t||[]).map(s=>[String(s.id),s]));return e.forEach(s=>{const r=String(s?.customerId??"unknown"),i=n.get(r)||{count:0,revenue:0},o=De(s);i.count+=1,i.revenue+=o.finalTotal,n.set(r,i)}),Array.from(n.entries()).map(([s,r])=>({name:a.get(s)?.customerName||f("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:r.count,revenue:r.revenue})).sort((s,r)=>r.revenue-s.revenue).slice(0,5)}function cr(e,t){const n=new Map,a=new Map((t||[]).map(s=>[Qe(s?.barcode),s]));return e.forEach(s=>{(s?.items||[]).forEach(r=>{const i=Qe(r?.barcode),o=i||(r?.desc??"unknown"),l=r?.desc||a.get(i)?.desc||a.get(i)?.description||f("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment"),d=Number(r?.qty)||1,u=d*(Number(r?.price)||0),m=n.get(o)||{name:l,count:0,revenue:0};m.name=l,m.count+=d,m.revenue+=u,n.set(o,m)})}),Array.from(n.values()).sort((s,r)=>r.count-s.count).slice(0,5)}function lr(e,t,n){const a=document.getElementById("reports-reservations-body");if(!a)return[];if(!e||e.length===0)return a.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${f("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`,[];const s=new Map((t||[]).map(o=>[String(o.id),o]));new Map((n||[]).map(o=>[String(o.id),o]));const r={code:f("reservations.reports.results.headers.id","الحجز","Reservation"),customer:f("reservations.reports.results.headers.customer","العميل","Customer"),date:f("reservations.reports.results.headers.date","التاريخ","Date"),status:f("reservations.reports.results.headers.status","الحالة","Status"),payment:f("reservations.reports.results.headers.payment","الدفع","Payment"),total:f("reservations.reports.results.headers.total","الإجمالي","Total"),share:f("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:f("reservations.reports.results.headers.net","صافي الربح","Net profit")},i=[...e].sort((o,l)=>new Date(l.start||0)-new Date(o.start||0)).slice(0,20).map(o=>{const l=xr(o,s),d={[r.code]:l.code.text,[r.customer]:l.customer.text,[r.date]:l.date.text,[r.status]:l.status.text,[r.payment]:l.payment.text,[r.total]:l.total.text,[r.share]:l.share.text,[r.net]:l.net.text};return{formatted:l,exportRow:d}});return a.innerHTML=i.map(({formatted:o})=>`
      <tr data-drilldown="reservation" data-search="${Ft(o.code.text)}">
        <td data-report-column="code">${o.code.html}</td>
        <td data-report-column="customer">${o.customer.html}</td>
        <td data-report-column="date">${o.date.html}</td>
        <td data-report-column="status">${o.status.html}</td>
        <td data-report-column="payment">${o.payment.html}</td>
        <td data-report-column="total">${o.total.html}</td>
        <td data-report-column="share">${o.share.html}</td>
        <td data-report-column="net">${o.net.html}</td>
      </tr>
    `).join(""),i.map(({exportRow:o})=>o)}function dr(e){const t=In?.[e];t&&(g.range="custom",g.start=t.startInput||null,g.end=t.endInput||null,tt(),I())}function ur(e){e&&(g.status=g.status===e?"all":e,tt(),I())}function mr(e){e&&(g.payment=g.payment===e?"all":e,tt(),I())}function pr(e){ve&&(clearTimeout(ve),ve=null),g.search=e||"";const t=document.getElementById("reports-search");t&&t.value!==g.search&&(t.value=g.search),I()}function fr(){if(nn)return;const e=document.getElementById("reports-column-controls");e&&(e.querySelectorAll("input[data-column-toggle]").forEach(t=>{const n=t.dataset.columnToggle;n&&(t.checked=vt[n]!==!1,t.addEventListener("change",()=>{vt[n]=t.checked,wt()}))}),nn=!0,wt())}function wt(){Object.entries(vt).forEach(([e,t])=>{document.querySelectorAll(`[data-report-column="${e}"]`).forEach(n=>{t?n.classList.remove("hidden"):n.classList.add("hidden")})})}function br(){if(tn)return;const e=document.querySelectorAll("[data-export]");e.length&&(e.forEach(t=>{t.addEventListener("click",async()=>{const{export:n=""}=t.dataset;if(n){t.disabled=!0;try{await gr(n)}catch(a){console.error("⚠️ [reports] export failed",a)}finally{t.disabled=!1}}})}),tn=!0)}async function gr(e){const t=re.tableRows||[];if(!t.length){console.warn("[reports] No reservation data to export");return}switch(e){case"pdf":await vr();break;case"excel":await yr(t);break;case"csv":default:At(t);break}}function Nt(e){const t=St(new Date).replace(/-/g,"");return`${f("reservations.reports.export.filePrefix","تقرير-الحجوزات","reservations-report")}-${t}.${e}`}function hr(e,t,n){const a=new Blob([e],{type:n}),s=URL.createObjectURL(a),r=document.createElement("a");r.href=s,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),setTimeout(()=>URL.revokeObjectURL(s),4e3)}function At(e){if(!e||!e.length)return;const t=Object.keys(e[0]),n=[t.join(",")];e.forEach(s=>{const r=t.map(i=>`"${String(s[i]??"").replace(/"/g,'""')}"`);n.push(r.join(","))});const a=`\uFEFF${n.join(`\r
`)}\r
`;hr(a,Nt("csv"),"text/csv;charset=utf-8;")}async function yr(e){try{const t=await Ua();if(!t){At(e);return}const n=t.utils.json_to_sheet(e),a=t.utils.book_new(),s=f("reservations.reports.export.sheetName","الحجوزات","Reservations");t.utils.book_append_sheet(a,n,s),t.writeFile(a,Nt("xlsx"))}catch(t){console.error("⚠️ [reports] Excel export failed, falling back to CSV",t),At(e)}}async function vr(){const e=document.getElementById("reservations-report-printable");if(!e)return;const t=await za();if(typeof t!="function"){console.warn("[reports] html2pdf unavailable, skipping PDF export");return}const n=Nt("pdf");await t().set({margin:10,filename:n,html2canvas:{scale:1.2,useCORS:!0,allowTaint:!1},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}}).from(e).save()}function Sr(){if(an)return;const e=document.getElementById("reports-top-customers"),t=document.getElementById("reports-top-equipment"),n=document.getElementById("reports-reservations-body"),a=s=>{const r=s.target?.closest("[data-drilldown]");if(!r)return;const i=r.dataset.search||"";pr(i)};e?.addEventListener("click",a),t?.addEventListener("click",a),n?.addEventListener("click",a),an=!0}async function Er(e){const t=document.getElementById("reports-volume-chart");if(t){if(In=Array.isArray(e)?e:[],!e||e.length===0){w.trend&&(w.trend.destroy(),w.trend=null),t.innerHTML=`<p class="text-base-content/60 text-sm">${f("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const n=await Rt();if(!n){t.innerHTML=`<p class="text-base-content/60 text-sm">${f("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const a=e.map(d=>d.label),s=e.map(d=>Math.round(d.count||0)),r=e.map(d=>Math.round(d.revenue||0)),i=e.map(d=>Math.round(d.netProfit||0)),o=[{name:f("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),type:"column",data:s},{name:f("reservations.reports.chart.volume.series.revenue","الإيرادات (ر.س)","Revenue (SAR)"),type:"line",data:r},{name:f("reservations.reports.chart.volume.series.net","صافي الربح (ر.س)","Net profit (SAR)"),type:"line",data:i,yAxisIndex:1}],l={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},background:"transparent",fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(d,u,m)=>{m?.dataPointIndex!=null&&dr(m.dataPointIndex)}}},theme:{mode:Xe()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,5,5]},colors:["#6366f1","#22c55e","#f97316"],dataLabels:{enabled:!1},fill:{type:"solid",opacity:1},xaxis:{categories:a,labels:{style:{colors:Xe()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:f("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:d=>k(d)},title:{text:f("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:f("reservations.reports.chart.volume.series.revenue","الإيرادات (ر.س)","Revenue (SAR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:d=>O(d)},title:{text:f("reservations.reports.chart.volume.series.revenue","الإيرادات (ر.س)","Revenue (SAR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,y:{formatter:(d,{seriesIndex:u})=>u===0?k(d):O(d)}}};w.trend?(w.trend.updateOptions({...l},!0,!0),w.trend.updateSeries(o,!0)):(t.innerHTML="",w.trend=new n(t,{...l,series:o}),w.trend.render())}catch(n){console.error("⚠️ [reports] Failed to render trend chart",n),t.innerHTML=`<p class="text-base-content/60 text-sm">${f("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}}async function Tr(e){const t=document.getElementById("reports-status-chart"),n="reports-status-breakdown";if(t){if(ft=Array.isArray(e)?e:[],!e||e.length===0){w.status&&(w.status.destroy(),w.status=null),Z(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${f("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const a=await Rt();if(!a){Z(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${f("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const s=e.map(o=>Math.max(0,o.value||0)),r=e.map(o=>o.label),i={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(o,l,d)=>{if(d?.dataPointIndex!=null){const u=ft[d.dataPointIndex];u?.filterKey&&ur(u.filterKey)}}}},theme:{mode:Xe()},labels:r,series:s,colors:["#22c55e","#f97316","#6366f1"],legend:{position:"bottom"},dataLabels:{formatter:o=>`${Math.round(o)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:f("reservations.reports.chart.status.title","🧾 توزيع الحالات","Status distribution"),formatter:()=>k(s.reduce((o,l)=>o+l,0))}}}}},tooltip:{y:{formatter:(o,l)=>{const d=ft?.[l?.seriesIndex||0],u=d?`${k(d.percent)}%`:`${k(o)}%`;return`${k(d?d.rawCount??d.value??0:o)} / ${u}`}}}};w.status?(w.status.updateOptions({...i},!0,!0),w.status.updateSeries(s,!0)):(t.innerHTML="",w.status=new a(t,{...i,series:s}),w.status.render()),Z(n,e)}catch(a){console.error("⚠️ [reports] Failed to render status chart",a),Z(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${f("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}}async function wr(e){const t=document.getElementById("reports-payment-chart"),n="reports-payment-breakdown";if(t){if(bt=Array.isArray(e)?e:[],!e||e.length===0){w.payment&&(w.payment.destroy(),w.payment=null),Z(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${f("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const a=await Rt();if(!a){Z(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${f("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const s=e.map(o=>Math.max(0,o.value||0)),r=e.map(o=>o.label),i={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(o,l,d)=>{if(d?.dataPointIndex!=null){const u=bt[d.dataPointIndex];u?.filterKey&&mr(u.filterKey)}}}},theme:{mode:Xe()},labels:r,series:s,colors:["#00ac69","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:o=>`${Math.round(o)}%`},tooltip:{y:{formatter:(o,l)=>{const d=bt?.[l?.seriesIndex||0],u=d?`${k(d.percent)}%`:`${k(o)}%`;return`${k(d?d.rawCount??d.value??0:o)} / ${u}`}}}};w.payment?(w.payment.updateOptions({...i},!0,!0),w.payment.updateSeries(s,!0)):(t.innerHTML="",w.payment=new a(t,{...i,series:s}),w.payment.render()),Z(n,e)}catch(a){console.error("⚠️ [reports] Failed to render payment chart",a),Z(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${f("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}}function Z(e,t){const n=document.getElementById(e);if(n){if(!t||t.length===0){n.innerHTML=`<div class="text-sm text-base-content/60">${f("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</div>`;return}n.innerHTML=t.map(a=>{const s=Math.min(Math.max(a.percent??0,0),100),r=f("reservations.reports.progress.meta","{count} حجز","{count} reservations").replace("{count}",k(a.rawCount??a.value??0)),i=a.className?`reports-progress-fill ${a.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${H(a.label)}</span>
            <span class="reports-progress-value">${k(a.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${i}" style="width: ${s}%;"></div>
          </div>
          <div class="reports-progress-meta">${r}</div>
        </div>
      `}).join("")}}function Ar(e){const t=document.getElementById("reports-top-customers");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${f("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${Ft(n.name)}">
        <td>${H(n.name)}</td>
        <td>${k(n.count)}</td>
        <td>${O(n.revenue)}</td>
      </tr>
    `).join("")}}function Lr(e){const t=document.getElementById("reports-top-equipment");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${f("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${Ft(n.name)}">
        <td>${H(n.name)}</td>
        <td>${k(n.count)}</td>
        <td>${O(n.revenue)}</td>
      </tr>
    `).join("")}}function xr(e,t,n){const a=e?.reservationId||e?.id||"—",s=v(String(a)),i=t.get(String(e?.customerId))?.customerName||f("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),o=Le(e),l=kr(o.statusValue),d=Ir(o.statusValue,l),u=_r(o.paid),m=$r(e?.start),p=De(e),b=O(p.finalTotal),h=p.companySharePercent>0?`${k(p.companySharePercent)}% (${O(p.companyShareAmount)})`:f("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),E=O(p.netProfit),S=H(i),$=i;return{code:{html:H(s),text:s},customer:{html:S,text:$},date:{html:H(m),text:m},status:d,payment:u,total:{html:H(b),text:b},share:{html:H(h),text:h},net:{html:H(E),text:E}}}function Rn(e){return e?f("reservations.reports.payment.paidLabel","مدفوعة","Paid"):f("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}function kr(e){switch(e){case"completed":return Ve(f("reservations.list.status.completed","📁 منتهي","Completed"));case"confirmed":return Ve(f("reservations.list.status.confirmed","✅ مؤكد","Confirmed"));case"pending":return Ve(f("reservations.list.status.pending","⏳ غير مؤكد","Pending"));default:return v(e||"—")}}function Ir(e,t){const n=Ve(t);return{html:`<span class="reservation-chip status-${["completed","confirmed","pending"].includes(e)?e:"info"}">${H(n)}</span>`,text:n}}function _r(e){const t=Rn(e);return{html:`<span class="reservation-chip status-${e?"paid":"unpaid"}">${H(t)}</span>`,text:t}}function Ve(e){return v(String(e??"")).replace(/^[^A-Za-z0-9\u0600-\u06FF]+/,"").trim()||"—"}function $r(e){if(!e)return"—";const t=new Date(e);if(Number.isNaN(t.getTime()))return"—";const n=Mt(),a=new Intl.DateTimeFormat(n,{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return v(a.format(t))}function Cr(e){const t=document.getElementById("reports-kpi-total"),n=document.getElementById("reports-kpi-total-meta"),a=document.getElementById("reports-kpi-revenue"),s=document.getElementById("reports-kpi-revenue-meta"),r=document.getElementById("reports-kpi-confirmed"),i=document.getElementById("reports-kpi-confirmed-meta"),o=document.getElementById("reports-kpi-paid"),l=document.getElementById("reports-kpi-paid-meta"),d=e.total||0,u=e.revenue||0,m=e.confirmed||0,p=e.paidCount||0,b=e.average||0,h=e.companyShareTotal||0,E=e.netProfit||0,S=d?Math.round(m/d*100):0,$=d?Math.round(p/d*100):0;if(t&&(t.textContent=k(d)),n){const L=f("reservations.reports.kpi.total.dynamicMeta","منها {count} منتهية","Includes {count} completed").replace("{count}",k(e.completed||0));n.textContent=L}if(a&&(a.textContent=O(u)),s){const L=f("reservations.reports.kpi.revenue.meta","صافي الربح {net} • نسبة الشركة {share} • متوسط الحجز {average}","Net profit {net} • Company share {share} • Average reservation {average}");s.textContent=L.replace("{net}",O(E)).replace("{share}",O(h)).replace("{average}",O(b))}if(r&&(r.textContent=`${S}%`),i){const L=f("reservations.reports.kpi.confirmed.detail","{count} حجوزات مؤكدة","{count} confirmed reservations").replace("{count}",k(m));i.textContent=L}if(o&&(o.textContent=`${$}%`),l){const L=f("reservations.reports.kpi.paid.detail","{count} حجوزات مدفوعة","{count} paid reservations").replace("{count}",k(p));l.textContent=L}}function qr(e){Et({active:!!e})}function H(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Ft(e=""){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function k(e){const{numberFormatter:t}=_n(),n=t.format(Math.round(e||0));return v(n)}function O(e){const{currencyFormatter:t}=_n(),n=t.format(Math.max(0,Math.round(e||0)));return v(n)}function Qe(e){return(e||"").toString().trim()}const Br=ee()||{};let pe=(Br.maintenance||[]).map(Nn);function nt(){return pe}function at(e){return pe=Array.isArray(e)?e.map(Nn):[],la({maintenance:pe}),zr(),pe}async function Mr(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([r,i])=>{i!=null&&i!==""&&t.set(r,String(i))});const n=t.toString(),a=await W(`/maintenance/${n?`?${n}`:""}`),s=Array.isArray(a?.data)?a.data.map(Pt):[];return at(s)}async function Dr(e){const t=await W("/maintenance/",{method:"POST",body:e}),n=Pt(t?.data??{});return at([n,...pe.filter(a=>a.id!==n.id)]),n}async function Rr(e,t){const n=await W(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=Pt(n?.data??{});return at(pe.map(s=>String(s.id)===String(e)?a:s)),a}async function Nr(e){await W(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),at(pe.filter(t=>String(t.id)!==String(e)))}function Fr({equipmentId:e,technicianId:t,issue:n,priority:a,status:s,scheduledAt:r,resolutionReport:i}){return{equipment_id:e,technician_id:null,maintenance_type:null,priority:a,reported_at:null,scheduled_at:null,status:s,notes:n??"",resolution_report:null}}function Pt(e={}){return Fn({id:e.id,equipment_id:e.equipment_id,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode,equipmentDesc:e.equipmentDesc??e.equipment_desc??e.equipment_description,issue:e.issue??e.notes,priority:e.priority,status:e.status,status_raw:e.status_raw,createdAt:e.createdAt??e.reportedAt??e.reported_at,reportedAt:e.reportedAt??e.reported_at,scheduledAt:e.scheduledAt??e.scheduled_at,resolvedAt:e.resolvedAt??e.resolved_at,resolutionReport:e.resolutionReport??e.resolution_report,technicianId:e.technicianId??e.technician_id})}function Nn(e={}){return Fn(e)}function Fn(e={}){const t=e.id??e.ticketId??Date.now(),n=e.equipmentDesc??e.equipment_desc??e.equipmentDescription??e.equipment_name??"",a=Pr(e.status_raw??e.status??"open"),s=jr(a),r=Or(e,a);return{id:Number(t),equipmentId:e.equipment_id??e.equipmentId??null,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode??"",equipmentDesc:n,issue:e.issue??e.notes??"",priority:Hr(e.priority??"medium"),status:s,statusRaw:a,statusLabel:r,createdAt:e.createdAt??e.reportedAt??e.reported_at??null,reportedAt:e.reportedAt??e.reported_at??null,scheduledAt:e.scheduledAt??e.scheduled_at??null,resolvedAt:e.resolvedAt??e.resolved_at??null,resolutionReport:e.resolutionReport??e.resolution_report??"",technicianId:e.technicianId??e.technician_id??null}}function Pr(e){const t=String(e??"").trim();return t&&t.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-]/g,"")||"open"}function jr(e){const t=Pn(e);return["completed","cancelled"].includes(t)?"closed":"open"}function Hr(e){const t=String(e??"medium").trim().toLowerCase();return["low","medium","high"].includes(t)?t:"medium"}function Or(e={},t="open"){const n=e.status_label??e.statusLabel??e.status_display??e.status_text??e.status??e.status_raw??t,a=String(n??"").trim();return a||t.replace(/[_-]+/g," ").replace(/\b\w/g,s=>s.toUpperCase())}function Pn(e){const t=String(e??"").toLowerCase();switch(t){case"open":case"قيد الصيانة":case"قيد الانتظار":return"open";case"in_progress":case"in-progress":case"جاري العمل":return"in_progress";case"completed":case"مكتمل":case"تم الإصلاح":case"closed":case"مغلق":return"completed";case"cancelled":case"ملغي":return"cancelled";default:return t.includes("progress")||t.includes("تنفيذ")?"in_progress":t.includes("complete")||t.includes("close")||t.includes("منجز")||t.includes("مغلق")?"completed":t.includes("cancel")||t.includes("ملغي")?"cancelled":t||"open"}}function zr(){typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("maintenance:updated")):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("maintenance:updated"))}function qe(e){return e instanceof gn}function Lt(e){if(!e)return null;const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getFullYear()).slice(-2);return`${n}/${a}/${s}`}let be=nt(),fe=[],$e=null,Ee=!1,Ce="",Te=be.length>0,ue={id:null,equipmentDesc:"",equipmentBarcode:""},jt=null,q=null,Y=null,we=null,jn=null,Ae=null;async function Be({showToastOnError:e=!0}={}){if(!Ee){Ee=!0,Ce="",z();try{await Mr(),Te=!0}catch(t){Te=be.length>0,console.error("❌ [maintenance] Failed to load maintenance tickets",t),Ce=qe(t)?t.message:c("maintenance.toast.fetchFailed","تعذر تحميل بيانات الصيانة. حاول تحديث الصفحة."),e&&A(Ce,"error")}finally{Ee=!1,be=nt(),z()}}}function xt(){return c("maintenance.form.selectedInfo","لم يتم اختيار معدة بعد.")}function J(e){return v(String(e||"")).trim().toLowerCase()}function un(e=""){return v(String(e)).trim().toLowerCase()}function _(e=""){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Ur(e=new Date){const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=a=>String(a).padStart(2,"0");return`${t.getFullYear()}-${n(t.getMonth()+1)}-${n(t.getDate())} ${n(t.getHours())}:${n(t.getMinutes())}:${n(t.getSeconds())}`}function te(){return be=nt(),be}function Hn(e){return te().find(n=>Number(n.id)===Number(e))||null}function On(e){const t=String(e??"").trim().toLowerCase();return t?["maintenance","صيانة"].includes(t)?"maintenance":["reserved","محجوز"].includes(t)?"reserved":["retired","متوقف","خارج الخدمة"].includes(t)?"retired":"available":"available"}function Ht(){const{equipment:e=[]}=ee(),t=c("maintenance.table.noName","بدون اسم");return fe=(e||[]).map(n=>{const a=String(n?.barcode??"").trim(),s=J(a),r=Number.parseInt(n?.qty??n?.quantity??0,10),i=Number.isFinite(r)?Math.max(r,0):1,o=n?.image||n?.imageUrl||n?.image_url||"",l=n?.status||"متاح";return{id:n?.id??n?.equipment_id??n?.equipmentId??null,barcode:s,displayBarcode:a,desc:n?.desc||n?.description||n?.name||t,status:l,statusNormalized:On(l),price:Number(n?.price||n?.unit_price)||0,category:n?.category||"",quantity:i,image:o}}),fe.sort((n,a)=>n.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),fe}function Ot(){const e=new Set,t=new Map;return te().filter(n=>n.status==="open").forEach(n=>{const a=J(n.equipmentBarcode);a&&(e.add(a),t.set(a,(t.get(a)||0)+1))}),{set:e,map:t}}function zn(e){const t=J(e);if(!t)return 0;const{map:n}=Ot();return n.get(t)||0}function rt(e){const t=J(e);return t&&(fe.length?fe:Ht()).find(a=>a.barcode===t)||null}function Vr(e){const t=un(e);return t&&(fe.length?fe:Ht()).find(a=>un(a.desc).includes(t))||null}function Ye(e,t=null){if(!e)return!0;const n=e.barcode,a=Number.isFinite(e.quantity)?e.quantity:0,r=(t||Ot().map).get(n)||0;return a<=0?!0:a===1?e.statusNormalized==="maintenance"||r>=1:r>=a}function ie({keepInputs:e=!1,silent:t=!1}={}){const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),s=document.getElementById("maintenance-equipment-search"),r=document.getElementById("maintenance-selected-info");n&&(n.value=""),e||(a&&(a.value=""),s&&(s.value="")),r&&(r.textContent=xt(),r.classList.remove("maintenance-selected-info--has-selection")),$e=null}function Un(e){const t=document.getElementById("maintenance-selected-info");if(!t)return;const n=c("maintenance.info.barcodeLabel","باركود"),a=c("maintenance.report.notAvailable","غير متوفر"),s=c("maintenance.info.unitsAvailable","الوحدات المتاحة الآن"),r=c("maintenance.info.categoryLabel","القسم"),i=e.displayBarcode||e.barcode||a,o=e.barcode,l=Number.isFinite(e.quantity)?e.quantity:0,d=zn(o),u=Math.max(l-d,0),m=e.category?`
    <div class="maintenance-selected-info__meta">${r}: <strong>${_(e.category)}</strong></div>
  `:"",p=l>0?`
    <div class="maintenance-selected-info__meta">
      ${s}: <strong>${u}</strong> / ${l}
    </div>
  `:"",b=e.image?`<img class="maintenance-selected-info__image" src="${_(e.image)}" alt="${_(e.desc)}">`:'<div class="maintenance-selected-info__placeholder" aria-hidden="true">🎥</div>';t.innerHTML=`
    <div class="maintenance-selected-info__media">${b}</div>
    <div class="maintenance-selected-info__body">
      <div class="maintenance-selected-info__name">${_(e.desc)}</div>
      <div class="maintenance-selected-info__meta">${n}: <strong>${_(i)}</strong></div>
      ${p}
      ${m}
    </div>
  `,t.classList.add("maintenance-selected-info--has-selection")}function zt(e,{silent:t=!1}={}){if(!e)return!1;if(Ye(e))return t||A(c("maintenance.toast.equipmentBlocked","⚠️ هذه المعدة قيد الصيانة ولا يمكن اختيارها حالياً")),!1;const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),s=document.getElementById("maintenance-equipment-search");return n&&(n.value=e.barcode),a&&(a.value=e.displayBarcode||e.barcode),s&&(s.value=e.desc),Un(e),$e=e,!0}function Vn(e,{showFeedback:t=!0}={}){const n=rt(e);return n?zt(n,{silent:!t}):(t&&A(c("maintenance.toast.equipmentNotFoundBarcode","❌ لم يتم العثور على معدة بهذا الباركود")),!1)}function Yn(e,{showFeedback:t=!0}={}){const n=Vr(e);return n?zt(n,{silent:!t}):(t&&A(c("maintenance.toast.equipmentNotFoundName","❌ لم يتم العثور على معدة بالاسم المدخل")),!1)}function Ut(){const e=document.getElementById("maintenance-equipment-options"),t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=Ht(),{map:s}=Ot();if(e){const i=c("maintenance.form.blockedSuffix","(صيانة)");e.innerHTML=a.map(o=>{const l=Number.isFinite(o.quantity)?o.quantity:0,d=o.barcode,u=s.get(d)||0,m=l>0?Math.max(l-u,0):0,p=Ye(o,s),b=[o.desc];l>0&&b.push(`(${m}/${l})`),p&&b.push(i);const h=b.join(" "),E=o.desc.replace(/"/g,"&quot;"),S=h.replace(/"/g,"&quot;");return`<option value="${E}" label="${S}"></option>`}).join("")}const r=document.getElementById("maintenance-selected-barcode");if(r&&r.value){const i=rt(r.value);!i||Ye(i,s)?(ie({keepInputs:!0,silent:!0}),i&&Ye(i,s)&&A(c("maintenance.toast.equipmentBecameBlocked","⚠️ هذه المعدة أصبحت قيد الصيانة ولا يمكن اختيارها"))):zt(i,{silent:!0})}else ie({keepInputs:!0,silent:!0});if(t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),Vn(t.value)||ie({keepInputs:!0,silent:!0}))}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached){const i=()=>{if(!n.value){ie({keepInputs:!0,silent:!0});return}Yn(n.value)||ie({keepInputs:!0,silent:!0})};n.addEventListener("change",i),n.addEventListener("keydown",o=>{o.key==="Enter"&&(o.preventDefault(),i())}),n.dataset.listenerAttached="true"}}async function Ze(){try{await ka({showToastOnError:!1})}catch(e){console.error("❌ [maintenance] refreshEquipmentData failed",e)}finally{Bt(),Ut()}}function Wn(){const e=document.getElementById("closeMaintenanceModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;if(!t?.Modal)return!1;jt=t.Modal.getOrCreateInstance(e),q||(q=e.querySelector("#maintenance-close-report")),Y||(Y=e.querySelector("#maintenance-close-submit")),we||(we=e.querySelector("#maintenance-close-modal-details"));const n=e.querySelector("#maintenance-close-form");return n&&!n.dataset.listenerAttached&&(n.addEventListener("submit",Wr),n.dataset.listenerAttached="true"),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",Gn),e.dataset.listenerAttached="true"),!0}function Gn(){ue={id:null,equipmentDesc:"",equipmentBarcode:""},q&&(q.value=""),we&&(we.innerHTML=""),Me(!1)}function Xn(){const e=document.getElementById("maintenanceReportModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;return t?.Modal?(jn=t.Modal.getOrCreateInstance(e),Ae||(Ae=e.querySelector("#maintenance-report-modal-content")),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",Kn),e.dataset.listenerAttached="true"),!0):!1}function Kn(){Ae&&(Ae.innerHTML="")}function Me(e){if(!Y)return;const t=c("maintenance.closeModal.saving","⏳ جاري الإغلاق..."),n=c("maintenance.closeModal.confirm","إغلاق التذكرة");e?(Y.disabled=!0,Y.dataset.loading="true",Y.textContent=t):(Y.disabled=!1,Y.removeAttribute("data-loading"),Y.textContent=n)}function Yr(e){const t=Hn(e);if(!t){A(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!Wn()){const n=prompt(c("maintenance.prompt.closeReport","أدخل تقرير الإصلاح / الإجراءات المتخذة:"));if(n===null)return;const a=n.trim();if(!a){A(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error");return}Qn(e,a);return}if(ue={id:t.id,equipmentDesc:t.equipmentDesc||"",equipmentBarcode:t.equipmentBarcode||""},q&&(q.value=t.resolutionReport||""),we){const n=c("maintenance.report.barcode","الباركود"),a=c("maintenance.report.notAvailable","غير متوفر"),s=ue.equipmentDesc||a,r=ue.equipmentBarcode?v(ue.equipmentBarcode):a;we.innerHTML=`
      <div class="maintenance-close-modal__ticket-card" role="group" aria-labelledby="maintenance-close-ticket-title">
        <div class="maintenance-close-modal__ticket-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 2h6"></path>
            <path d="M10 4h4"></path>
            <path d="M8 4h-2a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2"></path>
            <path d="M9 12l2 2 4-4"></path>
          </svg>
        </div>
        <div class="maintenance-close-modal__ticket-info">
          <div id="maintenance-close-ticket-title" class="maintenance-close-modal__ticket-title">${s}</div>
          <div class="maintenance-close-modal__ticket-meta">${n}: <span>${r}</span></div>
        </div>
      </div>
    `}Me(!1),jt?.show(),setTimeout(()=>{q?.focus(),q?.setSelectionRange(q.value.length,q.value.length)},150)}async function Wr(e){if(e?.preventDefault(),!ue.id){A(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!q)return;const t=q.value.trim();if(!t){A(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),q.focus();return}Me(!0),(await Qn(ue.id,t)).success?jt?.hide():Me(!1)}function Gr(e){const t=document.getElementById("maintenance-stats");if(!t)return;const n=e.length,a=e.filter(m=>m.status==="open").length,s=n-a,r=m=>v(String(m)),i=c("maintenance.stats.summaryTitle","ملخص الصيانة"),o=c("maintenance.filters.status.open","قيد الصيانة"),l=c("maintenance.filters.status.closed","مغلقة"),d=c("maintenance.stats.totalLabel","إجمالي التذاكر"),u=(m,p,b)=>`
    <div class="maintenance-summary__item maintenance-summary__item--${b}">
      <span class="maintenance-summary__value">${r(m)}</span>
      <span class="maintenance-summary__label">${p}</span>
    </div>
  `;t.innerHTML=`
    <section class="maintenance-summary" aria-labelledby="maintenance-summary-title">
      <header class="maintenance-summary__header">
        <span class="maintenance-summary__icon" aria-hidden="true">🛠️</span>
        <h4 id="maintenance-summary-title" class="maintenance-summary__title">${i}</h4>
      </header>
      <div class="maintenance-summary__items">
        ${u(a,o,"open")}
        ${u(s,l,"closed")}
        ${u(n,d,"total")}
      </div>
    </section>
  `}function Xr(e){const n=String(e?.statusRaw??e?.status??"open").toLowerCase().replace(/[^a-z0-9_\-\s]/g,"").replace(/[\s]+/g,"_")||"open",a=Pn(n)||"open",s={open:{key:"maintenance.status.open",fallback:"قيد الصيانة",className:"maintenance-status-tag--open"},in_progress:{key:"maintenance.status.inProgress",fallback:"قيد التنفيذ",className:"maintenance-status-tag--in-progress"},completed:{key:"maintenance.status.completed",fallback:"مكتملة",className:"maintenance-status-tag--completed"},cancelled:{key:"maintenance.status.cancelled",fallback:"ملغاة",className:"maintenance-status-tag--cancelled"}},r=s[a]??s.open,i=r?c(r.key,r.fallback):c("maintenance.status.open","قيد الصيانة"),o=e?.statusLabel&&String(e.statusLabel).trim()?String(e.statusLabel).trim():i,l=["maintenance-status-badge","maintenance-status-tag"];return r?.className&&l.push(r.className),l.push(`maintenance-status-tag--${a}`),l.push(`maintenance-status-tag--${n}`),`<span class="${l.filter(Boolean).join(" ")}">${o}</span>`}function Kr(e){const t=document.getElementById("maintenance-table-body"),n=document.getElementById("maintenance-empty-state");if(t){if(!e||e.length===0){const a=c("maintenance.empty.title","لا توجد تذاكر صيانة"),s=c("maintenance.empty.subtitle","عند إنشاء تذكرة جديدة ستظهر في هذه القائمة.");t.innerHTML=`
      <tr>
        <td colspan="6" class="maintenance-empty-row">
          <div class="maintenance-empty-icon">✅</div>
          <h5>${a}</h5>
          <p>${s}</p>
        </td>
      </tr>
    `,n&&n.classList.add("active");return}n&&n.classList.remove("active"),t.innerHTML=e.map(a=>{const s=Xr(a),r=a.status==="open"?"maintenance-row maintenance-row--open":"maintenance-row maintenance-row--closed",i=(()=>{const $=c("maintenance.priority.high","مرتفعة"),L=c("maintenance.priority.medium","متوسطة"),U=c("maintenance.priority.low","منخفضة");switch(a.priority){case"high":return`<span class="maintenance-priority-badge maintenance-priority-badge--high">${$}</span>`;case"low":return`<span class="maintenance-priority-badge maintenance-priority-badge--low">${U}</span>`;default:return`<span class="maintenance-priority-badge maintenance-priority-badge--medium">${L}</span>`}})(),o=[],l=c("maintenance.actions.close","🔧 إغلاق بعد الإصلاح"),d=c("maintenance.actions.view","👁️ عرض التقرير"),u=c("maintenance.actions.delete","🗑️ حذف التذكرة");a.status==="open"?o.push(`<button type="button" class="maintenance-action-btn" data-action="close" data-id="${a.id}">${l}</button>`):o.push(`<button type="button" class="maintenance-action-btn" data-action="view" data-id="${a.id}">${d}</button>`),qt()&&o.push(`<button type="button" class="maintenance-action-btn maintenance-action-btn--delete" data-action="delete" data-id="${a.id}">${u}</button>`);const m=o.join(""),p=c("maintenance.table.noBarcode","بدون باركود"),b=c("maintenance.report.none","—"),h=a.equipmentBarcode?v(a.equipmentBarcode):p,E=a.issue?v(a.issue):b,S=a.createdAt?v(Lt(a.createdAt)||de(a.createdAt)):"—";return`
        <tr class="${r}">
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${h}</small>
          </td>
          <td class="maintenance-issue-text">${E}</td>
          <td>${i}</td>
          <td>${S}</td>
          <td>${s}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${m}
            </div>
          </td>
        </tr>
      `}).join("")}}function Qr(e){if(!Te||Ee){A(c("maintenance.toast.loading","⏳ يتم تحديث بيانات الصيانة، يرجى الانتظار لحظة..."));return}const t=e.target.closest("button[data-action]");if(!t)return;const n=t.getAttribute("data-action"),a=Number(t.getAttribute("data-id"));if(a){if(n==="close")Yr(a);else if(n==="view")Zr(a);else if(n==="delete"){if(!qt()){hn();return}Jr(a).catch(s=>{console.error("❌ [maintenance] deleteTicket failed",s)})}}}async function Qn(e,t){const n=Hn(e);if(!n)return A(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة")),{success:!1};const a=(t??"").trim();if(!a)return A(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),{success:!1};const s=Ur(new Date)||new Date().toISOString();try{await Rr(e,{equipment_id:n.equipmentId,technician_id:n.technicianId??null,priority:n.priority??"medium",status:"completed",notes:n.issue??"",reported_at:n.reportedAt??null,scheduled_at:n.scheduledAt??null,resolution_report:a,resolved_at:s}),await Be({showToastOnError:!1});const r=document.getElementById("maintenance-status-filter");return r&&r.value==="open"&&(r.value="all"),await Ze(),z(),A(c("maintenance.toast.ticketClosed","✅ تم إغلاق تذكرة الصيانة وإعادة المعدة إلى الحالة المتاحة")),{success:!0}}catch(r){if(console.error("❌ [maintenance] closeTicket failed",r),qe(r)&&r.status===404)return await Be({showToastOnError:!1}),await Ze(),z(),A(c("maintenance.toast.ticketAlreadyClosed","✅ تم تحديث التذاكر، ويبدو أن هذه التذكرة مغلقة مسبقاً"),"info"),{success:!0};const i=qe(r)?r.message:c("maintenance.toast.updateError","⚠️ تعذر إغلاق تذكرة الصيانة. حاول مرة أخرى");return A(i,"error"),{success:!1,error:r}}}function Zr(e){const n=te().find(S=>Number(S.id)===Number(e));if(!n)return;if(!Xn()){const S=c("maintenance.report.equipment","المعدة"),$=c("maintenance.report.barcode","الباركود"),L=c("maintenance.report.issue","الوصف"),U=c("maintenance.report.createdAt","تاريخ الإنشاء"),F=c("maintenance.report.closedAt","تاريخ الإغلاق"),ne=c("maintenance.report.summary","التقرير"),ae=c("maintenance.report.notAvailable","غير متوفر"),V=c("maintenance.report.none","—"),B=[`${S}: ${n.equipmentDesc}`,`${$}: ${n.equipmentBarcode?v(n.equipmentBarcode):ae}`,`${L}: ${n.issue?v(n.issue):V}`,`${U}: ${n.createdAt?v(Lt(n.createdAt)||de(n.createdAt)):V}`,`${F}: ${n.resolvedAt?v(de(n.resolvedAt)):V}`,`${ne}: ${n.resolutionReport?v(n.resolutionReport):V}`].join(`
`);alert(B);return}const a=c("maintenance.report.equipment","المعدة"),s=c("maintenance.report.barcode","الباركود"),r=c("maintenance.report.issue","الوصف"),i=c("maintenance.report.createdAt","تاريخ الإنشاء"),o=c("maintenance.report.closedAt","تاريخ الإغلاق"),l=c("maintenance.report.summary","التقرير"),d=c("maintenance.report.notAvailable","غير متوفر"),u=c("maintenance.report.none","—"),m=[{label:a,value:`<span class="maintenance-report-modal__value">${_(n.equipmentDesc||u)}</span>`},{label:s,value:n.equipmentBarcode?`<span class="maintenance-report-modal__value">${_(v(n.equipmentBarcode))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${_(d)}</span>`},{label:r,value:n.issue?`<span class="maintenance-report-modal__value">${_(v(n.issue))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${_(u)}</span>`},{label:i,value:n.createdAt?`<span class="maintenance-report-modal__value">${_(v(Lt(n.createdAt)||de(n.createdAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${_(u)}</span>`},{label:o,value:n.resolvedAt?`<span class="maintenance-report-modal__value">${_(v(de(n.resolvedAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${_(u)}</span>`}],p=n.resolutionReport?v(n.resolutionReport):"",b=p?`<p>${_(p).replace(/\r?\n/g,"<br>")}</p>`:`<p class="maintenance-report-modal__value maintenance-report-modal__value--muted">${_(u)}</p>`,h=m.map(S=>`
      <div class="maintenance-report-modal__item">
        <span class="maintenance-report-modal__label">${_(S.label)}</span>
        ${S.value}
      </div>
    `).join(""),E=`
    <div class="maintenance-report-modal__summary">
      <h6>${_(l)}</h6>
      ${b}
    </div>
  `;Ae&&(Ae.innerHTML=`
      <div class="maintenance-report-modal__details">
        <div class="maintenance-report-modal__grid">
          ${h}
        </div>
        ${E}
      </div>
    `),jn?.show()}async function Jr(e){if(!qt()){hn();return}if(!te().find(a=>Number(a.id)===Number(e))){A(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(confirm(c("maintenance.toast.ticketDeleteConfirm","⚠️ هل أنت متأكد من حذف تذكرة الصيانة؟")))try{await Nr(e),await Be({showToastOnError:!1}),await Ze(),A(c("maintenance.toast.ticketDeleted","🗑️ تم حذف تذكرة الصيانة"))}catch(a){console.error("❌ [maintenance] deleteTicket failed",a);const s=qe(a)?a.message:c("maintenance.toast.deleteError","⚠️ تعذر حذف تذكرة الصيانة. حاول مرة أخرى");A(s,"error")}}async function es(e){e.preventDefault();try{const t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),s=document.getElementById("maintenance-issue"),r=document.getElementById("maintenance-priority");let i=$e,o=J(a?.value);if(!i&&o&&(i=rt(o)),!i&&t?.value&&Vn(t.value,{showFeedback:!0})&&(i=$e,o=J(i?.barcode)),!i&&n?.value&&Yn(n.value,{showFeedback:!0})&&(i=$e,o=J(i?.barcode)),!i||!o){A(c("maintenance.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const{equipment:l=[]}=ee();let d=(l||[]).find(S=>J(S?.barcode)===o);if(!d&&i&&(d={id:i.id,barcode:i.barcode,desc:i.desc,name:i.desc,status:i.status||"متاح",quantity:i.quantity,qty:i.quantity}),!d||d.id==null){A(c("maintenance.toast.selectedNotFound","❌ لم يتم العثور على المعدة المختارة")),ie();return}const u=Number.parseInt(d.qty??d.quantity??i?.quantity??1,10),m=Number.isFinite(u)&&u>0?u:1,p=zn(o);if(On(d.status||i?.status)==="maintenance"&&m<=1){A(c("maintenance.toast.equipmentAlreadyMaintenance","⚠️ هذه المعدة بالفعل في حالة صيانة"));return}if(p>=m){A(c("maintenance.toast.noUnitsAvailable","⚠️ لا توجد وحدات متاحة للصيانة لهذه المعدة حالياً"));return}const h=Fr({equipmentId:d.id,technicianId:null,issue:s?.value.trim()||"",priority:r?.value||"medium",status:"open",scheduledAt:null,resolutionReport:null});await Dr(h),await Be({showToastOnError:!1}),await Ze(),A(c("maintenance.toast.ticketCreated","🛠️ تم إنشاء تذكرة الصيانة وإيقاف المعدة")),ie(),s&&(s.value=""),r&&(r.value="medium");const E=document.getElementById("maintenance-status-filter");E&&(E.value="all")}catch(t){console.error("❌ [maintenance] Failed to create ticket",t);const n=qe(t)?t.message:c("maintenance.toast.submitError","⚠️ تعذر إنشاء تذكرة الصيانة. يرجى المحاولة مجدداً.");A(n,"error")}}function ts(e){const t=te();return e==="all"?t:t.filter(n=>n.status===e)}function z(){const e=te();Ut(),Gr(e);const t=document.getElementById("maintenance-status-filter");t&&!t.value&&(t.value="all");const n=t?.value||"all",a=document.getElementById("maintenance-table-body"),s=document.getElementById("maintenance-empty-state");if(!a)return;if(Ee&&!Te){const i=c("maintenance.table.loading","جاري التحميل...");a.innerHTML=`<tr><td colspan="6" class="text-center text-muted">${i}</td></tr>`,s&&s.classList.remove("active");return}if(Ce&&!Te){a.innerHTML=`<tr><td colspan="6" class="text-center text-danger">${Ce}</td></tr>`,s&&s.classList.remove("active");return}const r=ts(n);Kr(r)}function ns(){te(),Ut(),Te=be.length>0,Ee=!1,z(),Be({showToastOnError:!1}),Wn()&&Gn(),Xn()&&Kn();const e=document.getElementById("maintenance-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",a=>{es(a).catch(s=>{console.error("❌ [maintenance] submit handler failed",s)})}),e.dataset.listenerAttached="true");const t=document.getElementById("maintenance-status-filter");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{z()}),t.dataset.listenerAttached="true");const n=document.querySelector(".maintenance-table");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Qr),n.dataset.listenerAttached="true")}te();document.addEventListener("language:changed",()=>{const e=document.getElementById("maintenance-selected-barcode"),t=document.getElementById("maintenance-selected-info");if(e?.value){const n=rt(e.value);n?Un(n):t&&(t.textContent=xt())}else t&&(t.textContent=xt());z(),Me(!1)});document.addEventListener(da.USER_UPDATED,()=>{z()});window.addEventListener("maintenance:updated",()=>{be=nt(),z()});const kt="__ART_RATIO_LAST_DASHBOARD_TAB__",G="__ART_RATIO_LAST_DASHBOARD_SUB_TAB__",Je="create-tab",Zn=/^[a-z0-9\-]+$/i;function It(e){if(!(!e||typeof e.scrollIntoView!="function"))try{const t=e.closest("[data-tab-scroll-track]");if(!t)return;const n={behavior:"smooth",block:"nearest",inline:"center"};e.scrollIntoView(n);const a=t.closest("[data-tab-scroll]");a&&window.requestAnimationFrame(()=>{a.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0}))})}catch(t){console.warn("⚠️ [tabs.js] Failed to keep tab visible",t)}}function ce(e){try{if(typeof window>"u"||!window.localStorage)return null;const t=window.localStorage.getItem(e);return!t||!Zn.test(t)?null:t}catch(t){return console.warn("⚠️ [tabs.js] Failed to read stored tab",t),null}}function _t(e,t){try{if(typeof window>"u"||!window.localStorage)return;if(!t||!Zn.test(t)){window.localStorage.removeItem(e);return}window.localStorage.setItem(e,t)}catch(n){console.warn("⚠️ [tabs.js] Failed to persist tab",n)}}function Jn(e){try{if(typeof window>"u"||!window.localStorage)return;window.localStorage.removeItem(e)}catch(t){console.warn("⚠️ [tabs.js] Failed to clear stored tab",t)}}let se=null,N=null,le=!1,C=null,mn=null,me=null,$t=null,ge=null;function as(){console.log("🚀 [tabs.js] setupTabs()");const e=Array.from(document.querySelectorAll("[data-tab]")),t=document.querySelectorAll(".tab-content-wrapper > .tab");console.log("📌 tabButtons:",e),console.log("📌 tabContents:",t);const n=(r,{skipStore:i=!1,skipRender:o=!1}={})=>{if(!r)return;const l=e.filter(u=>u?.getAttribute("data-tab")===r),d=document.getElementById(r);if(!(!l.length||!d)&&(e.forEach(u=>{const m=u?.getAttribute("data-tab")===r;u.classList.toggle("active",m),m?(u.setAttribute("aria-selected","true"),u.setAttribute("tabindex","0"),It(u)):(u.setAttribute("aria-selected","false"),u.setAttribute("tabindex","-1"))}),t.forEach(u=>{const m=u.id===r;u.style.display=m?"block":"none",u.classList.toggle("active",m)}),se=r,_t(kt,r),i||Ie({dashboardTab:r}).catch(u=>{console.warn("⚠️ [tabs.js] Failed to store dashboard tab preference",u)}),r!=="reservations-tab"&&(N=null,C=null,Jn(G),i||Ie({dashboardSubTab:null}).catch(u=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",u)})),!o&&r==="customers-tab"&&(console.log("👤 Rendering customers"),ya()),!o&&r==="equipment-tab"&&(console.log("📦 Rendering equipment"),Bt()),!o&&r==="maintenance-tab"&&(console.log("🛠️ Rendering maintenance"),z()),!o&&r==="technicians-tab"&&(console.log("🛠️ Rendering technicians"),Ia()),r==="reservations-tab")){if(console.log("📅 Rendering reservations"),o||yn(),!C){const u=ce(G);C=N||u||Je}rs(),C&&(Ne(C),C=null)}};$t=n,e.forEach(r=>{r&&(r.getAttribute("type")||r.setAttribute("type","button"),r.setAttribute("role","tab"),r.hasAttribute("tabindex")||r.setAttribute("tabindex",r.classList.contains("active")?"0":"-1"),r.addEventListener("click",()=>{const i=r.getAttribute("data-tab");if(console.log("🖱️ Tab clicked:",i),n(i),i==="reservations-tab"){const o=N||ce(G)||Je;typeof me=="function"?me(o):C=o}else Ie({dashboardSubTab:null}).catch(o=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",o)})}))});const a=r=>{const i=document.querySelector("[data-tab].active"),o=ce(kt),l=e[0]?.getAttribute("data-tab")||null,u=[r?.dashboardTab,o,se,i?.getAttribute("data-tab"),l].filter(Boolean).find(b=>document.getElementById(b))||l;u&&(!le||u!==se)&&(console.log("⭐ Initial tab:",u),n(u,{skipStore:!0}));const p=[r?.dashboardSubTab,ce(G)].filter(Boolean).find(b=>document.getElementById(b));p&&(se==="reservations-tab"&&typeof me=="function"?(!le||p!==N)&&me(p,{skipStore:!0}):C=p),le||(document.body?.classList.remove("tabs-loading"),document.body?.classList.remove("no-js"),le=!0)},s=typeof We=="function"?We():null;a(s||null),ua().then(r=>a(r||null)).catch(r=>{console.warn("⚠️ [tabs.js] Failed to load tab preferences",r),a(null)}),mn||(mn=ma(r=>{if(!(!le||!r))if(r.dashboardTab&&r.dashboardTab!==se&&n(r.dashboardTab,{skipStore:!0}),se==="reservations-tab"){if(r.dashboardSubTab&&r.dashboardSubTab!==N)Ne(r.dashboardSubTab);else if(!r.dashboardSubTab&&N){const i=ce(G);i?i!==N&&Ne(i):Ne(null)}}else r.dashboardSubTab&&(C=r.dashboardSubTab)}))}function rs(){console.log("🚀 [tabs.js] setupSubTabs()");const e=document.querySelectorAll("#reservations-tab .sub-tab-button"),t=document.querySelectorAll("#reservations-tab .sub-tab");if(console.log("📌 subTabButtons:",e),console.log("📌 subTabContents:",t),!e.length){console.warn("⚠️ [tabs.js] No reservation sub-tab buttons found");return}const n=Array.from(e).map(r=>r?.getAttribute("data-sub-tab")).filter(r=>typeof r=="string"&&r.trim().length>0),a=()=>n.length?n.includes(Je)?Je:n[0]:null,s=(r,{skipStore:i=!1}={})=>{if(!n.length)return;let o=r;(!o||!n.includes(o))&&(console.warn("⚠️ [tabs.js] Invalid sub-tab target, falling back to first available",{requested:o,available:n}),o=a());const l=document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${o}"]`),d=document.getElementById(o);if(!l||!d){console.warn("⚠️ [tabs.js] Unable to locate sub-tab button/content after fallback",{target:o});return}if(N===o&&l.classList.contains("active")&&d.classList.contains("active")&&d.getAttribute("aria-hidden")==="false"){d.removeAttribute("hidden"),d.style.display="block",d.setAttribute("aria-hidden","false"),N=o,It(l),i||(_t(G,o),Ie({dashboardSubTab:o}).catch(m=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",m)}));return}e.forEach(m=>{m.classList.remove("active"),m.classList.contains("tab")&&m.classList.remove("tab-active"),m.setAttribute("aria-selected","false"),m.setAttribute("tabindex","-1")}),l.classList.add("active"),l.classList.contains("tab")&&l.classList.add("tab-active"),l.setAttribute("aria-selected","true"),l.setAttribute("tabindex","0"),It(l),t.forEach(m=>{const p=m.id===o;m.classList.toggle("active",p),m.setAttribute("aria-hidden",p?"false":"true"),p?(m.removeAttribute("hidden"),m.style.display="block"):(m.setAttribute("hidden",""),m.style.display="none")}),N=o,_t(G,o),i||Ie({dashboardSubTab:o}).catch(m=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",m)}),o==="my-reservations-tab"?(console.log("📋 Rendering reservations list"),setTimeout(()=>{yn()},50)):o==="calendar-tab"?(console.log("📅 Rendering calendar view"),setTimeout(()=>{et()},100)):o==="reports-tab"&&(console.log("📊 Rendering reports view"),setTimeout(()=>{I()},50))};if(me=(r,i={})=>{r?s(r,i):(e.forEach(o=>{o.classList.remove("active"),o.classList.contains("tab")&&o.classList.remove("tab-active"),o.setAttribute("aria-selected","false"),o.setAttribute("tabindex","-1")}),t.forEach(o=>{o.classList.remove("active"),o.setAttribute("aria-hidden","true"),o.setAttribute("hidden",""),o.style.display="none"}),N=null,Jn(G))},e.forEach(r=>{r.dataset.subTabListenerAttached||(r.addEventListener("click",()=>{const i=r.getAttribute("data-sub-tab");console.log("🖱️ Sub-tab clicked:",i),s(i)}),r.dataset.subTabListenerAttached="true")}),C)s(C,{skipStore:!0}),C=null;else{const r=document.querySelector("#reservations-tab .sub-tab-button.active"),i=a(),o=r?.getAttribute("data-sub-tab")||i;o&&(console.log("⭐ Initial sub-tab:",o),s(o,{skipStore:!0}))}En()}function Ne(e){typeof me=="function"?me(e,{skipStore:!0}):e&&(C=e)}function ss(){try{if(typeof We=="function")return We()||{}}catch(e){console.warn("⚠️ [tabs.js] Failed to read cached preferences",e)}return{}}function os({attemptsLeft:e=0}={}){if(!le||typeof $t!="function")return!1;const t=ss(),n=Array.from(document.querySelectorAll("[data-tab]"));if(!n.length)return!1;const a=n[0]?.dataset.tab||null,r=[se,document.querySelector("[data-tab].active")?.getAttribute("data-tab")||null,t.dashboardTab,ce(kt),a].filter(Boolean).find(o=>document.getElementById(o));if(!r)return!1;const i=()=>{const o=document.querySelector(`[data-tab].active[data-tab="${r}"]`),l=document.getElementById(r);return!!(o&&l?.classList.contains("active")&&l?.style.display!=="none")};if(r==="reservations-tab"){const o=Array.from(document.querySelectorAll("#reservations-tab .sub-tab-button"));if(!o.length)return!1;const l=o[0]?.getAttribute("data-sub-tab")||null,u=[N,document.querySelector("#reservations-tab .sub-tab-button.active")?.getAttribute("data-sub-tab")||null,document.querySelector("#reservations-tab .sub-tab.active")?.id||null,t.dashboardSubTab,ce(G),l].filter(Boolean).find(h=>document.getElementById(h)),m=document.querySelector("#reservations-tab .sub-tab-button.active"),p=document.querySelector("#reservations-tab .sub-tab.active"),b=p?.id||m?.getAttribute("data-sub-tab")||null;if(u&&b===u&&i())return p&&(p.removeAttribute("hidden"),p.style.display="block",p.setAttribute("aria-hidden","false")),!0;if(u)C=u;else if(e>0)return!1}else if(i())return!0;return $t(r,{skipStore:!0,skipRender:!0}),!0}function Vt(){if(!le)return;let e=0;const t=5;ge&&(clearTimeout(ge),ge=null);const n=()=>{if(os({attemptsLeft:t-e})){ge=null;return}if(e>=t){ge=null;return}e+=1,ge=setTimeout(n,50*(e+1))};n()}document.addEventListener("language:translationsReady",Vt);document.addEventListener("language:changed",Vt);document.addEventListener("theme:changed",Vt);const Fe={projects:["stat-projects","sidebar-stat-projects"],reservations:["stat-reservations","sidebar-stat-reservations"],equipment:["stat-equipment","sidebar-stat-equipment"],technicians:["stat-technicians","sidebar-stat-technicians"]};let Ct=!1;const is=1632,cs=1776;function ls(e){if(e==null)return 0;if(typeof e=="number"&&Number.isFinite(e))return e;const t=String(e).trim().replace(/[\s,_]/g,"").replace(/[\u0660-\u0669]/g,a=>String(a.charCodeAt(0)-is)).replace(/[\u06f0-\u06f9]/g,a=>String(a.charCodeAt(0)-cs)).replace(/[^0-9.+-]/g,""),n=Number(t);return Number.isFinite(n)?n:0}function ds(e){try{const t=ls(e);return new Intl.NumberFormat("en-US",{maximumFractionDigits:0,useGrouping:!0}).format(t)}catch{return String(e??0)}}function Pe(e,t){if(!e)return;const n=document.getElementById(e);n&&(n.textContent=ds(t))}function pn(){Ct=!1;const e=ee(),t=Array.isArray(e.projects)?e.projects.length:0,n=Array.isArray(e.reservations)?e.reservations.length:0,a=Array.isArray(e.equipment)?e.equipment.length:0,s=Array.isArray(e.technicians)?e.technicians.length:0;Fe.projects.forEach(r=>Pe(r,t)),Fe.reservations.forEach(r=>Pe(r,n)),Fe.equipment.forEach(r=>Pe(r,a)),Fe.technicians.forEach(r=>Pe(r,s))}function fn(){Ct||(Ct=!0,typeof requestAnimationFrame=="function"?requestAnimationFrame(pn):setTimeout(pn,16))}function us(){["reservations:changed","projects:changed","equipment:changed","technicians:changed","customers:changed","maintenance:changed","language:changed"].forEach(t=>{document.addEventListener(t,fn,{passive:!0})}),fn()}function ms(){const e=document.getElementById("dashboard-sidebar"),t=document.getElementById("sidebar-backdrop"),n=document.getElementById("sidebar-open"),a=document.getElementById("sidebar-close");return{sidebar:e,backdrop:t,openTrigger:n,closeTrigger:a}}function ps({sidebar:e,backdrop:t}){e?.classList.add("open"),t?.classList.add("open"),e?.setAttribute("aria-hidden","false")}function je({sidebar:e,backdrop:t}){e?.classList.remove("open"),t?.classList.remove("open"),e?.setAttribute("aria-hidden","true")}function fs(){const e=document.querySelector("[data-dashboard-greeting]");if(!e)return;const t=e.querySelector("[data-greeting-toggle]"),n=e.querySelector("[data-greeting-panel]");if(!t||!n)return;const a=o=>{o.target instanceof Node&&(e.contains(o.target)||i(!1))},s=()=>{window.requestAnimationFrame(()=>{document.addEventListener("click",a,{capture:!0})})},r=()=>{document.removeEventListener("click",a,{capture:!0})},i=o=>{n.hidden=!o,t.setAttribute("aria-expanded",String(o)),e.dataset.state=o?"open":"closed",o?s():r()};i(!1),t.addEventListener("click",()=>{const l=!(t.getAttribute("aria-expanded")==="true");i(l),l&&!window.matchMedia("(min-width: 768px)").matches&&n.scrollIntoView({behavior:"smooth",block:"start"})})}function bs(){const e=ms(),{sidebar:t,backdrop:n,openTrigger:a,closeTrigger:s}=e;t&&(t.setAttribute("aria-hidden","true"),a?.addEventListener("click",r=>{r.preventDefault(),ps(e)}),s?.addEventListener("click",r=>{r.preventDefault(),je(e)}),n?.addEventListener("click",()=>{je(e)}),t.addEventListener("click",r=>{const i=r.target;if(i instanceof HTMLElement){if(i.hasAttribute("data-close-sidebar")||i.closest("[data-close-sidebar]")){je(e);return}i.closest("[data-tab]")&&je(e)}}),fs())}pa();let R=null;async function bn(){if(!await fa())return;bs(),as(),us(),ba(),Bt(),_a(),et(),ns(),Ka(),ha(),En();const t=document.getElementById("excel-upload");t&&t.addEventListener("change",async a=>{const s=a.target.files&&a.target.files[0];s&&(await $a(s),a.target.value="")});const n=document.getElementById("excel-upload-trigger");n&&t&&n.addEventListener("click",a=>{a.preventDefault(),t.click()}),document.getElementById("logout-btn")?.addEventListener("click",ga),gs(),hs()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{bn().catch(e=>{console.error("❌ Failed to initialise app",e)})},{once:!0}):bn().catch(e=>{console.error("❌ Failed to initialise app",e)});function gs(){document.querySelectorAll('input[type="datetime-local"]').forEach(e=>{e.addEventListener("input",()=>{const t=e.value;if(!t.includes("T"))return;const[n,a]=t.split("T"),[s]=a.split(":"),r=`${s.padStart(2,"0")}:00`,i=`${n}T${r}`;e.value!==i&&(e.value=i,setTimeout(()=>e.blur(),150))})})}function hs(){const e=new URLSearchParams(window.location.search),t=e.get("reservationEditId"),n=e.get("reservationEditIndex");if(!t&&!n)return;R={reservationId:t,reservationIndex:n!=null?Number(n):null},ea(),e.delete("reservationEditId"),e.delete("reservationEditIndex");const a=e.toString(),s=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;window.history.replaceState({},document.title,s)}function ea(){if(!R)return;const t=ee().reservations||[];let n=null;if(R.reservationId){const a=t.findIndex(s=>String(s?.id)===R.reservationId||String(s?.reservationId)===R.reservationId);a!==-1&&(n=a)}n===null&&typeof R.reservationIndex=="number"&&!Number.isNaN(R.reservationIndex)&&R.reservationIndex>=0&&R.reservationIndex<t.length&&(n=R.reservationIndex),n!==null&&(R=null,setTimeout(()=>{document.querySelector('[data-tab="reservations-tab"]')?.click(),setTimeout(()=>{document.querySelector('.sub-tab-button[data-sub-tab="my-reservations-tab"]')?.click(),setTimeout(()=>{const s=window.editReservation;typeof s=="function"&&s(n)},150)},150)},150))}document.addEventListener("reservations:changed",()=>{R&&ea()});
