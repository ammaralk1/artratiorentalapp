import{t as c,d as ne,e as Z,n as f,f as pe,b as K,A as Rn,s as hs,h as ys,j as A,k as Yt,o as Fn,u as De,p as et,q as vs,r as Ss,a as ws,c as Ts,i as Es,l as xs}from"./auth.js";import{r as As,a as Pn,l as Ls}from"./controller.js";/* empty css   */import{r as $s}from"./customers.js";import{e as Cs,i as Is,g as kt,r as Wt,a as ks,s as _s,c as qs,D as jn,m as Ds,b as Hn,d as Ms,n as Bs,f as Ns,h as Rs,j as Gt,k as Fs,l as Ps,u as js}from"./projectsService.js";import{s as On}from"./events.js";const Hs={limit:200};let $=null,gn=!1,hn=!1,yn=!1,vn=!1,vt=null,St=null,wt=!1,le="";function _(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function zn(){const e=document.getElementById("calendar"),t=document.getElementById("calendar-panel")||e?.parentElement||null,n=document.getElementById("calendar-status");return{calendarEl:e,panelEl:t,statusEl:n}}function Os(){return typeof FullCalendar<"u"?FullCalendar:typeof window<"u"&&window.FullCalendar?window.FullCalendar:typeof globalThis<"u"&&globalThis.FullCalendar?globalThis.FullCalendar:null}function Te({loading:e=!1,error:t="",empty:n=!1}={}){const{panelEl:a,statusEl:r}=zn();if(!a||!r)return;const s=typeof t=="string"?t.trim().length>0:!!t,o=!e&&!s&&!!n,i=e||s||o;if(a.classList.toggle("is-loading",e),a.classList.toggle("has-error",s),a.classList.toggle("is-empty",o),r.dataset.initialized||(r.classList.add("alert","rounded-3xl","shadow-soft","bg-base-100/95","border","border-dashed","border-primary/30","text-base-content","text-sm","font-semibold","px-6","py-5","flex","flex-col","items-center","justify-center","gap-3","backdrop-blur-sm","text-center"),r.dataset.initialized="true"),r.classList.remove("alert-info","alert-error","alert-warning","alert-success"),r.classList.toggle("hidden",!i),!i){r.textContent="",r.removeAttribute("data-status");return}let d="";e?d=c("calendar.status.loading","⏳ جارٍ تحميل الحجوزات..."):s?d=typeof t=="string"&&t.trim().length>0?t:c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً."):o&&(d=c("calendar.status.empty","لا توجد حجوزات لعرضها في هذه الفترة."));const l=e?"loading":s?"error":"empty";if(r.setAttribute("data-status",l),e?r.classList.add("alert-info"):s?r.classList.add("alert-error"):r.classList.add("alert-warning"),r.innerHTML="",e){const m=document.createElement("span");m.className="loading loading-spinner loading-sm text-primary",m.setAttribute("aria-hidden","true"),r.appendChild(m)}const u=document.createElement("span");u.className="status-message",u.textContent=d,r.appendChild(u)}function Tt(){$&&($.destroy(),$=null)}function zs(e,t=null){if(!e||typeof e!="object")return null;const n=e.start??e.startDatetime??e.start_datetime??null,a=e.end??e.endDatetime??e.end_datetime??n;if(!n)return null;String(e.status??"").toLowerCase();const r=e.paidStatus??e.paid_status??null,s=e.paid!=null?e.paid:r==="paid",{effectiveConfirmed:o}=Wt(e,t),i=e.reservationId??e.reservationCode??e.reservation_code??e.id??n,d=e.customerName??e.customer_name??"";let l=!!e.completed;if(!l&&a){const u=new Date(a);Number.isNaN(u.getTime())||(l=u<new Date)}return{id:e.id??i??n,start:n,end:a||n,paid:s,confirmed:o,completed:l,reservationId:i??"",customerName:d,raw:e}}function Vn(e=[]){const{projects:t=[]}=Z(),n=new Map(t.map(a=>[String(a.id),a]));return e.map(a=>{const r=a?.projectId??a?.project_id??null,s=r!=null&&r!==""&&n.get(String(r))||null,o=zs(a,s);if(!o)return null;const i=Ks({...a,paid:o.paid,confirmed:o.confirmed,completed:o.completed});return{id:o.id,title:"",start:o.start,end:o.end,backgroundColor:i.background,borderColor:i.border,textColor:i.text,display:"auto",extendedProps:{...a,paid:o.paid,confirmed:o.confirmed,completed:o.completed,reservationId:o.reservationId,customerName:o.customerName}}}).filter(Boolean)}function Sn(){return{today:c("calendar.buttons.today","اليوم"),month:c("calendar.buttons.month","شهر"),week:c("calendar.buttons.week","أسبوع"),day:c("calendar.buttons.day","يوم")}}async function Vs(){if(wt)return kt();wt=!0,le="";try{await Cs({suppressError:!1,params:Hs})}catch(e){console.error("❌ [calendar] Failed to load reservations for calendar view",e),le=Is(e)?e.message:e instanceof Error&&e.message||""}finally{wt=!1}return kt()}function Un(e){$&&$.batchRendering(()=>{$.removeAllEvents(),$.addEventSource(e)})}function Yn(e){const t={events:e};typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("calendar:updated",{detail:t})):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("calendar:updated",{detail:t}))}function Wn(){const e=kt(),t=Vn(e);if(!$){it();return}$.setOption("locale",ne()),Un(t),Me(),Te({loading:!1,error:"",empty:t.length===0}),Yn(t)}function Us(){gn||(document.addEventListener("language:changed",()=>{$&&$.setOption("locale",ne()),it()}),gn=!0),hn||(document.addEventListener("reservations:changed",()=>{Wn()}),hn=!0)}function Gn(){return typeof window>"u"?"dayGridMonth":window.innerWidth<=768?"listWeek":"dayGridMonth"}function Me(){if(!$)return;const e=Gn();$.view?.type!==e&&$.changeView(e),$.updateSize()}function Ys(){yn||typeof window>"u"||(window.addEventListener("resize",()=>{Me()}),yn=!0)}function Ws(){if(vn||typeof MutationObserver>"u"||typeof document>"u")return;const e=()=>{St&&clearTimeout(St),St=setTimeout(()=>{$&&Wn()},80)};vt=new MutationObserver(e),vt.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),document.body&&vt.observe(document.body,{attributes:!0,attributeFilter:["class"]}),vn=!0}function Gs(){return typeof document>"u"?!1:document.documentElement?.classList.contains("dark-mode")||document.body?.classList.contains("dark-mode")}function Ks({paid:e,confirmed:t,completed:n}={}){const a=Gs(),r=e===!0||e==="paid",s=t===!0||t==="true";return n===!0||n==="true"?a?{background:"rgba(148, 163, 184, 0.28)",border:"rgba(148, 163, 184, 0.55)",text:"#f8fafc"}:{background:"rgba(148, 163, 184, 0.22)",border:"rgba(148, 163, 184, 0.45)",text:"#1f2937"}:s?r?a?{background:"rgba(79, 70, 229, 0.25)",border:"rgba(129, 140, 248, 0.65)",text:"#e0e7ff"}:{background:"rgba(99, 102, 241, 0.16)",border:"rgba(79, 70, 229, 0.42)",text:"#1e1b4b"}:a?{background:"rgba(248, 113, 113, 0.32)",border:"rgba(248, 113, 113, 0.65)",text:"#fee2e2"}:{background:"rgba(248, 113, 113, 0.18)",border:"rgba(220, 38, 38, 0.35)",text:"#991b1b"}:a?{background:"rgba(251, 191, 36, 0.28)",border:"rgba(251, 146, 60, 0.6)",text:"#fff7ed"}:{background:"rgba(251, 191, 36, 0.18)",border:"rgba(217, 119, 6, 0.4)",text:"#92400e"}}function Xs(e){const{reservationId:t,customerName:n,paid:a,confirmed:r,completed:s}=e.event.extendedProps,o=a===!0||a==="paid",i=r===!0||r==="true",d=document.createElement("div");d.className="fc-reservation-event flex flex-col gap-2 text-xs leading-5 text-base-content";const l=i?c("calendar.badges.confirmed","مؤكد"):c("calendar.badges.pending","غير مؤكد"),u=o?c("calendar.badges.paid","مدفوع"):c("calendar.badges.unpaid","غير مدفوع"),m=c("calendar.badges.completed","منتهي"),p=c("calendar.labels.unknownCustomer","غير معروف"),g=[`<span class="reservation-chip ${i?"status-confirmed":"status-pending"}">${_(l)}</span>`,`<span class="reservation-chip ${o?"status-paid":"status-unpaid"}">${_(u)}</span>`];s&&g.push(`<span class="reservation-chip status-completed">${_(m)}</span>`);const y=_(t||"—"),S=_(n||p);return d.innerHTML=`
    <div class="fc-reservation-id text-[0.78rem] font-semibold">${y}</div>
    <div class="fc-reservation-customer text-[0.72rem] text-base-content/70">${S}</div>
    <div class="fc-reservation-tags flex flex-wrap items-center gap-2 pt-1">${g.join("")}</div>
  `,{domNodes:[d]}}function Qs(e){const t=document.getElementById("calendar-reservation-details");if(!t){alert(c("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"));return}const n=Z(),a=Array.isArray(n?.projects)?n.projects:[],r=e.projectId??e.project_id??null,s=r!=null&&a.find(v=>String(v.id)===String(r))||null,{effectiveConfirmed:o,projectLinked:i}=Wt(e,s),d=o??(e.confirmed===!0||e.confirmed==="true"),l=e.paid===!0||e.paid==="paid",u=!!e.completed,m=d?c("calendar.badges.confirmed","مؤكد"):c("calendar.badges.pending","غير مؤكد"),p=l?c("calendar.badges.paid","مدفوع"):c("calendar.badges.unpaid","غير مدفوع"),g=c("calendar.badges.completed","منتهي"),y=e.items||[],S=ks(y),w=_s()||[],q=new Map(w.map(v=>[String(v.id),v])),E=(e.technicians||[]).map(v=>q.get(String(v))).filter(Boolean),V=qs(e.start,e.end),se=y.reduce((v,L)=>v+(L.qty||1)*(L.price||0),0)*V,_e=(v={})=>{const L=[v.dailyWage,v.daily_rate,v.dailyRate,v.wage,v.rate];for(const U of L){if(U==null)continue;const Se=parseFloat(f(String(U)));if(Number.isFinite(Se))return Se}return 0},N=E.reduce((v,L)=>v+_e(L),0)*V,W=se+N,M=c("reservations.create.summary.currency","ريال"),He=M,xa=c("reservations.create.equipment.imageAlt","صورة"),Aa=S.reduce((v,L)=>v+(Number(L.quantity)||0),0),La=S.length?S.map(v=>{const L=v.items[0]||{},U=As(L)||v.image||L.image||L.imageUrl||"",Se=U?`<img src="${U}" alt="${xa}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">🎥</div>',Ve=Number(v.quantity)||Number(v.count)||0,ms=f(String(Ve)),fn=Number.isFinite(Number(v.unitPrice))?Number(v.unitPrice):0,ps=Number.isFinite(Number(v.totalPrice))?Number(v.totalPrice):fn*Ve,fs=`${f(fn.toFixed(2))} ${He}`,bs=`${f(ps.toFixed(2))} ${He}`,bn=v.barcodes.map(yt=>f(String(yt||""))).filter(Boolean),gs=bn.length?`<details class="reservation-item-barcodes">
              <summary>${c("reservations.equipment.barcodes.summary","عرض الباركودات")}</summary>
              <ul class="reservation-barcode-list">
                ${bn.map(yt=>`<li>${yt}</li>`).join("")}
              </ul>
            </details>`:"";return`
          <tr>
            <td>
              <div class="reservation-item-info">
                <div class="reservation-item-thumb-wrapper">${Se}</div>
                <div class="reservation-item-copy">
                  <div class="reservation-item-title">${_(L.desc||L.description||L.name||v.description||"-")}</div>
                  ${gs}
                </div>
              </div>
            </td>
            <td>
              <div class="reservation-quantity-control reservation-quantity-control--static">
                <button type="button" class="reservation-qty-btn" disabled aria-disabled="true" tabindex="-1">−</button>
                <span class="reservation-qty-value">${ms}</span>
                <button type="button" class="reservation-qty-btn" disabled aria-disabled="true" tabindex="-1">+</button>
              </div>
            </td>
            <td>${fs}</td>
            <td>${bs}</td>
            <td>
              <button type="button" class="reservation-remove-button" disabled aria-disabled="true" tabindex="-1">🗑️</button>
            </td>
          </tr>
        `}).join(""):`<tr><td colspan="5" class="text-center">${c("calendar.labels.noEquipment","لا توجد معدات")}</td></tr>`,$a=c("reservations.details.labels.paymentStatus","حالة الدفع"),Ca=c("reservations.details.labels.itemsCount","عدد المعدات"),Ia=c("reservations.details.labels.duration","عدد الأيام"),ka=c("reservations.details.labels.itemsTotal","إجمالي المعدات"),_a=c("reservations.details.labels.crewTotal","إجمالي الفريق"),qa=c("reservations.details.labels.discount","الخصم"),Da=c("reservations.details.labels.subtotalAfterDiscount","الإجمالي بعد الخصم"),Ma=c("reservations.details.labels.tax","الضريبة (15%)"),Ba=c("reservations.details.labels.companyShare","🏦 نسبة الشركة"),Na=c("reservations.details.labels.netProfit","💵 صافي الربح"),Ra=c("reservations.details.labels.finalTotal","المجموع النهائي"),Fa=c("reservations.details.items.count","{count} عنصر"),Pa=c("reservations.list.payment.paid","💳 مدفوع"),ja=c("reservations.list.payment.unpaid","💳 غير مدفوع"),mt=parseFloat(e.discount)||0,Ha=e.discountType==="percent",pt=mt<=0?0:Ha?W*(mt/100):mt,ft=Math.max(0,W-pt),bt=i?!1:e.applyTax,Oe=bt?ft*.15:0,cn=Number(e.cost),Oa=Number.isFinite(cn),ln=ft+Oe,ve=i?Math.round(ln):Oa?cn:Math.round(ln),dn=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share,ze=dn!=null?parseFloat(f(String(dn))):NaN;let re=((e.companyShareEnabled??e.company_share_enabled??e.companyShareApplied)===!0||Number.isFinite(ze)&&ze>0)&&Number.isFinite(ze)?ze:0,gt=re>0?Math.max(0,(Number.isFinite(ve)?ve:0)*(re/100)):0;bt&&re<=0&&(re=jn,gt=Math.max(0,(Number.isFinite(ve)?ve:0)*(re/100)));const za=l?Pa:ja,Va=f(String(V)),Ua=f(se.toFixed(2)),Ya=f(N.toFixed(2)),Wa=f(pt.toFixed(2)),Ga=f(ft.toFixed(2)),Ka=f(Oe.toFixed(2)),ht=Number.isFinite(ve)?ve:0,Xa=f(ht.toFixed(2)),Qa=f(re.toFixed(2)),Za=f(gt.toFixed(2)),un=Math.max(0,ht-Oe-gt),Ja=f(un.toFixed(2)),es=f(String(Aa)),ts=Fa.replace("{count}",es),oe=[{icon:"💳",label:$a,value:za},{icon:"📦",label:Ca,value:ts},{icon:"⏱️",label:Ia,value:Va},{icon:"💼",label:ka,value:`${Ua} ${M}`},{icon:"😎",label:_a,value:`${Ya} ${M}`}];pt>0&&oe.push({icon:"💸",label:qa,value:`${Wa} ${M}`}),oe.push({icon:"📊",label:Da,value:`${Ga} ${M}`}),bt&&Oe>0&&oe.push({icon:"🧾",label:Ma,value:`${Ka} ${M}`}),re>0&&oe.push({icon:"🏦",label:Ba,value:`${Qa}% (${Za} ${M})`}),Math.abs(un-ht)>.009&&oe.push({icon:"💵",label:Na,value:`${Ja} ${M}`}),oe.push({icon:"💰",label:Ra,value:`${Xa} ${M}`});const ns=oe.map(({icon:v,label:L,value:U})=>{const Se=_(L),Ve=_(String(U));return`
        <div class="summary-row flex items-center justify-between gap-3 rounded-2xl bg-base-200/50 px-4 py-3 text-sm text-base-content shadow-inner">
          <span class="summary-row-label inline-flex items-center gap-2 text-base-content/70">${v} ${Se}</span>
          <span class="summary-row-value font-semibold text-base-content">${Ve}</span>
        </div>
      `}).join(""),as=f(String(e.reservationId??e.id??""))||"—",ss=e.start?f(pe(e.start)):"-",rs=e.end?f(pe(e.end)):"-",os=e.notes?f(e.notes):c("calendar.labels.noNotes","لا توجد ملاحظات"),is=e.customerName||c("calendar.labels.unknownCustomer","غير معروف"),cs=[{icon:"🆔",label:c("calendar.labels.reservationId","رقم الحجز"),value:as},{icon:"👤",label:c("calendar.labels.customer","العميل"),value:is},{icon:"🗓️",label:c("calendar.labels.start","بداية الحجز"),value:ss},{icon:"🗓️",label:c("calendar.labels.end","نهاية الحجز"),value:rs},{icon:"📝",label:c("calendar.labels.notes","الملاحظات"),value:os}],mn=[`<span class="reservation-chip ${d?"status-confirmed":"status-pending"}">${_(m)}</span>`,`<span class="reservation-chip ${l?"status-paid":"status-unpaid"}">${_(p)}</span>`];u&&mn.push(`<span class="reservation-chip status-completed">${_(g)}</span>`);const ls=cs.map(v=>{const L=_(String(v.value??"—")).replace(/\n/g,"<br>");return`
        <div class="calendar-info-row flex items-start justify-between gap-3 border-b border-base-200/60 py-3 first:pt-0 last:border-none last:pb-0">
          <span class="label inline-flex items-center gap-2 text-base-content/70">
            <span class="text-lg leading-none" aria-hidden="true">${_(v.icon)}</span>
            <span class="text-sm">${safeLabel}</span>
          </span>
          <span class="value text-end text-sm font-semibold text-base-content">${L}</span>
        </div>
      `}).join(""),ds=E.length?`<ul class="calendar-reservation-technicians grid gap-3 md:grid-cols-2">${E.map(v=>{const L=_(v.name||"-"),U=_(v.role?v.role:c("reservations.details.technicians.roleUnknown","غير محدد"));return`<li class="calendar-technician-card flex items-center justify-between gap-3 rounded-2xl border border-base-200 bg-base-100/90 p-4 shadow-sm">
          <span class="font-semibold text-base-content">${L}</span>
          <span class="text-sm text-base-content/70">${U}</span>
        </li>`}).join("")}</ul>`:`<div class="calendar-empty-state rounded-3xl border border-dashed border-base-300 bg-base-100/80 px-5 py-6 text-center text-sm text-base-content/70">${_(c("calendar.emptyStates.noCrew","😎 لا يوجد فريق مرتبط بهذا الحجز."))}</div>`,us=`
    <div class="reservation-modal-items-wrapper overflow-x-auto rounded-3xl border border-base-200 bg-base-100 shadow-soft">
      <table class="table table-zebra table-sm align-middle reservation-modal-items-table">
        <thead>
          <tr>
            <th>${c("reservations.equipment.table.item","المعدة")}</th>
            <th>${c("reservations.equipment.table.quantity","الكمية")}</th>
            <th>${c("reservations.equipment.table.unitPrice","سعر الوحدة")}</th>
            <th>${c("reservations.equipment.table.total","الإجمالي")}</th>
            <th>${c("reservations.equipment.table.actions","الإجراءات")}</th>
          </tr>
        </thead>
        <tbody>${La}</tbody>
      </table>
    </div>
  `;t.innerHTML=`
    <div class="calendar-reservation-layout flex flex-col gap-8 text-base-content">
      <div class="calendar-reservation-status flex flex-wrap items-center gap-3">${mn.join("")}</div>
      <div class="calendar-reservation-info rounded-3xl border border-base-200 bg-base-100/90 p-6 shadow-soft">
        ${ls}
      </div>
      <section class="calendar-reservation-section flex flex-col gap-4">
        <h6 class="calendar-section-title text-base font-semibold text-base-content">${c("calendar.sections.crew","😎 الفريق الفني")}</h6>
        ${ds}
      </section>
      <section class="calendar-reservation-section flex flex-col gap-4">
        <h6 class="calendar-section-title text-base font-semibold text-base-content">${c("calendar.sections.equipment","📦 المعدات")}</h6>
        ${us}
      </section>
      <div class="calendar-reservation-summary grid gap-3 rounded-3xl border border-base-200 bg-base-100/90 p-6 shadow-soft">
        ${ns}
      </div>
    </div>
  `;const pn=document.getElementById("calendarReservationModal");pn&&window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(pn).show():alert(c("calendar.alerts.cannotOpenModal","لا يمكن فتح نافذة التفاصيل"))}function it(){Us(),Ys(),Ws();const{calendarEl:e}=zn();if(!e)return;const t=Os();if(!t||typeof t.Calendar!="function"){const n=c("calendar.status.missingLibrary","تعذر تحميل مكتبة التقويم. يرجى تحديث الصفحة.");Te({error:n}),Tt();return}(async()=>{Te({loading:!0});const n=await Vs();if(le){const r=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");Te({loading:!1,error:le||r}),Tt();return}const a=Vn(n);$?($.setOption("locale",ne()),$.setOption("buttonText",Sn()),Un(a)):($=new t.Calendar(e,{initialView:Gn(),locale:ne(),timeZone:"local",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},buttonText:Sn(),events:a,eventContent:Xs,eventClick(r){Qs(r.event.extendedProps)},windowResize:Me}),$.render()),Me(),Yn(a),Te({loading:!1,error:"",empty:a.length===0}),setTimeout(()=>{Me()},120)})().catch(n=>{console.error("❌ [calendar] renderCalendar failed",n),le=n instanceof Error&&n.message||le||"";const a=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");Te({loading:!1,error:le||a}),Tt()})}let _t=null,Ke=null,Xe=null;const h={range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null};let wn=!1,Tn=!1,xe=null;const T={reservations:[],customers:[],equipment:[],technicians:[],projects:[],projectsMap:new Map};let Qe=!1,tt="";const R={icon:null,title:null,subtitle:null};let En=!1;const Et=new Map;let xt=null,At=null,Lt=null,Ae=null;const x={trend:null,status:null,payment:null},ie={filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[]},qt={code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0};let xn=!1,An=!1,Ln=!1,Kn=[],$t=[],Ct=[],$n=!1,j=null,H=null,Cn=null,In=null;function b(e,t,n=t){const a=ne()==="en"?n??t:t;return c(e,a)}function kn(){It(),k(),setTimeout(()=>{It(),k(),Ze()},0),setTimeout(()=>{It(),k(),Ze()},60),Ze()}function Ee(){h.range==="custom"&&k()}function It(){_t=null,Ke=null,Xe=null}function Kt(){return(ne()||"ar").toLowerCase().startsWith("ar")?"ar-EG":"en-US"}function Xn(){const e=ne();if(e!==_t||!Ke||!Xe){_t=e;const t=Kt();Ke=new Intl.NumberFormat(t,{maximumFractionDigits:0}),Xe=new Intl.NumberFormat(t,{style:"currency",currency:"SAR",maximumFractionDigits:0})}return{numberFormatter:Ke,currencyFormatter:Xe}}function Zs(e){const t=Kt();return new Intl.DateTimeFormat(t,{month:"short"}).format(e)}function Dt(e){const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return"";const n=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");return`${n}-${a}-${r}`}function Xt(e){if(Et.has(e))return Et.get(e);const t=document.querySelector(`script[src="${e}"]`),n=new Promise((a,r)=>{const s=()=>{t&&(t.dataset.loaded="true"),a()},o=d=>r(d);if(t){if(t.dataset.loaded==="true"){a();return}t.addEventListener("load",s,{once:!0}),t.addEventListener("error",o,{once:!0});return}const i=document.createElement("script");i.src=e,i.async=!0,i.onload=()=>{i.dataset.loaded="true",a()},i.onerror=d=>r(d),document.head.appendChild(i)});return Et.set(e,n),n}function Qt(){return window.ApexCharts?Promise.resolve(window.ApexCharts):(xt||(xt=Xt("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),xt)}function Js(){return window.html2pdf?Promise.resolve(window.html2pdf):(At||(At=Xt("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),At)}function er(){return window.XLSX?Promise.resolve(window.XLSX):(Lt||(Lt=Xt("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),Lt)}function nt(){const e=document.documentElement;return e.classList.contains("dark")||e.dataset.theme==="dark"?"dark":"light"}function Qn(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function Zn(e={}){const t=f(String(e?.barcode??"")).trim(),n=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:t,desc:n,description:n,name:e?.name??n,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function Jn(e={}){const t=e?.title??e?.name??"",n=e?.project_code??e?.projectCode??"",a=e?.status??"",r=e?.confirmed===!0||at(a)==="confirmed"||at(a)==="completed";return{id:e?.id!=null?String(e.id):"",title:t,code:n,status:a,confirmed:r}}function tr(){if(typeof Z!="function")return!1;let e;try{e=Z()}catch(i){return console.warn("⚠️ [reports] Failed to access cached data",i),!1}if(!e||typeof e!="object")return!1;const{reservations:t=[],customers:n=[],equipment:a=[],technicians:r=[],projects:s=[]}=e;return t.length||n.length||a.length||r.length||s.length?(T.reservations=Array.isArray(t)?t.map(Ds):[],T.customers=Array.isArray(n)?n.map(Qn):[],T.equipment=Array.isArray(a)?a.map(Zn):[],T.technicians=Array.isArray(r)?r.map(Hn):[],T.projects=Array.isArray(s)?s.map(Jn):[],T.projectsMap=new Map(T.projects.map(i=>[i.id,i])),Ae=new Map((T.technicians||[]).map(i=>[String(i.id),i])),!0):!1}const nr=1440*60*1e3;function ar(e,t){if(!e||!t)return 1;const n=new Date(e),a=new Date(t);if(Number.isNaN(n.getTime())||Number.isNaN(a.getTime()))return 1;const r=a.getTime()-n.getTime();return r<=0?1:Math.max(1,Math.ceil(r/nr))}function sr(e){return e?(Ae||(Ae=new Map((T.technicians||[]).map(t=>[String(t.id),t]))),Ae.get(String(e))||null):null}function rr(e={}){const t=[e.dailyWage,e.daily_rate,e.dailyRate,e.wage,e.rate];for(const n of t){if(n==null)continue;const a=Number.parseFloat(f(String(n)));if(Number.isFinite(a))return a}return 0}function je(e){if(!e)return{rentalDays:1,equipmentTotal:0,crewTotal:0,discountAmount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(e.__financials)return e.__financials;const t=ar(e.start,e.end),a=(e.items||[]).reduce((N,W)=>{const M=Number(W?.qty)||Number(W?.quantity)||1,He=Number(W?.price)||Number(W?.unit_price)||0;return N+M*He},0)*t,s=(e.technicians||[]).reduce((N,W)=>{const M=sr(W);return N+rr(M)},0)*t,o=a+s,i=Number(e.discount)||0;let l=(e.discountType||e.discount_type||"percent")==="amount"?i:o*(i/100);(!Number.isFinite(l)||l<0)&&(l=0),l>o&&(l=o);const u=Math.max(0,o-l),m=e.applyTax===!0||e.apply_tax===!0||e.apply_tax===1||e.apply_tax==="1";let p=m?u*.15:0;(!Number.isFinite(p)||p<0)&&(p=0);const g=Number(e.cost),y=u+p;let S=Math.max(0,Math.round(y));if(Number.isFinite(g)&&g>0&&(S=g,m)){const N=S-u;Number.isFinite(N)&&N>=0&&(p=N)}const w=e.companySharePercent??e.company_share_percent??e.companyShare??e.company_share??null,q=w!=null?Number.parseFloat(f(String(w).replace("%","").trim())):NaN,E=e.companyShareEnabled??e.company_share_enabled??e.companyShareApplied??e.company_share_applied??null;let V=E!=null?E===!0||E===1||E==="1"||String(E).toLowerCase()==="true":Number.isFinite(q)&&q>0,J=V&&Number.isFinite(q)?Number(q):0;m&&J<=0&&(J=jn,V=!0);const se=J>0?Math.max(0,S*(J/100)):0,_e=Math.max(0,S-p-se),ee={rentalDays:t,equipmentTotal:a,crewTotal:s,discountAmount:l,taxableAmount:u,taxAmount:p,finalTotal:S,companySharePercent:J,companyShareAmount:se,netProfit:_e};return e.__financials=ee,ee}function ea(e){return e?.projectId&&T.projectsMap.get(String(e.projectId))||null}function ke(e){const t=ea(e),n=Wt(e,t),a=at(n.projectStatus);let r=at(e?.status??e?.reservationStatus??e?.reservation_status??e?.state??"");n.projectLinked&&a&&(r=a),(!r||r==="cancelled")&&(r=n.effectiveConfirmed?"confirmed":"pending"),(Ns(e)||a==="completed")&&(r="completed");const s=n.effectiveConfirmed||r==="confirmed"||r==="completed";s&&r!=="completed"&&(r="confirmed");const o=mr(e);return{statusValue:r,confirmed:s,paid:o}}async function ta({silent:e=!1}={}){if(!Qe){Qe=!0,tt="",e||k();try{const[t,n,a,r,s]=await Promise.all([K("/reservations/?limit=500"),K("/customers/?limit=500"),K("/equipment/?limit=500"),K("/technicians/?limit=500"),K("/projects/?limit=500")]);T.reservations=Array.isArray(t?.data)?t.data.map(o=>Ms(o)):[],T.customers=Array.isArray(n?.data)?n.data.map(Qn):[],T.equipment=Array.isArray(a?.data)?a.data.map(Zn):[],T.technicians=Array.isArray(r?.data)?r.data.map(Hn):[],T.projects=Array.isArray(s?.data)?s.data.map(Jn):[],T.projectsMap=new Map(T.projects.map(o=>[o.id,o])),Ae=new Map((T.technicians||[]).map(o=>[String(o.id),o]))}catch(t){console.error("❌ [reports] Failed to load reports data",t),tt=t instanceof Rn?t.message:c("reservations.reports.error.fetchFailed","تعذر تحميل بيانات التقارير، حاول لاحقاً"),T.reservations=[],T.customers=[],T.equipment=[],T.technicians=[],T.projects=[],T.projectsMap=new Map,Ae=null}finally{Qe=!1,k()}}}function qe(){ta({silent:!0}).catch(e=>{console.error("❌ [reports] Background refresh failed",e)})}function Mt({active:e,icon:t,title:n,subtitle:a}){const r=document.getElementById("reports-empty-state");if(!r)return;const s=r.querySelector(".reports-empty-icon"),o=r.querySelector("h4"),i=r.querySelector("p");R.icon===null&&s&&(R.icon=s.textContent),R.title===null&&o&&(R.title=o.textContent),R.subtitle===null&&i&&(R.subtitle=i.textContent),r.classList.toggle("active",!!e),r.classList.toggle("hidden",!e),!(!s||!o||!i)&&(e?(s.textContent=t!==void 0?t:R.icon??s.textContent,o.textContent=n!==void 0?n:R.title??o.textContent,i.textContent=a!==void 0?a:R.subtitle??i.textContent):(s.textContent=R.icon??s.textContent,o.textContent=R.title??o.textContent,i.textContent=R.subtitle??i.textContent))}function or(){if(wn)return;wn=!0;const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),n=document.getElementById("reports-payment-filter"),a=document.getElementById("reports-share-filter"),r=document.getElementById("reports-start"),s=document.getElementById("reports-end"),o=document.getElementById("reports-refresh"),i=document.getElementById("reports-custom-range"),d=document.getElementById("reports-search");if(!e)return;e.value=h.range,tr()&&k(),e.addEventListener("change",()=>{h.range=e.value,Bt(i,h.range==="custom"),h.range!=="custom"&&(h.start=null,h.end=null),k()}),t?.addEventListener("change",()=>{h.status=t.value,k()}),n?.addEventListener("change",()=>{h.payment=n.value,k()}),a?.addEventListener("change",()=>{h.share=a.value,k()}),d?.addEventListener("input",()=>{const u=d.value||"";xe&&clearTimeout(xe),xe=setTimeout(()=>{h.search=u,k()},220)}),r?.addEventListener("change",()=>{h.start=r.value||null,Ee()}),s?.addEventListener("change",()=>{h.end=s.value||null,Ee()}),o?.addEventListener("click",()=>{h.range==="custom"&&(h.start=r?.value||null,h.end=s?.value||null),k()}),Ze(r,s),Bt(i,!1),Tn||(document.addEventListener("language:changed",kn),document.addEventListener("language:translationsReady",kn),Tn=!0),En||(document.addEventListener("reservations:changed",qe),document.addEventListener("customers:changed",qe),document.addEventListener("equipment:changed",qe),document.addEventListener("projects:changed",qe),document.addEventListener("technicians:updated",qe),En=!0),xr(),Ar(),kr(),$n||(document.addEventListener("theme:changed",()=>{setTimeout(()=>k(),0)}),$n=!0),ta()}function ct(){const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),n=document.getElementById("reports-payment-filter"),a=document.getElementById("reports-share-filter"),r=document.getElementById("reports-search"),s=document.getElementById("reports-start"),o=document.getElementById("reports-end"),i=document.getElementById("reports-custom-range");e&&e.value!==h.range&&(e.value=h.range),t&&t.value!==h.status&&(t.value=h.status),n&&n.value!==h.payment&&(n.value=h.payment),a&&a.value!==h.share&&(a.value=h.share),r&&r.value!==h.search&&(r.value=h.search||""),s&&s.value!==(h.start||"")&&(s.value=h.start||""),o&&o.value!==(h.end||"")&&(o.value=h.end||""),Bt(i,h.range==="custom")}function k(){if(ct(),Qe){Mt({active:!0,icon:"⏳",title:c("reservations.reports.status.loading","جارٍ تحميل التقارير..."),subtitle:c("reservations.reports.status.loadingHint","قد يستغرق هذا بضع ثوانٍ.")});return}if(tt){Mt({active:!0,icon:"⚠️",title:tt,subtitle:c("reservations.reports.status.retry","جرّب إعادة المحاولة أو تحديث الصفحة.")});return}const{reservations:e,customers:t,equipment:n,technicians:a}=T,r=cr(e,h,t,n,a),s=pr(r),o=fr(r),i=br(r),d=gr(r),l=hr(r,t),u=yr(r,n);Hr(s),_r(o),qr(i),Dr(d),Mr(l),Br(u);const m=vr(r,t,a);Nt(),Or(r.length===0),ie.filtered=r,ie.metrics=s,ie.trend=o,ie.statusBreakdown=i,ie.paymentBreakdown=d,ie.tableRows=m}function Ze(e,t){if(!window.flatpickr)return;e&&(Cn=e),t&&(In=t);const n=Cn,a=In;if(!n&&!a)return;const r=ir(),s=o=>{const i={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...o};return r&&(i.locale=r),i};if(j&&(j.destroy(),j=null),H&&(H.destroy(),H=null),n&&(j=window.flatpickr(n,s({onChange(o,i){h.start=i||null,H&&(o?.length?H.set("minDate",o[0]):H.set("minDate",null)),Ee()},onValueUpdate(o,i){h.start=i||null,Ee()}}))),a&&(H=window.flatpickr(a,s({onChange(o,i){h.end=i||null,j&&(o?.length?j.set("maxDate",o[0]):j.set("maxDate",null)),Ee()},onValueUpdate(o,i){h.end=i||null,Ee()}}))),j&&n){j.setDate(n.value,!1);const o=H?.selectedDates?.[0]||a?.value;o&&j.set("maxDate",o)}if(H&&a){H.setDate(a.value,!1);const o=j?.selectedDates?.[0]||n?.value;o&&H.set("minDate",o)}}function ir(){return(ne()||"ar").toLowerCase().startsWith("ar")?window.flatpickr?.l10ns?.ar?"ar":null:window.flatpickr?.l10ns?.en?"en":null}function Bt(e,t){e&&(e.classList.toggle("active",!!t),e.classList.toggle("hidden",!t))}function na(e){return f(String(e||"")).toLowerCase().trim()}function cr(e,t,n,a,r){const{startDate:s,endDate:o}=dr(t),i=na(t.search),d=!!i,l=new Map((n||[]).map(p=>[String(p.id),p])),u=new Map((a||[]).map(p=>[st(p?.barcode),p])),m=new Map((r||[]).map(p=>[String(p.id),p]));return(e||[]).filter(p=>{const g=p?.start?new Date(p.start):null;if(!g||Number.isNaN(g.getTime())||s&&g<s||o&&g>o)return!1;const{statusValue:y,confirmed:S,paid:w}=ke(p);if(t.status==="confirmed"&&!(y==="confirmed"||y==="completed"||S)||t.status==="pending"&&y!=="pending"||t.status==="completed"&&y!=="completed"||t.payment==="paid"&&!w||t.payment==="unpaid"&&w)return!1;if(t.share&&t.share!=="all"){const E=je(p).companySharePercent>0;if(t.share==="with"&&!E||t.share==="without"&&E)return!1}return!(d&&!lr(p,i,l,u,m))})}function lr(e,t,n,a,r){const s=[],o=e?.reservationId||e?.id;o&&s.push(o),e?.notes&&s.push(e.notes);const{statusValue:i,paid:d}=ke(e);i&&s.push(i);const l=e?.paymentStatus||e?.payment_status;l&&s.push(l),e?.paid!=null&&s.push(e.paid?"paid":"unpaid");const u=n.get(String(e?.customerId));u&&s.push(u.customerName,u.company_name||u.companyName,u.contact_person||"");const m=ea(e);return m&&s.push(m.title,m.code,m.status),s.push(aa(d)),(e?.items||[]).forEach(g=>{g?.desc&&s.push(g.desc),g?.barcode&&s.push(g.barcode);const y=a.get(st(g?.barcode));y&&s.push(y.desc,y.description,y.name)}),(e?.technicians||[]).forEach(g=>{const y=r.get(String(g));y&&s.push(y.name,y.role,y.department)}),na(s.filter(Boolean).join(" ")).includes(t)}function dr({range:e,start:t,end:n}){const a=new Date;if(a.setHours(23,59,59,999),e==="custom"){const o=t?new Date(`${t}T00:00:00`):null,i=n?new Date(`${n}T23:59:59`):null;return{startDate:_n(o)?o:null,endDate:_n(i)?i:null}}let r=new Date(a),s=null;switch(e){case"last30":{s=new Date(a),s.setDate(s.getDate()-29);break}case"thisWeek":{const o=new Date(a),d=(o.getDay()-6+7)%7;o.setDate(o.getDate()-d),o.setHours(0,0,0,0);const l=new Date(o);l.setDate(o.getDate()+6),l.setHours(23,59,59,999),s=o,r.setTime(l.getTime());break}case"thisMonth":{s=new Date(a.getFullYear(),a.getMonth(),1);const o=new Date(a.getFullYear(),a.getMonth()+1,0);r.setTime(o.setHours(23,59,59,999));break}case"thisQuarter":{const o=Math.floor(a.getMonth()/3);s=new Date(a.getFullYear(),o*3,1);const i=new Date(a.getFullYear(),(o+1)*3,0);r.setTime(i.setHours(23,59,59,999));break}case"thisYear":{s=new Date(a.getFullYear(),0,1);const o=new Date(a.getFullYear(),12,0);r.setTime(o.setHours(23,59,59,999));break}case"all":default:s=null,r=null;break}return s&&s.setHours(0,0,0,0),{startDate:s,endDate:r}}function _n(e){return e instanceof Date&&!Number.isNaN(e.getTime())}const ur=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"]]),qn=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]);function at(e=""){const t=String(e).toLowerCase().trim();return t?ur.get(t)||t:""}function mr(e){const t=[e?.paymentStatus,e?.payment_status,e?.payment,e?.paymentState,e?.payment_state];for(const n of t){const a=String(n||"").toLowerCase().trim();if(a&&qn.has(a))return qn.get(a)}return e?.paid===!0||e?.paid==="true"}function pr(e){const t=e.length;let n=0,a=0,r=0,s=0,o=0,i=0,d=0;e.forEach(u=>{const{statusValue:m,confirmed:p,paid:g}=ke(u);m==="completed"&&(a+=1),p&&(n+=1),g&&(r+=1);const y=je(u);s+=y.finalTotal,o+=y.companyShareAmount,i+=y.taxAmount,d+=y.netProfit});const l=t?s/t:0;return{total:t,confirmed:n,completed:a,paidCount:r,revenue:s,average:l,companyShareTotal:o,taxTotal:i,netProfit:d}}function fr(e){const t=new Date,n=[];for(let a=5;a>=0;a-=1){const r=new Date(t.getFullYear(),t.getMonth()-a,1),s=r.getFullYear(),o=r.getMonth(),i=e.filter(S=>{const w=S?.start?new Date(S.start):null;return w&&w.getFullYear()===s&&w.getMonth()===o}),d=i.length;let l=0,u=0,m=0;i.forEach(S=>{const w=je(S);l+=w.finalTotal,u+=w.netProfit,m+=w.companyShareAmount});const p=Zs(r),g=new Date(r.getFullYear(),r.getMonth(),1),y=new Date(r.getFullYear(),r.getMonth()+1,0);n.push({label:p,count:d,revenue:l,netProfit:u,companyShare:m,periodStart:g,periodEnd:y,startInput:Dt(g),endInput:Dt(y)})}return n}function br(e){const t={confirmed:0,pending:0,completed:0};(e||[]).forEach(o=>{const{statusValue:i,confirmed:d}=ke(o);i==="completed"?t.completed+=1:i==="confirmed"||d?t.confirmed+=1:t.pending+=1});const n=Math.max(1,(e||[]).length),a=t.confirmed,r=t.pending,s=t.completed;return[{label:b("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:a,percent:Math.round(a/n*100)||0,rawCount:a,className:"status-confirmed",filterKey:"confirmed"},{label:b("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:r,percent:Math.round(r/n*100)||0,rawCount:r,className:"status-pending",filterKey:"pending"},{label:b("reservations.reports.status.completedLabel","منتهية","Completed"),value:s,percent:Math.round(s/n*100)||0,rawCount:s,className:"status-completed",filterKey:"completed"}]}function gr(e){const t=e.length||1,n=e.filter(r=>ke(r).paid).length,a=e.length-n;return[{label:b("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:n,percent:Math.round(n/t*100)||0,rawCount:n,className:"status-paid",filterKey:"paid"},{label:b("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:a,percent:Math.round(a/t*100)||0,rawCount:a,className:"status-unpaid",filterKey:"unpaid"}]}function hr(e,t){const n=new Map,a=new Map((t||[]).map(r=>[String(r.id),r]));return e.forEach(r=>{const s=String(r?.customerId??"unknown"),o=n.get(s)||{count:0,revenue:0},i=je(r);o.count+=1,o.revenue+=i.finalTotal,n.set(s,o)}),Array.from(n.entries()).map(([r,s])=>({name:a.get(r)?.customerName||b("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:s.count,revenue:s.revenue})).sort((r,s)=>s.revenue-r.revenue).slice(0,5)}function yr(e,t){const n=new Map,a=new Map((t||[]).map(s=>[st(s?.barcode),s])),r=b("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment");return e.forEach(s=>{(s?.items||[]).forEach(o=>{const i=st(o?.barcode),d=i?a.get(i):null,l=o?.desc||o?.description||o?.name||d?.desc||d?.description||d?.name||"",u=l&&l.trim()?l:r,m=Bs(u)||"unknown",p=Number(o?.qty)||1,g=Number(o?.price)||0,y=p*g,S=n.get(m)||{name:u,count:0,revenue:0};S.name=u,S.count+=p,S.revenue+=y,n.set(m,S)})}),Array.from(n.values()).sort((s,o)=>o.count!==s.count?o.count-s.count:o.revenue-s.revenue).slice(0,5)}function vr(e,t,n){const a=document.getElementById("reports-reservations-body");if(!a)return[];if(!e||e.length===0)return a.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${b("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`,[];const r=new Map((t||[]).map(i=>[String(i.id),i]));new Map((n||[]).map(i=>[String(i.id),i]));const s={code:b("reservations.reports.results.headers.id","الحجز","Reservation"),customer:b("reservations.reports.results.headers.customer","العميل","Customer"),date:b("reservations.reports.results.headers.date","التاريخ","Date"),status:b("reservations.reports.results.headers.status","الحالة","Status"),payment:b("reservations.reports.results.headers.payment","الدفع","Payment"),total:b("reservations.reports.results.headers.total","الإجمالي","Total"),share:b("reservations.reports.results.headers.share","نسبة الشركة","Company share"),net:b("reservations.reports.results.headers.net","صافي الربح","Net profit")},o=[...e].sort((i,d)=>new Date(d.start||0)-new Date(i.start||0)).slice(0,20).map(i=>{const d=Nr(i,r),l={[s.code]:d.code.text,[s.customer]:d.customer.text,[s.date]:d.date.text,[s.status]:d.status.text,[s.payment]:d.payment.text,[s.total]:d.total.text,[s.share]:d.share.text,[s.net]:d.net.text};return{formatted:d,exportRow:l}});return a.innerHTML=o.map(({formatted:i})=>`
      <tr data-drilldown="reservation" data-search="${Jt(i.code.text)}">
        <td data-report-column="code">${i.code.html}</td>
        <td data-report-column="customer">${i.customer.html}</td>
        <td data-report-column="date">${i.date.html}</td>
        <td data-report-column="status">${i.status.html}</td>
        <td data-report-column="payment">${i.payment.html}</td>
        <td data-report-column="total">${i.total.html}</td>
        <td data-report-column="share">${i.share.html}</td>
        <td data-report-column="net">${i.net.html}</td>
      </tr>
    `).join(""),o.map(({exportRow:i})=>i)}function Sr(e){const t=Kn?.[e];t&&(h.range="custom",h.start=t.startInput||null,h.end=t.endInput||null,ct(),k())}function wr(e){e&&(h.status=h.status===e?"all":e,ct(),k())}function Tr(e){e&&(h.payment=h.payment===e?"all":e,ct(),k())}function Er(e){xe&&(clearTimeout(xe),xe=null),h.search=e||"";const t=document.getElementById("reports-search");t&&t.value!==h.search&&(t.value=h.search),k()}function xr(){if(An)return;const e=document.getElementById("reports-column-controls");e&&(e.querySelectorAll("input[data-column-toggle]").forEach(t=>{const n=t.dataset.columnToggle;n&&(t.checked=qt[n]!==!1,t.addEventListener("change",()=>{qt[n]=t.checked,Nt()}))}),An=!0,Nt())}function Nt(){Object.entries(qt).forEach(([e,t])=>{document.querySelectorAll(`[data-report-column="${e}"]`).forEach(n=>{t?n.classList.remove("hidden"):n.classList.add("hidden")})})}function Ar(){if(xn)return;const e=document.querySelectorAll("[data-export]");e.length&&(e.forEach(t=>{t.addEventListener("click",async()=>{const{export:n=""}=t.dataset;if(n){t.disabled=!0;try{await Lr(n)}catch(a){console.error("⚠️ [reports] export failed",a)}finally{t.disabled=!1}}})}),xn=!0)}async function Lr(e){const t=ie.tableRows||[];if(!t.length){console.warn("[reports] No reservation data to export");return}switch(e){case"pdf":await Ir();break;case"excel":await Cr(t);break;case"csv":default:Rt(t);break}}function Zt(e){const t=Dt(new Date).replace(/-/g,"");return`${b("reservations.reports.export.filePrefix","تقرير-الحجوزات","reservations-report")}-${t}.${e}`}function $r(e,t,n){const a=new Blob([e],{type:n}),r=URL.createObjectURL(a),s=document.createElement("a");s.href=r,s.download=t,document.body.appendChild(s),s.click(),document.body.removeChild(s),setTimeout(()=>URL.revokeObjectURL(r),4e3)}function Rt(e){if(!e||!e.length)return;const t=Object.keys(e[0]),n=[t.join(",")];e.forEach(r=>{const s=t.map(o=>`"${String(r[o]??"").replace(/"/g,'""')}"`);n.push(s.join(","))});const a=`\uFEFF${n.join(`\r
`)}\r
`;$r(a,Zt("csv"),"text/csv;charset=utf-8;")}async function Cr(e){try{const t=await er();if(!t){Rt(e);return}const n=t.utils.json_to_sheet(e),a=t.utils.book_new(),r=b("reservations.reports.export.sheetName","الحجوزات","Reservations");t.utils.book_append_sheet(a,n,r),t.writeFile(a,Zt("xlsx"))}catch(t){console.error("⚠️ [reports] Excel export failed, falling back to CSV",t),Rt(e)}}async function Ir(){const e=document.getElementById("reservations-report-printable");if(!e)return;const t=await Js();if(typeof t!="function"){console.warn("[reports] html2pdf unavailable, skipping PDF export");return}const n=Zt("pdf");await t().set({margin:10,filename:n,html2canvas:{scale:1.2,useCORS:!0,allowTaint:!1},jsPDF:{unit:"mm",format:"a4",orientation:"portrait"}}).from(e).save()}function kr(){if(Ln)return;const e=document.getElementById("reports-top-customers"),t=document.getElementById("reports-top-equipment"),n=document.getElementById("reports-reservations-body"),a=r=>{const s=r.target?.closest("[data-drilldown]");if(!s)return;const o=s.dataset.search||"";Er(o)};e?.addEventListener("click",a),t?.addEventListener("click",a),n?.addEventListener("click",a),Ln=!0}async function _r(e){const t=document.getElementById("reports-volume-chart");if(t){if(Kn=Array.isArray(e)?e:[],!e||e.length===0){x.trend&&(x.trend.destroy(),x.trend=null),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const n=await Qt();if(!n){t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const a=e.map(l=>l.label),r=e.map(l=>Math.round(l.count||0)),s=e.map(l=>Math.round(l.revenue||0)),o=e.map(l=>Math.round(l.netProfit||0)),i=[{name:b("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),type:"column",data:r},{name:b("reservations.reports.chart.volume.series.revenue","الإيرادات (ر.س)","Revenue (SAR)"),type:"line",data:s},{name:b("reservations.reports.chart.volume.series.net","صافي الربح (ر.س)","Net profit (SAR)"),type:"line",data:o,yAxisIndex:1}],d={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},background:"transparent",fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(l,u,m)=>{m?.dataPointIndex!=null&&Sr(m.dataPointIndex)}}},theme:{mode:nt()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,5,5]},colors:["#6366f1","#22c55e","#f97316"],dataLabels:{enabled:!1},fill:{type:"solid",opacity:1},xaxis:{categories:a,labels:{style:{colors:nt()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:b("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:l=>C(l)},title:{text:b("reservations.reports.chart.volume.series.reservations","عدد الحجوزات","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:b("reservations.reports.chart.volume.series.revenue","الإيرادات (ر.س)","Revenue (SAR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:l=>z(l)},title:{text:b("reservations.reports.chart.volume.series.revenue","الإيرادات (ر.س)","Revenue (SAR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,y:{formatter:(l,{seriesIndex:u})=>u===0?C(l):z(l)}}};x.trend?(x.trend.updateOptions({...d},!0,!0),x.trend.updateSeries(i,!0)):(t.innerHTML="",x.trend=new n(t,{...d,series:i}),x.trend.render())}catch(n){console.error("⚠️ [reports] Failed to render trend chart",n),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}}async function qr(e){const t=document.getElementById("reports-status-chart"),n="reports-status-breakdown";if(t){if($t=Array.isArray(e)?e:[],!e||e.length===0){x.status&&(x.status.destroy(),x.status=null),te(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const a=await Qt();if(!a){te(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const r=e.map(i=>Math.max(0,i.value||0)),s=e.map(i=>i.label),o={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(i,d,l)=>{if(l?.dataPointIndex!=null){const u=$t[l.dataPointIndex];u?.filterKey&&wr(u.filterKey)}}}},theme:{mode:nt()},labels:s,series:r,colors:["#22c55e","#f97316","#6366f1"],legend:{position:"bottom"},dataLabels:{formatter:i=>`${Math.round(i)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:b("reservations.reports.chart.status.title","🧾 توزيع الحالات","Status distribution"),formatter:()=>C(r.reduce((i,d)=>i+d,0))}}}}},tooltip:{y:{formatter:(i,d)=>{const l=$t?.[d?.seriesIndex||0],u=l?`${C(l.percent)}%`:`${C(i)}%`;return`${C(l?l.rawCount??l.value??0:i)} / ${u}`}}}};x.status?(x.status.updateOptions({...o},!0,!0),x.status.updateSeries(r,!0)):(t.innerHTML="",x.status=new a(t,{...o,series:r}),x.status.render()),te(n,e)}catch(a){console.error("⚠️ [reports] Failed to render status chart",a),te(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}}async function Dr(e){const t=document.getElementById("reports-payment-chart"),n="reports-payment-breakdown";if(t){if(Ct=Array.isArray(e)?e:[],!e||e.length===0){x.payment&&(x.payment.destroy(),x.payment=null),te(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}try{const a=await Qt();if(!a){te(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const r=e.map(i=>Math.max(0,i.value||0)),s=e.map(i=>i.label),o={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(i,d,l)=>{if(l?.dataPointIndex!=null){const u=Ct[l.dataPointIndex];u?.filterKey&&Tr(u.filterKey)}}}},theme:{mode:nt()},labels:s,series:r,colors:["#00ac69","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:i=>`${Math.round(i)}%`},tooltip:{y:{formatter:(i,d)=>{const l=Ct?.[d?.seriesIndex||0],u=l?`${C(l.percent)}%`:`${C(i)}%`;return`${C(l?l.rawCount??l.value??0:i)} / ${u}`}}}};x.payment?(x.payment.updateOptions({...o},!0,!0),x.payment.updateSeries(r,!0)):(t.innerHTML="",x.payment=new a(t,{...o,series:r}),x.payment.render()),te(n,e)}catch(a){console.error("⚠️ [reports] Failed to render payment chart",a),te(n,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`}}}function te(e,t){const n=document.getElementById(e);if(n){if(!t||t.length===0){n.innerHTML=`<div class="text-sm text-base-content/60">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</div>`;return}n.innerHTML=t.map(a=>{const r=Math.min(Math.max(a.percent??0,0),100),s=b("reservations.reports.progress.meta","{count} حجز","{count} reservations").replace("{count}",C(a.rawCount??a.value??0)),o=a.className?`reports-progress-fill ${a.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${O(a.label)}</span>
            <span class="reports-progress-value">${C(a.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${o}" style="width: ${r}%;"></div>
          </div>
          <div class="reports-progress-meta">${s}</div>
        </div>
      `}).join("")}}function Mr(e){const t=document.getElementById("reports-top-customers");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${b("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${Jt(n.name)}">
        <td>${O(n.name)}</td>
        <td>${C(n.count)}</td>
        <td>${z(n.revenue)}</td>
      </tr>
    `).join("")}}function Br(e){const t=document.getElementById("reports-top-equipment");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${b("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(n=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${Jt(n.name)}">
        <td>${O(n.name)}</td>
        <td>${C(n.count)}</td>
        <td>${z(n.revenue)}</td>
      </tr>
    `).join("")}}function Nr(e,t,n){const a=e?.reservationId||e?.id||"—",r=f(String(a)),o=t.get(String(e?.customerId))?.customerName||b("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),i=ke(e),d=Rr(i.statusValue),l=Fr(i.statusValue,d),u=Pr(i.paid),m=jr(e?.start),p=je(e),g=z(p.finalTotal),y=p.companySharePercent>0?`${C(p.companySharePercent)}% (${z(p.companyShareAmount)})`:b("reservations.reports.results.share.none","بدون نسبة الشركة","No company share"),S=z(p.netProfit),w=O(o),q=o;return{code:{html:O(r),text:r},customer:{html:w,text:q},date:{html:O(m),text:m},status:l,payment:u,total:{html:O(g),text:g},share:{html:O(y),text:y},net:{html:O(S),text:S}}}function aa(e){return e?b("reservations.reports.payment.paidLabel","مدفوعة","Paid"):b("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}function Rr(e){switch(e){case"completed":return Je(b("reservations.list.status.completed","📁 منتهي","Completed"));case"confirmed":return Je(b("reservations.list.status.confirmed","✅ مؤكد","Confirmed"));case"pending":return Je(b("reservations.list.status.pending","⏳ غير مؤكد","Pending"));default:return f(e||"—")}}function Fr(e,t){const n=Je(t);return{html:`<span class="reservation-chip status-${["completed","confirmed","pending"].includes(e)?e:"info"}">${O(n)}</span>`,text:n}}function Pr(e){const t=aa(e);return{html:`<span class="reservation-chip status-${e?"paid":"unpaid"}">${O(t)}</span>`,text:t}}function Je(e){return f(String(e??"")).replace(/^[^A-Za-z0-9\u0600-\u06FF]+/,"").trim()||"—"}function jr(e){if(!e)return"—";const t=new Date(e);if(Number.isNaN(t.getTime()))return"—";const n=Kt(),a=new Intl.DateTimeFormat(n,{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return f(a.format(t))}function Hr(e){const t=document.getElementById("reports-kpi-total"),n=document.getElementById("reports-kpi-total-meta"),a=document.getElementById("reports-kpi-revenue"),r=document.getElementById("reports-kpi-revenue-meta"),s=document.getElementById("reports-kpi-confirmed"),o=document.getElementById("reports-kpi-confirmed-meta"),i=document.getElementById("reports-kpi-paid"),d=document.getElementById("reports-kpi-paid-meta"),l=e.total||0,u=e.revenue||0,m=e.confirmed||0,p=e.paidCount||0,g=e.average||0,y=e.companyShareTotal||0,S=e.netProfit||0,w=l?Math.round(m/l*100):0,q=l?Math.round(p/l*100):0;if(t&&(t.textContent=C(l)),n){const E=b("reservations.reports.kpi.total.dynamicMeta","منها {count} منتهية","Includes {count} completed").replace("{count}",C(e.completed||0));n.textContent=E}if(a&&(a.textContent=z(u)),r){const E=b("reservations.reports.kpi.revenue.meta","صافي الربح {net} • نسبة الشركة {share} • متوسط الحجز {average}","Net profit {net} • Company share {share} • Average reservation {average}");r.textContent=E.replace("{net}",z(S)).replace("{share}",z(y)).replace("{average}",z(g))}if(s&&(s.textContent=`${w}%`),o){const E=b("reservations.reports.kpi.confirmed.detail","{count} حجوزات مؤكدة","{count} confirmed reservations").replace("{count}",C(m));o.textContent=E}if(i&&(i.textContent=`${q}%`),d){const E=b("reservations.reports.kpi.paid.detail","{count} حجوزات مدفوعة","{count} paid reservations").replace("{count}",C(p));d.textContent=E}}function Or(e){Mt({active:!!e})}function O(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Jt(e=""){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function C(e){const{numberFormatter:t}=Xn(),n=t.format(Math.round(e||0));return f(n)}function z(e){const{currencyFormatter:t}=Xn(),n=t.format(Math.max(0,Math.round(e||0)));return f(n)}function st(e){return(e||"").toString().trim()}const zr=Z()||{};let ge=(zr.maintenance||[]).map(sa);function lt(){return ge}function dt(e){return ge=Array.isArray(e)?e.map(sa):[],hs({maintenance:ge}),Jr(),ge}async function Vr(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([s,o])=>{o!=null&&o!==""&&t.set(s,String(o))});const n=t.toString(),a=await K(`/maintenance/${n?`?${n}`:""}`),r=Array.isArray(a?.data)?a.data.map(en):[];return dt(r)}async function Ur(e){const t=await K("/maintenance/",{method:"POST",body:e}),n=en(t?.data??{});return dt([n,...ge.filter(a=>a.id!==n.id)]),n}async function Yr(e,t){const n=await K(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=en(n?.data??{});return dt(ge.map(r=>String(r.id)===String(e)?a:r)),a}async function Wr(e){await K(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),dt(ge.filter(t=>String(t.id)!==String(e)))}function Gr({equipmentId:e,technicianId:t,issue:n,priority:a,status:r,scheduledAt:s,resolutionReport:o}){return{equipment_id:e,technician_id:null,maintenance_type:null,priority:a,reported_at:null,scheduled_at:null,status:r,notes:n??"",resolution_report:null}}function en(e={}){return ra({id:e.id,equipment_id:e.equipment_id,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode,equipmentDesc:e.equipmentDesc??e.equipment_desc??e.equipment_description,issue:e.issue??e.notes,priority:e.priority,status:e.status,status_raw:e.status_raw,createdAt:e.createdAt??e.reportedAt??e.reported_at,reportedAt:e.reportedAt??e.reported_at,scheduledAt:e.scheduledAt??e.scheduled_at,resolvedAt:e.resolvedAt??e.resolved_at,resolutionReport:e.resolutionReport??e.resolution_report,technicianId:e.technicianId??e.technician_id})}function sa(e={}){return ra(e)}function ra(e={}){const t=e.id??e.ticketId??Date.now(),n=e.equipmentDesc??e.equipment_desc??e.equipmentDescription??e.equipment_name??"",a=Kr(e.status_raw??e.status??"open"),r=Xr(a),s=Zr(e,a);return{id:Number(t),equipmentId:e.equipment_id??e.equipmentId??null,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode??"",equipmentDesc:n,issue:e.issue??e.notes??"",priority:Qr(e.priority??"medium"),status:r,statusRaw:a,statusLabel:s,createdAt:e.createdAt??e.reportedAt??e.reported_at??null,reportedAt:e.reportedAt??e.reported_at??null,scheduledAt:e.scheduledAt??e.scheduled_at??null,resolvedAt:e.resolvedAt??e.resolved_at??null,resolutionReport:e.resolutionReport??e.resolution_report??"",technicianId:e.technicianId??e.technician_id??null}}function Kr(e){const t=String(e??"").trim();return t&&t.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-]/g,"")||"open"}function Xr(e){const t=oa(e);return["completed","cancelled"].includes(t)?"closed":"open"}function Qr(e){const t=String(e??"medium").trim().toLowerCase();return["low","medium","high"].includes(t)?t:"medium"}function Zr(e={},t="open"){const n=e.status_label??e.statusLabel??e.status_display??e.status_text??e.status??e.status_raw??t,a=String(n??"").trim();return a||t.replace(/[_-]+/g," ").replace(/\b\w/g,r=>r.toUpperCase())}function oa(e){const t=String(e??"").toLowerCase();switch(t){case"open":case"قيد الصيانة":case"قيد الانتظار":return"open";case"in_progress":case"in-progress":case"جاري العمل":return"in_progress";case"completed":case"مكتمل":case"تم الإصلاح":case"closed":case"مغلق":return"completed";case"cancelled":case"ملغي":return"cancelled";default:return t.includes("progress")||t.includes("تنفيذ")?"in_progress":t.includes("complete")||t.includes("close")||t.includes("منجز")||t.includes("مغلق")?"completed":t.includes("cancel")||t.includes("ملغي")?"cancelled":t||"open"}}function Jr(){typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("maintenance:updated")):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("maintenance:updated"))}function Re(e){return e instanceof Rn}function Ft(e){if(!e)return null;const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getFullYear()).slice(-2);return`${n}/${a}/${r}`}let ye=lt(),he=[],Be=null,Le=!1,Ne="",$e=ye.length>0,fe={id:null,equipmentDesc:"",equipmentBarcode:""},tn=null,B=null,G=null,Ce=null,ia=null,Ie=null;async function Fe({showToastOnError:e=!0}={}){if(!Le){Le=!0,Ne="",Y();try{await Vr(),$e=!0}catch(t){$e=ye.length>0,console.error("❌ [maintenance] Failed to load maintenance tickets",t),Ne=Re(t)?t.message:c("maintenance.toast.fetchFailed","تعذر تحميل بيانات الصيانة. حاول تحديث الصفحة."),e&&A(Ne,"error")}finally{Le=!1,ye=lt(),Y()}}}function Pt(){return c("maintenance.form.selectedInfo","لم يتم اختيار معدة بعد.")}function Q(e){return f(String(e||"")).trim().toLowerCase()}function ca(e=""){return f(String(e)).trim().toLowerCase()}function eo(e={}){const t=String(e?.desc??"").trim(),n=f(String(e?.displayBarcode??e?.barcode??"")).trim();return n?`${t} | ${n}`:t}function to(e){const t=f(String(e||""));if(!t.trim())return{description:"",barcode:""};const[n,...a]=t.split("|");return{description:n.trim(),barcode:a.join("|").trim()}}function la(e){return f(String(e||"")).trim().toLowerCase()}function I(e=""){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function no(e=new Date){const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=a=>String(a).padStart(2,"0");return`${t.getFullYear()}-${n(t.getMonth()+1)}-${n(t.getDate())} ${n(t.getHours())}:${n(t.getMinutes())}:${n(t.getSeconds())}`}function ae(){return ye=lt(),ye}function da(e){return ae().find(n=>Number(n.id)===Number(e))||null}function ua(e){const t=String(e??"").trim().toLowerCase();return t?["maintenance","صيانة"].includes(t)?"maintenance":["reserved","محجوز"].includes(t)?"reserved":["retired","متوقف","خارج الخدمة"].includes(t)?"retired":"available":"available"}function nn(){const{equipment:e=[]}=Z(),t=c("maintenance.table.noName","بدون اسم");return he=(e||[]).map(n=>{const a=String(n?.barcode??"").trim(),r=Q(a),s=Number.parseInt(n?.qty??n?.quantity??0,10),o=Number.isFinite(s)?Math.max(s,0):1,i=n?.image||n?.imageUrl||n?.image_url||"",d=n?.status||"متاح",l=n?.desc||n?.description||n?.name||t,u=eo({desc:l,displayBarcode:a,barcode:r});return{id:n?.id??n?.equipment_id??n?.equipmentId??null,barcode:r,displayBarcode:a,desc:l,status:d,statusNormalized:ua(d),price:Number(n?.price||n?.unit_price)||0,category:n?.category||"",quantity:o,image:i,searchValue:u,searchValueNormalized:la(u),descriptionNormalized:ca(l)}}),he.sort((n,a)=>n.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),he}function an(){const e=new Set,t=new Map;return ae().filter(n=>n.status==="open").forEach(n=>{const a=Q(n.equipmentBarcode);a&&(e.add(a),t.set(a,(t.get(a)||0)+1))}),{set:e,map:t}}function ma(e){const t=Q(e);if(!t)return 0;const{map:n}=an();return n.get(t)||0}function ut(e){const t=Q(e);return t&&(he.length?he:nn()).find(a=>a.barcode===t)||null}function ao(e){const t=he.length?he:nn();if(!t.length)return null;const n=la(e);if(n){const i=t.find(d=>d.searchValueNormalized===n);if(i)return i}const{description:a,barcode:r}=to(e);if(r){const i=Q(r);if(i){const d=t.find(l=>l.barcode===i);if(d)return d}}const s=ca(a||e);if(!s)return null;const o=t.find(i=>i.descriptionNormalized===s);return o||t.find(i=>i.descriptionNormalized.includes(s))||null}function jt(e,t=null){if(!e)return!0;const n=e.barcode,a=Number.isFinite(e.quantity)?e.quantity:0,s=(t||an().map).get(n)||0;return a<=0?!0:a===1?e.statusNormalized==="maintenance"||s>=1:s>=a}function de({keepInputs:e=!1,silent:t=!1}={}){const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),r=document.getElementById("maintenance-equipment-search"),s=document.getElementById("maintenance-selected-info");n&&(n.value=""),e||(a&&(a.value=""),r&&(r.value="")),s&&(s.textContent=Pt(),s.classList.remove("maintenance-selected-info--has-selection")),Be=null}function pa(e){const t=document.getElementById("maintenance-selected-info");if(!t)return;const n=c("maintenance.info.barcodeLabel","باركود"),a=c("maintenance.report.notAvailable","غير متوفر"),r=c("maintenance.info.unitsAvailable","الوحدات المتاحة الآن"),s=c("maintenance.info.categoryLabel","القسم"),o=e.displayBarcode||e.barcode||a,i=e.barcode,d=Number.isFinite(e.quantity)?e.quantity:0,l=ma(i),u=Math.max(d-l,0),m=e.category?`
    <div class="maintenance-selected-info__meta">${s}: <strong>${I(e.category)}</strong></div>
  `:"",p=d>0?`
    <div class="maintenance-selected-info__meta">
      ${r}: <strong>${u}</strong> / ${d}
    </div>
  `:"",g=e.image?`<img class="maintenance-selected-info__image" src="${I(e.image)}" alt="${I(e.desc)}">`:'<div class="maintenance-selected-info__placeholder" aria-hidden="true">🎥</div>';t.innerHTML=`
    <div class="maintenance-selected-info__media">${g}</div>
    <div class="maintenance-selected-info__body">
      <div class="maintenance-selected-info__name">${I(e.desc)}</div>
      <div class="maintenance-selected-info__meta">${n}: <strong>${I(o)}</strong></div>
      ${p}
      ${m}
    </div>
  `,t.classList.add("maintenance-selected-info--has-selection")}function sn(e,{silent:t=!1}={}){if(!e)return!1;if(jt(e))return t||A(c("maintenance.toast.equipmentBlocked","⚠️ هذه المعدة قيد الصيانة ولا يمكن اختيارها حالياً")),!1;const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),r=document.getElementById("maintenance-equipment-search");return n&&(n.value=e.barcode),a&&(a.value=e.displayBarcode||e.barcode),r&&(r.value=e.searchValue||e.desc),pa(e),Be=e,!0}function fa(e,{showFeedback:t=!0}={}){const n=ut(e);return n?sn(n,{silent:!t}):(t&&A(c("maintenance.toast.equipmentNotFoundBarcode","❌ لم يتم العثور على معدة بهذا الباركود")),!1)}function ba(e,{showFeedback:t=!0}={}){const n=ao(e);return n?sn(n,{silent:!t}):(t&&A(c("maintenance.toast.equipmentNotFoundName","❌ لم يتم العثور على معدة بالاسم المدخل")),!1)}function rn(){const e=document.getElementById("maintenance-equipment-options"),t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=nn(),{map:r}=an();e&&(e.innerHTML=a.map(o=>`<option value="${I(o.searchValue||o.desc)}"></option>`).join(""));const s=document.getElementById("maintenance-selected-barcode");if(s&&s.value){const o=ut(s.value);!o||jt(o,r)?(de({keepInputs:!0,silent:!0}),o&&jt(o,r)&&A(c("maintenance.toast.equipmentBecameBlocked","⚠️ هذه المعدة أصبحت قيد الصيانة ولا يمكن اختيارها"))):sn(o,{silent:!0})}else de({keepInputs:!0,silent:!0});if(t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",o=>{o.key==="Enter"&&(o.preventDefault(),fa(t.value)||de({keepInputs:!0,silent:!0}))}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached){const o=()=>{if(!n.value){de({keepInputs:!0,silent:!0});return}ba(n.value)||de({keepInputs:!0,silent:!0})};n.addEventListener("change",o),n.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),o())}),n.dataset.listenerAttached="true"}}async function rt(){try{await Rs({showToastOnError:!1})}catch(e){console.error("❌ [maintenance] refreshEquipmentData failed",e)}finally{Gt(),rn()}}function ga(){const e=document.getElementById("closeMaintenanceModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;if(!t?.Modal)return!1;tn=t.Modal.getOrCreateInstance(e),B||(B=e.querySelector("#maintenance-close-report")),G||(G=e.querySelector("#maintenance-close-submit")),Ce||(Ce=e.querySelector("#maintenance-close-modal-details"));const n=e.querySelector("#maintenance-close-form");return n&&!n.dataset.listenerAttached&&(n.addEventListener("submit",ro),n.dataset.listenerAttached="true"),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",ha),e.dataset.listenerAttached="true"),!0}function ha(){fe={id:null,equipmentDesc:"",equipmentBarcode:""},B&&(B.value=""),Ce&&(Ce.innerHTML=""),Pe(!1)}function ya(){const e=document.getElementById("maintenanceReportModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;return t?.Modal?(ia=t.Modal.getOrCreateInstance(e),Ie||(Ie=e.querySelector("#maintenance-report-modal-content")),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",va),e.dataset.listenerAttached="true"),!0):!1}function va(){Ie&&(Ie.innerHTML="")}function Pe(e){if(!G)return;const t=c("maintenance.closeModal.saving","⏳ جاري الإغلاق..."),n=c("maintenance.closeModal.confirm","إغلاق التذكرة");e?(G.disabled=!0,G.dataset.loading="true",G.textContent=t):(G.disabled=!1,G.removeAttribute("data-loading"),G.textContent=n)}function so(e){const t=da(e);if(!t){A(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!ga()){const n=prompt(c("maintenance.prompt.closeReport","أدخل تقرير الإصلاح / الإجراءات المتخذة:"));if(n===null)return;const a=n.trim();if(!a){A(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error");return}Sa(e,a);return}if(fe={id:t.id,equipmentDesc:t.equipmentDesc||"",equipmentBarcode:t.equipmentBarcode||""},B&&(B.value=t.resolutionReport||""),Ce){const n=c("maintenance.report.barcode","الباركود"),a=c("maintenance.report.notAvailable","غير متوفر"),r=fe.equipmentDesc||a,s=fe.equipmentBarcode?f(fe.equipmentBarcode):a;Ce.innerHTML=`
      <div class="maintenance-close-modal__ticket-card" role="group" aria-labelledby="maintenance-close-ticket-title">
        <div class="maintenance-close-modal__ticket-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 2h6"></path>
            <path d="M10 4h4"></path>
            <path d="M8 4h-2a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2"></path>
            <path d="M9 12l2 2 4-4"></path>
          </svg>
        </div>
        <div class="maintenance-close-modal__ticket-info">
          <div id="maintenance-close-ticket-title" class="maintenance-close-modal__ticket-title">${r}</div>
          <div class="maintenance-close-modal__ticket-meta">${n}: <span>${s}</span></div>
        </div>
      </div>
    `}Pe(!1),tn?.show(),setTimeout(()=>{B?.focus(),B?.setSelectionRange(B.value.length,B.value.length)},150)}async function ro(e){if(e?.preventDefault(),!fe.id){A(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!B)return;const t=B.value.trim();if(!t){A(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),B.focus();return}Pe(!0),(await Sa(fe.id,t)).success?tn?.hide():Pe(!1)}function oo(e){const t=document.getElementById("maintenance-stats");if(!t)return;const n=e.length,a=e.filter(m=>m.status==="open").length,r=n-a,s=m=>f(String(m)),o=c("maintenance.stats.summaryTitle","ملخص الصيانة"),i=c("maintenance.filters.status.open","قيد الصيانة"),d=c("maintenance.filters.status.closed","مغلقة"),l=c("maintenance.stats.totalLabel","إجمالي التذاكر"),u=(m,p,g)=>`
    <div class="maintenance-summary__item maintenance-summary__item--${g}">
      <span class="maintenance-summary__value">${s(m)}</span>
      <span class="maintenance-summary__label">${p}</span>
    </div>
  `;t.innerHTML=`
    <section class="maintenance-summary" aria-labelledby="maintenance-summary-title">
      <header class="maintenance-summary__header">
        <span class="maintenance-summary__icon" aria-hidden="true">🛠️</span>
        <h4 id="maintenance-summary-title" class="maintenance-summary__title">${o}</h4>
      </header>
      <div class="maintenance-summary__items">
        ${u(a,i,"open")}
        ${u(r,d,"closed")}
        ${u(n,l,"total")}
      </div>
    </section>
  `}function io(e){const n=String(e?.statusRaw??e?.status??"open").toLowerCase().replace(/[^a-z0-9_\-\s]/g,"").replace(/[\s]+/g,"_")||"open",a=oa(n)||"open",r={open:{key:"maintenance.status.open",fallback:"قيد الصيانة",className:"maintenance-status-tag--open"},in_progress:{key:"maintenance.status.inProgress",fallback:"قيد التنفيذ",className:"maintenance-status-tag--in-progress"},completed:{key:"maintenance.status.completed",fallback:"مكتملة",className:"maintenance-status-tag--completed"},cancelled:{key:"maintenance.status.cancelled",fallback:"ملغاة",className:"maintenance-status-tag--cancelled"}},s=r[a]??r.open,o=s?c(s.key,s.fallback):c("maintenance.status.open","قيد الصيانة"),i=e?.statusLabel&&String(e.statusLabel).trim()?String(e.statusLabel).trim():o,d=["maintenance-status-badge","maintenance-status-tag"];return s?.className&&d.push(s.className),d.push(`maintenance-status-tag--${a}`),d.push(`maintenance-status-tag--${n}`),`<span class="${d.filter(Boolean).join(" ")}">${i}</span>`}function co(e){const t=document.getElementById("maintenance-table-body"),n=document.getElementById("maintenance-empty-state");if(t){if(!e||e.length===0){const a=c("maintenance.empty.title","لا توجد تذاكر صيانة"),r=c("maintenance.empty.subtitle","عند إنشاء تذكرة جديدة ستظهر في هذه القائمة.");t.innerHTML=`
      <tr>
        <td colspan="6" class="maintenance-empty-row">
          <div class="maintenance-empty-icon">✅</div>
          <h5>${a}</h5>
          <p>${r}</p>
        </td>
      </tr>
    `,n&&n.classList.add("active");return}n&&n.classList.remove("active"),t.innerHTML=e.map(a=>{const r=io(a),s=a.status==="open"?"maintenance-row maintenance-row--open":"maintenance-row maintenance-row--closed",o=(()=>{const q=c("maintenance.priority.high","مرتفعة"),E=c("maintenance.priority.medium","متوسطة"),V=c("maintenance.priority.low","منخفضة");switch(a.priority){case"high":return`<span class="maintenance-priority-badge maintenance-priority-badge--high">${q}</span>`;case"low":return`<span class="maintenance-priority-badge maintenance-priority-badge--low">${V}</span>`;default:return`<span class="maintenance-priority-badge maintenance-priority-badge--medium">${E}</span>`}})(),i=[],d=c("maintenance.actions.close","🔧 إغلاق بعد الإصلاح"),l=c("maintenance.actions.view","👁️ عرض التقرير"),u=c("maintenance.actions.delete","🗑️ حذف التذكرة");a.status==="open"?i.push(`<button type="button" class="maintenance-action-btn" data-action="close" data-id="${a.id}">${d}</button>`):i.push(`<button type="button" class="maintenance-action-btn" data-action="view" data-id="${a.id}">${l}</button>`),Yt()&&i.push(`<button type="button" class="maintenance-action-btn maintenance-action-btn--delete" data-action="delete" data-id="${a.id}">${u}</button>`);const m=i.join(""),p=c("maintenance.table.noBarcode","بدون باركود"),g=c("maintenance.report.none","—"),y=a.equipmentBarcode?f(a.equipmentBarcode):p,S=a.issue?f(a.issue):g,w=a.createdAt?f(Ft(a.createdAt)||pe(a.createdAt)):"—";return`
        <tr class="${s}">
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${y}</small>
          </td>
          <td class="maintenance-issue-text">${S}</td>
          <td>${o}</td>
          <td>${w}</td>
          <td>${r}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${m}
            </div>
          </td>
        </tr>
      `}).join("")}}function lo(e){if(!$e||Le){A(c("maintenance.toast.loading","⏳ يتم تحديث بيانات الصيانة، يرجى الانتظار لحظة..."));return}const t=e.target.closest("button[data-action]");if(!t)return;const n=t.getAttribute("data-action"),a=Number(t.getAttribute("data-id"));if(a){if(n==="close")so(a);else if(n==="view")uo(a);else if(n==="delete"){if(!Yt()){Fn();return}mo(a).catch(r=>{console.error("❌ [maintenance] deleteTicket failed",r)})}}}async function Sa(e,t){const n=da(e);if(!n)return A(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة")),{success:!1};const a=(t??"").trim();if(!a)return A(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),{success:!1};const r=no(new Date)||new Date().toISOString();try{await Yr(e,{equipment_id:n.equipmentId,technician_id:n.technicianId??null,priority:n.priority??"medium",status:"completed",notes:n.issue??"",reported_at:n.reportedAt??null,scheduled_at:n.scheduledAt??null,resolution_report:a,resolved_at:r}),await Fe({showToastOnError:!1});const s=document.getElementById("maintenance-status-filter");return s&&s.value==="open"&&(s.value="all"),await rt(),Y(),A(c("maintenance.toast.ticketClosed","✅ تم إغلاق تذكرة الصيانة وإعادة المعدة إلى الحالة المتاحة")),{success:!0}}catch(s){if(console.error("❌ [maintenance] closeTicket failed",s),Re(s)&&s.status===404)return await Fe({showToastOnError:!1}),await rt(),Y(),A(c("maintenance.toast.ticketAlreadyClosed","✅ تم تحديث التذاكر، ويبدو أن هذه التذكرة مغلقة مسبقاً"),"info"),{success:!0};const o=Re(s)?s.message:c("maintenance.toast.updateError","⚠️ تعذر إغلاق تذكرة الصيانة. حاول مرة أخرى");return A(o,"error"),{success:!1,error:s}}}function uo(e){const n=ae().find(w=>Number(w.id)===Number(e));if(!n)return;if(!ya()){const w=c("maintenance.report.equipment","المعدة"),q=c("maintenance.report.barcode","الباركود"),E=c("maintenance.report.issue","الوصف"),V=c("maintenance.report.createdAt","تاريخ الإنشاء"),J=c("maintenance.report.closedAt","تاريخ الإغلاق"),se=c("maintenance.report.summary","التقرير"),_e=c("maintenance.report.notAvailable","غير متوفر"),ee=c("maintenance.report.none","—"),N=[`${w}: ${n.equipmentDesc}`,`${q}: ${n.equipmentBarcode?f(n.equipmentBarcode):_e}`,`${E}: ${n.issue?f(n.issue):ee}`,`${V}: ${n.createdAt?f(Ft(n.createdAt)||pe(n.createdAt)):ee}`,`${J}: ${n.resolvedAt?f(pe(n.resolvedAt)):ee}`,`${se}: ${n.resolutionReport?f(n.resolutionReport):ee}`].join(`
`);alert(N);return}const a=c("maintenance.report.equipment","المعدة"),r=c("maintenance.report.barcode","الباركود"),s=c("maintenance.report.issue","الوصف"),o=c("maintenance.report.createdAt","تاريخ الإنشاء"),i=c("maintenance.report.closedAt","تاريخ الإغلاق"),d=c("maintenance.report.summary","التقرير"),l=c("maintenance.report.notAvailable","غير متوفر"),u=c("maintenance.report.none","—"),m=[{label:a,value:`<span class="maintenance-report-modal__value">${I(n.equipmentDesc||u)}</span>`},{label:r,value:n.equipmentBarcode?`<span class="maintenance-report-modal__value">${I(f(n.equipmentBarcode))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${I(l)}</span>`},{label:s,value:n.issue?`<span class="maintenance-report-modal__value">${I(f(n.issue))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${I(u)}</span>`},{label:o,value:n.createdAt?`<span class="maintenance-report-modal__value">${I(f(Ft(n.createdAt)||pe(n.createdAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${I(u)}</span>`},{label:i,value:n.resolvedAt?`<span class="maintenance-report-modal__value">${I(f(pe(n.resolvedAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${I(u)}</span>`}],p=n.resolutionReport?f(n.resolutionReport):"",g=p?`<p>${I(p).replace(/\r?\n/g,"<br>")}</p>`:`<p class="maintenance-report-modal__value maintenance-report-modal__value--muted">${I(u)}</p>`,y=m.map(w=>`
      <div class="maintenance-report-modal__item">
        <span class="maintenance-report-modal__label">${I(w.label)}</span>
        ${w.value}
      </div>
    `).join(""),S=`
    <div class="maintenance-report-modal__summary">
      <h6>${I(d)}</h6>
      ${g}
    </div>
  `;Ie&&(Ie.innerHTML=`
      <div class="maintenance-report-modal__details">
        <div class="maintenance-report-modal__grid">
          ${y}
        </div>
        ${S}
      </div>
    `),ia?.show()}async function mo(e){if(!Yt()){Fn();return}if(!ae().find(a=>Number(a.id)===Number(e))){A(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(confirm(c("maintenance.toast.ticketDeleteConfirm","⚠️ هل أنت متأكد من حذف تذكرة الصيانة؟")))try{await Wr(e),await Fe({showToastOnError:!1}),await rt(),A(c("maintenance.toast.ticketDeleted","🗑️ تم حذف تذكرة الصيانة"))}catch(a){console.error("❌ [maintenance] deleteTicket failed",a);const r=Re(a)?a.message:c("maintenance.toast.deleteError","⚠️ تعذر حذف تذكرة الصيانة. حاول مرة أخرى");A(r,"error")}}async function po(e){e.preventDefault();try{const t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),r=document.getElementById("maintenance-issue"),s=document.getElementById("maintenance-priority");let o=Be,i=Q(a?.value);if(!o&&i&&(o=ut(i)),!o&&t?.value&&fa(t.value,{showFeedback:!0})&&(o=Be,i=Q(o?.barcode)),!o&&n?.value&&ba(n.value,{showFeedback:!0})&&(o=Be,i=Q(o?.barcode)),!o||!i){A(c("maintenance.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const{equipment:d=[]}=Z();let l=(d||[]).find(w=>Q(w?.barcode)===i);if(!l&&o&&(l={id:o.id,barcode:o.barcode,desc:o.desc,name:o.desc,status:o.status||"متاح",quantity:o.quantity,qty:o.quantity}),!l||l.id==null){A(c("maintenance.toast.selectedNotFound","❌ لم يتم العثور على المعدة المختارة")),de();return}const u=Number.parseInt(l.qty??l.quantity??o?.quantity??1,10),m=Number.isFinite(u)&&u>0?u:1,p=ma(i);if(ua(l.status||o?.status)==="maintenance"&&m<=1){A(c("maintenance.toast.equipmentAlreadyMaintenance","⚠️ هذه المعدة بالفعل في حالة صيانة"));return}if(p>=m){A(c("maintenance.toast.noUnitsAvailable","⚠️ لا توجد وحدات متاحة للصيانة لهذه المعدة حالياً"));return}const y=Gr({equipmentId:l.id,technicianId:null,issue:r?.value.trim()||"",priority:s?.value||"medium",status:"open",scheduledAt:null,resolutionReport:null});await Ur(y),await Fe({showToastOnError:!1}),await rt(),A(c("maintenance.toast.ticketCreated","🛠️ تم إنشاء تذكرة الصيانة وإيقاف المعدة")),de(),r&&(r.value=""),s&&(s.value="medium");const S=document.getElementById("maintenance-status-filter");S&&(S.value="all")}catch(t){console.error("❌ [maintenance] Failed to create ticket",t);const n=Re(t)?t.message:c("maintenance.toast.submitError","⚠️ تعذر إنشاء تذكرة الصيانة. يرجى المحاولة مجدداً.");A(n,"error")}}function fo(e){const t=ae();return e==="all"?t:t.filter(n=>n.status===e)}function Y(){const e=ae();rn(),oo(e);const t=document.getElementById("maintenance-status-filter");t&&!t.value&&(t.value="all");const n=t?.value||"all",a=document.getElementById("maintenance-table-body"),r=document.getElementById("maintenance-empty-state");if(!a)return;if(Le&&!$e){const o=c("maintenance.table.loading","جاري التحميل...");a.innerHTML=`<tr><td colspan="6" class="text-center text-muted">${o}</td></tr>`,r&&r.classList.remove("active");return}if(Ne&&!$e){a.innerHTML=`<tr><td colspan="6" class="text-center text-danger">${Ne}</td></tr>`,r&&r.classList.remove("active");return}const s=fo(n);co(s)}function bo(){ae(),rn(),$e=ye.length>0,Le=!1,Y(),Fe({showToastOnError:!1}),ga()&&ha(),ya()&&va();const e=document.getElementById("maintenance-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",a=>{po(a).catch(r=>{console.error("❌ [maintenance] submit handler failed",r)})}),e.dataset.listenerAttached="true");const t=document.getElementById("maintenance-status-filter");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{Y()}),t.dataset.listenerAttached="true");const n=document.querySelector(".maintenance-table");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",lo),n.dataset.listenerAttached="true")}ae();document.addEventListener("language:changed",()=>{const e=document.getElementById("maintenance-selected-barcode"),t=document.getElementById("maintenance-selected-info");if(e?.value){const n=ut(e.value);n?pa(n):t&&(t.textContent=Pt())}else t&&(t.textContent=Pt());Y(),Pe(!1)});document.addEventListener(ys.USER_UPDATED,()=>{Y()});window.addEventListener("maintenance:updated",()=>{ye=lt(),Y()});const Ht="__ART_RATIO_LAST_DASHBOARD_TAB__",X="__ART_RATIO_LAST_DASHBOARD_SUB_TAB__",ot="create-tab",wa=/^[a-z0-9\-]+$/i;function Ot(e){if(!(!e||typeof e.scrollIntoView!="function"))try{const t=e.closest("[data-tab-scroll-track]");if(!t)return;const n={behavior:"smooth",block:"nearest",inline:"center"};e.scrollIntoView(n);const a=t.closest("[data-tab-scroll]");a&&window.requestAnimationFrame(()=>{a.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0}))})}catch(t){console.warn("⚠️ [tabs.js] Failed to keep tab visible",t)}}function ue(e){try{if(typeof window>"u"||!window.localStorage)return null;const t=window.localStorage.getItem(e);return!t||!wa.test(t)?null:t}catch(t){return console.warn("⚠️ [tabs.js] Failed to read stored tab",t),null}}function zt(e,t){try{if(typeof window>"u"||!window.localStorage)return;if(!t||!wa.test(t)){window.localStorage.removeItem(e);return}window.localStorage.setItem(e,t)}catch(n){console.warn("⚠️ [tabs.js] Failed to persist tab",n)}}function Ta(e){try{if(typeof window>"u"||!window.localStorage)return;window.localStorage.removeItem(e)}catch(t){console.warn("⚠️ [tabs.js] Failed to clear stored tab",t)}}let ce=null,P=null,me=!1,D=null,Dn=null,be=null,Vt=null,we=null;function go(){console.log("🚀 [tabs.js] setupTabs()");const e=Array.from(document.querySelectorAll("[data-tab]")),t=document.querySelectorAll(".tab-content-wrapper > .tab");console.log("📌 tabButtons:",e),console.log("📌 tabContents:",t);const n=(s,{skipStore:o=!1,skipRender:i=!1}={})=>{if(!s)return;const d=e.filter(u=>u?.getAttribute("data-tab")===s),l=document.getElementById(s);if(!(!d.length||!l)&&(e.forEach(u=>{const m=u?.getAttribute("data-tab")===s;u.classList.toggle("active",m),m?(u.setAttribute("aria-selected","true"),u.setAttribute("tabindex","0"),Ot(u)):(u.setAttribute("aria-selected","false"),u.setAttribute("tabindex","-1"))}),t.forEach(u=>{const m=u.id===s;u.style.display=m?"block":"none",u.classList.toggle("active",m)}),ce=s,zt(Ht,s),o||De({dashboardTab:s}).catch(u=>{console.warn("⚠️ [tabs.js] Failed to store dashboard tab preference",u)}),s!=="reservations-tab"&&(P=null,D=null,Ta(X),o||De({dashboardSubTab:null}).catch(u=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",u)})),!i&&s==="customers-tab"&&(console.log("👤 Rendering customers"),$s()),!i&&s==="equipment-tab"&&(console.log("📦 Rendering equipment"),Gt()),!i&&s==="maintenance-tab"&&(console.log("🛠️ Rendering maintenance"),Y()),!i&&s==="technicians-tab"&&(console.log("🛠️ Rendering technicians"),Fs()),s==="reservations-tab")){if(console.log("📅 Rendering reservations"),i||Pn(),!D){const u=ue(X);D=P||u||ot}ho(),D&&(Ue(D),D=null)}};Vt=n,e.forEach(s=>{s&&(s.getAttribute("type")||s.setAttribute("type","button"),s.setAttribute("role","tab"),s.hasAttribute("tabindex")||s.setAttribute("tabindex",s.classList.contains("active")?"0":"-1"),s.addEventListener("click",()=>{const o=s.getAttribute("data-tab");if(console.log("🖱️ Tab clicked:",o),n(o),o==="reservations-tab"){const i=P||ue(X)||ot;typeof be=="function"?be(i):D=i}else De({dashboardSubTab:null}).catch(i=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",i)})}))});const a=s=>{const o=document.querySelector("[data-tab].active"),i=ue(Ht),d=e[0]?.getAttribute("data-tab")||null,u=[s?.dashboardTab,i,ce,o?.getAttribute("data-tab"),d].filter(Boolean).find(g=>document.getElementById(g))||d;u&&(!me||u!==ce)&&(console.log("⭐ Initial tab:",u),n(u,{skipStore:!0}));const p=[s?.dashboardSubTab,ue(X)].filter(Boolean).find(g=>document.getElementById(g));p&&(ce==="reservations-tab"&&typeof be=="function"?(!me||p!==P)&&be(p,{skipStore:!0}):D=p),me||(document.body?.classList.remove("tabs-loading"),document.body?.classList.remove("no-js"),me=!0)},r=typeof et=="function"?et():null;a(r||null),vs().then(s=>a(s||null)).catch(s=>{console.warn("⚠️ [tabs.js] Failed to load tab preferences",s),a(null)}),Dn||(Dn=Ss(s=>{if(!(!me||!s))if(s.dashboardTab&&s.dashboardTab!==ce&&n(s.dashboardTab,{skipStore:!0}),ce==="reservations-tab"){if(s.dashboardSubTab&&s.dashboardSubTab!==P)Ue(s.dashboardSubTab);else if(!s.dashboardSubTab&&P){const o=ue(X);o?o!==P&&Ue(o):Ue(null)}}else s.dashboardSubTab&&(D=s.dashboardSubTab)}))}function ho(){console.log("🚀 [tabs.js] setupSubTabs()");const e=document.querySelectorAll("#reservations-tab .sub-tab-button"),t=document.querySelectorAll("#reservations-tab .sub-tab");if(console.log("📌 subTabButtons:",e),console.log("📌 subTabContents:",t),!e.length){console.warn("⚠️ [tabs.js] No reservation sub-tab buttons found");return}const n=Array.from(e).map(s=>s?.getAttribute("data-sub-tab")).filter(s=>typeof s=="string"&&s.trim().length>0),a=()=>n.length?n.includes(ot)?ot:n[0]:null,r=(s,{skipStore:o=!1}={})=>{if(!n.length)return;let i=s;(!i||!n.includes(i))&&(console.warn("⚠️ [tabs.js] Invalid sub-tab target, falling back to first available",{requested:i,available:n}),i=a());const d=document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${i}"]`),l=document.getElementById(i);if(!d||!l){console.warn("⚠️ [tabs.js] Unable to locate sub-tab button/content after fallback",{target:i});return}if(P===i&&d.classList.contains("active")&&l.classList.contains("active")&&l.getAttribute("aria-hidden")==="false"){l.removeAttribute("hidden"),l.style.display="block",l.setAttribute("aria-hidden","false"),P=i,Ot(d),o||(zt(X,i),De({dashboardSubTab:i}).catch(m=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",m)}));return}e.forEach(m=>{m.classList.remove("active"),m.classList.contains("tab")&&m.classList.remove("tab-active"),m.setAttribute("aria-selected","false"),m.setAttribute("tabindex","-1")}),d.classList.add("active"),d.classList.contains("tab")&&d.classList.add("tab-active"),d.setAttribute("aria-selected","true"),d.setAttribute("tabindex","0"),Ot(d),t.forEach(m=>{const p=m.id===i;m.classList.toggle("active",p),m.setAttribute("aria-hidden",p?"false":"true"),p?(m.removeAttribute("hidden"),m.style.display="block"):(m.setAttribute("hidden",""),m.style.display="none")}),P=i,zt(X,i),o||De({dashboardSubTab:i}).catch(m=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",m)}),i==="my-reservations-tab"?(console.log("📋 Rendering reservations list"),setTimeout(()=>{Pn()},50)):i==="calendar-tab"?(console.log("📅 Rendering calendar view"),setTimeout(()=>{it()},100)):i==="reports-tab"&&(console.log("📊 Rendering reports view"),setTimeout(()=>{k()},50))};if(be=(s,o={})=>{s?r(s,o):(e.forEach(i=>{i.classList.remove("active"),i.classList.contains("tab")&&i.classList.remove("tab-active"),i.setAttribute("aria-selected","false"),i.setAttribute("tabindex","-1")}),t.forEach(i=>{i.classList.remove("active"),i.setAttribute("aria-hidden","true"),i.setAttribute("hidden",""),i.style.display="none"}),P=null,Ta(X))},e.forEach(s=>{s.dataset.subTabListenerAttached||(s.addEventListener("click",()=>{const o=s.getAttribute("data-sub-tab");console.log("🖱️ Sub-tab clicked:",o),r(o)}),s.dataset.subTabListenerAttached="true")}),D)r(D,{skipStore:!0}),D=null;else{const s=document.querySelector("#reservations-tab .sub-tab-button.active"),o=a(),i=s?.getAttribute("data-sub-tab")||o;i&&(console.log("⭐ Initial sub-tab:",i),r(i,{skipStore:!0}))}On()}function Ue(e){typeof be=="function"?be(e,{skipStore:!0}):e&&(D=e)}function yo(){try{if(typeof et=="function")return et()||{}}catch(e){console.warn("⚠️ [tabs.js] Failed to read cached preferences",e)}return{}}function vo({attemptsLeft:e=0}={}){if(!me||typeof Vt!="function")return!1;const t=yo(),n=Array.from(document.querySelectorAll("[data-tab]"));if(!n.length)return!1;const a=n[0]?.dataset.tab||null,s=[ce,document.querySelector("[data-tab].active")?.getAttribute("data-tab")||null,t.dashboardTab,ue(Ht),a].filter(Boolean).find(i=>document.getElementById(i));if(!s)return!1;const o=()=>{const i=document.querySelector(`[data-tab].active[data-tab="${s}"]`),d=document.getElementById(s);return!!(i&&d?.classList.contains("active")&&d?.style.display!=="none")};if(s==="reservations-tab"){const i=Array.from(document.querySelectorAll("#reservations-tab .sub-tab-button"));if(!i.length)return!1;const d=i[0]?.getAttribute("data-sub-tab")||null,u=[P,document.querySelector("#reservations-tab .sub-tab-button.active")?.getAttribute("data-sub-tab")||null,document.querySelector("#reservations-tab .sub-tab.active")?.id||null,t.dashboardSubTab,ue(X),d].filter(Boolean).find(y=>document.getElementById(y)),m=document.querySelector("#reservations-tab .sub-tab-button.active"),p=document.querySelector("#reservations-tab .sub-tab.active"),g=p?.id||m?.getAttribute("data-sub-tab")||null;if(u&&g===u&&o())return p&&(p.removeAttribute("hidden"),p.style.display="block",p.setAttribute("aria-hidden","false")),!0;if(u)D=u;else if(e>0)return!1}else if(o())return!0;return Vt(s,{skipStore:!0,skipRender:!0}),!0}function on(){if(!me)return;let e=0;const t=5;we&&(clearTimeout(we),we=null);const n=()=>{if(vo({attemptsLeft:t-e})){we=null;return}if(e>=t){we=null;return}e+=1,we=setTimeout(n,50*(e+1))};n()}document.addEventListener("language:translationsReady",on);document.addEventListener("language:changed",on);document.addEventListener("theme:changed",on);const Ye={projects:["stat-projects","sidebar-stat-projects"],reservations:["stat-reservations","sidebar-stat-reservations"],equipment:["stat-equipment","sidebar-stat-equipment"],technicians:["stat-technicians","sidebar-stat-technicians"]};let Ut=!1;const So=1632,wo=1776;function To(e){if(e==null)return 0;if(typeof e=="number"&&Number.isFinite(e))return e;const t=String(e).trim().replace(/[\s,_]/g,"").replace(/[\u0660-\u0669]/g,a=>String(a.charCodeAt(0)-So)).replace(/[\u06f0-\u06f9]/g,a=>String(a.charCodeAt(0)-wo)).replace(/[^0-9.+-]/g,""),n=Number(t);return Number.isFinite(n)?n:0}function Eo(e){try{const t=To(e);return new Intl.NumberFormat("en-US",{maximumFractionDigits:0,useGrouping:!0}).format(t)}catch{return String(e??0)}}function We(e,t){if(!e)return;const n=document.getElementById(e);n&&(n.textContent=Eo(t))}function Mn(){Ut=!1;const e=Z(),t=Array.isArray(e.projects)?e.projects.length:0,n=Array.isArray(e.reservations)?e.reservations.length:0,a=Array.isArray(e.equipment)?e.equipment.length:0,r=Array.isArray(e.technicians)?e.technicians.length:0;Ye.projects.forEach(s=>We(s,t)),Ye.reservations.forEach(s=>We(s,n)),Ye.equipment.forEach(s=>We(s,a)),Ye.technicians.forEach(s=>We(s,r))}function Bn(){Ut||(Ut=!0,typeof requestAnimationFrame=="function"?requestAnimationFrame(Mn):setTimeout(Mn,16))}function xo(){["reservations:changed","projects:changed","equipment:changed","technicians:changed","customers:changed","maintenance:changed","language:changed"].forEach(t=>{document.addEventListener(t,Bn,{passive:!0})}),Bn()}function Ao(){const e=document.getElementById("dashboard-sidebar"),t=document.getElementById("sidebar-backdrop"),n=document.getElementById("sidebar-open"),a=document.getElementById("sidebar-close");return{sidebar:e,backdrop:t,openTrigger:n,closeTrigger:a}}function Lo({sidebar:e,backdrop:t}){e?.classList.add("open"),t?.classList.add("open"),e?.setAttribute("aria-hidden","false")}function Ge({sidebar:e,backdrop:t}){e?.classList.remove("open"),t?.classList.remove("open"),e?.setAttribute("aria-hidden","true")}function $o(){const e=document.querySelector("[data-dashboard-greeting]");if(!e)return;const t=e.querySelector("[data-greeting-toggle]"),n=e.querySelector("[data-greeting-panel]");if(!t||!n)return;const a=i=>{i.target instanceof Node&&(e.contains(i.target)||o(!1))},r=()=>{window.requestAnimationFrame(()=>{document.addEventListener("click",a,{capture:!0})})},s=()=>{document.removeEventListener("click",a,{capture:!0})},o=i=>{n.hidden=!i,t.setAttribute("aria-expanded",String(i)),e.dataset.state=i?"open":"closed",i?r():s()};o(!1),t.addEventListener("click",()=>{const d=!(t.getAttribute("aria-expanded")==="true");o(d),d&&!window.matchMedia("(min-width: 768px)").matches&&n.scrollIntoView({behavior:"smooth",block:"start"})})}function Co(){const e=Ao(),{sidebar:t,backdrop:n,openTrigger:a,closeTrigger:r}=e;t&&(t.setAttribute("aria-hidden","true"),a?.addEventListener("click",s=>{s.preventDefault(),Lo(e)}),r?.addEventListener("click",s=>{s.preventDefault(),Ge(e)}),n?.addEventListener("click",()=>{Ge(e)}),t.addEventListener("click",s=>{const o=s.target;if(o instanceof HTMLElement){if(o.hasAttribute("data-close-sidebar")||o.closest("[data-close-sidebar]")){Ge(e);return}o.closest("[data-tab]")&&Ge(e)}}),$o())}ws();let F=null;async function Nn(){if(!await Ts())return;Co(),go(),xo(),Es(),Gt(),Ps(),it(),bo(),or(),Ls(),On();const t=document.getElementById("excel-upload");t&&t.addEventListener("change",async a=>{const r=a.target.files&&a.target.files[0];r&&(await js(r),a.target.value="")});const n=document.getElementById("excel-upload-trigger");n&&t&&n.addEventListener("click",a=>{a.preventDefault(),t.click()}),document.getElementById("logout-btn")?.addEventListener("click",xs),Io(),ko()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{Nn().catch(e=>{console.error("❌ Failed to initialise app",e)})},{once:!0}):Nn().catch(e=>{console.error("❌ Failed to initialise app",e)});function Io(){document.querySelectorAll('input[type="datetime-local"]').forEach(e=>{e.addEventListener("input",()=>{const t=e.value;if(!t.includes("T"))return;const[n,a]=t.split("T"),[r]=a.split(":"),s=`${r.padStart(2,"0")}:00`,o=`${n}T${s}`;e.value!==o&&(e.value=o,setTimeout(()=>e.blur(),150))})})}function ko(){const e=new URLSearchParams(window.location.search),t=e.get("reservationEditId"),n=e.get("reservationEditIndex");if(!t&&!n)return;F={reservationId:t,reservationIndex:n!=null?Number(n):null},Ea(),e.delete("reservationEditId"),e.delete("reservationEditIndex");const a=e.toString(),r=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;window.history.replaceState({},document.title,r)}function Ea(){if(!F)return;const t=Z().reservations||[];let n=null;if(F.reservationId){const a=t.findIndex(r=>String(r?.id)===F.reservationId||String(r?.reservationId)===F.reservationId);a!==-1&&(n=a)}n===null&&typeof F.reservationIndex=="number"&&!Number.isNaN(F.reservationIndex)&&F.reservationIndex>=0&&F.reservationIndex<t.length&&(n=F.reservationIndex),n!==null&&(F=null,setTimeout(()=>{document.querySelector('[data-tab="reservations-tab"]')?.click(),setTimeout(()=>{document.querySelector('.sub-tab-button[data-sub-tab="my-reservations-tab"]')?.click(),setTimeout(()=>{const r=window.editReservation;typeof r=="function"&&r(n)},150)},150)},150))}document.addEventListener("reservations:changed",()=>{F&&Ea()});
