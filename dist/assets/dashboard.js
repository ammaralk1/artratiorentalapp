const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./reports.js","./auth.js","./auth.css","./reservationsService.js","./controller.js","./dashboardShell.js","./customers.js","./index.css","./dashboardMetrics.js"])))=>i.map(i=>d[i]);
import{d as P,t as c,e as Ue,n as f,b as W,A as dn,s as At,f as un,h as y,j as Ie,k as me,o as nt,u as fe,p as $e,q as mn,r as pn,a as fn,c as bn,i as gn,l as yn}from"./auth.js";/* empty css     */import{i as vn}from"./dashboardShell.js";import{r as hn}from"./customers.js";import{e as Tt,a as Sn,r as ve,b as En,i as qn,s as In,c as _n,l as An,d as Tn,f as wn,u as wt,g as kn,h as Ln,j as Cn,k as Bn,m as $n,n as at,E as pt,o as Mn,p as Rn,q as Fn,t as Nn,v as Dn,w as xn}from"./controller.js";import{i as Pn,b as zn,c as jn,g as ft,e as On,s as Hn,f as Vn,n as kt,h as Un}from"./reservationsService.js";const Wn="modulepreload",Qn=function(e,t){return new URL(e,t).href},bt={},Lt=function(t,n,a){let o=Promise.resolve();if(n&&n.length>0){let p=function(m){return Promise.all(m.map(u=>Promise.resolve(u).then(b=>({status:"fulfilled",value:b}),b=>({status:"rejected",reason:b}))))};const r=document.getElementsByTagName("link"),s=document.querySelector("meta[property=csp-nonce]"),d=s?.nonce||s?.getAttribute("nonce");o=p(n.map(m=>{if(m=Qn(m,a),m in bt)return;bt[m]=!0;const u=m.endsWith(".css"),b=u?'[rel="stylesheet"]':"";if(a)for(let h=r.length-1;h>=0;h--){const S=r[h];if(S.href===m&&(!u||S.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${m}"]${b}`))return;const g=document.createElement("link");if(g.rel=u?"stylesheet":Wn,u||(g.as="script"),g.crossOrigin="",g.href=m,d&&g.setAttribute("nonce",d),document.head.appendChild(g),u)return new Promise((h,S)=>{g.addEventListener("load",h),g.addEventListener("error",()=>S(new Error(`Unable to preload CSS for ${m}`)))})}))}function i(r){const s=new Event("vite:preloadError",{cancelable:!0});if(s.payload=r,window.dispatchEvent(s),!s.defaultPrevented)throw r}return o.then(r=>{for(const s of r||[])s.status==="rejected"&&i(s.reason);return t().catch(i)})};let We=!1;function Yn(){document.querySelectorAll('input[type="time"]').forEach(t=>{t.setAttribute("step","300")})}function Gn(){return typeof window<"u"&&typeof window.flatpickr=="function"?window.flatpickr.bind(window):typeof globalThis<"u"&&typeof globalThis.flatpickr=="function"?globalThis.flatpickr.bind(globalThis):(console.warn("⚠️ Flatpickr غير متاح - سيتم تخطي تهيئة عناصر التاريخ"),null)}function Kn(){const e=Gn(),t={dateFormat:"Y-m-d",altInput:!0,altFormat:"Y-m-d",allowInput:!0,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"},n=[["#res-start",{}],["#res-end",{}],["#filter-start-date",{}],["#filter-end-date",{}],["#edit-res-start",{}],["#edit-res-end",{}]],a={enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,disableMobile:!0,minuteIncrement:5,altInputClass:"flatpickr-alt-input form-control"},o=["#res-start-time","#res-end-time","#edit-res-start-time","#edit-res-end-time"];e&&(n.forEach(([r,s])=>{document.querySelector(r)&&e(r,{...t,...s})}),o.forEach(r=>{document.querySelector(r)&&e(r,{...a})}));const i=document.querySelector("#res-start-time");i&&i.dispatchEvent(new Event("change",{bubbles:!0}))}function Ct(){if(!We){Yn(),In(()=>ve()),_n(kn()),Pn({onDraftChange:Ln,onEditChange:wt}),An(),Tn(),We=!0;try{const e=()=>ve();document.addEventListener("reservations:updated",e),window.addEventListener("reservations:updated",e)}catch{}}}function Jn(){const e=document.body;e&&e.dataset.reservationsTechListener!=="true"&&(document.addEventListener("technicians:updated",()=>{const{technicians:t=[]}=P();zn(t),wn(),wt()}),e.dataset.reservationsTechListener="true")}async function Xn(){await Tt();try{await Sn({force:!0})}catch(e){console.warn("⚠️ [reservations/events] Failed to pre-load projects for reservation form",e)}ve(),En(),qn({onAfterSubmit:Cn}),We||Ct(),Kn(),Jn()}const Zn={limit:200};let _=null,gt=!1,yt=!1,vt=!1,ht=null,Pe=null,St=!1,ze=null,je=null,Oe=!1,G="";const He=new Map;function pe(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Bt(){const e=document.getElementById("calendar"),t=document.getElementById("calendar-panel")||e?.parentElement||null,n=document.getElementById("calendar-status");return{calendarEl:e,panelEl:t,statusEl:n}}function ea(){if(typeof window>"u")return null;const e=window.tui?.Calendar||window.toastui?.Calendar||window.Calendar;return typeof e=="function"?e:null}function ta(e){return He.has(e)||He.set(e,new Intl.DateTimeFormat(e,{hour:"2-digit",minute:"2-digit"})),He.get(e)}function na(e,t,n=!1){if(n){const m=(Ue?.()==="en"?"en":"ar")==="en"?"All day":"طوال اليوم";return c("calendar.labels.allDay",m)}if(!e)return"";const a=new Date(e);if(Number.isNaN(a.getTime()))return"";const o=Ue?.()==="en"?"en-US":"ar-SA-u-ca-gregory-nu-latn",i=ta(o),r=i.format(a);if(!t)return r;const s=new Date(t);if(Number.isNaN(s.getTime()))return r;const d=i.format(s);return r===d?r:`${r} – ${d}`}function ue({loading:e=!1,error:t="",empty:n=!1}={}){const{panelEl:a,statusEl:o}=Bt();if(!a||!o)return;const i=typeof t=="string"?t.trim().length>0:!!t,r=!e&&!i&&!!n,s=e||i||r;if(a.classList.toggle("is-loading",e),a.classList.toggle("has-error",i),a.classList.toggle("is-empty",r),o.dataset.initialized||(o.classList.add("calendar-status-card","shadow-2xl","bg-base-100/95","border","border-base-200/80","rounded-3xl","text-base-content","px-8","py-8","flex","flex-col","items-center","justify-center","gap-4"),o.dataset.initialized="true"),o.classList.remove("calendar-status-card--loading","calendar-status-card--error","calendar-status-card--empty"),o.classList.toggle("hidden",!s),!s){o.innerHTML="",o.removeAttribute("data-status");return}let d="";e?d=c("calendar.status.loading","⏳ جارٍ تحميل الحجوزات..."):i?d=typeof t=="string"&&t.trim().length>0?t:c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً."):r&&(d=c("calendar.status.empty","لا توجد حجوزات لعرضها في هذه الفترة."));const p=e?"loading":i?"error":"empty";if(o.setAttribute("data-status",p),o.classList.add(`calendar-status-card--${p}`),o.innerHTML="",e){const u=document.createElement("span");u.className="loading loading-spinner loading-md text-primary",u.setAttribute("aria-hidden","true"),o.appendChild(u)}else{const u=document.createElement("span");u.className="calendar-status-card__icon",u.setAttribute("aria-hidden","true"),u.textContent=i?"⚠️":"🗓️",o.appendChild(u)}const m=document.createElement("span");m.className="calendar-status-card__message text-center text-sm font-semibold",m.textContent=d,o.appendChild(m)}function aa(e,t=null){if(!e||typeof e!="object")return null;const n=e.start??e.startDatetime??e.start_datetime??null,a=e.end??e.endDatetime??e.end_datetime??n;if(!n)return null;String(e.status??"").toLowerCase();const o=e.paidStatus??e.paid_status??null,i=e.paid!=null?e.paid:o==="paid",{effectiveConfirmed:r}=On(e,t),s=e.reservationId??e.reservationCode??e.reservation_code??e.id??n,d=e.customerName??e.customer_name??"";let p=!!e.completed;if(!p&&a){const m=new Date(a);Number.isNaN(m.getTime())||(p=m<new Date)}return{id:e.id??s??n,start:n,end:a||n,paid:i,confirmed:r,completed:p,reservationId:s??"",customerName:d,raw:e}}async function ia(){if(Oe)return ft();Oe=!0,G="";try{await Tt({suppressError:!1,params:Zn})}catch(e){console.error("❌ [calendar] Failed to load reservations for calendar view",e),G=jn(e)?e.message:e instanceof Error&&e.message||""}finally{Oe=!1}return ft()}function we(){if(_){try{typeof _.destroy=="function"&&_.destroy()}catch{}_=null}}function ra(e){const t={events:e};typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("calendar:updated",{detail:t})):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("calendar:updated",{detail:t}))}function $t(){Fe()}function sa(){gt||(document.addEventListener("language:changed",()=>{_&&_.setOption("locale",Ue()),Fe()}),gt=!0),yt||(document.addEventListener("reservations:changed",()=>{$t()}),yt=!0)}function Mt(e){return e<=480?"xs":e<=768?"sm":"lg"}function Rt(){if(typeof window>"u")return"month";const e=window.innerWidth||1024,t=Mt(e);return t==="xs"?"day":t==="sm"?"week":"month"}function Qe(){if(!_)return;const e=typeof window<"u"&&window.innerWidth||1024,t=Mt(e),n=Rt();ht!==t&&typeof _.changeView=="function"&&(ht=t,_.changeView(n,!0))}function oa(){vt||typeof window>"u"||(window.addEventListener("resize",()=>{Pe&&clearTimeout(Pe),Pe=setTimeout(()=>{Qe()},160)},{passive:!0}),vt=!0)}function ca(){if(St||typeof MutationObserver>"u"||typeof document>"u")return;const e=()=>{je&&clearTimeout(je),je=setTimeout(()=>{$t()},80)};ze=new MutationObserver(e),ze.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),document.body&&ze.observe(document.body,{attributes:!0,attributeFilter:["class"]}),St=!0}function la(e){const t=document.getElementById("calendar-reservation-details");if(!t){alert(c("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"));return}const n=P()||{},{reservations:a=[],customers:o=[],projects:i=[],technicians:r=[]}=n,s=e?.raw&&typeof e.raw=="object"?{...e.raw,...e}:{...e},d=[s.id,s.reservationId,s.reservation_id,s.reservationCode,s.reservation_code].map(v=>v==null?"":String(v)).filter(v=>v.length>0);let p=-1,m=null;d.length>0&&(p=a.findIndex(v=>{const j=[v?.id,v?.reservationId,v?.reservation_id,v?.reservationCode,v?.reservation_code].map(D=>D==null?"":String(D)).filter(D=>D.length>0);return j.length===0?!1:j.some(D=>d.includes(D))}),p>=0&&(m=a[p]));let u;m?(u={...s,...m},Array.isArray(m.items)&&m.items.length&&(u.items=m.items),Array.isArray(m.packages)&&m.packages.length&&(u.packages=m.packages)):u=s;const b=u.projectId??u.project_id??null,g=b!=null&&i.find(v=>String(v.id)===String(b))||null,h=u.customerId??u.customer_id,S=o.find(v=>String(v.id)===String(h)),A=Hn(),N=[...Array.isArray(A)?A:[],...Array.isArray(r)?r:[]],$=new Map;N.forEach(v=>{if(!v||v.id==null)return;const j=String(v.id),D=$.get(j)||{};$.set(j,{...D,...v})});const z=Array.from($.values());let T="";try{T=Bn(u,S,z,p>=0?p:0,g)}catch(v){console.error("❌ [calendar] Failed to build reservation details for calendar modal",v),t.innerHTML=`<p class="text-sm text-error">${pe(c("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"))}</p>`;return}t.innerHTML=T,t.classList.add("calendar-reservation-details"),t.querySelector(".reservation-modal-actions")?.remove(),t.querySelectorAll(".reservation-qty-btn, .reservation-remove-button").forEach(v=>{v instanceof HTMLElement&&(v.setAttribute("disabled","true"),v.setAttribute("aria-disabled","true"),v.setAttribute("tabindex","-1"))});const ae=t.querySelector('[data-action="open-project"]');ae&&(g?ae.addEventListener("click",()=>{const v=g?.id!=null?String(g.id):"",j=v?`projects.html?project=${encodeURIComponent(v)}`:"projects.html";window.location.href=j}):ae instanceof HTMLElement&&ae.setAttribute("disabled","true"));const Te=document.getElementById("calendarReservationModal");Te&&window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(Te).show():alert(c("calendar.alerts.cannotOpenModal","لا يمكن فتح نافذة التفاصيل"))}function Fe(){sa(),oa(),ca();const{calendarEl:e}=Bt();if(!e)return;const t=ea();if(!t){const n=c("calendar.status.missingLibrary","تعذر تحميل مكتبة التقويم. يرجى تحديث الصفحة.");ue({error:n}),we();return}(async()=>{ue({loading:!0});const n=await ia();if(G){const r=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");ue({loading:!1,error:G||r}),we();return}const a=da(n);we();const o=Rt();_=new t("#calendar",{defaultView:o,usageStatistics:!1,isReadOnly:!0,week:{taskView:!1,hourStart:6,hourEnd:24},month:{visibleWeeksCount:0,startDayOfWeek:0},template:{time(r){const s=r?.raw?.paid===!0||r?.raw?.paid==="paid",d=r?.raw?.confirmed===!0||r?.raw?.confirmed==="true",p=r?.raw?.completed===!0||r?.raw?.completed==="true",m=c("calendar.labels.unknownCustomer","غير معروف"),u=na(r.start?.toString?.()||r.start,r.end?.toString?.()||r.end,r.isAllDay),b=r?.raw?.reservationId?String(r.raw.reservationId):"—",g=r?.raw?.customerName||m,h=($,z)=>`<span class="badge ${$} badge-sm">${pe(z)}</span>`,S=d?c("calendar.badges.confirmed","مؤكد"):c("calendar.badges.pending","غير مؤكد"),A=s?c("calendar.badges.paid","مدفوع"):c("calendar.badges.unpaid","غير مدفوع"),N=[h(d?"badge-success":"badge-warning",S),h(s?"badge-info":"badge-error",A)];return p&&N.push(h("badge-neutral",c("calendar.badges.completed","منتهي"))),`
            <div class="card bg-base-100/90 border border-base-200 shadow-sm rounded-xl p-2">
              <div class="flex items-baseline justify-between text-[0.8rem]">
                <span class="font-bold">${pe(u||"")}</span>
                <span class="font-semibold">${pe(b)}</span>
              </div>
              <div class="mt-1 font-semibold text-sm truncate">${pe(g)}</div>
              <div class="mt-1 flex gap-1 flex-wrap">${N.join("")}</div>
            </div>
          `}}});const i=r=>{if(r)try{la(r)}catch{}};typeof _.on=="function"&&(_.on("clickSchedule",r=>i(r?.schedule?.raw||r?.schedule)),_.on("clickEvent",r=>i(r?.event?.raw||r?.event)));try{typeof _.createSchedules=="function"?_.createSchedules(a):typeof _.createEvents=="function"&&_.createEvents(a)}catch{}Qe(),ra(a),ue({loading:!1,error:"",empty:a.length===0}),setTimeout(()=>{Qe()},120)})().catch(n=>{console.error("❌ [calendar] renderCalendar failed",n),G=n instanceof Error&&n.message||G||"";const a=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");ue({loading:!1,error:G||a}),we()})}function da(e=[]){const{projects:t=[]}=P(),n=new Map(t.map(a=>[String(a.id),a]));return e.map(a=>{const o=a?.projectId??a?.project_id??null,i=o!=null&&n.get(String(o))||null,r=aa(a,i);return r?{id:String(r.id),calendarId:"default",title:"",category:"time",isAllDay:!1,start:r.start,end:r.end,raw:{...a,paid:r.paid,confirmed:r.confirmed,completed:r.completed,reservationId:r.reservationId,customerName:r.customerName}}:null}).filter(Boolean)}const ua=P()||{};let ee=(ua.maintenance||[]).map(Ft);function Ne(){return ee}function De(e){return ee=Array.isArray(e)?e.map(Ft):[],At({maintenance:ee}),qa(),ee}async function ma(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([i,r])=>{r!=null&&r!==""&&t.set(i,String(r))});const n=t.toString(),a=await W(`/maintenance/${n?`?${n}`:""}`),o=Array.isArray(a?.data)?a.data.map(it):[];return De(o)}async function pa(e){const t=await W("/maintenance/",{method:"POST",body:e}),n=it(t?.data??{});return De([n,...ee.filter(a=>a.id!==n.id)]),n}async function fa(e,t){const n=await W(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=it(n?.data??{});return De(ee.map(o=>String(o.id)===String(e)?a:o)),a}async function ba(e){await W(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),De(ee.filter(t=>String(t.id)!==String(e)))}function ga({equipmentId:e,technicianId:t,issue:n,priority:a,status:o,scheduledAt:i,resolutionReport:r}){return{equipment_id:e,technician_id:null,maintenance_type:null,priority:a,reported_at:null,scheduled_at:null,status:o,notes:n??"",resolution_report:null,repair_cost:null}}function it(e={}){return Nt({id:e.id,equipment_id:e.equipment_id,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode,equipmentDesc:e.equipmentDesc??e.equipment_desc??e.equipment_description,issue:e.issue??e.notes,priority:e.priority,status:e.status,status_raw:e.status_raw,createdAt:e.createdAt??e.reportedAt??e.reported_at,reportedAt:e.reportedAt??e.reported_at,scheduledAt:e.scheduledAt??e.scheduled_at,resolvedAt:e.resolvedAt??e.resolved_at,resolutionReport:e.resolutionReport??e.resolution_report,technicianId:e.technicianId??e.technician_id,repairCost:e.repairCost??e.repair_cost})}function Ft(e={}){return Nt(e)}function Nt(e={}){const t=e.id??e.ticketId??Date.now(),n=e.equipmentDesc??e.equipment_desc??e.equipmentDescription??e.equipment_name??"",a=va(e.status_raw??e.status??"open"),o=ha(a),i=Ea(e,a);return{id:Number(t),equipmentId:e.equipment_id??e.equipmentId??null,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode??"",equipmentDesc:n,issue:e.issue??e.notes??"",priority:Sa(e.priority??"medium"),status:o,statusRaw:a,statusLabel:i,createdAt:e.createdAt??e.reportedAt??e.reported_at??null,reportedAt:e.reportedAt??e.reported_at??null,scheduledAt:e.scheduledAt??e.scheduled_at??null,resolvedAt:e.resolvedAt??e.resolved_at??null,resolutionReport:e.resolutionReport??e.resolution_report??"",technicianId:e.technicianId??e.technician_id??null,repairCost:ya(e.repairCost??e.repair_cost??e.repair_cost_value??null)}}function ya(e){if(e==null||e==="")return null;const t=Number.parseFloat(f(String(e)));return!Number.isFinite(t)||t<0?null:Math.round(t*100)/100}function va(e){const t=String(e??"").trim();return t&&t.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-]/g,"")||"open"}function ha(e){const t=Dt(e);return["completed","cancelled"].includes(t)?"closed":"open"}function Sa(e){const t=String(e??"medium").trim().toLowerCase();return["low","medium","high"].includes(t)?t:"medium"}function Ea(e={},t="open"){const n=e.status_label??e.statusLabel??e.status_display??e.status_text??e.status??e.status_raw??t,a=String(n??"").trim();return a||t.replace(/[_-]+/g," ").replace(/\b\w/g,o=>o.toUpperCase())}function Dt(e){const t=String(e??"").toLowerCase();switch(t){case"open":case"قيد الصيانة":case"قيد الانتظار":return"open";case"in_progress":case"in-progress":case"جاري العمل":return"in_progress";case"completed":case"مكتمل":case"تم الإصلاح":case"closed":case"مغلق":return"completed";case"cancelled":case"ملغي":return"cancelled";default:return t.includes("progress")||t.includes("تنفيذ")?"in_progress":t.includes("complete")||t.includes("close")||t.includes("منجز")||t.includes("مغلق")?"completed":t.includes("cancel")||t.includes("ملغي")?"cancelled":t||"open"}}function qa(){typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("maintenance:updated")):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("maintenance:updated"))}function he(e){return e instanceof dn}function Ye(e){if(!e)return null;const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),o=String(t.getFullYear()).slice(-2);return`${n}/${a}/${o}`}let ne=Ne(),te=[],be=null,re=!1,ge="",se=ne.length>0,F={id:null,equipmentDesc:"",equipmentBarcode:"",repairCost:null,resolvedAt:null,mode:"close"},rt=null,k=null,q=null,B=null,oe=null,ye=null,ce=null,I=null;async function Se({showToastOnError:e=!0}={}){if(!re){re=!0,ge="",x();try{await ma(),se=!0}catch(t){se=ne.length>0,console.error("❌ [maintenance] Failed to load maintenance tickets",t),ge=he(t)?t.message:c("maintenance.toast.fetchFailed","تعذر تحميل بيانات الصيانة. حاول تحديث الصفحة."),e&&y(ge,"error")}finally{re=!1,ne=Ne(),x()}}}function Ge(){return c("maintenance.form.selectedInfo","لم يتم اختيار معدة بعد.")}function H(e){return f(String(e||"")).trim().toLowerCase()}function xt(e=""){return f(String(e)).trim().toLowerCase()}function Ia(e={}){const t=String(e?.desc??"").trim(),n=f(String(e?.displayBarcode??e?.barcode??"")).trim();return n?`${t} | ${n}`:t}function _a(e){const t=f(String(e||""));if(!t.trim())return{description:"",barcode:""};const[n,...a]=t.split("|");return{description:n.trim(),barcode:a.join("|").trim()}}function Pt(e){return f(String(e||"")).trim().toLowerCase()}function E(e=""){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Aa(e=new Date){const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=a=>String(a).padStart(2,"0");return`${t.getFullYear()}-${n(t.getMonth()+1)}-${n(t.getDate())} ${n(t.getHours())}:${n(t.getMinutes())}:${n(t.getSeconds())}`}function Q(){return ne=Ne(),ne}function zt(e){return Q().find(n=>Number(n.id)===Number(e))||null}function jt(e){const t=String(e??"").trim().toLowerCase();return t?["maintenance","صيانة"].includes(t)?"maintenance":["reserved","محجوز"].includes(t)?"reserved":["retired","متوقف","خارج الخدمة"].includes(t)?"retired":"available":"available"}function st(){const{equipment:e=[]}=P(),t=c("maintenance.table.noName","بدون اسم");return te=(e||[]).map(n=>{const a=String(n?.barcode??"").trim(),o=H(a),i=Number.parseInt(n?.qty??n?.quantity??0,10),r=Number.isFinite(i)?Math.max(i,0):1,s=n?.image||n?.imageUrl||n?.image_url||"",d=n?.status||"متاح",p=n?.desc||n?.description||n?.name||t,m=Ia({desc:p,displayBarcode:a,barcode:o});return{id:n?.id??n?.equipment_id??n?.equipmentId??null,barcode:o,displayBarcode:a,desc:p,status:d,statusNormalized:jt(d),price:Number(n?.price||n?.unit_price)||0,category:n?.category||"",quantity:r,image:s,searchValue:m,searchValueNormalized:Pt(m),descriptionNormalized:xt(p)}}),te.sort((n,a)=>n.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),te}function ot(){const e=new Set,t=new Map;return Q().filter(n=>n.status==="open").forEach(n=>{const a=H(n.equipmentBarcode);a&&(e.add(a),t.set(a,(t.get(a)||0)+1))}),{set:e,map:t}}function Ot(e){const t=H(e);if(!t)return 0;const{map:n}=ot();return n.get(t)||0}function xe(e){const t=H(e);return t&&(te.length?te:st()).find(a=>a.barcode===t)||null}function Ta(e){const t=te.length?te:st();if(!t.length)return null;const n=Pt(e);if(n){const s=t.find(d=>d.searchValueNormalized===n);if(s)return s}const{description:a,barcode:o}=_a(e);if(o){const s=H(o);if(s){const d=t.find(p=>p.barcode===s);if(d)return d}}const i=xt(a||e);if(!i)return null;const r=t.find(s=>s.descriptionNormalized===i);return r||t.find(s=>s.descriptionNormalized.includes(i))||null}function Ke(e,t=null){if(!e)return!0;const n=e.barcode,a=Number.isFinite(e.quantity)?e.quantity:0,i=(t||ot().map).get(n)||0;return a<=0?!0:a===1?e.statusNormalized==="maintenance"||i>=1:i>=a}function K({keepInputs:e=!1,silent:t=!1}={}){const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),o=document.getElementById("maintenance-equipment-search"),i=document.getElementById("maintenance-selected-info");n&&(n.value=""),e||(a&&(a.value=""),o&&(o.value="")),i&&(i.textContent=Ge(),i.classList.remove("maintenance-selected-info--has-selection")),be=null}function Ht(e){const t=document.getElementById("maintenance-selected-info");if(!t)return;const n=c("maintenance.info.barcodeLabel","باركود"),a=c("maintenance.report.notAvailable","غير متوفر"),o=c("maintenance.info.unitsAvailable","الوحدات المتاحة الآن"),i=c("maintenance.info.categoryLabel","القسم"),r=e.displayBarcode||e.barcode||a,s=e.barcode,d=Number.isFinite(e.quantity)?e.quantity:0,p=Ot(s),m=Math.max(d-p,0),u=e.category?`
    <div class="maintenance-selected-info__meta">${i}: <strong>${E(e.category)}</strong></div>
  `:"",b=d>0?`
    <div class="maintenance-selected-info__meta">
      ${o}: <strong>${m}</strong> / ${d}
    </div>
  `:"",g=e.image?`<img class="maintenance-selected-info__image" src="${E(e.image)}" alt="${E(e.desc)}">`:'<div class="maintenance-selected-info__placeholder" aria-hidden="true">🎥</div>';t.innerHTML=`
    <div class="maintenance-selected-info__media">${g}</div>
    <div class="maintenance-selected-info__body">
      <div class="maintenance-selected-info__name">${E(e.desc)}</div>
      <div class="maintenance-selected-info__meta">${n}: <strong>${E(r)}</strong></div>
      ${b}
      ${u}
    </div>
  `,t.classList.add("maintenance-selected-info--has-selection")}function ct(e,{silent:t=!1}={}){if(!e)return!1;if(Ke(e))return t||y(c("maintenance.toast.equipmentBlocked","⚠️ هذه المعدة قيد الصيانة ولا يمكن اختيارها حالياً")),!1;const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),o=document.getElementById("maintenance-equipment-search");return n&&(n.value=e.barcode),a&&(a.value=e.displayBarcode||e.barcode),o&&(o.value=e.searchValue||e.desc),Ht(e),be=e,!0}function Vt(e,{showFeedback:t=!0}={}){const n=xe(e);return n?ct(n,{silent:!t}):(t&&y(c("maintenance.toast.equipmentNotFoundBarcode","❌ لم يتم العثور على معدة بهذا الباركود")),!1)}function Ut(e,{showFeedback:t=!0}={}){const n=Ta(e);return n?ct(n,{silent:!t}):(t&&y(c("maintenance.toast.equipmentNotFoundName","❌ لم يتم العثور على معدة بالاسم المدخل")),!1)}function lt(){const e=document.getElementById("maintenance-equipment-options"),t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=st(),{map:o}=ot();e&&(e.innerHTML=a.map(r=>`<option value="${E(r.searchValue||r.desc)}"></option>`).join(""));const i=document.getElementById("maintenance-selected-barcode");if(i&&i.value){const r=xe(i.value);!r||Ke(r,o)?(K({keepInputs:!0,silent:!0}),r&&Ke(r,o)&&y(c("maintenance.toast.equipmentBecameBlocked","⚠️ هذه المعدة أصبحت قيد الصيانة ولا يمكن اختيارها"))):ct(r,{silent:!0})}else K({keepInputs:!0,silent:!0});if(t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",r=>{r.key==="Enter"&&(r.preventDefault(),Vt(t.value)||K({keepInputs:!0,silent:!0}))}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached){const r=()=>{if(!n.value){K({keepInputs:!0,silent:!0});return}Ut(n.value)||K({keepInputs:!0,silent:!0})};n.addEventListener("change",r),n.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),r())}),n.dataset.listenerAttached="true"}}async function Me(){try{await $n({showToastOnError:!1})}catch(e){console.error("❌ [maintenance] refreshEquipmentData failed",e)}finally{at(),lt()}}function Wt(){const e=document.getElementById("closeMaintenanceModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;if(!t?.Modal)return!1;rt=t.Modal.getOrCreateInstance(e),k||(k=e.querySelector("#maintenance-close-report")),q||(q=e.querySelector("#maintenance-close-cost")),q&&q.dataset.normalizeAttached!=="true"&&(q.addEventListener("input",a=>{wa(a.currentTarget),a.currentTarget?.classList.remove("is-invalid")}),q.dataset.normalizeAttached="true"),B||(B=e.querySelector("#maintenance-close-submit")),oe||(oe=e.querySelector("#maintenance-close-modal-details"));const n=e.querySelector("#maintenance-close-form");return n&&!n.dataset.listenerAttached&&(n.addEventListener("submit",La),n.dataset.listenerAttached="true"),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",Qt),e.dataset.listenerAttached="true"),!0}function Qt(){F={id:null,equipmentDesc:"",equipmentBarcode:"",repairCost:null,resolvedAt:null,mode:"close"},k&&(k.value="",k.classList.remove("is-invalid")),q&&(q.value="",q.classList.remove("is-invalid")),oe&&(oe.innerHTML=""),Ee(!1);const e=document.getElementById("closeMaintenanceModal");if(e){const t=e.querySelector("#maintenance-close-modal-title"),n=e.querySelector(".maintenance-close-modal__subtitle");t&&(t.textContent=c("maintenance.closeModal.title","🔧 إغلاق تذكرة الصيانة")),n&&(n.textContent=c("maintenance.closeModal.subtitle","يرجى كتابة تقرير الإصلاح قبل إغلاق هذه التذكرة.")),B&&(B.textContent=c("maintenance.closeModal.confirm","إغلاق التذكرة"))}}function Yt(){const e=document.getElementById("maintenanceReportModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;return t?.Modal?(ye=t.Modal.getOrCreateInstance(e),ce||(ce=e.querySelector("#maintenance-report-modal-content")),I||(I=e.querySelector("#maintenance-report-edit")),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",Gt),e.dataset.listenerAttached="true"),I&&I.dataset.listenerAttached!=="true"&&(I.addEventListener("click",Fa),I.dataset.listenerAttached="true"),!0):!1}function Gt(){ce&&(ce.innerHTML=""),I&&(I.hidden=!0,I.disabled=!1,delete I.dataset.id)}function Ee(e){if(!B)return;const t=F.mode==="edit",n=t?c("maintenance.closeModal.editSaving","⏳ جاري الحفظ..."):c("maintenance.closeModal.saving","⏳ جاري الإغلاق..."),a=t?c("maintenance.closeModal.editConfirm","حفظ التعديلات"):c("maintenance.closeModal.confirm","إغلاق التذكرة");e?(B.disabled=!0,B.dataset.loading="true",B.textContent=n):(B.disabled=!1,B.removeAttribute("data-loading"),B.textContent=a)}function wa(e){if(!e)return;const t=e.value;if(typeof t!="string")return;const n=f(t).replace(/٫/g,".").replace(/٬/g,",");if(n!==t){const{selectionStart:a,selectionEnd:o}=e;if(e.value=n,a!==null&&o!==null)try{e.setSelectionRange(a,o)}catch{}}}function ka(e,t){const n=typeof e=="string"?e.trim():"",a=Number.isFinite(t);if(!n)return{provided:a,value:null,error:null};const i=f(n).replace(/٫/g,".").replace(/٬/g,",").replace(/[^0-9.,-]/g,"");if(!i)return{provided:!0,value:null,error:"invalid"};const r=i.includes(","),s=i.includes(".");let d=i;r&&!s?d=i.replace(",","."):r&&s&&(d=i.replace(/,/g,""));const p=Number.parseFloat(d);return!Number.isFinite(p)||p<0?{provided:!0,value:null,error:"invalid"}:{provided:!0,value:Math.round(p*100)/100,error:null}}function Kt(e,{mode:t="close"}={}){const n=zt(e);if(!n){y(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!Wt()){const d=prompt(c("maintenance.prompt.closeReport","أدخل تقرير الإصلاح / الإجراءات المتخذة:"));if(d===null)return;const p=d.trim();if(!p){y(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error");return}Jt(e,p);return}const a=n.repairCost!=null&&n.repairCost!==""?Number.parseFloat(f(String(n.repairCost))):null,o=Number.isFinite(a)?Math.round(a*100)/100:null,i=t==="edit"?"edit":"close";if(F={id:n.id,equipmentDesc:n.equipmentDesc||"",equipmentBarcode:n.equipmentBarcode||"",repairCost:o,resolvedAt:n.resolvedAt||null,mode:i},k&&(k.value=n.resolutionReport||"",k.classList.remove("is-invalid")),q&&(o!==null?q.value=f(o.toFixed(2)):q.value="",q.classList.remove("is-invalid")),oe){const d=c("maintenance.report.barcode","الباركود"),p=c("maintenance.report.notAvailable","غير متوفر"),m=F.equipmentDesc||p,u=F.equipmentBarcode?f(F.equipmentBarcode):p;oe.innerHTML=`
      <div class="maintenance-close-modal__ticket-card" role="group" aria-labelledby="maintenance-close-ticket-title">
        <div class="maintenance-close-modal__ticket-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 2h6"></path>
            <path d="M10 4h4"></path>
            <path d="M8 4h-2a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2"></path>
            <path d="M9 12l2 2 4-4"></path>
          </svg>
        </div>
        <div class="maintenance-close-modal__ticket-info">
          <div id="maintenance-close-ticket-title" class="maintenance-close-modal__ticket-title">${m}</div>
          <div class="maintenance-close-modal__ticket-meta">${d}: <span>${u}</span></div>
        </div>
      </div>
    `}Ee(!1);const r=i==="edit";B&&(B.textContent=r?c("maintenance.closeModal.editConfirm","حفظ التعديلات"):c("maintenance.closeModal.confirm","إغلاق التذكرة"));const s=document.getElementById("closeMaintenanceModal");if(s){const d=s.querySelector("#maintenance-close-modal-title"),p=s.querySelector(".maintenance-close-modal__subtitle");d&&(d.textContent=r?c("maintenance.closeModal.editTitle","✏️ تعديل بيانات الإغلاق"):c("maintenance.closeModal.title","🔧 إغلاق تذكرة الصيانة")),p&&(p.textContent=r?c("maintenance.closeModal.editSubtitle","يمكنك تحديث تقرير الإصلاح وتكلفته."):c("maintenance.closeModal.subtitle","يرجى كتابة تقرير الإصلاح قبل إغلاق هذه التذكرة."))}rt?.show(),setTimeout(()=>{k?.focus(),k?.setSelectionRange(k.value.length,k.value.length)},150)}async function La(e){if(e?.preventDefault(),!F.id){y(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!k)return;const t=k.value.trim();if(!t){y(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),k.focus();return}q&&q.classList.remove("is-invalid");const n=q?ka(q.value,F.repairCost):{provided:!1,value:null,error:null};if(n.error){y(c("maintenance.toast.invalidRepairCost","⚠️ يرجى إدخال قيمة رقمية صحيحة لتكلفة الإصلاح"),"error"),q?.classList.add("is-invalid"),q?.focus();return}Ee(!0),(await Jt(F.id,t,{repairCost:n.value,repairCostProvided:n.provided,mode:F.mode,resolvedAt:F.resolvedAt})).success?rt?.hide():Ee(!1)}function Ca(e){const t=document.getElementById("maintenance-stats");if(!t)return;const n=e.length,a=e.filter(u=>u.status==="open").length,o=n-a,i=u=>f(String(u)),r=c("maintenance.stats.summaryTitle","ملخص الصيانة"),s=c("maintenance.filters.status.open","قيد الصيانة"),d=c("maintenance.filters.status.closed","مغلقة"),p=c("maintenance.stats.totalLabel","إجمالي التذاكر"),m=(u,b,g)=>`
    <div class="maintenance-summary__item maintenance-summary__item--${g}">
      <span class="maintenance-summary__value">${i(u)}</span>
      <span class="maintenance-summary__label">${b}</span>
    </div>
  `;t.innerHTML=`
    <section class="maintenance-summary" aria-labelledby="maintenance-summary-title">
      <header class="maintenance-summary__header">
        <span class="maintenance-summary__icon" aria-hidden="true">🛠️</span>
        <h4 id="maintenance-summary-title" class="maintenance-summary__title">${r}</h4>
      </header>
      <div class="maintenance-summary__items">
        ${m(a,s,"open")}
        ${m(o,d,"closed")}
        ${m(n,p,"total")}
      </div>
    </section>
  `}function Ba(e){const n=String(e?.statusRaw??e?.status??"open").toLowerCase().replace(/[^a-z0-9_\-\s]/g,"").replace(/[\s]+/g,"_")||"open",a=Dt(n)||"open",o={open:{key:"maintenance.status.open",fallback:"قيد الصيانة",className:"maintenance-status-tag--open"},in_progress:{key:"maintenance.status.inProgress",fallback:"قيد التنفيذ",className:"maintenance-status-tag--in-progress"},completed:{key:"maintenance.status.completed",fallback:"مكتملة",className:"maintenance-status-tag--completed"},cancelled:{key:"maintenance.status.cancelled",fallback:"ملغاة",className:"maintenance-status-tag--cancelled"}},i=o[a]??o.open,r=i?c(i.key,i.fallback):c("maintenance.status.open","قيد الصيانة"),s=e?.statusLabel&&String(e.statusLabel).trim()?String(e.statusLabel).trim():r,d=["maintenance-status-badge","maintenance-status-tag"];return i?.className&&d.push(i.className),d.push(`maintenance-status-tag--${a}`),d.push(`maintenance-status-tag--${n}`),`<span class="${d.filter(Boolean).join(" ")}">${s}</span>`}function $a(e){const t=document.getElementById("maintenance-table-body"),n=document.getElementById("maintenance-empty-state");if(t){if(!e||e.length===0){const a=c("maintenance.empty.title","لا توجد تذاكر صيانة"),o=c("maintenance.empty.subtitle","عند إنشاء تذكرة جديدة ستظهر في هذه القائمة.");t.innerHTML=`
      <tr>
        <td colspan="6" class="maintenance-empty-row">
          <div class="maintenance-empty-icon">✅</div>
          <h5>${a}</h5>
          <p>${o}</p>
        </td>
      </tr>
    `,n&&n.classList.add("active");return}n&&n.classList.remove("active"),t.innerHTML=e.map(a=>{const o=Ba(a),i=a.status==="open"?"maintenance-row maintenance-row--open":"maintenance-row maintenance-row--closed",r=(()=>{const z=c("maintenance.priority.high","مرتفعة"),T=c("maintenance.priority.medium","متوسطة"),Ae=c("maintenance.priority.low","منخفضة");switch(a.priority){case"high":return`<span class="maintenance-priority-badge maintenance-priority-badge--high">${z}</span>`;case"low":return`<span class="maintenance-priority-badge maintenance-priority-badge--low">${Ae}</span>`;default:return`<span class="maintenance-priority-badge maintenance-priority-badge--medium">${T}</span>`}})(),s=[],d=c("maintenance.actions.close","🔧 إغلاق بعد الإصلاح"),p=c("maintenance.actions.view","👁️ عرض التقرير"),m=c("maintenance.actions.delete","🗑️ حذف التذكرة");a.status==="open"?s.push(`<button type="button" class="maintenance-action-btn" data-action="close" data-id="${a.id}">${d}</button>`):s.push(`<button type="button" class="maintenance-action-btn" data-action="view" data-id="${a.id}">${p}</button>`),Ie()&&s.push(`<button type="button" class="maintenance-action-btn maintenance-action-btn--delete" data-action="delete" data-id="${a.id}">${m}</button>`);const u=s.join(""),b=c("maintenance.table.noBarcode","بدون باركود"),g=c("maintenance.report.none","—"),h=a.equipmentBarcode?f(a.equipmentBarcode):b,S=a.issue?f(a.issue):g,A=a.repairCost!=null?Number.parseFloat(f(String(a.repairCost))):null,N=a.status==="closed"&&Number.isFinite(A)?`<div class="maintenance-repair-cost">${E(c("maintenance.table.repairCost","💰 تكلفة الإصلاح: {amount}").replace("{amount}",f(A.toFixed(2))))}</div>`:"",$=a.createdAt?f(Ye(a.createdAt)||me(a.createdAt)):"—";return`
        <tr class="${i}">
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${h}</small>
          </td>
          <td class="maintenance-issue-text">${S}${N}</td>
          <td>${r}</td>
          <td>${$}</td>
          <td>${o}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${u}
            </div>
          </td>
        </tr>
      `}).join("")}}function Ma(e){if(!se||re){y(c("maintenance.toast.loading","⏳ يتم تحديث بيانات الصيانة، يرجى الانتظار لحظة..."));return}const t=e.target.closest("button[data-action]");if(!t)return;const n=t.getAttribute("data-action"),a=Number(t.getAttribute("data-id"));if(a){if(n==="close")Kt(a);else if(n==="view")Ra(a);else if(n==="delete"){if(!Ie()){nt();return}Na(a).catch(o=>{console.error("❌ [maintenance] deleteTicket failed",o)})}}}async function Jt(e,t,n={}){const a=zt(e);if(!a)return y(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة")),{success:!1};const o=(t??"").trim();if(!o)return y(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),{success:!1};const i=n?.mode==="edit"&&n?.resolvedAt?n.resolvedAt:Aa(new Date)||new Date().toISOString(),r={equipment_id:a.equipmentId,technician_id:a.technicianId??null,priority:a.priority??"medium",status:"completed",notes:a.issue??"",reported_at:a.reportedAt??null,scheduled_at:a.scheduledAt??null,resolution_report:o,resolved_at:i};n?.repairCostProvided&&(r.repair_cost=n.repairCost!=null?Math.round(n.repairCost*100)/100:null);try{await fa(e,r),await Se({showToastOnError:!1});const s=document.getElementById("maintenance-status-filter");return s&&s.value==="open"&&(s.value="all"),await Me(),x(),y(c("maintenance.toast.ticketClosed","✅ تم إغلاق تذكرة الصيانة وإعادة المعدة إلى الحالة المتاحة")),{success:!0}}catch(s){if(console.error("❌ [maintenance] closeTicket failed",s),he(s)&&s.status===404)return await Se({showToastOnError:!1}),await Me(),x(),y(c("maintenance.toast.ticketAlreadyClosed","✅ تم تحديث التذاكر، ويبدو أن هذه التذكرة مغلقة مسبقاً"),"info"),{success:!0};const d=he(s)?s.message:c("maintenance.toast.updateError","⚠️ تعذر إغلاق تذكرة الصيانة. حاول مرة أخرى");return y(d,"error"),{success:!1,error:s}}}function Ra(e){const n=Q().find(T=>Number(T.id)===Number(e));if(!n)return;if(n.id,!Yt()){const T=c("maintenance.report.equipment","المعدة"),Ae=c("maintenance.report.barcode","الباركود"),ae=c("maintenance.report.issue","الوصف"),Te=c("maintenance.report.createdAt","تاريخ الإنشاء"),v=c("maintenance.report.closedAt","تاريخ الإغلاق"),j=c("maintenance.report.summary","التقرير"),D=c("maintenance.report.repairCost","تكلفة الإصلاح"),sn=c("maintenance.report.currencyLabel","ريال"),mt=Number.parseFloat(f(String(n.repairCost??""))),on=Number.isFinite(mt)?`${f(mt.toFixed(2))} ${sn}`:de,cn=c("maintenance.report.notAvailable","غير متوفر"),de=c("maintenance.report.none","—"),ln=[`${T}: ${n.equipmentDesc}`,`${Ae}: ${n.equipmentBarcode?f(n.equipmentBarcode):cn}`,`${ae}: ${n.issue?f(n.issue):de}`,`${Te}: ${n.createdAt?f(Ye(n.createdAt)||me(n.createdAt)):de}`,`${v}: ${n.resolvedAt?f(me(n.resolvedAt)):de}`,`${D}: ${on}`,`${j}: ${n.resolutionReport?f(n.resolutionReport):de}`].join(`
`);alert(ln);return}const a=c("maintenance.report.equipment","المعدة"),o=c("maintenance.report.barcode","الباركود"),i=c("maintenance.report.issue","الوصف"),r=c("maintenance.report.createdAt","تاريخ الإنشاء"),s=c("maintenance.report.closedAt","تاريخ الإغلاق"),d=c("maintenance.report.repairCost","تكلفة الإصلاح"),p=c("maintenance.report.summary","التقرير"),m=c("maintenance.report.notAvailable","غير متوفر"),u=c("maintenance.report.none","—"),b=Number.parseFloat(f(String(n.repairCost??""))),g=Number.isFinite(b)?f(b.toFixed(2)):null,h=c("maintenance.report.currencyLabel","ريال"),S=[{label:a,value:`<span class="maintenance-report-modal__value">${E(n.equipmentDesc||u)}</span>`},{label:o,value:n.equipmentBarcode?`<span class="maintenance-report-modal__value">${E(f(n.equipmentBarcode))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${E(m)}</span>`},{label:i,value:n.issue?`<span class="maintenance-report-modal__value">${E(f(n.issue))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${E(u)}</span>`},{label:r,value:n.createdAt?`<span class="maintenance-report-modal__value">${E(f(Ye(n.createdAt)||me(n.createdAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${E(u)}</span>`},{label:s,value:n.resolvedAt?`<span class="maintenance-report-modal__value">${E(f(me(n.resolvedAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${E(u)}</span>`},{label:d,value:g?`<span class="maintenance-report-modal__value">${E(g)} ${E(h)}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${E(u)}</span>`}],A=n.resolutionReport?f(n.resolutionReport):"",N=A?`<p>${E(A).replace(/\r?\n/g,"<br>")}</p>`:`<p class="maintenance-report-modal__value maintenance-report-modal__value--muted">${E(u)}</p>`,$=S.map(T=>`
      <div class="maintenance-report-modal__item">
        <span class="maintenance-report-modal__label">${E(T.label)}</span>
        ${T.value}
      </div>
    `).join(""),z=`
    <div class="maintenance-report-modal__summary">
      <h6>${E(p)}</h6>
      ${N}
    </div>
  `;if(ce&&(ce.innerHTML=`
      <div class="maintenance-report-modal__details">
        <div class="maintenance-report-modal__grid">
          ${$}
        </div>
        ${z}
      </div>
    `),I){const T=Ie()&&n.status==="closed";I.hidden=!T,I.disabled=!T,I.textContent=c("maintenance.actions.editClosed","✏️ تعديل بيانات الإغلاق"),T?I.dataset.id=String(n.id):delete I.dataset.id}ye?.show()}function Fa(){if(!I)return;const e=Number(I.dataset.id);if(!e){ye?.hide();return}if(!Ie()){ye?.hide(),nt();return}ye?.hide(),setTimeout(()=>{Kt(e,{mode:"edit"})},220)}async function Na(e){if(!Ie()){nt();return}if(!Q().find(a=>Number(a.id)===Number(e))){y(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(confirm(c("maintenance.toast.ticketDeleteConfirm","⚠️ هل أنت متأكد من حذف تذكرة الصيانة؟")))try{await ba(e),await Se({showToastOnError:!1}),await Me(),y(c("maintenance.toast.ticketDeleted","🗑️ تم حذف تذكرة الصيانة"))}catch(a){console.error("❌ [maintenance] deleteTicket failed",a);const o=he(a)?a.message:c("maintenance.toast.deleteError","⚠️ تعذر حذف تذكرة الصيانة. حاول مرة أخرى");y(o,"error")}}async function Da(e){e.preventDefault();try{const t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),o=document.getElementById("maintenance-issue"),i=document.getElementById("maintenance-priority");let r=be,s=H(a?.value);if(!r&&s&&(r=xe(s)),!r&&t?.value&&Vt(t.value,{showFeedback:!0})&&(r=be,s=H(r?.barcode)),!r&&n?.value&&Ut(n.value,{showFeedback:!0})&&(r=be,s=H(r?.barcode)),!r||!s){y(c("maintenance.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const{equipment:d=[]}=P();let p=(d||[]).find(A=>H(A?.barcode)===s);if(!p&&r&&(p={id:r.id,barcode:r.barcode,desc:r.desc,name:r.desc,status:r.status||"متاح",quantity:r.quantity,qty:r.quantity}),!p||p.id==null){y(c("maintenance.toast.selectedNotFound","❌ لم يتم العثور على المعدة المختارة")),K();return}const m=Number.parseInt(p.qty??p.quantity??r?.quantity??1,10),u=Number.isFinite(m)&&m>0?m:1,b=Ot(s);if(jt(p.status||r?.status)==="maintenance"&&u<=1){y(c("maintenance.toast.equipmentAlreadyMaintenance","⚠️ هذه المعدة بالفعل في حالة صيانة"));return}if(b>=u){y(c("maintenance.toast.noUnitsAvailable","⚠️ لا توجد وحدات متاحة للصيانة لهذه المعدة حالياً"));return}const h=ga({equipmentId:p.id,technicianId:null,issue:o?.value.trim()||"",priority:i?.value||"medium",status:"open",scheduledAt:null,resolutionReport:null});await pa(h),await Se({showToastOnError:!1}),await Me(),y(c("maintenance.toast.ticketCreated","🛠️ تم إنشاء تذكرة الصيانة وإيقاف المعدة")),K(),o&&(o.value=""),i&&(i.value="medium");const S=document.getElementById("maintenance-status-filter");S&&(S.value="all")}catch(t){console.error("❌ [maintenance] Failed to create ticket",t);const n=he(t)?t.message:c("maintenance.toast.submitError","⚠️ تعذر إنشاء تذكرة الصيانة. يرجى المحاولة مجدداً.");y(n,"error")}}function xa(e){const t=Q();return e==="all"?t:t.filter(n=>n.status===e)}function x(){const e=Q();lt(),Ca(e);const t=document.getElementById("maintenance-status-filter");t&&!t.value&&(t.value="all");const n=t?.value||"all",a=document.getElementById("maintenance-table-body"),o=document.getElementById("maintenance-empty-state");if(!a)return;if(re&&!se){const r=c("maintenance.table.loading","جاري التحميل...");a.innerHTML=`<tr><td colspan="6" class="text-center text-muted">${r}</td></tr>`,o&&o.classList.remove("active");return}if(ge&&!se){a.innerHTML=`<tr><td colspan="6" class="text-center text-danger">${ge}</td></tr>`,o&&o.classList.remove("active");return}const i=xa(n);$a(i)}function Pa(){Q(),lt(),se=ne.length>0,re=!1,x(),Se({showToastOnError:!1}),Wt()&&Qt(),Yt()&&Gt();const e=document.getElementById("maintenance-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",a=>{Da(a).catch(o=>{console.error("❌ [maintenance] submit handler failed",o)})}),e.dataset.listenerAttached="true");const t=document.getElementById("maintenance-status-filter");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{x()}),t.dataset.listenerAttached="true");const n=document.querySelector(".maintenance-table");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Ma),n.dataset.listenerAttached="true")}Q();document.addEventListener("language:changed",()=>{const e=document.getElementById("maintenance-selected-barcode"),t=document.getElementById("maintenance-selected-info");if(e?.value){const n=xe(e.value);n?Ht(n):t&&(t.textContent=Ge())}else t&&(t.textContent=Ge());x(),Ee(!1)});document.addEventListener(un.USER_UPDATED,()=>{x()});window.addEventListener("maintenance:updated",()=>{ne=Ne(),x()});const Je="__ART_RATIO_LAST_DASHBOARD_TAB__",O="__ART_RATIO_LAST_DASHBOARD_SUB_TAB__",Re="create-tab",Xt=/^[a-z0-9\-]+$/i;function Xe(e){if(!(!e||typeof e.scrollIntoView!="function"))try{const t=e.closest("[data-tab-scroll-track]");if(!t)return;const n={behavior:"smooth",block:"nearest",inline:"center"};e.scrollIntoView(n);const a=t.closest("[data-tab-scroll]");a&&window.requestAnimationFrame(()=>{a.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0}))})}catch(t){console.warn("⚠️ [tabs.js] Failed to keep tab visible",t)}}function J(e){try{if(typeof window>"u"||!window.localStorage)return null;const t=window.localStorage.getItem(e);return!t||!Xt.test(t)?null:t}catch(t){return console.warn("⚠️ [tabs.js] Failed to read stored tab",t),null}}function Ze(e,t){try{if(typeof window>"u"||!window.localStorage)return;if(!t||!Xt.test(t)){window.localStorage.removeItem(e);return}window.localStorage.setItem(e,t)}catch(n){console.warn("⚠️ [tabs.js] Failed to persist tab",n)}}function Zt(e){try{if(typeof window>"u"||!window.localStorage)return;window.localStorage.removeItem(e)}catch(t){console.warn("⚠️ [tabs.js] Failed to clear stored tab",t)}}let Y=null,M=null,X=!1,C=null,Et=null,Z=null,et=null,ie=null,ke=null;function za(){return ke||(ke=Lt(()=>import("./reports.js"),__vite__mapDeps([0,1,2,3,4,5,6,7]),import.meta.url).then(e=>{try{typeof e.initReports=="function"&&e.initReports()}catch(t){console.error("❌ [tabs.js] Failed to initialise reports module",t)}return e}).catch(e=>{throw console.error("❌ [tabs.js] Failed to load reports module",e),ke=null,e})),ke}function ja(){console.log("🚀 [tabs.js] setupTabs()");const e=Array.from(document.querySelectorAll("[data-tab]")),t=document.querySelectorAll(".tab-content-wrapper > .tab");console.log("📌 tabButtons:",e),console.log("📌 tabContents:",t);const n=(i,{skipStore:r=!1,skipRender:s=!1}={})=>{if(!i)return;const d=e.filter(m=>m?.getAttribute("data-tab")===i),p=document.getElementById(i);if(!(!d.length||!p)&&(e.forEach(m=>{const u=m?.getAttribute("data-tab")===i;m.classList.toggle("active",u),u?(m.setAttribute("aria-selected","true"),m.setAttribute("tabindex","0"),Xe(m)):(m.setAttribute("aria-selected","false"),m.setAttribute("tabindex","-1"))}),t.forEach(m=>{const u=m.id===i;m.style.display=u?"block":"none",m.classList.toggle("active",u)}),Y=i,Ze(Je,i),typeof document<"u"&&document.dispatchEvent(new CustomEvent("dashboard:tabChanged",{detail:{tabId:i}})),r||fe({dashboardTab:i}).catch(m=>{console.warn("⚠️ [tabs.js] Failed to store dashboard tab preference",m)}),i!=="reservations-tab"&&(M=null,C=null,Zt(O),r||fe({dashboardSubTab:null}).catch(m=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",m)})),!s&&i==="customers-tab"&&(console.log("👤 Rendering customers"),hn()),!s&&i==="equipment-tab"&&(console.log("📦 Rendering equipment"),at()),!s&&i==="maintenance-tab"&&(console.log("🛠️ Rendering maintenance"),x()),!s&&i==="technicians-tab"&&(console.log("🛠️ Rendering technicians"),Vn()),i==="reservations-tab")){if(console.log("📅 Rendering reservations"),s||ve(),!C){const m=J(O);C=M||m||Re}Oa(),C&&(Le(C),C=null)}};et=n,e.forEach(i=>{i&&(i.getAttribute("type")||i.setAttribute("type","button"),i.setAttribute("role","tab"),i.hasAttribute("tabindex")||i.setAttribute("tabindex",i.classList.contains("active")?"0":"-1"),i.addEventListener("click",()=>{const r=i.getAttribute("data-tab");if(console.log("🖱️ Tab clicked:",r),n(r),r==="reservations-tab"){const s=M||J(O)||Re;typeof Z=="function"?Z(s):C=s}else fe({dashboardSubTab:null}).catch(s=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",s)})}))});const a=i=>{const r=document.querySelector("[data-tab].active"),s=J(Je),d=e[0]?.getAttribute("data-tab")||null,m=[i?.dashboardTab,s,Y,r?.getAttribute("data-tab"),d].filter(Boolean).find(g=>document.getElementById(g))||d;m&&(!X||m!==Y)&&(console.log("⭐ Initial tab:",m),n(m,{skipStore:!0}));const b=[i?.dashboardSubTab,J(O)].filter(Boolean).find(g=>document.getElementById(g));b&&(Y==="reservations-tab"&&typeof Z=="function"?(!X||b!==M)&&Z(b,{skipStore:!0}):C=b),X||(document.body?.classList.remove("tabs-loading"),document.body?.classList.remove("no-js"),X=!0)},o=typeof $e=="function"?$e():null;a(o||null),mn().then(i=>a(i||null)).catch(i=>{console.warn("⚠️ [tabs.js] Failed to load tab preferences",i),a(null)}),Et||(Et=pn(i=>{if(!(!X||!i))if(i.dashboardTab&&i.dashboardTab!==Y&&n(i.dashboardTab,{skipStore:!0}),Y==="reservations-tab"){if(i.dashboardSubTab&&i.dashboardSubTab!==M)Le(i.dashboardSubTab);else if(!i.dashboardSubTab&&M){const r=J(O);r?r!==M&&Le(r):Le(null)}}else i.dashboardSubTab&&(C=i.dashboardSubTab)}))}function Oa(){console.log("🚀 [tabs.js] setupSubTabs()");const e=document.querySelectorAll("#reservations-tab .sub-tab-button"),t=document.querySelectorAll("#reservations-tab .sub-tab");if(console.log("📌 subTabButtons:",e),console.log("📌 subTabContents:",t),!e.length){console.warn("⚠️ [tabs.js] No reservation sub-tab buttons found");return}const n=Array.from(e).map(i=>i?.getAttribute("data-sub-tab")).filter(i=>typeof i=="string"&&i.trim().length>0),a=()=>n.length?n.includes(Re)?Re:n[0]:null,o=(i,{skipStore:r=!1}={})=>{if(!n.length)return;let s=i;(!s||!n.includes(s))&&(console.warn("⚠️ [tabs.js] Invalid sub-tab target, falling back to first available",{requested:s,available:n}),s=a());const d=document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${s}"]`),p=document.getElementById(s);if(!d||!p){console.warn("⚠️ [tabs.js] Unable to locate sub-tab button/content after fallback",{target:s});return}if(M===s&&d.classList.contains("active")&&p.classList.contains("active")&&p.getAttribute("aria-hidden")==="false"){p.removeAttribute("hidden"),p.style.display="block",p.setAttribute("aria-hidden","false"),M=s,Xe(d),r||(Ze(O,s),fe({dashboardSubTab:s}).catch(u=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",u)}));return}e.forEach(u=>{u.classList.remove("active"),u.classList.contains("tab")&&u.classList.remove("tab-active"),u.setAttribute("aria-selected","false"),u.setAttribute("tabindex","-1")}),d.classList.add("active"),d.classList.contains("tab")&&d.classList.add("tab-active"),d.setAttribute("aria-selected","true"),d.setAttribute("tabindex","0"),Xe(d),t.forEach(u=>{const b=u.id===s;u.classList.toggle("active",b),u.setAttribute("aria-hidden",b?"false":"true"),b?(u.removeAttribute("hidden"),u.style.display="block"):(u.setAttribute("hidden",""),u.style.display="none")}),M=s,Ze(O,s),r||fe({dashboardSubTab:s}).catch(u=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",u)}),typeof document<"u"&&document.dispatchEvent(new CustomEvent("reservations:subTabChanged",{detail:{subTabId:s}})),s==="my-reservations-tab"?(console.log("📋 Rendering reservations list"),setTimeout(()=>{ve()},50)):s==="calendar-tab"?(console.log("📅 Rendering calendar view"),setTimeout(()=>{Fe()},100)):s==="reports-tab"&&(console.log("📊 Rendering reports view"),za().then(u=>{const{renderReports:b}=u;setTimeout(()=>{try{b?.()}catch(g){console.error("❌ [tabs.js] Failed to render reports tab",g)}},50)}).catch(u=>{console.error("❌ [tabs.js] Unable to load reports tab",u)}))};if(Z=(i,r={})=>{i?o(i,r):(e.forEach(s=>{s.classList.remove("active"),s.classList.contains("tab")&&s.classList.remove("tab-active"),s.setAttribute("aria-selected","false"),s.setAttribute("tabindex","-1")}),t.forEach(s=>{s.classList.remove("active"),s.setAttribute("aria-hidden","true"),s.setAttribute("hidden",""),s.style.display="none"}),M=null,Zt(O))},e.forEach(i=>{i.dataset.subTabListenerAttached||(i.addEventListener("click",()=>{const r=i.getAttribute("data-sub-tab");console.log("🖱️ Sub-tab clicked:",r),o(r)}),i.dataset.subTabListenerAttached="true")}),C)o(C,{skipStore:!0}),C=null;else{const i=document.querySelector("#reservations-tab .sub-tab-button.active"),r=a(),s=i?.getAttribute("data-sub-tab")||r;s&&(console.log("⭐ Initial sub-tab:",s),o(s,{skipStore:!0}))}Ct()}function Le(e){typeof Z=="function"?Z(e,{skipStore:!0}):e&&(C=e)}function Ha(){try{if(typeof $e=="function")return $e()||{}}catch(e){console.warn("⚠️ [tabs.js] Failed to read cached preferences",e)}return{}}function Va({attemptsLeft:e=0}={}){if(!X||typeof et!="function")return!1;const t=Ha(),n=Array.from(document.querySelectorAll("[data-tab]"));if(!n.length)return!1;const a=n[0]?.dataset.tab||null,i=[Y,document.querySelector("[data-tab].active")?.getAttribute("data-tab")||null,t.dashboardTab,J(Je),a].filter(Boolean).find(s=>document.getElementById(s));if(!i)return!1;const r=()=>{const s=document.querySelector(`[data-tab].active[data-tab="${i}"]`),d=document.getElementById(i);return!!(s&&d?.classList.contains("active")&&d?.style.display!=="none")};if(i==="reservations-tab"){const s=Array.from(document.querySelectorAll("#reservations-tab .sub-tab-button"));if(!s.length)return!1;const d=s[0]?.getAttribute("data-sub-tab")||null,m=[M,document.querySelector("#reservations-tab .sub-tab-button.active")?.getAttribute("data-sub-tab")||null,document.querySelector("#reservations-tab .sub-tab.active")?.id||null,t.dashboardSubTab,J(O),d].filter(Boolean).find(h=>document.getElementById(h)),u=document.querySelector("#reservations-tab .sub-tab-button.active"),b=document.querySelector("#reservations-tab .sub-tab.active"),g=b?.id||u?.getAttribute("data-sub-tab")||null;if(m&&g===m&&r())return b&&(b.removeAttribute("hidden"),b.style.display="block",b.setAttribute("aria-hidden","false")),!0;if(m)C=m;else if(e>0)return!1}else if(r())return!0;return et(i,{skipStore:!0,skipRender:!0}),!0}function dt(){if(!X)return;let e=0;const t=5;ie&&(clearTimeout(ie),ie=null);const n=()=>{if(Va({attemptsLeft:t-e})){ie=null;return}if(e>=t){ie=null;return}e+=1,ie=setTimeout(n,50*(e+1))};n()}document.addEventListener("language:translationsReady",dt);document.addEventListener("language:changed",dt);document.addEventListener("theme:changed",dt);let L=[],R=[],qe=null,U=!1,qt=!1;const l={};function Ua(){l.form=document.getElementById("equipment-package-form"),l.hiddenId=document.getElementById("equipment-package-id"),l.nameInput=document.getElementById("equipment-package-name"),l.codeInput=document.getElementById("equipment-package-code"),l.priceInput=document.getElementById("equipment-package-price"),l.descriptionInput=document.getElementById("equipment-package-description"),l.openSelector=document.getElementById("equipment-package-open-selector"),l.selectionWrapper=document.getElementById("equipment-package-selection-active"),l.selectionCounter=document.getElementById("equipment-package-selection-counter"),l.applySelection=document.getElementById("equipment-package-apply-selection"),l.cancelSelection=document.getElementById("equipment-package-cancel-selection"),l.itemsTableBody=document.querySelector("#equipment-package-items-table tbody"),l.itemsEmptyMessage=document.getElementById("equipment-package-items-empty"),l.resetButton=document.getElementById("equipment-package-reset"),l.submitButton=document.getElementById("equipment-package-submit"),l.tableBody=document.getElementById("equipment-packages-table-body"),l.emptyRow=document.getElementById("equipment-packages-empty-row"),l.countBadge=document.getElementById("equipment-packages-count"),l.applySelection&&(l.applySelection.style.display="none")}function en(){const{equipment:e=[]}=P()||{};return Array.isArray(e)?e:[]}function ut(){const e=new Map;return en().forEach(t=>{const n=t?.id??t?.equipment_id??t?.equipmentId??null;n!=null&&e.set(String(n),t)}),e}function Wa(){const e=new Map;return en().forEach(t=>{const n=kt(t?.barcode);n&&!e.has(n)&&e.set(n,t)}),e}function le(e,{persist:t=!1}={}){L=Array.isArray(e)?e.map(tn):[],Za(),t&&(At({packages:L}),document.dispatchEvent(new CustomEvent("packages:changed",{detail:{packages:L}})))}function tn(e={}){const t=Qa(e.items??e.equipment_ids??e.equipmentIds??[]);return{id:e.id!=null?String(e.id):"",package_code:e.package_code??e.code??e.slug??"",slug:e.slug??null,name:e.name??e.title??e.label??"",description:e.description??"",price:Ya(e.price??e.total_price??e.package_price??0),is_active:Ga(e.is_active??e.active??!0),items:t,created_at:e.created_at??null,updated_at:e.updated_at??null}}function Qa(e){return Array.isArray(e)||(e=[]),e.map(t=>{if(t==null)return null;if(typeof t=="number"||typeof t=="string"){const n=String(t).trim();return n?{equipment_id:n,quantity:1,unit_price:null}:null}if(typeof t=="object"){const n=t.equipment_id??t.equipmentId??t.id??t.item_id??t.itemId??null;if(n==null)return null;const a=Number.isFinite(Number(t.quantity??t.qty))?Number(t.quantity??t.qty):1,o=Number.isFinite(Number(t.unit_price??t.price))?Number(t.unit_price??t.price):null;return{equipment_id:String(n),quantity:a>0?a:1,unit_price:o}}return null}).filter(Boolean)}function Ya(e){const t=Number.parseFloat(e);return Number.isFinite(t)?Math.round(t*100)/100:0}function Ga(e){if(e===!0||e===!1)return e;if(e==null)return!0;const t=String(e).trim().toLowerCase();return!(t==="0"||t==="false"||t==="no")}function Ka(e){const t=e?.quantity??e?.qty??1,n=Number.parseFloat(f(String(t)));return!Number.isFinite(n)||n<=0?1:n}function Ja(e,t){const n=[e?.unit_price,e?.price];for(const o of n){if(o==null)continue;const i=Number.parseFloat(f(String(o)));if(Number.isFinite(i))return i}const a=e?.equipment_id??e?.equipmentId??e?.id;if(a!=null&&t instanceof Map){const o=t.get(String(a));if(o&&typeof o=="object"){const i=[o.unit_price,o.unitPrice,o.price,o.daily_rate,o.dailyRate];for(const r of i){if(r==null)continue;const s=Number.parseFloat(f(String(r)));if(Number.isFinite(s))return s}}}return 0}function Xa(e=null){const t=e instanceof Map?e:ut();return R.reduce((n,a)=>{const o=Ka(a),i=Ja(a,t),r=Number.isFinite(o)&&o>0?o:1,s=Number.isFinite(i)&&i>0?i:0;return n+r*s},0)}function It(e){const t=l.priceInput;if(!t)return;const n=t.dataset.autoCalculated==="false",a=!!(t.value&&t.value.trim());if(n&&a)return;if(!Number.isFinite(e)||R.length===0){t.value="",t.dataset.autoCalculated="true";return}const o=e<0?0:e,i=Math.round(o*100)/100,r=Number.isInteger(i)?String(i):i.toFixed(2);t.value=r,t.dataset.autoCalculated="true"}function _e(){if(!l.itemsTableBody||!l.itemsEmptyMessage)return;if(R.length===0){l.itemsTableBody.innerHTML="",l.itemsEmptyMessage.hidden=!1,It(0);return}const e=ut(),t=R.map((a,o)=>{const i=e.get(String(a.equipment_id)),r=i?.desc||i?.name||c("equipment.packages.items.unknown","معدة بدون اسم"),s=i?.barcode?f(String(i.barcode)):"",d=f(String(a.quantity??1)),p=s?`${r} — ${s}`:r;return`
      <tr data-package-item-index="${o}">
        <td>${p}</td>
        <td>${d}</td>
        <td>
          <button type="button" class="btn btn-outline-danger btn-sm" data-action="remove-item" data-index="${o}">🗑️</button>
        </td>
      </tr>
    `});l.itemsTableBody.innerHTML=t.join(""),l.itemsEmptyMessage.hidden=!0;const n=Xa(e);It(n)}function Za(){if(!l.tableBody||!l.emptyRow)return;if(!L.length){l.tableBody.innerHTML="",l.tableBody.appendChild(l.emptyRow),l.emptyRow.hidden=!1,l.countBadge&&(l.countBadge.textContent="0");return}const e=ut(),t=L.map(n=>{const a=Un({...n,items:n.items}),o=a.map(s=>{const d=e.get(String(s.equipmentId??s.equipment_id)),p=d?.desc||d?.name||s.desc||c("equipment.packages.items.unknown","معدة بدون اسم"),m=f(String(s.qty??s.quantity??1)),u=s.barcode||d?.barcode,b=u?` (${f(String(u))})`:"";return`<li>${p}${b} × ${m}</li>`}),i=a.reduce((s,d)=>s+(Number(d.qty??d.quantity??1)||0),0),r=`${f(n.price.toFixed(2))} ${c("reservations.create.summary.currency","SR")}`;return`
      <tr data-package-id="${n.id}">
        <td>${n.name||"—"}</td>
        <td>${n.package_code||"—"}</td>
        <td>${r}</td>
        <td>
          <details>
            <summary>${f(String(i||0))}</summary>
            <ul class="equipment-package-items-summary">${o.join("")}</ul>
          </details>
        </td>
        <td>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-primary" data-action="edit-package" data-id="${n.id}">✏️</button>
            <button type="button" class="btn btn-sm btn-outline-danger" data-action="delete-package" data-id="${n.id}">🗑️</button>
          </div>
        </td>
      </tr>
    `});l.tableBody.innerHTML=t.join(""),l.emptyRow.hidden=!0,l.countBadge&&(l.countBadge.textContent=f(String(L.length)))}function nn(){qe=null,R=[],l.hiddenId&&(l.hiddenId.value=""),l.nameInput&&(l.nameInput.value=""),l.codeInput&&(l.codeInput.value=""),l.priceInput&&(l.priceInput.value="",l.priceInput.dataset.autoCalculated="true"),l.descriptionInput&&(l.descriptionInput.value=""),l.submitButton&&(l.submitButton.textContent=c("equipment.packages.form.actions.save","💾 حفظ الحزمة")),_e(),V(!1)}function ei(e){qe=e.id||null,R=e.items.map(t=>({...t})),l.hiddenId&&(l.hiddenId.value=qe||""),l.nameInput&&(l.nameInput.value=e.name||""),l.codeInput&&(l.codeInput.value=e.package_code||""),l.priceInput&&(l.priceInput.value=e.price!=null?String(e.price):"",l.priceInput.dataset.autoCalculated=e.price!=null?"false":"true"),l.descriptionInput&&(l.descriptionInput.value=e.description||""),l.submitButton&&(l.submitButton.textContent=c("equipment.packages.form.actions.update","💾 تحديث الحزمة")),_e(),V(!1)}function V(e=U){U=e,l.selectionWrapper&&(U?l.selectionWrapper.hidden=!1:l.selectionWrapper.hidden=!0),l.openSelector&&(l.openSelector.disabled=U),l.cancelSelection&&(l.cancelSelection.disabled=!U),an()}function an(){if(l.selectionCounter){if(!U){l.selectionCounter.textContent=c("equipment.packages.selection.counter","لم يتم اختيار عناصر بعد.");return}l.selectionCounter.textContent=c("equipment.packages.selection.autoMode","أي معدة تختارها ستُضاف مباشرة إلى الحزمة. استخدم زر إلغاء للخروج من وضع الاختيار.")}}function ti(e){const t=e?.detail||{},n=!!t.active,a=t.selection||t.previous||{},o=a?.mode||a?.source||"";if(o!=="package-manager"&&o!=="equipment-packages"){!n&&U&&(V(!1),tt());return}if(n){V(!0);return}V(!1),tt()}function ni(e){const t=e?.detail;if(!t)return;const n=t.selection||{},a=n?.mode||n?.source||"";if(a!=="package-manager"&&a!=="equipment-packages")return;const o=Array.isArray(t.barcodes)?t.barcodes:[],i=Number.isInteger(t.quantity)&&t.quantity>0?t.quantity:1,r=o.length?o:t.barcode?[t.barcode]:[];if(!r.length)return;const s=Wa(),d=[],p=new Set;r.forEach(g=>{const h=kt(g);h&&!p.has(h)&&(p.add(h),d.push(h))});const m=Math.min(d.length,i);let u=0;const b=[];for(let g=0;g<m;g+=1){const h=d[g],S=s.get(h);if(!S)continue;const A=S?.id??S?.equipment_id??S?.equipmentId??null;if(A==null)continue;const N=S?.desc||S?.name||h,$=R.find(z=>z.equipment_id===String(A));$?$.quantity+=1:R.push({equipment_id:String(A),quantity:1,unit_price:Number.isFinite(Number(S?.price))?Number(S.price):null}),u+=1,b.push(N)}if(u>0){_e(),an();const g=u===1?c("equipment.packages.selection.itemAddedSingle","✅ تمت إضافة {name} إلى الحزمة"):c("equipment.packages.selection.itemAddedMulti","✅ تمت إضافة {count} معدات إلى الحزمة"),h=u===1?g.replace("{name}",b[0]||""):g.replace("{count}",f(String(u)));y(h)}else y(c("equipment.packages.selection.noMatch","⚠️ تعذر ربط المعدات المختارة بالحزم، تحقق من بيانات المعدات"),4e3)}function ai(){V(!1),Rn("package-cancel"),tt()}function tt(){l.form&&(l.form.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{l.nameInput?.focus()},200))}function Ve(e){const t=l.priceInput;if(!t)return;const n=t.value;if(n==null)return;const a=n.replace(/[\u066B\u066C\u060C،,]/gu,".");let i=f(a).replace(/[^0-9.]/gu,"");const r=i.indexOf(".");if(r!==-1){const s=i.slice(0,r+1),d=i.slice(r+1).replace(/\./g,"");i=`${s}${d}`}if(i!==n&&(t.value=i,typeof t.setSelectionRange=="function")){const s=i.length;try{t.setSelectionRange(s,s)}catch{}}e?.type==="input"&&(t.dataset.autoCalculated=i.trim()?"false":"true")}function ii(){const e=l.nameInput?.value.trim(),t=l.codeInput?.value.trim(),n=l.descriptionInput?.value.trim()??"",a=l.priceInput?.value??"",o=Number.parseFloat(f(a));if(!e)return y(c("equipment.packages.validation.nameRequired","⚠️ يرجى إدخال اسم الحزمة")),null;if(!t)return y(c("equipment.packages.validation.codeRequired","⚠️ يرجى إدخال كود الحزمة")),null;if(!R.length)return y(c("equipment.packages.validation.itemsRequired","⚠️ أضف عنصرًا واحدًا على الأقل للحزمة")),null;const i=R.map(r=>({equipment_id:r.equipment_id,quantity:Number.isFinite(Number(r.quantity))?Number(r.quantity):1,unit_price:r.unit_price!=null&&Number.isFinite(Number(r.unit_price))?Number(r.unit_price):null}));return{package_code:t,name:e,description:n,price:Number.isFinite(o)?o:0,is_active:!0,items:i}}async function ri(e){if(e.preventDefault(),!l.form)return;const t=ii();if(t)try{let n;qe?(n=await W(`/packages/?id=${encodeURIComponent(qe)}`,{method:"PATCH",body:t}),y(c("equipment.packages.toast.updated","✅ تم تحديث الحزمة بنجاح"))):(n=await W("/packages/",{method:"POST",body:t}),y(c("equipment.packages.toast.created","✅ تم إنشاء الحزمة بنجاح")));const a=tn(n?.data??n),o=L.findIndex(i=>i.id===a.id);o>=0?L.splice(o,1,a):L=[a,...L],le(L,{persist:!0}),nn()}catch(n){console.error("[equipmentPackagesManager] handlePackageSubmit error",n);const a=n?.message||c("equipment.packages.toast.saveFailed","❌ تعذر حفظ الحزمة");y(a,4e3)}}function si(e){const t=e.target.closest('[data-action="remove-item"]');if(!t)return;const n=Number(t.dataset.index);Number.isNaN(n)||(R=R.filter((a,o)=>o!==n),_e())}async function oi(e){const t=e.target.closest('[data-action="edit-package"]');if(t){const a=t.dataset.id;if(!a)return;const o=L.find(i=>i.id===a);if(!o)return;ei(o);return}const n=e.target.closest('[data-action="delete-package"]');if(n){const a=n.dataset.id;if(!a||!window.confirm(c("equipment.packages.confirm.delete","هل أنت متأكد من حذف الحزمة؟")))return;try{await W(`/packages/?id=${encodeURIComponent(a)}`,{method:"DELETE"}),L=L.filter(i=>i.id!==a),le(L,{persist:!0}),y(c("equipment.packages.toast.deleted","🗑️ تم حذف الحزمة بنجاح"))}catch(i){console.error("[equipmentPackagesManager] delete package error",i),y(c("equipment.packages.toast.deleteFailed","❌ تعذر حذف الحزمة"),4e3)}}}async function ci(){try{const e=await W("/packages/?all=1"),t=Array.isArray(e?.data)?e.data:Array.isArray(e)?e:[];le(t,{persist:!0})}catch(e){console.warn("[equipmentPackagesManager] Failed to fetch packages from API, falling back to cache",e);const{packages:t=[]}=P()||{};le(t,{persist:!1})}}function li(){const{packages:e=[]}=P()||{};Array.isArray(e)&&e.length?le(e,{persist:!1}):le([],{persist:!1}),_e(),V(!1)}function di(){if(U){V(!0);return}V(!0),Mn({mode:"package-manager",source:"equipment-packages",activatedAt:Date.now()});const e=document.querySelector('[data-tab="equipment-tab"]');e&&e.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.getElementById("search-equipment")?.focus();const t=document.getElementById("equipment-list");t&&t.scrollIntoView({behavior:"smooth",block:"start"})},200)})}function ui(){l.form&&(l.form.addEventListener("submit",ri),l.itemsTableBody?.addEventListener("click",si),l.resetButton?.addEventListener("click",()=>{nn()}),l.tableBody?.addEventListener("click",oi),l.openSelector?.addEventListener("click",e=>{e.preventDefault(),di()}),l.cancelSelection?.addEventListener("click",e=>{e.preventDefault(),ai()}),l.priceInput&&!l.priceInput.dataset.normalizedAttached&&(l.priceInput.addEventListener("input",Ve),l.priceInput.addEventListener("blur",Ve),l.priceInput.dataset.normalizedAttached="true",Ve()),qt||(document.addEventListener(pt.change,ti),document.addEventListener(pt.requestAdd,ni),qt=!0))}function mi(){typeof document>"u"||(Ua(),l.form&&(li(),ui(),ci()))}fn();let w=null,Ce=null,Be=null;function pi(){return Be||(Be=Lt(()=>import("./dashboardMetrics.js"),__vite__mapDeps([8,1,2]),import.meta.url).then(e=>{try{typeof e.initDashboardMetrics=="function"&&e.initDashboardMetrics()}catch(t){console.error("❌ Failed to initialise dashboard metrics",t)}return e}).catch(e=>{throw console.error("❌ Failed to load dashboard metrics module",e),Be=null,e})),Be}function fi(){const e=()=>{pi()};typeof window<"u"&&typeof window.requestIdleCallback=="function"?window.requestIdleCallback(()=>{e()},{timeout:1500}):setTimeout(e,0)}async function _t(){if(!await bn())return;vn(),ja(),gn(),at(),mi(),Fn(),Fe(),Pa(),await Xn(),fi();const t=document.getElementById("excel-upload");t&&t.addEventListener("change",async a=>{const o=a.target.files&&a.target.files[0];o&&(await Nn(o),a.target.value="")});const n=document.getElementById("excel-upload-trigger");n&&t&&n.addEventListener("click",a=>{a.preventDefault(),t.click()}),document.getElementById("logout-btn")?.addEventListener("click",yn),bi(),gi()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{_t().catch(e=>{console.error("❌ Failed to initialise app",e)})},{once:!0}):_t().catch(e=>{console.error("❌ Failed to initialise app",e)});function bi(){document.querySelectorAll('input[type="datetime-local"]').forEach(e=>{e.addEventListener("input",()=>{const t=e.value;if(!t.includes("T"))return;const[n,a]=t.split("T"),[o]=a.split(":"),i=`${o.padStart(2,"0")}:00`,r=`${n}T${i}`;e.value!==r&&(e.value=r,setTimeout(()=>e.blur(),150))})})}function gi(){const e=new URLSearchParams(window.location.search),t=e.get("reservationEditId"),n=e.get("reservationEditIndex");if(!t&&!n)return;w={reservationId:t,reservationIndex:n!=null?Number(n):null},rn(),e.delete("reservationEditId"),e.delete("reservationEditIndex");const a=e.toString(),o=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;window.history.replaceState({},document.title,o)}function yi(e){const t=document.getElementById(e);return!!(t?.classList.contains("active")&&t?.style.display!=="none")}function vi(e){return new Promise(t=>{if(yi(e)){t();return}const n=o=>{o?.detail?.tabId===e&&(document.removeEventListener("dashboard:tabChanged",n),t())};document.addEventListener("dashboard:tabChanged",n),document.querySelector(`[data-tab="${e}"]`)?.click()})}function hi(e){const t=document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${e}"]`),n=document.getElementById(e);return!!(t?.classList.contains("active")&&n?.classList.contains("active")&&n?.getAttribute("aria-hidden")==="false")}function Si(e){return new Promise(t=>{if(hi(e)){t();return}const n=o=>{o?.detail?.subTabId===e&&(document.removeEventListener("reservations:subTabChanged",n),t())};document.addEventListener("reservations:subTabChanged",n),document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${e}"]`)?.click()})}async function Ei(){const e=Dn("openReservationEditor");if(typeof e=="function")return e;const t=await xn("openReservationEditor");if(typeof t=="function")return t;throw new Error("Reservation editor handler is unavailable")}async function rn(){if(!w)return;if(Ce)return Ce;const e=(async()=>{const n=P().reservations||[];let a=null;if(w.reservationId){const s=n.findIndex(d=>String(d?.id)===w.reservationId||String(d?.reservationId)===w.reservationId);s!==-1&&(a=s)}if(a===null&&typeof w.reservationIndex=="number"&&!Number.isNaN(w.reservationIndex)&&w.reservationIndex>=0&&w.reservationIndex<n.length&&(a=w.reservationIndex),a===null)return;const o="my-reservations-tab",i="reservations-tab",r=w;w=null;try{await vi(i),await Si(o);const s=await Ei();typeof s=="function"?s(a):(console.warn("⚠️ Pending reservation edit skipped: editor is not available"),w=r)}catch(s){console.error("❌ Failed to open pending reservation editor",s),w=r}})();Ce=e;try{await e}finally{Ce=null}}document.addEventListener("reservations:changed",()=>{w&&rn()});export{it as m};
