const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./reports.js","./auth.js","./auth.css","./reservationsService.js","./controller.js","./dashboardShell.js","./customers.js","./index.css","./dashboardMetrics.js"])))=>i.map(i=>d[i]);
import{d as j,t as c,e as de,n as g,b as K,A as qn,s as xt,f as In,h as v,j as Ae,k as ge,o as dt,u as ve,p as Ne,q as _n,r as wn,a as Tn,c as An,i as kn,l as Cn}from"./auth.js";/* empty css     */import{i as Ln}from"./dashboardShell.js";import{r as Bn}from"./customers.js";import{e as Dt,a as $n,r as qe,b as Mn,i as Rn,s as Fn,c as Nn,l as xn,d as Dn,f as Pn,u as Pt,g as jn,h as zn,j as On,k as _t,m as Hn,n as ut,E as wt,o as Vn,p as Un,q as Wn,t as Gn,v as Qn,w as Yn}from"./controller.js";import{i as Kn,b as Zn,c as Jn,g as Tt,s as At,e as Xn,f as ea,h as ta,n as jt,j as na}from"./reservationsService.js";const aa="modulepreload",ia=function(e,t){return new URL(e,t).href},kt={},zt=function(t,n,a){let s=Promise.resolve();if(n&&n.length>0){let p=function(m){return Promise.all(m.map(u=>Promise.resolve(u).then(f=>({status:"fulfilled",value:f}),f=>({status:"rejected",reason:f}))))};const i=document.getElementsByTagName("link"),o=document.querySelector("meta[property=csp-nonce]"),l=o?.nonce||o?.getAttribute("nonce");s=p(n.map(m=>{if(m=ia(m,a),m in kt)return;kt[m]=!0;const u=m.endsWith(".css"),f=u?'[rel="stylesheet"]':"";if(a)for(let h=i.length-1;h>=0;h--){const E=i[h];if(E.href===m&&(!u||E.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${m}"]${f}`))return;const b=document.createElement("link");if(b.rel=u?"stylesheet":aa,u||(b.as="script"),b.crossOrigin="",b.href=m,l&&b.setAttribute("nonce",l),document.head.appendChild(b),u)return new Promise((h,E)=>{b.addEventListener("load",h),b.addEventListener("error",()=>E(new Error(`Unable to preload CSS for ${m}`)))})}))}function r(i){const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=i,window.dispatchEvent(o),!o.defaultPrevented)throw i}return s.then(i=>{for(const o of i||[])o.status==="rejected"&&r(o.reason);return t().catch(r)})};let Ke=!1;function ra(){document.querySelectorAll('input[type="time"]').forEach(t=>{t.setAttribute("step","300")})}function sa(){return typeof window<"u"&&typeof window.flatpickr=="function"?window.flatpickr.bind(window):typeof globalThis<"u"&&typeof globalThis.flatpickr=="function"?globalThis.flatpickr.bind(globalThis):(console.warn("⚠️ Flatpickr غير متاح - سيتم تخطي تهيئة عناصر التاريخ"),null)}function oa(){const e=sa(),t={dateFormat:"Y-m-d",altInput:!0,altFormat:"Y-m-d",allowInput:!0,disableMobile:!0,altInputClass:"flatpickr-alt-input form-control"},n=[["#res-start",{}],["#res-end",{}],["#filter-start-date",{}],["#filter-end-date",{}],["#edit-res-start",{}],["#edit-res-end",{}]],a={enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0,disableMobile:!0,minuteIncrement:5,altInputClass:"flatpickr-alt-input form-control"},s=["#res-start-time","#res-end-time","#edit-res-start-time","#edit-res-end-time"];e&&(n.forEach(([i,o])=>{document.querySelector(i)&&e(i,{...t,...o})}),s.forEach(i=>{document.querySelector(i)&&e(i,{...a})}));const r=document.querySelector("#res-start-time");r&&r.dispatchEvent(new Event("change",{bubbles:!0}))}function Ot(){if(!Ke){ra(),Fn(()=>qe()),Nn(jn()),Kn({onDraftChange:zn,onEditChange:Pt}),xn(),Dn(),Ke=!0;try{const e=()=>qe();document.addEventListener("reservations:updated",e),window.addEventListener("reservations:updated",e)}catch{}}}function ca(){const e=document.body;e&&e.dataset.reservationsTechListener!=="true"&&(document.addEventListener("technicians:updated",()=>{const{technicians:t=[]}=j();Zn(t),Pn(),Pt()}),e.dataset.reservationsTechListener="true")}async function la(){await Dt();try{await $n({force:!0})}catch(e){console.warn("⚠️ [reservations/events] Failed to pre-load projects for reservation form",e)}qe(),Mn(),Rn({onAfterSubmit:On}),Ke||Ot(),oa(),ca()}const da={limit:200};let S=null,Ct=!1,Lt=!1,Bt=!1,Ze=null,Ve=null,$t=!1,Ue=null,We=null,Ge=!1,D="",Be=null;const Qe=new Map;function U(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function mt(){const e=document.getElementById("calendar"),t=document.getElementById("calendar-panel")||e?.parentElement||null,n=document.getElementById("calendar-status");return{calendarEl:e,panelEl:t,statusEl:n}}function Je(){try{if(typeof FullCalendar<"u")return FullCalendar}catch{}return typeof window<"u"&&window.FullCalendar?window.FullCalendar:typeof global<"u"&&global.FullCalendar?global.FullCalendar:typeof globalThis<"u"&&globalThis.FullCalendar?globalThis.FullCalendar:null}async function ua(){const e=Je();return e||Be||(Be=new Promise(t=>{try{const n="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js",a=document.createElement("script");a.src=n,a.async=!0,a.onload=()=>t(Je()),a.onerror=()=>t(null),document.head.appendChild(a)}catch{t(null)}}),Be)}function ma(){if(typeof window>"u")return null;const e=window.tui?.Calendar||window.toastui?.Calendar||window.Calendar;return typeof e=="function"?e:null}function pa(e){return Qe.has(e)||Qe.set(e,new Intl.DateTimeFormat(e,{hour:"2-digit",minute:"2-digit"})),Qe.get(e)}function pt(e,t,n=!1){if(n){const m=(de?.()==="en"?"en":"ar")==="en"?"All day":"طوال اليوم";return c("calendar.labels.allDay",m)}if(!e)return"";const a=new Date(e);if(Number.isNaN(a.getTime()))return"";const s=de?.()==="en"?"en-US":"ar-SA-u-ca-gregory-nu-latn",r=pa(s),i=r.format(a);if(!t)return i;const o=new Date(t);if(Number.isNaN(o.getTime()))return i;const l=r.format(o);return i===l?i:`${i} – ${l}`}function fa({paid:e,confirmed:t,completed:n}){const a=["calendar-event"];return(n===!0||n==="true")&&a.push("calendar-event--completed"),t===!0||t==="true"?a.push("calendar-event--confirmed"):a.push("calendar-event--pending"),e===!0||e==="paid"?a.push("calendar-event--paid"):a.push("calendar-event--unpaid"),a}function Ht(e){try{const{event:t}=e||{},n=t?.extendedProps||{},a=pt(t?.startStr,t?.endStr,t?.allDay),s=n?.reservationId?String(n.reservationId):t?.id!=null?String(t.id):"—",r=n?.customerName||c("calendar.labels.unknownCustomer","غير معروف"),i=n?.confirmed===!0||n?.confirmed==="true",o=n?.paid===!0||n?.paid==="paid",l=n?.completed===!0||n?.completed==="true",p=(h,E)=>`<span class="calendar-chip ${h}">${U(E)}</span>`,m=i?c("calendar.badges.confirmed","مؤكد"):c("calendar.badges.pending","غير مؤكد"),u=o?c("calendar.badges.paid","مدفوع"):c("calendar.badges.unpaid","غير مدفوع"),f=[p(i?"status-confirmed":"status-pending",m),p(o?"status-paid":"status-unpaid",u)];return l&&f.push(p("status-completed",c("calendar.badges.completed","منتهي"))),{html:`
      <div class="calendar-event-wrapper">
        <div class="calendar-event-card">
          <div class="calendar-event-card__head">
            <span class="calendar-event-card__time">${U(a||"")}</span>
            <span class="calendar-event-card__id">${U(s)}</span>
          </div>
          <div class="calendar-event-card__customer">${U(r)}</div>
          <div class="calendar-event-card__chips">${f.join("")}</div>
        </div>
      </div>`}}catch{return{html:""}}}function ye(){const{calendarEl:e}=mt();if(!e)return;const t=Je();if(t&&typeof t.Calendar=="function"){(async()=>{R({loading:!0});const s=await Xe();if(D){const i=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");R({loading:!1,error:D||i}),X();return}const r=Ut(s);S?(S.setOption("locale",de()),S.setOption("buttonText",getCalendarButtonText()),S.batchRendering?.(()=>{S.removeAllEvents(),S.addEventSource(r)}),ye()):(S=new t.Calendar(e,{initialView:xe(),locale:de(),timeZone:"local",expandRows:!1,height:"auto",contentHeight:"auto",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},dayMaxEventRows:3,lazyFetching:!1,noEventsContent(){return c("calendar.noEvents","لا توجد حجوزات لعرضها في هذا النطاق")},buttonText:getCalendarButtonText(),events:r,eventContent:Ht,eventClick(i){tt(i.event.extendedProps)},windowResize:Y,datesSet(){ye()}}),S.render(),typeof window<"u"&&(Ze=ft(window.innerWidth||1024)),ye()),Y(),et(r),R({loading:!1,error:"",empty:r.length===0}),setTimeout(()=>{Y(),ye()},120)})().catch(s=>{console.error("❌ [calendar] renderCalendar (FC) failed",s);const r=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");R({loading:!1,error:r}),X()});return}const n=e.querySelector(".fc-header-toolbar");if(!n)return;n.classList.add("calendar-toolbar"),n.querySelectorAll(".fc-toolbar-chunk").forEach(s=>{s.classList.add("calendar-toolbar__chunk")});const a=n.querySelector(".fc-toolbar-title");a&&a.classList.add("calendar-toolbar__title"),n.querySelectorAll(".fc-button").forEach(s=>{s.classList.add("calendar-toolbar__button")})}function R({loading:e=!1,error:t="",empty:n=!1}={}){const{panelEl:a,statusEl:s}=mt();if(!a||!s)return;const r=typeof t=="string"?t.trim().length>0:!!t,i=!e&&!r&&!!n,o=e||r||i;if(a.classList.toggle("is-loading",e),a.classList.toggle("has-error",r),a.classList.toggle("is-empty",i),s.dataset.initialized||(s.classList.add("calendar-status-card","shadow-2xl","bg-base-100/95","border","border-base-200/80","rounded-3xl","text-base-content","px-8","py-8","flex","flex-col","items-center","justify-center","gap-4"),s.dataset.initialized="true"),s.classList.remove("calendar-status-card--loading","calendar-status-card--error","calendar-status-card--empty"),s.classList.toggle("hidden",!o),!o){s.innerHTML="",s.removeAttribute("data-status");return}let l="";e?l=c("calendar.status.loading","⏳ جارٍ تحميل الحجوزات..."):r?l=typeof t=="string"&&t.trim().length>0?t:c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً."):i&&(l=c("calendar.status.empty","لا توجد حجوزات لعرضها في هذه الفترة."));const p=e?"loading":r?"error":"empty";if(s.setAttribute("data-status",p),s.classList.add(`calendar-status-card--${p}`),s.innerHTML="",e){const u=document.createElement("span");u.className="loading loading-spinner loading-md text-primary",u.setAttribute("aria-hidden","true"),s.appendChild(u)}else{const u=document.createElement("span");u.className="calendar-status-card__icon",u.setAttribute("aria-hidden","true"),u.textContent=r?"⚠️":"🗓️",s.appendChild(u)}const m=document.createElement("span");m.className="calendar-status-card__message text-center text-sm font-semibold",m.textContent=l,s.appendChild(m)}function Vt(e,t=null){if(!e||typeof e!="object")return null;const n=e.start??e.startDatetime??e.start_datetime??null,a=e.end??e.endDatetime??e.end_datetime??n;if(!n)return null;String(e.status??"").toLowerCase();const s=e.paidStatus??e.paid_status??null,r=e.paid!=null?e.paid:s==="paid",{effectiveConfirmed:i}=ea(e,t),o=e.reservationId??e.reservationCode??e.reservation_code??e.id??n,l=e.customerName??e.customer_name??"";let p=!!e.completed;if(!p&&a){const m=new Date(a);Number.isNaN(m.getTime())||(p=m<new Date)}return{id:e.id??o??n,start:n,end:a||n,paid:r,confirmed:i,completed:p,reservationId:o??"",customerName:l,raw:e}}function Ut(e=[]){const{projects:t=[]}=j(),n=new Map(t.map(a=>[String(a.id),a]));return e.map(a=>{const s=a?.projectId??a?.project_id??null,r=s!=null&&s!==""&&n.get(String(s))||null,i=Vt(a,r);if(!i)return null;const o=fa({paid:i.paid,confirmed:i.confirmed,completed:i.completed});return{id:i.id,title:"",start:i.start,end:i.end,display:"block",backgroundColor:"transparent",borderColor:"transparent",textColor:"",classNames:o,extendedProps:{...a,raw:a,paid:i.paid,confirmed:i.confirmed,completed:i.completed,reservationId:i.reservationId,customerName:i.customerName}}}).filter(Boolean)}async function Xe(){if(Ge)return Tt();Ge=!0,D="";try{await Dt({suppressError:!1,params:da})}catch(e){console.error("❌ [calendar] Failed to load reservations for calendar view",e),D=Jn(e)?e.message:e instanceof Error&&e.message||""}finally{Ge=!1}return Tt()}function X(){if(S){try{typeof S.destroy=="function"&&S.destroy()}catch{}S=null}}function et(e){const t={events:e};typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("calendar:updated",{detail:t})):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("calendar:updated",{detail:t}))}function Wt(){je()}function ba(){Ct||(document.addEventListener("language:changed",()=>{S&&S.setOption("locale",de()),je()}),Ct=!0),Lt||(document.addEventListener("reservations:changed",()=>{Wt()}),Lt=!0)}function ft(e){return e<=480?"xs":e<=768?"sm":"lg"}function xe(){if(typeof window>"u")return"month";const e=window.innerWidth||1024,t=ft(e);return t==="xs"?"day":t==="sm"?"week":"month"}function Y(){if(!S)return;const e=typeof window<"u"&&window.innerWidth||1024,t=ft(e),n=xe();Ze!==t&&typeof S.changeView=="function"&&(Ze=t,S.changeView(n,!0))}function ga(){Bt||typeof window>"u"||(window.addEventListener("resize",()=>{Ve&&clearTimeout(Ve),Ve=setTimeout(()=>{Y()},160)},{passive:!0}),Bt=!0)}function ya(){if($t||typeof MutationObserver>"u"||typeof document>"u")return;const e=()=>{We&&clearTimeout(We),We=setTimeout(()=>{Wt()},80)};Ue=new MutationObserver(e),Ue.observe(document.documentElement,{attributes:!0,attributeFilter:["class"]}),document.body&&Ue.observe(document.body,{attributes:!0,attributeFilter:["class"]}),$t=!0}function tt(e){const t=document.getElementById("calendar-reservation-details");if(!t){alert(c("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"));return}const n=j()||{},{reservations:a=[],customers:s=[],projects:r=[],technicians:i=[]}=n,o=e?.raw&&typeof e.raw=="object"?{...e.raw,...e}:{...e},l=[o.id,o.reservationId,o.reservation_id,o.reservationCode,o.reservation_code].map(y=>y==null?"":String(y)).filter(y=>y.length>0);let p=-1,m=null;l.length>0&&(p=a.findIndex(y=>{const x=[y?.id,y?.reservationId,y?.reservation_id,y?.reservationCode,y?.reservation_code].map(B=>B==null?"":String(B)).filter(B=>B.length>0);return x.length===0?!1:x.some(B=>l.includes(B))}),p>=0&&(m=a[p]));let u;m?(u={...o,...m},Array.isArray(m.items)&&m.items.length&&(u.items=m.items),Array.isArray(m.packages)&&m.packages.length&&(u.packages=m.packages)):u=o;const f=u.projectId??u.project_id??null,b=f!=null&&r.find(y=>String(y.id)===String(f))||null,h=u.customerId??u.customer_id,E=s.find(y=>String(y.id)===String(h)),w=At(),z=[...Array.isArray(w)?w:[],...Array.isArray(i)?i:[]],M=new Map;z.forEach(y=>{if(!y||y.id==null)return;const x=String(y.id),B=M.get(x)||{};M.set(x,{...B,...y})});const H=Array.from(M.values());let T="";try{T=_t(u,E,H,p>=0?p:0,b)}catch(y){console.error("❌ [calendar] Failed to build reservation details for calendar modal",y),t.innerHTML=`<p class="text-sm text-error">${U(c("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"))}</p>`;return}t.innerHTML=T,t.classList.add("calendar-reservation-details");try{Xn()?.then(()=>{try{const y=Array.from(new Map((At()||[]).map(B=>[String(B.id),B])).values()),x=_t(u,E,y,p>=0?p:0,b);t.innerHTML=x,t.classList.add("calendar-reservation-details")}catch{}}).catch(()=>{})}catch{}t.querySelector(".reservation-modal-actions")?.remove(),t.querySelectorAll(".reservation-qty-btn, .reservation-remove-button").forEach(y=>{y instanceof HTMLElement&&(y.setAttribute("disabled","true"),y.setAttribute("aria-disabled","true"),y.setAttribute("tabindex","-1"))});const oe=t.querySelector('[data-action="open-project"]');oe&&(b?oe.addEventListener("click",()=>{const y=b?.id!=null?String(b.id):"",x=y?`projects.html?project=${encodeURIComponent(y)}`:"projects.html";window.location.href=x}):oe instanceof HTMLElement&&oe.setAttribute("disabled","true"));const Le=document.getElementById("calendarReservationModal");Le&&window.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(Le).show():alert(c("calendar.alerts.cannotOpenModal","لا يمكن فتح نافذة التفاصيل"))}function je(){ba(),ga(),ya();const{calendarEl:e}=mt();if(!e)return;const t=ma();if(!t){(async()=>{const n=await ua();if(!n||typeof n.Calendar!="function"){const r=c("calendar.status.missingLibrary","تعذر تحميل مكتبة التقويم. يرجى تحديث الصفحة.");R({error:r}),X();return}R({loading:!0});const a=await Xe();if(D){const r=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");R({loading:!1,error:D||r}),X();return}const s=Ut(a);S?S.batchRendering?.(()=>{S.removeAllEvents(),S.addEventSource(s)}):(S=new n.Calendar(e,{initialView:xe(),locale:de(),timeZone:"local",expandRows:!1,height:"auto",contentHeight:"auto",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},dayMaxEventRows:3,lazyFetching:!1,noEventsContent(){return c("calendar.noEvents","لا توجد حجوزات لعرضها في هذا النطاق")},buttonText:{today:c("calendar.buttons.today","اليوم"),month:c("calendar.buttons.month","شهر"),week:c("calendar.buttons.week","أسبوع"),day:c("calendar.buttons.day","يوم")},events:s,eventContent:Ht,eventClick(r){tt(r.event.extendedProps)},windowResize:Y,datesSet(){ye()}}),S.render()),Y(),et(s),R({loading:!1,error:"",empty:s.length===0})})();return}(async()=>{R({loading:!0});const n=await Xe();if(D){const i=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");R({loading:!1,error:D||i}),X();return}const a=va(n);X();const s=xe();S=new t("#calendar",{defaultView:s,usageStatistics:!1,isReadOnly:!0,week:{taskView:!1,hourStart:6,hourEnd:24},month:{visibleWeeksCount:0,startDayOfWeek:0,isAlways6Weeks:!0,maxVisibleEventCount:6,moreLayerSize:420},template:{time(i){const o=i?.raw?.paid===!0||i?.raw?.paid==="paid",l=i?.raw?.confirmed===!0||i?.raw?.confirmed==="true",p=i?.raw?.completed===!0||i?.raw?.completed==="true",m=c("calendar.labels.unknownCustomer","غير معروف"),u=pt(i.start?.toString?.()||i.start,i.end?.toString?.()||i.end,i.isAllDay),f=i?.raw?.reservationId?String(i.raw.reservationId):"—",b=i?.raw?.customerName||m,h=(M,H)=>`<span class="badge ${M} badge-sm">${U(H)}</span>`,E=l?c("calendar.badges.confirmed","مؤكد"):c("calendar.badges.pending","غير مؤكد"),w=o?c("calendar.badges.paid","مدفوع"):c("calendar.badges.unpaid","غير مدفوع"),z=[h(l?"badge-success":"badge-warning",E),h(o?"badge-info":"badge-error",w)];return p&&z.push(h("badge-neutral",c("calendar.badges.completed","منتهي"))),`
            <div class="card bg-base-100/90 border border-base-200 shadow-sm rounded-xl p-2">
              <div class="flex items-baseline justify-between text-[0.8rem]">
                <span class="font-bold">${U(u||"")}</span>
                <span class="font-semibold">${U(f)}</span>
              </div>
              <div class="mt-1 font-semibold text-sm truncate">${U(b)}</div>
              <div class="mt-1 flex gap-1 flex-wrap">${z.join("")}</div>
            </div>
          `}}});const r=i=>{if(i)try{tt(i)}catch{}};typeof S.on=="function"&&(S.on("clickSchedule",i=>r(i?.schedule?.raw||i?.schedule)),S.on("clickEvent",i=>r(i?.event?.raw||i?.event)));try{typeof S.createSchedules=="function"?S.createSchedules(a):typeof S.createEvents=="function"&&S.createEvents(a)}catch{}Y(),et(a),R({loading:!1,error:"",empty:a.length===0}),setTimeout(()=>{Y()},120)})().catch(n=>{console.error("❌ [calendar] renderCalendar failed",n),D=n instanceof Error&&n.message||D||"";const a=c("calendar.status.error","تعذر تحميل بيانات الحجوزات. حاول مجدداً.");R({loading:!1,error:D||a}),X()})}function va(e=[]){const{projects:t=[]}=j(),n=new Map(t.map(a=>[String(a.id),a]));return e.map(a=>{const s=a?.projectId??a?.project_id??null,r=s!=null&&n.get(String(s))||null,i=Vt(a,r);if(!i)return null;const o=pt(i.start,i.end,!1),l=i.customerName||"",p=[o,l].filter(Boolean).join(" · ");return{id:String(i.id),calendarId:"default",title:p,category:"time",isAllDay:!1,isAllday:!1,start:i.start,end:i.end,raw:{...a,paid:i.paid,confirmed:i.confirmed,completed:i.completed,reservationId:i.reservationId,customerName:i.customerName}}}).filter(Boolean)}const ha=j()||{};let ie=(ha.maintenance||[]).map(Gt);function ze(){return ie}function Oe(e){return ie=Array.isArray(e)?e.map(Gt):[],xt({maintenance:ie}),La(),ie}async function Sa(e={}){const t=new URLSearchParams;Object.entries(e).forEach(([r,i])=>{i!=null&&i!==""&&t.set(r,String(i))});const n=t.toString(),a=await K(`/maintenance/${n?`?${n}`:""}`),s=Array.isArray(a?.data)?a.data.map(bt):[];return Oe(s)}async function Ea(e){const t=await K("/maintenance/",{method:"POST",body:e}),n=bt(t?.data??{});return Oe([n,...ie.filter(a=>a.id!==n.id)]),n}async function qa(e,t){const n=await K(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:t}),a=bt(n?.data??{});return Oe(ie.map(s=>String(s.id)===String(e)?a:s)),a}async function Ia(e){await K(`/maintenance/?id=${encodeURIComponent(e)}`,{method:"DELETE"}),Oe(ie.filter(t=>String(t.id)!==String(e)))}function _a({equipmentId:e,technicianId:t,issue:n,priority:a,status:s,scheduledAt:r,resolutionReport:i}){return{equipment_id:e,technician_id:null,maintenance_type:null,priority:a,reported_at:null,scheduled_at:null,status:s,notes:n??"",resolution_report:null,repair_cost:null}}function bt(e={}){return Qt({id:e.id,equipment_id:e.equipment_id,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode,equipmentDesc:e.equipmentDesc??e.equipment_desc??e.equipment_description,issue:e.issue??e.notes,priority:e.priority,status:e.status,status_raw:e.status_raw,createdAt:e.createdAt??e.reportedAt??e.reported_at,reportedAt:e.reportedAt??e.reported_at,scheduledAt:e.scheduledAt??e.scheduled_at,resolvedAt:e.resolvedAt??e.resolved_at,resolutionReport:e.resolutionReport??e.resolution_report,technicianId:e.technicianId??e.technician_id,repairCost:e.repairCost??e.repair_cost})}function Gt(e={}){return Qt(e)}function Qt(e={}){const t=e.id??e.ticketId??Date.now(),n=e.equipmentDesc??e.equipment_desc??e.equipmentDescription??e.equipment_name??"",a=Ta(e.status_raw??e.status??"open"),s=Aa(a),r=Ca(e,a);return{id:Number(t),equipmentId:e.equipment_id??e.equipmentId??null,equipmentBarcode:e.equipmentBarcode??e.equipment_barcode??"",equipmentDesc:n,issue:e.issue??e.notes??"",priority:ka(e.priority??"medium"),status:s,statusRaw:a,statusLabel:r,createdAt:e.createdAt??e.reportedAt??e.reported_at??null,reportedAt:e.reportedAt??e.reported_at??null,scheduledAt:e.scheduledAt??e.scheduled_at??null,resolvedAt:e.resolvedAt??e.resolved_at??null,resolutionReport:e.resolutionReport??e.resolution_report??"",technicianId:e.technicianId??e.technician_id??null,repairCost:wa(e.repairCost??e.repair_cost??e.repair_cost_value??null)}}function wa(e){if(e==null||e==="")return null;const t=Number.parseFloat(g(String(e)));return!Number.isFinite(t)||t<0?null:Math.round(t*100)/100}function Ta(e){const t=String(e??"").trim();return t&&t.toLowerCase().replace(/\s+/g,"_").replace(/[^a-z0-9_\-]/g,"")||"open"}function Aa(e){const t=Yt(e);return["completed","cancelled"].includes(t)?"closed":"open"}function ka(e){const t=String(e??"medium").trim().toLowerCase();return["low","medium","high"].includes(t)?t:"medium"}function Ca(e={},t="open"){const n=e.status_label??e.statusLabel??e.status_display??e.status_text??e.status??e.status_raw??t,a=String(n??"").trim();return a||t.replace(/[_-]+/g," ").replace(/\b\w/g,s=>s.toUpperCase())}function Yt(e){const t=String(e??"").toLowerCase();switch(t){case"open":case"قيد الصيانة":case"قيد الانتظار":return"open";case"in_progress":case"in-progress":case"جاري العمل":return"in_progress";case"completed":case"مكتمل":case"تم الإصلاح":case"closed":case"مغلق":return"completed";case"cancelled":case"ملغي":return"cancelled";default:return t.includes("progress")||t.includes("تنفيذ")?"in_progress":t.includes("complete")||t.includes("close")||t.includes("منجز")||t.includes("مغلق")?"completed":t.includes("cancel")||t.includes("ملغي")?"cancelled":t||"open"}}function La(){typeof window<"u"&&typeof window.dispatchEvent=="function"?window.dispatchEvent(new CustomEvent("maintenance:updated")):typeof dispatchEvent=="function"&&dispatchEvent(new CustomEvent("maintenance:updated"))}function Ie(e){return e instanceof qn}function nt(e){if(!e)return null;const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=String(t.getDate()).padStart(2,"0"),a=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getFullYear()).slice(-2);return`${n}/${a}/${s}`}let se=ze(),re=[],he=null,le=!1,Se="",ue=se.length>0,P={id:null,equipmentDesc:"",equipmentBarcode:"",repairCost:null,resolvedAt:null,mode:"close"},gt=null,k=null,I=null,$=null,me=null,Ee=null,pe=null,_=null;async function _e({showToastOnError:e=!0}={}){if(!le){le=!0,Se="",O();try{await Sa(),ue=!0}catch(t){ue=se.length>0,console.error("❌ [maintenance] Failed to load maintenance tickets",t),Se=Ie(t)?t.message:c("maintenance.toast.fetchFailed","تعذر تحميل بيانات الصيانة. حاول تحديث الصفحة."),e&&v(Se,"error")}finally{le=!1,se=ze(),O()}}}function at(){return c("maintenance.form.selectedInfo","لم يتم اختيار معدة بعد.")}function W(e){return g(String(e||"")).trim().toLowerCase()}function Kt(e=""){return g(String(e)).trim().toLowerCase()}function Ba(e={}){const t=String(e?.desc??"").trim(),n=g(String(e?.displayBarcode??e?.barcode??"")).trim();return n?`${t} | ${n}`:t}function $a(e){const t=g(String(e||""));if(!t.trim())return{description:"",barcode:""};const[n,...a]=t.split("|");return{description:n.trim(),barcode:a.join("|").trim()}}function Zt(e){return g(String(e||"")).trim().toLowerCase()}function q(e=""){return String(e??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Ma(e=new Date){const t=e instanceof Date?e:new Date(e);if(Number.isNaN(t.getTime()))return null;const n=a=>String(a).padStart(2,"0");return`${t.getFullYear()}-${n(t.getMonth()+1)}-${n(t.getDate())} ${n(t.getHours())}:${n(t.getMinutes())}:${n(t.getSeconds())}`}function Z(){return se=ze(),se}function Jt(e){return Z().find(n=>Number(n.id)===Number(e))||null}function Xt(e){const t=String(e??"").trim().toLowerCase();return t?["maintenance","صيانة"].includes(t)?"maintenance":["reserved","محجوز"].includes(t)?"reserved":["retired","متوقف","خارج الخدمة"].includes(t)?"retired":"available":"available"}function yt(){const{equipment:e=[]}=j(),t=c("maintenance.table.noName","بدون اسم");return re=(e||[]).map(n=>{const a=String(n?.barcode??"").trim(),s=W(a),r=Number.parseInt(n?.qty??n?.quantity??0,10),i=Number.isFinite(r)?Math.max(r,0):1,o=n?.image||n?.imageUrl||n?.image_url||"",l=n?.status||"متاح",p=n?.desc||n?.description||n?.name||t,m=Ba({desc:p,displayBarcode:a,barcode:s});return{id:n?.id??n?.equipment_id??n?.equipmentId??null,barcode:s,displayBarcode:a,desc:p,status:l,statusNormalized:Xt(l),price:Number(n?.price||n?.unit_price)||0,category:n?.category||"",quantity:i,image:o,searchValue:m,searchValueNormalized:Zt(m),descriptionNormalized:Kt(p)}}),re.sort((n,a)=>n.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),re}function vt(){const e=new Set,t=new Map;return Z().filter(n=>n.status==="open").forEach(n=>{const a=W(n.equipmentBarcode);a&&(e.add(a),t.set(a,(t.get(a)||0)+1))}),{set:e,map:t}}function en(e){const t=W(e);if(!t)return 0;const{map:n}=vt();return n.get(t)||0}function He(e){const t=W(e);return t&&(re.length?re:yt()).find(a=>a.barcode===t)||null}function Ra(e){const t=re.length?re:yt();if(!t.length)return null;const n=Zt(e);if(n){const o=t.find(l=>l.searchValueNormalized===n);if(o)return o}const{description:a,barcode:s}=$a(e);if(s){const o=W(s);if(o){const l=t.find(p=>p.barcode===o);if(l)return l}}const r=Kt(a||e);if(!r)return null;const i=t.find(o=>o.descriptionNormalized===r);return i||t.find(o=>o.descriptionNormalized.includes(r))||null}function it(e,t=null){if(!e)return!0;const n=e.barcode,a=Number.isFinite(e.quantity)?e.quantity:0,r=(t||vt().map).get(n)||0;return a<=0?!0:a===1?e.statusNormalized==="maintenance"||r>=1:r>=a}function ee({keepInputs:e=!1,silent:t=!1}={}){const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),s=document.getElementById("maintenance-equipment-search"),r=document.getElementById("maintenance-selected-info");n&&(n.value=""),e||(a&&(a.value=""),s&&(s.value="")),r&&(r.textContent=at(),r.classList.remove("maintenance-selected-info--has-selection")),he=null}function tn(e){const t=document.getElementById("maintenance-selected-info");if(!t)return;const n=c("maintenance.info.barcodeLabel","باركود"),a=c("maintenance.report.notAvailable","غير متوفر"),s=c("maintenance.info.unitsAvailable","الوحدات المتاحة الآن"),r=c("maintenance.info.categoryLabel","القسم"),i=e.displayBarcode||e.barcode||a,o=e.barcode,l=Number.isFinite(e.quantity)?e.quantity:0,p=en(o),m=Math.max(l-p,0),u=e.category?`
    <div class="maintenance-selected-info__meta">${r}: <strong>${q(e.category)}</strong></div>
  `:"",f=l>0?`
    <div class="maintenance-selected-info__meta">
      ${s}: <strong>${m}</strong> / ${l}
    </div>
  `:"",b=e.image?`<img class="maintenance-selected-info__image" src="${q(e.image)}" alt="${q(e.desc)}">`:'<div class="maintenance-selected-info__placeholder" aria-hidden="true">🎥</div>';t.innerHTML=`
    <div class="maintenance-selected-info__media">${b}</div>
    <div class="maintenance-selected-info__body">
      <div class="maintenance-selected-info__name">${q(e.desc)}</div>
      <div class="maintenance-selected-info__meta">${n}: <strong>${q(i)}</strong></div>
      ${f}
      ${u}
    </div>
  `,t.classList.add("maintenance-selected-info--has-selection")}function ht(e,{silent:t=!1}={}){if(!e)return!1;if(it(e))return t||v(c("maintenance.toast.equipmentBlocked","⚠️ هذه المعدة قيد الصيانة ولا يمكن اختيارها حالياً")),!1;const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),s=document.getElementById("maintenance-equipment-search");return n&&(n.value=e.barcode),a&&(a.value=e.displayBarcode||e.barcode),s&&(s.value=e.searchValue||e.desc),tn(e),he=e,!0}function nn(e,{showFeedback:t=!0}={}){const n=He(e);return n?ht(n,{silent:!t}):(t&&v(c("maintenance.toast.equipmentNotFoundBarcode","❌ لم يتم العثور على معدة بهذا الباركود")),!1)}function an(e,{showFeedback:t=!0}={}){const n=Ra(e);return n?ht(n,{silent:!t}):(t&&v(c("maintenance.toast.equipmentNotFoundName","❌ لم يتم العثور على معدة بالاسم المدخل")),!1)}function St(){const e=document.getElementById("maintenance-equipment-options"),t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=yt(),{map:s}=vt();e&&(e.innerHTML=a.map(i=>`<option value="${q(i.searchValue||i.desc)}"></option>`).join(""));const r=document.getElementById("maintenance-selected-barcode");if(r&&r.value){const i=He(r.value);!i||it(i,s)?(ee({keepInputs:!0,silent:!0}),i&&it(i,s)&&v(c("maintenance.toast.equipmentBecameBlocked","⚠️ هذه المعدة أصبحت قيد الصيانة ولا يمكن اختيارها"))):ht(i,{silent:!0})}else ee({keepInputs:!0,silent:!0});if(t&&!t.dataset.listenerAttached&&(t.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),nn(t.value)||ee({keepInputs:!0,silent:!0}))}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached){const i=()=>{if(!n.value){ee({keepInputs:!0,silent:!0});return}an(n.value)||ee({keepInputs:!0,silent:!0})};n.addEventListener("change",i),n.addEventListener("keydown",o=>{o.key==="Enter"&&(o.preventDefault(),i())}),n.dataset.listenerAttached="true"}}async function De(){try{await Hn({showToastOnError:!1})}catch(e){console.error("❌ [maintenance] refreshEquipmentData failed",e)}finally{ut(),St()}}function rn(){const e=document.getElementById("closeMaintenanceModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;if(!t?.Modal)return!1;gt=t.Modal.getOrCreateInstance(e),k||(k=e.querySelector("#maintenance-close-report")),I||(I=e.querySelector("#maintenance-close-cost")),I&&I.dataset.normalizeAttached!=="true"&&(I.addEventListener("input",a=>{Fa(a.currentTarget),a.currentTarget?.classList.remove("is-invalid")}),I.dataset.normalizeAttached="true"),$||($=e.querySelector("#maintenance-close-submit")),me||(me=e.querySelector("#maintenance-close-modal-details"));const n=e.querySelector("#maintenance-close-form");return n&&!n.dataset.listenerAttached&&(n.addEventListener("submit",xa),n.dataset.listenerAttached="true"),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",sn),e.dataset.listenerAttached="true"),!0}function sn(){P={id:null,equipmentDesc:"",equipmentBarcode:"",repairCost:null,resolvedAt:null,mode:"close"},k&&(k.value="",k.classList.remove("is-invalid")),I&&(I.value="",I.classList.remove("is-invalid")),me&&(me.innerHTML=""),we(!1);const e=document.getElementById("closeMaintenanceModal");if(e){const t=e.querySelector("#maintenance-close-modal-title"),n=e.querySelector(".maintenance-close-modal__subtitle");t&&(t.textContent=c("maintenance.closeModal.title","🔧 إغلاق تذكرة الصيانة")),n&&(n.textContent=c("maintenance.closeModal.subtitle","يرجى كتابة تقرير الإصلاح قبل إغلاق هذه التذكرة.")),$&&($.textContent=c("maintenance.closeModal.confirm","إغلاق التذكرة"))}}function on(){const e=document.getElementById("maintenanceReportModal");if(!e)return!1;const t=(typeof window<"u"?window.bootstrap:void 0)??globalThis?.bootstrap;return t?.Modal?(Ee=t.Modal.getOrCreateInstance(e),pe||(pe=e.querySelector("#maintenance-report-modal-content")),_||(_=e.querySelector("#maintenance-report-edit")),e.dataset.listenerAttached||(e.addEventListener("hidden.bs.modal",cn),e.dataset.listenerAttached="true"),_&&_.dataset.listenerAttached!=="true"&&(_.addEventListener("click",Ha),_.dataset.listenerAttached="true"),!0):!1}function cn(){pe&&(pe.innerHTML=""),_&&(_.hidden=!0,_.disabled=!1,delete _.dataset.id)}function we(e){if(!$)return;const t=P.mode==="edit",n=t?c("maintenance.closeModal.editSaving","⏳ جاري الحفظ..."):c("maintenance.closeModal.saving","⏳ جاري الإغلاق..."),a=t?c("maintenance.closeModal.editConfirm","حفظ التعديلات"):c("maintenance.closeModal.confirm","إغلاق التذكرة");e?($.disabled=!0,$.dataset.loading="true",$.textContent=n):($.disabled=!1,$.removeAttribute("data-loading"),$.textContent=a)}function Fa(e){if(!e)return;const t=e.value;if(typeof t!="string")return;const n=g(t).replace(/٫/g,".").replace(/٬/g,",");if(n!==t){const{selectionStart:a,selectionEnd:s}=e;if(e.value=n,a!==null&&s!==null)try{e.setSelectionRange(a,s)}catch{}}}function Na(e,t){const n=typeof e=="string"?e.trim():"",a=Number.isFinite(t);if(!n)return{provided:a,value:null,error:null};const r=g(n).replace(/٫/g,".").replace(/٬/g,",").replace(/[^0-9.,-]/g,"");if(!r)return{provided:!0,value:null,error:"invalid"};const i=r.includes(","),o=r.includes(".");let l=r;i&&!o?l=r.replace(",","."):i&&o&&(l=r.replace(/,/g,""));const p=Number.parseFloat(l);return!Number.isFinite(p)||p<0?{provided:!0,value:null,error:"invalid"}:{provided:!0,value:Math.round(p*100)/100,error:null}}function ln(e,{mode:t="close"}={}){const n=Jt(e);if(!n){v(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!rn()){const l=prompt(c("maintenance.prompt.closeReport","أدخل تقرير الإصلاح / الإجراءات المتخذة:"));if(l===null)return;const p=l.trim();if(!p){v(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error");return}dn(e,p);return}const a=n.repairCost!=null&&n.repairCost!==""?Number.parseFloat(g(String(n.repairCost))):null,s=Number.isFinite(a)?Math.round(a*100)/100:null,r=t==="edit"?"edit":"close";if(P={id:n.id,equipmentDesc:n.equipmentDesc||"",equipmentBarcode:n.equipmentBarcode||"",repairCost:s,resolvedAt:n.resolvedAt||null,mode:r},k&&(k.value=n.resolutionReport||"",k.classList.remove("is-invalid")),I&&(s!==null?I.value=g(s.toFixed(2)):I.value="",I.classList.remove("is-invalid")),me){const l=c("maintenance.report.barcode","الباركود"),p=c("maintenance.report.notAvailable","غير متوفر"),m=P.equipmentDesc||p,u=P.equipmentBarcode?g(P.equipmentBarcode):p;me.innerHTML=`
      <div class="maintenance-close-modal__ticket-card" role="group" aria-labelledby="maintenance-close-ticket-title">
        <div class="maintenance-close-modal__ticket-icon" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.75" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 2h6"></path>
            <path d="M10 4h4"></path>
            <path d="M8 4h-2a2 2 0 0 0-2 2v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-2"></path>
            <path d="M9 12l2 2 4-4"></path>
          </svg>
        </div>
        <div class="maintenance-close-modal__ticket-info">
          <div id="maintenance-close-ticket-title" class="maintenance-close-modal__ticket-title">${m}</div>
          <div class="maintenance-close-modal__ticket-meta">${l}: <span>${u}</span></div>
        </div>
      </div>
    `}we(!1);const i=r==="edit";$&&($.textContent=i?c("maintenance.closeModal.editConfirm","حفظ التعديلات"):c("maintenance.closeModal.confirm","إغلاق التذكرة"));const o=document.getElementById("closeMaintenanceModal");if(o){const l=o.querySelector("#maintenance-close-modal-title"),p=o.querySelector(".maintenance-close-modal__subtitle");l&&(l.textContent=i?c("maintenance.closeModal.editTitle","✏️ تعديل بيانات الإغلاق"):c("maintenance.closeModal.title","🔧 إغلاق تذكرة الصيانة")),p&&(p.textContent=i?c("maintenance.closeModal.editSubtitle","يمكنك تحديث تقرير الإصلاح وتكلفته."):c("maintenance.closeModal.subtitle","يرجى كتابة تقرير الإصلاح قبل إغلاق هذه التذكرة."))}gt?.show(),setTimeout(()=>{k?.focus(),k?.setSelectionRange(k.value.length,k.value.length)},150)}async function xa(e){if(e?.preventDefault(),!P.id){v(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(!k)return;const t=k.value.trim();if(!t){v(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),k.focus();return}I&&I.classList.remove("is-invalid");const n=I?Na(I.value,P.repairCost):{provided:!1,value:null,error:null};if(n.error){v(c("maintenance.toast.invalidRepairCost","⚠️ يرجى إدخال قيمة رقمية صحيحة لتكلفة الإصلاح"),"error"),I?.classList.add("is-invalid"),I?.focus();return}we(!0),(await dn(P.id,t,{repairCost:n.value,repairCostProvided:n.provided,mode:P.mode,resolvedAt:P.resolvedAt})).success?gt?.hide():we(!1)}function Da(e){const t=document.getElementById("maintenance-stats");if(!t)return;const n=e.length,a=e.filter(u=>u.status==="open").length,s=n-a,r=u=>g(String(u)),i=c("maintenance.stats.summaryTitle","ملخص الصيانة"),o=c("maintenance.filters.status.open","قيد الصيانة"),l=c("maintenance.filters.status.closed","مغلقة"),p=c("maintenance.stats.totalLabel","إجمالي التذاكر"),m=(u,f,b)=>`
    <div class="maintenance-summary__item maintenance-summary__item--${b}">
      <span class="maintenance-summary__value">${r(u)}</span>
      <span class="maintenance-summary__label">${f}</span>
    </div>
  `;t.innerHTML=`
    <section class="maintenance-summary" aria-labelledby="maintenance-summary-title">
      <header class="maintenance-summary__header">
        <span class="maintenance-summary__icon" aria-hidden="true">🛠️</span>
        <h4 id="maintenance-summary-title" class="maintenance-summary__title">${i}</h4>
      </header>
      <div class="maintenance-summary__items">
        ${m(a,o,"open")}
        ${m(s,l,"closed")}
        ${m(n,p,"total")}
      </div>
    </section>
  `}function Pa(e){const n=String(e?.statusRaw??e?.status??"open").toLowerCase().replace(/[^a-z0-9_\-\s]/g,"").replace(/[\s]+/g,"_")||"open",a=Yt(n)||"open",s={open:{key:"maintenance.status.open",fallback:"قيد الصيانة",className:"maintenance-status-tag--open"},in_progress:{key:"maintenance.status.inProgress",fallback:"قيد التنفيذ",className:"maintenance-status-tag--in-progress"},completed:{key:"maintenance.status.completed",fallback:"مكتملة",className:"maintenance-status-tag--completed"},cancelled:{key:"maintenance.status.cancelled",fallback:"ملغاة",className:"maintenance-status-tag--cancelled"}},r=s[a]??s.open,i=r?c(r.key,r.fallback):c("maintenance.status.open","قيد الصيانة"),o=e?.statusLabel&&String(e.statusLabel).trim()?String(e.statusLabel).trim():i,l=["maintenance-status-badge","maintenance-status-tag"];return r?.className&&l.push(r.className),l.push(`maintenance-status-tag--${a}`),l.push(`maintenance-status-tag--${n}`),`<span class="${l.filter(Boolean).join(" ")}">${o}</span>`}function ja(e){const t=document.getElementById("maintenance-table-body"),n=document.getElementById("maintenance-empty-state");if(t){if(!e||e.length===0){const a=c("maintenance.empty.title","لا توجد تذاكر صيانة"),s=c("maintenance.empty.subtitle","عند إنشاء تذكرة جديدة ستظهر في هذه القائمة.");t.innerHTML=`
      <tr>
        <td colspan="6" class="maintenance-empty-row">
          <div class="maintenance-empty-icon">✅</div>
          <h5>${a}</h5>
          <p>${s}</p>
        </td>
      </tr>
    `,n&&n.classList.add("active");return}n&&n.classList.remove("active"),t.innerHTML=e.map(a=>{const s=Pa(a),r=a.status==="open"?"maintenance-row maintenance-row--open":"maintenance-row maintenance-row--closed",i=(()=>{const H=c("maintenance.priority.high","مرتفعة"),T=c("maintenance.priority.medium","متوسطة"),Ce=c("maintenance.priority.low","منخفضة");switch(a.priority){case"high":return`<span class="maintenance-priority-badge maintenance-priority-badge--high">${H}</span>`;case"low":return`<span class="maintenance-priority-badge maintenance-priority-badge--low">${Ce}</span>`;default:return`<span class="maintenance-priority-badge maintenance-priority-badge--medium">${T}</span>`}})(),o=[],l=c("maintenance.actions.close","🔧 إغلاق بعد الإصلاح"),p=c("maintenance.actions.view","👁️ عرض التقرير"),m=c("maintenance.actions.delete","🗑️ حذف التذكرة");a.status==="open"?o.push(`<button type="button" class="maintenance-action-btn" data-action="close" data-id="${a.id}">${l}</button>`):o.push(`<button type="button" class="maintenance-action-btn" data-action="view" data-id="${a.id}">${p}</button>`),Ae()&&o.push(`<button type="button" class="maintenance-action-btn maintenance-action-btn--delete" data-action="delete" data-id="${a.id}">${m}</button>`);const u=o.join(""),f=c("maintenance.table.noBarcode","بدون باركود"),b=c("maintenance.report.none","—"),h=a.equipmentBarcode?g(a.equipmentBarcode):f,E=a.issue?g(a.issue):b,w=a.repairCost!=null?Number.parseFloat(g(String(a.repairCost))):null,z=a.status==="closed"&&Number.isFinite(w)?`<div class="maintenance-repair-cost">${q(c("maintenance.table.repairCost","💰 تكلفة الإصلاح: {amount}").replace("{amount}",g(w.toFixed(2))))}</div>`:"",M=a.createdAt?g(nt(a.createdAt)||ge(a.createdAt)):"—";return`
        <tr class="${r}">
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${h}</small>
          </td>
          <td class="maintenance-issue-text">${E}${z}</td>
          <td>${i}</td>
          <td>${M}</td>
          <td>${s}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${u}
            </div>
          </td>
        </tr>
      `}).join("")}}function za(e){if(!ue||le){v(c("maintenance.toast.loading","⏳ يتم تحديث بيانات الصيانة، يرجى الانتظار لحظة..."));return}const t=e.target.closest("button[data-action]");if(!t)return;const n=t.getAttribute("data-action"),a=Number(t.getAttribute("data-id"));if(a){if(n==="close")ln(a);else if(n==="view")Oa(a);else if(n==="delete"){if(!Ae()){dt();return}Va(a).catch(s=>{console.error("❌ [maintenance] deleteTicket failed",s)})}}}async function dn(e,t,n={}){const a=Jt(e);if(!a)return v(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة")),{success:!1};const s=(t??"").trim();if(!s)return v(c("maintenance.toast.reportRequired","⚠️ يرجى كتابة تقرير الإصلاح قبل الإغلاق"),"error"),{success:!1};const r=n?.mode==="edit"&&n?.resolvedAt?n.resolvedAt:Ma(new Date)||new Date().toISOString(),i={equipment_id:a.equipmentId,technician_id:a.technicianId??null,priority:a.priority??"medium",status:"completed",notes:a.issue??"",reported_at:a.reportedAt??null,scheduled_at:a.scheduledAt??null,resolution_report:s,resolved_at:r};n?.repairCostProvided&&(i.repair_cost=n.repairCost!=null?Math.round(n.repairCost*100)/100:null);try{await qa(e,i),await _e({showToastOnError:!1});const o=document.getElementById("maintenance-status-filter");return o&&o.value==="open"&&(o.value="all"),await De(),O(),v(c("maintenance.toast.ticketClosed","✅ تم إغلاق تذكرة الصيانة وإعادة المعدة إلى الحالة المتاحة")),{success:!0}}catch(o){if(console.error("❌ [maintenance] closeTicket failed",o),Ie(o)&&o.status===404)return await _e({showToastOnError:!1}),await De(),O(),v(c("maintenance.toast.ticketAlreadyClosed","✅ تم تحديث التذاكر، ويبدو أن هذه التذكرة مغلقة مسبقاً"),"info"),{success:!0};const l=Ie(o)?o.message:c("maintenance.toast.updateError","⚠️ تعذر إغلاق تذكرة الصيانة. حاول مرة أخرى");return v(l,"error"),{success:!1,error:o}}}function Oa(e){const n=Z().find(T=>Number(T.id)===Number(e));if(!n)return;if(n.id,!on()){const T=c("maintenance.report.equipment","المعدة"),Ce=c("maintenance.report.barcode","الباركود"),oe=c("maintenance.report.issue","الوصف"),Le=c("maintenance.report.createdAt","تاريخ الإنشاء"),y=c("maintenance.report.closedAt","تاريخ الإغلاق"),x=c("maintenance.report.summary","التقرير"),B=c("maintenance.report.repairCost","تكلفة الإصلاح"),vn=c("maintenance.report.currencyLabel","ريال"),It=Number.parseFloat(g(String(n.repairCost??""))),hn=Number.isFinite(It)?`${g(It.toFixed(2))} ${vn}`:be,Sn=c("maintenance.report.notAvailable","غير متوفر"),be=c("maintenance.report.none","—"),En=[`${T}: ${n.equipmentDesc}`,`${Ce}: ${n.equipmentBarcode?g(n.equipmentBarcode):Sn}`,`${oe}: ${n.issue?g(n.issue):be}`,`${Le}: ${n.createdAt?g(nt(n.createdAt)||ge(n.createdAt)):be}`,`${y}: ${n.resolvedAt?g(ge(n.resolvedAt)):be}`,`${B}: ${hn}`,`${x}: ${n.resolutionReport?g(n.resolutionReport):be}`].join(`
`);alert(En);return}const a=c("maintenance.report.equipment","المعدة"),s=c("maintenance.report.barcode","الباركود"),r=c("maintenance.report.issue","الوصف"),i=c("maintenance.report.createdAt","تاريخ الإنشاء"),o=c("maintenance.report.closedAt","تاريخ الإغلاق"),l=c("maintenance.report.repairCost","تكلفة الإصلاح"),p=c("maintenance.report.summary","التقرير"),m=c("maintenance.report.notAvailable","غير متوفر"),u=c("maintenance.report.none","—"),f=Number.parseFloat(g(String(n.repairCost??""))),b=Number.isFinite(f)?g(f.toFixed(2)):null,h=c("maintenance.report.currencyLabel","ريال"),E=[{label:a,value:`<span class="maintenance-report-modal__value">${q(n.equipmentDesc||u)}</span>`},{label:s,value:n.equipmentBarcode?`<span class="maintenance-report-modal__value">${q(g(n.equipmentBarcode))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${q(m)}</span>`},{label:r,value:n.issue?`<span class="maintenance-report-modal__value">${q(g(n.issue))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${q(u)}</span>`},{label:i,value:n.createdAt?`<span class="maintenance-report-modal__value">${q(g(nt(n.createdAt)||ge(n.createdAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${q(u)}</span>`},{label:o,value:n.resolvedAt?`<span class="maintenance-report-modal__value">${q(g(ge(n.resolvedAt)))}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${q(u)}</span>`},{label:l,value:b?`<span class="maintenance-report-modal__value">${q(b)} ${q(h)}</span>`:`<span class="maintenance-report-modal__value maintenance-report-modal__value--muted">${q(u)}</span>`}],w=n.resolutionReport?g(n.resolutionReport):"",z=w?`<p>${q(w).replace(/\r?\n/g,"<br>")}</p>`:`<p class="maintenance-report-modal__value maintenance-report-modal__value--muted">${q(u)}</p>`,M=E.map(T=>`
      <div class="maintenance-report-modal__item">
        <span class="maintenance-report-modal__label">${q(T.label)}</span>
        ${T.value}
      </div>
    `).join(""),H=`
    <div class="maintenance-report-modal__summary">
      <h6>${q(p)}</h6>
      ${z}
    </div>
  `;if(pe&&(pe.innerHTML=`
      <div class="maintenance-report-modal__details">
        <div class="maintenance-report-modal__grid">
          ${M}
        </div>
        ${H}
      </div>
    `),_){const T=Ae()&&n.status==="closed";_.hidden=!T,_.disabled=!T,_.textContent=c("maintenance.actions.editClosed","✏️ تعديل بيانات الإغلاق"),T?_.dataset.id=String(n.id):delete _.dataset.id}Ee?.show()}function Ha(){if(!_)return;const e=Number(_.dataset.id);if(!e){Ee?.hide();return}if(!Ae()){Ee?.hide(),dt();return}Ee?.hide(),setTimeout(()=>{ln(e,{mode:"edit"})},220)}async function Va(e){if(!Ae()){dt();return}if(!Z().find(a=>Number(a.id)===Number(e))){v(c("maintenance.toast.ticketNotFound","⚠️ تعذر العثور على تذكرة الصيانة"));return}if(confirm(c("maintenance.toast.ticketDeleteConfirm","⚠️ هل أنت متأكد من حذف تذكرة الصيانة؟")))try{await Ia(e),await _e({showToastOnError:!1}),await De(),v(c("maintenance.toast.ticketDeleted","🗑️ تم حذف تذكرة الصيانة"))}catch(a){console.error("❌ [maintenance] deleteTicket failed",a);const s=Ie(a)?a.message:c("maintenance.toast.deleteError","⚠️ تعذر حذف تذكرة الصيانة. حاول مرة أخرى");v(s,"error")}}async function Ua(e){e.preventDefault();try{const t=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),s=document.getElementById("maintenance-issue"),r=document.getElementById("maintenance-priority");let i=he,o=W(a?.value);if(!i&&o&&(i=He(o)),!i&&t?.value&&nn(t.value,{showFeedback:!0})&&(i=he,o=W(i?.barcode)),!i&&n?.value&&an(n.value,{showFeedback:!0})&&(i=he,o=W(i?.barcode)),!i||!o){v(c("maintenance.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const{equipment:l=[]}=j();let p=(l||[]).find(w=>W(w?.barcode)===o);if(!p&&i&&(p={id:i.id,barcode:i.barcode,desc:i.desc,name:i.desc,status:i.status||"متاح",quantity:i.quantity,qty:i.quantity}),!p||p.id==null){v(c("maintenance.toast.selectedNotFound","❌ لم يتم العثور على المعدة المختارة")),ee();return}const m=Number.parseInt(p.qty??p.quantity??i?.quantity??1,10),u=Number.isFinite(m)&&m>0?m:1,f=en(o);if(Xt(p.status||i?.status)==="maintenance"&&u<=1){v(c("maintenance.toast.equipmentAlreadyMaintenance","⚠️ هذه المعدة بالفعل في حالة صيانة"));return}if(f>=u){v(c("maintenance.toast.noUnitsAvailable","⚠️ لا توجد وحدات متاحة للصيانة لهذه المعدة حالياً"));return}const h=_a({equipmentId:p.id,technicianId:null,issue:s?.value.trim()||"",priority:r?.value||"medium",status:"open",scheduledAt:null,resolutionReport:null});await Ea(h),await _e({showToastOnError:!1}),await De(),v(c("maintenance.toast.ticketCreated","🛠️ تم إنشاء تذكرة الصيانة وإيقاف المعدة")),ee(),s&&(s.value=""),r&&(r.value="medium");const E=document.getElementById("maintenance-status-filter");E&&(E.value="all")}catch(t){console.error("❌ [maintenance] Failed to create ticket",t);const n=Ie(t)?t.message:c("maintenance.toast.submitError","⚠️ تعذر إنشاء تذكرة الصيانة. يرجى المحاولة مجدداً.");v(n,"error")}}function Wa(e){const t=Z();return e==="all"?t:t.filter(n=>n.status===e)}function O(){const e=Z();St(),Da(e);const t=document.getElementById("maintenance-status-filter");t&&!t.value&&(t.value="all");const n=t?.value||"all",a=document.getElementById("maintenance-table-body"),s=document.getElementById("maintenance-empty-state");if(!a)return;if(le&&!ue){const i=c("maintenance.table.loading","جاري التحميل...");a.innerHTML=`<tr><td colspan="6" class="text-center text-muted">${i}</td></tr>`,s&&s.classList.remove("active");return}if(Se&&!ue){a.innerHTML=`<tr><td colspan="6" class="text-center text-danger">${Se}</td></tr>`,s&&s.classList.remove("active");return}const r=Wa(n);ja(r)}function Ga(){Z(),St(),ue=se.length>0,le=!1,O(),_e({showToastOnError:!1}),rn()&&sn(),on()&&cn();const e=document.getElementById("maintenance-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",a=>{Ua(a).catch(s=>{console.error("❌ [maintenance] submit handler failed",s)})}),e.dataset.listenerAttached="true");const t=document.getElementById("maintenance-status-filter");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{O()}),t.dataset.listenerAttached="true");const n=document.querySelector(".maintenance-table");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",za),n.dataset.listenerAttached="true")}Z();document.addEventListener("language:changed",()=>{const e=document.getElementById("maintenance-selected-barcode"),t=document.getElementById("maintenance-selected-info");if(e?.value){const n=He(e.value);n?tn(n):t&&(t.textContent=at())}else t&&(t.textContent=at());O(),we(!1)});document.addEventListener(In.USER_UPDATED,()=>{O()});window.addEventListener("maintenance:updated",()=>{se=ze(),O()});const rt="__ART_RATIO_LAST_DASHBOARD_TAB__",V="__ART_RATIO_LAST_DASHBOARD_SUB_TAB__",Pe="create-tab",un=/^[a-z0-9\-]+$/i;function st(e){if(!(!e||typeof e.scrollIntoView!="function"))try{const t=e.closest("[data-tab-scroll-track]");if(!t)return;const n={behavior:"smooth",block:"nearest",inline:"center"};e.scrollIntoView(n);const a=t.closest("[data-tab-scroll]");a&&window.requestAnimationFrame(()=>{a.dispatchEvent(new CustomEvent("tabScroll:update",{bubbles:!0}))})}catch(t){console.warn("⚠️ [tabs.js] Failed to keep tab visible",t)}}function te(e){try{if(typeof window>"u"||!window.localStorage)return null;const t=window.localStorage.getItem(e);return!t||!un.test(t)?null:t}catch(t){return console.warn("⚠️ [tabs.js] Failed to read stored tab",t),null}}function ot(e,t){try{if(typeof window>"u"||!window.localStorage)return;if(!t||!un.test(t)){window.localStorage.removeItem(e);return}window.localStorage.setItem(e,t)}catch(n){console.warn("⚠️ [tabs.js] Failed to persist tab",n)}}function mn(e){try{if(typeof window>"u"||!window.localStorage)return;window.localStorage.removeItem(e)}catch(t){console.warn("⚠️ [tabs.js] Failed to clear stored tab",t)}}let J=null,F=null,ne=!1,L=null,Mt=null,ae=null,ct=null,ce=null,$e=null;function Qa(){return $e||($e=zt(()=>import("./reports.js"),__vite__mapDeps([0,1,2,3,4,5,6,7]),import.meta.url).then(e=>{try{typeof e.initReports=="function"&&e.initReports()}catch(t){console.error("❌ [tabs.js] Failed to initialise reports module",t)}return e}).catch(e=>{throw console.error("❌ [tabs.js] Failed to load reports module",e),$e=null,e})),$e}function Ya(){console.log("🚀 [tabs.js] setupTabs()");const e=Array.from(document.querySelectorAll("[data-tab]")),t=document.querySelectorAll(".tab-content-wrapper > .tab");console.log("📌 tabButtons:",e),console.log("📌 tabContents:",t);const n=(r,{skipStore:i=!1,skipRender:o=!1}={})=>{if(!r)return;const l=e.filter(m=>m?.getAttribute("data-tab")===r),p=document.getElementById(r);if(!(!l.length||!p)&&(e.forEach(m=>{const u=m?.getAttribute("data-tab")===r;m.classList.toggle("active",u),u?(m.setAttribute("aria-selected","true"),m.setAttribute("tabindex","0"),st(m)):(m.setAttribute("aria-selected","false"),m.setAttribute("tabindex","-1"))}),t.forEach(m=>{const u=m.id===r;m.style.display=u?"block":"none",m.classList.toggle("active",u)}),J=r,ot(rt,r),typeof document<"u"&&document.dispatchEvent(new CustomEvent("dashboard:tabChanged",{detail:{tabId:r}})),i||ve({dashboardTab:r}).catch(m=>{console.warn("⚠️ [tabs.js] Failed to store dashboard tab preference",m)}),r!=="reservations-tab"&&(F=null,L=null,mn(V),i||ve({dashboardSubTab:null}).catch(m=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",m)})),!o&&r==="customers-tab"&&(console.log("👤 Rendering customers"),Bn()),!o&&r==="equipment-tab"&&(console.log("📦 Rendering equipment"),ut()),!o&&r==="maintenance-tab"&&(console.log("🛠️ Rendering maintenance"),O()),!o&&r==="technicians-tab"&&(console.log("🛠️ Rendering technicians"),ta()),r==="reservations-tab")){if(console.log("📅 Rendering reservations"),o||qe(),!L){const m=te(V);L=F||m||Pe}Ka(),L&&(Me(L),L=null)}};ct=n,e.forEach(r=>{r&&(r.getAttribute("type")||r.setAttribute("type","button"),r.setAttribute("role","tab"),r.hasAttribute("tabindex")||r.setAttribute("tabindex",r.classList.contains("active")?"0":"-1"),r.addEventListener("click",()=>{const i=r.getAttribute("data-tab");if(console.log("🖱️ Tab clicked:",i),n(i),i==="reservations-tab"){const o=F||te(V)||Pe;typeof ae=="function"?ae(o):L=o}else ve({dashboardSubTab:null}).catch(o=>{console.warn("⚠️ [tabs.js] Failed to clear sub-tab preference",o)})}))});const a=r=>{const i=document.querySelector("[data-tab].active"),o=te(rt),l=e[0]?.getAttribute("data-tab")||null,m=[r?.dashboardTab,o,J,i?.getAttribute("data-tab"),l].filter(Boolean).find(b=>document.getElementById(b))||l;m&&(!ne||m!==J)&&(console.log("⭐ Initial tab:",m),n(m,{skipStore:!0}));const f=[r?.dashboardSubTab,te(V)].filter(Boolean).find(b=>document.getElementById(b));f&&(J==="reservations-tab"&&typeof ae=="function"?(!ne||f!==F)&&ae(f,{skipStore:!0}):L=f),ne||(document.body?.classList.remove("tabs-loading"),document.body?.classList.remove("no-js"),ne=!0)},s=typeof Ne=="function"?Ne():null;a(s||null),_n().then(r=>a(r||null)).catch(r=>{console.warn("⚠️ [tabs.js] Failed to load tab preferences",r),a(null)}),Mt||(Mt=wn(r=>{if(!(!ne||!r))if(r.dashboardTab&&r.dashboardTab!==J&&n(r.dashboardTab,{skipStore:!0}),J==="reservations-tab"){if(r.dashboardSubTab&&r.dashboardSubTab!==F)Me(r.dashboardSubTab);else if(!r.dashboardSubTab&&F){const i=te(V);i?i!==F&&Me(i):Me(null)}}else r.dashboardSubTab&&(L=r.dashboardSubTab)}))}function Ka(){console.log("🚀 [tabs.js] setupSubTabs()");const e=document.querySelectorAll("#reservations-tab .sub-tab-button"),t=document.querySelectorAll("#reservations-tab .sub-tab");if(console.log("📌 subTabButtons:",e),console.log("📌 subTabContents:",t),!e.length){console.warn("⚠️ [tabs.js] No reservation sub-tab buttons found");return}const n=Array.from(e).map(r=>r?.getAttribute("data-sub-tab")).filter(r=>typeof r=="string"&&r.trim().length>0),a=()=>n.length?n.includes(Pe)?Pe:n[0]:null,s=(r,{skipStore:i=!1}={})=>{if(!n.length)return;let o=r;(!o||!n.includes(o))&&(console.warn("⚠️ [tabs.js] Invalid sub-tab target, falling back to first available",{requested:o,available:n}),o=a());const l=document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${o}"]`),p=document.getElementById(o);if(!l||!p){console.warn("⚠️ [tabs.js] Unable to locate sub-tab button/content after fallback",{target:o});return}if(F===o&&l.classList.contains("active")&&p.classList.contains("active")&&p.getAttribute("aria-hidden")==="false"){p.removeAttribute("hidden"),p.style.display="block",p.setAttribute("aria-hidden","false"),F=o,st(l),i||(ot(V,o),ve({dashboardSubTab:o}).catch(u=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",u)}));return}e.forEach(u=>{u.classList.remove("active"),u.classList.contains("tab")&&u.classList.remove("tab-active"),u.setAttribute("aria-selected","false"),u.setAttribute("tabindex","-1")}),l.classList.add("active"),l.classList.contains("tab")&&l.classList.add("tab-active"),l.setAttribute("aria-selected","true"),l.setAttribute("tabindex","0"),st(l),t.forEach(u=>{const f=u.id===o;u.classList.toggle("active",f),u.setAttribute("aria-hidden",f?"false":"true"),f?(u.removeAttribute("hidden"),u.style.display="block"):(u.setAttribute("hidden",""),u.style.display="none")}),F=o,ot(V,o),i||ve({dashboardSubTab:o}).catch(u=>{console.warn("⚠️ [tabs.js] Failed to store sub-tab preference",u)}),typeof document<"u"&&document.dispatchEvent(new CustomEvent("reservations:subTabChanged",{detail:{subTabId:o}})),o==="my-reservations-tab"?(console.log("📋 Rendering reservations list"),setTimeout(()=>{qe()},50)):o==="calendar-tab"?(console.log("📅 Rendering calendar view"),setTimeout(()=>{je()},100)):o==="reports-tab"&&(console.log("📊 Rendering reports view"),Qa().then(u=>{const{renderReports:f}=u;setTimeout(()=>{try{f?.()}catch(b){console.error("❌ [tabs.js] Failed to render reports tab",b)}},50)}).catch(u=>{console.error("❌ [tabs.js] Unable to load reports tab",u)}))};if(ae=(r,i={})=>{r?s(r,i):(e.forEach(o=>{o.classList.remove("active"),o.classList.contains("tab")&&o.classList.remove("tab-active"),o.setAttribute("aria-selected","false"),o.setAttribute("tabindex","-1")}),t.forEach(o=>{o.classList.remove("active"),o.setAttribute("aria-hidden","true"),o.setAttribute("hidden",""),o.style.display="none"}),F=null,mn(V))},e.forEach(r=>{r.dataset.subTabListenerAttached||(r.addEventListener("click",()=>{const i=r.getAttribute("data-sub-tab");console.log("🖱️ Sub-tab clicked:",i),s(i)}),r.dataset.subTabListenerAttached="true")}),L)s(L,{skipStore:!0}),L=null;else{const r=document.querySelector("#reservations-tab .sub-tab-button.active"),i=a(),o=r?.getAttribute("data-sub-tab")||i;o&&(console.log("⭐ Initial sub-tab:",o),s(o,{skipStore:!0}))}Ot()}function Me(e){typeof ae=="function"?ae(e,{skipStore:!0}):e&&(L=e)}function Za(){try{if(typeof Ne=="function")return Ne()||{}}catch(e){console.warn("⚠️ [tabs.js] Failed to read cached preferences",e)}return{}}function Ja({attemptsLeft:e=0}={}){if(!ne||typeof ct!="function")return!1;const t=Za(),n=Array.from(document.querySelectorAll("[data-tab]"));if(!n.length)return!1;const a=n[0]?.dataset.tab||null,r=[J,document.querySelector("[data-tab].active")?.getAttribute("data-tab")||null,t.dashboardTab,te(rt),a].filter(Boolean).find(o=>document.getElementById(o));if(!r)return!1;const i=()=>{const o=document.querySelector(`[data-tab].active[data-tab="${r}"]`),l=document.getElementById(r);return!!(o&&l?.classList.contains("active")&&l?.style.display!=="none")};if(r==="reservations-tab"){const o=Array.from(document.querySelectorAll("#reservations-tab .sub-tab-button"));if(!o.length)return!1;const l=o[0]?.getAttribute("data-sub-tab")||null,m=[F,document.querySelector("#reservations-tab .sub-tab-button.active")?.getAttribute("data-sub-tab")||null,document.querySelector("#reservations-tab .sub-tab.active")?.id||null,t.dashboardSubTab,te(V),l].filter(Boolean).find(h=>document.getElementById(h)),u=document.querySelector("#reservations-tab .sub-tab-button.active"),f=document.querySelector("#reservations-tab .sub-tab.active"),b=f?.id||u?.getAttribute("data-sub-tab")||null;if(m&&b===m&&i())return f&&(f.removeAttribute("hidden"),f.style.display="block",f.setAttribute("aria-hidden","false")),!0;if(m)L=m;else if(e>0)return!1}else if(i())return!0;return ct(r,{skipStore:!0,skipRender:!0}),!0}function Et(){if(!ne)return;let e=0;const t=5;ce&&(clearTimeout(ce),ce=null);const n=()=>{if(Ja({attemptsLeft:t-e})){ce=null;return}if(e>=t){ce=null;return}e+=1,ce=setTimeout(n,50*(e+1))};n()}document.addEventListener("language:translationsReady",Et);document.addEventListener("language:changed",Et);document.addEventListener("theme:changed",Et);let C=[],N=[],Te=null,Q=!1,Rt=!1;const d={};function Xa(){d.form=document.getElementById("equipment-package-form"),d.hiddenId=document.getElementById("equipment-package-id"),d.nameInput=document.getElementById("equipment-package-name"),d.codeInput=document.getElementById("equipment-package-code"),d.priceInput=document.getElementById("equipment-package-price"),d.descriptionInput=document.getElementById("equipment-package-description"),d.openSelector=document.getElementById("equipment-package-open-selector"),d.selectionWrapper=document.getElementById("equipment-package-selection-active"),d.selectionCounter=document.getElementById("equipment-package-selection-counter"),d.applySelection=document.getElementById("equipment-package-apply-selection"),d.cancelSelection=document.getElementById("equipment-package-cancel-selection"),d.itemsTableBody=document.querySelector("#equipment-package-items-table tbody"),d.itemsEmptyMessage=document.getElementById("equipment-package-items-empty"),d.resetButton=document.getElementById("equipment-package-reset"),d.submitButton=document.getElementById("equipment-package-submit"),d.tableBody=document.getElementById("equipment-packages-table-body"),d.emptyRow=document.getElementById("equipment-packages-empty-row"),d.countBadge=document.getElementById("equipment-packages-count"),d.applySelection&&(d.applySelection.style.display="none")}function pn(){const{equipment:e=[]}=j()||{};return Array.isArray(e)?e:[]}function qt(){const e=new Map;return pn().forEach(t=>{const n=t?.id??t?.equipment_id??t?.equipmentId??null;n!=null&&e.set(String(n),t)}),e}function ei(){const e=new Map;return pn().forEach(t=>{const n=jt(t?.barcode);n&&!e.has(n)&&e.set(n,t)}),e}function fe(e,{persist:t=!1}={}){C=Array.isArray(e)?e.map(fn):[],oi(),t&&(xt({packages:C}),document.dispatchEvent(new CustomEvent("packages:changed",{detail:{packages:C}})))}function fn(e={}){const t=ti(e.items??e.equipment_ids??e.equipmentIds??[]);return{id:e.id!=null?String(e.id):"",package_code:e.package_code??e.code??e.slug??"",slug:e.slug??null,name:e.name??e.title??e.label??"",description:e.description??"",price:ni(e.price??e.total_price??e.package_price??0),is_active:ai(e.is_active??e.active??!0),items:t,created_at:e.created_at??null,updated_at:e.updated_at??null}}function ti(e){return Array.isArray(e)||(e=[]),e.map(t=>{if(t==null)return null;if(typeof t=="number"||typeof t=="string"){const n=String(t).trim();return n?{equipment_id:n,quantity:1,unit_price:null}:null}if(typeof t=="object"){const n=t.equipment_id??t.equipmentId??t.id??t.item_id??t.itemId??null;if(n==null)return null;const a=Number.isFinite(Number(t.quantity??t.qty))?Number(t.quantity??t.qty):1,s=Number.isFinite(Number(t.unit_price??t.price))?Number(t.unit_price??t.price):null;return{equipment_id:String(n),quantity:a>0?a:1,unit_price:s}}return null}).filter(Boolean)}function ni(e){const t=Number.parseFloat(e);return Number.isFinite(t)?Math.round(t*100)/100:0}function ai(e){if(e===!0||e===!1)return e;if(e==null)return!0;const t=String(e).trim().toLowerCase();return!(t==="0"||t==="false"||t==="no")}function ii(e){const t=e?.quantity??e?.qty??1,n=Number.parseFloat(g(String(t)));return!Number.isFinite(n)||n<=0?1:n}function ri(e,t){const n=[e?.unit_price,e?.price];for(const s of n){if(s==null)continue;const r=Number.parseFloat(g(String(s)));if(Number.isFinite(r))return r}const a=e?.equipment_id??e?.equipmentId??e?.id;if(a!=null&&t instanceof Map){const s=t.get(String(a));if(s&&typeof s=="object"){const r=[s.unit_price,s.unitPrice,s.price,s.daily_rate,s.dailyRate];for(const i of r){if(i==null)continue;const o=Number.parseFloat(g(String(i)));if(Number.isFinite(o))return o}}}return 0}function si(e=null){const t=e instanceof Map?e:qt();return N.reduce((n,a)=>{const s=ii(a),r=ri(a,t),i=Number.isFinite(s)&&s>0?s:1,o=Number.isFinite(r)&&r>0?r:0;return n+i*o},0)}function Ft(e){const t=d.priceInput;if(!t)return;const n=t.dataset.autoCalculated==="false",a=!!(t.value&&t.value.trim());if(n&&a)return;if(!Number.isFinite(e)||N.length===0){t.value="",t.dataset.autoCalculated="true";return}const s=e<0?0:e,r=Math.round(s*100)/100,i=Number.isInteger(r)?String(r):r.toFixed(2);t.value=i,t.dataset.autoCalculated="true"}function ke(){if(!d.itemsTableBody||!d.itemsEmptyMessage)return;if(N.length===0){d.itemsTableBody.innerHTML="",d.itemsEmptyMessage.hidden=!1,Ft(0);return}const e=qt(),t=N.map((a,s)=>{const r=e.get(String(a.equipment_id)),i=r?.desc||r?.name||c("equipment.packages.items.unknown","معدة بدون اسم"),o=r?.barcode?g(String(r.barcode)):"",l=g(String(a.quantity??1)),p=o?`${i} — ${o}`:i;return`
      <tr data-package-item-index="${s}">
        <td>${p}</td>
        <td>${l}</td>
        <td>
          <button type="button" class="btn btn-outline-danger btn-sm" data-action="remove-item" data-index="${s}">🗑️</button>
        </td>
      </tr>
    `});d.itemsTableBody.innerHTML=t.join(""),d.itemsEmptyMessage.hidden=!0;const n=si(e);Ft(n)}function oi(){if(!d.tableBody||!d.emptyRow)return;if(!C.length){d.tableBody.innerHTML="",d.tableBody.appendChild(d.emptyRow),d.emptyRow.hidden=!1,d.countBadge&&(d.countBadge.textContent="0");return}const e=qt(),t=C.map(n=>{const a=na({...n,items:n.items}),s=a.map(o=>{const l=e.get(String(o.equipmentId??o.equipment_id)),p=l?.desc||l?.name||o.desc||c("equipment.packages.items.unknown","معدة بدون اسم"),m=g(String(o.qty??o.quantity??1)),u=o.barcode||l?.barcode,f=u?` (${g(String(u))})`:"";return`<li>${p}${f} × ${m}</li>`}),r=a.reduce((o,l)=>o+(Number(l.qty??l.quantity??1)||0),0),i=`${g(n.price.toFixed(2))} ${c("reservations.create.summary.currency","SR")}`;return`
      <tr data-package-id="${n.id}">
        <td>${n.name||"—"}</td>
        <td>${n.package_code||"—"}</td>
        <td>${i}</td>
        <td>
          <details>
            <summary>${g(String(r||0))}</summary>
            <ul class="equipment-package-items-summary">${s.join("")}</ul>
          </details>
        </td>
        <td>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-primary" data-action="edit-package" data-id="${n.id}">✏️</button>
            <button type="button" class="btn btn-sm btn-outline-danger" data-action="delete-package" data-id="${n.id}">🗑️</button>
          </div>
        </td>
      </tr>
    `});d.tableBody.innerHTML=t.join(""),d.emptyRow.hidden=!0,d.countBadge&&(d.countBadge.textContent=g(String(C.length)))}function bn(){Te=null,N=[],d.hiddenId&&(d.hiddenId.value=""),d.nameInput&&(d.nameInput.value=""),d.codeInput&&(d.codeInput.value=""),d.priceInput&&(d.priceInput.value="",d.priceInput.dataset.autoCalculated="true"),d.descriptionInput&&(d.descriptionInput.value=""),d.submitButton&&(d.submitButton.textContent=c("equipment.packages.form.actions.save","💾 حفظ الحزمة")),ke(),G(!1)}function ci(e){Te=e.id||null,N=e.items.map(t=>({...t})),d.hiddenId&&(d.hiddenId.value=Te||""),d.nameInput&&(d.nameInput.value=e.name||""),d.codeInput&&(d.codeInput.value=e.package_code||""),d.priceInput&&(d.priceInput.value=e.price!=null?String(e.price):"",d.priceInput.dataset.autoCalculated=e.price!=null?"false":"true"),d.descriptionInput&&(d.descriptionInput.value=e.description||""),d.submitButton&&(d.submitButton.textContent=c("equipment.packages.form.actions.update","💾 تحديث الحزمة")),ke(),G(!1)}function G(e=Q){Q=e,d.selectionWrapper&&(Q?d.selectionWrapper.hidden=!1:d.selectionWrapper.hidden=!0),d.openSelector&&(d.openSelector.disabled=Q),d.cancelSelection&&(d.cancelSelection.disabled=!Q),gn()}function gn(){if(d.selectionCounter){if(!Q){d.selectionCounter.textContent=c("equipment.packages.selection.counter","لم يتم اختيار عناصر بعد.");return}d.selectionCounter.textContent=c("equipment.packages.selection.autoMode","أي معدة تختارها ستُضاف مباشرة إلى الحزمة. استخدم زر إلغاء للخروج من وضع الاختيار.")}}function li(e){const t=e?.detail||{},n=!!t.active,a=t.selection||t.previous||{},s=a?.mode||a?.source||"";if(s!=="package-manager"&&s!=="equipment-packages"){!n&&Q&&(G(!1),lt());return}if(n){G(!0);return}G(!1),lt()}function di(e){const t=e?.detail;if(!t)return;const n=t.selection||{},a=n?.mode||n?.source||"";if(a!=="package-manager"&&a!=="equipment-packages")return;const s=Array.isArray(t.barcodes)?t.barcodes:[],r=Number.isInteger(t.quantity)&&t.quantity>0?t.quantity:1,i=s.length?s:t.barcode?[t.barcode]:[];if(!i.length)return;const o=ei(),l=[],p=new Set;i.forEach(b=>{const h=jt(b);h&&!p.has(h)&&(p.add(h),l.push(h))});const m=Math.min(l.length,r);let u=0;const f=[];for(let b=0;b<m;b+=1){const h=l[b],E=o.get(h);if(!E)continue;const w=E?.id??E?.equipment_id??E?.equipmentId??null;if(w==null)continue;const z=E?.desc||E?.name||h,M=N.find(H=>H.equipment_id===String(w));M?M.quantity+=1:N.push({equipment_id:String(w),quantity:1,unit_price:Number.isFinite(Number(E?.price))?Number(E.price):null}),u+=1,f.push(z)}if(u>0){ke(),gn();const b=u===1?c("equipment.packages.selection.itemAddedSingle","✅ تمت إضافة {name} إلى الحزمة"):c("equipment.packages.selection.itemAddedMulti","✅ تمت إضافة {count} معدات إلى الحزمة"),h=u===1?b.replace("{name}",f[0]||""):b.replace("{count}",g(String(u)));v(h)}else v(c("equipment.packages.selection.noMatch","⚠️ تعذر ربط المعدات المختارة بالحزم، تحقق من بيانات المعدات"),4e3)}function ui(){G(!1),Un("package-cancel"),lt()}function lt(){d.form&&(d.form.scrollIntoView({behavior:"smooth",block:"start"}),setTimeout(()=>{d.nameInput?.focus()},200))}function Ye(e){const t=d.priceInput;if(!t)return;const n=t.value;if(n==null)return;const a=n.replace(/[\u066B\u066C\u060C،,]/gu,".");let r=g(a).replace(/[^0-9.]/gu,"");const i=r.indexOf(".");if(i!==-1){const o=r.slice(0,i+1),l=r.slice(i+1).replace(/\./g,"");r=`${o}${l}`}if(r!==n&&(t.value=r,typeof t.setSelectionRange=="function")){const o=r.length;try{t.setSelectionRange(o,o)}catch{}}e?.type==="input"&&(t.dataset.autoCalculated=r.trim()?"false":"true")}function mi(){const e=d.nameInput?.value.trim(),t=d.codeInput?.value.trim(),n=d.descriptionInput?.value.trim()??"",a=d.priceInput?.value??"",s=Number.parseFloat(g(a));if(!e)return v(c("equipment.packages.validation.nameRequired","⚠️ يرجى إدخال اسم الحزمة")),null;if(!t)return v(c("equipment.packages.validation.codeRequired","⚠️ يرجى إدخال كود الحزمة")),null;if(!N.length)return v(c("equipment.packages.validation.itemsRequired","⚠️ أضف عنصرًا واحدًا على الأقل للحزمة")),null;const r=N.map(i=>({equipment_id:i.equipment_id,quantity:Number.isFinite(Number(i.quantity))?Number(i.quantity):1,unit_price:i.unit_price!=null&&Number.isFinite(Number(i.unit_price))?Number(i.unit_price):null}));return{package_code:t,name:e,description:n,price:Number.isFinite(s)?s:0,is_active:!0,items:r}}async function pi(e){if(e.preventDefault(),!d.form)return;const t=mi();if(t)try{let n;Te?(n=await K(`/packages/?id=${encodeURIComponent(Te)}`,{method:"PATCH",body:t}),v(c("equipment.packages.toast.updated","✅ تم تحديث الحزمة بنجاح"))):(n=await K("/packages/",{method:"POST",body:t}),v(c("equipment.packages.toast.created","✅ تم إنشاء الحزمة بنجاح")));const a=fn(n?.data??n),s=C.findIndex(r=>r.id===a.id);s>=0?C.splice(s,1,a):C=[a,...C],fe(C,{persist:!0}),bn()}catch(n){console.error("[equipmentPackagesManager] handlePackageSubmit error",n);const a=n?.message||c("equipment.packages.toast.saveFailed","❌ تعذر حفظ الحزمة");v(a,4e3)}}function fi(e){const t=e.target.closest('[data-action="remove-item"]');if(!t)return;const n=Number(t.dataset.index);Number.isNaN(n)||(N=N.filter((a,s)=>s!==n),ke())}async function bi(e){const t=e.target.closest('[data-action="edit-package"]');if(t){const a=t.dataset.id;if(!a)return;const s=C.find(r=>r.id===a);if(!s)return;ci(s);return}const n=e.target.closest('[data-action="delete-package"]');if(n){const a=n.dataset.id;if(!a||!window.confirm(c("equipment.packages.confirm.delete","هل أنت متأكد من حذف الحزمة؟")))return;try{await K(`/packages/?id=${encodeURIComponent(a)}`,{method:"DELETE"}),C=C.filter(r=>r.id!==a),fe(C,{persist:!0}),v(c("equipment.packages.toast.deleted","🗑️ تم حذف الحزمة بنجاح"))}catch(r){console.error("[equipmentPackagesManager] delete package error",r),v(c("equipment.packages.toast.deleteFailed","❌ تعذر حذف الحزمة"),4e3)}}}async function gi(){try{const e=await K("/packages/?all=1"),t=Array.isArray(e?.data)?e.data:Array.isArray(e)?e:[];fe(t,{persist:!0})}catch(e){console.warn("[equipmentPackagesManager] Failed to fetch packages from API, falling back to cache",e);const{packages:t=[]}=j()||{};fe(t,{persist:!1})}}function yi(){const{packages:e=[]}=j()||{};Array.isArray(e)&&e.length?fe(e,{persist:!1}):fe([],{persist:!1}),ke(),G(!1)}function vi(){if(Q){G(!0);return}G(!0),Vn({mode:"package-manager",source:"equipment-packages",activatedAt:Date.now()});const e=document.querySelector('[data-tab="equipment-tab"]');e&&e.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.getElementById("search-equipment")?.focus();const t=document.getElementById("equipment-list");t&&t.scrollIntoView({behavior:"smooth",block:"start"})},200)})}function hi(){d.form&&(d.form.addEventListener("submit",pi),d.itemsTableBody?.addEventListener("click",fi),d.resetButton?.addEventListener("click",()=>{bn()}),d.tableBody?.addEventListener("click",bi),d.openSelector?.addEventListener("click",e=>{e.preventDefault(),vi()}),d.cancelSelection?.addEventListener("click",e=>{e.preventDefault(),ui()}),d.priceInput&&!d.priceInput.dataset.normalizedAttached&&(d.priceInput.addEventListener("input",Ye),d.priceInput.addEventListener("blur",Ye),d.priceInput.dataset.normalizedAttached="true",Ye()),Rt||(document.addEventListener(wt.change,li),document.addEventListener(wt.requestAdd,di),Rt=!0))}function Si(){typeof document>"u"||(Xa(),d.form&&(yi(),hi(),gi()))}Tn();let A=null,Re=null,Fe=null;function Ei(){return Fe||(Fe=zt(()=>import("./dashboardMetrics.js"),__vite__mapDeps([8,1,2]),import.meta.url).then(e=>{try{typeof e.initDashboardMetrics=="function"&&e.initDashboardMetrics()}catch(t){console.error("❌ Failed to initialise dashboard metrics",t)}return e}).catch(e=>{throw console.error("❌ Failed to load dashboard metrics module",e),Fe=null,e})),Fe}function qi(){const e=()=>{Ei()};typeof window<"u"&&typeof window.requestIdleCallback=="function"?window.requestIdleCallback(()=>{e()},{timeout:1500}):setTimeout(e,0)}async function Nt(){if(!await An())return;Ln(),Ya(),kn(),ut(),Si(),Wn(),je(),Ga(),await la(),qi();const t=document.getElementById("excel-upload");t&&t.addEventListener("change",async a=>{const s=a.target.files&&a.target.files[0];s&&(await Gn(s),a.target.value="")});const n=document.getElementById("excel-upload-trigger");n&&t&&n.addEventListener("click",a=>{a.preventDefault(),t.click()}),document.getElementById("logout-btn")?.addEventListener("click",Cn),Ii(),_i()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{Nt().catch(e=>{console.error("❌ Failed to initialise app",e)})},{once:!0}):Nt().catch(e=>{console.error("❌ Failed to initialise app",e)});function Ii(){document.querySelectorAll('input[type="datetime-local"]').forEach(e=>{e.addEventListener("input",()=>{const t=e.value;if(!t.includes("T"))return;const[n,a]=t.split("T"),[s]=a.split(":"),r=`${s.padStart(2,"0")}:00`,i=`${n}T${r}`;e.value!==i&&(e.value=i,setTimeout(()=>e.blur(),150))})})}function _i(){const e=new URLSearchParams(window.location.search),t=e.get("reservationEditId"),n=e.get("reservationEditIndex");if(!t&&!n)return;A={reservationId:t,reservationIndex:n!=null?Number(n):null},yn(),e.delete("reservationEditId"),e.delete("reservationEditIndex");const a=e.toString(),s=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;window.history.replaceState({},document.title,s)}function wi(e){const t=document.getElementById(e);return!!(t?.classList.contains("active")&&t?.style.display!=="none")}function Ti(e){return new Promise(t=>{if(wi(e)){t();return}const n=s=>{s?.detail?.tabId===e&&(document.removeEventListener("dashboard:tabChanged",n),t())};document.addEventListener("dashboard:tabChanged",n),document.querySelector(`[data-tab="${e}"]`)?.click()})}function Ai(e){const t=document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${e}"]`),n=document.getElementById(e);return!!(t?.classList.contains("active")&&n?.classList.contains("active")&&n?.getAttribute("aria-hidden")==="false")}function ki(e){return new Promise(t=>{if(Ai(e)){t();return}const n=s=>{s?.detail?.subTabId===e&&(document.removeEventListener("reservations:subTabChanged",n),t())};document.addEventListener("reservations:subTabChanged",n),document.querySelector(`#reservations-tab .sub-tab-button[data-sub-tab="${e}"]`)?.click()})}async function Ci(){const e=Qn("openReservationEditor");if(typeof e=="function")return e;const t=await Yn("openReservationEditor");if(typeof t=="function")return t;throw new Error("Reservation editor handler is unavailable")}async function yn(){if(!A)return;if(Re)return Re;const e=(async()=>{const n=j().reservations||[];let a=null;if(A.reservationId){const o=n.findIndex(l=>String(l?.id)===A.reservationId||String(l?.reservationId)===A.reservationId);o!==-1&&(a=o)}if(a===null&&typeof A.reservationIndex=="number"&&!Number.isNaN(A.reservationIndex)&&A.reservationIndex>=0&&A.reservationIndex<n.length&&(a=A.reservationIndex),a===null)return;const s="my-reservations-tab",r="reservations-tab",i=A;A=null;try{await Ti(r),await ki(s);const o=await Ci();typeof o=="function"?o(a):(console.warn("⚠️ Pending reservation edit skipped: editor is not available"),A=i)}catch(o){console.error("❌ Failed to open pending reservation editor",o),A=i}})();Re=e;try{await e}finally{Re=null}}document.addEventListener("reservations:changed",()=>{A&&yn()});export{bt as m};
