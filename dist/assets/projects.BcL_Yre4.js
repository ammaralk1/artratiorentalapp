const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./print.v0yztiJa.js","./calculations.MYeLSaN3.js","./reservationsService.KzI_jRxb.js","./auth.BLFzWQsL.js","./auth.DwoC9zDp.css","./state.BK2rhNHf.js","./dashboard.COFM-6a3.js","./projectDetails.1YcLPkzK.js","./projectsService.Do5PYtuQ.js","./uiBridge.DRZiKs3I.js","./reservationPdf.DKd_B3O1.js","./view.BB6KfxzD.js","./quotePdf.kDBbUcue.js","./canvasColorUtils.CviLtv6S.js","./customers.Do_b30uX.js","./controller.uKq3TtLp.js","./details.CAwHdUf5.js","./reservationsActions.CvTfoS1u.js","./dashboardShell.DF2kUed9.js"])))=>i.map(i=>d[i]);
import{s as Ea,f as Ca,e as _r,u as Tr,j as Bt,t as O,p as wt,b as Lt,q as Sa,a as Aa,m as _a,c as Ta,i as La,d as Pa,n as Qt}from"./auth.BLFzWQsL.js";import"./dashboard.COFM-6a3.js";import{o as Be,s as Ia,c as Na,r as Lr,i as Ba,b as Ma,a as ka,d as Ra,e as Da,f as qa,g as ja,h as Fa,j as $a,k as Oa,l as Ha,m as Pr,n as vn,p as za,q as ze,t as Ua,u as Wa,v as Va}from"./projectDetails.1YcLPkzK.js";import"./customers.Do_b30uX.js";import{h as we,i as $n,j as On,k as Xa,r as Ya}from"./state.BK2rhNHf.js";import{r as Ga}from"./controller.uKq3TtLp.js";import{i as Ka}from"./dashboardShell.DF2kUed9.js";import{e as Ir}from"./reservationsActions.CvTfoS1u.js";import{refreshProjectsFromApi as Ae,getProjectsState as ie,ensureProjectsLoaded as Za,isApiError as Nr}from"./projectsService.Do5PYtuQ.js";import{d as Q,s as it,r as de,a as ue,u as _e,P as xn,b as En,c as Hn,e as sn,g as cn,h as zn}from"./view.BB6KfxzD.js";import{_ as Un}from"./uiBridge.DRZiKs3I.js";import{g as Cn,r as Br,d as ve}from"./reservationsService.KzI_jRxb.js";import{l as Mr,e as Ja,a as Qa,c as to}from"./calculations.MYeLSaN3.js";import"./canvasColorUtils.CviLtv6S.js";import"./reservationPdf.DKd_B3O1.js";import"./quotePdf.kDBbUcue.js";import"./details.CAwHdUf5.js";let Wn=null;function eo(t){t&&kr()!==t&&Tr({[xn]:t}).catch(e=>{console.warn("⚠️ [projects] Failed to persist projects main tab preference",e)})}function kr(){return _r()?.[xn]||""}function Sn(t){t&&qe()!==t&&Tr({[En]:t}).catch(e=>{console.warn("⚠️ [projects] Failed to persist projects sub-tab preference",e)})}function qe(){return _r()?.[En]||""}function no(t){if(!t)return"";const e=t.trim();return e?Object.values(Hn).includes(e)?e:Hn[e]||"":""}function Rr(){if(typeof window>"u")return"";try{const e=new URLSearchParams(window.location.search||"").get("subTab");if(e){const n=no(e);if(n)return n}}catch{}return""}function Dr(t,e){!t||!Q.tabPanes||!Q.tabButtons||(Q.tabButtons.forEach(n=>{const r=n===e;n.classList.toggle("active",r),n.classList.contains("tab-button")&&n.classList.toggle("tab-active",r)}),Q.tabPanes.forEach(n=>{n.dataset.tabPane===t?n.classList.remove("d-none"):n.classList.add("d-none")}),e&&eo(t))}function ro(){if(!Q.tabButtons||!Q.tabButtons.length)return;Q.tabButtons.forEach(n=>{n.dataset.tabListenerAttached!=="true"&&(n.addEventListener("click",r=>{r.preventDefault();const o=n.dataset.tabTarget;o&&(Dr(o,n),o==="projects-section"&&(it.filters.search="",Q.search&&(Q.search.value=""),de(),ue(),_e()))}),n.dataset.tabListenerAttached="true")});const t=kr(),e=t&&Q.tabButtons.find(n=>n.dataset.tabTarget===t);e&&e.click()}async function Ue(t,e){if(!(!t||!Q.projectSubTabButtons||!Q.projectSubTabPanes)&&(Q.projectSubTabButtons.forEach(n=>{const r=n===e;n.classList.toggle("active",r),n.classList.contains("tab")&&n.classList.toggle("tab-active",r)}),Q.projectSubTabPanes.forEach(n=>{n.dataset.projectSubtab===t?n.classList.remove("d-none"):n.classList.add("d-none")}),t==="projects-list-tab"))try{(!Array.isArray(it.projects)||it.projects.length===0)&&await Ae(),de(),ue(),_e()}catch(n){console.warn("[projects] Failed to render list after sub-tab switch",n)}}function ao(){!Q.projectSubTabButtons||!Q.projectSubTabButtons.length||(Q.projectSubTabButtons.forEach(t=>{t.dataset.tabListenerAttached!=="true"&&(t.addEventListener("click",async e=>{e.preventDefault();const n=t.dataset.projectSubtabTarget;n&&(await Ue(n,t),Sn(n))}),t.dataset.tabListenerAttached="true")}),oo())}function oo(){const e=Rr()||qe();if(!e)return;const n=Q.projectSubTabButtons?.[0],r=Q.projectSubTabButtons?.find(s=>s.dataset.projectSubtabTarget===e)||n,o=r?.dataset.projectSubtabTarget;o&&(e!==qe()&&Sn(o),Ue(o,r))}function so(){return Q.tabButtons?Q.tabButtons.find(e=>e.classList.contains("active"))?.dataset.tabTarget==="projects-section":!1}function Vn(t={}){if(t){if(Q.tabButtons&&Q.tabButtons.length){const n=Q.tabButtons.find(o=>o.classList.contains("active"))?.dataset.tabTarget||"",r=t[xn];if(r&&r!==n){const o=Q.tabButtons.find(s=>s.dataset.tabTarget===r);o&&Dr(r,o)}}if(Q.projectSubTabButtons&&Q.projectSubTabButtons.length&&so()){const n=Q.projectSubTabButtons.find(o=>o.classList.contains("active"))?.dataset.projectSubtabTarget||"",r=t[En];if(r&&r!==n){const o=Q.projectSubTabButtons.find(s=>s.dataset.projectSubtabTarget===r);o&&Ue(r,o)}}}}function co(){Wn||(Wn=Ea(t=>{Vn(t)})),Ca().then(t=>{Vn(t)}).catch(t=>{console.warn("⚠️ [projects] Failed to synchronise project preferences",t)})}function An(t){if(typeof window>"u")return null;try{const r=new URLSearchParams(window.location.search||"").get(t);if(r)return r}catch{}const e=window.location.hash?window.location.hash.replace(/^#/,""):"";if(e&&e.includes(`${t}=`))try{const r=new URLSearchParams(e).get(t);if(r)return r}catch{}return null}function lo(){return An(sn)}function io(){return An(cn)}function uo(){if(!(typeof window>"u"||typeof window.history?.replaceState!="function"))try{const t=new URLSearchParams(window.location.search||""),e=window.location.hash?window.location.hash.replace(/^#/,""):"";let n=!1;[sn,cn,"linked"].forEach(a=>{t.has(a)&&(t.delete(a),n=!0)});let r=e,o=!1;if(e)try{const a=new URLSearchParams(e);let u=!1;[sn,cn,"linked"].forEach(d=>{a.has(d)&&(a.delete(d),u=!0)}),u&&(r=a.toString(),o=!0)}catch{}if(!n&&!o)return;const s=window.location.pathname,c=t.toString(),i=`${s}${c?`?${c}`:""}${r?`#${r}`:""}`;window.history.replaceState({},"",i)}catch{}}function po(){const t=lo(),e=io(),n=An("linked");t&&(it.pendingProjectDetailId=t),e&&(it.pendingProjectEditId=e,it.pendingProjectDetailId||(it.pendingProjectDetailId=e)),n!=null&&String(n)!==""&&String(n)!=="0"&&String(n).toLowerCase()!=="false"&&(it.pendingLinkedToast=!0),(t||e)&&uo()}function mo(){if(!it.pendingProjectDetailId)return;const t=it.pendingProjectDetailId,e=String(t),n=it.projects.find(o=>[o?.id,o?.projectId,o?.project_id].some(c=>c!=null&&String(c)===e));if(!n)return;it.pendingProjectDetailId=null;const r=n?.id??n?.projectId??n?.project_id??e;if(Be(r),it.pendingLinkedToast){it.pendingLinkedToast=!1;try{Bt(O("projects.toast.linkedReservationCreated","✅ تم ربط الحجز بالمشروع"))}catch{}}if(it.pendingProjectEditId!=null){const o=String(it.pendingProjectEditId);[n.id,n.projectId,n.project_id].some(c=>c!=null&&String(c)===o)&&(it.pendingProjectEditId=null,setTimeout(()=>Ia(n),0))}}let Ke=null;function _n(){return typeof window<"u"&&window.XLSX&&window.XLSX.utils?Promise.resolve(window.XLSX):(Ke||(Ke=Mr("https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js").then(()=>window.XLSX)),Ke)}function ae(t){const e=String(t||"").replace("#","");return e.length===3?e.split("").map(n=>n+n).join("").toUpperCase():e.slice(0,6).toUpperCase()}function je(t="#9CA3AF"){const e={rgb:ae(t)};return{top:{style:"thin",color:e},right:{style:"thin",color:e},bottom:{style:"thin",color:e},left:{style:"thin",color:e}}}function Xn(t){const e=Array.from(t.querySelectorAll("tr")),n=[];return e.forEach((r,o)=>{const s=Array.from(r.children),c=[];s.forEach(i=>{const a=(i.tagName||"").toLowerCase(),u=(i.textContent||"").replace(/\u00A0/g," ").trim(),l=a==="th"||i.classList.contains("cs-crew-title")||i.classList.contains("cs-cast-title")?{font:{bold:!0,color:{rgb:ae("#FFFFFF")}},fill:{patternType:"solid",fgColor:{rgb:ae("#2563EB")}},alignment:{horizontal:"center",vertical:"center",wrapText:!0},border:je("#9CA3AF")}:{alignment:{horizontal:"center",vertical:"center",wrapText:!0},border:je("#CBD5E1")};c.push({v:u,s:l})}),n.push(c)}),n}function Tn(t){t["!merges"]||(t["!merges"]=[]),t["!cols"]||(t["!cols"]=[])}function qr(t,e,n){const r=window.XLSX,o=t["!ref"];if(!o){t["!ref"]=r.utils.encode_range({s:{r:e,c:n},e:{r:e,c:n}});return}const s=r.utils.decode_range(o);e>s.e.r&&(s.e.r=e),n>s.e.c&&(s.e.c=n),e<s.s.r&&(s.s.r=e),n<s.s.c&&(s.s.c=n),t["!ref"]=r.utils.encode_range(s)}function qt(t,e,n,r,o){const c=window.XLSX.utils.encode_cell({r:e,c:n}),i=typeof r=="number"?"n":"s";t[c]={v:r??"",t:i,s:o||{}},qr(t,e,n)}function Ht(t,e,n,r,o){Tn(t),t["!merges"].push({s:{r:e,c:n},e:{r,c:o}})}function Ie(t,e,n,r,o){let s=0,c=0;for(let i=0;i<e.length;i+=1){const a=e[i]||[];c=Math.max(c,a.length);for(let u=0;u<a.length;u+=1){const d=a[u],l=d&&typeof d=="object"&&"v"in d?d.v:d,p=d&&typeof d=="object"&&d.s?d.s:o||{};qt(t,n+i,r+u,l,p)}}return s=e.length,{rows:s,cols:c}}function ho(t,e=[]){Tn(t),t["!cols"]=e.map(n=>({wch:n}))}async function fo(t){const e=await _n(),n=e.utils.book_new(),r={};Tn(r);const o=[5,5,25,6,5,5,6,4,4,10,8,17],s=o.reduce((A,k)=>A+k,0),c=120,i=o.map(A=>Math.max(5,Math.round(A/s*c)));ho(r,i);const a={alignment:{horizontal:"center",vertical:"center",wrapText:!0}},u={alignment:{horizontal:"left",vertical:"top",wrapText:!0}},d=je("#CBD5E1"),l=je("#9CA3AF"),p={...a,border:d},m={...u,border:d},h={font:{bold:!0,color:{rgb:ae("#FFFFFF")},sz:12},fill:{patternType:"solid",fgColor:{rgb:ae("#2563EB")}},alignment:{horizontal:"center",vertical:"center",wrapText:!0},border:l},y=A=>t&&t.querySelector(A);let g=0;const E=(y(".callsheet-v1 .cs-brand")?.textContent||"").trim(),I=(y(".callsheet-v1 .cs-date")?.textContent||"").trim(),x=(y(".callsheet-v1 .cs-title")?.textContent||"CALL SHEET").trim();qt(r,g,0,E||""),Ht(r,g,0,g,11),r[e.utils.encode_cell({r:g,c:0})].s={font:{bold:!0,sz:20},...a},g+=1,qt(r,g,0,I||""),Ht(r,g,0,g,11),r[e.utils.encode_cell({r:g,c:0})].s={font:{bold:!0,sz:12},...a},g+=1,qt(r,g,0,x),Ht(r,g,0,g,11),r[e.utils.encode_cell({r:g,c:0})].s={font:{bold:!0,sz:14},...a},g+=2,r["!rows"]=r["!rows"]||[],r["!rows"][0]={hpt:26},r["!rows"][1]={hpt:18},r["!rows"][2]={hpt:20};const C=[];try{Array.from(y(".callsheet-v1 .cs-roles tbody")?.querySelectorAll("tr")||[]).forEach(A=>{const k=Array.from(A.children),H=(k[0]?.textContent||"").trim(),F=(k[1]?.textContent||"").trim();C.push([{v:H,s:{...p,font:{bold:!0}}},{v:F,s:p}])})}catch{}const f=[];try{Array.from(y(".callsheet-v1 .cs-times tbody")?.querySelectorAll("tr")||[]).forEach(A=>{const k=Array.from(A.children);f.push([{v:(k[0]?.textContent||"").trim(),s:{...p,font:{bold:!0}}},{v:(k[1]?.textContent||"").trim(),s:p}])})}catch{}const v=[];try{const A=(y(".callsheet-v1 .cs-notes-h")?.textContent||"Important Notes").trim(),k=(y(".callsheet-v1 .cs-notes")?.textContent||"").replace(/\n+/g,`
`).trim(),H=(y(".callsheet-v1 .cs-section")?.textContent||"Locations").trim(),F=(y(".callsheet-v1 .cs-locations")?.textContent||"").trim();v.push([{v:A,s:h}]),v.push([{v:k,s:m}]),v.push([{v:H,s:h}]),v.push([{v:F,s:m}])}catch{}const T=g,P=Ie(r,C,T,0,p).rows,L=Ie(r,f,T,8,p).rows;for(let A=0;A<v.length;A+=1){const k=T+A,H=v[A][0];qt(r,k,4,H.v,H.s),Ht(r,k,4,k,7)}const _=Math.max(P,v.length,L),R=(A,k,H,F)=>{const Y="medium";for(let G=A;G<=H;G+=1)for(let K=k;K<=F;K+=1){const z=e.utils.encode_cell({r:G,c:K}),V=r[z]||{v:"",t:"s",s:{}},at=V.s.border||{},st={rgb:ae("#9CA3AF")};G===A&&(at.top={style:Y,color:st}),G===H&&(at.bottom={style:Y,color:st}),K===k&&(at.left={style:Y,color:st}),K===F&&(at.right={style:Y,color:st}),V.s.border={...V.s.border,...at},r[z]=V,qr(r,G,K)}};P>0&&R(T,0,T+P-1,3),v.length>0&&R(T,4,T+v.length-1,7),L>0&&R(T,8,T+L-1,11),g=T+_+2;const D=y(".callsheet-v1 .cs-cast");if(D){const A=g;qt(r,g,0,"Cast Calls",h),Ht(r,g,0,g,11),g+=1;const k=Xn(D).slice(1),H=Ie(r,k,g,2,p);R(A,2,g+H.rows-1,9),r["!rows"][A]={hpt:22},g+=H.rows+2}const N=y(".callsheet-v1 .cs-crew");if(N){const A=g;qt(r,g,0,"Crew Call",h),Ht(r,g,0,g,11),r["!rows"][g]={hpt:22},g+=1;const k=[[0,2],[3,7],[8,10],[11,11]];["Position","Name","Phone","Time"].forEach((F,Y)=>{const[G,K]=k[Y];qt(r,g,G,F,h),K>G&&Ht(r,g,G,g,K)}),r["!rows"][g]={hpt:18},g+=1,Array.from(N.querySelectorAll("tbody tr")).forEach(F=>{const Y=Array.from(F.children);[0,1,2,3].map(K=>(Y[K]?.textContent||"").trim()).forEach((K,z)=>{const[V,at]=k[z];qt(r,g,V,K,z===1?m:p),at>V&&Ht(r,g,V,g,at)}),g+=1}),R(A,0,g-1,11),g+=2}const b=y(".callsheet-v1 .cs-schedule");if(b){const A=Xn(b),k=Ie(r,A,g,0,p);R(g,0,g+k.rows-1,11),r["!rows"][g]={hpt:18},g+=k.rows+1}e.utils.book_append_sheet(n,r,"Call Sheet");let M="CallSheet.xlsx";try{const A=(document.querySelector("#templates-save-title")?.value||"").trim();A&&(M=`${A}-CallSheet.xlsx`)}catch{}const q=e.write(n,{bookType:"xlsx",type:"array"}),B=new Blob([q],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),j=URL.createObjectURL(B),X=document.createElement("a");X.href=j,X.download=M,document.body.appendChild(X),X.click(),X.remove(),URL.revokeObjectURL(j)}function yo(t,e){try{if(!t)return;const n=(localStorage.getItem("templates.debugOverlay")||"")==="1";let r=document.getElementById("tpl-debug-overlay");if(!n){r&&r.remove();return}r||(r=document.createElement("div"),r.id="tpl-debug-overlay",Object.assign(r.style,{position:"absolute",top:"8px",left:"8px",background:"rgba(17,24,39,0.85)",color:"#fff",padding:"8px 10px",font:"12px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto",borderRadius:"8px",zIndex:"9999",maxWidth:"36vw",direction:"ltr",textAlign:"left"}),t.appendChild(r));const o=[],s=Array.isArray(e?.crewAssignments)?e.crewAssignments:[],c=Array.isArray(e?.techniciansDetails)?e.techniciansDetails:[],i=Array.isArray(e?.technicians)?e.technicians:[];o.push(`crewAssignments: ${s.length}`),o.push(`techniciansDetails: ${c.length}`),o.push(`technicians: ${i.length}`);const a=m=>m&&m.length?m[0]:null,u=m=>m&&typeof m=="object"?Object.keys(m):[],d=a(s);d&&o.push(`CA keys: ${u(d).join(", ")}`);const l=a(c);l&&o.push(`TD keys: ${u(l).join(", ")}`);const p=a(i);p&&typeof p!="string"&&o.push(`T keys: ${u(p).join(", ")}`),r.innerHTML=o.map(m=>`<div>${go(m)}</div>`).join("")}catch{}}function go(t){try{return String(t).replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"})[e])}catch{return String(t)}}function w(t,e={},n=[]){const r=document.createElement(t);return Object.entries(e||{}).forEach(([o,s])=>{o==="class"?r.className=s:o==="text"?r.textContent=s:o==="html"?r.innerHTML=s:r.setAttribute(o,s)}),(Array.isArray(n)?n:[n]).filter(Boolean).forEach(o=>r.appendChild(o)),r}function jr({landscape:t=!1,headerFooter:e=!1,logoUrl:n=""}={}){const o=typeof localStorage<"u"&&localStorage.getItem("templates.lang")==="ar"?"rtl":"ltr",s=w("div",{id:"templates-a4-root","data-render-context":"preview",dir:o}),c=w("div",{"data-a4-pages":""}),i=w("section",{class:`a4-page${t?" a4-page--landscape":""}${e?" a4-page--with-hf":""}`}),a=w("div",{class:"a4-inner"});if(e){const u=w("div",{class:"tpl-print-header"},[w("div",{class:"brand"},[w("img",{src:n,alt:"Logo",referrerpolicy:"no-referrer"}),w("div",{class:"brand-text",text:"Art Ratio"})]),w("div",{class:"meta"},[w("div",{text:new Date().toLocaleDateString()})])]),d=w("div",{class:"tpl-print-footer"},[w("div",{class:"footer-left",text:"art-ratio.com"}),w("div",{class:"page-num",html:"<span data-page-num>1</span> / <span data-page-count>1</span>"})]);i.appendChild(u),i.appendChild(d)}return i.appendChild(a),c.appendChild(i),s.appendChild(c),{root:s,inner:a}}function tt(t,e){try{return(typeof localStorage<"u"&&localStorage.getItem("templates.lang")==="ar"?"ar":"en")==="ar"&&e||t}catch{return t}}function ee(t,e="",n=!0){const r=w("div",{class:"cell"});r.appendChild(w("span",{class:"label",text:t}));const o=w("div",{"data-editable":n?"true":"false",contenteditable:n?"true":"false"});try{o.setAttribute("dir","auto")}catch{}return o.textContent=e||"",r.appendChild(o),r}function Fr(){try{return{url:localStorage.getItem("templates.callsheet.logo2.url")||"",s:Number(localStorage.getItem("templates.callsheet.logo2.s")||"1")||1,x:Number(localStorage.getItem("templates.callsheet.logo2.x")||"0")||0,y:Number(localStorage.getItem("templates.callsheet.logo2.y")||"0")||0}}catch{return{url:"",s:1,x:0,y:0}}}function bo(t={}){try{typeof t.url=="string"&&localStorage.setItem("templates.callsheet.logo2.url",t.url),Number.isFinite(t.s)&&localStorage.setItem("templates.callsheet.logo2.s",String(t.s)),Number.isFinite(t.x)&&localStorage.setItem("templates.callsheet.logo2.x",String(t.x)),Number.isFinite(t.y)&&localStorage.setItem("templates.callsheet.logo2.y",String(t.y))}catch{}}function wo(t,e){try{if(!t||!e)return;let n=!1,r=0,o=0,s=0,c=0;const i=()=>{try{const l=e.style.transform||"",p=/translate\(([-\d.]+)px,\s*([-\d.]+)px\)/.exec(l),m=/scale\(([-\d.]+)\)/.exec(l);return{x:Number(p?.[1]||0)||0,y:Number(p?.[2]||0)||0,s:Number(m?.[1]||1)||1}}catch{return{x:0,y:0,s:1}}},a=l=>{n=!0;const p=i();s=p.x,c=p.y,r=l.clientX,o=l.clientY;try{l.preventDefault()}catch{}},u=l=>{if(!n)return;const p=l.clientX-r,m=l.clientY-o,h=Math.round(s+p),y=Math.round(c+m),g=Math.max(.3,Math.min(3,Number(Fr().s||1)));e.style.transform=`scale(${g}) translate(${h}px, ${y}px)`},d=()=>{if(!n)return;n=!1;const l=i();bo({x:l.x,y:l.y})};e.addEventListener("pointerdown",a),window.addEventListener("pointermove",u,{passive:!0}),window.addEventListener("pointerup",d,{passive:!0})}catch{}}function $r(){try{return{s:Number(localStorage.getItem("templates.callsheet.logo1.s")||"1")||1,x:Number(localStorage.getItem("templates.callsheet.logo1.x")||"0")||0,y:Number(localStorage.getItem("templates.callsheet.logo1.y")||"0")||0,h:localStorage.getItem("templates.callsheet.logo1.h")==="1"}}catch{return{s:1,x:0,y:0,h:!1}}}function Yn(t={}){try{Number.isFinite(t.s)&&localStorage.setItem("templates.callsheet.logo1.s",String(t.s)),Number.isFinite(t.x)&&localStorage.setItem("templates.callsheet.logo1.x",String(t.x)),Number.isFinite(t.y)&&localStorage.setItem("templates.callsheet.logo1.y",String(t.y)),typeof t.h=="boolean"&&localStorage.setItem("templates.callsheet.logo1.h",t.h?"1":"0")}catch{}}function vo(t,e){try{if(!t||!e)return;let n=!1,r=0,o=0,s=0,c=0;const i=()=>{try{const p=e.style.transform||"",m=/translate\(([-\d.]+)px,\s*([-\d.]+)px\)/.exec(p),h=/scale\(([-\d.]+)\)/.exec(p);return{x:Number(m?.[1]||0)||0,y:Number(m?.[2]||0)||0,s:Number(h?.[1]||1)||1}}catch{return{x:0,y:0,s:1}}},a=p=>{n=!0;const m=i();s=m.x,c=m.y,r=p.clientX,o=p.clientY;try{p.preventDefault()}catch{}},u=p=>{if(!n)return;const m=p.clientX-r,h=p.clientY-o,y=Math.round(s+m),g=Math.round(c+h),E=Math.max(.3,Math.min(3,Number($r().s||1)));e.style.transform=`scale(${E}) translate(${y}px, ${g}px)`},d=()=>{if(!n)return;n=!1;const p=i();Yn({x:p.x,y:p.y})};e.addEventListener("pointerdown",a),window.addEventListener("pointermove",u,{passive:!0}),window.addEventListener("pointerup",d,{passive:!0});const l=document.getElementById("tpl-logo1-size");if(l){const p=m=>{const h=Math.max(.3,Math.min(3,Number(m||1))),y=i();try{e.style.transform=`scale(${h}) translate(${y.x}px, ${y.y}px)`}catch{}Yn({s:h})};l.addEventListener("input",m=>{p(m?.target?.value)})}}catch{}}function Or(t,e){if(!t||!e)return;const n=(()=>{if(Array.isArray(e.crewAssignments)&&e.crewAssignments.length)return e.crewAssignments;if(Array.isArray(e.techniciansDetails)&&e.techniciansDetails.length)return e.techniciansDetails;const s=Array.isArray(e.technicians)?e.technicians:[];if(s.length){const c=we()||[],i=new Map(c.map(u=>[String(u.id),u])),a=new Map(c.map(u=>[String((u.name||u.full_name||"").trim().toLowerCase()),u]));return s.map(u=>{if(u&&typeof u=="object"){const p=u.id??u.technicianId,m=u.name??u.full_name??u.technician_name,h=p!=null&&i.get(String(p))||(m?a.get(String(m).trim().toLowerCase()):null);return h?{technicianId:h.id,technicianName:h.name||h.full_name,technicianPhone:h.phone,technicianRole:h.role||h.specialization}:{technicianName:m||"",technicianId:p??null}}const d=String(u||"").trim(),l=i.get(d)||a.get(d.toLowerCase());return l?{technicianId:l.id,technicianName:l.name||l.full_name,technicianPhone:l.phone,technicianRole:l.role||l.specialization}:/^\d+$/.test(d)?{technicianId:d}:{technicianName:d}})}return[]})();try{if(n.length){n.forEach(a=>{try{a&&typeof a.technician=="object"&&(a.technicianId=a.technicianId??a.technician?.id??a.technician_id,a.technicianName=a.technicianName??a.technician?.name??a.technician?.full_name??a.name,a.technicianPhone=a.technicianPhone??a.technician?.phone??a.phone,a.technicianRole=a.technicianRole??a.technician?.role??a.specialization??a.role),a&&typeof a.position=="object"&&(a.positionLabel=a.positionLabel??a.position?.labelAr??a.position?.labelEn??a.position?.name??a.position_name),a.positionLabel=a.positionLabel??a.position_name??a.positionName??a.position,a.technicianPhone=a.technicianPhone??a.phone_number??a.phoneNumber??a.mobile??a.whatsapp,a.technicianName=a.technicianName??a.full_name??a.technician_name,!a.technicianName&&a.name&&(a.technicianName=a.name)}catch{}});const s=we()||[],c=new Map(s.map(a=>[String(a.id),a])),i=new Map(s.map(a=>[String((a.name||a.full_name||"").trim().toLowerCase()),a]));n.forEach(a=>{const u=a.technicianId??a.technician_id??a.id,d=a.technicianName??a.name,l=u!=null&&c.get(String(u))||(d?i.get(String(d).trim().toLowerCase()):null);l&&(!a.technicianName&&(l.name||l.full_name)&&(a.technicianName=l.name||l.full_name),!a.technicianPhone&&l.phone&&(a.technicianPhone=l.phone),!a.technicianRole&&(l.role||l.specialization)&&(a.technicianRole=l.role||l.specialization))})}}catch{}if(!n.length)return;const r=Array.from(t.querySelectorAll("tbody tr"));(s=>{const c=Math.max(0,s-r.length);for(let i=0;i<c;i+=1){const a=document.createElement("tr");for(let u=0;u<4;u+=1){const d=document.createElement("td");if(d.setAttribute("data-editable","true"),d.setAttribute("contenteditable","true"),u===2){try{d.removeAttribute("dir")}catch{}d.classList.add("dir-ltr")}a.appendChild(d)}t.tBodies[0].appendChild(a),r.push(a)}})(n.length),n.forEach((s,c)=>{const i=r[c];if(!i)return;const a=Array.from(i.children),u=Fe(s),d=s.technicianName||s.name||s.full_name||s.technician_name||"",l=s.technicianPhone||s.phone||s.phoneNumber||s.phone_number||s.mobile||s.whatsapp||"";if(a[0]&&(a[0].textContent=u||""),a[1]&&(a[1].textContent=d||""),a[2]){try{a[2].removeAttribute("dir")}catch{}a[2].classList.add("dir-ltr"),a[2].textContent=l||""}})}function ln(t){try{const e=document.querySelector("#templates-a4-root .callsheet-v1 table.cs-crew");if(!e||!t)return;const n=Array.from(e.querySelectorAll("tbody tr")),r=n.slice(0,Math.min(n.length,6));let o=0,s=0;if(r.forEach(i=>{Array.from(i.children).slice(0,3).forEach(u=>{s+=1,(u.textContent||"").trim()&&(o+=1)})}),(s>0?o/s:0)<=.15){Or(e,t);return}try{const i=(()=>{if(Array.isArray(t.crewAssignments)&&t.crewAssignments.length)return t.crewAssignments;if(Array.isArray(t.techniciansDetails)&&t.techniciansDetails.length)return t.techniciansDetails;const u=Array.isArray(t.technicians)?t.technicians:[];if(u.length){const d=new Map((we()||[]).map(l=>[String(l.id),l]));return u.map(l=>{const p=d.get(String(l));return p?{technicianId:p.id,technicianName:p.name||p.full_name,technicianPhone:p.phone,technicianRole:p.role||p.specialization}:{technicianId:l}})}return[]})(),a=new Map(i.map(u=>[String(u.technicianName||u.name||u.full_name||"").trim().toLowerCase(),u]));n.forEach(u=>{const d=Array.from(u.children);if(!(d[1]&&(d[1].textContent||"").trim()))return;const p=String(d[1].textContent||"").trim().toLowerCase(),m=a.get(p);if(!m)return;const h=Fe(m),y=m.technicianPhone||m.phone||m.phoneNumber||m.phone_number||m.mobile||m.whatsapp||"";if(d[0]&&!(d[0].textContent||"").trim()&&(d[0].textContent=h||""),d[2]&&!(d[2].textContent||"").trim()){try{d[2].removeAttribute("dir")}catch{}d[2].classList.add("dir-ltr"),d[2].textContent=y||""}})}catch{}}catch{}}function xo(t,e,n={}){const{headerFooter:r=!1,logoUrl:o=""}=n||{},{root:s,inner:c}=jr({landscape:!0,headerFooter:r,logoUrl:o});try{s.setAttribute("dir","ltr")}catch{}const i=s.querySelector("[data-a4-pages]"),a=e?.[0]||null,u=()=>{const $=w("section",{class:"a4-page a4-page--landscape"}),J=w("div",{class:"a4-inner"}),ct=w("div",{class:"callsheet-v1"});return $.appendChild(J),J.appendChild(ct),i.appendChild($),{page:$,innerPage:J,wrapPage:ct}},d=w("div",{class:"callsheet-v1"}),l=w("div",{class:"cs-header"}),p=w("div",{class:"cs-logo cs-logo--left"}),m=w("img",{src:o||"",alt:"Art Ratio Logo",draggable:"false",referrerpolicy:"no-referrer",crossorigin:"anonymous"});try{m.style.removeProperty("width")}catch{}try{const $=$r(),J=Number($.x||0)||0,ct=Number($.y||0)||0,W=Math.max(.3,Math.min(3,Number($.s||1)));if(m.style.transform=`scale(${W}) translate(${J}px, ${ct}px)`,$.h)try{p.setAttribute("data-hidden","1"),p.style.visibility="hidden"}catch{}}catch{}p.appendChild(m),l.appendChild(p);const h=w("div",{class:"cs-titlebox"},[w("div",{class:"cs-brand","data-editable":"true",contenteditable:"true",text:t?.title||"WKK."}),w("div",{class:"cs-date","data-editable":"true",contenteditable:"true",text:new Date().toLocaleDateString("en-GB")}),w("div",{class:"cs-title",text:"CALL SHEET"})]);l.appendChild(h);const y=Fr(),g=w("div",{class:"cs-logo cs-logo--right","data-empty":y.url?"0":"1"}),E=w("img",{alt:"Client Logo",draggable:"false",referrerpolicy:"no-referrer",crossorigin:"anonymous"});try{E.style.removeProperty("width")}catch{}y.url&&E.setAttribute("src",y.url);try{const $=Number(y.x||0)||0,J=Number(y.y||0)||0,ct=Math.max(.3,Math.min(3,Number(y.s||1)));E.style.transform=`scale(${ct}) translate(${$}px, ${J}px)`}catch{}g.appendChild(E),g.appendChild(w("div",{class:"cs-logo__resize",title:"resize"})),l.appendChild(g),d.appendChild(l);const I=w("table",{class:"cs-info"}),x=w("tbody"),C=(...$)=>{const J=w("tr");return $.forEach(ct=>J.appendChild(ct)),J},f=$=>w("td",{class:"cs-label",text:$}),v=($="")=>w("td",{"data-editable":"true",contenteditable:"true",text:$}),T=w("table",{class:"cs-roles"}),P=w("tbody");["Producer","Director","DOP","Production Manager","Assistant Director"].forEach($=>{const J=w("tr");J.appendChild(f(`${$}:`)),J.appendChild(v("")),P.appendChild(J)}),T.appendChild(P);try{a&&Co(T,a)}catch{}const L=w("table",{class:"cs-center"}),_=w("tbody");_.appendChild(C(w("td",{class:"cs-notes-h",text:"Important Notes"}))),_.appendChild(C(w("td",{class:"cs-notes","data-editable":"true",contenteditable:"true",html:"Please be on Time<br>Have Fun and make Art<br>If you need any help please contact the AD or Production manager"}))),_.appendChild(C(w("td",{class:"cs-section",text:"Locations"}))),_.appendChild(C(w("td",{class:"cs-locations","data-editable":"true",contenteditable:"true",text:""}))),L.appendChild(_);const R=w("table",{class:"cs-times"}),D=w("tbody");[["Call Time",""],["Client",t?.clientCompany||t?.clientName||t?.client||""],["Ready to shoot",""],["Lunch",""],["Est. Wrap",""]].forEach(([$,J])=>{const ct=w("tr");ct.appendChild(f(`${$}:`)),ct.appendChild(v(J)),D.appendChild(ct)});const N=w("tr");N.appendChild(f(""));const b=w("td"),M=w("div",{class:"cs-weather"},[w("div",{class:"cs-city","data-editable":"true",contenteditable:"true",text:"jeddah"}),w("div",{class:"cs-temp","data-editable":"true",contenteditable:"true",text:"38°C - 25°C"}),w("div",{class:"cs-wind","data-editable":"true",contenteditable:"true",text:"Wind: 16 km/h"}),w("div",{class:"cs-rain","data-editable":"true",contenteditable:"true",text:"Chance of rain : 0%"})]);b.appendChild(M),N.appendChild(b),D.appendChild(N),R.appendChild(D),x.appendChild(C(w("td",{},[T]),w("td",{},[L]),w("td",{},[R]))),I.appendChild(x),d.appendChild(I);const q=w("table",{class:"cs-cast"}),B=w("tbody"),j=w("colgroup");for(let $=0;$<8;$+=1)j.appendChild(w("col",{style:"width:12.5%"}));q.appendChild(j),B.appendChild(C(w("td",{class:"cs-cast-title",text:"Cast Calls",colspan:"8",style:"background:#2563EB !important;color:#ffffff !important;"})));const X=w("tr"),A=w("tr");for(let $=0;$<8;$+=1)X.appendChild(w("td",{"data-editable":"true",contenteditable:"true"})),A.appendChild(w("td",{"data-editable":"true",contenteditable:"true"}));B.appendChild(X),B.appendChild(A),q.appendChild(B),d.appendChild(q),c.appendChild(d);const{innerPage:k,wrapPage:H}=u(),F=w("table",{class:"tpl-table cs-crew","data-editable-table":"crew",style:"width:90% !important; margin-left:auto !important; margin-right:auto !important;"}),Y=[30,34,20,16],G=w("colgroup");Y.forEach($=>G.appendChild(w("col",{style:`width:${$}%`}))),F.appendChild(G);const K=w("thead"),z=w("tr");z.appendChild(w("th",{colspan:String(Y.length),class:"cs-crew-title",text:"Crew Call"})),K.appendChild(z);const V=w("tr");["Position","Name","Phone","Time"].forEach($=>V.appendChild(w("th",{text:$,class:"cs-crew-head"}))),K.appendChild(V),F.appendChild(K);const at=w("tbody");for(let $=0;$<18;$+=1){const J=w("tr");J.appendChild(w("td",{"data-editable":"true",contenteditable:"true"})),J.appendChild(w("td",{"data-editable":"true",contenteditable:"true"})),J.appendChild(w("td",{"data-editable":"true",contenteditable:"true",class:"dir-ltr"})),J.appendChild(w("td",{"data-editable":"true",contenteditable:"true"})),at.appendChild(J)}F.appendChild(at),H.appendChild(F),k.appendChild(H);const{innerPage:st,wrapPage:mt}=u();try{st.style.paddingLeft="0mm",st.style.paddingRight="0mm"}catch{}const _t=w("table",{class:"tpl-table cs-schedule","data-editable-table":"callsheet",style:"width:calc(100% + 16mm) !important; margin-left:-8mm !important; margin-right:-8mm !important;"}),Pt=[5,5,21,6,7,5,8,4,4,10,8,17],St=w("colgroup");Pt.forEach($=>St.appendChild(w("col",{style:`width:${$}%`}))),_t.appendChild(St);const te=["Shot #","Time (Duration)","Description","Movement","Rig","Lens","Location","I/E","D/N","Sound","Cast","Notes / Props"],$t=w("thead"),Te=w("tr");Te.appendChild(w("th",{colspan:String(Pt.length),class:"cs-schedule-title",text:"Shot List"})),$t.appendChild(Te);const Dt=w("tr");te.forEach(($,J)=>Dt.appendChild(w("th",{text:$,class:"cs-schedule-head",style:`width:${Pt[J]}%`}))),$t.appendChild(Dt),_t.appendChild($t);const Ot=w("tbody"),Le=w("tr",{class:"cs-row-note"});Le.appendChild(w("td",{colspan:"12","data-editable":"true",contenteditable:"true",text:"breakfast(30m)"})),Ot.appendChild(Le);const Pe=w("tr",{class:"cs-row-strong"});Pe.appendChild(w("td",{colspan:"12","data-editable":"true",contenteditable:"true",text:"light, camera and art Prep (1H)"})),Ot.appendChild(Pe);for(let $=0;$<4;$+=1){const J=w("tr");for(let ct=0;ct<12;ct+=1)J.appendChild(w("td",{"data-editable":"true",contenteditable:"true"}));Ot.appendChild(J)}_t.appendChild(Ot),mt.appendChild(_t),st.appendChild(mt);try{vo(p,m)}catch{}try{wo(g,E)}catch{}return s}function Fe(t={}){try{const n=typeof wt=="function"?wt():"ar",r=i=>n==="ar"?i.labelAr||i.labelEn||i.name||"":i.labelEn||i.labelAr||i.name||"",o=typeof $n=="function"?$n()||[]:[],s=t.positionLabel||t.positionLabelAr||t.positionLabelEn||t.position_name||t.position_label||"";if(s&&!/^position[-_]/i.test(String(s)))return String(s);if(t.positionId!=null&&o.length){const i=o.find(a=>String(a.id)===String(t.positionId));if(i)return r(i)}const c=[t.positionKey,t.position_key,t.positionName,t.position_name,t.position,t.assignedPosition,t.assigned_position,t.reservationPosition,t.reservation_position,t.crewPosition,t.crew_position,t.roleInReservation,t.role_in_reservation,t.technicianRole,t.role,t.specialization].map(i=>i!=null?String(i).trim():"").filter(Boolean);for(const i of c){let a=null;if(typeof On=="function"&&(a=On(i)),!a&&o.length){const u=i.toLowerCase();a=o.find(d=>[d.name,d.labelAr,d.labelEn].filter(Boolean).map(l=>String(l).toLowerCase()).includes(u))||null}if(a)return r(a);if(!/^position[-_]/i.test(i))return i}}catch{}const e=t.positionLabel||t.positionLabelAr||t.positionLabelEn||t.position_name||t.position_label||t.technicianRole||t.role||t.specialization||"";return/^position[-_]/i.test(String(e))?"":String(e)}function Eo(t){const e=we()||[],n=new Map(e.map(c=>[String(c.id),c])),r=new Map(e.map(c=>[String((c.name||c.full_name||"").trim().toLowerCase()),c])),s=(()=>{if(Array.isArray(t?.crewAssignments)&&t.crewAssignments.length)return t.crewAssignments;if(Array.isArray(t?.techniciansDetails)&&t.techniciansDetails.length)return t.techniciansDetails;const c=Array.isArray(t?.technicians)?t.technicians:[];return c.length?c.map(i=>({technicianId:i})):[]})().map(c=>({...c}));return s.forEach(c=>{try{c&&typeof c.technician=="object"&&(c.technicianId=c.technicianId??c.technician?.id??c.technician_id,c.technicianName=c.technicianName??c.technician?.name??c.technician?.full_name??c.name,c.technicianPhone=c.technicianPhone??c.technician?.phone??c.phone,c.technicianRole=c.technicianRole??c.technician?.role??c.specialization??c.role),c&&typeof c.position=="object"&&(c.positionLabel=c.positionLabel??c.position?.labelAr??c.position?.labelEn??c.position?.name??c.position_name),c.positionLabel=c.positionLabel??c.position_name??c.positionName??c.position,c.technicianPhone=c.technicianPhone??c.phone_number??c.phoneNumber??c.mobile??c.whatsapp,c.technicianName=c.technicianName??c.full_name??c.technician_name,!c.technicianName&&c.name&&(c.technicianName=c.name)}catch{}}),s.forEach(c=>{const i=c.technicianId??c.technician_id??c.id,a=c.technicianName??c.name,u=i!=null&&n.get(String(i))||(a?r.get(String(a).trim().toLowerCase()):null);u&&(!c.technicianName&&(u.name||u.full_name)&&(c.technicianName=u.name||u.full_name),!c.technicianPhone&&u.phone&&(c.technicianPhone=u.phone),!c.technicianRole&&(u.role||u.specialization)&&(c.technicianRole=u.role||u.specialization))}),s}function Co(t,e){if(!t||!e)return;const n=Array.from(t.querySelectorAll("tbody tr")),r=d=>String(d||"").toLowerCase().replace(/[\u064B-\u0652]/g,"").replace(/[\.\-_/]+/g," ").replace(/\s+/g," ").trim(),o=d=>{const l=r(d);if(!l)return!1;const p=l.replace(/\s+/g,"");return!!(["assistant director","first assistant director","second assistant director","1st ad","1 ad","first ad","2nd ad","second ad","asst dir","dir asst","assistant dir","dir assistant","ad","مساعد مخرج","مساعد المخرج","مساعد اخراج","مساعد إخراج","مساعد مخرج اول","مساعد مخرج أول","مساعد مخرج ثاني"].map(r).includes(l)||l.includes("assistant director")||l.includes("dir asst")||l.includes("asst dir")||l.includes("assistant dir")||l.includes("dir assistant")||l.includes("مساعد مخرج")||l.includes("مساعد اخراج")||l.includes("مساعد إخراج")||/^ad$/.test(l)||/^(1st\s*ad|first\s*ad|ad\s*1)$/i.test(l)||/^(2nd\s*ad|second\s*ad|ad\s*2)$/i.test(l)||/^ad$/.test(p))},s=d=>{const l=String(d||"").toLowerCase();return o(l)?"ad1":/\bproducer\b/.test(l)||/منتج/.test(l)?"producer":/\bdop\b/.test(l)||/director of photography/i.test(l)||/cinematograph/.test(l)||/مدير تصوير/.test(l)?"dop":/production manager/i.test(l)||/مدير انتاج/.test(l)||/مدير إنتاج/.test(l)?"pm":/\bdirector\b/.test(l)&&!/assistant/.test(l)||/مخرج/.test(l)&&!/مساعد/.test(l)?"director":""},c=d=>n.find(l=>s(l?.children?.[0]?.textContent)===d)||null,i={producer:c("producer")?.children?.[1]||null,director:c("director")?.children?.[1]||null,dop:c("dop")?.children?.[1]||null,pm:c("pm")?.children?.[1]||null,ad1:c("ad1")?.children?.[1]||null},a=new Set,u=Eo(e);if(u.forEach(d=>{const l=d.technicianName||d.name||d.full_name||d.technician_name||"";if(!l)return;const p=Fe(d),m=String(p||"").trim().toLowerCase();if(m){if(!a.has("ad1")&&i.ad1&&o(m)){i.ad1.textContent=l,a.add("ad1");return}if(!a.has("pm")&&i.pm&&(/production manager/i.test(m)||/مدير انتاج/.test(m)||/مدير إنتاج/.test(m))){i.pm.textContent=l,a.add("pm");return}if(!a.has("dop")&&i.dop&&(/\bdop\b/.test(m)||/director of photography/i.test(m)||/cinematograph/.test(m)||/مدير تصوير/.test(m))){i.dop.textContent=l,a.add("dop");return}if(!a.has("director")&&i.director&&(/\bdirector\b/.test(m)&&!/assistant/.test(m)||/مخرج/.test(m)&&!/مساعد/.test(m))){i.director.textContent=l,a.add("director");return}if(!a.has("producer")&&i.producer&&(/\bproducer\b/.test(m)||/منتج/.test(m))){i.producer.textContent=l,a.add("producer");return}}}),i.ad1&&!a.has("ad1")&&(!i.ad1.textContent||!i.ad1.textContent.trim())){const d=u.find(l=>{const p=Fe(l)||"";return o(p)});if(d){const l=d.technicianName||d.name||d.full_name||d.technician_name||"";l&&(i.ad1.textContent=l,a.add("ad1"))}}}function So(t,e,n={}){const{headerFooter:r=!1,logoUrl:o=""}=n||{},{root:s,inner:c}=jr({landscape:!1,headerFooter:r,logoUrl:o});try{s.setAttribute("data-exp-mode","multipage")}catch{}const i=w("div",{class:"exp-masthead"},[w("div",{class:"brand-logo"},[w("img",{src:o,alt:"Logo",referrerpolicy:"no-referrer"})]),w("div",{class:"brand-info"},[w("div",{class:"text",text:n.companyName||t?.clientCompany||t?.title||"Company"}),w("div",{class:"meta"},[w("span",{class:"line",text:`${tt("CR","السجل التجاري")}: ${n.companyCR||""}`}),w("span",{class:"line",text:`${tt("Media License","ترخيص إعلامي")}: ${n.companyLicense||""}`})])]),(()=>{const E=document.createElement("div");return E.className="title-wrap",E.appendChild(w("div",{class:"title",text:tt("Expenses Sheet","ورقة المصاريف")})),E.appendChild(w("div",{class:"date",text:`Date: ${new Date().toISOString().slice(0,10)}`})),E})()]);c.appendChild(i);const a=w("div",{class:"tpl-meta"});a.appendChild(ee(tt("Client","العميل"),t?.clientCompany||"")),a.appendChild(ee(tt("Project Title","اسم المشروع"),t?.title||"")),a.appendChild(ee(tt("Budget Date","تاريخ الميزانية"),new Date().toISOString().slice(0,10))),a.appendChild(ee(tt("Prepared by","إعداد"),""));const u=Array.from(new Set((e||[]).map(E=>(E?.location||"").trim()).filter(Boolean))).join(", ");a.appendChild(ee(tt("Locations","المواقع"),u)),a.appendChild(ee(tt("Shoot Days","أيام التصوير"),"")),c.appendChild(a);const d=w("div",{id:"expenses-top-sheet"}),l=(E,I)=>w("tr",{"data-top-row":E},[w("td",{class:"code",text:E}),w("td",{class:"exp-top-label",text:I}),w("td",{"data-top-count":E,text:""}),w("td",{"data-top-total":E,text:""})]),p=(E,I,x)=>{const C=w("table",{class:"exp-table exp-top-table dir-ltr"}),f=w("caption",{class:"exp-group-cap"},[w("div",{class:"exp-group-bar",text:E})]);C.appendChild(f);const v=w("thead"),T=w("tr");["CODE","DESCRIPTION","COUNT","TOTAL"].forEach((L,_)=>T.appendChild(w("th",{class:["exp-top-col-code","exp-top-col-label","exp-top-col-count","exp-top-col-total"][_],text:tt(L,_===1?"الوصف":_===2?"العدد":"الإجمالي")}))),v.appendChild(T),C.appendChild(v);const P=w("tbody");if(I.forEach(([L,_])=>P.appendChild(l(L,_))),x){const L=x==="atl"?tt("Total Above the Line","مجموع فوق الخط"):x==="prod"?tt("Total Production","مجموع الإنتاج"):tt("Total Post Production","مجموع ما بعد الإنتاج"),_=w("tr",{"data-top-group-total-row":x},[w("td",{colspan:"3",class:"exp-top-total-label",text:L}),w("td",{"data-top-total-group":x,text:"0"})]);P.appendChild(_)}return C.appendChild(P),C};d.appendChild(p(tt("ABOVE THE LINE","فوق الخط"),[["01-00","PRODUCERS UNIT"],["02-00","DIRECTOR & STAFF"],["03-00","CAST"]],"atl")),d.appendChild(p(tt("PRODUCTION EXPENSES","مصاريف الإنتاج"),[["04-00","PRODUCTION STAFF"],["05-00","SET DESIGN"],["06-00","SET CONSTRUCTION"]],"prod")),d.appendChild(p(tt("POST-PRODUCTION EXPENSES","مصاريف ما بعد الإنتاج"),[["13-00","FILM EDITING"],["14-00","VOICE OVER"]],"post"));const m=w("table",{class:"exp-table exp-top-table dir-ltr"}),h=document.createElement("colgroup");["16%","54%","10%","20%"].forEach(E=>h.appendChild(w("col",{style:`width:${E}`}))),m.appendChild(h);const y=document.createElement("tbody");y.appendChild(w("tr",{class:"exp-grand-total-row"},[w("td",{colspan:"3",class:"exp-grand-total-label",text:tt("GRAND TOTAL","الإجمالي الكلي")}),w("td",{"data-top-grand":"1",class:"exp-grand-total-value",text:"0"})])),m.appendChild(y),d.appendChild(m),c.appendChild(d);const g=(E,I,x=[])=>{const C=w("table",{class:"exp-table exp-details dir-ltr","data-editable-table":"expenses","data-group":E}),f=w("colgroup");["12%","38%","12%","10%","10%","8%","10%"].forEach(L=>f.appendChild(w("col",{style:`width:${L}`}))),C.appendChild(f);const v=w("thead"),T=w("tr");[{text:tt("CODE","الكود")},{text:tt("DESCRIPTION","الوصف")},{text:tt("RATE","السعر")},{text:tt("QTY","الكمية")},{text:tt("DAYS","الأيام")},{text:tt("PAID","المدفوع")},{text:tt("TOTAL","الإجمالي")}].forEach(L=>T.appendChild(w("th",{text:L.text}))),v.appendChild(T),C.appendChild(v);const P=w("tbody");P.appendChild(w("tr",{"data-group-bar":"true","data-group-title":"true"},[w("th",{colspan:"7"},[w("div",{class:`exp-group-bar exp-group-bar--${E}`,text:I})])])),x.forEach((L,_)=>{P.appendChild(w("tr",{"data-subgroup-header":"true","data-subgroup":L.code},[w("td",{class:"code",text:L.code}),w("td",{class:"label",text:L.label}),w("td",{class:"exp-subheader-fill",colspan:"5",text:""})])),P.appendChild(w("tr",{"data-subgroup-marker":L.code,"data-parent-group":E,style:"display:none;"},[w("td",{colspan:"7",text:""})]));for(let R=0;R<(L.rows||2);R+=1){const D=w("tr",{"data-row":"item"}),N={"data-editable":"true",contenteditable:"true",autocapitalize:"off",autocorrect:"off",autocomplete:"off",spellcheck:"false"},b={...N,"data-num":"1",inputmode:"decimal"};D.appendChild(w("td",N)),D.appendChild(w("td",N)),D.appendChild(w("td",b)),D.appendChild(w("td",b)),D.appendChild(w("td",b)),D.appendChild(w("td",b)),D.appendChild(w("td",{"data-num":"1"})),P.appendChild(D)}P.appendChild(w("tr",{"data-subgroup-subtotal":"true"},[w("td",{colspan:"6",text:tt("SUBTOTAL","المجموع الفرعي")}),w("td",{"data-subtotal":L.code,"data-num":"1",text:"0"})]))}),C.appendChild(P),c.appendChild(C)};return g("atl",tt("ABOVE THE LINE","فوق الخط"),[{code:"01-00",label:"PRODUCERS UNIT",rows:2},{code:"02-00",label:"DIRECTOR & STAFF",rows:2},{code:"03-00",label:"CAST",rows:6}]),g("prod",tt("PRODUCTION EXPENSES","مصاريف الإنتاج"),[{code:"04-00",label:"PRODUCTION STAFF",rows:3},{code:"05-00",label:"SET DESIGN",rows:3},{code:"06-00",label:"SET CONSTRUCTION",rows:2}]),g("post",tt("POST-PRODUCTION EXPENSES","مصاريف ما بعد الإنتاج"),[{code:"13-00",label:"FILM EDITING",rows:2},{code:"14-00",label:"VOICE OVER",rows:2}]),s}function dn(t){try{if(!t)return!1;const e=!!t.querySelector("#expenses-top-sheet"),n=!!t.querySelector('table.exp-details tbody tr[data-row="item"]'),r=!!Array.from(t.querySelectorAll("table.tpl-table tbody tr")).find(i=>{try{return i.classList?.contains("cs-row-note")||i.classList?.contains("cs-row-strong")?!0:Array.from(i.querySelectorAll("td")).some(u=>(u.textContent||"").trim().length>0)}catch{return!1}}),s=!!t.querySelector(".callsheet-v1 table.cs-crew")||!!Array.from(t.querySelectorAll(".callsheet-v1 table.cs-crew tbody tr")).find(i=>{try{return Array.from(i.querySelectorAll("td")).some(a=>(a.textContent||"").trim().length>0)}catch{return!1}}),c=!!t.querySelector(".callsheet-v1 .cs-header, .callsheet-v1 .cs-info td, .callsheet-v1 .cs-cast td");return e||n||r||s||c}catch{return!0}}const Ze=new Map;function Ao(t){if(!t)return Promise.resolve(null);const e=String(t);if(Ze.has(e))return Ze.get(e);const n=new Promise(r=>{try{const o=new Image;o.crossOrigin="anonymous",o.referrerPolicy="no-referrer",o.onload=()=>r(o),o.onerror=()=>r(null),o.src=e}catch{r(null)}});return Ze.set(e,n),n}function uc(t=[]){return Promise.all((t||[]).map(e=>Ao(e)))}async function _o(){try{document.fonts&&document.fonts.ready&&await document.fonts.ready}catch{}}function To(t=document){try{const e=t||document,n=Array.from(e.querySelectorAll?e.querySelectorAll("img"):[]);return n.length?Promise.all(n.map(r=>new Promise(o=>{try{if(r.complete&&r.naturalWidth>0)return o();const s=()=>{try{r.removeEventListener("load",s),r.removeEventListener("error",s)}catch{}o()};r.addEventListener("load",s,{once:!0}),r.addEventListener("error",s,{once:!0})}catch{o()}}))):Promise.resolve()}catch{return Promise.resolve()}}async function Lo(t=document){await _o(),await To(t)}let Wt=[],Ln=[],Gn=!1,Kn=null,Hr=()=>null,Pn=()=>{},zr=()=>{},Ur=()=>{};function Po({getSnapshot:t,applySnapshot:e,onAutosaveDebounced:n,onMarkEditing:r}={}){typeof t=="function"&&(Hr=t),typeof e=="function"&&(Pn=e),typeof n=="function"&&(zr=n),typeof r=="function"&&(Ur=r)}function Wr(){try{const t=Hr();if(!t)return;Wt.push(t),Wt.length>50&&Wt.shift(),Ln=[]}catch{}}function Rt(){try{clearTimeout(Kn)}catch{}Kn=setTimeout(Wr,250)}function Io(){if(Wt.length<2)return;const t=Wt.pop(),e=Wt[Wt.length-1];t&&Ln.push(t),e&&Pn(e)}function No(){const t=Ln.pop();t&&(Wt.push(t),Pn(t))}function Bo(t,e){try{if(e!=="callsheet"||(Wr(),Gn))return;const n=document.getElementById("templates-preview-host");if(!n)return;n.addEventListener("input",r=>{const o=r.target;if(o&&o.getAttribute&&o.getAttribute("data-editable")==="true"){try{Rt()}catch{}try{zr()}catch{}try{Ur()}catch{}}},!0),Gn=!0}catch{}}function Mo(t){return!t||!t.parentElement?-1:Array.from(t.parentElement.children).indexOf(t)}function Xt(t){return t?.matches("[data-section-bar]")||t?.classList.contains("tpl-subtotal-row")}function Vr(t,e=0){if(!t)return;const n=Array.from(t.children),r=n[e];if(r&&r.hasAttribute("contenteditable")){r.focus();return}n.find(s=>s.hasAttribute("contenteditable"))?.focus()}function Xr(t){if(!t)return null;const e=t.parentElement,n=t.cloneNode(!0);return n.querySelectorAll("[contenteditable]")?.forEach(r=>{r.textContent=""}),e.insertBefore(n,t.nextElementSibling),n}function Yr(t,e=-1){if(!t)return;const n=t.parentElement;if(e<0){const r=t.previousElementSibling;r&&!Xt(r)&&n.insertBefore(t,r)}else{const r=t.nextElementSibling;if(r){const o=r.nextElementSibling;Xt(r)?o&&!Xt(o)&&n.insertBefore(t,o.nextElementSibling):n.insertBefore(r,t)}}}function Gr(t){if(!t||Xt(t))return;const e=t.parentElement;try{e.removeChild(t)}catch{}}function oe({landscape:t=!1,headerFooter:e=!1,logoUrl:n=""}={}){const r=document.createElement("section");r.className=`a4-page ${t?"a4-landscape":""}`.trim();const o=document.createElement("div");if(o.className="a4-inner",e){const s=w("div",{class:"tpl-print-header"},[w("div",{class:"logo-left"},[w("img",{src:n||"",alt:""})]),w("div",{class:"meta"},[w("div",{text:new Date().toLocaleDateString()})])]),c=w("div",{class:"tpl-print-footer"},[w("div",{class:"footer-left",text:"art-ratio.com"}),w("div",{class:"page-num",html:"<span data-page-num>1</span> / <span data-page-count>1</span>"})]);r.appendChild(s),r.appendChild(c)}return r.appendChild(o),{page:r,inner:o}}function un({headerFooter:t=!1,logoUrl:e=""}={}){const n=document.querySelector("#templates-preview-host #templates-a4-root");if(!n)return;const r=n.querySelector("[data-a4-pages]"),s=r?.querySelector(".a4-page")?.querySelector(".a4-inner");if(!s)return;const c=s.querySelector(".exp-masthead"),i=s.querySelector(".tpl-meta"),a=s.querySelector("#expenses-top-sheet"),u=s.querySelector("#expenses-table"),d=s.querySelector("#expenses-summary");if(!u)return;for(;r.firstChild;)r.removeChild(r.firstChild);let{page:l,inner:p}=oe({headerFooter:t,logoUrl:e,landscape:!1});r.appendChild(l),c&&p.appendChild(c),i&&p.appendChild(i),a&&p.appendChild(a);const m=u.querySelector("thead"),h=()=>{const b=document.createElement("table");b.className=u.className,b.id="expenses-table",b.setAttribute("data-editable-table","expenses");const M=m?m.cloneNode(!0):document.createElement("thead");return b.appendChild(M),b.appendChild(document.createElement("tbody")),b};let y=h();p.appendChild(y);const g=Array.from(u.querySelectorAll("tbody > tr")),E=b=>b?.hasAttribute("data-subgroup-header"),I=b=>b?.hasAttribute("data-subgroup-subtotal"),x=b=>b?.hasAttribute("data-group-total"),C=b=>b?.hasAttribute("data-subgroup-marker"),f=b=>b?.getAttribute("data-row")==="item",v=b=>b?.hasAttribute("data-group-bar"),T=()=>p.scrollHeight<=p.clientHeight+.5;let P=null,L=null,_=null;const R=(b=null)=>{({page:l,inner:p}=oe({headerFooter:t,logoUrl:e,landscape:!1})),r.appendChild(l),y=h(),p.appendChild(y);const M=y.tBodies[0];if(P&&!(b&&v(b))&&M.appendChild(P.cloneNode(!0)),L&&!(b&&E(b))){const q=b,B=!!(q&&(q.getAttribute&&q.getAttribute("data-subgroup-subtotal")===_||q.getAttribute&&q.getAttribute("data-row")==="item"||q.hasAttribute&&q.hasAttribute("data-subgroup-marker")));(!b||B)&&M.appendChild(L.cloneNode(!0))}},D=b=>{const M=y.tBodies[0];M.appendChild(b),T()||(M.removeChild(b),R(b),y.tBodies[0].appendChild(b))};let N=0;for(;N<g.length;){const b=g[N];if(v(b)&&(P=b.cloneNode(!0)),E(b)&&(L=b.cloneNode(!0),_=b.getAttribute("data-subgroup")),E(b)){const M=[b],q=b.getAttribute("data-subgroup");let B=N+1,j=0;for(;B<g.length&&j<2;)if(f(g[B]))M.push(g[B]),j+=1,B+=1;else if(C(g[B]))M.push(g[B]),B+=1;else{if(I(g[B]))break;break}B<g.length&&I(g[B])&&g[B].getAttribute("data-subgroup-subtotal")===q&&(M.push(g[B]),B+=1);const X=y.tBodies[0];if(M.forEach(A=>X.appendChild(A)),!T()){M.forEach(k=>{k.parentElement===X&&X.removeChild(k)}),R(M[0]);const A=y.tBodies[0];M.forEach(k=>A.appendChild(k))}N=B;continue}if(x(b)){const M=y.tBodies[0];if(M.appendChild(b),!T()){M.removeChild(b);const q=M.lastElementChild;let B=null;q&&(f(q)||I(q))&&(B=q,M.removeChild(q)),R(b);const j=y.tBodies[0];B&&j.appendChild(B),j.appendChild(b),T()||(j.removeChild(b),R(b),y.tBodies[0].appendChild(b))}L=null,_=null,P=null,N+=1;continue}D(b),N+=1}if(d&&(p.appendChild(d),T()||(p.removeChild(d),{page:l,inner:p}=oe({headerFooter:t,logoUrl:e,landscape:!1}),r.appendChild(l),y=h(),p.appendChild(y),p.appendChild(d))),t){const b=r.querySelectorAll(".a4-page").length;Array.from(r.querySelectorAll(".a4-page")).forEach((M,q)=>{const B=M.querySelector("[data-page-num]"),j=M.querySelector("[data-page-count]");B&&(B.textContent=String(q+1)),j&&(j.textContent=String(b))})}try{Ro()}catch{}try{Do()}catch{}try{Nn()}catch{}try{window.__pdfTunerRefreshPages&&window.__pdfTunerRefreshPages()}catch{}try{window.__pdfTunerLoadValues&&window.__pdfTunerLoadValues()}catch{}}function In({headerFooter:t=!1,logoUrl:e=""}={}){const n=document.querySelector("#templates-preview-host #templates-a4-root");if(!n)return;const r=n.querySelector("[data-a4-pages]");if(!r)return;Array.from(r.querySelectorAll(".a4-page")).forEach(s=>{const c=s.querySelector(".a4-inner");if(!c)return;Array.from(c.querySelectorAll("table.exp-details")).filter(a=>a.getAttribute("data-split-done")!=="1").forEach(a=>{const u=a.querySelector("thead"),d=a.querySelector("colgroup"),l=a.getAttribute("data-group")||"",p=Array.from(a.querySelectorAll("tbody > tr"));if(!p.length){a.setAttribute("data-split-done","1");return}const m=()=>{const b=document.createElement("table");b.className=a.className,b.setAttribute("data-editable-table","expenses"),l&&b.setAttribute("data-group",l),d&&b.appendChild(d.cloneNode(!0));const M=u?u.cloneNode(!0):document.createElement("thead");return b.appendChild(M),b.appendChild(document.createElement("tbody")),b};let h=s,y=c;const g=m();try{c.removeChild(a)}catch{}y.appendChild(g);try{const b=!!y.querySelector("#expenses-top-sheet"),M=!!Array.from(y.querySelectorAll("table.exp-details")).find(q=>q!==g);if(b||M){try{y.removeChild(g)}catch{}({page:h,inner:y}=oe({headerFooter:t,logoUrl:e,landscape:!1})),r.appendChild(h),y.appendChild(g)}}catch{}let E=g;const I=b=>b?.hasAttribute("data-subgroup-header"),x=b=>b?.hasAttribute("data-subgroup-subtotal"),C=b=>b?.hasAttribute("data-group-total"),f=b=>b?.hasAttribute("data-subgroup-marker"),v=b=>b?.getAttribute("data-row")==="item",T=b=>b?.hasAttribute("data-group-bar"),P=()=>y.scrollHeight<=y.clientHeight+.5;let L=null,_=null,R=null;const D=(b=null)=>{({page:h,inner:y}=oe({headerFooter:t,logoUrl:e,landscape:!1})),r.appendChild(h),E=m(),y.appendChild(E);const M=E.tBodies[0];if(L&&!(b&&T(b))&&M.appendChild(L.cloneNode(!0)),_&&!(b&&I(b))){const q=b,B=!!(q&&(q.getAttribute&&q.getAttribute("data-subgroup-subtotal")===R||q.getAttribute&&q.getAttribute("data-row")==="item"||q.hasAttribute&&q.hasAttribute("data-subgroup-marker")));(!b||B)&&M.appendChild(_.cloneNode(!0))}};let N=0;for(;N<p.length;){const b=p[N],M=E.tBodies[0],q=B=>{if(M.appendChild(B),!P()){try{M.removeChild(B)}catch{}let j=!1;try{j=!(M.children&&M.children.length)}catch{}const X=E;if(D(B),j)try{X.parentElement?.removeChild(X)}catch{}E.tBodies[0].appendChild(B)}};if(T(b)){L=b.cloneNode(!0);const B=E.tBodies[0];B&&B.children&&B.children.length>0&&D(b),q(b),N+=1;continue}if(I(b)){_=b.cloneNode(!0),R=b.getAttribute("data-subgroup");const B=[b];let j=N+1,X=0;for(;j<p.length&&X<2;)if(v(p[j]))B.push(p[j]),X+=1,j+=1;else if(f(p[j]))B.push(p[j]),j+=1;else{if(x(p[j]))break;break}if(j<p.length&&x(p[j])&&p[j].getAttribute("data-subgroup-subtotal")===R&&(B.push(p[j]),j+=1),B.forEach(A=>M.appendChild(A)),!P()){B.forEach(k=>{try{M.removeChild(k)}catch{}}),D(B[0]);const A=E.tBodies[0];B.forEach(k=>A.appendChild(k))}N=j;continue}if(C(b)){if(q(b),!P()){const B=M.lastElementChild;let j=null;if(B&&(v(B)||x(B))){try{M.removeChild(B)}catch{}j=B}try{M.removeChild(b)}catch{}D(b);const X=E.tBodies[0];if(j&&X.appendChild(j),X.appendChild(b),!P()){try{X.removeChild(b)}catch{}D(b),E.tBodies[0].appendChild(b)}}_=null,R=null,L=null,N+=1;continue}q(b),N+=1}try{a.setAttribute("data-split-done","1")}catch{}try{Array.from(r.querySelectorAll("table.exp-details")).forEach(b=>{try{b.setAttribute("data-split-done","1")}catch{}})}catch{}})});try{const s=Array.from(r.querySelectorAll(".a4-page"));if(s.length>1){const c=s[0],i=s.slice(1),a={atl:[],prod:[],post:[],other:[]};i.forEach(d=>{const l=d.querySelector("table.exp-details"),p=l&&l.getAttribute("data-group")||"other";p in a?a[p].push(d):a.other.push(d)}),[c,...a.atl,...a.prod,...a.post,...a.other].forEach(d=>{try{r.appendChild(d)}catch{}})}}catch{}try{Array.from(r.querySelectorAll("table.exp-details")).forEach(c=>{const i=Array.from(c.querySelectorAll("thead"));i.length>1&&i.slice(1).forEach(d=>{try{d.parentElement?.removeChild(d)}catch{}});const a=c.tBodies&&c.tBodies[0];if(!!!(a&&a.children&&a.children.length))try{c.parentElement?.removeChild(c)}catch{}})}catch{}try{n.querySelector('table.exp-details:not([data-split-done="1"])')&&requestAnimationFrame(()=>{try{In({headerFooter:t,logoUrl:e})}catch{}})}catch{}}function pe({headerFooter:t=!1,logoUrl:e="",isLandscape:n=!0}={}){const r=document.querySelector("#templates-preview-host #templates-a4-root");if(!r||(document.getElementById("templates-type")?.value||"expenses")==="expenses")return;const s=r.querySelector("[data-a4-pages]");if(!s)return;Array.from(s.querySelectorAll(".a4-page")).forEach(i=>{const a=i.querySelector(".a4-inner");if(!a)return;Array.from(a.querySelectorAll("table.tpl-table")).forEach(d=>{if(!d||d.getAttribute("data-split-done")==="1")return;const l=d.querySelector("thead"),p=d.querySelector("colgroup"),m=Array.from(d.querySelectorAll("tbody > tr"));if(!m.length){d.setAttribute("data-split-done","1");return}const h=()=>{const C=document.createElement("table");C.className=d.className,p&&C.appendChild(p.cloneNode(!0));const f=l?l.cloneNode(!0):document.createElement("thead");return C.appendChild(f),C.appendChild(document.createElement("tbody")),C},y=()=>a.scrollHeight<=a.clientHeight+.5;let g=i,E=a;try{a.removeChild(d)}catch{}let I=h();E.appendChild(I);let x=0;for(;x<m.length;){const C=I.tBodies[0];if(C.appendChild(m[x]),!y()){C.removeChild(m[x]);try{if(!(C.children&&C.children.length)){const v=I;try{E.removeChild(v)}catch{}}}catch{}({page:g,inner:E}=oe({headerFooter:t,logoUrl:e,landscape:n})),s.appendChild(g),I=h(),E.appendChild(I),I.tBodies[0].appendChild(m[x])}x+=1}try{Array.from(s.querySelectorAll("table.tpl-table")).forEach(f=>{const v=f.tBodies&&f.tBodies[0];if(!!!(v&&v.children&&v.children.length))try{f.parentElement?.removeChild(f)}catch{}})}catch{}d.setAttribute("data-split-done","1")})})}function Zt(){try{const t=document.getElementById("templates-a4-root");if(!t)return;Array.from(t.querySelectorAll(".a4-page")).forEach(n=>{dn(n)||t.querySelectorAll(".a4-page").length>1&&n.parentElement?.removeChild(n)});try{ko()}catch{}}catch{}}function ko(){const t=document.getElementById("templates-a4-root");if(!t)return;const e=Array.from(t.querySelectorAll("table.cs-crew"));if(e.length<=1)return;let n=e.find(r=>(r.tBodies?.[0]?.children?.length||0)>0)||e[0];e.forEach(r=>{if(r!==n)try{r.parentElement?.removeChild(r)}catch{}})}function Ro(){Array.from(document.querySelectorAll("#templates-preview-host #templates-a4-root table.exp-table")).forEach(e=>{const n=e.tBodies?.[0];if(!n)return;let r=!1;Array.from(n.children).forEach(o=>{o.getAttribute("data-row")==="item"&&(o.classList.toggle("exp-row-alt",r),r=!r)})})}function Do(){Array.from(document.querySelectorAll("#templates-preview-host #templates-a4-root table.exp-table tr.exp-subheader th")).forEach(e=>{e.style.fontSize="",e.style.whiteSpace="nowrap",e.style.overflow="hidden",e.style.textOverflow="ellipsis";const n=12,r=9;let o=n;const s=()=>e.scrollWidth<=e.clientWidth;for(;o>r&&!s();)o-=.5,e.style.fontSize=o+"px"})}function Nn(t){const e=document.querySelector("#templates-preview-host #templates-a4-root");if(!e)return;const n=t&&t instanceof HTMLElement?t:e,r=Array.from(n.querySelectorAll("table.exp-table td")),o=s=>s&&!/\s/.test(s);r.forEach(s=>{const c=(s.textContent||"").trim();if(!c||!o(c))return;s.style.fontSize="";const i=Number.parseFloat(getComputedStyle(s).fontSize||"11");let a=Number.isFinite(i)?i:11;const u=7,d=()=>s.scrollWidth<=s.clientWidth&&s.scrollHeight<=s.clientHeight;let l=0;for(;!d()&&a>u&&l<40;)a-=.5,s.style.fontSize=a+"px",l+=1})}function Kr(){try{Array.from(document.querySelectorAll("#templates-preview-host #templates-a4-root table.cs-schedule thead th")).forEach(e=>{e.style.fontSize="";const n=Number.parseFloat(getComputedStyle(e).fontSize||"10");let r=Number.isFinite(n)?n:10;const o=8,s=()=>e.scrollWidth<=e.clientWidth+.5&&e.scrollHeight<=e.clientHeight+.5;let c=0;for(;!s()&&r>o&&c<30;)r-=.5,e.style.fontSize=r+"px",c+=1})}catch{}}function Zr({onAfterChange:t}={}){const e=document.getElementById("templates-preview-host");if(!e)return;const n=document.getElementById("templates-type")?.value||"expenses";let r=document.getElementById("tpl-cell-toolbar");if(!(n==="callsheet"||n==="expenses")){r&&(r.style.display="none");return}r||(r=document.createElement("div"),r.id="tpl-cell-toolbar",Object.assign(r.style,{position:"fixed",display:"none",zIndex:9999}),r.innerHTML=`
      <div style="display:inline-flex;gap:4px;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:4px;box-shadow:0 2px 8px rgba(15,23,42,0.12);">
        <button type="button" data-act="row-add" class="btn btn-outline" style="height:28px;padding:0 8px">+ صف</button>
        <button type="button" data-act="row-full" class="btn btn-outline" style="height:28px;padding:0 8px">+ صف كامل</button>
        <button type="button" data-act="row-full-del" class="btn btn-outline btn-danger" style="height:28px;padding:0 8px">× صف كامل</button>
        <button type="button" data-act="row-del" class="btn btn-outline btn-danger" style="height:28px;padding:0 8px">× صف</button>
        <button type="button" data-act="row-up" class="btn btn-outline" style="height:28px;padding:0 8px">↑</button>
        <button type="button" data-act="row-down" class="btn btn-outline" style="height:28px;padding:0 8px">↓</button>
        <span data-sep style="width:1px;background:#e5e7eb;margin:0 4px"></span>
        <button type="button" data-act="cast-add" class="btn btn-outline" style="height:28px;padding:0 8px">+ خانة</button>
        <button type="button" data-act="cast-del" class="btn btn-outline btn-danger" style="height:28px;padding:0 8px">× خانة</button>
        <button type="button" data-act="cast-add-row" class="btn btn-outline" style="height:28px;padding:0 8px">+ صف اسم/وقت</button>
        <button type="button" data-act="cast-del-row" class="btn btn-outline btn-danger" style="height:28px;padding:0 8px">× صف اسم/وقت</button>
      </div>`,e.appendChild(r),r.__lock=!1,r.__switchTimer=null,r.__freezeUntil=0,r.addEventListener("pointerenter",()=>{r.__lock=!0}),r.addEventListener("pointerleave",()=>{r.__lock=!1}),r.addEventListener("click",c=>{const i=c.target.closest("[data-act]");if(!i)return;const a=i.getAttribute("data-act"),u=r.__targetCell||null;if(!u)return;const d=u.closest("table.cs-schedule")||u.closest("table.cs-crew")||u.closest("table.exp-details"),l=u.closest("table.cs-cast"),p=()=>{const f=u.closest("tr");if(!f)return;const v=Xr(f);v&&Vr(v,0)},m=()=>{const f=u.closest("tr");f&&(f.classList.contains("cs-row-note")||f.classList.contains("cs-row-strong")||f.hasAttribute("data-group-bar")||f.hasAttribute("data-subgroup-header")||f.hasAttribute("data-subgroup-subtotal")||f.hasAttribute("data-group-total")||f.hasAttribute("data-subgroup-marker")||Gr(f))},h=f=>{const v=u.closest("tr");v&&Yr(v,f)},y=()=>{try{typeof t=="function"&&t()}catch{}try{setTimeout(()=>{pe(),Zt()},30)}catch{}try{typeof window.__enforceCallsheetSizing=="function"&&window.__enforceCallsheetSizing()}catch{}try{document.dispatchEvent(new CustomEvent("templates:afterRowChange"))}catch{}},g=()=>{const f=d||u.closest("table");if(!f)return;const v=u.closest("tr"),T=v?.parentElement;if(!v||!T)return;const P=(()=>{try{const R=f.querySelectorAll("thead tr"),D=R&&R.length?R[R.length-1]:null;if(D&&D.children&&D.children.length)return D.children.length;const N=f.querySelectorAll("colgroup col");return N&&N.length?N.length:12}catch{return 12}})(),L=document.createElement("tr"),_=document.createElement("td");_.setAttribute("colspan",String(P)),_.setAttribute("data-editable","true"),_.setAttribute("contenteditable","true"),L.appendChild(_),T.insertBefore(L,v.nextElementSibling)},E=()=>{const f=l;if(!f)return;const v=f.tBodies&&f.tBodies[0];if(!v)return;const T=v.children&&v.children[1],P=v.children&&v.children[2];if(!T||!P)return;const L=document.createElement("td");L.setAttribute("data-editable","true"),L.setAttribute("contenteditable","true"),T.appendChild(L);const _=document.createElement("td");_.setAttribute("data-editable","true"),_.setAttribute("contenteditable","true"),P.appendChild(_)},I=()=>{const f=l;if(!f)return;const v=f.tBodies&&f.tBodies[0];if(!v)return;const T=v.children&&v.children[1],P=v.children&&v.children[2];!T||!P||T.children.length<=2||P.children.length<=2||(T.removeChild(T.lastElementChild),P.removeChild(P.lastElementChild))},x=()=>{const f=l;if(!f)return;const v=f.tBodies&&f.tBodies[0];if(!v)return;const T=v.children&&v.children[1],P=v.children&&v.children[2];if(!T||!P)return;const L=T.querySelector(".cs-weather"),_=T.children.length-(L?1:0),R=document.createElement("tr"),D=document.createElement("tr");for(let N=0;N<_;N+=1){const b=document.createElement("td");b.setAttribute("data-editable","true"),b.setAttribute("contenteditable","true"),R.appendChild(b)}for(let N=0;N<_;N+=1){const b=document.createElement("td");b.setAttribute("data-editable","true"),b.setAttribute("contenteditable","true"),D.appendChild(b)}if(v.appendChild(R),v.appendChild(D),L){const N=v.querySelectorAll("tr").length-1;L.setAttribute("rowspan",String(N))}},C=()=>{const f=l;if(!f)return;const v=f.tBodies&&f.tBodies[0];if(!v||v.children.length<=3)return;const T=v.lastElementChild,P=T?.previousElementSibling;P&&T&&P.tagName==="TR"&&(v.removeChild(T),v.removeChild(P));const _=v.children[1]?.querySelector(".cs-weather");if(_){const R=v.querySelectorAll("tr").length-1;_.setAttribute("rowspan",String(R))}};if(a==="row-add"&&d)p(),y();else if(a==="row-full"&&d)g(),y();else if(a==="row-full-del"&&d){const f=u.closest("tr"),v=(()=>{try{const P=d.querySelectorAll("thead tr"),L=P&&P.length?P[P.length-1]:null;if(L&&L.children&&L.children.length)return L.children.length;const _=d.querySelectorAll("colgroup col");return _&&_.length?_.length:12}catch{return 12}})();f&&f.children&&f.children.length===1&&Number(f.children[0]?.getAttribute("colspan")||"1")>=v&&(f.parentElement?.removeChild(f),y())}else a==="row-del"&&d?(m(),y()):a==="row-up"&&d?(h(-1),y()):a==="row-down"&&d?(h(1),y()):a==="cast-add"&&l?(E(),y()):a==="cast-del"&&l?(I(),y()):a==="cast-add-row"&&l?(x(),y()):a==="cast-del-row"&&l&&(C(),y())}));const o=c=>{if(!c){r.style.display="none",r.__targetCell=null;return}const i=c.closest("table.cs-schedule")||c.closest("table.cs-crew")||c.closest("table.exp-details"),a=c.closest("table.cs-cast");if(!i&&!a){r.style.display="none",r.__targetCell=null;return}let u=!!i;const d=!!a;try{if(u&&i&&i.matches("table.exp-details")){const y=c.closest("tr");u=!!(y&&y.getAttribute("data-row")==="item")}}catch{}Array.from(r.querySelectorAll('[data-act^="row-"]')).forEach(y=>y.style.display=u?"inline-flex":"none"),Array.from(r.querySelectorAll('[data-act^="cast-"]')).forEach(y=>y.style.display=d?"inline-flex":"none"),r.querySelector("[data-sep]")?.setAttribute("style",`width:1px;background:#e5e7eb;margin:0 4px;display:${u&&d?"inline-block":"none"}`);try{const y=r.querySelector('[data-act="row-full"]'),g=r.querySelector('[data-act="row-full-del"]');if(i&&i.matches("table.exp-details"))y&&(y.style.display="none"),g&&(g.style.display="none");else if(g&&i){const E=c.closest("tr"),I=i.querySelector("thead tr"),x=I&&I.children&&I.children.length?I.children.length:12,C=E&&E.children&&E.children.length===1&&Number(E.children[0]?.getAttribute("colspan")||"1")>=x;g.style.display=C?"inline-flex":"none",y&&(y.style.display="inline-flex")}}catch{}const l=c.getBoundingClientRect(),p=6,m=Math.round(l.left+Math.min(l.width-28,12)),h=Math.round(l.top-(r.offsetHeight||32)-p);r.style.transform="none",r.style.left=`${m}px`,r.style.top=`${Math.max(0,h)}px`,r.style.display="block",r.__targetCell=c},s=()=>{const c=document.getElementById("templates-a4-root");if(!c)return;const i=()=>{if(r.__lock)return;const u=window.getSelection();if(!u||u.rangeCount===0){r.__lock||(r.style.display="none");return}let d=u.anchorNode;d&&d.nodeType===3&&(d=d.parentElement);const l=d instanceof Element?d.closest("td,th"):null;if(!l){r.__lock||(r.style.display="none");return}o(l)};document.addEventListener("selectionchange",i);const a=u=>{const d=u.target;if(d instanceof Element&&(d.getAttribute("contenteditable")==="true"||d.closest('[contenteditable="true"]'))){const l=d.closest("td,th");l&&o(l)}};c.addEventListener("focusin",a,!0),r.__detach=()=>{try{document.removeEventListener("selectionchange",i),c.removeEventListener("focusin",a,!0)}catch{}}};r.__attachedOnce||(s(),r.__attachedOnce=!0)}function qo(t,{onAfterChange:e,onTotalsChange:n,onRenumber:r}={}){if(!t)return()=>{};const o=s=>{const c=s.target.closest("[data-action]");if(!c)return;const i=c.getAttribute("data-action"),a=c.closest("tr"),u=a?.parentElement;if(!(!a||!u)){if(i==="row-up"&&a.previousElementSibling&&!a.previousElementSibling.matches("[data-section-bar]"))u.insertBefore(a,a.previousElementSibling);else if(i==="row-down"&&a.nextElementSibling)u.insertBefore(a.nextElementSibling,a);else if(i==="row-add"){const d=a.cloneNode(!0);d.querySelectorAll("[contenteditable]")?.forEach(l=>{l.textContent=""}),u.insertBefore(d,a.nextElementSibling)}else i==="row-delete"&&u.removeChild(a);try{typeof r=="function"&&r()}catch{}try{typeof n=="function"&&n()}catch{}try{Nn(u)}catch{}try{typeof e=="function"&&e()}catch{}}};return t.addEventListener("click",o),()=>{try{t.removeEventListener("click",o)}catch{}}}function Zn(t){let e=t?.nextElementSibling;for(;e&&Xt(e);)e=e.nextElementSibling;return e}function jo(t,e,n){if(!(!t||!e||n<=0))for(let r=0;r<n;r+=1){const o=e.cloneNode(!0);o.querySelectorAll("[contenteditable]")?.forEach(s=>{s.textContent=""}),t.appendChild(o)}}function Fo(t){return t?t.split(/\r?\n/).map(n=>n.replace(/\r$/,"")).filter(n=>n.trim().length>0).map(n=>n.split(/\t|,|;/).map(r=>r.trim())):[]}function $o(t,e,n){if(!t||!n||!n.length)return;const r=Array.from(t.children);let o=Math.max(0,e);for(let s=0;s<n.length&&o<r.length;s+=1){for(;o<r.length&&!r[o].hasAttribute("contenteditable");)o+=1;if(o>=r.length)break;const c=r[o],i=n[s]??"";c.textContent=String(i),o+=1}}function Oo(t,{onAfterChange:e,onTotalsChange:n}={}){if(!t)return()=>{};const r=s=>{const c=s.target,i=c&&c.closest("[contenteditable]"),a=c&&c.closest("table.tpl-table");if(!i||!a)return;const u=s.clipboardData?.getData("text/plain")??"";if(!u||!u.includes("	")&&!u.includes(`
`))return;s.preventDefault();const d=Fo(u);if(!d.length)return;const l=c.closest("td"),p=Mo(l),m=a.tBodies?.[0]||a.querySelector("tbody");if(!m)return;let h=Array.from(m.children).find(C=>C&&!Xt(C)),y=l.parentElement,g=0,E=y;for(;E;)Xt(E)||(g+=1),E=E.nextElementSibling;const I=d.length-g;I>0&&h&&jo(m,h,I);let x=y;d.forEach((C,f)=>{for(;x&&Xt(x);)x=Zn(x);if(!x)return;const v=f===0?p:0,T=C.map(P=>{const L=String(P||""),_={"٠":"0","١":"1","٢":"2","٣":"3","٤":"4","٥":"5","٦":"6","٧":"7","٨":"8","٩":"9"},R={"۰":"0","۱":"1","۲":"2","۳":"3","۴":"4","۵":"5","۶":"6","۷":"۷","۸":"8","۹":"9"};return L.replace(/[\u0660-\u0669]/g,D=>_[D]).replace(/[\u06F0-\u06F9]/g,D=>R[D])});$o(x,v,T),x=Zn(x)||x?.nextElementSibling}),typeof n=="function"&&n();try{Nn(a)}catch{}},o=s=>{const c=s.target;if(!c||!c.closest("table.tpl-table"))return;const i=c.closest("table.tpl-table"),a=c.closest("tr");if(a){if(s.key==="Enter"&&!s.shiftKey){s.preventDefault();const u=Xr(a);u&&(Vr(u),typeof n=="function"&&(i.getAttribute("data-editable-table")==="expenses"||i.id==="expenses-table")&&n());try{typeof e=="function"&&e()}catch{}return}if(s.altKey&&(s.key==="ArrowUp"||s.key==="ArrowDown")){s.preventDefault(),Yr(a,s.key==="ArrowDown"?1:-1),typeof n=="function"&&(i.getAttribute("data-editable-table")==="expenses"||i.id==="expenses-table")&&n();try{typeof e=="function"&&e()}catch{}return}if((s.key==="Delete"||s.key==="Backspace")&&s.ctrlKey){s.preventDefault(),Gr(a),typeof n=="function"&&(i.getAttribute("data-editable-table")==="expenses"||i.id==="expenses-table")&&n();try{typeof e=="function"&&e()}catch{}}}};return t.addEventListener("paste",r),t.addEventListener("keydown",o,!0),()=>{try{t.removeEventListener("paste",r)}catch{}try{t.removeEventListener("keydown",o,!0)}catch{}}}function Ho(t){try{const e=t.querySelector(".callsheet-v1");if(!e)return[];const n=Array.from(e.querySelectorAll("table")),r=[];return n.forEach((o,s)=>{const c=o.classList.contains("cs-schedule")?"schedule":o.classList.contains("cs-cast")?"cast":o.classList.contains("cs-info")?"info":"";Array.from(o.querySelectorAll("tr")).forEach((a,u)=>{Array.from(a.children).forEach((l,p)=>{if(l.getAttribute&&l.getAttribute("data-shaded")==="1"){const m=l.style.getPropertyValue("--shade")||l.style.backgroundColor||"";r.push({ti:s,ri:u,ci:p,shade:m,tp:c})}})})}),r}catch{return[]}}function Jr(t){if(!t)return[];const e=Cn();return Array.isArray(e)?e.filter(n=>String(n?.projectId??n?.project_id??"")===String(t)):[]}let Gt=1,xe=null,At="manual",Jn=!1,pn=!1,Z={hostInput:null,hostMouseDown:null,hostFocusIn:null,hostFocusOut:null,hostCompStart:null,hostCompEnd:null,projChanged:null,resChanged:null,resUpdated:null,tabClick:null},Nt=null,Ut=null,se=null,Me=null,Je=null,ke=null,Qe=!1,Qn=null,tr=null;function re(t){try{const e=t||document.querySelector("#templates-preview-host #templates-a4-root");if(!e)return;try{Qr(e)}catch{}Array.from(e.querySelectorAll("table.cs-crew")).forEach(o=>{try{o.style.setProperty("width","90%","important"),o.style.setProperty("margin-left","auto","important"),o.style.setProperty("margin-right","auto","important")}catch{}});const r=Array.from(e.querySelectorAll("table.cs-schedule"));r.forEach(o=>{try{o.style.setProperty("width","calc(82% + 120px)","important"),o.style.setProperty("margin-left","11mm","important"),o.style.setProperty("margin-right","-16mm","important");const s=o.closest(".a4-inner");s&&(s.style.setProperty("padding-left","0mm","important"),s.style.setProperty("padding-right","0mm","important"))}catch{}});try{const o=r[0];if(o){const s=o.tBodies&&o.tBodies[0];if(s){const c=Array.from(s.children),i=d=>d.classList?.contains("cs-row-note")||d.classList?.contains("cs-row-strong");let a=c.filter(d=>!i(d));const u=(()=>{const d=o.querySelector("thead tr");return d&&d.children&&d.children.length?d.children.length:12})();for(;a.length<4;){const d=document.createElement("tr");for(let l=0;l<u;l+=1){const p=document.createElement("td");p.setAttribute("data-editable","true"),p.setAttribute("contenteditable","true"),d.appendChild(p)}s.appendChild(d),a.push(d)}}}}catch{}}catch{}}try{window.__enforceCallsheetSizing=re}catch{}function Qr(t){const e=t||document.getElementById("templates-a4-root");if(!e)return;Array.from(e.querySelectorAll("table.cs-crew, table.cs-schedule")).forEach(r=>{const o=r.closest(".a4-inner");if(!o||r.closest(".callsheet-v1"))return;let c=o.querySelector(":scope > .callsheet-v1");c||(c=document.createElement("div"),c.className="callsheet-v1",o.insertBefore(c,r));try{c.appendChild(r)}catch{}})}function er(){try{const t=document.getElementById("templates-preview-host");if(t){try{Z.hostInput&&t.removeEventListener("input",Z.hostInput)}catch{}try{Me&&(Me(),Me=null)}catch{}try{Z.hostMouseDown&&t.removeEventListener("mousedown",Z.hostMouseDown,!0)}catch{}try{Z.hostFocusIn&&t.removeEventListener("focusin",Z.hostFocusIn,!0)}catch{}try{Z.hostFocusOut&&t.removeEventListener("focusout",Z.hostFocusOut,!0)}catch{}try{Z.hostCompStart&&t.removeEventListener("compositionstart",Z.hostCompStart,!0)}catch{}try{Z.hostCompEnd&&t.removeEventListener("compositionend",Z.hostCompEnd,!0)}catch{}try{ke&&(ke(),ke=null)}catch{}try{const e=document.getElementById("tpl-cell-toolbar");e&&typeof e.__detach=="function"&&e.__detach()}catch{}}if(Z.projChanged&&document.removeEventListener("projects:changed",Z.projChanged),Z.resChanged&&document.removeEventListener("reservations:changed",Z.resChanged),Z.resUpdated&&document.removeEventListener("reservations:updated",Z.resUpdated),Z.tabClick){const e=document.querySelector('[data-project-subtab-target="projects-templates-tab"]');e&&e.removeEventListener("click",Z.tabClick)}if(Ut&&(clearTimeout(Ut),Ut=null),se){try{se.disconnect()}catch{}se=null}}finally{pn=!1,Nt=null,Z={hostInput:null,hostMouseDown:null,hostFocusIn:null,hostFocusOut:null,projChanged:null,resChanged:null,resUpdated:null,tabClick:null}}}function Kt(t,e="تعذر الاتصال بالخادم"){try{let n=t&&t.message?String(t.message):e;try{const r=t&&t.payload&&t.payload.raw?String(t.payload.raw):"",o=`${n}
${r}`;/Missing configuration file/i.test(o)&&(n="الخادم غير مُعد: يرجى نسخ backend/config.example.php إلى backend/config.php وتعبئة بيانات الاتصال (Database + allowed_origins) ثم إعادة المحاولة.")}catch{}typeof Bt=="function"?Bt(n,"error",7e3):alert(n)}catch{}}function ta(){try{return Math.max(.3,Math.min(2.5,Number(localStorage.getItem("templates.preview.zoom")||"1")))}catch{return 1}}function zo(t){try{localStorage.setItem("templates.preview.zoom",String(t))}catch{}}function ea(){try{return(localStorage.getItem("templates.preview.zoomMode")||"manual")==="fit"?"fit":"manual"}catch{return"manual"}}function mn(t){try{localStorage.setItem("templates.preview.zoomMode",t==="fit"?"fit":"manual")}catch{}}function Ee(t,{silent:e=!1,markManual:n=!1}={}){Gt=Math.min(Math.max(t,.25),2.5),Uo(Gt),zo(Gt),!e&&xe&&(xe.textContent=`${Math.round(Gt*100)}%`)}function nr(t){At="manual",mn(At),Ee(Gt+t,{markManual:!0})}function Uo(t){const e=document.querySelector("#templates-preview-host > #templates-a4-root")||document.querySelector("#templates-preview-host #templates-a4-root");if(e){try{e.style.transformOrigin="top center"}catch{}try{e.style.transform=`scale(${t})`}catch{}}}function Wo(){try{const e=document.querySelector("#templates-preview-host #templates-a4-root .a4-page");if(e)return e.getBoundingClientRect().width||e.offsetWidth||794}catch{}return(document.getElementById("templates-type")?.value||"expenses")!=="expenses"?1123:794}function Vo(){const t=document.getElementById("templates-preview-host");if(!t)return null;try{const e=window.getComputedStyle(t),n=parseFloat(e.paddingLeft||"0")||0,r=parseFloat(e.paddingRight||"0")||0;return Math.max(0,t.clientWidth-n-r)}catch{return t.clientWidth||null}}function Xo(){const t=Wo(),e=Vo();return!t||!e?1:Math.max(.25,Math.min(2.5,e/t))}function Ce(){const t=Xo();Ee(t,{silent:!1})}function rr(){Jn||(window.addEventListener("resize",()=>{At==="fit"&&Ce()},{passive:!0}),Jn=!0)}function ar(){try{if(se)return;const t=document.getElementById("templates-preview-host");if(!t||typeof ResizeObserver>"u")return;se=new ResizeObserver(()=>{At==="fit"&&Ce()}),se.observe(t)}catch{}}function tn(t=180){try{Je&&clearTimeout(Je)}catch{}Je=setTimeout(()=>{try{jn()}catch{}},Math.max(0,t))}const na="projects.templates.type";function Yo(){try{const t=String(localStorage.getItem(na)||"").trim();return t&&(t==="expenses"||t==="callsheet")?t:""}catch{return""}}function Go(t){try{t&&localStorage.setItem(na,String(t))}catch{}}function Ko(t){if(!t)return;let e="";try{const s=new URLSearchParams(window.location.search||"");e=s.get("tplType")||s.get("templatesType")||""}catch{}const n=Yo(),r=e&&(e==="expenses"||e==="callsheet")?e:n;if(!r)return;Array.from(t.options).some(s=>s.value===r)&&(t.value=r)}function Zo(){const t=document.getElementById("templates-actions");if(!t||document.getElementById("tpl-zoom-controls"))return;const e=document.createElement("div");e.id="tpl-zoom-controls",e.className="tpl-zoom-controls",e.innerHTML=`
    <button type="button" class="tpl-zoom-btn" data-tpl-zoom-out title="تصغير">−</button>
    <span class="tpl-zoom-value" data-tpl-zoom-value>100%</span>
    <button type="button" class="tpl-zoom-btn" data-tpl-zoom-in title="تكبير">+</button>
    <button type="button" class="tpl-zoom-btn" data-tpl-zoom-fit title="ملء العرض">↔︎</button>
    <button type="button" class="tpl-zoom-btn" data-tpl-zoom-reset title="1:1">1:1</button>
  `,t.appendChild(e);const n=e.querySelector("[data-tpl-zoom-out]"),r=e.querySelector("[data-tpl-zoom-in]"),o=e.querySelector("[data-tpl-zoom-reset]"),s=e.querySelector("[data-tpl-zoom-fit]");xe=e.querySelector("[data-tpl-zoom-value]"),n?.addEventListener("click",()=>nr(-.1)),r?.addEventListener("click",()=>nr(.1)),o?.addEventListener("click",()=>{At="manual",mn(At),Ee(1,{markManual:!0})}),s?.addEventListener("click",()=>{At="fit",mn(At),Ce(),rr(),ar()}),At=ea(),At==="fit"?(Ce(),rr(),ar()):Ee(ta(),{silent:!1})}function Jo(t="expenses"){if(!document.getElementById("templates-actions"))return;const n=document.getElementById("templates-controls"),r=document.getElementById("tpl-logo-controls"),o=document.getElementById("tpl-controls-row2")||(()=>{const l=document.createElement("div");return l.id="tpl-controls-row2",Object.assign(l.style,{display:"flex",flexWrap:"wrap",gap:"8px",width:"100%",alignItems:"center",marginTop:"6px"}),n?.appendChild(l),l})();if(t!=="callsheet"){r&&r.remove();return}if(r)return;const s=document.createElement("div");s.id="tpl-logo-controls",Object.assign(s.style,{display:"inline-flex",gap:"6px",alignItems:"center",flexWrap:"wrap"}),s.innerHTML=`
    <div class="input-group" style="display:inline-flex;gap:6px;align-items:center;">
      <label class="form-label" style="margin:0 4px 0 0;">لوغو ارت ريشيو</label>
      <input type="range" id="tpl-logo1-size" min="0.3" max="3" step="0.01" title="حجم لوغو ارت ريشيو">
      <button type="button" class="btn btn-outline" id="tpl-logo1-reset" title="إعادة تموضع لوغو ارت ريشيو">↺</button>
      <label class="form-check-label" style="display:inline-flex;align-items:center;gap:6px;margin:0 0 0 8px;">
        <input type="checkbox" id="tpl-logo1-hide" class="form-check-input">
        <span>إخفاء اللوغو</span>
      </label>
    </div>
    <div class="input-group" style="display:inline-flex;gap:6px;align-items:center;">
      <input type="url" id="tpl-logo2-url" class="form-control" placeholder="🔗 رابط لوغو إضافي" style="min-width:220px;max-width:320px;">
      <input type="range" id="tpl-logo2-size" min="0.3" max="3" step="0.01" title="حجم لوغو العميل">
      <button type="button" class="btn btn-outline" id="tpl-logo2-apply">تطبيق</button>
      <button type="button" class="btn btn-outline" id="tpl-logo2-reset">إعادة تموضع</button>
      <button type="button" class="btn btn-outline btn-danger" id="tpl-logo2-clear">حذف</button>
    </div>
    <div class="input-group" id="tpl-font-controls" style="display:inline-flex;gap:6px;align-items:center;">
      <label class="form-label" style="margin:0 4px 0 0;">حجم الخط</label>
      <button type="button" class="btn btn-outline" id="tpl-font-down" title="تصغير الخط">A−</button>
      <button type="button" class="btn btn-outline" id="tpl-font-up" title="تكبير الخط">A+</button>
      <button type="button" class="btn btn-outline" id="tpl-font-bold" title="تسميك الخط (Bold)"><strong>B</strong></button>
    </div>
    <div class="input-group" id="tpl-shade-controls" style="display:inline-flex;gap:6px;align-items:center;">
      <label class="form-label" style="margin:0 4px 0 0;">تظليل</label>
      <input type="color" id="tpl-shade-color" value="#fff59d" title="لون التظليل">
      <input type="range" id="tpl-shade-opacity" min="0" max="100" step="1" value="40" title="الشفافية %">
      <select id="tpl-shade-target" class="form-select" style="height:32px;">
        <option value="cell">خلية</option>
        <option value="row">صف</option>
      </select>
      <button type="button" class="btn btn-outline" id="tpl-shade-apply">تطبيق</button>
      <button type="button" class="btn btn-outline btn-danger" id="tpl-shade-clear">إزالة</button>
    </div>
    <div class="input-group" id="tpl-history-controls" style="display:inline-flex;gap:6px;align-items:center;">
      <button type="button" class="btn btn-outline" id="tpl-undo" title="تراجع">↶</button>
      <button type="button" class="btn btn-outline" id="tpl-redo" title="تقديم">↷</button>
    </div>
  `,o.appendChild(s);try{const l=Bn(),p=document.getElementById("tpl-logo2-url"),m=document.getElementById("tpl-logo2-size");p&&l.url&&(p.value=l.url),m&&(m.value=String(l.s||1));const h=Mn(),y=document.getElementById("tpl-logo1-size");y&&(y.value=String(h.s||1));const g=document.getElementById("tpl-logo1-hide");g&&(g.checked=!!h.h)}catch(l){Kt(l,"تعذر حفظ القالب")}document.getElementById("tpl-logo2-apply")?.addEventListener("click",()=>{const l=document.getElementById("tpl-logo2-url")?.value?.trim()||"";Re({url:l});try{gt()}catch{}}),document.getElementById("tpl-logo2-clear")?.addEventListener("click",()=>{Re({url:"",w:0,x:0,y:0});try{const l=me(),p=localStorage.getItem(l);if(p){const m=JSON.parse(p);if(m){if(m.snap&&m.snap.r&&(m.snap.r.url=""),m.html&&typeof m.html=="string")try{const h=document.createElement("div");h.innerHTML=m.html;const y=h.firstElementChild,g=y&&y.querySelector(".cs-logo--right img");if(g){g.removeAttribute("src");const E=g.closest(".cs-logo--right");E&&E.setAttribute("data-empty","1")}m.html=y?y.outerHTML:m.html}catch{}localStorage.setItem(l,JSON.stringify(m))}}}catch{}try{Rt(),kt()}catch{}try{gt()}catch{}}),document.getElementById("tpl-logo2-reset")?.addEventListener("click",()=>{Re({x:0,y:0});try{gt()}catch{}}),document.getElementById("tpl-logo1-hide")?.addEventListener("change",l=>{const p=!!l?.target?.checked;try{ra({h:p})}catch{}try{gt()}catch{}}),document.getElementById("tpl-undo")?.addEventListener("click",()=>Io()),document.getElementById("tpl-redo")?.addEventListener("click",()=>No());const c=document.getElementById("tpl-font-down"),i=document.getElementById("tpl-font-up");c?.addEventListener("click",l=>{try{ir(l&&l.shiftKey?-2:-1)}catch{}}),i?.addEventListener("click",l=>{try{ir(l&&l.shiftKey?2:1)}catch{}}),document.getElementById("tpl-font-bold")?.addEventListener("click",()=>{try{ts()}catch{}});const u=document.getElementById("tpl-shade-apply"),d=document.getElementById("tpl-shade-clear");u?.addEventListener("click",()=>{try{ns()}catch{}}),d?.addEventListener("click",()=>{try{rs()}catch{}})}function Ft(){const e=document.getElementById("templates-project")?.value||"";return ie().find(n=>String(n.id)===String(e))||null}function ge(t){const e=document.getElementById("templates-reservation");if(!e)return[];const n=e.value||"",r=Jr(t);if(!n)return r;const o=r.find(s=>String(s.id||s.reservationId)===String(n));return o?[o]:[]}const Et={logoUrl:"https://art-ratio.sirv.com/AR-Logo-v3.5-curved.png",companyName:"شركة فود آرت للدعاية والإعلان (شركة شخص واحد)",companyCR:"4030485240",companyLicense:"159460"};let jt=typeof localStorage<"u"&&localStorage.getItem("templates.lang")||"en";function or(t){jt=t==="ar"?"ar":"en";try{localStorage.setItem("templates.lang",jt)}catch{}}function yt(t){try{const e=Math.round(Number(t)||0),n=jt==="ar"?"ar-SA":"en-US";return e.toLocaleString(n,{maximumFractionDigits:0,minimumFractionDigits:0,useGrouping:!0})}catch{const n=Math.round(Number(t)||0);return String(n)}}function Qo(){return{headerFooter:!1,logoUrl:Et.logoUrl,companyName:Et.companyName,companyCR:Et.companyCR,companyLicense:Et.companyLicense}}function Bn(){try{return{url:localStorage.getItem("templates.callsheet.logo2.url")||"",s:Number(localStorage.getItem("templates.callsheet.logo2.s")||"1")||1,x:Number(localStorage.getItem("templates.callsheet.logo2.x")||"0")||0,y:Number(localStorage.getItem("templates.callsheet.logo2.y")||"0")||0}}catch{return{url:"",w:0,x:0,y:0}}}function Re(t={}){try{const n={...Bn(),...t};typeof n.url=="string"&&localStorage.setItem("templates.callsheet.logo2.url",n.url),Number.isFinite(n.s)&&localStorage.setItem("templates.callsheet.logo2.s",String(n.s)),Number.isFinite(n.x)&&localStorage.setItem("templates.callsheet.logo2.x",String(n.x)),Number.isFinite(n.y)&&localStorage.setItem("templates.callsheet.logo2.y",String(n.y))}catch{}}function Mn(){try{return{s:Number(localStorage.getItem("templates.callsheet.logo1.s")||"1")||1,x:Number(localStorage.getItem("templates.callsheet.logo1.x")||"0")||0,y:Number(localStorage.getItem("templates.callsheet.logo1.y")||"0")||0,h:localStorage.getItem("templates.callsheet.logo1.h")==="1"}}catch{return{s:1,x:0,y:0,h:!1}}}function ra(t={}){try{const n={...Mn(),...t};Number.isFinite(n.s)&&localStorage.setItem("templates.callsheet.logo1.s",String(n.s)),Number.isFinite(n.x)&&localStorage.setItem("templates.callsheet.logo1.x",String(n.x)),Number.isFinite(n.y)&&localStorage.setItem("templates.callsheet.logo1.y",String(n.y)),typeof n.h=="boolean"&&localStorage.setItem("templates.callsheet.logo1.h",n.h?"1":"0")}catch{}}let $e=!1,sr=null,cr=null,lr=null;function Mt(){$e=!0,clearTimeout(sr),sr=setTimeout(()=>{$e=!1;try{ls()}catch{}},1200)}function ir(t=0){try{if(!document.getElementById("templates-a4-root")||!Number.isFinite(t)||t===0)return;const n=window.getSelection(),o=(()=>{let u=n&&n.anchorNode||document.activeElement;if(!u)return null;u.nodeType===3&&(u=u.parentElement);let d=u instanceof Element?u:null;for(;d&&d!==document.body;){if(d.hasAttribute&&d.hasAttribute("contenteditable"))return d;d=d.parentElement}return null})();if(!o)return;const s=Number.parseFloat(getComputedStyle(o).fontSize||"11")||11,i=(u=>Math.max(7,Math.min(20,u)))(s+t),a=u=>{try{u.style.fontSize=i+"px"}catch{}};if(n&&n.rangeCount>0&&!n.isCollapsed){const u=n.getRangeAt(0);if(o.contains(u.commonAncestorContainer))try{const d=document.createElement("span");d.style.fontSize=i+"px";const l=u.extractContents();d.appendChild(l),u.insertNode(d),n.removeAllRanges();const p=document.createRange();p.setStartAfter(d),p.setEndAfter(d),n.addRange(p)}catch{a(o)}else a(o)}else a(o);try{Rt(),kt()}catch{}Mt()}catch{}}function ts(){try{if(!document.getElementById("templates-a4-root"))return;const e=window.getSelection(),r=(()=>{let i=e&&e.anchorNode||document.activeElement;if(!i)return null;i.nodeType===3&&(i=i.parentElement);let a=i instanceof Element?i:null;for(;a&&a!==document.body;){if(a.hasAttribute&&a.hasAttribute("contenteditable"))return a;a=a.parentElement}return null})();if(!r)return;const s=!(Number.parseInt(getComputedStyle(r).fontWeight||"400",10)>=600),c=i=>{try{i.style.fontWeight=s?"700":"400"}catch{}};if(e&&e.rangeCount>0&&!e.isCollapsed){const i=e.getRangeAt(0);if(r.contains(i.commonAncestorContainer))try{const a=document.createElement("span");a.style.fontWeight=s?"700":"400";const u=i.extractContents();a.appendChild(u),i.insertNode(a),e.removeAllRanges();const d=document.createRange();d.setStartAfter(a),d.setEndAfter(a),e.addRange(d)}catch{c(r)}else c(r)}else c(r);try{Rt(),kt()}catch{}Mt()}catch{}}function es(t){try{let e=(t||"").trim();e.startsWith("#")&&(e=e.slice(1)),e.length===3&&(e=e.split("").map(c=>c+c).join(""));const n=parseInt(e,16),r=n>>16&255,o=n>>8&255,s=n&255;return{r,g:o,b:s}}catch{return{r:255,g:255,b:0}}}function aa(){try{const t=document.getElementById("templates-a4-root");if(!t)return null;const e=window.getSelection();let n=e&&e.anchorNode||document.activeElement;if(!n)return null;n.nodeType===3&&(n=n.parentElement);let r=n instanceof Element?n:null;for(;r&&r!==document.body;){if((r.tagName==="TD"||r.tagName==="TH")&&t.contains(r))return r;r=r.parentElement}return null}catch{return null}}function en(t,e){if(t)try{t.setAttribute("data-shaded","1"),t.style.setProperty("--shade",e),t.style.setProperty("background","var(--shade)","important"),t.style.setProperty("background-color","var(--shade)","important")}catch{}}function nn(t){if(t)try{t.removeAttribute("data-shaded"),t.style.removeProperty("--shade"),t.style.removeProperty("background"),t.style.removeProperty("background-color")}catch{}}function ns(){const t=document.getElementById("tpl-shade-color"),e=document.getElementById("tpl-shade-opacity"),n=document.getElementById("tpl-shade-target"),{r,g:o,b:s}=es(t?.value||"#fff59d"),c=Math.max(0,Math.min(100,Number(e?.value||40)))/100,i=`rgba(${r}, ${o}, ${s}, ${c})`,a=aa();if(!a)return;if((n?.value||"cell")==="row"){const d=a.closest("tr");d?Array.from(d.children).forEach(l=>en(l,i)):en(a,i)}else en(a,i);try{Rt(),kt(),Mt()}catch{}}function rs(){const t=aa();if(!t)return;if((document.getElementById("tpl-shade-target")?.value||"cell")==="row"){const r=t.closest("tr");r?Array.from(r.children).forEach(o=>nn(o)):nn(t)}else nn(t);try{Rt(),kt(),Mt()}catch{}}function me(){try{const t=Ft(),e=document.getElementById("templates-type"),n=e?e.value:"expenses",r=document.getElementById("templates-reservation"),o=r&&r.value?String(r.value):"all";return`templates.callsheet.autosave.${t?.id!=null?String(t.id):"no-project"}.${n}.${o}`}catch{return"templates.callsheet.autosave"}}function as(){try{const t=oa();if(!t)return;let e="";try{const r=document.getElementById("templates-a4-root");r&&(e=r.outerHTML)}catch{}const n={v:1,ts:Date.now(),snap:t,html:e};localStorage.setItem(me(),JSON.stringify(n))}catch{}}function kt(){clearTimeout(cr),cr=setTimeout(as,250)}function oa(){const t=document.getElementById("templates-a4-root");if(!t)return null;const e=Array.from(t.querySelectorAll('[data-editable="true"]')).map(r=>r.innerHTML),n=Ho(t);return{edits:e,l:Mn(),r:Bn(),sh:n}}function os(t){if(!(!t||!document.getElementById("templates-preview-host")))try{ra(t.l||{}),Re(t.r||{});const n=document.getElementById("templates-a4-root");n&&Array.isArray(t.edits)&&Array.from(n.querySelectorAll('[data-editable="true"]')).forEach((o,s)=>{s<t.edits.length&&(o.innerHTML=t.edits[s])})}finally{try{gt()}catch{}}}function sa(){try{const t=`remoteAutosaveId:${me()}`,e=localStorage.getItem(t);return e?Number(e):null}catch{return null}}function dr(t){try{const e=`remoteAutosaveId:${me()}`;t&&localStorage.setItem(e,String(t))}catch{}}function kn(t){try{const e=document.createElement("div");return e.innerHTML=String(t||""),e.querySelectorAll("script").forEach(n=>n.parentElement?.removeChild(n)),Array.from(e.querySelectorAll("*")).forEach(n=>{try{Array.from(n.attributes||[]).forEach(o=>{/^on/i.test(o.name)&&n.removeAttribute(o.name)})}catch{}}),e.innerHTML}catch{return t}}async function ss(){let t=sa();if(t)return t;const n=(await Oe()||[]).find(d=>{const l=String(d?.title||"").toLowerCase();return l.includes("autosave")||l.includes("draft")||l.includes("مسودة")});if(n&&n.id)return dr(n.id),n.id;const r=Ft();if(!r)return null;const o=document.getElementById("templates-type"),s=o?o.value:"expenses",c=document.getElementById("templates-reservation"),i=c&&c.value?Number(c.value):null,a=document.querySelector("#templates-preview-host #templates-a4-root");if(!a)return null;const u={html:kn(a.outerHTML)};try{await Lt("/project-templates/",{method:"POST",body:{project_id:Number(r.id),reservation_id:i,type:s,title:`Autosave - ${s}`,data:u}});const l=(await Oe()||[]).find(p=>String(p?.title||"").toLowerCase().includes("autosave"));if(l&&l.id)return dr(l.id),l.id}catch{}return null}async function cs(){const t=document.querySelector("#templates-preview-host #templates-a4-root");if(!t)return;const e=await ss();if(!e)return;const n={html:kn(t.outerHTML)};try{await Lt(`/project-templates/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:{data:n}})}catch(r){Kt(r,"تعذر الحفظ التلقائي")}}function ls(){clearTimeout(lr),lr=setTimeout(()=>{cs()},800)}function gt(){const t=document.getElementById("templates-preview-host");if(!t)return;try{t.style.visibility="hidden"}catch{}const e=Ft(),n=t.querySelector("#templates-a4-root");if(!e){t.innerHTML="";const a=w("div",{class:"text-muted",text:O("projects.templates.empty","اختر مشروعاً لبدء إنشاء القوالب.")});t.appendChild(a);try{t.style.visibility=""}catch{}return}const r=ge(e.id),o=document.getElementById("templates-type")?.value||"expenses",s=Qo();Jo(o);let c=null;c||(o==="callsheet"?c=xo(e,r,s):c=So(e,r,s));const i=c;if(n&&i&&n.tagName===i.tagName){const a=n.querySelector("[data-a4-pages]"),u=i.querySelector("[data-a4-pages]");if(a&&u)try{a.replaceWith(u)}catch{n.innerHTML=i.innerHTML}else n.innerHTML=i.innerHTML;c=n}else t.innerHTML="",t.appendChild(i),c=i;try{re(c)}catch{}try{Bo(c,o)}catch{}try{Zr({onAfterChange:()=>{try{Rt(),kt(),Mt()}catch{}try{setTimeout(()=>{pe({headerFooter:!1,logoUrl:Et.logoUrl,isLandscape:!0}),Zt()},30)}catch{}}})}catch{}try{Kr()}catch{}try{o==="callsheet"&&(yr(),fr(),De(),fn(),yn())}catch{}try{ur()}catch{}try{ur()}catch{}try{if(o==="callsheet"){const a=ge(e.id)?.[0]||null,u=()=>ln(a);Promise.resolve(Xa()).catch(()=>{}).finally(()=>{we()?.length?u():Ya().then(u).catch(()=>u())})}}catch{}try{o==="callsheet"&&ln(ge(e.id)?.[0]||null)}catch{}try{Array.from(c.querySelectorAll(".a4-page")).forEach(a=>{dn(a)||a.parentElement?.removeChild(a)})}catch{}try{hn()}catch{}jn();try{un({headerFooter:!1,logoUrl:Et.logoUrl})}catch{}try{In({headerFooter:!1,logoUrl:Et.logoUrl})}catch{}try{Array.from(c.querySelectorAll(".a4-page")).forEach(a=>{dn(a)||a.parentElement?.removeChild(a)})}catch{}try{o==="callsheet"&&De()}catch{}try{o==="callsheet"&&(yr(),fr(),De(),fn(),yn(),re(c),Zt())}catch{}try{hn()}catch{}try{pe({headerFooter:!1,logoUrl:Et.logoUrl,isLandscape:!0})}catch{}try{o==="callsheet"&&re(c)}catch{}try{ia()}catch{}try{o==="callsheet"&&localStorage.getItem("templates.debugOverlay")==="1"&&yo(c,ge(e.id)?.[0]||null)}catch{}try{o==="callsheet"&&re(c)}catch{}try{t.style.visibility=""}catch{}try{if(At=ea(),At==="fit")Ce();else{const a=ta();Gt=a,Ee(a,{silent:!0})}xe&&(xe.textContent=`${Math.round(Gt*100)}%`)}catch{}}function ur(){const t=document.getElementById("templates-a4-root");if(!t)return;Array.from(t.querySelectorAll("table.exp-details td")).forEach(n=>{try{if(n===n.parentElement?.lastElementChild){n.removeAttribute("contenteditable"),n.removeAttribute("data-editable");return}if(!(n.getAttribute("data-editable")==="true"||n.getAttribute("contenteditable")==="true"||!!n.querySelector('[contenteditable="true"]')))return;const s=n.querySelector('[contenteditable="true"]');if(s){const c=s.innerHTML;n.innerHTML=c}n.setAttribute("data-editable","true"),n.setAttribute("contenteditable","true"),n.setAttribute("autocapitalize","off"),n.setAttribute("autocorrect","off"),n.setAttribute("autocomplete","off"),n.setAttribute("spellcheck","false")}catch{}})}async function Rn(){const t=document.querySelector("#templates-preview-host > #templates-a4-root");if(!t){alert("لا يوجد محتوى للطباعة");return}const e=document.getElementById("templates-type")?.value||"expenses",r=(o=>{try{const c=`templatesPdf.orientation.${o}`,i=ft(c,"");if(i==="portrait"||i==="landscape")return i}catch{}return{expenses:"portrait",callsheet:"landscape"}[o]||"landscape"})(e);if(e==="callsheet"){try{await(await Un(async()=>{const{printCallsheetFromHost:o}=await import("./print.v0yztiJa.js");return{printCallsheetFromHost:o}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]),import.meta.url)).printCallsheetFromHost(t)}catch{alert("تعذر إنشاء PDF")}return}else{try{const{printGenericTemplate:o}=await Un(async()=>{const{printGenericTemplate:s}=await import("./print.v0yztiJa.js");return{printGenericTemplate:s}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18]),import.meta.url);await o(t,{orientation:r,filename:`template-${e}.pdf`})}catch{alert("تعذر إنشاء PDF")}return}}function is(){try{const t=document.querySelector("#templates-preview-host > #templates-a4-root");if(!t){alert("لا يوجد محتوى للمعاينة");return}const e=document.createElement("div");Object.assign(e.style,{position:"fixed",inset:"0",background:"rgba(15,23,42,0.6)",zIndex:"9998",display:"flex",alignItems:"center",justifyContent:"center",padding:"20px"});const n=document.createElement("div");Object.assign(n.style,{background:"#fff",borderRadius:"12px",maxWidth:"92vw",maxHeight:"88vh",width:"min(1200px,92vw)",padding:"12px",boxShadow:"0 12px 30px rgba(0,0,0,0.25)",display:"flex",flexDirection:"column",gap:"12px"});const r=document.createElement("div");r.textContent="معاينة الطباعة",r.style.cssText="font-weight:800;font-size:16px";const o=document.createElement("div");Object.assign(o.style,{overflow:"auto",flex:"1 1 auto",border:"1px solid #e5e7eb",borderRadius:"8px",padding:"10px",background:"#f8fafc"});const s=document.createElement("div");Object.assign(s.style,{display:"flex",gap:"8px",justifyContent:"flex-start"});const c=document.createElement("button");c.className="btn btn-outline",c.textContent="إغلاق",c.onclick=()=>e.remove();const i=document.createElement("button");i.className="btn btn-primary",i.textContent="طباعة الآن",i.onclick=async()=>{e.remove();try{await Rn()}catch{}},s.appendChild(i),s.appendChild(c);const a=t.cloneNode(!0),u=a.querySelector("[data-a4-pages]")||a,d=Array.from(u.querySelectorAll(".a4-page")),l=y=>{try{const g=!!y.querySelector("#expenses-top-sheet"),E=!!y.querySelector('table.exp-details tbody tr[data-row="item"]'),I=!!Array.from(y.querySelectorAll("table.tpl-table tbody tr")).find(f=>Array.from(f.querySelectorAll("td")).some(v=>(v.textContent||"").trim().length>0)),x=!!Array.from(y.querySelectorAll(".callsheet-v1 table.cs-crew tbody tr")).find(f=>Array.from(f.querySelectorAll("td")).some(v=>(v.textContent||"").trim().length>0)),C=!!y.querySelector(".callsheet-v1 .cs-header, .callsheet-v1 .cs-info td, .callsheet-v1 .cs-cast td");return g||E||I||x||C}catch{return!0}};d.forEach(y=>{l(y)||y.parentElement?.removeChild(y)});const p=Array.from(u.querySelectorAll(".a4-page")),m=document.createElement("div");m.textContent=`عدد الصفحات: ${p.length}`,m.style.cssText="font-size:12px;color:#475569";const h=document.createElement("div");Object.assign(h.style,{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(360px, 1fr))",gap:"14px"}),p.forEach(y=>{const g=document.createElement("div");Object.assign(g.style,{background:"#fff",border:"1px solid #e5e7eb",borderRadius:"8px",padding:"6px",display:"flex",justifyContent:"center",alignItems:"center"});const E=y.cloneNode(!0);Object.assign(E.style,{transform:"scale(0.45)",transformOrigin:"top left",width:y.clientWidth+"px",height:y.clientHeight+"px"}),g.appendChild(E),h.appendChild(g)}),o.appendChild(m),o.appendChild(h),n.appendChild(r),n.appendChild(o),n.appendChild(s),e.appendChild(n),document.body.appendChild(e)}catch{alert("تعذر إنشاء المعاينة")}}async function pr(t=!1){try{const e=document.getElementById("templates-a4-root");if(!e){alert("لا يوجد محتوى");return}const n=e.querySelector(".callsheet-v1 table.cs-crew");if(!n){alert("لا يوجد جدول Crew في القالب الحالي");return}const r=Ft(),o=r&&ge(r.id)?.[0]||null;if(!o){alert("اختر حجزاً مرتبطاً أولاً");return}t?Or(n,o):ln(o);try{Bt("تم جلب بيانات الطاقم","success",2500)}catch{}}catch{alert("تعذر جلب بيانات الطاقم")}}function ca(){try{return`templatesPdf.${document.getElementById("templates-type")?.value||"expenses"}`}catch{return"templatesPdf.expenses"}}function la(t){const e=String(t||"").replace(/^templatesPdf[.:]/,"");return{ns:`${ca()}.${e}`,legacy:`templatesPdf.${e}`}}function ft(t,e){try{const{ns:n,legacy:r}=la(t);let o=localStorage.getItem(n);if(o==null&&(o=localStorage.getItem(r)),o==null)return e;const s=Number(o);return Number.isFinite(s)?s:e}catch{return e}}function mr(t,e){try{const{ns:n}=la(t);localStorage.setItem(n,String(e))}catch{}}function Dn(){return`${ca()}.pageOverrides`}function qn(){try{const t=localStorage.getItem(Dn());return t?JSON.parse(t):{}}catch{return{}}}function It(t,e,n){try{const r=qn(),o=String(t);r[o]=r[o]||{},r[o][e]=Number(n),localStorage.setItem(Dn(),JSON.stringify(r))}catch{}}function Vt(t,e,n){try{const o=qn()[String(e)];return o&&o[t]!=null&&Number.isFinite(Number(o[t]))?Number(o[t]):ft(t,n)}catch{return ft(t,n)}}function ds(){try{localStorage.removeItem(Dn())}catch{}}async function us(){const t=document.querySelector("#templates-preview-host > #templates-a4-root");if(!t)return;const n=(document.getElementById("templates-type")?.value||"expenses")!=="expenses";try{const W=document.getElementById("templates-pdf-live-slot");W&&(W.innerHTML='<div style="padding:8px;color:#64748b">… جار إنشاء المعاينة</div>')}catch{}let r;try{r=await Ja()}catch{r=null}let o=window.html2canvas;if(typeof o!="function"){try{await Mr("https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js")}catch{}o=window.html2canvas}if(typeof o!="function"){const W=document.getElementById("templates-pdf-live-slot");W&&(W.innerHTML='<div style="padding:8px;color:#ef4444">تعذر تحميل html2canvas لمعاينة PDF. تأكد من اتصال الشبكة ثم أعد المحاولة.</div>');return}const s=n?1123:794,c=n?794:1123,i=n?297:210,u=96/25.4,d=document.getElementById("pdftun-page")?.value,l=Math.max(0,Number(d??0)||0),p=Array.from(t.querySelectorAll(".a4-page")),m=p[l]||p[0];if(!m)return;const h=document.createElement("div");Object.assign(h.style,{position:"fixed",top:"0",left:"-12000px",pointerEvents:"none",zIndex:"-1",backgroundColor:"#ffffff"});const y=document.createElement("div");y.id="templates-a4-root",y.setAttribute("data-render-context","export"),y.setAttribute("dir",t.getAttribute("dir")||document.documentElement.getAttribute("dir")||"rtl");const g=document.createElement("div");g.setAttribute("data-a4-pages","");const E=m.cloneNode(!0);E.style.width=`${s}px`,E.style.height=`${c}px`,E.style.background="#ffffff",E.style.overflow="hidden";try{((et,ut)=>{const nt=et.querySelector("table.exp-details");if(!nt)return;const pt=nt.tBodies&&nt.tBodies[0];if(!pt||!!!pt.querySelector('tr[data-row="item"]'))return;const rt=pt.firstElementChild;if(rt&&rt.hasAttribute&&rt.hasAttribute("data-group-bar"))return;let xt=et.querySelector("tbody > tr[data-group-bar]");!xt&&ut&&(xt=ut.querySelector("tbody > tr[data-group-bar]")),xt&&pt.insertBefore(xt.cloneNode(!0),pt.firstElementChild)})(E,m)}catch{}g.appendChild(E),y.appendChild(g),h.appendChild(y),document.body.appendChild(h);const I=Math.min(2,Math.max(1.6,(window.devicePixelRatio||1)*1.25)),x={scale:I,useCORS:!0,allowTaint:!1,backgroundColor:"#ffffff",letterRendering:!1,removeContainer:!1},C=(W,et=246)=>{try{const ut=W.getContext("2d"),{width:nt,height:pt}=W;for(let ot=0;ot<pt;ot+=2){const rt=ut.getImageData(0,ot,nt,1).data;let xt=0;for(let lt=0;lt<nt;lt+=1){const ht=lt*4;if((rt[ht]<et||rt[ht+1]<et||rt[ht+2]<et)&&++xt>Math.max(2,Math.ceil(nt*.003)))return ot}}return 0}catch{return 0}},f=(W,et=244)=>{try{const ut=W.getContext("2d"),{width:nt,height:pt}=W,ot=Math.floor(nt*.55),rt=Math.max(10,nt-ot),xt=Math.max(3,Math.ceil(rt*.015));for(let lt=0;lt<pt;lt+=2){const ht=ut.getImageData(ot,lt,rt,1).data;let he=0;for(let fe=0;fe<rt;fe+=1){const Yt=fe*4,ye=ht[Yt],Ye=ht[Yt+1],Ge=ht[Yt+2];if((ye<et||Ye<et||Ge<et)&&++he>=xt)return lt}}return 0}catch{return 0}},v=(W,et=244)=>{try{const ut=W.getContext("2d"),{width:nt,height:pt}=W,ot=Math.floor(nt*.2),rt=Math.max(10,Math.floor(nt*.6)),xt=Math.max(12,Math.ceil(rt*.08)),lt=4;for(let ht=lt;ht<pt;ht+=2){const he=ut.getImageData(ot,ht,rt,1).data;let fe=0;for(let Yt=0;Yt<rt;Yt+=1){const ye=Yt*4,Ye=he[ye],Ge=he[ye+1],xa=he[ye+2];if((Ye<et||Ge<et||xa<et)&&++fe>=xt)return ht}}return 0}catch{return 0}},T=(W,et=246)=>{try{const ut=W.getContext("2d"),{width:nt,height:pt}=W;for(let ot=pt-1;ot>=0;ot-=2){const rt=ut.getImageData(0,ot,nt,1).data;let xt=0;for(let lt=0;lt<nt;lt+=1){const ht=lt*4;if((rt[ht]<et||rt[ht+1]<et||rt[ht+2]<et)&&++xt>Math.max(2,Math.ceil(nt*.003)))return pt-1-ot}}return 0}catch{return 0}},P=(W,et,ut)=>{try{const{width:nt,height:pt}=W,ot=Math.max(0,Math.min(pt-1,Math.round(et))),rt=Math.max(0,Math.min(pt-ot,Math.round(ut))),xt=Math.max(1,pt-ot-rt);if(ot===0&&rt===0)return W;const lt=document.createElement("canvas");return lt.width=nt,lt.height=xt,lt.getContext("2d").drawImage(W,0,-ot),lt}catch{return W}};let L=0;try{const W=E.querySelector(".a4-inner")||E,et=W.querySelector(".exp-masthead")||W.firstElementChild;if(et){const ut=E.getBoundingClientRect(),nt=et.getBoundingClientRect();L=Math.max(0,nt.top-ut.top)}}catch{L=0}let _;try{await Lo(y),_=await o(E,{...x,scrollX:0,scrollY:0,windowWidth:s,windowHeight:c})}finally{try{h.parentNode?.removeChild(h)}catch{}}if(!_)return;const R=C(_,246),D=f(_,244),N=v(_,244),b=document.getElementById("pdftun-page")?.value||"all",M=b==="all"?0:Math.max(0,Number(b)||0),q=Vt("templatesPdf.extraTrimMm",M,ft("templatesPdf.extraTrimMm",14)),B=Vt("templatesPdf.safeMarginMm",M,ft("templatesPdf.safeMarginMm",.5)),j=Math.max(N,L*I),X=q*u*I,A=B*u*I,k=Math.max(R,D,N),H=Math.min(Math.max(0,k+X),Math.max(0,j-A)),F=T(_,246),Y=P(_,H,F),G=ft("templatesPdf.scalePct",100)/100,K=Math.max(.98,Math.min(1,G||1)),z=i*K,V=Y.height/Y.width*z,at=Vt("templatesPdf.shiftRightMm",l,ft("templatesPdf.shiftRightMm",40)),st=ft("templatesPdf.globalAllRightMm",0),mt=l===0?ft("templatesPdf.tightFudgeMm",-144.5):0,_t=Vt("templatesPdf.tightFudgeMm",l,mt),Pt=ft("templatesPdf.globalYmm",0),St=ft("templatesPdf.globalAllYmm",-1),te=at+st;let Te=-(Math.max(0,L*I-H)*(z/Y.width))+_t+Pt+St;const Dt=document.createElement("canvas");Dt.width=s,Dt.height=c;const Ot=Dt.getContext("2d");Ot.fillStyle="#ffffff",Ot.fillRect(0,0,Dt.width,Dt.height);const Le=Math.round(te*u),Pe=Math.round(Te*u),$=Math.round(z*u),J=Math.round(V*u);try{Ot.drawImage(Y,Le,Pe,$,J)}catch{}const ct=document.getElementById("templates-pdf-live-slot");if(ct){ct.innerHTML="";const W=document.createElement("img");W.src=Dt.toDataURL("image/png"),W.style.maxWidth="100%",W.style.height="auto",W.style.border="1px solid #e5e7eb",ct.appendChild(W)}}function ia(){const t=document.getElementById("templates-controls");if(!t||document.getElementById("templates-pdf-tuner-toggle"))return;const e=t.querySelector(".ms-auto")||t,n=document.createElement("button");n.type="button",n.id="templates-pdf-tuner-toggle",n.className="btn btn-outline",n.textContent="🛠️ ضبط PDF",e.appendChild(n);const r=document.createElement("div");r.id="templates-pdf-tuner",r.style.display="none",r.style.marginTop="10px",r.style.border="1px solid #e5e7eb",r.style.borderRadius="10px",r.style.padding="10px",r.innerHTML=`
    <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:flex-end;">
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>الصفحة</span>
        <select id="pdftun-page" style="width:110px;"></select>
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Top Offset (All)</span>
        <input id="pdftun-globalY" type="number" step="0.5" min="-1000" max="1000" style="width:90px;" />
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Right Shift (All)</span>
        <input id="pdftun-globalX" type="number" step="0.5" min="-1000" max="1000" style="width:90px;" />
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Top Trim (mm)</span>
        <input id="pdftun-extraTrim" type="number" step="0.5" min="0" max="40" style="width:90px;" />
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Safe Margin (mm)</span>
        <input id="pdftun-safeMargin" type="number" step="0.1" min="0" max="10" style="width:90px;" />
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Top Offset (mm)</span>
        <input id="pdftun-tightFudge" type="number" step="0.5" min="-40" max="40" style="width:90px;" />
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Right Shift (mm)</span>
        <input id="pdftun-right" type="number" step="0.5" min="-40" max="40" style="width:90px;" />
      </label>
      <label style="display:flex; flex-direction:column; gap:4px;">
        <span>Scale (%)</span>
        <input id="pdftun-scale" type="number" step="1" min="90" max="110" style="width:90px;" />
      </label>
      <span style="flex:1 1 auto"></span>
      <button type="button" class="btn btn-outline" id="pdftun-preset">تطبيق القيم</button>
      <button type="button" class="btn btn-outline" id="pdftun-reset">الافتراضيات</button>
      <button type="button" class="btn btn-primary" id="pdftun-print">🖨️ طباعة</button>
    </div>
  `,t.parentElement?.appendChild(r);const o=()=>{const u=r.querySelector("#pdftun-page"),d=Array.from(document.querySelectorAll("#templates-preview-host #templates-a4-root .a4-page")),l=u.value||"0",p=[];d.forEach((m,h)=>{p.push(`<option value="${h}">الصفحة ${h+1}</option>`)}),p.length?u.innerHTML=p.join(""):(u.innerHTML='<option value="0">الصفحة 1</option>',setTimeout(()=>{try{o()}catch{}},120)),Array.from(u.options).some(m=>m.value===l)?u.value=l:u.value="0"},s=()=>{const u=r.querySelector("#pdftun-page"),d=Math.max(0,Number(u.value||"0")),l=Vt("templatesPdf.extraTrimMm",d,ft("templatesPdf.extraTrimMm",14)),p=Vt("templatesPdf.safeMarginMm",d,ft("templatesPdf.safeMarginMm",.5));document.getElementById("pdftun-extraTrim").value=String(l),document.getElementById("pdftun-safeMargin").value=String(p);const h=Vt("templatesPdf.tightFudgeMm",d,d===0?-144.5:0),y=Vt("templatesPdf.shiftRightMm",d,ft("templatesPdf.shiftRightMm",40));document.getElementById("pdftun-tightFudge").value=String(h),document.getElementById("pdftun-right").value=String(y),document.getElementById("pdftun-scale").value=String(ft("templatesPdf.scalePct",100));try{document.getElementById("pdftun-globalY").value=String(ft("templatesPdf.globalAllYmm",-1))}catch{}try{document.getElementById("pdftun-globalX").value=String(ft("templatesPdf.globalAllRightMm",0))}catch{}},c=()=>{o(),s()};c(),n.addEventListener("click",()=>{if(r.style.display=r.style.display==="none"?"block":"none",r.style.display==="block"){try{o(),s()}catch{}try{const u=qn();if(u&&Object.keys(u).length===0&&!localStorage.getItem("templatesPdf.presetSeeded.v4")){const d=Array.from(document.querySelectorAll("#templates-preview-host #templates-a4-root .a4-page"));if(d.length){const m=[-145,-290,-435,-580,-725],h=[14,14,14,14,14],y=-145;d.forEach((g,E)=>{const I=E<m.length?m[E]:m[m.length-1]+y*(E-(m.length-1)),x=E<h.length?h[E]:h[h.length-1];It(E,"templatesPdf.shiftRightMm",61),It(E,"templatesPdf.tightFudgeMm",I),It(E,"templatesPdf.extraTrimMm",x),It(E,"templatesPdf.safeMarginMm",.5)}),localStorage.setItem("templatesPdf.presetSeeded.v4","1");try{localStorage.setItem("templatesPdf.globalAllYmm","-1")}catch{}s()}}}catch{}try{if(window.__pdfTunerMO)try{window.__pdfTunerMO.disconnect()}catch{}const u=document.querySelector("#templates-preview-host #templates-a4-root [data-a4-pages]")||document.querySelector("#templates-preview-host #templates-a4-root");if(u){const d=new MutationObserver(()=>{try{o()}catch{}});d.observe(u,{childList:!0,subtree:!0}),window.__pdfTunerMO=d}}catch{}us()}else try{window.__pdfTunerMO&&(window.__pdfTunerMO.disconnect(),window.__pdfTunerMO=null)}catch{}}),r.querySelector("#pdftun-page").addEventListener("change",()=>{s()});const i=(u,d,l=!0)=>{const p=document.getElementById(u);p.addEventListener("input",()=>{const m=p.value;if(l){const h=r.querySelector("#pdftun-page").value||"0";It(Number(h),d,m)}else mr(d,m)}),p.addEventListener("change",()=>{const m=p.value;if(l){const h=r.querySelector("#pdftun-page").value||"0";It(Number(h),d,m)}else mr(d,m)})};i("pdftun-extraTrim","templatesPdf.extraTrimMm",!0),i("pdftun-safeMargin","templatesPdf.safeMarginMm",!0),i("pdftun-tightFudge","templatesPdf.tightFudgeMm",!0),i("pdftun-right","templatesPdf.shiftRightMm",!0),i("pdftun-scale","templatesPdf.scalePct",!1),i("pdftun-globalY","templatesPdf.globalAllYmm",!1),i("pdftun-globalX","templatesPdf.globalAllRightMm",!1);const a=()=>{const u=Array.from(document.querySelectorAll("#templates-preview-host #templates-a4-root .a4-page")),d=61,l=.5,p=[-145,-290,-435,-580,-725],m=[14,14,14,14,14],h=-145;u.forEach((y,g)=>{const E=g<p.length?p[g]:p[p.length-1]+h*(g-(p.length-1)),I=g<m.length?m[g]:m[m.length-1];It(g,"templatesPdf.shiftRightMm",d),It(g,"templatesPdf.tightFudgeMm",E),It(g,"templatesPdf.extraTrimMm",I),It(g,"templatesPdf.safeMarginMm",l)});try{localStorage.setItem("templatesPdf.globalAllYmm","-1")}catch{}s()};document.getElementById("pdftun-preset").addEventListener("click",a),document.getElementById("pdftun-reset").addEventListener("click",()=>{try{["templatesPdf.extraTrimMm","templatesPdf.safeMarginMm","templatesPdf.tightFudgeMm","templatesPdf.shiftRightMm","templatesPdf.scalePct","templatesPdf.globalYmm","templatesPdf.globalAllYmm","templatesPdf.globalAllRightMm"].forEach(u=>localStorage.removeItem(u)),ds()}catch{}c()}),document.getElementById("pdftun-print").addEventListener("click",Rn);try{window.__pdfTunerRefreshPages=o,window.__pdfTunerLoadValues=s}catch{}}function hr(){const t=document.getElementById("templates-project");if(!t)return;const e=ie().map(n=>({id:n.id,title:n.title||`#${n.id}`}));t.innerHTML='<option value="">— اختر —</option>'+e.map(n=>`<option value="${String(n.id)}">${n.title}</option>`).join("")}function rn(t){const e=document.getElementById("templates-reservation");if(!e)return;const n=t?Jr(t):[],r=['<option value="" selected>— بدون ربط —</option>'];n.forEach(o=>{const s=o.id??o.reservationId,c=(o.title||"").trim()||`#${s}`;r.push(`<option value="${String(s)}">${c}</option>`)}),e.innerHTML=r.join("")}function jn(){const t=Array.from(document.querySelectorAll("#templates-preview-host table.exp-details")),e=document.querySelector("#templates-preview-host #expenses-table"),n=t.length?t:e?[e]:[];if(!n.length)return;if(n[0].classList.contains("exp-table")){const h=(N,b=0)=>{const q=String(N||"").replace(/[\u0660-\u0669]/g,j=>"0123456789"[j.charCodeAt(0)-1632]).replace(/[\u06F0-\u06F9]/g,j=>"0123456789"[j.charCodeAt(0)-1776]).replace(/[\u066B]/g,".").replace(/[\u066C]/g,"").replace(/[\u200f\u200e]/g,"").replace(/[^\d.\-]/g,""),B=Number(q);return Number.isFinite(B)?B:b},y={atl:0,prod:0,post:0};let g=0;const E={},I={};n.flatMap(N=>Array.from(N.querySelectorAll("tbody tr[data-subgroup-header]"))).forEach(N=>{const b=N.getAttribute("data-subgroup");let M=0,q=0,B=N.nextElementSibling;for(;B&&!B.hasAttribute("data-subgroup-header")&&!B.hasAttribute("data-subgroup-subtotal");){if(B.getAttribute("data-row")==="item"){const k=B.children,H=h(k[2]?.textContent,0),F=h(k[3]?.textContent,1),Y=h(k[4]?.textContent,1),G=F*Y*H;if(k[6]){k[6].textContent=yt(G);try{k[6].setAttribute("data-num","1")}catch{}}M+=G,(String(k[1]?.textContent||"").trim().length||h(k[2]?.textContent,0)||h(k[3]?.textContent,0))&&(q+=1)}B=B.nextElementSibling}const j=document.querySelector(`#templates-preview-host [data-subtotal="${CSS.escape(b)}"]`);j&&(j.textContent=yt(M)),E[b]=M,I[b]=q,g+=M;const A=document.querySelector(`#templates-preview-host tr[data-subgroup-marker="${CSS.escape(b)}"]`)?.getAttribute("data-parent-group")||null;A&&y[A]!=null&&(y[A]+=M)}),Object.entries(y).forEach(([N,b])=>{const M=document.querySelector(`#templates-preview-host [data-total-group="${CSS.escape(N)}"]`);M&&(M.textContent=yt(b))});const C=document.querySelector("#templates-preview-host [data-grand-total]");C&&(C.textContent=yt(g));try{Object.entries(E).forEach(([b,M])=>{const q=I[b]||0,B=document.querySelector(`#templates-preview-host #expenses-top-sheet [data-top-count="${CSS.escape(b)}"]`),j=document.querySelector(`#templates-preview-host #expenses-top-sheet [data-top-total="${CSS.escape(b)}"]`);B&&(B.textContent=yt(q)),j&&(j.textContent=yt(M))}),Object.entries(y).forEach(([b,M])=>{const q=document.querySelector(`#templates-preview-host #expenses-top-sheet [data-top-total-group="${CSS.escape(b)}"]`);q&&(q.textContent=yt(M))});const N=document.querySelector("#templates-preview-host #expenses-top-sheet [data-top-grand]");N&&(N.textContent=yt(g))}catch{}const f=Ft(),v=O("reservations.create.summary.currency","SR"),T=!!f?.applyTax,P=T?Math.round(g*zn):0,L=Math.round(g+P),_=document.querySelector("#expenses-summary [data-summary-subtotal]"),R=document.querySelector("#expenses-summary [data-summary-tax]"),D=document.querySelector("#expenses-summary [data-summary-total]");_&&(_.textContent=`${yt(g)} ${v}`),R&&(R.textContent=T?`${yt(P)} ${v}`:`0 ${v}`),D&&(D.textContent=`${yt(L)} ${v}`);try{const N=document.activeElement;!!(N&&(N.getAttribute("contenteditable")==="true"||N.closest('[contenteditable="true"]'))&&N.closest("#templates-a4-root table.exp-details"))||requestAnimationFrame(()=>{try{un({headerFooter:!1,logoUrl:Et.logoUrl})}catch{}})}catch{}return}let r=0,o=0;Array.from(e.querySelectorAll("tbody tr")).forEach(h=>{if(h.matches("[data-section-bar]")){r=0;return}if(h.classList.contains("tpl-subtotal-row")){const I=h.querySelector("[data-subtotal]")||h.children[5];I&&(I.textContent=yt(r||0));return}const y=Number(String(h.children[3]?.textContent||"1").replace(/[^\d.\-]/g,""))||1,g=Number(String(h.children[4]?.textContent||"0").replace(/[^\d.\-]/g,""))||0,E=y*g;h.children[5]&&(h.children[5].textContent=yt(E)),r+=E,o+=E});const c=Ft(),i=O("reservations.create.summary.currency","SR"),a=!!c?.applyTax,u=a?Math.round(o*zn):0,d=Math.round(o+u),l=document.querySelector("#expenses-summary [data-summary-subtotal]"),p=document.querySelector("#expenses-summary [data-summary-tax]"),m=document.querySelector("#expenses-summary [data-summary-total]");l&&(l.textContent=`${yt(o)} ${i}`),p&&(p.textContent=a?`${yt(u)} ${i}`:`0 ${i}`),m&&(m.textContent=`${yt(d)} ${i}`);try{const h=document.activeElement;!!(h&&(h.getAttribute("contenteditable")==="true"||h.closest('[contenteditable="true"]'))&&h.closest("#templates-a4-root table.exp-details"))||(requestAnimationFrame(()=>{try{un({headerFooter:!1,logoUrl:Et.logoUrl})}catch{}}),requestAnimationFrame(()=>{try{In({headerFooter:!1,logoUrl:Et.logoUrl})}catch{}}))}catch{}}function hn(){const t=document.querySelector("#templates-preview-host #templates-a4-root");if(!t)return;const e=Array.from(t.querySelectorAll("table.exp-details"));if(!e.length)return;const n=new Map,r=i=>i?.hasAttribute("data-subgroup-header"),o=i=>i?.hasAttribute("data-subgroup-subtotal"),s=i=>i?.getAttribute("data-row")==="item",c=i=>String(i||"").split("-")[0]||"";e.forEach(i=>{const a=Array.from(i.querySelectorAll("tbody > tr"));let u=null,d="",l=0;a.forEach(p=>{if(r(p)){u=p.getAttribute("data-subgroup"),d=c(u),l=n.get(u)||0;return}if(o(p)){n.set(u,l),u=null,d="";return}if(s(p)&&d){l+=1;const m=p.children[0];if(m&&m.hasAttribute("contenteditable")){const h=String(l).padStart(2,"0");m.textContent=`${d}-${h}`}}}),u&&n.set(u,l)})}function fr(){const t=document.getElementById("templates-a4-root");if(!t)return;const e=t.querySelector("[data-a4-pages]");if(!e||t.querySelector("table.cs-crew"))return;const r=document.createElement("section");r.className="a4-page a4-page--landscape";const o=document.createElement("div");o.className="a4-inner";const s=document.createElement("div");s.className="callsheet-v1",r.appendChild(o),o.appendChild(s);const c=document.createElement("table");c.className="tpl-table cs-crew",c.setAttribute("data-editable-table","crew");const i=[30,34,20,16],a=document.createElement("colgroup");i.forEach(h=>{const y=document.createElement("col");y.setAttribute("style",`width:${h}%`),a.appendChild(y)}),c.appendChild(a);const u=document.createElement("thead"),d=document.createElement("tr"),l=document.createElement("th");l.setAttribute("colspan",String(i.length)),l.className="cs-crew-title",l.textContent="Crew Call",d.appendChild(l),u.appendChild(d);const p=document.createElement("tr");["Position","Name","Phone","Time"].forEach((h,y)=>{const g=document.createElement("th");g.textContent=h,g.setAttribute("style",`width:${i[y]}%`),p.appendChild(g)}),u.appendChild(p),c.appendChild(u);const m=document.createElement("tbody");for(let h=0;h<18;h+=1){const y=document.createElement("tr");for(let g=0;g<4;g+=1){const E=document.createElement("td");E.setAttribute("data-editable","true"),E.setAttribute("contenteditable","true"),g===2&&(E.setAttribute("dir","ltr"),E.style.direction="ltr"),y.appendChild(E)}m.appendChild(y)}c.appendChild(m),s.appendChild(c),e.insertBefore(r,e.children[1]||null);try{setTimeout(()=>{pe({headerFooter:!1,logoUrl:Et.logoUrl,isLandscape:!0}),Zt()},20)}catch{}}function yr(){const t=document.getElementById("templates-a4-root");if(!t)return;const e=Array.from(t.querySelectorAll(".callsheet-v1"));if(e.length)try{const n=[];e.forEach(a=>{n.push(...Array.from(a.getElementsByTagName("table")))});const r=a=>!!(a.classList&&a.classList.contains("cs-crew")),o=a=>{try{return r(a)?!0:((a.querySelector("thead")?.textContent||a.textContent||"")+"").toLowerCase().includes("crew call")}catch{return!1}},s=n.filter(o);if(!s.length)return;let c=null;const i=s.filter(r);i.length?c=i[i.length-1]:c=s[0],s.forEach(a=>{if(a!==c)try{a.parentElement?.removeChild(a)}catch{}})}catch{}}function De(){try{const t=document.getElementById("templates-a4-root");if(!t)return;const e=t.querySelector("[data-a4-pages]");if(!e)return;const n=t.querySelector("table.cs-crew");if(!n)return;const r=n.closest(".a4-page"),o=Array.from(e.querySelectorAll(".a4-page"));r&&o.indexOf(r)!==1&&e.insertBefore(r,e.children[1]||null);const s=r?r.querySelector("table.cs-schedule"):null;if(s){const c=document.createElement("section");c.className="a4-page a4-page--landscape";const i=document.createElement("div");i.className="a4-inner";const a=document.createElement("div");a.className="callsheet-v1",c.appendChild(i),i.appendChild(a),a.appendChild(s),e.insertBefore(c,e.children[2]||null)}}catch{}}function fn(){const t=document.getElementById("templates-a4-root");if(!t)return;const e=Array.from(t.querySelectorAll(".callsheet-v1 table.cs-crew"));if(e.length<=1)return;const n=l=>{try{return!!l.querySelector("thead .cs-crew-title")}catch{return!1}},r=l=>{try{return Array.from(l.querySelectorAll("tbody td")).reduce((m,h)=>m+((h.textContent||"").trim().length>0?1:0),0)}catch{return 0}};let o=null;const s=e.filter(n);if(s.length)o=s[s.length-1];else{o=e[0];let l=r(o);e.slice(1).forEach(p=>{const m=r(p);m>l&&(o=p,l=m)})}const c=o.tBodies&&o.tBodies[0];if(!c)return;const i=l=>{for(let p=0;p<l;p+=1){const m=document.createElement("tr");for(let h=0;h<4;h+=1){const y=document.createElement("td");y.setAttribute("data-editable","true"),y.setAttribute("contenteditable","true"),m.appendChild(y)}c.appendChild(m)}},a=[];e.forEach(l=>{if(l===o||!n(l))return;const p=l.tBodies&&l.tBodies[0];p&&Array.from(p.children).forEach(m=>{const h=Array.from(m.children);h.some(g=>(g.textContent||"").trim().length>0)&&a.push(h.map(g=>g.textContent||""))})}),a.length&&i(Math.max(0,a.length-(c.children?.length||0)));const u=l=>Array.from(l.children).every(p=>!(p.textContent||"").trim().length);let d=0;Array.from(c.children).forEach(l=>{if(d>=a.length||!u(l))return;const p=a[d++],m=Array.from(l.children);for(let h=0;h<Math.min(m.length,p.length);h+=1)m[h].textContent=p[h]||""}),e.forEach(l=>{if(l!==o)try{l.parentElement?.removeChild(l)}catch{}})}function yn(){try{const t=document.getElementById("templates-a4-root");if(!t)return;const e=t.querySelector("[data-a4-pages]"),n=e?Array.from(e.querySelectorAll(".a4-page")):[],r=m=>{const h=m?.closest?.(".a4-page");return h?n.indexOf(h):-1},o=Array.from(t.getElementsByTagName("table")),s=m=>!!(m.classList&&m.classList.contains("cs-crew")),c=["crew call","crewcall","crew","طاقم","طاقم العمل","كرو","كرو كول"],i=m=>{try{if(s(m))return!0;const h=((m.querySelector("thead")?.textContent||m.textContent||"")+"").toLowerCase();return c.some(y=>h.includes(y))}catch{return!1}},a=o.filter(i);if(a.length<=1)return;let u=null;const d=a.filter(s);u=d.find(m=>r(m)===1)||d[d.length-1]||a[0];const l=u.tBodies&&u.tBodies[0],p=m=>{for(let h=0;h<m;h+=1){const y=document.createElement("tr");for(let g=0;g<4;g+=1){const E=document.createElement("td");E.setAttribute("data-editable","true"),E.setAttribute("contenteditable","true"),y.appendChild(E)}l.appendChild(y)}};a.forEach(m=>{if(m!==u){if(s(m)){const h=m.tBodies&&m.tBodies[0];if(!h){try{m.remove()}catch{}return}const g=Array.from(h.children).map(I=>Array.from(I.children).map(x=>x.textContent||"")).filter(I=>I.some(x=>(x||"").trim().length>0));g.length&&p(Math.max(0,g.length-(l?.children?.length||0)));let E=0;Array.from(l.children).forEach(I=>{if(E>=g.length)return;const x=Array.from(I.children);if(!x.every(v=>!(v.textContent||"").trim().length))return;const f=g[E++];for(let v=0;v<Math.min(x.length,f.length);v+=1)x[v].textContent=f[v]||""})}try{m.parentElement?.removeChild(m)}catch{}}});try{const m=u.closest(".a4-page");m&&e&&Array.from(e.children).indexOf(m)!==1&&e.insertBefore(m,e.children[1]||null)}catch{}}catch{}}async function gr({copy:t=!1}={}){const e=Ft();if(!e)throw alert("اختر مشروعاً أولاً"),new Error("No project selected");const n=document.getElementById("templates-type"),r=n?n.value:"expenses",o=document.getElementById("templates-reservation"),s=o&&o.value?Number(o.value):null,c=document.querySelector("#templates-preview-host #templates-a4-root");if(!c)throw alert("لا يوجد محتوى للحفظ"),new Error("No template root to save");const i={html:kn(c.outerHTML)},a=document.getElementById("templates-save-title"),u=a&&a.value?String(a.value).trim():"";await Lt("/project-templates/",{method:"POST",body:{project_id:Number(e.id),reservation_id:s,type:r,title:u||`${e.title||"Template"} - ${r}`,data:i}}),alert("تم حفظ القالب");try{localStorage.removeItem(me())}catch{}}async function Oe(){const t=Ft();if(!t)return[];const e=document.getElementById("templates-type");let n=e?e.value:"expenses";const r=n==="callsheet"?["callsheet","call-sheet","callsheet_v1","callsheetv1","callsheet-v1"]:[n],o=new Set,s=[],c=i=>Array.isArray(i?.data)?i.data:Array.isArray(i)?i:Array.isArray(i?.items)?i.items:[];for(const i of r)try{const a=await Lt(`/project-templates/?project_id=${encodeURIComponent(t.id)}&type=${encodeURIComponent(i)}`);c(a).forEach(u=>{const d=String(u?.id??"");!d||o.has(d)||(o.add(d),s.push(u))})}catch{}if(!s.length)try{const i=await Lt(`/project-templates/?project_id=${encodeURIComponent(t.id)}`);c(i).forEach(a=>{const u=String(a?.id??"");!u||o.has(u)||(o.add(u),s.push(a))})}catch{}return s}async function zt(){const t=document.getElementById("templates-saved");if(!t)return;const e=t.value||"",n=Array.from(t.options).slice(1).map(s=>({id:s.value,title:s.textContent})),r=await Oe(),o=Array.isArray(r)&&r.length?r:n;t.innerHTML='<option value="">— محفوظات —</option>'+(o||[]).map(s=>`<option value="${String(s.id)}">${s.title||`#${s.id}`}</option>`).join(""),e&&Array.from(t.options).some(s=>s.value===String(e))&&(t.value=String(e))}async function an(t){if(!t)return;const e=document.getElementById("templates-preview-host");if(!e)return;try{e.style.visibility="hidden"}catch{}let n=null;try{n=await Lt(`/project-templates/?id=${encodeURIComponent(t)}`)}catch(s){Kt(s,"تعذر تحميل القالب");return}const r=n&&typeof n=="object"&&"data"in n?n.data:n,o=Array.isArray(r)?r[0]:r;if(!o){try{e.style.visibility=""}catch{}return}e.innerHTML="";try{const s=typeof o.data=="string"?JSON.parse(o.data):o.data;if(s?.html){const c=document.createElement("div");c.innerHTML=s.html;const i=c.firstElementChild;i&&e.appendChild(i);try{Qr(i)}catch{}try{fn(),yn(),De()}catch{}try{re(i)}catch{}try{Kr()}catch{}try{Zt()}catch{}try{Zr({onAfterChange:()=>{try{Rt(),kt(),Mt()}catch{}}})}catch{}}}catch{}try{e.style.visibility=""}catch{}}function ps(){const t=document.getElementById("templates-project"),e=document.getElementById("templates-reservation"),n=document.getElementById("templates-type"),r=document.getElementById("templates-refresh"),o=document.getElementById("templates-print"),s=document.getElementById("templates-save"),c=document.getElementById("templates-save-copy"),i=document.getElementById("templates-saved"),a=document.getElementById("templates-from-res"),u=document.getElementById("templates-rename"),d=document.getElementById("templates-delete"),l=document.getElementById("templates-export"),p=document.getElementById("templates-export-excel"),m=document.getElementById("templates-import"),h=document.getElementById("templates-import-file");try{console.debug("[templatesTab] init start")}catch{}if(!t)return;try{Po({getSnapshot:oa,applySnapshot:os,onAutosaveDebounced:kt,onMarkEditing:Mt})}catch{}Ko(n),hr(),rn(t.value||""),gt(),(async()=>{try{await zt()}catch{}})(),t.addEventListener("change",()=>{rn(t.value||""),gt(),(async()=>{try{await zt()}catch{}})()}),e?.addEventListener("change",gt),n?.addEventListener("change",()=>{try{Go(n.value)}catch{}gt();try{window.__pdfTunerLoadValues&&window.__pdfTunerLoadValues()}catch{}}),r?.addEventListener("click",gt),o&&o.addEventListener("click",async x=>{try{x.preventDefault(),x.stopPropagation()}catch{}try{try{const f=document.getElementById("templates-actions-menu");f&&(f.style.display="none")}catch{}const C=o.textContent;o.disabled=!0,o.textContent="… جاري الطباعة",await Rn();try{Bt("تم إنشاء ملف PDF","success",3500)}catch{}o.textContent=C,o.disabled=!1}catch(C){console.error("❌ [templatesTab] print failed",C);try{Bt("تعذر إنشاء PDF، حاول مجددًا","error",6e3)}catch{alert("تعذر إنشاء PDF، حاول مجددًا")}try{o.disabled=!1}catch{}}});const y=document.getElementById("templates-actions-toggle"),g=document.getElementById("templates-actions-menu"),E=document.getElementById("templates-actions-dd");if(y&&g){try{if(!document.getElementById("templates-print-preview")){const C=document.createElement("button");C.type="button",C.className="btn btn-outline",C.id="templates-print-preview",C.textContent="👁️ معاينة الطباعة",C.style.cssText="display:block;width:100%;text-align:right;margin:4px 0;",C.addEventListener("click",f=>{f.preventDefault(),f.stopPropagation();try{is()}catch{}}),g.insertBefore(C,g.firstChild)}}catch{}try{if(!document.getElementById("templates-new")){const C=document.createElement("button");C.type="button",C.className="btn btn-outline",C.id="templates-new",C.textContent="🆕 قالب جديد (فارغ)",C.style.cssText="display:block;width:100%;text-align:right;margin:4px 0;",C.addEventListener("click",f=>{f.preventDefault(),f.stopPropagation();try{const v=me();localStorage.removeItem(v);const T=`remoteAutosaveId:${v}`;localStorage.removeItem(T)}catch{}try{Bt("تم إنشاء قالب فارغ","success",2e3)}catch{}try{gt()}catch{}}),g.insertBefore(C,g.firstChild)}}catch{}try{if(!document.getElementById("templates-load-last")){const C=document.createElement("button");C.type="button",C.className="btn btn-outline",C.id="templates-load-last",C.textContent="📥 تحميل آخر مسودة",C.style.cssText="display:block;width:100%;text-align:right;margin:4px 0;",C.addEventListener("click",async f=>{f.preventDefault(),f.stopPropagation();try{const v=sa();if(v)await an(v);else{const T=await Oe(),P=(T||[]).find(L=>{const _=String(L?.title||"").toLowerCase();return _.includes("autosave")||_.includes("draft")||_.includes("مسودة")})||(T||[])[0];P&&P.id&&await an(P.id)}try{Bt("تم تحميل المسودة","success",2e3)}catch{}}catch{try{Bt("تعذر تحميل المسودة","error",2500)}catch{}}}),g.insertBefore(C,g.firstChild)}}catch{}try{if(!document.getElementById("templates-fetch-crew")){const C=document.createElement("div");C.style.cssText="height:1px;background:#e5e7eb;margin:6px 0",g.appendChild(C);const f=document.createElement("button");f.type="button",f.className="btn btn-outline",f.id="templates-fetch-crew",f.textContent="👥 جلب الطاقم (إكمال الفراغات)",f.style.cssText="display:block;width:100%;text-align:right;margin:4px 0;";const v=document.createElement("button");v.type="button",v.className="btn btn-outline",v.id="templates-fetch-crew-force",v.textContent="👥 جلب الطاقم (إعادة تعبئة)",v.style.cssText="display:block;width:100%;text-align:right;margin:4px 0;",f.addEventListener("click",T=>{T.preventDefault(),T.stopPropagation();try{pr(!1)}catch{}}),v.addEventListener("click",T=>{T.preventDefault(),T.stopPropagation();try{pr(!0)}catch{}}),g.appendChild(f),g.appendChild(v)}}catch{}const x=C=>{if(!E?.contains(C.target)){g.style.display="none";try{E.classList.remove("dropdown-open");const f=E.closest(".reports-surface-card");f&&f.classList.remove("--raise-on-top"),f&&(f.style.zIndex="")}catch{}document.removeEventListener("click",x,!0)}};y.addEventListener("click",C=>{C.preventDefault(),C.stopPropagation();const f=g.style.display==="block";if(g.style.display=f?"none":"block",f)try{E.classList.remove("dropdown-open");const v=E.closest(".reports-surface-card");v&&v.classList.remove("--raise-on-top"),v&&(v.style.zIndex="")}catch{}else{try{E.classList.add("dropdown-open");const v=E.closest(".reports-surface-card");v&&(v.classList.add("--raise-on-top"),v.style.zIndex="12")}catch{}document.addEventListener("click",x,!0)}})}const I=document.getElementById("templates-lang-toggle");if(I){const x=()=>{I.textContent=jt==="ar"?"🌐 AR":"🌐 EN",I.title=`Language: ${jt.toUpperCase()}`};x(),I.addEventListener("click",()=>{or(jt==="ar"?"en":"ar"),x(),gt()})}if(document.addEventListener("keydown",x=>{x.altKey&&!x.shiftKey&&!x.ctrlKey&&!x.metaKey&&(x.code==="KeyL"||x.key.toLowerCase()==="l")&&(x.preventDefault(),or(jt==="ar"?"en":"ar"),I&&(I.textContent=jt==="ar"?"🌐 AR":"🌐 EN",I.title=`Language: ${jt.toUpperCase()}`),gt())},!0),s?.addEventListener("click",()=>{gr({copy:!1}).then(zt).catch(x=>{const C=x&&(x.message||x?.payload?.error||x?.payload?.details)||"تعذر الحفظ";alert(C);try{console.error("[templates/save] error",x)}catch{}})}),c?.addEventListener("click",()=>{gr({copy:!0}).then(zt).catch(x=>{const C=x&&(x.message||x?.payload?.error||x?.payload?.details)||"تعذر الحفظ";alert(C);try{console.error("[templates/saveCopy] error",x)}catch{}})}),i?.addEventListener("change",()=>{i.value&&an(i.value).catch(()=>{})}),a?.addEventListener("click",()=>{n&&(n.value="callsheet"),e&&e.options.length>1&&(e.selectedIndex=1),gt()}),u?.addEventListener("click",async()=>{const x=i?.value||"";if(!x){alert("اختر محفوظاً أولاً");return}const C=i.options[i.selectedIndex]?.textContent||"",f=prompt("اسم جديد للمحفوظ:",C);if(!(!f||f.trim()===C))try{try{await Lt(`/project-templates/?id=${encodeURIComponent(x)}`,{method:"PATCH",body:{title:String(f).trim()}})}catch(T){Kt(T,"تعذر إعادة التسمية");return}await zt(),Array.from(i.options).find(T=>T.value===String(x))&&(i.value=String(x))}catch{alert("تعذر إعادة التسمية")}}),d?.addEventListener("click",async()=>{const x=i?.value||"";if(!x){alert("اختر محفوظاً أولاً");return}if(confirm("هل تريد حذف هذا المحفوظ نهائياً؟"))try{try{await Lt(`/project-templates/?id=${encodeURIComponent(x)}`,{method:"DELETE"})}catch(f){Kt(f,"تعذر حذف القالب");return}await zt(),gt()}catch{alert("تعذر الحذف")}}),l?.addEventListener("click",async()=>{const x=i?.value||"";if(!x){alert("اختر محفوظاً أولاً");return}try{let C=null;try{C=await Lt(`/project-templates/?id=${encodeURIComponent(x)}`)}catch(D){Kt(D,"تعذر تحميل القالب");return}const f=C&&typeof C=="object"&&"data"in C?C.data:C,v=Array.isArray(f)?f[0]:f;if(!v){alert("تعذر جلب المحفوظ");return}const T=typeof v.data=="string"?JSON.parse(v.data):v.data,P=new Blob([JSON.stringify({meta:{id:v.id,title:v.title,type:v.type,project_id:v.project_id},data:T},null,2)],{type:"application/json"}),L=URL.createObjectURL(P),_=document.createElement("a");_.href=L;const R=(v.title||`template-${x}`).replace(/[^\w\-\s]/g,"").trim()||`template-${x}`;_.download=`${R}.json`,document.body.appendChild(_),_.click(),_.remove(),URL.revokeObjectURL(L)}catch{alert("تعذر التصدير")}}),p?.addEventListener("click",async x=>{x?.preventDefault?.(),x?.stopPropagation?.();try{if((document.getElementById("templates-type")?.value||"expenses")!=="callsheet"){alert("التصدير إلى Excel متاح في الكول شيت فقط");return}const f=document.querySelector("#templates-preview-host #templates-a4-root");if(!f){alert("لا توجد معاينة للكول شيت");return}await _n(),await fo(f)}catch(C){console.error("[templates/export-excel] failed",C),alert("تعذر التصدير إلى Excel")}}),m?.addEventListener("click",()=>{h?.click()}),h?.addEventListener("change",async x=>{const C=x.target?.files?.[0];if(C)try{const f=await C.text(),v=JSON.parse(f),T=Ft();if(!T){alert("اختر مشروعاً أولاً");return}const P=document.getElementById("templates-type"),L=P?P.value:v?.meta?.type||"expenses",_=document.getElementById("templates-reservation"),R=_?.value?Number(_.value):null,D=v?.data?.html?v.data:{html:document.querySelector("#templates-preview-host")?.innerHTML||""};try{await Lt("/project-templates/",{method:"POST",body:{project_id:Number(T.id),reservation_id:R,type:L,title:v?.meta?.title||`Imported - ${L}`,data:D}})}catch(N){Kt(N,"تعذر الاستيراد");return}await zt(),alert("تم الاستيراد بنجاح")}catch{alert("تعذر الاستيراد، تأكد من صحة ملف JSON")}finally{x.target.value=""}}),!pn){let b=function(A=R){if(L||$e){_=!0;return}Ut&&(clearTimeout(Ut),Ut=null),Ut=setTimeout(()=>{Ut=null,N()},Math.max(0,A))};pn=!0,Nt=document.getElementById("templates-preview-host");try{ke=qo(Nt,{onRenumber:()=>{try{hn()}catch{}},onTotalsChange:()=>{try{jn()}catch{}},onAfterChange:()=>{try{Rt(),kt(),Mt()}catch{}try{setTimeout(()=>{pe({headerFooter:!1,logoUrl:Et.logoUrl,isLandscape:!0}),Zt()},30)}catch{}}})}catch{}const x=A=>{const k=A&&A.target;if(k instanceof HTMLElement&&k.isContentEditable&&!Qe){try{Mt()}catch{}try{const H=k.closest("td"),F=H&&H.closest("tr"),Y=F&&F.closest("table.exp-details");if(F&&Y&&F.getAttribute("data-row")==="item"){const G=Array.from(F.children),K=(_t,Pt=0)=>{try{const St=String(_t||"").replace(/[\u0660-\u0669]/g,$t=>"0123456789"[$t.charCodeAt(0)-1632]).replace(/[\u06F0-\u06F9]/g,$t=>"0123456789"[$t.charCodeAt(0)-1776]).replace(/[\u066B]/g,".").replace(/[\u066C]/g,"").replace(/[^\d.\-]/g,""),te=Number(St);return Number.isFinite(te)?te:Pt}catch{return Pt}},z=K(G[2]?.textContent,0),V=K(G[3]?.textContent,1),at=K(G[4]?.textContent,1),st=Math.round(z*V*at),mt=G[6];if(mt){mt.textContent=String(st);try{mt.setAttribute("data-num","1")}catch{}}}}catch{}try{clearTimeout(Qn)}catch{}Qn=setTimeout(()=>{tn(420)},180);try{clearTimeout(tr)}catch{}tr=setTimeout(()=>{try{typeof window.__enforceCallsheetSizing=="function"&&window.__enforceCallsheetSizing()}catch{}},80)}};Z.hostInput=x,Nt?.addEventListener("input",x);const C=A=>{Qe=!0},f=A=>{Qe=!1;try{x(A)}catch{}try{typeof window.__enforceCallsheetSizing=="function"&&window.__enforceCallsheetSizing()}catch{}};Z.hostCompStart=C,Z.hostCompEnd=f,Nt?.addEventListener("compositionstart",C,!0),Nt?.addEventListener("compositionend",f,!0);const v=A=>{const k=A.target;if(!(k instanceof HTMLElement))return;const H=k.closest&&k.closest("td");if(H)try{H.classList.add("editing")}catch{}},T=A=>{const k=A.target;if(!(k instanceof HTMLElement))return;const H=k.closest&&k.closest("td");if(H)try{H.classList.remove("editing")}catch{}try{H&&H.closest&&H.closest("table.exp-details")&&tn(120)}catch{}try{typeof window.__enforceCallsheetSizing=="function"&&window.__enforceCallsheetSizing()}catch{}};Nt?.addEventListener("focusin",v,!0),Nt?.addEventListener("focusout",T,!0),Z.hostFocusIn=v,Z.hostFocusOut=T;try{Me=Oo(Nt,{onAfterChange:()=>{try{Rt(),kt(),Mt()}catch{}try{setTimeout(()=>{pe({headerFooter:!1,logoUrl:Et.logoUrl,isLandscape:!0}),Zt()},30)}catch{}},onTotalsChange:()=>tn()})}catch{}const P=A=>{const k=A.target&&A.target.closest&&A.target.closest('[contenteditable="true"]');if(k){try{setTimeout(()=>{k&&k.focus&&k.focus()},0)}catch{}return}const H=A.target&&A.target.closest&&A.target.closest("td");if(H){const F=H.querySelector('[contenteditable="true"]');if(F)try{setTimeout(()=>{F&&F.focus&&F.focus()},0)}catch{}}};Nt?.addEventListener("mousedown",P,!0),Z.hostMouseDown=P;try{ia()}catch{}let L=!1,_=!1;const R=420;let D="";const N=async()=>{if(L||$e){_=!0;return}L=!0;try{isTemplatesDebugEnabled()&&console.debug("[templatesTab] repopulate start")}catch{}const A=t?.value||"";try{ie()?.length||await Ae(),Cn()?.length||await Br()}catch(Y){try{isTemplatesDebugEnabled()&&console.warn("[templatesTab] fetch fallback failed",Y)}catch{}}hr(),!t.value&&t.options.length>1?t.selectedIndex=1:A&&(t.value=A),rn(t.value||"");const k=document.getElementById("templates-type"),H=k?k.value:"expenses",F=`${t.value||""}|${document.getElementById("templates-reservation")?.value||""}|${H}`;F!==D&&(D=F,gt());try{await zt()}catch{}try{isTemplatesDebugEnabled()&&console.debug("[templatesTab] repopulate done")}catch{}L=!1,_&&(_=!1,b())},M=()=>b(),q=()=>b(),B=()=>b();Z.projChanged=M,Z.resChanged=q,Z.resUpdated=B,document.addEventListener("projects:changed",M),document.addEventListener("reservations:changed",q),document.addEventListener("reservations:updated",B);const j=document.querySelector('[data-project-subtab-target="projects-templates-tab"]'),X=()=>b(0);Z.tabClick=X,j?.addEventListener("click",X),b(0)}try{Array.from(document.querySelectorAll(".sub-tab-button[data-project-subtab-target]")).forEach(x=>{(x.getAttribute("data-project-subtab-target")||"")!=="projects-templates-tab"&&x.dataset.tplDestroyBound!=="1"&&(x.addEventListener("click",()=>{try{er()}catch{}}),x.dataset.tplDestroyBound="1")}),Array.from(document.querySelectorAll(".tab-button[data-tab-target]")).forEach(x=>{(x.getAttribute("data-tab-target")||"")!=="projects-section"&&x.dataset.tplDestroyMainBound!=="1"&&(x.addEventListener("click",()=>{try{er()}catch{}}),x.dataset.tplDestroyMainBound="1")})}catch{}try{Zo()}catch{}}function ms(){document.addEventListener("DOMContentLoaded",()=>{co(),po(),Na(),Lr(),Ba(),ro(),ao(),ps(),Ma(),ka(),Ra(),Da(),qa(),ja(),Fa({onViewDetails:Be}),$a({onOpenProject:Be}),Oa(),hs()}),document.addEventListener("language:changed",br),document.addEventListener("language:translationsReady",br),document.addEventListener("customers:changed",fs),document.addEventListener("technicians:updated",ys),document.addEventListener("reservations:changed",()=>Ha(Be)),document.addEventListener(Sa.USER_UPDATED,()=>{de(),ue()});try{document.addEventListener("projects:changed",()=>{Pr(),vn(),de(),_e(),ue()},{passive:!0})}catch{}}async function hs(){try{await Ir({suppressError:!0}),await Ae();try{await za()}catch{}}catch(t){console.error("❌ [projects] Failed to initialise projects data",t);const e=t?.message||O("projects.toast.fetchFailed","تعذر تحميل بيانات المشاريع، حاول لاحقًا");Bt(e,"error")}finally{Pr(),ze(),Ua(),vn(),de(),_e(),ue(),mo();try{const t=!!qe(),e=!!Rr(),n=document.querySelector('.sub-tab-button[data-project-subtab-target="projects-list-tab"]');!t&&!e&&Array.isArray(it.projects)&&it.projects.length>0&&n&&(await Ue("projects-list-tab",n),Sn("projects-list-tab"))}catch{}}}function br(){ze(),vn(),de(),_e(),ue(),Lr()}function fs(){Wa(),ze()}function ys(){Va(),ze()}Aa();_a();Ta();Ga();ms();document.addEventListener("DOMContentLoaded",()=>{Ka(),La()});let ce=.15;const Ne={},gs="https://cdn.jsdelivr.net/npm/apexcharts@3.49.0/dist/apexcharts.min.js";let be=0;const U={projects:[],customers:[],reservations:[],totalProjects:0,filters:{search:"",statuses:["upcoming","ongoing","completed"],payment:"all",confirmed:"all",range:"all",startDate:"",endDate:""}},S={search:null,payment:null,confirmed:null,dateRange:null,customRangeWrapper:null,startDate:null,endDate:null,refreshBtn:null,exportExcelBtn:null,kpiGrid:null,statusChips:null,table:null,tableBody:null,tableHead:null,tableMeta:null,tableEmpty:null,chartCards:{},chartLoaders:{}},ne=Object.freeze({projects:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M4 4h6v8h-6z"></path>
      <path d="M14 4h6v5h-6z"></path>
      <path d="M4 16h6v4h-6z"></path>
      <path d="M14 11h6v9h-6z"></path>
    </svg>
  `,value:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 8c-4.418 0 -8 1.79 -8 4s3.582 4 8 4s8 -1.79 8 -4s-3.582 -4 -8 -4"></path>
      <path d="M12 8v8"></path>
      <path d="M8 12h8"></path>
    </svg>
  `,outstanding:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M7 18v-11a2 2 0 0 1 4 0v11"></path>
      <path d="M7 8h4"></path>
      <path d="M15 18v-7a2 2 0 0 1 4 0v7"></path>
      <path d="M15 13h4"></path>
    </svg>
  `,expenses:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M3 12l3 3l3 -3"></path>
      <path d="M6 6v9"></path>
      <path d="M13 6h5"></path>
      <path d="M15.5 6v12"></path>
      <path d="M21 18h-5"></path>
    </svg>
  `,margin:`
    <svg aria-hidden="true" focusable="false" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
      <path d="M12 3a9 9 0 1 0 9 9"></path>
      <path d="M12 7v5l3 3"></path>
      <path d="M16 3l5 5"></path>
    </svg>
  `});let Ct=null;const da=["upcoming","ongoing","completed"],Tt={key:"value",dir:"desc"};let on=!1,wr=0;const bs=1500;async function ws({forceProjects:t=!1}={}){try{await Ir({suppressError:!0}),await Za({force:t})}catch(e){console.error("❌ [projectsReports] Failed to load initial data",e),Nr(e)&&console.warn("Projects API error:",e.message)}He()}async function vs(){Cs(),pa(),Ss();try{le()}catch{}try{const t=document?.documentElement?.getAttribute("dir")||"rtl",e=document.querySelector(".reports-wrapper--projects");e&&e.setAttribute("dir",t)}catch{}await xs();try{const t=new URLSearchParams(window.location.search||"");U.__debug=t.get("reportsDebug")==="1"||t.get("debugReports")==="1"}catch{U.__debug=!1}try{if(await ws({forceProjects:!0}),!Array.isArray(ie())||ie().length===0){try{await Ae()}catch{}He()}S.search&&(S.search.value=""),U.filters.search="",ba(),Ts(),Us(),$s(),dt()}finally{ma()}document.addEventListener("language:changed",Ps,{passive:!0}),document.addEventListener("projects:changed",()=>{bn().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after projects change",t)})},{passive:!0}),document.addEventListener("reservations:changed",()=>{bn().catch(t=>{console.error("❌ [projectsReports] Failed to refresh after reservations change",t)})},{passive:!0}),window.addEventListener("storage",Is)}document.addEventListener("DOMContentLoaded",vs);async function xs(){if(Ct)return Ct;if(typeof window>"u")return null;if(window.ApexCharts)return Ct=window.ApexCharts,Ct;try{await Es(gs),Ct=window.ApexCharts||null}catch(t){console.warn("ApexCharts failed to load",t),Ct=null}return Ct}function Es(t){return new Promise((e,n)=>{if(typeof document>"u"){n(new Error("Document is not available to load scripts."));return}const r=document.querySelector(`script[src="${t}"]`);if(r){if(r.dataset.loaded==="true"){e();return}r.addEventListener("load",e,{once:!0}),r.addEventListener("error",()=>n(new Error(`Failed to load script ${t}`)),{once:!0});return}const o=document.createElement("script");o.src=t,o.async=!0,o.dataset.loaded="false",o.onload=()=>{o.dataset.loaded="true",e()},o.onerror=()=>n(new Error(`Failed to load script ${t}`)),document.head.appendChild(o)})}function Cs(){S.search=document.getElementById("reports-search"),S.statusChips=document.getElementById("reports-status-chips"),S.payment=document.getElementById("reports-payment"),S.confirmed=document.getElementById("reports-confirmed"),S.dateRange=document.getElementById("reports-date-range"),S.customRangeWrapper=document.getElementById("reports-custom-range"),S.startDate=document.getElementById("reports-start-date"),S.endDate=document.getElementById("reports-end-date"),S.refreshBtn=document.getElementById("reports-refresh"),S.exportExcelBtn=document.getElementById("projects-export-excel"),S.kpiGrid=document.getElementById("reports-kpi-grid"),S.table=document.getElementById("reports-table"),S.tableBody=S.table?.querySelector("tbody"),S.tableHead=S.table?.querySelector("thead"),S.tableMeta=document.getElementById("reports-table-meta"),S.tableEmpty=document.getElementById("reports-empty"),S.chartCards={},S.chartLoaders={},document.querySelectorAll("[data-chart-card]").forEach(t=>{const e=t.dataset.chartCard;if(!e)return;S.chartCards[e]=t;const n=t.querySelector("[data-chart-loading]");n&&(S.chartLoaders[e]=n)})}function ua(t){const e=!!t;Object.entries(S.chartCards||{}).forEach(([n,r])=>{if(!r)return;r.classList.toggle("is-loading",e),r.setAttribute("aria-busy",e?"true":"false");const o=S.chartLoaders?.[n];o&&(o.hidden=!e)})}function pa(){be+=1,be===1&&ua(!0)}function ma(){be=Math.max(0,be-1),be===0&&ua(!1)}function He(){const{customers:t=[]}=Pa();U.customers=Array.isArray(t)?t:[],U.reservations=Cn();const e=new Map(U.customers.map(r=>[String(r.id),r])),n=ie();U.projects=Array.isArray(n)?n.map(r=>As(r,e)):[],U.totalProjects=U.projects.length}function gn(t){const e=We(t.id);let n=0,r=0,o=0;e.forEach(l=>{const p=to(l),m=Number(p.finalTotal||0),h=Number(p.taxAmount||0);n+=m,r+=h,o+=m-h});const s=Number(t?.raw?.equipmentEstimate??t?.equipmentEstimate??0)||0,c=Number(t?.raw?.servicesClientPrice??t?.servicesClientPrice??0)||0,i=Number(t?.expensesTotal??0)||0,a=o+s+c,u=o+(c-i),d=a>0?u/a*100:0;return{resFinal:n,resTax:r,resNetRevenue:o,equipmentEstimate:s,servicesRevenue:c,projectExpenses:i,netProfit:u,marginPercent:d}}function Ss(){try{const t=typeof window<"u"?window:globalThis,e=[t.APP_VAT_RATE,t.APP_TAX_RATE,t.__APP_SETTINGS__?.vatRate];for(const n of e){const r=Number(n);if(Number.isFinite(r)&&r>0&&r<=1){ce=r;return}if(Number.isFinite(r)&&r>1&&r<=100){ce=r/100;return}}}catch{}try{Lt("/preferences/").then(t=>{const e=t?.data??t??{},n=e.vatRate??e.taxRate??null,r=Number(n);Number.isFinite(r)&&r>0&&(ce=r>1?r/100:r,dt())}).catch(()=>{})}catch{}}function As(t,e){const n=t.paymentStatus==="paid"?"paid":"unpaid",r=e.get(String(t.clientId)),o=We(t.id),s=o.reduce((L,_)=>{const R=Array.isArray(_.items)?_.items:[],D=Array.isArray(_.crewAssignments)?_.crewAssignments:[],N=D.length?D:Array.isArray(_.technicians)?_.technicians:[],b=Array.isArray(N)&&N.length&&typeof N[0]=="object",M=Array.isArray(N)&&N.length&&typeof N[0]!="object",q=ve({items:R,technicianIds:M?N:[],crewAssignments:b?N:[],discount:_.discount??0,discountType:_.discountType||"percent",applyTax:!1,start:_.start,end:_.end});return L.equipment+=Number(q.equipmentTotal||0),L.crew+=Number(q.crewTotal||0),L.crewCost+=Number(q.crewCostTotal||0),L},{equipment:0,crew:0,crewCost:0}),c=Ve(t),i=Number(t?.discount??0)||0,a=t?.discountType==="amount"?"amount":"percent",u=t?.applyTax===!0||t?.applyTax==="true",d=s.equipment+s.crew+c;let l=a==="amount"?i:d*(i/100);(!Number.isFinite(l)||l<0)&&(l=0),l>d&&(l=d);const p=Math.max(0,d-l),m=t?.companyShareEnabled===!0||t?.companyShareEnabled==="true",h=Number(t?.companySharePercent)||0,y=u||m&&h>0,g=m&&y?h:0,E=g>0?Number((p*(g/100)).toFixed(2)):0,I=y?Number(((p+E)*ce).toFixed(2)):0,x=Number((p+E+I).toFixed(2)),C=_s(t),f=(()=>{try{if(t?.cancelled===!0)return!0;const L=String(t?.status||t?.raw?.status||"").toLowerCase();return L==="cancelled"||L==="canceled"||L==="ملغي"||L==="ملغى"}catch{return!1}})(),v=f?"cancelled":C,T=t.start?new Date(t.start):null,P=t.end?new Date(t.end):null;return{raw:t,id:t.id,projectCode:t.projectCode||t.id,title:(t.title||"").trim(),clientId:t.clientId,clientName:r?.customerName||r?.name||"",clientCompany:t.clientCompany||r?.companyName||"",type:t.type||t.projectType||"",description:t.description||"",paymentStatus:n,confirmed:t.confirmed===!0||t.confirmed==="true",start:T,end:P,applyTax:y,companyShareEnabled:m,companySharePercent:g,status:v,cancelled:f,reservationsTotal:Number((s.equipment+s.crew).toFixed(2)),expensesTotal:Se(t),servicesClientPrice:c,taxAmount:I,combinedTaxAmount:I,overallTotal:x,unpaidValue:n==="paid"?0:x,reservationsCount:o.length}}function We(t){return Array.isArray(U.reservations)?U.reservations.filter(e=>String(e.projectId)===String(t)):[]}function Se(t){return typeof t.expensesTotal=="number"?Number(t.expensesTotal)||0:Array.isArray(t.expenses)?t.expenses.reduce((e,n)=>e+(Number(n.amount)||0),0):0}function Ve(t){const e=Number(t?.servicesClientPrice??t?.services_client_price??t?.raw?.servicesClientPrice??t?.raw?.services_client_price??0)||0;if(e>0)return e;const n=Array.isArray(t?.expenses)?t.expenses:Array.isArray(t?.raw?.expenses)?t.raw.expenses:[];if(!n.length)return 0;const r=o=>{if(typeof o=="number")return Number.isFinite(o)?o:0;if(o==null||o==="")return 0;const s=Qt(String(o)).replace(/[^\d.+-]/g,""),c=Number.parseFloat(s);return Number.isFinite(c)?c:0};return n.reduce((o,s)=>o+r(s?.salePrice??s?.sale_price??0),0)}function _s(t){const e=new Date,n=t.start?new Date(t.start):null,r=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":r&&!Number.isNaN(r.getTime())&&r<e?"completed":"ongoing"}function Ts(){if(S.search){let t;S.search.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{U.filters.search=S.search.value.trim(),dt()},180)})}S.payment&&(S.payment.value=U.filters.payment,S.payment.addEventListener("change",()=>{U.filters.payment=S.payment.value||"all",dt()})),S.confirmed&&(S.confirmed.value=U.filters.confirmed||"all",S.confirmed.addEventListener("change",()=>{U.filters.confirmed=S.confirmed.value||"all",dt()})),S.dateRange&&(S.dateRange.addEventListener("change",Ls),S.dateRange.value=U.filters.range,S.dateRange.value==="custom"&&le()),S.startDate&&S.startDate.addEventListener("change",()=>{U.filters.startDate=S.startDate.value,U.filters.range==="custom"&&dt()}),S.endDate&&S.endDate.addEventListener("change",()=>{U.filters.endDate=S.endDate.value,U.filters.range==="custom"&&dt()}),S.refreshBtn&&S.refreshBtn.addEventListener("click",()=>{if(U.filters.range!=="custom"){dt();return}U.filters.startDate=S.startDate?.value||"",U.filters.endDate=S.endDate?.value||"",dt()})}function Ls(t){const e=t.target.value;U.filters.range=e,e==="custom"?(S.customRangeWrapper?.classList.add("active"),le()):(S.customRangeWrapper?.classList.remove("active"),U.filters.startDate="",U.filters.endDate="",S.startDate&&(S.startDate.value=""),S.endDate&&(S.endDate.value=""),dt())}function le(){try{if(!window.flatpickr){try{const r=document.querySelector('script[data-flatpickr-loader="true"]')||document.querySelector('script[src*="flatpickr"]');if(r)r.dataset.boundRetry||(r.addEventListener("load",()=>{try{le()}catch{}},{once:!0}),r.dataset.boundRetry="true");else{const o=document.createElement("script");o.src="https://cdn.jsdelivr.net/npm/flatpickr",o.async=!0,o.dataset.flatpickrLoader="true",o.onload=()=>{try{le()}catch{}},document.head.appendChild(o)}}catch{}setTimeout(()=>{try{le()}catch{}},150);return}const t=(()=>{try{if((wt()||"ar").toLowerCase().startsWith("ar")&&window.flatpickr?.l10ns?.ar)return"ar"}catch{}return window.flatpickr?.l10ns?.default,void 0})(),e=r=>({dateFormat:"Y-m-d",allowInput:!0,clickOpens:!0,disableMobile:!0,appendTo:document.body,...t?{locale:t}:{},...r});if(S.startDate&&!S.startDate._flatpickr){try{S.startDate.removeAttribute("readonly"),S.startDate.setAttribute("tabindex","0"),S.startDate.style.cursor="pointer",S.startDate.setAttribute("aria-haspopup","dialog")}catch{}window.flatpickr(S.startDate,e({onChange:(r,o)=>{U.filters.startDate=o||"",S.endDate?._flatpickr&&r?.length&&S.endDate._flatpickr.set("minDate",r[0]),U.filters.range==="custom"&&dt()},onValueUpdate:(r,o)=>{U.filters.startDate=o||"",U.filters.range==="custom"&&dt()}})),S.startDate.addEventListener("click",()=>S.startDate?._flatpickr?.open()),S.startDate.addEventListener("focus",()=>S.startDate?._flatpickr?.open())}if(S.endDate&&!S.endDate._flatpickr){try{S.endDate.removeAttribute("readonly"),S.endDate.setAttribute("tabindex","0"),S.endDate.style.cursor="pointer",S.endDate.setAttribute("aria-haspopup","dialog")}catch{}window.flatpickr(S.endDate,e({onChange:(r,o)=>{U.filters.endDate=o||"",S.startDate?._flatpickr&&r?.length&&S.startDate._flatpickr.set("maxDate",r[0]),U.filters.range==="custom"&&dt()},onValueUpdate:(r,o)=>{U.filters.endDate=o||"",U.filters.range==="custom"&&dt()}})),S.endDate.addEventListener("click",()=>S.endDate?._flatpickr?.open()),S.endDate.addEventListener("focus",()=>S.endDate?._flatpickr?.open())}const n=S.customRangeWrapper;n&&!n.dataset.openBound&&(n.addEventListener("click",r=>{const o=r.target;if(o===S.startDate){S.startDate?._flatpickr?.open();return}if(o===S.endDate){S.endDate?._flatpickr?.open();return}S.startDate?._flatpickr?.open()}),n.dataset.openBound="true")}catch{}}async function bn(){const t=Date.now();if(!on){if(t-wr<bs){He(),dt();return}on=!0,pa();try{await Promise.all([Ae(),Br()])}catch(e){console.error("❌ [projectsReports] Data mutation refresh failed",e),Nr(e)&&console.warn("Projects API error:",e.message)}finally{wr=Date.now(),on=!1,He(),dt(),ma()}}}function Ps(){try{const t=document?.documentElement?.getAttribute("dir")||"rtl",e=document.querySelector(".reports-wrapper--projects");e&&e.setAttribute("dir",t)}catch{}ba(),dt()}function Is(t){t.key&&!["projects","reservations","customers"].includes(t.key)||bn().catch(e=>{console.error("❌ [projectsReports] Storage sync failed",e)})}function dt(){const t=ha();Fn(),Ms(t),Ds(t),qs(t),js(t),Fs(t),zs(t),Vs()}function ha(){const{search:t,statuses:e,payment:n,range:r,startDate:o,endDate:s,confirmed:c}=U.filters,i=ya(t),a=new Date,u=Number(r);let d=null;if(r==="custom"){d=o?new Date(o):null;const l=s?new Date(s):null;return U.projects.filter(p=>p?.cancelled===!0||String(p?.status).toLowerCase()==="cancelled"||String(p?.status).toLowerCase()==="canceled"||!vr(p,e)||!xr(p,n)||!Cr(p,i)||!Er(p,c)?!1:Bs(p.start,d,l))}return r!=="all"&&Number.isFinite(u)&&(d=new Date,d.setDate(a.getDate()-u)),U.projects.filter(l=>l?.cancelled===!0||String(l?.status).toLowerCase()==="cancelled"||String(l?.status).toLowerCase()==="canceled"||!vr(l,e)||!xr(l,n)||!Cr(l,i)||!Er(l,c)?!1:r==="all"?!0:Ns(l.start,d,a))}function vr(t,e){return e.includes(t.status)}function xr(t,e){return e==="all"?!0:fa(t)===e}function Er(t,e){if(!e||e==="all")return!0;const n=t?.confirmed===!0;return e==="yes"?n:e==="no"?!n:!0}function Cr(t,e){return e?ya([t.title,t.projectCode,t.clientName,t.clientCompany,t.type,t.description].filter(Boolean).join(" ")).includes(e):!0}function fa(t){try{const e=t?.raw||t||{},n=Number(t?.overallTotal||0)||0;let r=0;const o=a=>{const u=Number(a);Number.isFinite(u)&&u>0&&(r+=u)},s=Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payments)?e.payments:[];if(Array.isArray(s)&&s.length)s.forEach(a=>{const u=(a?.type||"").toString().toLowerCase(),d=Number(a?.value??a?.amount??a?.percentage??0)||0;o(u==="percent"||u==="percentage"?d/100*n:d)});else{o(e?.paidAmount??e?.paid_amount);const a=Number(e?.paidPercent??e?.paid_percentage);a>0&&o(a/100*n)}const c=.01;return n<=0?r>0?"partial":"unpaid":Math.max(0,n-r)<=c?"paid":r>0?"partial":"unpaid"}catch{return"unpaid"}}function Ns(t,e,n){return!t||!(t instanceof Date)||Number.isNaN(t.getTime())?!1:e?t>=e&&t<=n:!0}function Bs(t,e,n){if(!e&&!n)return!0;if(!t||Number.isNaN(t.getTime()))return!1;const r=t.getTime();return!(e&&!Number.isNaN(e.getTime())&&r<e.getTime()||n&&!Number.isNaN(n.getTime())&&r>n.getTime())}function ya(t){return t?Qt(String(t)).toLowerCase().trim():""}function Ms(t){if(!S.kpiGrid)return;const e=t.length,n=ga(t),r=n.grossRevenue,o=n.outstandingTotal||0,s=n.projectExpensesTotal||0,c=n.netProfit||0,i=[{key:"projects",icon:ne.projects,label:O("projects.reports.kpi.totalProjects",wt()==="ar"?"إجمالي المشاريع":"Total projects"),value:wn(e),meta:O("projects.reports.kpi.totalProjectsMeta",wt()==="ar"?"بعد تطبيق الفلاتر الحالية":"After applying the current filters")},{key:"totalValue",icon:ne.value,label:O("projects.reports.kpi.totalValue",wt()==="ar"?"الإيراد الكلي":"Total value"),value:bt(r),meta:O("projects.reports.kpi.totalValueMeta",wt()==="ar"?"يشمل المشاريع والحجوزات والضريبة":"Includes projects, linked reservations, and VAT")},{key:"outstanding",icon:ne.outstanding,label:O("projects.reports.kpi.unpaidValue",wt()==="ar"?"قيمة غير مدفوعة":"Outstanding value"),value:bt(o),meta:O("projects.reports.kpi.unpaidValueMeta",wt()==="ar"?"مشاريع لم تُسدّد بالكامل":"Projects not fully paid yet")},{key:"expenses",icon:ne.expenses,label:O("projects.reports.kpi.expenses","تكلفة الخدمات الإنتاجية"),value:bt(s),meta:O("projects.reports.kpi.expensesMeta","تكلفة الخدمات الإنتاجية للمشاريع المحددة")},{key:"margin",icon:ne.margin,label:O("projects.reports.kpi.margin","هامش الربح"),value:va(n.profitMarginPercent),meta:O("projects.reports.kpi.marginMeta","صافي الربح ÷ الإيراد بدون الضريبة")},{key:"netProfit",icon:ne.value,label:O("reservations.reports.kpi.revenue.details.net","صافي الربح"),value:bt(c),meta:O("projects.reports.kpi.netProfitMeta","مجموع صافي الربح للمشاريع المحددة")}];S.kpiGrid.innerHTML=i.map(({key:a,icon:u,label:d,value:l,meta:p})=>`
    <div class="reports-kpi-card glass-card" data-kpi="${a}">
      <div class="reports-kpi-icon">${u}</div>
      <div class="reports-kpi-content">
        <p class="reports-kpi-label">${vt(d)}</p>
        <p class="reports-kpi-value">${vt(l)}</p>
        <span class="reports-kpi-meta">${vt(p)}</span>
      </div>
    </div>
  `).join(""),ks(t)}function ks(t){try{const e=ga(t),n="projects-revenue-breakdown";let r=document.getElementById(n);const o=(e.servicesRevenueTotal||0)-(e.projectExpensesTotal||0),s=[{key:"gross",label:O("reservations.reports.kpi.revenue.details.gross","الإيراد الكلي","Gross revenue"),value:bt(e.grossRevenue)},{key:"discount",label:O("projects.details.summary.discount","الخصم","Discount"),value:`−${bt(e.discountTotal||0)}`},{key:"share",label:O("reservations.reports.kpi.revenue.details.share","نسبة الشركة","Company share"),value:bt(e.companyShareTotal)},{key:"tax",label:O("reservations.reports.kpi.revenue.details.tax","الضريبة","Tax"),value:bt(e.taxTotal)},{key:"crewGross",label:O("reservations.reports.kpi.revenue.details.crewGross","إجمالي الطاقم","Crew total"),value:bt(e.crewTotal)},{key:"crew",label:O("reservations.reports.kpi.revenue.details.crew","تكلفة الطاقم","Crew cost"),value:`−${bt(e.crewCostTotal)}`},{key:"equipment",label:O("reservations.reports.kpi.revenue.details.equipmentGross","إجمالي المعدات","Equipment total"),value:bt(e.equipmentTotalCombined)},{key:"equipmentCost",label:O("reservations.reports.kpi.revenue.details.equipment","تكلفة المعدات","Equipment cost"),value:`−${bt(e.equipmentCostTotalCombined||0)}`},{key:"projectExpenses",label:O("projects.reports.kpi.revenue.details.projectExpenses","تكلفة الخدمات الإنتاجية","Project expenses"),value:`−${bt(e.projectExpensesTotal)}`},{key:"servicesProfit",label:O("projects.reports.kpi.revenue.details.servicesProfit",wt()==="ar"?"ربح الخدمات الإنتاجية":"Services profit"),value:`${bt(o)}`},{key:"net",label:O("reservations.reports.kpi.revenue.details.net","صافي الربح","Net profit"),value:bt(e.netProfit)}],c=`
      <div id="${n}" class="reports-kpi-details glass-card" style="margin-top: 12px;">
        ${s.map(({key:i,label:a,value:u})=>`
          <div class="reports-kpi-detail-row d-flex justify-content-between" data-row="${i}">
            <span class="reports-kpi-detail-label">${vt(a)}</span>
            <span class="reports-kpi-detail-value">${vt(u)}</span>
          </div>
        `).join("")}
      </div>
    `;r?r.outerHTML=c:S.kpiGrid.insertAdjacentHTML("afterend",c)}catch(e){console.warn("[projectsReports] Failed to render revenue breakdown",e)}}function ga(t){const e=new Set(t.map(f=>String(f.id))),n=U.reservations.filter(f=>f.projectId!=null&&e.has(String(f.projectId))),r=new Map;let o=0,s=0,c=0,i=0;n.forEach(f=>{const v=Array.isArray(f.items)?f.items:[],T=Array.isArray(f.crewAssignments)?f.crewAssignments:[],P=T.length?T:Array.isArray(f.technicians)?f.technicians:[],L=Array.isArray(P)&&P.length&&typeof P[0]=="object",_=Array.isArray(P)&&P.length&&typeof P[0]!="object",R=ve({items:v,technicianIds:_?P:[],crewAssignments:L?P:[],discount:f.discount??0,discountType:f.discountType||"percent",applyTax:!1,start:f.start,end:f.end});o+=Number(R.equipmentTotal||0),s+=Number(R.equipmentCostTotal||0),c+=Number(R.crewTotal||0),i+=Number(R.crewCostTotal||0);const D=r.get(String(f.projectId))||[];D.push(f),r.set(String(f.projectId),D)});let a=0,u=0,d=0,l=0,p=0,m=0,h=0,y=0;t.forEach(f=>{const T=(r.get(String(f.id))||[]).reduce((z,V)=>{const at=Array.isArray(V.items)?V.items:[],st=Array.isArray(V.crewAssignments)?V.crewAssignments:[],mt=st.length?st:Array.isArray(V.technicians)?V.technicians:[],_t=Array.isArray(mt)&&mt.length&&typeof mt[0]=="object",Pt=Array.isArray(mt)&&mt.length&&typeof mt[0]!="object",St=ve({items:at,technicianIds:Pt?mt:[],crewAssignments:_t?mt:[],discount:V.discount??0,discountType:V.discountType||"percent",applyTax:!1,start:V.start,end:V.end});return z.equipment+=Number(St.equipmentTotal||0),z.equipmentCost+=Number(St.equipmentCostTotal||0),z.crew+=Number(St.crewTotal||0),z.crewCost+=Number(St.crewCostTotal||0),z},{equipment:0,equipmentCost:0,crew:0,crewCost:0}),P=Ve(f);p+=P,l+=Number(Se(f)||0);const L=T.equipment+T.crew+P,_=Number(f?.raw?.discount??f?.discount??0)||0;let D=((f?.raw?.discount_type??f?.discountType)==="amount"?"amount":"percent")==="amount"?_:L*(_/100);(!Number.isFinite(D)||D<0)&&(D=0),D>L&&(D=L);const N=Math.max(0,L-D);y+=Number(D||0);let b=(()=>{const z=f?.applyTax!==void 0?f.applyTax:f?.apply_tax??f?.raw?.apply_tax??f?.raw?.applyTax;return z===!0||z===1||z==="1"||typeof z=="string"&&z.toLowerCase()==="true"})();const M=(()=>{const z=f?.companyShareEnabled!==void 0?f.companyShareEnabled:f?.raw?.company_share_enabled??f?.raw?.companyShareEnabled;return z===!0||z===1||z==="1"||typeof z=="string"&&z.toLowerCase()==="true"})(),q=(()=>{const z=f?.raw?.company_share_percent??f?.raw?.companySharePercent??f?.companySharePercent??f?.company_share_percent??0,V=Number(z);return Number.isFinite(V)?V:0})();M&&q>0&&(b=!0);const B=M&&b?q:0,j=B>0?Number((N*(B/100)).toFixed(2)):0;d+=j;const X=b?Number(((N+j)*ce).toFixed(2)):0;u+=X;const A=N+j+X;a+=A;const k=Number(Se(f)||0),H=Number((N-k-(T.crewCost||0)-(T.equipmentCost||0)).toFixed(2));h+=H;const F=f.raw||f;let Y=0;const G=z=>{const V=Number(z);Number.isFinite(V)&&V>0&&(Y+=V)};let K=!1;try{const z=Array.isArray(F.paymentHistory)?F.paymentHistory:Array.isArray(F.payments)?F.payments:[];Array.isArray(z)&&z.length&&(K=!0,z.forEach(V=>{const at=(V?.type||"").toString().toLowerCase(),st=Number(V?.value??V?.amount??V?.percentage??0)||0;G(at==="percent"||at==="percentage"?st/100*A:st)}))}catch{}if(!K){G(F?.paidAmount??F?.paid_amount);const z=Number(F?.paidPercent??F?.paid_percentage);z>0&&G(z/100*A)}Y>A&&(Y=A),m+=Math.max(0,A-Y)});const g=o,E=s,I=Math.max(0,a-u),x=h,C=I>0?x/I*100:0;return{grossRevenue:a,companyShareTotal:d,taxTotal:u,crewTotal:c,crewCostTotal:i,equipmentTotalCombined:g,equipmentCostTotalCombined:E,projectExpensesTotal:l,servicesRevenueTotal:p,outstandingTotal:m,netProfit:x,revenueExTax:I,profitMarginPercent:C,discountTotal:y}}function ba(){if(!S.statusChips)return;const t=da.map(e=>{const n=O(`projects.status.${e}`,e);return`<span class="reports-status-chip timeline-status-badge timeline-status-badge--${e}" data-status="${e}">${vt(n)}</span>`}).join("");S.statusChips.innerHTML=t,S.statusChips.dataset.listenerAttached||(S.statusChips.addEventListener("click",Rs),S.statusChips.dataset.listenerAttached="true"),Fn()}function Rs(t){const e=t.target.closest("[data-status]");if(!e)return;const n=e.dataset.status;if(!n)return;const r=new Set(U.filters.statuses);r.has(n)?r.delete(n):r.add(n),r.size===0&&da.forEach(o=>r.add(o)),U.filters.statuses=Array.from(r),Fn(),dt()}function Fn(){if(!S.statusChips)return;const t=new Set(U.filters.statuses);S.statusChips.querySelectorAll("[data-status]").forEach(e=>{e.classList.toggle("is-active",t.has(e.dataset.status))})}function Ds(t){if(!Ct)return;const e=document.getElementById("reports-status-chart");if(!e)return;const n=["upcoming","ongoing","completed"],r=n.map(a=>t.filter(u=>u.status===a).length),o=n.map(a=>O(`projects.status.${a}`,a)),c=r.reduce((a,u)=>a+u,0)>0?r:[],i={chart:{type:"donut",height:320,toolbar:{show:!1}},labels:o,series:c,colors:["#3b82f6","#fbbf24","#22c55e"],dataLabels:{formatter:a=>Number.isFinite(a)?`${Math.round(a)}%`:"0%"},legend:{position:"bottom",fontSize:"13px"},stroke:{width:0},tooltip:{y:{formatter:a=>Jt(a)}},noData:{text:O("projects.reports.noData","لا توجد بيانات متاحة")},responsive:[{breakpoint:1024,options:{chart:{height:280}}}]};Xe("status",e,i)}function qs(t){if(!Ct)return;const e=document.getElementById("reports-timeline-chart");if(!e)return;const n=new Map,r=new Intl.DateTimeFormat(Xs(),{month:"short",year:"numeric"});t.forEach(d=>{if(!d.start||Number.isNaN(d.start.getTime()))return;const l=`${d.start.getFullYear()}-${d.start.getMonth()+1}`,p=n.get(l)||{total:0,label:r.format(d.start)};p.total+=d.overallTotal,n.set(l,p)});const s=Array.from(n.keys()).sort((d,l)=>{const[p,m]=d.split("-").map(Number),[h,y]=l.split("-").map(Number);return p===h?m-y:p-h}).slice(-12),c=s.map(d=>n.get(d)?.label||d),i=s.map(d=>Math.round(n.get(d)?.total||0)),a=i.length?[{name:O("projects.reports.datasets.value","Total value"),data:i}]:[],u={chart:{type:"area",height:320,toolbar:{show:!1}},series:a,xaxis:{categories:c,labels:{rotate:-35}},yaxis:{labels:{formatter:d=>Jt(d)}},dataLabels:{enabled:!1},stroke:{curve:"smooth",width:3},fill:{type:"gradient",gradient:{shadeIntensity:.35,opacityFrom:.5,opacityTo:.05}},markers:{size:4},colors:["#4c6ef5"],tooltip:{y:{formatter:d=>Jt(d)}},noData:{text:O("projects.reports.noData","لا توجد بيانات متاحة")}};Xe("timeline",e,u)}function js(t){if(!Ct)return;const e=document.getElementById("reports-expense-chart");if(!e)return;const n=[...t].sort((u,d)=>d.overallTotal-u.overallTotal).slice(0,6),r=n.map(u=>u.title||u.projectCode),o=n.map(u=>Math.round(u.overallTotal)),s=n.map(u=>Math.round(u.expensesTotal)),c=r.length?[{name:O("projects.reports.datasets.value","Total value"),data:o},{name:O("projects.reports.datasets.expenses","تكلفة الخدمات الإنتاجية"),data:s}]:[],a={chart:{type:"bar",height:Math.max(320,r.length*60||0),toolbar:{show:!1}},series:c,plotOptions:{bar:{horizontal:!0,barHeight:"55%",borderRadius:8}},xaxis:{categories:r,labels:{formatter:u=>Jt(u)}},dataLabels:{enabled:!1},legend:{position:"bottom",fontSize:"13px"},colors:["#4c6ef5","#f472b6"],tooltip:{y:{formatter:u=>Jt(u)}},noData:{text:O("projects.reports.noData","لا توجد بيانات متاحة")}};Xe("expenses",e,a)}function Fs(t){if(!Ct)return;const e=document.getElementById("reports-clients-chart");if(!e)return;const n=new Map;t.forEach(a=>{const u=a.clientName||a.clientCompany||O("projects.fallback.unknownClient","Unknown client"),d=n.get(u)||0;n.set(u,d+a.overallTotal)});const r=Array.from(n.entries()).sort((a,u)=>u[1]-a[1]).slice(0,6),o=r.map(([a])=>a),s=r.map(([,a])=>Math.round(a)),c=s.length?[{name:O("projects.reports.datasets.value","Total value"),data:s}]:[],i={chart:{type:"bar",height:320,toolbar:{show:!1}},series:c,plotOptions:{bar:{borderRadius:6,columnWidth:"60%"}},xaxis:{categories:o,labels:{rotate:-35}},yaxis:{labels:{formatter:a=>Jt(a)}},dataLabels:{enabled:!1},colors:["#3b82f6"],tooltip:{y:{formatter:a=>Jt(a)}},legend:{show:!1},noData:{text:O("projects.reports.noData","لا توجد بيانات متاحة")}};Xe("clients",e,i)}function Xe(t,e,n={}){if(!Ct||!e)return;if(Ne[t]){try{Ne[t].destroy()}catch(o){console.warn(`⚠️ [projectsReports] Failed to destroy ${t} chart`,o)}delete Ne[t]}e.innerHTML="";const r={...n};Array.isArray(r.series)||(r.series=[]);try{const o=new Ct(e,r);Ne[t]=o,o.render().catch(s=>{console.error(`❌ [projectsReports] Failed to render ${t} chart`,s)})}catch(o){console.error(`❌ [projectsReports] Failed to render ${t} chart`,o)}}function $s(){!S.exportExcelBtn||S.exportExcelBtn.dataset.bound==="true"||(S.exportExcelBtn.addEventListener("click",async()=>{try{const t=ha();await Os(t)}catch(t){console.error("❌ [projectsReports] Failed to export Excel",t);try{alert("تعذر تصدير البيانات.")}catch{}}}),S.exportExcelBtn.dataset.bound="true")}async function Os(t){if(!Array.isArray(t)||t.length===0){try{alert("لا توجد بيانات لتصديرها.")}catch{}return}let e=null;try{e=await _n()}catch{e=null}if(e||(e=await Qa()),!e){try{alert("مكتبة Excel غير متوفرة.")}catch{}return}const n=["كود المشروع","المشروع","العميل","الحالة","الفترة","القيمة (مع الضريبة)","تقدير المعدات","إيرادات الخدمات","تكلفة الخدمات","صافي الحجوزات (بدون ضريبة)","صافي الربح","هامش الربح %","حالة الدفع","المبالغ المدفوعة","نسبة الدفع %","عدد الدفعات"],r=t.map(h=>{const y=We(h.id),g=(Array.isArray(y)?y:[]).reduce((X,A)=>{const k=Array.isArray(A.items)?A.items:[],H=Array.isArray(A.crewAssignments)?A.crewAssignments:[],F=H.length?H:Array.isArray(A.technicians)?A.technicians:[],Y=Array.isArray(F)&&F.length&&typeof F[0]=="object",G=Array.isArray(F)&&F.length&&typeof F[0]!="object",K=ve({items:k,technicianIds:G?F:[],crewAssignments:Y?F:[],discount:A.discount??0,discountType:A.discountType||"percent",applyTax:!1,start:A.start,end:A.end});return X.equipment+=Number(K.equipmentTotal||0),X.crew+=Number(K.crewTotal||0),X.crewCost+=Number(K.crewCostTotal||0),X},{equipment:0,crew:0,crewCost:0}),E=Ve(h),I=Number(Se(h)||0),x=g.equipment+g.crew+E,C=Number(h?.raw?.discount??h?.discount??0)||0;let v=((h?.raw?.discount_type??h?.discountType)==="amount"?"amount":"percent")==="amount"?C:x*(C/100);(!Number.isFinite(v)||v<0)&&(v=0),v>x&&(v=x);const T=Math.max(0,x-v),P=T,L=Math.max(0,g.equipment+g.crew-v),_=Number((T-I-(g.crewCost||0)).toFixed(2)),R=P>0?_/P*100:0,D=wa(h.start,h.end),N=O(`projects.status.${h.status}`,h.status),b=O(`projects.paymentStatus.${h.paymentStatus}`,h.paymentStatus),M=h.clientCompany?`${h.clientName} (${h.clientCompany})`:h.clientName||"",q=Number(h.raw?.paidAmount??h.paidAmount??0)||0,B=Number(h.raw?.paidPercent??h.paidPercent??0)||0,j=Array.isArray(h.raw?.paymentHistory)?h.raw.paymentHistory.length:0;return[String(h.projectCode||h.id||""),String(h.title||h.projectCode||""),String(M),N,D,Math.round(h.overallTotal||0),Math.round(Number(h?.raw?.equipmentEstimate??h?.equipmentEstimate??0)||0),Math.round(E||0),Math.round(I||0),Math.round(L||0),Math.round(_||0),Number(R.toFixed(1)),b,Math.round(q||0),Number((B||0).toFixed(1)),j]}),o={font:{bold:!0,color:{rgb:"FFFFFF"}},fill:{patternType:"solid",fgColor:{rgb:"2563EB"}},alignment:{horizontal:"center",vertical:"center"}},s={z:"#,##0",alignment:{horizontal:"right"}},c={z:"#,##0.0",alignment:{horizontal:"right"}},i=[n.map(h=>({v:h,t:"s",s:o}))];r.forEach(h=>{const y=[];y.push({v:h[0]}),y.push({v:h[1]}),y.push({v:h[2]}),y.push({v:h[3]}),y.push({v:h[4]}),y.push({v:h[5],t:"n",s}),y.push({v:h[6],t:"n",s}),y.push({v:h[7],t:"n",s}),y.push({v:h[8],t:"n",s}),y.push({v:h[9],t:"n",s}),y.push({v:h[10],t:"n",s}),y.push({v:h[11],t:"n",s:c}),y.push({v:h[12]}),y.push({v:h[13],t:"n",s}),y.push({v:h[14],t:"n",s:c}),y.push({v:h[15],t:"n",s}),i.push(y)});const a=e.utils.aoa_to_sheet(i);a["!cols"]=[8,24,18,12,16,16,14,14,14,18,14,12,12,14,12,10].map(h=>({wch:h}));const u=String.fromCharCode(65+n.length-1);a["!autofilter"]={ref:`A1:${u}${i.length}`};const d=e.utils.book_new();e.utils.book_append_sheet(d,a,"Summary");const l=Hs(e,t);e.utils.book_append_sheet(d,l,"Breakdown");const m=new Date().toISOString().slice(0,19).replace(/[:T]/g,"-");e.writeFile(d,`projects-report-${m}.xlsx`)}function Hs(t,e){const n={font:{bold:!0,color:{rgb:"FFFFFF"}},fill:{patternType:"solid",fgColor:{rgb:"1F2937"}},alignment:{horizontal:"center",vertical:"center"}},r={font:{bold:!0,sz:13},alignment:{horizontal:"left",vertical:"center"}},o={z:"#,##0",alignment:{horizontal:"right"}},s={z:"#,##0.0",alignment:{horizontal:"right"}},c={};let i=0;const a=(l,p,m)=>{const h=t.utils.encode_cell({r:i,c:l}),y=typeof p=="number"?"n":"s";c[h]={v:p,t:y,s:m||{}},u()},u=()=>{const l=c["!ref"],p=t.utils.encode_cell({r:i,c:5});c["!ref"]=l?l.replace(/:[A-Z]+\d+$/,`:${p}`):`A1:${p}`},d=(l=1)=>{i+=l};return c["!cols"]=[22,36,16,16,16,16].map(l=>({wch:l})),e.forEach((l,p)=>{a(0,`${l.title||l.projectCode||""} — #${l.projectCode||l.id||""}`,r),d(),["البند","القيمة","البند","القيمة","البند","القيمة"].forEach((_,R)=>a(R,_,n)),d();const h=We(l.id),y=(Array.isArray(h)?h:[]).reduce((_,R)=>{const D=Array.isArray(R.items)?R.items:[],N=Array.isArray(R.crewAssignments)?R.crewAssignments:[],b=N.length?N:Array.isArray(R.technicians)?R.technicians:[],M=Array.isArray(b)&&b.length&&typeof b[0]=="object",q=Array.isArray(b)&&b.length&&typeof b[0]!="object",B=ve({items:D,technicianIds:q?b:[],crewAssignments:M?b:[],discount:R.discount??0,discountType:R.discountType||"percent",applyTax:!1,start:R.start,end:R.end});return _.equipment+=Number(B.equipmentTotal||0),_.crew+=Number(B.crewTotal||0),_.crewCost+=Number(B.crewCostTotal||0),_},{equipment:0,crew:0,crewCost:0}),g=Ve(l),E=Number(Se(l)||0),I=y.equipment+y.crew+g,x=Number(l?.raw?.discount??l?.discount??0)||0;let f=((l?.raw?.discount_type??l?.discountType)==="amount"?"amount":"percent")==="amount"?x:I*(x/100);(!Number.isFinite(f)||f<0)&&(f=0),f>I&&(f=I);const v=Math.max(0,I-f),T=Number((v-E-(y.crewCost||0)).toFixed(2)),P=v>0?T/v*100:0;[["إيراد المعدات (حجوزات)",y.equipment,"إيراد الطاقم (حجوزات)",y.crew,"إيرادات الخدمات",g],["الخصم",f,"بعد الخصم",v,"تكلفة الطاقم",y.crewCost],["تكلفة الخدمات الإنتاجية",E,"صافي الربح",T,"هامش الربح %",Number(P.toFixed(1))]].forEach(_=>{_.forEach((R,D)=>{const N=D%2===1;a(D,R,N?typeof R=="number"&&(D===5?s:o):{})}),d()}),d()}),c}function zs(t){if(!S.table||!S.tableBody||!S.tableEmpty)return;if(!t.length){S.table.style.display="none",S.tableEmpty.classList.add("active"),S.tableMeta&&(S.tableMeta.textContent="");return}S.table.style.display="",S.tableEmpty.classList.remove("active");const e=Ws([...t||[]]).map(n=>{const r=gn(n),o=wa(n.start,n.end),s=O(`projects.status.${n.status}`,n.status),c=`<span class="timeline-status-badge timeline-status-badge--${n.status}">${vt(s)}</span>`,i=fa(n),a=i==="paid"?"status-paid":i==="partial"?"status-partial":"status-unpaid",u=i==="paid"?O("reservations.list.payment.paid","💳 مدفوع"):i==="partial"?O("reservations.list.payment.partial","💳 مدفوع جزئياً"):O("reservations.list.payment.unpaid","💳 غير مدفوع"),d=`<span class="reservation-chip ${a}">${vt(u)}</span>`,l=vt(n.clientName||O("projects.fallback.unknownClient","Unknown client")),p=`
      <tr>
        <td>
          <div class="d-flex flex-column gap-1">
            <span class="fw-semibold">${vt(n.title||n.projectCode)}</span>
            <small class="text-muted">${vt(`#${n.projectCode}`)}</small>
          </div>
        </td>
        <td>${l}</td>
        <td>${c}</td>
        <td>${vt(o)}</td>
        <td>${vt(bt(n.overallTotal))}</td>
        <td>${vt(va(r.marginPercent))}</td>
        <td>${d}</td>
      </tr>
    `;if(!U.__debug)return p;const m=[];m.push(`resFinal=${Math.round(r.resFinal)}`),m.push(`resTax=${Math.round(r.resTax)}`),m.push(`resNet=${Math.round(r.resNetRevenue)}`),m.push(`equipEst=${Math.round(r.equipmentEstimate)}`),m.push(`services=${Math.round(r.servicesRevenue)}`),m.push(`expenses=${Math.round(r.projectExpenses)}`),m.push(`netProfit=${Math.round(r.netProfit)}`),m.push(`margin=${Number((r.marginPercent||0).toFixed(1))}%`);const y=(n?.raw?.companyShareEnabled===!0||String(n?.raw?.companyShareEnabled).toLowerCase()==="true")&&Number(n?.raw?.companySharePercent)||0,g=Number(n?.raw?.discount??0)||0,E=n?.raw?.discountType==="amount"?"amount":"percent";m.push(`share%=${y}`),m.push(`disc=${g}${E==="amount"?"":"%"}`),m.push(`applyTax=${n.applyTax?"Y":"N"} taxRate=${Number((ce*100).toFixed(2))}%`);const I=`
      <tr class="reports-debug-row">
        <td colspan="7">
          <code class="reports-debug-code">${vt(m.join("  |  "))}</code>
        </td>
      </tr>
    `;return`${p}${I}`}).join("");if(S.tableBody.innerHTML=e,S.tableMeta){const n=O("projects.reports.table.meta","Showing {count} of {total} projects");S.tableMeta.textContent=n.replace("{count}",wn(t.length)).replace("{total}",wn(U.totalProjects))}}function Us(){!S.tableHead||S.tableHead.dataset.sortAttached==="true"||(S.tableHead.addEventListener("click",t=>{const e=t.target.closest("[data-sort-key]");if(!e)return;const n=e.getAttribute("data-sort-key");n&&(Tt.key===n?Tt.dir=Tt.dir==="asc"?"desc":"asc":(Tt.key=n,Tt.dir=n==="project"||n==="client"||n==="status"?"asc":"desc"),dt())}),S.tableHead.dataset.sortAttached="true")}function Ws(t){const e=Tt.dir==="asc"?1:-1,n=Tt.key,r=(o,s)=>{switch(n){case"project":{const c=String(o.title||o.projectCode||"").toLowerCase(),i=String(s.title||s.projectCode||"").toLowerCase();return c.localeCompare(i,"ar")}case"client":{const c=String(o.clientName||"").toLowerCase(),i=String(s.clientName||"").toLowerCase();return c.localeCompare(i,"ar")}case"status":{const c=String(o.status||""),i=String(s.status||"");return c.localeCompare(i,"ar")}case"period":{const c=o.start?new Date(o.start).getTime():0,i=s.start?new Date(s.start).getTime():0;return c-i}case"value":return(o.overallTotal||0)-(s.overallTotal||0);case"margin":{const c=gn(o).marginPercent||0,i=gn(s).marginPercent||0;return c-i}case"payment":{const c=i=>i==="paid"?2:i==="partial"?1:0;return c(o.paymentStatus)-c(s.paymentStatus)}default:return(o.overallTotal||0)-(s.overallTotal||0)}};return t.sort((o,s)=>e*r(o,s))}function Vs(){if(!S.tableHead)return;S.tableHead.querySelectorAll("th.sortable").forEach(e=>{e.classList.remove("is-sorted"),e.removeAttribute("data-dir");const n=e.getAttribute("data-sort-key");n&&e.setAttribute("title",Sr(n,null))});const t=S.tableHead.querySelector(`th.sortable[data-sort-key="${Tt.key}"]`);t&&(t.classList.add("is-sorted"),t.setAttribute("data-dir",Tt.dir),t.setAttribute("title",Sr(Tt.key,Tt.dir)))}function Sr(t,e){const r=O({project:"projects.reports.table.columns.project",client:"projects.reports.table.columns.client",status:"projects.reports.table.columns.status",period:"projects.reports.table.columns.period",value:"projects.reports.table.columns.value",margin:"projects.reports.table.columns.margin",payment:"projects.reports.table.columns.payment"}[t]||"",t);if(!e)return`${r} — ${O("projects.reports.table.sortable","قابل للفرز")}`;const o=e==="asc"?O("projects.reports.table.sort.asc","ترتيب تصاعدي"):O("projects.reports.table.sort.desc","ترتيب تنازلي");return`${r} — ${o}`}function Ar(t){if(!t)return"—";const e=t instanceof Date?t:new Date(t);if(Number.isNaN(e.getTime()))return"—";const r=wt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",o=new Intl.DateTimeFormat(r,{day:"2-digit",month:"2-digit",year:"numeric"});return Qt(o.format(e))}function wa(t,e){if(!t&&!e)return"—";const n=t?Ar(t):"—",r=e?Ar(e):"—";return e?`${n} → ${r}`:n}function bt(t){const e=Number(t)||0,r=wt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",o=new Intl.NumberFormat(r,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e));return`${Qt(o)} SR`}function wn(t){const n=wt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return Qt(new Intl.NumberFormat(n).format(t))}function va(t){const n=wt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US",r=Number.isFinite(t)?t:0,o=new Intl.NumberFormat(n,{minimumFractionDigits:1,maximumFractionDigits:1}).format(r);return`${Qt(o)}%`}function Jt(t){const n=wt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US";return Qt(new Intl.NumberFormat(n,{notation:"compact",compactDisplay:"short"}).format(t))}function Xs(){return wt()==="ar"?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function vt(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}export{dn as a,_o as e,uc as p};
