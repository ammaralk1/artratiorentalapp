import{d as ue,n as I,t as u,j as h,b as Je,z as Za,y as en,v as es,w as ts,u as ns}from"./auth.DjG6Y4HV.js";import{g as Xe,r as yt,f as gn,a as as,b as st,i as Wn,c as ss}from"./details.CC3-xaok.js";import{k as yn,l as Pn,n as Ne,s as Ln,o as dt,b as tn,p as Te,D as rt,q as lt,h as Jn,c as Tt,e as jt,t as Oe,v as xe,w as Qn,x as rs,y as Yn,z as is,A as os,B as Xn,a as At,d as cs,C as nn,E as Zn,F as ea,G as an,H as Bt,g as ta,I as ds,J as ls,K as us,u as ms,r as ps,L as fs,j as gs}from"./reservationsService.BZvERlIP.js";import{o as vn,p as na,q as ys,u as it,v as _t,w as Pe,n as U,x as aa,y as hn,l as Ge,z as Ut,A as Dt,B as vs,C as sa,D as ra,E as ia,F as ke,s as kt,G as oa,b as bn,H as hs,I as bs,J as Is,K as ca,L as Es,M as Ss,k as da,N as qn}from"./state.Cq48_FNn.js";import{d as In,E as la,a as ks,c as ws,e as As,r as Bs,s as _s}from"./uiBridge.DK92HFPJ.js";import{g as Cs,a as Ps,b as Ls}from"./reservationPdf.QZSemqwN.js";import{o as qs}from"./view.CsxfVLq5.js";import{c as ua,r as ma,d as $s,a as Ns}from"./reservationsActions.C2xcRpW4.js";import{ensureProjectsLoaded as xs}from"./projectsService.cEP3699U.js";const Rs="__DEBUG_CREW__";function Ts(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const n=window.localStorage?.getItem(Rs);if(n&&["1","true","on","yes"].includes(String(n).toLowerCase()))return!0}}catch{}return!1}function $n(e,n){if(Ts())try{console.log(`ğŸªµ [crew-debug:create] ${e}`,n)}catch{}}const pa="projects:create:draft",fa="projects.html#projects-section";let sn=null,ga=[],rn=new Map,on=new Map,Ft=new Map,Yt=!1,$t=null,Nn=!1,ya=[];const Qe="reservations:create:draft";let pt=!1;function Gt(){try{if(typeof window<"u"&&window.sessionStorage)return window.sessionStorage}catch{}try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return null}function En(){try{if(typeof window<"u"&&window.localStorage)return window.localStorage}catch{}return null}function js(){if(typeof document>"u"||!Gt())return null;try{const{input:n,hidden:t}=gt(),{input:a,hidden:r}=Ke(),s=document.getElementById("res-start")?.value||"",i=document.getElementById("res-end")?.value||"",o=document.getElementById("res-start-time")?.value||"",d=document.getElementById("res-end-time")?.value||"",l=document.getElementById("res-notes")?.value||"",c=document.getElementById("res-discount")?.value||"",p=document.getElementById("res-discount-type")?.value||"percent",g=!!document.getElementById("res-tax")?.checked,f=!!document.getElementById("res-company-share")?.checked,v=f?ct("res-company-share"):null,b=document.getElementById("res-payment-status")?.value||"unpaid",C=document.getElementById("res-payment-progress-type")?.value||"percent",E=document.getElementById("res-payment-progress-value")?.value||"";return{startDate:s,endDate:i,startTime:o,endTime:d,customerId:t?.value||"",customerLabel:n?.value||"",projectId:r?.value||"",projectLabel:a?.value||"",notes:l,discount:String(c||""),discountType:p,taxEnabled:g,companyShareEnabled:f,companySharePercent:v,paymentStatus:b,paymentProgressType:C,paymentProgressValue:String(E||""),items:Pe()||[],technicianIds:os()||[],crewAssignments:yn()||[]}}catch{return null}}function Ye(){if(pt)return;const e=Gt(),n=En();if(!e&&!n)return;const t=js();if(t){try{const r=(()=>{const i=e?e.getItem(Qe):null,o=!i&&n?n.getItem(Qe):null,d=i||o;return d?JSON.parse(d):null})(),s=i=>{if(!i)return!1;const o=Array.isArray(i.items)&&i.items.length>0,d=Array.isArray(i.technicianIds)&&i.technicianIds.length>0,l=!!(i.startDate||i.endDate||i.startTime||i.endTime),c=!!(i.customerId||i.customerLabel);return o||d||l||c};if(s(r)&&!s(t))return}catch{}try{const a=JSON.stringify(t);e&&e.setItem(Qe,a),n&&n!==e&&n.setItem(Qe,a)}catch(a){console.warn("âš ï¸ [reservations/createForm] Unable to persist create draft",a)}}}function va(){const e=Gt(),n=En();if(!(!e&&!n))try{e&&e.removeItem(Qe),n&&n!==e&&n.removeItem(Qe)}catch(t){console.warn("âš ï¸ [reservations/createForm] Unable to clear create draft",t)}}function Ds(){const e=Gt(),n=En();if(!e&&!n)return;pt=!0;let t=null;try{const a=e?e.getItem(Qe):null,r=!a&&n?n.getItem(Qe):null,s=a||r;t=s?JSON.parse(s):null}catch(a){console.warn("âš ï¸ [reservations/createForm] Unable to read create draft",a),pt=!1;return}if(t)try{if(t.startDate||t.startTime){const i=it(t.startDate||"",t.startTime||"");et("res-start","res-start-time",i)}if(t.endDate||t.endTime){const i=it(t.endDate||"",t.endTime||"");et("res-end","res-end-time",i)}if(t.customerId){Re({selectedValue:String(t.customerId)});const{input:i,hidden:o}=gt();i&&(i.dataset.selectedId=String(t.customerId))}else if(t.customerLabel){Re({selectedValue:"",resetInput:!0});const{input:i,hidden:o}=gt();i&&(i.value=t.customerLabel),o&&(o.value="");try{const d=Vt(t.customerLabel,{allowPartial:!0});d&&(o.value=String(d.id),i.value=d.label,i.dataset.selectedId=String(d.id))}catch{}}if(t.projectId)Ze({selectedValue:String(t.projectId)});else if(t.projectLabel){Ze({selectedValue:"",resetInput:!0});const{input:i,hidden:o}=Ke();i&&(i.value=t.projectLabel),o&&(o.value="")}document.getElementById("res-notes")&&(document.getElementById("res-notes").value=t.notes||""),document.getElementById("res-discount")&&(document.getElementById("res-discount").value=t.discount||""),document.getElementById("res-discount-type")&&(document.getElementById("res-discount-type").value=t.discountType||"percent");const a=document.getElementById("res-tax");a&&(a.checked=!!t.taxEnabled);const r=document.getElementById("res-company-share");r&&(r.checked=!!t.companyShareEnabled,t.companySharePercent!=null&&(r.dataset.companyShare=String(t.companySharePercent)));const s=document.getElementById("res-payment-status");if(s&&(s.value=t.paymentStatus||s.value||"unpaid",Ce(s,s.value)),document.getElementById("res-payment-progress-type")&&(document.getElementById("res-payment-progress-type").value=t.paymentProgressType||"percent"),document.getElementById("res-payment-progress-value")&&(document.getElementById("res-payment-progress-value").value=t.paymentProgressValue||""),Array.isArray(t.items)&&(_t(t.items),be()),Array.isArray(t.crewAssignments)&&t.crewAssignments.length)try{Ln(t.crewAssignments)}catch{}else if(Array.isArray(t.technicianIds)&&t.technicianIds.length)try{Ln(t.technicianIds)}catch{}Ue();try{["res-customer","res-customer-input","res-start","res-end","res-start-time","res-end-time"].map(i=>document.getElementById(i)).filter(Boolean).forEach(i=>{i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}))})}catch{}J()}catch(a){console.warn("âš ï¸ [reservations/createForm] Failed to restore create draft",a)}finally{pt=!1}}function Fs(e){if(!e)return null;let n=ya.find(a=>a.id===e)||null;if(n)return n;const t=hs(e);return t?(n={id:e,name:Is(t)||e,price:bs(t),items:bn(t),raw:t},n):null}function Mt(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function zt(e){return I(String(e||"")).trim().toLowerCase()}function Ms(e={}){const n=String(e?.desc||e?.description||"")?.trim(),t=I(String(e?.barcode||"")).trim();return t?`${n} | ${t}`:n}function ha(e){const n=I(String(e||""));if(!n.trim())return{description:"",barcode:""};const[t,...a]=n.split("|");return{description:t.trim(),barcode:a.join("|").trim()}}function ba(e,n="percent"){const t=e?.value;return t==="amount"||t==="percent"?t:n}function Ia(e){if(!e)return null;const n=I(String(e.value||"")).replace("%","").trim();if(!n)return null;const t=Number.parseFloat(n);return!Number.isFinite(t)||t<0?null:t}function Ea(e,n){if(e){if(n==null||!Number.isFinite(n)||n<=0){e.value="";return}e.value=I(String(n))}}function ot(e){switch(e){case"maintenance":return u("reservations.toast.equipmentMaintenance","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù‚ÙŠØ¯ Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø­Ø§Ù„ÙŠØ§Ù‹");case"reserved":return u("reservations.toast.equipmentReserved","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§");case"retired":return u("reservations.toast.equipmentRetired","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø© Ø­Ø§Ù„ÙŠØ§Ù‹");default:return u("reservations.toast.equipmentUnavailable","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹")}}function gt(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-customer-input"),hidden:document.getElementById("res-customer"),list:document.getElementById("res-customer-options")}}function Ke(){return typeof document>"u"?{input:null,hidden:null,list:null}:{input:document.getElementById("res-project-input"),hidden:document.getElementById("res-project"),list:document.getElementById("res-project-options")}}function $e(){const{input:e,hidden:n}=Ke();return e?.dataset?.pendingLinked==="true"?!0:!!n?.value}function at(e,n){if(!e)return;const t=new Set([e]),a=e.parentElement;if(a&&t.add(a),e.id){const s=document.querySelector(`label[for="${e.id}"]`);s&&t.add(s)}const r=s=>{n()&&h(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error")};t.forEach(s=>{!s||s.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(i=>{s.addEventListener(i,r,{capture:!0})}),s.dataset.linkedGuardAttached="true")})}function Sa(e,n,{allowPartial:t=!1}={}){const a=Ne(n);if(!a)return null;const r=e.get(a);if(r)return r;if(!t)return null;const s=[];return e.forEach((i,o)=>{o.includes(a)&&s.push(i)}),s.length===1?s[0]:null}function Vt(e,n={}){return Sa(rn,e,n)}function cn(e,n={}){return Sa(on,e,n)}function Ce(e,n){if(!e)return;const t=n??e.value;e.classList.remove("payment-status-select--paid","payment-status-select--unpaid","payment-status-select--partial"),t==="paid"?e.classList.add("payment-status-select--paid"):t==="partial"?e.classList.add("payment-status-select--partial"):e.classList.add("payment-status-select--unpaid")}function ka(e){ga=Array.isArray(e)?[...e]:[]}function Sn(){return ga}function kn(e){return e&&Sn().find(n=>String(n.id)===String(e))||null}function xn(e){if(!e)return"";const n=typeof e.title=="string"?e.title.trim():"";return n||u("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")}function ct(e="res-company-share"){const n=document.getElementById(e);if(!n||!n.checked)return null;const t=n.dataset.companyShare??n.value??rt,a=I(String(t).replace("%","").trim()),r=parseFloat(a);return Number.isFinite(r)?r:rt}function je(e="res-company-share"){const n=document.getElementById(e);if(!n)return;let t=n.dataset.companyShare??n.value??rt,a=I(String(t).replace("%","").trim()),r=parseFloat(a);(!Number.isFinite(r)||r<=0)&&(r=rt),n.dataset.companyShare=String(r),n.checked=!0}function dn(e){const n=document.getElementById("res-tax"),t=document.getElementById("res-company-share");if(!n||!t)return;if(Yt){J();return}Yt=!0;const a=()=>{Yt=!1,J()};if(e==="share")if(t.checked){if(t.dataset.companyShare||(t.dataset.companyShare=String(rt)),n.disabled){t.checked=!1,h(u("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),a();return}n.checked||(n.checked=!0),je()}else n.checked&&!n.disabled&&(n.checked=!1);else e==="tax"&&(n.checked?je():t.checked&&(t.checked=!1));a()}function zs(e){if(!e)return!1;if(e.confirmed===!0)return!0;const n=typeof e.status=="string"?e.status.toLowerCase():"";return["confirmed","in_progress","completed"].includes(n)}function Rn(e,n){if(!e)return"";if(e[n])return e[n];if(e[`${n}Datetime`])return e[`${n}Datetime`];if(e[`${n}datetime`])return e[`${n}datetime`];if(e[`${n}_datetime`])return e[`${n}_datetime`];const t=e[`${n}Date`]??e[`${n}_date`],a=e[`${n}Time`]??e[`${n}_time`];if(t){const r=typeof a=="string"&&a.trim()?a.trim():"00:00";return`${t}T${r}`}return""}function Tn(e){if(!e)return"";const n=e.customerName??e.full_name??e.fullName??e.name??e.customer_name??"";return typeof n=="string"?n.trim():String(n||"").trim()}function Re({selectedValue:e="",resetInput:n=!1}={}){const{input:t,hidden:a,list:r}=gt();if(!t||!a||!r)return;const s=vn()||[],i=u("reservations.create.placeholders.client","Ø§Ø®ØªØ± Ø¹Ù…ÙŠÙ„Ù‹Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),o=u("customers.fallback.unnamed","Ø¹Ù…ÙŠÙ„ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");t.setAttribute("placeholder",i);const d=new Set;rn=new Map;const l=s.filter(m=>m&&m.id!=null).map(m=>({id:String(m.id),label:Tn(m)||o})).filter(m=>{if(!m.label)return!1;const f=Ne(m.label);return!f||d.has(f)?!1:(d.add(f),rn.set(f,m),!0)}).sort((m,f)=>m.label.localeCompare(f.label,void 0,{sensitivity:"base"}));r.innerHTML=l.map(m=>`<option value="${Mt(m.label)}"></option>`).join("");const c=n?"":t.value,p=e?String(e):a.value?String(a.value):"",g=p?s.find(m=>String(m.id)===p):null;if(g){const m=Tn(g)||o;a.value=String(g.id),t.value=m,t.dataset.selectedId=String(g.id)}else a.value="",t.dataset.selectedId="",t.value=n?"":c}function Ze({selectedValue:e="",projectsList:n=null,resetInput:t=!1}={}){const{input:a,hidden:r,list:s}=Ke();if(!a||!r||!s)return;const i=Array.isArray(n)?n:Sn()||[],o=u("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)");a.setAttribute("placeholder",o);const d=[...i].filter(v=>v&&v.id!=null).sort((v,b)=>String(b.createdAt||b.start||"").localeCompare(String(v.createdAt||v.start||""))),l=t?"":a.value,c=u("projects.fallback.untitled","Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),p=new Set;on=new Map;const g=d.map(v=>{const b=xn(v)||c;return{id:String(v.id),label:b}}).filter(v=>{if(!v.label)return!1;const b=Ne(v.label);return!b||p.has(b)?!1:(p.add(b),on.set(b,v),!0)});s.innerHTML=g.map(v=>`<option value="${Mt(v.label)}"></option>`).join("");const m=e?String(e):r.value?String(r.value):"",f=m?d.find(v=>String(v.id)===m):null;if(f){const v=xn(f)||c;r.value=String(f.id),a.value=v,a.dataset.selectedId=String(f.id)}else r.value="",a.dataset.selectedId="",a.value=t?"":l}function et(e,n,t){const{date:a,time:r}=oa(t),s=document.getElementById(e),i=document.getElementById(n);if(s){if(a)if(s._flatpickr){const o=s._flatpickr.config?.dateFormat||"Y-m-d";s._flatpickr.setDate(a,!1,o)}else s.value=a;else s._flatpickr?s._flatpickr.clear():s.value="";s.dispatchEvent(new Event("input",{bubbles:!0})),s.dispatchEvent(new Event("change",{bubbles:!0}))}if(i){if(r)if(i._flatpickr){const o=i._flatpickr.config?.dateFormat||"H:i";i._flatpickr.setDate(r,!1,o)}else i.value=r;else i._flatpickr?i._flatpickr.clear():i.value="";i.dispatchEvent(new Event("input",{bubbles:!0})),i.dispatchEvent(new Event("change",{bubbles:!0}))}}function wa(e,{forceNotes:n=!1,skipProjectSelectUpdate:t=!1}={}){if(!e)return;const a=e?.id!=null?String(e.id):"";t||Ze({selectedValue:a});const s=(vn()||[]).find(c=>String(c.id)===String(e.clientId)),i=s?.id!=null?String(s.id):"";Re(i?{selectedValue:i}:{selectedValue:"",resetInput:!0});const o=Rn(e,"start"),d=Rn(e,"end");o&&et("res-start","res-start-time",o),d&&et("res-end","res-end-time",d);const l=document.getElementById("res-notes");l&&e.description&&(n||!l.value)&&(l.value=e.description),J(),Ue()}function Aa({projectsList:e=null,preselectId:n=null}={}){const t=document.getElementById("res-project");if(!t)return;const{projects:a}=e?{projects:e}:ue(),r=Array.isArray(a)?a:[];ka(r);const s=n!=null?String(n):t.value?String(t.value):"";Ze({selectedValue:s,projectsList:r}),Ue(),J()}function Ue(){const{input:e,hidden:n}=Ke(),t=document.getElementById("res-tax"),a=document.getElementById("res-company-share"),r=document.getElementById("res-payment-status"),s=document.getElementById("res-payment-progress-type"),i=document.getElementById("res-payment-progress-value"),o=document.getElementById("res-discount"),d=document.getElementById("res-discount-type"),l=u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),p=e?.dataset?.pendingLinked==="true"||!!n?.value;if(t&&(at(t,$e),a&&at(a,$e)),r&&at(r,$e),s&&at(s,$e),i&&at(i,$e),o&&at(o,$e),d&&at(d,$e),p)t&&(t.checked=!1,t.disabled=!0,t.classList.add("disabled","reservation-input-disabled"),t.title=l),a&&(a.checked=!1,a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=l),r&&(r.value="unpaid",Ce(r,"unpaid"),r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=l),s&&(s.value=s.value||"percent",s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=l),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=l),o&&(o.value="0",o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=l),d&&(d.value="percent",d.disabled=!0,d.classList.add("reservation-input-disabled"),d.title=l);else{if(t){const g=t.disabled;t.disabled=!1,t.classList.remove("disabled","reservation-input-disabled"),t.title="",g&&(t.checked=!1)}a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),d&&(d.disabled=!1,d.classList.remove("reservation-input-disabled"),d.title="")}dn("tax"),J()}function wn(){const{input:e,hidden:n}=Ke();if(!e||!n||e.dataset.listenerAttached)return;const t=(a=!1)=>{const r=e.value.trim(),s=r?cn(r,{allowPartial:a}):null;if(s){n.value=String(s.id),e.value=s.label,e.dataset.selectedId=String(s.id);const i=kn(s.id);i?wa(i,{skipProjectSelectUpdate:!0}):(Ue(),J())}else n.value="",e.dataset.selectedId="",Ue(),J()};e.addEventListener("input",()=>{const a=e.value.trim(),r=a?cn(a):null;r?(n.value=String(r.id),e.dataset.selectedId=String(r.id)):a||(n.value="",e.dataset.selectedId="");try{Ye()}catch{}}),e.addEventListener("change",()=>t(!0)),e.addEventListener("blur",()=>t(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),t(!0))}),e.dataset.listenerAttached="true"}function An(){const{input:e,hidden:n}=gt();if(!e||!n||e.dataset.listenerAttached)return;const t=(a=!1)=>{const r=e.value.trim(),s=r?Vt(r,{allowPartial:a}):null;s?(n.value=String(s.id),e.value=s.label,e.dataset.selectedId=String(s.id)):(n.value="",e.dataset.selectedId=""),J()};e.addEventListener("input",()=>{const a=e.value.trim(),r=a?Vt(a):null;r?(n.value=String(r.id),e.dataset.selectedId=String(r.id)):a||(n.value="",e.dataset.selectedId="");try{Ye()}catch{}}),e.addEventListener("change",()=>t(!0)),e.addEventListener("blur",()=>t(!0)),e.addEventListener("keydown",a=>{a.key==="Enter"&&(a.preventDefault(),t(!0))}),e.dataset.listenerAttached="true"}function Vs(){const e=new URLSearchParams(window.location.search),n=e.get("reservationProjectContext");if(!n){It({clearValue:!0});return}let t=null;try{const l=decodeURIComponent(n);t=JSON.parse(l)}catch(l){console.warn("âš ï¸ [reservations/createForm] Failed to decode project context",l)}e.delete("reservationProjectContext");const a=e.toString(),r=`${window.location.pathname}${a?`?${a}`:""}${window.location.hash||""}`;if(window.history.replaceState({},document.title,r),It({clearValue:!1}),!t)return;t.fromProjectForm&&($t={draftStorageKey:t.draftStorageKey||pa,returnUrl:t.returnUrl||fa});const s=document.getElementById("res-project");if(t.projectId){s&&(Ze({selectedValue:String(t.projectId)}),Ue());const l=kn(t.projectId);l?wa(l,{forceNotes:!!t.forceNotes}):J(),It()}else{s&&Ze({selectedValue:""});const l=t.projectTitle?t.projectTitle:u("reservations.create.project.pendingPlaceholder","Ø³ÙŠØªÙ… Ø§Ù„Ø±Ø¨Ø· Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ");ir(u("reservations.create.project.pendingTooltip","Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯ Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„ÙŠ"),l)}t.start&&et("res-start","res-start-time",t.start),t.end&&et("res-end","res-end-time",t.end);const i=document.getElementById("res-customer-input"),o=document.getElementById("res-customer");if(t.customerId){const c=(vn()||[]).find(p=>String(p.id)===String(t.customerId));c?.id!=null&&(Re({selectedValue:String(c.id)}),o&&(o.value=String(c.id)),i&&(i.value=c.customerName||c.name||i.value))}else t.customerName&&i?(Re({selectedValue:""}),i.value=t.customerName,i.dataset.selectedId="",o&&(o.value="")):Re({selectedValue:""});const d=document.getElementById("res-notes");d&&t.description&&!d.value&&(d.value=t.description),J()}function nt(){const e=document.getElementById("res-start")?.value?.trim(),n=document.getElementById("res-end")?.value?.trim(),t=document.getElementById("res-start-time")?.value?.trim()||"00:00",a=document.getElementById("res-end-time")?.value?.trim()||"00:00";return!e||!n?{start:null,end:null}:{start:it(e,t),end:it(n,a)}}function Ba(e){const n=zt(e);if(n){const o=Ft.get(n);if(o)return o}const{description:t,barcode:a}=ha(e);if(a){const o=gn(a);if(o)return o}const r=Ne(t||e);if(!r)return null;let s=aa();if(!s?.length){const o=ue();s=Array.isArray(o?.equipment)?o.equipment:[],s.length&&ca(s)}const i=s.find(o=>Ne(o?.desc||o?.description||"")===r);return i||s.find(o=>Ne(o?.desc||o?.description||"").includes(r))||null}function _a(e,n="equipment-description-options"){const t=zt(e);if(!t)return!1;const a=document.getElementById(n);if(a&&a.options&&Array.from(a.options).some(d=>zt(d.value)===t)||Ft.has(t))return!0;const{description:r}=ha(e);if(!r)return!1;const s=Ne(r);return s?(aa()||[]).some(o=>Ne(o?.desc||o?.description||"")===s):!1}const Hs={available:0,reserved:1,maintenance:2,retired:3};function Os(e){return Hs[e]??5}function jn(e){switch(e){case"available":return u("reservations.equipment.status.available","Ù…ØªØ§Ø­");case"reserved":return u("reservations.equipment.status.reserved","Ù…Ø­Ø¬ÙˆØ²");case"maintenance":return u("reservations.equipment.status.maintenance","ØµÙŠØ§Ù†Ø©");case"retired":return u("reservations.equipment.status.retired","Ø®Ø§Ø±Ø¬ Ø§Ù„Ø®Ø¯Ù…Ø©");default:return u("reservations.equipment.status.unknown","Ø§Ù„Ø­Ø§Ù„Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©")}}function Us(e){const n=e.value;if(e.bestStatus==="available"&&e.statuses.size===1)return n;const t=e.bestStatus!=="available"?e.bestStatus:[...e.statuses].find(r=>r!=="available")||e.bestStatus;if(t==="available")return`${n} â€” ${jn(t)}`;const a=u("reservations.equipment.status.unavailable","ØºÙŠØ± Ù…ØªØ§Ø­");return`${n} â€” ${a} (${jn(t)})`}function tt(){const e=document.getElementById("equipment-description-options"),n=document.getElementById("edit-res-equipment-description-options"),t=In(),a=ue(),r=Array.isArray(t)&&t.length?t:a?.equipment||[],s=Array.isArray(r)?r:[];ca(s);const i=new Map;s.forEach(l=>{const c=Ms(l),p=zt(c);if(!p||!c)return;const g=Xe(l),m=Os(g),f=i.get(p);if(!f){i.set(p,{normalized:p,value:c,bestItem:l,bestStatus:g,bestPriority:m,statuses:new Set([g])});return}f.statuses.add(g),m<f.bestPriority&&(f.bestItem=l,f.bestStatus=g,f.bestPriority=m,f.value=c)}),Ft=new Map;const d=Array.from(i.values()).sort((l,c)=>l.value.localeCompare(c.value,"ar",{sensitivity:"base"})).map(l=>{Ft.set(l.normalized,l.bestItem);const c=Us(l),p=Mt(l.value);if(c===l.value)return`<option value="${p}"></option>`;const g=Mt(c);return`<option value="${p}" label="${g}"></option>`}).join("");e&&(e.innerHTML=d),n&&(n.innerHTML=d)}function Ca(e,n,t={}){const{silent:a=!1}=t,r=U(e);if(!r)return{success:!1,message:null};const{start:s,end:i}=nt();if(!s||!i){const f=u("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");return a||h(f),{success:!1,message:f}}const o=Pe();if(Bn(o).has(r)){const f=u("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²");return a||h(f),{success:!1,message:f}}const l=hn(r,s,i);if(l.length){const f=l.map(b=>b.name).join(", "),v=u("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${f}`);return a||h(v),{success:!1,message:v}}if(Ge(r,s,i)){const f=u("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");if(!a)try{const v=new URLSearchParams({type:"equipment",id:r,start:s,end:i});Je(`/reservations/availability.php?${v.toString()}`).then(b=>{const C=Array.isArray(b?.conflicts)?b.conflicts:[],E=Array.from(new Set(C.map(B=>B?.reservation_code||(B?.reservation_id!=null?`#${B.reservation_id}`:null)).filter(Boolean))),T=E.length?`${f}: ${E.join("ØŒ ")}`:f;h(T)}).catch(()=>h(f))}catch{h(f)}return{success:!1,message:f}}const c=gn(r);if(!c){const f=u("reservations.toast.barcodeNotFound","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");return a||h(f),{success:!1,message:f}}const p=Xe(c);if(p==="maintenance"||p==="retired"){const f=ot(p);return a||h(f),{success:!1,message:f}}const g=lt(c);if(!g){const f=u("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù");return a||h(f),{success:!1,message:f}}Ut({id:g,equipmentId:g,barcode:r,desc:c.desc,qty:1,price:c.price,cost:st(c),image:yt(c)}),n&&(n.value=""),be(),J();const m=u("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­");return a||h(m),{success:!0,message:m,barcode:r}}function ln(e){if(!e)return;const n=e.value.trim();if(!n)return;const t=Ba(n);if(!t){h(u("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const a=as(t.barcode),r=Xe(a||t);if(r==="maintenance"||r==="retired"){h(ot(r));return}const s=U(t.barcode);if(!s){h(u("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const i=lt(t);if(!i){h(u("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const o={id:i,equipmentId:i,barcode:s,desc:t.desc||t.description||t.name||"",qty:1,price:Number.isFinite(Number(t.price))?Number(t.price):0,cost:st(t),image:yt(t)},{start:d,end:l}=nt();if(!d||!l){h(u("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const c=Pe();if(Bn(c).has(s)){h(u("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const g=hn(s,d,l);if(g.length){const m=g.map(f=>f.name).join(", ");h(u("reservations.toast.equipmentBlockedByPackage",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ø¬Ø²Ø¡ Ù…Ù† Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø©: ${m}`));return}if(Ge(s,d,l)){const m=u("reservations.toast.equipmentTimeConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø£Ù†Ù‡Ø§ Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");try{const f=new URLSearchParams({type:"equipment",id:s,start:d,end:l});Je(`/reservations/availability.php?${f.toString()}`).then(v=>{const b=Array.isArray(v?.conflicts)?v.conflicts:[],C=Array.from(new Set(b.map(T=>T?.reservation_code||(T?.reservation_id!=null?`#${T.reservation_id}`:null)).filter(Boolean))),E=C.length?`${m}: ${C.join("ØŒ ")}`:m;h(E)}).catch(()=>h(m))}catch{h(m)}return}Ut(o),be(),J(),h(u("reservations.toast.equipmentAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­")),e.value=""}function Gs(){tt();const e=document.getElementById("equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),ln(e))});const n=()=>{_a(e.value,"equipment-description-options")&&ln(e)};e.addEventListener("focus",()=>{if(tt(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",n),e.addEventListener("change",n),e.dataset.listenerAttached="true"}}function Dn(e,n){if(!e)return;const t=!!n;e.dataset.selectionActive=t?"true":"false",e.setAttribute("aria-pressed",t?"true":"false"),e.classList.toggle("reservation-select-equipment-btn--active",t)}function Bn(e=Pe()){const n=new Set;return e.forEach(t=>{if(!t)return;const a=U(t.barcode??t.normalizedBarcode);a&&n.add(a),Array.isArray(t.packageItems)&&t.packageItems.forEach(r=>{const s=U(r?.normalizedBarcode??r?.barcode);s&&n.add(s)})}),n}function Ks(){const e=document.getElementById("open-equipment-selector");e&&(e.dataset.listenerAttached||(e.addEventListener("click",()=>{const{start:n,end:t}=nt();if(!n||!t){h(u("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}ks({mode:"create",source:"reservation-form",returnTab:"reservations-tab",returnSubTab:"create-tab",start:n,end:t});const a=document.querySelector('[data-tab="equipment-tab"]');a?(a.click(),window.requestAnimationFrame(()=>{setTimeout(()=>{document.getElementById("search-equipment")?.focus()},300)})):h(u("reservations.toast.equipmentTabUnavailable","âš ï¸ ØªØ¹Ø°Ø± ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹"))}),e.dataset.listenerAttached="true"),e.dataset.selectionObserverAttached||(document.addEventListener(la.change,n=>{Dn(e,n?.detail?.active)}),e.dataset.selectionObserverAttached="true"),Dn(e,As()))}function Ws(e){if(!e||!e.detail||!document.getElementById("reservation-form"))return;const n=e.detail,t=n.selection?.mode||n.selection?.source||"";if(t==="package-manager"||t==="equipment-packages")return;const a=Array.isArray(n.barcodes)?n.barcodes:[],r=Number.isInteger(n.quantity)&&n.quantity>0?n.quantity:1,s=a.length?a:n.barcode?[n.barcode]:[];if(!s.length)return;let i=0,o=null;const d=[],l=new Set;s.forEach(p=>{const g=U(p);g&&!l.has(g)&&(l.add(g),d.push(g))});const c=Math.min(r,d.length);for(let p=0;p<c;p+=1){const g=d[p],m=Ca(g,null,{silent:!0});m.success&&(i+=1),m.message&&(o=m.message)}if(i>0){const g=u("reservations.toast.equipmentAddedBulk","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© {count} Ù…Ø¹Ø¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²").replace("{count}",I(String(i)));h(g)}else o&&h(o)}function Pa(){Ks(),!(Nn||typeof document>"u")&&(document.addEventListener(la.requestAdd,Ws),Nn=!0)}function Ct(){if(typeof document>"u")return{modeRadios:[],singleContainer:null,packageContainer:null,packageSelect:null,packageHint:null,packageAddButton:null};const e=Array.from(document.querySelectorAll('input[name="reservation-equipment-mode"]')),n=document.querySelector('[data-equipment-mode="single"]'),t=document.querySelector('[data-equipment-mode="package"]'),a=document.getElementById("reservation-package-select"),r=document.getElementById("reservation-package-hint"),s=document.getElementById("add-reservation-package");return{modeRadios:e,singleContainer:n,packageContainer:t,packageSelect:a,packageHint:r,packageAddButton:s}}function un(e){const n=e==="package"?"package":"single",{singleContainer:t,packageContainer:a,packageSelect:r}=Ct();t&&(t.hidden=n!=="single",t.setAttribute("aria-hidden",n!=="single"?"true":"false")),a&&(a.hidden=n!=="package",a.setAttribute("aria-hidden",n!=="package"?"true":"false"));const s=document.getElementById("equipment-barcode"),i=document.getElementById("equipment-description"),o=n==="package";s&&(s.disabled=o),i&&(i.disabled=o),r&&(r.disabled=n!=="package"||r.options.length===0),Es(n),n==="package"&&Kt()}function Kt(){const{packageSelect:e,packageHint:n}=Ct();if(!e)return;const t=na();ya=t,ys(t.map(o=>o.raw??o));const a=u("reservations.create.summary.currency","SR"),r=`<option value="" disabled selected>${u("reservations.create.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,s=t.map(o=>{const d=Number.isFinite(Number(o.price))?Number(o.price):0,l=I(d.toFixed(2)),c=`${o.name} â€” ${l} ${a}`;return`<option value="${o.id}">${c}</option>`}).join("");e.innerHTML=`${r}${s}`,e.selectedIndex=0;const i=t.length>0;e.disabled=!i,n&&(i?(n.textContent=u("reservations.create.packages.hint","Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ù…Ø¬Ø±Ø¯ Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§."),n.dataset.state="ready"):(n.textContent=u("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),n.dataset.state="empty")),$a()}function Js(e,n){const t=e?.name||u("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©"),a=u("reservations.toast.packageItemsConflict",`âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ${t} Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© ØºÙŠØ± Ù…ØªØ§Ø­Ø©:`),r=n.map(({item:s,blockingPackages:i})=>{const o=s?.desc||I(String(s?.barcode??s?.normalizedBarcode??""))||u("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");if(Array.isArray(i)&&i.length){const d=i.map(l=>l.name).join(", ");return`â€¢ ${o} (${u("reservations.create.packages.blockedByPackage","Ù…Ø­Ø¬ÙˆØ² Ø¶Ù…Ù† Ø§Ù„Ø­Ø²Ù…")}: ${d})`}return`â€¢ ${o} (${u("reservations.create.packages.blockedDirect","Ù…Ø­Ø¬ÙˆØ² ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©")})`});return[a,...r].join(`
`)}function La(e,{existingItems:n=[],start:t,end:a,ignoreReservationId:r=null}={}){const s=ke(e);if(!s)return{success:!1,reason:"invalid",message:u("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")};const i=Fs(s);if(!i)return{success:!1,reason:"not_found",message:u("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©")};if(!t||!a)return{success:!1,reason:"missing_dates",message:u("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª")};if(n.some(m=>m?.type==="package"&&ke(m.packageId)===s))return{success:!1,reason:"duplicate",message:u("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")};if(sa(s,t,a,r)){const m=i.name||s;return{success:!1,reason:"package_conflict",message:u("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${m} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)}}const o=Array.isArray(i.items)&&i.items.length?i.items:bn(i.raw??{}),d=Bn(n),l=[],c=new Set;if(o.forEach(m=>{const f=U(m?.normalizedBarcode??m?.barcode);if(f){if(c.has(f)){l.push({item:m,type:"internal"});return}c.add(f),d.has(f)&&l.push({item:m,type:"external"})}}),l.length){const m=l.map(({item:v})=>v?.desc||v?.description||v?.name||v?.barcode||v?.normalizedBarcode||u("equipment.packages.items.unknown","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…")).map(v=>I(String(v))).join(", ");return{success:!1,reason:"package_duplicate_equipment",message:l.some(v=>v.type==="external")?u("reservations.toast.packageDuplicateEquipmentExternal","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ù„Ø£Ù† Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²: {items}").replace("{items}",m):u("reservations.toast.packageDuplicateEquipmentInternal","âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ù…ÙƒØ±Ø±Ø©: {items}").replace("{items}",m),duplicates:l}}const p=[];return o.forEach(m=>{const f=U(m?.normalizedBarcode??m?.barcode);if(f&&Ge(f,t,a,r)){const v=hn(f,t,a,r);p.push({item:m,blockingPackages:v})}}),p.length?{success:!1,reason:"item_conflict",message:Js(i,p),conflicts:p}:{success:!0,package:{id:`package::${s}`,packageId:s,type:"package",desc:i.name||`Package ${s}`,qty:1,price:Number.isFinite(Number(i.price))?Number(i.price):0,cost:Number.isFinite(Number(i.cost))?Number(i.cost):0,barcode:i.code||i.raw?.package_code||`pkg-${s}`,packageItems:o.map(m=>({equipmentId:m?.equipmentId??null,barcode:m?.barcode??m?.normalizedBarcode??"",normalizedBarcode:U(m?.normalizedBarcode??m?.barcode),desc:m?.desc??"",qty:Number.isFinite(Number(m?.qty))?Number(m.qty):1,price:Number.isFinite(Number(m?.price))?Number(m.price):0,cost:0})),image:o.find(m=>m?.image)?.image??null},packageInfo:i}}function qa(e,{silent:n=!1}={}){const t=ke(e);if(!t)return n||h(u("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{start:a,end:r}=nt(),s=Pe(),i=La(t,{existingItems:s,start:a,end:r});if(!i.success){if(!n){const d={invalid:u("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"),not_found:u("reservations.toast.packageNotFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©"),missing_dates:u("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),duplicate:u("reservations.toast.packageDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø¶Ø§ÙØ© Ø¨Ø§Ù„ÙØ¹Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")}[i.reason]||u("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹");h(i.message||d)}return i}return Ut(i.package),be(),J(),n||h(u("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),{success:!0,package:i.package}}function $a(){const{packageSelect:e}=Ct();!e||e.dataset.autoAddAttached==="true"||(e.addEventListener("change",()=>{const n=e.value;if(!n)return;qa(n)?.success&&(e.options.length>0?e.selectedIndex=0:e.value="")}),e.dataset.autoAddAttached="true")}function Qs(){const{packageAddButton:e,packageSelect:n}=Ct();!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{const t=n?.value||"";if(!t){h(u("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹"));return}qa(t)}),e.dataset.listenerAttached="true")}function Na(){const{modeRadios:e}=Ct();if(!e.length)return;e.forEach(a=>{a.dataset.listenerAttached||(a.addEventListener("change",r=>{r.target.checked&&un(r.target.value)}),a.dataset.listenerAttached="true")}),Qs(),$a();const n=Dt(),t=e.find(a=>a.value===n);t&&(t.checked=!0),un(n)}function Ys(e={}){const n=[e.packageId,e.package_id,e.packageCode,e.package_code,e.packageDisplayCode,e.barcode,e.key];for(const t of n){if(!t)continue;const a=ke(t);if(a)return a;const r=I(String(t)).trim().toLowerCase();if(r)return r}return null}function Xt(e={}){if(!e||typeof e!="object")return null;const n=ke(e.packageId??e.package_id??e.package_code??e.packageCode??e.barcode??e.id??null);if(n)return n;const t=e.package_code??e.packageCode??e.barcode??null;return t?I(String(t)).trim().toLowerCase():null}function be(e="reservation-items"){const n=document.getElementById(e);if(!n)return;const t=Pe(),a=u("reservations.create.equipment.noneAdded","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª Ù…Ø¶Ø§ÙØ©"),r=u("reservations.create.summary.currency","SR"),s=u("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),i=u("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),o=u("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),d=u("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(t.length===0){n.innerHTML=`<tr><td colspan="7" class="text-center">${a}</td></tr>`;return}const l=dt(t);n.innerHTML=l.map(c=>{const p=c.items[0]||{},g=yt(p)||c.image,m=g?`<img src="${g}" alt="${s}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>',f=I(String(c.count)),v=Number.isFinite(Number(c.unitPrice))?Number(c.unitPrice):0,b=(()=>{try{const{start:$,end:R}=nt(),F=tn($,R);return Number.isFinite(F)&&F>0?F:1}catch{return 1}})(),C=I(String(b)),E=v*c.count*b,T=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-price-input"
          data-group-key="${c.key}"
          min="0"
          step="0.01"
          value="${I(String(v))}"
          aria-label="${u("reservations.equipment.table.unitPrice","Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,B=`${I(E.toFixed(2))} ${r}`,N=Number.isFinite(Number(c.unitCost))?Number(c.unitCost):0,y=c.items.some($=>$?.type==="package"),_=c.barcodes.map($=>I(String($||""))).filter(Boolean),z=_.length?`<details class="reservation-item-barcodes">
            <summary>${u("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${_.map($=>`<li>${$}</li>`).join("")}
            </ul>
          </details>`:"";let L="";if(y){const $=new Map;if(c.items.forEach(R=>{Array.isArray(R?.packageItems)&&R.packageItems.forEach(F=>{if(!F)return;const G=U(F.barcode||F.desc||Math.random()),Y=$.get(G);if(Y){Y.qty+=Number.isFinite(Number(F.qty))?Number(F.qty):1;return}$.set(G,{desc:F.desc||F.barcode||u("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:Number.isFinite(Number(F.qty))?Number(F.qty):1,barcode:F.barcode??F.normalizedBarcode??""})})}),$.size){const R=Array.from($.values()).map(F=>{const G=I(String(F.qty)),Y=F.desc||I(String(F.barcode||"")),q=F.barcode?` <span class="reservation-package-items__barcode">(${I(String(F.barcode))})</span>`:"";return`<li>${Y}${q} Ã— ${G}</li>`}).join("");L=`
            <details class="reservation-package-items">
              <summary>${u("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${R}
              </ul>
            </details>
          `}}const se=(()=>{if(!y)return null;for(let $=0;$<t.length;$+=1){const R=t[$];if(!(!R||String(R.type||"").toLowerCase()!=="package")&&Te(R)===c.key)return $}return null})(),V=y?Ys(c):null,X=V?`data-package-identity="${V}"`:"",oe=se!=null&&Number.isInteger(se)?`data-package-index="${se}"`:"",Q=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-cost-input"
          data-group-key="${c.key}"
          ${X}
          ${oe}
          min="0"
          step="0.01"
          value="${I(String(N))}"
          aria-label="${u("reservations.equipment.table.unitCost","ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `;return`
        <tr data-group-key="${c.key}">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-thumb-wrapper">${m}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${c.description||"-"}</div>
                ${y?`${L||""}${z||""}`:z}
              </div>
            </div>
          </td>
          <td>
            <div class="reservation-quantity-control" data-group-key="${c.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-group" data-group-key="${c.key}" aria-label="${o}" ${y?"disabled":""}>âˆ’</button>
              <span class="reservation-qty-value">${f}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-group" data-group-key="${c.key}" aria-label="${i}" ${y?"disabled":""}>+</button>
            </div>
          </td>
          <td><span class="reservation-days-value">${C}</span></td>
          <td>${T}</td>
          <td>${Q}</td>
          <td>${B}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-group" data-group-key="${c.key}" aria-label="${d}">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join("")}function Xs(e){const n=Pe(),a=dt(n).find(s=>s.key===e);if(!a)return;const r=a.itemIndices[a.itemIndices.length-1];r!=null&&(vs(r),be(),J())}function Zs(e){const n=Pe(),t=n.filter(a=>Te(a)!==e);t.length!==n.length&&(_t(t),be(),J())}function er(e,n){const t=xa(n),a=Number.isFinite(t)&&t>=0?Ra(t):0,r=Pe(),i=dt(r).find(d=>d.key===e);if(!i||!Array.isArray(i.itemIndices))return;const o=[...r];i.itemIndices.forEach(d=>{o[d]&&(o[d]={...o[d],price:a,unit_price:a})}),_t(o),be(),J()}function tr(e,n){const t=xa(n),a=Number.isFinite(t)&&t>=0?Ra(t):0,r=Pe(),i=dt(r).find(d=>d.key===e);if(!i||!Array.isArray(i.itemIndices))return;const o=[...r];i.itemIndices.forEach(d=>{if(o[d]){const l={...o[d],cost:a,unit_cost:a,rental_cost:a,purchase_price:a,internal_cost:a,equipment_cost:a};o[d]=l}}),_t(o),be(),J()}function xa(e){const n=I(String(e??"")).replace(/[^0-9.,-]/g,"").replace(/,/g,"."),t=Number.parseFloat(n);return Number.isFinite(t)?t:NaN}function Ra(e){const n=Number(e);return!Number.isFinite(n)||n<0?0:Number(n.toFixed(2))}function nr(e){const n=Pe(),a=dt(n).find(p=>p.key===e);if(!a)return;const{start:r,end:s}=nt();if(!r||!s){h(u("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const i=new Set(n.map(p=>U(p.barcode))),{equipment:o=[]}=ue(),d=(o||[]).find(p=>{const g=U(p?.barcode);return!g||i.has(g)||Te({desc:p?.desc||p?.description||p?.name||"",price:Number(p?.price)||0})!==e||!Wn(p)?!1:!Ge(g,r,s)});if(!d){h(u("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const l=U(d.barcode),c=lt(d);if(!c){h(u("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}Ut({id:c,equipmentId:c,barcode:l,desc:d.desc||d.description||d.name||a.description||"",qty:1,price:Number.isFinite(Number(d.price))?Number(d.price):a.unitPrice,cost:Number.isFinite(Number(d.cost))?Number(d.cost):Number.isFinite(Number(d.unit_cost))?Number(d.unit_cost):Number(a.unitCost)||0,image:yt(d)}),be(),J()}function J(){const e=!!document.getElementById("res-project")?.value,n=document.getElementById("res-discount")?.value||"0",t=e?0:parseFloat(I(n))||0,a=document.getElementById("res-discount-type")?.value||"percent",r=e?"percent":a,s=document.getElementById("res-tax"),i=e?!1:s?.checked||!1,o=document.getElementById("res-payment-status"),d=o?.value||"unpaid",{start:l,end:c}=nt();i&&je();const p=ct(),g=document.getElementById("res-payment-progress-type"),m=document.getElementById("res-payment-progress-value"),f=ba(g),v=Ia(m);yn(),Pn({selectedItems:Pe(),discount:t,discountType:r,applyTax:i,paidStatus:d,paymentProgressType:f,paymentProgressValue:v,start:l,end:c,companySharePercent:p,paymentHistory:[]});const b=Pn.lastResult;b?(Ea(m,b.paymentProgressValue),o&&(o.value=b.paymentStatus,Ce(o,b.paymentStatus))):Ce(o,d);try{Ye()}catch{}}function ar(){const e=document.getElementById("res-discount");e&&!e.dataset.listenerAttached&&(e.addEventListener("input",o=>{o.target.value=I(o.target.value),J()}),e.dataset.listenerAttached="true");const n=document.getElementById("res-discount-type");n&&!n.dataset.listenerAttached&&(n.addEventListener("change",J),n.dataset.listenerAttached="true");const t=document.getElementById("res-tax");t&&!t.dataset.listenerAttached&&(t.addEventListener("change",()=>{if($e()){t.checked=!1,h(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}dn("tax")}),t.dataset.listenerAttached="true");const a=document.getElementById("res-company-share");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{if($e()){a.checked=!1,h(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}dn("share")}),a.dataset.listenerAttached="true");const r=document.getElementById("res-payment-status");r&&!r.dataset.listenerAttached&&(r.addEventListener("change",()=>{if($e()){r.value="unpaid",Ce(r,"unpaid"),h(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}Ce(r),J()}),r.dataset.listenerAttached="true");const s=document.getElementById("res-payment-progress-type");s&&!s.dataset.listenerAttached?(s.dataset.userSelected!=="true"&&(s.value="percent"),s.addEventListener("change",o=>{if($e()){s.value="percent",h(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}s.dataset.userSelected="true",J()}),s.dataset.listenerAttached="true"):s&&s.dataset.userSelected!=="true"&&!s.value&&(s.value="percent");const i=document.getElementById("res-payment-progress-value");i&&!i.dataset.listenerAttached&&(i.addEventListener("input",o=>{if($e()){i.value="",h(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}o.target.value=I(o.target.value),J()}),i.dataset.listenerAttached="true"),J()}function sr(){const e=document.getElementById("res-start-time"),n=document.getElementById("res-end-time");if(!e||!n||e.dataset.timeSyncAttached)return;try{const s=document.getElementById("res-start"),i=document.getElementById("res-end");if(s&&!s.dataset.persistAttached){const o=()=>{try{Ye()}catch{}},d=()=>{try{be(),J()}catch{}};s.addEventListener("input",o),s.addEventListener("change",o),s.addEventListener("input",d),s.addEventListener("change",d),s.dataset.persistAttached="true"}if(i&&!i.dataset.persistAttached){const o=()=>{try{Ye()}catch{}},d=()=>{try{be(),J()}catch{}};i.addEventListener("input",o),i.addEventListener("change",o),i.addEventListener("input",d),i.addEventListener("change",d),i.dataset.persistAttached="true"}}catch{}let t=!1;const a=()=>{const s=e.value?.trim();if(!s){J();return}const i=n.dataset.syncedWithStart;(!n.value?.trim()||i!=="false")&&(t=!0,n.value=s,n.dataset.syncedWithStart="true",n.dataset.syncedValue=s,n.dispatchEvent(new Event("input",{bubbles:!0})),n.dispatchEvent(new Event("change",{bubbles:!0})),t=!1),J();try{be()}catch{}};e.addEventListener("change",a),e.addEventListener("input",a),e.addEventListener("blur",a),n.addEventListener("input",()=>{if(!t){n.value===e.value?(n.dataset.syncedWithStart="true",n.dataset.syncedValue=n.value):n.dataset.syncedWithStart="false";try{Ye()}catch{}try{be(),J()}catch{}}});const r=()=>{try{Ye()}catch{}};e.addEventListener("input",r),e.addEventListener("change",r),n.addEventListener("change",r),n.value?.trim()||a(),e.dataset.timeSyncAttached="true"}async function Fn(){const{input:e,hidden:n}=gt(),{input:t,hidden:a}=Ke(),{customers:r}=ue();let s=n?.value?String(n.value):"";if(!s&&e?.value){const w=Vt(e.value,{allowPartial:!0});w&&(s=String(w.id),n&&(n.value=s),e.value=w.label,e.dataset.selectedId=s)}const i=r.find(w=>String(w.id)===s);if(!i){h(u("reservations.toast.customerNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const o=i.id;let d=a?.value?String(a.value):"";if(!d&&t?.value){const w=cn(t.value,{allowPartial:!0});w&&(d=String(w.id),a&&(a.value=d),t.value=w.label,t.dataset.selectedId=d)}const l=document.getElementById("res-start").value,c=document.getElementById("res-end").value,p=document.getElementById("res-start-time")?.value||"00:00",g=document.getElementById("res-end-time")?.value||"00:00";if(!l||!c){h(u("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const m=`${l}T${p}`,f=`${c}T${g}`,v=new Date(m),b=new Date(f);if(Number.isNaN(v.getTime())||Number.isNaN(b.getTime())||v>=b){h(u("reservations.toast.invalidDateRange","âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ³Ø¨Ù‚ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const C=yn();C.map(w=>w.technicianId).filter(Boolean);const E=Pe();if(E.length===0&&C.length===0){h(u("reservations.toast.noItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"));return}const T=document.getElementById("res-notes")?.value||"",B=parseFloat(I(document.getElementById("res-discount")?.value))||0,N=document.getElementById("res-discount-type")?.value||"percent",y=document.getElementById("res-payment-status"),_=y?.value||"unpaid",z=document.getElementById("res-payment-progress-type"),L=document.getElementById("res-payment-progress-value"),se=ba(z),V=Ia(L),X=d?kn(d):null,oe=zs(X);if(d&&!X){h(u("reservations.toast.projectNotFound","âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø­Ø¯Ø¯. Ø­Ø§ÙˆÙ„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©."));return}for(const w of E){const D=Xe(w.barcode);if(D==="maintenance"||D==="retired"){h(ot(D));return}}const Q=[];for(const w of E){const D=U(w.barcode);if(Ge(D,m,f)){const A=w?.desc||w?.name||w?.barcode||u("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");Q.push({label:I(String(A)),barcode:D})}}if(Q.length){const w=u("reservations.toast.cannotCreateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©");let D=null;try{const M=Array.from(new Set(Q.map(de=>de.barcode).filter(Boolean))),Ee=new Map;await Promise.all(M.map(async de=>{const te=new URLSearchParams({type:"equipment",id:de,start:m,end:f}),pe=await Je(`/reservations/availability.php?${te.toString()}`),Se=Array.isArray(pe?.conflicts)?pe.conflicts:[],_e=Array.from(new Set(Se.map(ge=>ge?.reservation_code||(ge?.reservation_id!=null?`#${ge.reservation_id}`:null)).filter(Boolean)));Ee.set(de,_e)})),D=Q.map(({label:de,barcode:te})=>{const pe=Ee.get(te)||[];return pe.length?`${de} (${pe.join("ØŒ ")})`:de}).join("ØŒ ")}catch{}const A=D||Q.map(M=>M.label).filter(Boolean).map(String).join("ØŒ ");h(`${w}: ${A}`,"warning",6e3);return}const $=[];for(const w of E){if(w?.type!=="package")continue;const D=w.packageId??w.package_id??null;if(D&&sa(D,m,f)){const A=w.desc||w.packageName||u("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");let M=[];try{const Ee=new URLSearchParams({type:"package",id:String(D),start:m,end:f}),de=await Je(`/reservations/availability.php?${Ee.toString()}`),te=Array.isArray(de?.conflicts)?de.conflicts:[];M=Array.from(new Set(te.map(pe=>pe?.reservation_code||(pe?.reservation_id!=null?`#${pe.reservation_id}`:null)).filter(Boolean)))}catch{}$.push({label:I(String(A)),codes:M})}}if($.length){const w=$.map(({label:A,codes:M})=>M&&M.length?`${A} (${M.join("ØŒ ")})`:A).join("ØŒ "),D=u("reservations.toast.packageTimeConflict","âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©");h(`${D}: ${w}`,"warning",6e3);return}const R=[];for(const w of C){if(!w?.technicianId||!ra(w.technicianId,m,f))continue;const D=w?.technicianName||w?.positionLabel||String(w.technicianId);let A=[];try{A=ia(w.technicianId,m,f,null)}catch{}R.push({label:I(String(D)),codes:A})}if(R.length){const w=u("reservations.toast.cannotCreateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø­Ø¬Ø²ØŒ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù… Ù…Ø±ØªØ¨Ø· Ø¨Ø­Ø¬Ø² Ø¢Ø®Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø©"),D=R.map(({label:A,codes:M})=>M&&M.length?`${A} (${M.join("ØŒ ")})`:A).join("ØŒ ");h(`${w}: ${D}`);return}const F=document.getElementById("res-tax"),G=document.getElementById("res-company-share"),Y=!!d;Y?(F&&(F.checked=!1,F.disabled=!0,F.classList.add("disabled"),F.title=u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),G&&(G.checked=!1,G.disabled=!0,G.classList.add("disabled"),G.title=u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),y&&(y.value="unpaid",y.disabled=!0,Ce(y,"unpaid"),y.title=u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹ Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø±ØªØ¨Ø·. Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ù„Ù‹Ø§ Ù…Ù† Ø°Ù„Ùƒ.")),z&&(z.disabled=!0,z.classList.add("disabled")),L&&(L.value="",L.disabled=!0,L.classList.add("disabled"))):(F&&(F.disabled=!1,F.classList.remove("disabled"),F.title=""),G&&(G.disabled=!1,G.classList.remove("disabled"),G.title=""),y&&(y.disabled=!1,y.title=""),z&&(z.disabled=!1,z.classList.remove("disabled")),L&&(L.disabled=!1,L.classList.remove("disabled")));const q=Y?!1:F?.checked||!1,O=!!G?.checked;if(!Y&&O!==q){h(u("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}let re=O?ct():null;O&&(!Number.isFinite(re)||re<=0)&&(je(),re=ct());const K=O&&q&&Number.isFinite(re)&&re>0;q&&je();const ee=Jn(E,B,N,q,C,{start:m,end:f,companySharePercent:K?re:0}),Le=Za(),P=Tt({totalAmount:ee,progressType:se,progressValue:V,history:[]});L&&Ea(L,P.paymentProgressValue);const ce=[];P.paymentProgressValue!=null&&P.paymentProgressValue>0&&ce.push({type:P.paymentProgressType||se,value:P.paymentProgressValue,amount:P.paidAmount,percentage:P.paidPercent,recordedAt:new Date().toISOString()});const ve=jt({manualStatus:_,paidAmount:P.paidAmount,paidPercent:P.paidPercent,totalAmount:ee});y&&(y.value=ve,Ce(y,ve));const me=typeof X?.paymentStatus=="string"?X.paymentStatus.toLowerCase():null,mt=me&&["paid","partial","unpaid"].includes(me)?me:"unpaid",Ie=new Map,he=new Map,Ae=new Map;document.querySelectorAll(".reservation-unit-cost-input[data-group-key]").forEach(w=>{const D=Oe(w.value),A=Number.isFinite(D)&&D>=0?xe(D):null;if(A===null)return;const M=w.dataset.packageIndex;if(M!==void 0&&M!==""){const te=Number.parseInt(M,10);if(Number.isInteger(te)&&te>=0){he.set(te,A);const pe=E[te];if(pe){const Se=Xt(pe);Se&&Ae.set(Se,A)}}}const Ee=w.dataset.packageIdentity;if(Ee){const te=ke(Ee)||I(String(Ee)).trim().toLowerCase();te&&Ae.set(te,A)}const de=w.dataset.groupKey;de&&Ie.set(de,A)});const ze=E.map((w,D)=>{let A=he.has(D)?he.get(D):void 0;if(A===void 0){const M=Xt(w);M&&(A=Ae.get(M))}if(A===void 0){const M=Te(w);M&&(A=Ie.get(M))}return A===void 0?w:{...w,cost:A,unit_cost:A,rental_cost:A,purchase_price:A,internal_cost:A,equipment_cost:A,package_cost:A,packageCost:A}}),Ve=(()=>{const w=[];ze.forEach((A,M)=>{if(String(A?.type||"").toLowerCase()!=="package")return;const Ee=Number.isFinite(Number(A.qty??A.quantity))?Number(A.qty??A.quantity):1,de=Number.isFinite(Number(A.unit_price??A.price))?Number(A.unit_price??A.price):0;let te=Number.isFinite(Number(A.unit_cost??A.cost))?Number(A.unit_cost??A.cost):0;const pe=Te(A),Se=Xt(A),_e=(he.has(M)?he.get(M):void 0)??(Se?Ae.get(Se):void 0)??(pe!==void 0?Ie.get(pe):void 0);_e!==void 0&&Number.isFinite(_e)&&(te=xe(_e));const ge=_e!==void 0?2:Number.isFinite(te)&&te>0?1:0;w.push({__dedupeKey:Se??`pkg-${M}`,__priority:ge,package_code:A.package_code??A.packageCode??A.barcode??A.code??null,name:A.name??A.desc??A.package_name??null,quantity:Ee,unit_price:de,unit_cost:te,package_cost:te,packageCost:te,cost:te,items:Array.isArray(A.packageItems)?A.packageItems:[]})});const D=new Map;return w.forEach(A=>{const M=A.__dedupeKey;(!D.has(M)||(A.__priority??0)>=(D.get(M).__priority??0))&&D.set(M,A)}),Array.from(D.values()).map(A=>{const{__dedupeKey:M,__priority:Ee,...de}=A;return de})})(),Fe=Qn({reservationCode:Le,customerId:o,start:m,end:f,status:oe?"confirmed":"pending",title:null,location:null,notes:T,projectId:d||null,totalAmount:ee,discount:Y?0:B,discountType:Y?"percent":N,applyTax:q,paidStatus:Y?mt:ve,confirmed:oe,items:ze.map(w=>({...w,equipmentId:w.equipmentId??w.id})),packages:Ve,crewAssignments:C,companySharePercent:Y||!K?null:re,companyShareEnabled:Y?!1:K,paidAmount:Y?0:P.paidAmount,paidPercentage:Y?0:P.paidPercent,paymentProgressType:Y?null:P.paymentProgressType,paymentProgressValue:Y?null:P.paymentProgressValue,paymentHistory:Y?[]:ce});try{$n("about to submit",{crewAssignments:C,techniciansPayload:Fe?.technicians,payload:Fe});const w=await rs(Fe);$n("server response",{reservation:w?.id??w?.reservationId??w?.reservation_code,technicians:w?.technicians,crewAssignments:w?.crewAssignments,techniciansDetails:w?.techniciansDetails}),In(),tt(),kt(),Ta(),h(u("reservations.toast.created","âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²"));try{const D=document.getElementById("sub-tab-trigger-my-reservations-tab");D&&typeof D.click=="function"&&setTimeout(()=>D.click(),0)}catch{}typeof sn=="function"&&sn({type:"created",reservation:w}),rr(w)}catch(w){console.error("âŒ [reservations/createForm] Failed to create reservation",w);const D=Yn(w)?w.message:u("reservations.toast.createFailed","ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");h(D,"error"),Y&&(h(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),It({clearValue:!1}))}}function rr(e){if(!$t)return;const{draftStorageKey:n=pa,returnUrl:t=fa}=$t,a=e?.id??e?.reservationId??e?.reservation_code;if(a!=null&&typeof window<"u"&&window.sessionStorage)try{const r=window.sessionStorage.getItem(n),s=r?JSON.parse(r)||{}:{},i=Array.isArray(s.linkedReservationIds)?s.linkedReservationIds:[],o=String(a);i.includes(o)||i.push(o),s.linkedReservationIds=i,window.sessionStorage.setItem(n,JSON.stringify(s))}catch(r){console.warn("âš ï¸ [reservations] Unable to persist linked reservation draft state",r)}$t=null,t&&(window.location.href=t)}function It({clearValue:e=!1}={}){const{input:n,hidden:t}=Ke();n&&(n.disabled=!1,n.classList.remove("reservation-input-disabled"),n.removeAttribute("aria-disabled"),n.removeAttribute("title"),e&&(n.value="",n.dataset.selectedId="",t&&(t.value="")),n.dataset&&delete n.dataset.pendingLinked,Ue())}function ir(e,n=""){const{input:t,hidden:a}=Ke();t&&(t.disabled=!0,t.classList.add("reservation-input-disabled"),t.setAttribute("aria-disabled","true"),n!=null&&(t.value=n),t.dataset.selectedId="",e&&(t.title=e),t.dataset&&(t.dataset.pendingLinked="true"),a&&(a.value=""),Ue())}function Ta(){const e=document.getElementById("res-customer"),n=document.getElementById("res-customer-input");e&&(e.value=""),n&&(n.value="",n.dataset.selectedId=""),Re({selectedValue:"",resetInput:!0});try{et("res-start","res-start-time","")}catch{}try{et("res-end","res-end-time","")}catch{}document.getElementById("res-notes").value="",document.getElementById("res-discount").value="";const t=document.getElementById("res-project"),a=document.getElementById("res-project-input");t&&(t.value=""),a&&(a.value="",a.dataset.selectedId=""),It({clearValue:!1}),Ze({selectedValue:"",resetInput:!0});const r=document.getElementById("equipment-description");r&&(r.value="");const s=document.getElementById("res-payment-status");s&&(s.value="unpaid",Ce(s,"unpaid"));const i=document.getElementById("res-payment-progress-type");i&&(i.value="percent");const o=document.getElementById("res-payment-progress-value");o&&(o.value=""),is(),_t([]),ws("form-reset"),be(),Ue(),J(),va()}function or(){const e=document.getElementById("reservation-items");if(!e||e.dataset.listenerAttached)return;e.addEventListener("click",t=>{const a=t.target.closest("button[data-action]");if(!a)return;const{action:r,groupKey:s}=a.dataset;if(r==="decrease-group"&&s){Xs(s);return}if(r==="increase-group"&&s){nr(s);return}if(r==="remove-group"&&s){Zs(s);return}});const n=t=>{const a=t.target.closest(".reservation-unit-price-input");if(a){const s=a.dataset.groupKey;s&&er(s,a.value);return}const r=t.target.closest(".reservation-unit-cost-input");if(r){const s=r.dataset.groupKey;s&&tr(s,r.value)}};e.addEventListener("change",n),e.dataset.listenerAttached="true"}function cr(){const e=document.getElementById("equipment-barcode");if(!e||e.dataset.listenerAttached)return;let n=null;const t=()=>{if(Dt()!=="single")return;const r=e.value;r?.trim()&&(clearTimeout(n),n=null,Ca(r,e))};e.addEventListener("keydown",r=>{r.key==="Enter"&&(r.preventDefault(),t())});const a=()=>{if(clearTimeout(n),!e.value?.trim()||Dt()!=="single")return;const{start:s,end:i}=nt();!s||!i||(n=setTimeout(()=>{t()},150))};e.addEventListener("input",a),e.addEventListener("change",t),e.dataset.listenerAttached="true"}function dr(){const e=document.getElementById("reservation-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",async a=>{a.preventDefault(),await Fn()}),e.dataset.listenerAttached="true");const n=document.getElementById("create-reservation-btn");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",async a=>{a.preventDefault(),await Fn()}),n.dataset.listenerAttached="true");const t=document.getElementById("clear-reservation-form-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",a=>{a.preventDefault(),Ta();try{va()}catch{}h(u("reservations.toast.formCleared","ğŸ§¹ ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„"))}),t.dataset.listenerAttached="true")}function ri({onAfterSubmit:e}={}){sn=typeof e=="function"?e:null,pt=!0;const{customers:n,projects:t}=ue();Ss(n||[]),Re(),An(),ka(t||[]),Aa({projectsList:t}),wn(),tt(),Kt(),Gs(),Pa(),Na(),sr(),ar(),or(),cr(),dr(),Ds(),Vs(),J(),be();try{typeof window<"u"&&!window.__reservationDraftUnloadBound&&(window.addEventListener("beforeunload",()=>{try{Ye()}catch{}}),window.__reservationDraftUnloadBound=!0)}catch{}pt=!1}function ja(){tt(),Kt(),Aa(),Re(),An(),wn(),Pa(),Na(),be(),J()}if(typeof document<"u"){const e=()=>{Re(),Ze({projectsList:Sn()}),An(),wn(),J()};document.addEventListener("language:changed",e),document.addEventListener("language:translationsReady",e),document.addEventListener("equipment:changed",()=>{tt()}),document.addEventListener("packages:changed",()=>{Kt(),Dt()==="package"&&un("package")})}typeof window<"u"&&(window.getCompanySharePercent=ct);function qt(e){if(!e)return null;const t=new Date(e).getTime();return Number.isNaN(t)?null:t}function lr(e){if(e==null)return null;if(typeof e=="number"&&Number.isFinite(e))return e;const n=String(e).trim();if(!n)return null;const t=n.match(/(\d+)/g);if(!t||t.length===0)return null;const a=t[t.length-1],r=Number.parseInt(a,10);return Number.isFinite(r)?r:null}function ur(e){const n=[e?.reservationId,e?.reservation_id,e?.id];for(const t of n){const a=lr(t);if(a!==null)return a}return null}function Mn(e,n=0){const t=ur(e);if(t!=null)return t;const a=qt(e.createdAt??e.created_at);if(a!=null)return a;const r=qt(e.updatedAt??e.updated_at);if(r!=null)return r;const s=qt(e.start);if(s!=null)return s;const i=qt(e.end);if(i!=null)return i;const o=Number(e.id??e.reservationId);return Number.isFinite(o)?o:Number.isFinite(n)?n:0}function mr({reservations:e=[],filters:n={},customersMap:t,techniciansMap:a,projectsMap:r}){const s=e.map((E,T)=>({reservation:E,index:T})),i=n.searchTerm||"",o=n.searchReservationId||"",d=n.searchCustomerName||"",l=n.searchProjectId||"",c=n.startDate||"",p=n.endDate||"",g=n.status||"",m=Object.prototype.hasOwnProperty.call(n,"customerId")?n.customerId:null,f=Object.prototype.hasOwnProperty.call(n,"technicianId")?n.technicianId:null,v=c?new Date(`${c}T00:00:00`):null,b=p?new Date(`${p}T23:59:59`):null,C=s.filter(({reservation:E})=>{const T=t.get(String(E.customerId)),B=r?.get?.(String(E.projectId)),N=E.start?new Date(E.start):null,y=Xn(E),{effectiveConfirmed:_}=At(E,B);if(m!=null&&String(E.customerId)!==String(m)||f!=null&&!(Array.isArray(E.technicians)?E.technicians.map(X=>String(X)):[]).includes(String(f))||g==="confirmed"&&!_||g==="pending"&&_||g==="completed"&&!y)return!1;if(g==="cancelled"){const V=String(E?.status||E?.reservationStatus||"").toLowerCase();if(!["cancelled","canceled"].includes(V))return!1}if(v&&N&&N<v||b&&N&&N>b)return!1;if(o){const V=[E.reservationId,E.id,E.reservation_id,E.reservationCode,E.reservation_code,E.code,E.reference,E.referenceNumber,E.reference_number],X=Ne(V.filter(Q=>Q!=null&&Q!=="").map(String).join(" ")).replace(/\s+/g,""),oe=o.replace(/\s+/g,"");if(!X.includes(oe))return!1}if(d&&!Ne(T?.customerName||E.customerName||"").includes(d))return!1;if(l){const V=[E.projectId,E.project_id,E.projectID,B?.id,B?.projectCode,B?.project_code],X=Ne(V.filter(Q=>Q!=null&&Q!=="").map(String).join(" ")).replace(/\s+/g,""),oe=l.replace(/\s+/g,"");if(!X.includes(oe))return!1}if(!i)return!0;const z=E.items?.map?.(V=>`${V.barcode} ${V.desc}`).join(" ")||"",L=(E.technicians||[]).map(V=>a.get(String(V))?.name).filter(Boolean).join(" ");return Ne([E.reservationId,T?.customerName||E.customerName,E.notes,z,L,B?.title].filter(Boolean).join(" ")).includes(i)});return C.sort((E,T)=>{const B=Mn(E.reservation,E.index),N=Mn(T.reservation,T.index);return B!==N?N-B:T.index-E.index}),C}function pr({entries:e,customersMap:n,techniciansMap:t,projectsMap:a}){const r=u("reservations.create.summary.currency","SR"),s=u("reservations.list.taxIncludedShort","(Ø´Ø§Ù…Ù„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©)"),i=u("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),o=u("reservations.list.noNotes","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª"),d=u("reservations.list.itemsCountShort","{count} Ø¹Ù†ØµØ±"),l=u("reservations.list.crew.separator","ØŒ "),c=u("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯"),p=u("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯"),g=u("reservations.list.status.completed","ğŸ“ Ù…ØºÙ„Ù‚"),m=u("reservations.list.status.cancelled","âŒ Ù…Ù„ØºÙŠ"),f=u("reservations.list.payment.paid","ğŸ’³ Ù…Ø¯ÙÙˆØ¹"),v=u("reservations.list.payment.unpaid","ğŸ’³ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"),b=u("reservations.list.payment.partial","ğŸ’³ Ù…Ø¯ÙÙˆØ¹ Ø¬Ø²Ø¦ÙŠØ§Ù‹"),C=u("reservations.list.actions.confirm","âœ”ï¸ ØªØ£ÙƒÙŠØ¯"),E=u("reservations.list.actions.close","ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø¬Ø²"),T=u("reservations.list.project.unlinked","ØºÙŠØ± Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø´Ø±ÙˆØ¹"),B=u("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),N={client:u("reservations.list.labels.client","ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„"),project:u("reservations.list.labels.project","ğŸ“ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"),start:u("reservations.list.labels.start","ğŸ—“ï¸ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),end:u("reservations.list.labels.end","ğŸ—“ï¸ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø­Ø¬Ø²"),cost:u("reservations.list.labels.cost","ğŸ’µ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ"),equipment:u("reservations.list.labels.equipment","ğŸ“¦ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"),crew:u("reservations.list.labels.crew","ğŸ˜ Ø§Ù„ÙØ±ÙŠÙ‚")};return e.map(({reservation:y,index:_})=>{const z=n.get(String(y.customerId)),L=y.projectId?a?.get?.(String(y.projectId)):null,se=Xn(y),V=String(y?.status||y?.reservationStatus||"").toLowerCase(),X=V==="cancelled"||V==="canceled",oe=y.items?.length||0,Q=Array.isArray(y.crewAssignments)?y.crewAssignments:[],$=(y.technicians||[]).map(H=>t.get(String(H))).filter(Boolean),R=Q.length?Q.map(H=>{const le=H.positionLabel??H.position_name??H.role??u("reservations.crew.positionFallback","Ù…Ù†ØµØ¨ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),ae=H.technicianName??t.get(String(H.technicianId??""))?.name??null;return ae?`${I(le)} (${I(ae)})`:I(le)}):$.map(H=>H.name),F=R.length?R.join(l):"â€”",G=I(String(y.reservationId??"")),Y=y.start?I(en(y.start)):"-",q=y.end?I(en(y.end)):"-",O=y.discount??y.discountValue??y.discount_value??y.discountAmount??0,re=Number.parseFloat(I(String(O))),K=Number.isFinite(re)?re:0,ee=y.discountType??y.discount_type??y.discountMode??"percent",Le=String(ee).toLowerCase()==="amount"?"amount":"percent",P=!!(y.applyTax??y.apply_tax??y.taxApplied),ce=y.companySharePercent??y.company_share_percent??y.companyShare??y.company_share,ve=y.companyShareEnabled??y.company_share_enabled??y.companyShareApplied,me=Number.parseFloat(I(String(ce))),Ie=(ve===!0||Number.isFinite(me)&&me>0)&&Number.isFinite(me)?me:0;let he=0;try{const H=cs({items:y.items||[],technicianIds:y.technicians||[],crewAssignments:Array.isArray(y.crewAssignments)?y.crewAssignments:[],discount:K,discountType:Le,applyTax:P,start:y.start,end:y.end,companySharePercent:Ie,groupingSource:y}),le=Number(H?.finalTotal||0);he=Number.isFinite(le)?Number(le.toFixed(2)):0}catch{he=0}const Ae=Number.parseFloat(I(String(y.cost??0)))||0,We=he>0?he:Ae,ze=y.paymentHistory||y.payment_history||[],Ve=Tt({totalAmount:We,paidAmount:ze.length?0:y.paidAmount,paidPercent:ze.length?0:y.paidPercent,history:ze});let w=jt({manualStatus:null,paidAmount:Ve.paidAmount,paidPercent:Ve.paidPercent,totalAmount:We});if(L)try{const{totalWithTax:H}=qs(L)||{totalWithTax:0},le=L.paymentHistory||L.payments||[],ae=Tt({totalAmount:H,paidAmount:le.length?0:L.paidAmount,paidPercent:le.length?0:L.paidPercent,history:le}),vt=jt({manualStatus:null,paidAmount:ae.paidAmount,paidPercent:ae.paidPercent,totalAmount:H});vt&&(w=vt)}catch{}const D=w==="paid",A=w==="partial",{effectiveConfirmed:M,projectLinked:Ee}=At(y,L),de=M?"status-confirmed":"status-pending",te=D?"status-paid":A?"status-partial":"status-unpaid",pe=D?f:A?b:v;let Se=`<span class="reservation-chip status-chip ${de}">${M?c:p}</span>`,_e=`<span class="reservation-chip status-chip ${te}">${pe}</span>`,ge="",Lt="";X?(Se=`<span class="reservation-chip status-chip status-cancelled">${m}</span>`,_e="",ge=" tile-cancelled"):(ge=D?" tile-paid":A?" tile-partial":" tile-unpaid",se&&(ge+=" tile-completed",Se=`<span class="reservation-chip status-chip status-completed">${g}</span>`,_e=`<span class="reservation-chip status-chip status-completed">${pe}</span>`,Lt=` data-completed-label="${u("reservations.list.ribbon.completed","Ù…ØºÙ„Ù‚").replace(/\"/g,"&quot;")}"`));let He="";!Ee&&!X&&(M?se||(He=`<button class="tile-confirm" data-reservation-index="${_}" data-action="close">${E}</button>`):He=`<button class="tile-confirm" data-reservation-index="${_}" data-action="confirm">${C}</button>`);const S=He?`<div class="tile-actions">${He}</div>`:"",x=I(We.toFixed(2)),k=I(String(oe)),j=y.notes?I(y.notes):o,ie=d.replace("{count}",k),ne=y.applyTax?`<small>${s}</small>`:"";let W=T;return y.projectId&&(W=L?.title?I(L.title):B),`
      <div class="${He?"reservation-tile-wrapper has-tile-action":"reservation-tile-wrapper"}">
        <div class="reservation-tile${ge}"${Lt} data-reservation-index="${_}" data-action="details">
          <div class="tile-top">
          <div class="tile-id">${G}</div>
          <div class="tile-badges">
            ${Se}
            ${_e}
          </div>
          </div>
          <div class="tile-body">
          <div class="tile-row">
            <span class="tile-label">${N.client}</span>
            <span class="tile-value">${z?.customerName||y.customerName||i}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${N.project}</span>
            <span class="tile-value">${W}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${N.start}</span>
            <span class="tile-value tile-inline">${Y}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${N.end}</span>
            <span class="tile-value tile-inline">${q}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${N.cost}</span>
            <span class="tile-value">${x} ${r} ${ne}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${N.equipment}</span>
            <span class="tile-value">${ie}</span>
          </div>
          <div class="tile-row">
            <span class="tile-label">${N.crew}</span>
            <span class="tile-value">${R.length?F:"â€”"}</span>
          </div>
          </div>
          <div class="tile-footer">
          <span class="tile-notes">ğŸ“ ${j}</span>
          </div>
        </div>
        ${S}
      </div>
    `}).join("")}function fr({containerId:e="reservations-list",filters:n=null,onShowDetails:t,onConfirmReservation:a,onCloseReservation:r,onReopenReservation:s}={}){const i=kt(),{reservations:o=[],customers:d=[],technicians:l=[],projects:c=[]}=ue(),p=o.map(B=>{const N=nn(B);return{...N,id:B.id??N.id,reservationId:B.reservationId??B.reservation_id??N.reservationId,reservationCode:B.reservationCode??B.reservation_code??N.reservationCode}}),g=p,m=Array.isArray(i)?i:l||[],f=new Map((c||[]).map(B=>[String(B.id),B])),v=document.getElementById(e);if(!v){console.warn("âš ï¸ [reservations/renderers] container not found",e);return}if(!g||g.length===0){v.innerHTML=`<p>${u("reservations.list.empty","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ø¨Ø¹Ø¯.")}</p>`;return}const b=n||Cs(),C=new Map(d.map(B=>[String(B.id),B])),E=new Map(m.map(B=>[String(B.id),B])),T=mr({reservations:p,filters:b,customersMap:C,techniciansMap:E,projectsMap:f});if(T.length===0){v.innerHTML=`<p>${u("reservations.list.noResults","ğŸ” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.")}</p>`;return}v.innerHTML=`<div class="reservations-grid">${pr({entries:T,customersMap:C,techniciansMap:E,projectsMap:f})}</div>`,v.querySelectorAll('[data-action="details"]').forEach(B=>{const N=Number(B.dataset.reservationIndex);Number.isNaN(N)||B.addEventListener("click",()=>{typeof t=="function"&&t(N)})}),v.querySelectorAll('button[data-action="confirm"]').forEach(B=>{const N=Number(B.dataset.reservationIndex);Number.isNaN(N)||B.addEventListener("click",y=>{y.stopPropagation(),typeof a=="function"&&a(N,y)})}),v.querySelectorAll('button[data-action="close"]').forEach(B=>{const N=Number(B.dataset.reservationIndex);Number.isNaN(N)||B.addEventListener("click",y=>{y.stopPropagation(),typeof r=="function"&&r(N,y)})})}function gr(e,{onEdit:n,onDelete:t,getEditContext:a}={}){const{reservations:r=[],customers:s=[],projects:i=[]}=ue(),o=r.map(b=>{const C=nn(b);return{...C,id:b.id??C.id,reservationId:b.reservationId??b.reservation_id??C.reservationId,reservationCode:b.reservationCode??b.reservation_code??C.reservationCode}}),d=r[e];if(!d)return h(u("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²")),!1;let l=o[e]??nn(d);const c=s.find(b=>String(b.id)===String(d.customerId)),p=d.projectId?i.find(b=>String(b.id)===String(d.projectId)):null,g=document.getElementById("reservation-details-body"),m=document.getElementById("reservationDetailsModal"),f=(b,C=null)=>{if(g){const E=C??(kt()||[]);g.innerHTML=ss(b,c,E,e,p)}},v=()=>{const b=()=>{m&&window.bootstrap?.Modal&&window.bootstrap.Modal.getInstance(m)?.hide()},C=document.getElementById("reservation-details-edit-btn");C&&(C.onclick=()=>{b(),typeof n=="function"&&n(e,{reservation:d,customer:c,getEditContext:a})});const E=document.getElementById("reservation-details-delete-btn");E&&(E.onclick=()=>{b(),typeof t=="function"&&t(e,{reservation:d,customer:c})});const T=g?.querySelector('[data-action="open-project"]');T&&p&&T.addEventListener("click",()=>{b();const y=p?.id!=null?String(p.id):"",_=y?`projects.html?project=${encodeURIComponent(y)}`:"projects.html";window.location.href=_});const B=document.getElementById("reservation-details-export-btn");B&&(B.onclick=async y=>{y?.preventDefault?.(),y?.stopPropagation?.(),B.blur();try{await Ps({reservation:d,customer:c,project:p})}catch(_){console.error("âŒ [reservations] export to PDF failed",_),h(u("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});const N=document.getElementById("reservation-details-checklist-btn");N&&(N.onclick=async y=>{y?.preventDefault?.(),y?.stopPropagation?.(),N.blur();try{await Ls({reservation:d,customer:c,project:p})}catch(_){console.error("âŒ [reservations] export checklist PDF failed",_),h(u("reservations.details.actions.exportFailed","âš ï¸ ØªØ¹Ø°Ø± ØªØµØ¯ÙŠØ± Ø§Ù„Ø­Ø¬Ø² Ø¥Ù„Ù‰ PDF"),"error")}});try{const y=g?.querySelector("[data-tech-slider]");if(y){const _=y.querySelector("[data-slider-track]"),z=y.querySelector("[data-slider-prev]"),L=y.querySelector("[data-slider-next]");if(_&&(z||L)){const se=document.documentElement.getAttribute("dir")==="rtl"||document.body.getAttribute("dir")==="rtl",V=()=>{const Q=_.querySelector(".reservation-technician-card"),$=Q&&Q.getBoundingClientRect().width||220,R=12,F=Math.max(1,Math.floor(_.clientWidth/($+R)));return Math.max($+R,Math.floor(F*($+R)*.9))},X=()=>{const Q=Math.max(0,_.scrollWidth-_.clientWidth-2),$=_.scrollLeft<=1,R=_.scrollLeft>=Q;z&&(z.disabled=$),L&&(L.disabled=R)},oe=Q=>{const $=V()*Q,R=se?-$:$;_.scrollBy({left:R,behavior:"smooth"})};z?.addEventListener("click",()=>oe(-1)),L?.addEventListener("click",()=>oe(1)),_.addEventListener("scroll",X,{passive:!0}),window.addEventListener("resize",X,{passive:!0}),setTimeout(X,0)}}}catch{}};if(g&&(f(l),v(),da().then(()=>{const b=kt()||[];f(l,b),v()}).catch(()=>{})),Zn(l)){const b=l.id||l.reservationId||l.reservation_code;ea(b).then(C=>{C&&(l=C,f(l),v())}).catch(()=>{})}return m&&window.bootstrap?.Modal&&window.bootstrap.Modal.getOrCreateInstance(m).show(),!0}function yr(){try{const e=window.__EDIT_RESERVATION_RANGE__;if(e&&typeof e=="object")return{start:typeof e.start=="string"?e.start:null,end:typeof e.end=="string"?e.end:null}}catch{}return{start:null,end:null}}function zn(e,n){const t=yr(),a={start:e||t.start||null,end:n||t.end||null};try{window.__EDIT_RESERVATION_RANGE__=a}catch{}return a}function ut(){const e=document.getElementById("edit-res-start")?.value?.trim(),n=document.getElementById("edit-res-end")?.value?.trim(),t=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",a=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00";let r=null,s=null;if(e&&(r=it(e,t)||`${e}T${t}`),n&&(s=it(n,a)||`${n}T${a}`),!r||!s){const i=zn(r,s);r=r||i.start,s=s||i.end}else zn(r,s);return{start:r||null,end:s||null}}function Ht(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function _n(){return typeof document>"u"?{container:null,select:null,hint:null,addButton:null}:{container:document.querySelector(".reservation-equipment-inputs--package"),select:document.getElementById("edit-res-package-select"),hint:document.getElementById("edit-res-package-hint"),addButton:document.getElementById("edit-add-reservation-package")}}function Nt(){const{container:e,select:n,hint:t,addButton:a}=_n();if(!n)return;const r=n.value,s=na(),i=u("reservations.create.summary.currency","SR"),o=`<option value="" disabled selected>${u("reservations.edit.packages.placeholder","Ø§Ø®ØªØ± Ø§Ù„Ø­Ø²Ù…Ø©")}</option>`,d=s.map(c=>{const p=Number.isFinite(Number(c.price))?Number(c.price):0,g=I(p.toFixed(2)),m=`${c.name} â€” ${g} ${i}`;return`<option value="${Ht(c.id)}">${Ht(m)}</option>`}).join("");n.innerHTML=`${o}${d}`;const l=s.length>0;n.disabled=!l,a&&(a.disabled=!l),e&&(e.hidden=!l,e.setAttribute("aria-hidden",l?"false":"true")),t&&(l?(t.textContent=u("reservations.edit.packages.hint","Ø­Ø¯Ø¯ Ø§Ù„Ø­Ø²Ù…Ø© Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ø­Ø¬Ø²."),t.dataset.state="ready"):(t.textContent=u("reservations.create.packages.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø²Ù… Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹. ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ù…Ù† Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…."),t.dataset.state="empty")),l&&r&&s.some(c=>c.id===r)?n.value=r:n.selectedIndex=0}function vr(e,{silent:n=!1}={}){const t=String(e??"").trim();if(!t)return n||h(u("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),{success:!1,reason:"invalid"};const{index:a,items:r=[]}=ye(),{start:s,end:i}=ut(),{reservations:o=[]}=ue(),d=a!=null&&o[a]||null,l=d?.id??d?.reservationId??null,c=La(t,{existingItems:r,start:s,end:i,ignoreReservationId:l});if(!c.success)return n||h(c.message||u("reservations.toast.packageInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø²Ù…Ø© ØµØ§Ù„Ø­Ø© Ø£ÙˆÙ„Ø§Ù‹")),c;const p=[...r,c.package];return De(a,p),Be(p),we(),n||h(u("reservations.toast.packageAdded","âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ø²Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­")),c}function Vn(){const{select:e}=_n();if(!e)return;const n=e.value||"";vr(n)?.success&&e&&(e.value="",e.selectedIndex=0)}function hr(){const{addButton:e,select:n}=_n();n&&!n.dataset.langRefreshAttached&&(document.addEventListener("language:changed",Nt),document.addEventListener("language:translationsReady",Nt),n.dataset.langRefreshAttached="true"),e&&!e.dataset.listenerAttached&&(e.addEventListener("click",()=>{Vn()}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),Vn())}),n.dataset.listenerAttached="true"),Nt()}function Be(e=[]){const n=document.getElementById("edit-res-items");if(!n)return;const t=u("reservations.create.equipment.none","Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø¯Ø§Øª"),a=u("reservations.create.summary.currency","SR"),r=u("reservations.create.equipment.imageAlt","ØµÙˆØ±Ø©"),s=u("reservations.equipment.actions.increase","Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ©"),i=u("reservations.equipment.actions.decrease","ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ©"),o=u("reservations.equipment.actions.remove","Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù†Ø¯");if(!e||e.length===0){n.innerHTML=`<tr><td colspan="7" class="text-center">${t}</td></tr>`,On(n);return}const{groups:d}=Bt({items:e},{preserveOriginalOrder:!0}),l=u("reservations.equipment.table.reorder","Ø§Ø³Ø­Ø¨ Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨");n.innerHTML=d.map(c=>{const p=c.items[0]||{},g=yt(p)||c.image,m=g?`<img src="${g}" alt="${r}" class="reservation-item-thumb">`:'<div class="reservation-item-thumb reservation-item-thumb--placeholder" aria-hidden="true">ğŸ¥</div>',f=String(c?.type||"").toLowerCase()==="package"||c.items.some(q=>q?.type==="package"),v=I(String(c.count)),b=Oe(c.unitPrice),C=Number.isFinite(b)?xe(b):0,E=Oe(c.unitCost);let T=Number.isFinite(E)?xe(E):0;const B=(()=>{try{const{start:q,end:O}=ut(),re=typeof tn=="function"?tn(q,O):1;return Number.isFinite(re)&&re>0?re:1}catch{return 1}})(),N=(()=>{const q=c.count??c.quantity??1;if(typeof q=="number")return Number.isFinite(q)&&q>0?q:1;const O=Number.parseFloat(I(String(q)).replace(/[^0-9.]/g,""));return Number.isFinite(O)&&O>0?O:1})(),y=xe(C*N*B),_=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-price-input"
          data-group-key="${c.key}"
          min="0"
          step="0.01"
          value="${I(String(C))}"
          aria-label="${u("reservations.equipment.table.unitPrice","Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,z=`edit-unit-cost-${c.key}`,L=(()=>{for(let q=0;q<e.length;q+=1){const O=e[q];if(!(!O||String(O.type||"").toLowerCase()!=="package")&&Te(O)===c.key)return q}return null})();if(L!=null&&Number.isInteger(L)&&e[L]){const q=e[L],O=Oe(q.unit_cost??q.cost??q.package_cost??q.packageCost);Number.isFinite(O)&&(T=xe(O))}const se=(()=>{if(!f)return null;const q=[c.packageId,c.package_id,c.packageCode,c.package_code,c.packageDisplayCode,c.barcode,c.key];for(const O of q){if(!O)continue;const re=ke(O);if(re)return re;const K=I(String(O)).trim().toLowerCase();if(K)return K}return null})(),V=se?`data-package-identity="${se}"`:"",X=`
        <input
          type="number"
          class="form-control form-control-sm reservation-unit-cost-input"
          id="${z}"
          data-group-key="${c.key}"
          ${V}
          ${L!=null&&Number.isInteger(L)?`data-package-index="${L}"`:""}
          min="0"
          step="0.01"
          value="${I(String(T))}"
          aria-label="${u("reservations.equipment.table.unitCost","ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©")}"
        >
      `,oe=`${I(y.toFixed(2))} ${a}`,Q=`
        <span
          class="reservation-row-handle"
          data-drag-handle="true"
          draggable="true"
          title="${l}"
          aria-label="${l}"
          role="button"
          tabindex="0"
        >
          â‹®â‹®
        </span>
      `,$=c.barcodes.map(q=>I(String(q||""))).filter(Boolean),R=$.length?`<details class="reservation-item-barcodes">
            <summary>${u("reservations.equipment.barcodes.summary","Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯Ø§Øª")}</summary>
            <ul class="reservation-barcode-list">
              ${$.map(q=>`<li>${q}</li>`).join("")}
            </ul>
          </details>`:"";let F="";if(f){const q=new Map,O=K=>{const ee=Number.parseFloat(I(String(K??"")).replace(/[^0-9.]/g,""));return!Number.isFinite(ee)||ee<=0||ee>99?1:Math.round(ee)},re=[];if(Array.isArray(c.packageItems)&&c.packageItems.length&&re.push(...c.packageItems),c.items.forEach(K=>{Array.isArray(K?.packageItems)&&re.push(...K.packageItems)}),re.forEach(K=>{if(!K)return;const ee=U(K.barcode||K.normalizedBarcode||K.desc||Math.random());if(!ee)return;const Le=q.get(ee),P=O(K.qtyPerPackage??K.perPackageQty??K.quantityPerPackage??K.qty??K.quantity??1),ce=Math.max(1,Math.min(P,99));if(Le){Le.qty=ce;return}q.set(ee,{desc:K.desc||K.barcode||u("reservations.create.packages.unnamedItem","Ø¹Ù†ØµØ± Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"),qty:ce,barcode:K.barcode??K.normalizedBarcode??""})}),q.size){const K=Array.from(q.values()).map(ee=>{const Le=I(String(ee.qty>0?Math.min(ee.qty,99):1)),P=Ht(ee.desc||""),ce=ee.barcode?` <span class="reservation-package-items__barcode">(${Ht(I(String(ee.barcode)))})</span>`:"";return`<li>${P}${ce} Ã— ${Le}</li>`}).join("");F=`
            <details class="reservation-package-items">
              <summary>${u("reservations.create.packages.itemsSummary","Ø¹Ø±Ø¶ Ù…Ø­ØªÙˆÙŠØ§Øª Ø§Ù„Ø­Ø²Ù…Ø©")}</summary>
              <ul class="reservation-package-items__list">
                ${K}
              </ul>
            </details>
          `}}const G=f?"reservation-quantity-control reservation-quantity-control--static":"reservation-quantity-control",Y=f?' disabled aria-disabled="true" tabindex="-1"':"";return`
        <tr data-group-key="${c.key}" data-drag-row="true" draggable="true">
          <td>
            <div class="reservation-item-info">
              <div class="reservation-item-drag">
                ${Q}
              </div>
              <div class="reservation-item-thumb-wrapper">${m}</div>
              <div class="reservation-item-copy">
                <div class="reservation-item-title">${c.description||"-"}</div>
                ${f?`${F||""}${R||""}`:R}
              </div>
            </div>
          </td>
          <td>
            <div class="${G}" data-group-key="${c.key}">
              <button type="button" class="reservation-qty-btn" data-action="decrease-edit-group" data-group-key="${c.key}" aria-label="${i}"${Y}>âˆ’</button>
              <span class="reservation-qty-value">${v}</span>
              <button type="button" class="reservation-qty-btn" data-action="increase-edit-group" data-group-key="${c.key}" aria-label="${s}"${Y}>+</button>
            </div>
          </td>
          <td><span class="reservation-days-value">${I(String(B))}</span></td>
          <td>${_}</td>
          <td>${X}</td>
          <td>${oe}</td>
          <td>
            <button type="button" class="reservation-remove-button" data-action="remove-edit-group" data-group-key="${c.key}" aria-label="${o}">ğŸ—‘ï¸</button>
          </td>
        </tr>
      `}).join(""),Ir(n),On(n)}function br(e=[]){if(!Array.isArray(e)||!e.length)return;const{index:n,items:t}=ye();if(!Array.isArray(t)||!t.length)return;const{groups:a}=Bt({items:t},{preserveOriginalOrder:!0}),r=new Map;a.forEach(d=>{Array.isArray(d.itemIndices)&&d.itemIndices.length&&r.set(d.key,[...d.itemIndices])});const s=new Set,i=[];if(e.forEach(d=>{const l=r.get(d);!l||!l.length||l.forEach(c=>{s.has(c)||t[c]&&(i.push(t[c]),s.add(c))})}),!i.length||(t.forEach((d,l)=>{s.has(l)||i.push(d)}),i.length!==t.length))return;if(i.every((d,l)=>d===t[l])){Be(t);return}De(n,i),Be(i),we()}function Ir(e){if(!e||e.dataset.dragListenerAttached==="true")return;let n=null;const t=()=>Array.from(e.querySelectorAll("tr[data-group-key]")).map(r=>r.dataset.groupKey),a=r=>{const s=e.querySelector("tr[data-group-key].is-dragging");if(s&&s.classList.remove("is-dragging"),!n)return;const i=n.initialOrder||[];if(n=null,!r){Be(ye().items);return}const o=t();if(i.length===o.length&&i.every((l,c)=>l===o[c])){Be(ye().items);return}br(o)};e.addEventListener("dragstart",r=>{if(r.target.closest("button, input, textarea, select, a[href]")&&!r.target.closest("[data-drag-handle]"))return;const i=r.target.closest("[data-drag-handle], tr[data-group-key]");if(!i)return;const o=i.closest("tr[data-group-key]");if(o){n={key:o.dataset.groupKey,initialOrder:t()},o.classList.add("is-dragging");try{r.dataTransfer?.setData?.("text/plain",o.dataset.groupKey||""),r.dataTransfer.effectAllowed="move"}catch{}}}),e.addEventListener("dragover",r=>{if(!n)return;const s=r.target.closest("tr[data-group-key]"),i=e.querySelector("tr[data-group-key].is-dragging");if(!s||!i||s===i)return;r.preventDefault();const o=s.getBoundingClientRect();r.clientY>o.top+o.height/2?s.after(i):s.before(i)}),e.addEventListener("drop",r=>{n&&(r.preventDefault(),a(!0))}),e.addEventListener("dragend",()=>{n&&a(!1)}),e.dataset.dragListenerAttached="true"}function Er(e){switch(e){case"amount":return u("reservations.paymentHistory.type.amount","ğŸ’µ Ø¯ÙØ¹Ø© Ù…Ø§Ù„ÙŠØ©");case"percent":return u("reservations.paymentHistory.type.percent","Ùª Ø¯ÙØ¹Ø© Ù†Ø³Ø¨Ø©");default:return u("reservations.paymentHistory.type.unknown","Ø¯ÙØ¹Ø©")}}function Wt(){const e=document.getElementById("edit-res-payment-history");if(!e)return;let n=Jt();const t=document.getElementById("edit-res-project")?.value||"";if(t)try{const i=(ue()?.projects||[]).find(d=>String(d.id)===String(t)),o=Array.isArray(i?.paymentHistory)?i.paymentHistory:Array.isArray(i?.payment_history)?i.payment_history:Array.isArray(i?.payments)?i.payments:Array.isArray(i?.paymentLogs)?i.paymentLogs:[];Array.isArray(o)&&o.length&&(n=o)}catch{}if(!Array.isArray(n)||n.length===0){e.innerHTML=`<div class="reservation-payment-history__empty">${u("reservations.paymentHistory.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙØ¹Ø§Øª Ù…Ø³Ø¬Ù„Ø©")}</div>`,Hn();return}const a=u("reservations.create.summary.currency","SR"),r=n.map((s,i)=>{const o=Number.isFinite(Number(s?.amount))&&Number(s.amount)>0?`${I(Number(s.amount).toFixed(2))} ${a}`:"â€”",d=Number.isFinite(Number(s?.percentage))&&Number(s.percentage)>0?`${I(Number(s.percentage).toFixed(2))}%`:"â€”",l=s?.recordedAt?I(en(s.recordedAt)):"â€”",c=Er(s?.type),p=s?.note?I(s.note):"";return`
      <tr>
        <td>${c}</td>
        <td>${o}</td>
        <td>${d}</td>
        <td>${l}</td>
        <td>${p}</td>
        <td class="reservation-payment-history__actions">
          <button type="button" class="btn btn-link btn-sm reservation-payment-history__remove" data-action="remove-payment" data-index="${i}" aria-label="${u("reservations.paymentHistory.actions.delete","Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")}">ğŸ—‘ï¸</button>
        </td>
      </tr>
    `}).join("");e.innerHTML=`
    <div class="reservation-payment-history__table-wrapper">
      <table class="table table-sm reservation-payment-history__table">
        <thead>
          <tr>
            <th>${u("reservations.paymentHistory.headers.method","Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©")}</th>
            <th>${u("reservations.paymentHistory.headers.amount","Ø§Ù„Ù…Ø¨Ù„Øº")}</th>
            <th>${u("reservations.paymentHistory.headers.percent","Ø§Ù„Ù†Ø³Ø¨Ø©")}</th>
            <th>${u("reservations.paymentHistory.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®")}</th>
            <th>${u("reservations.paymentHistory.headers.note","Ù…Ù„Ø§Ø­Ø¸Ø§Øª")}</th>
            <th></th>
          </tr>
        </thead>
        <tbody>${r}</tbody>
      </table>
    </div>
  `,Hn()}function Sr(){if(wt()){h(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const e=document.getElementById("edit-res-payment-progress-type"),n=document.getElementById("edit-res-payment-progress-value"),t=Ma(e);let a=za(n);if(!Number.isFinite(a)||a<=0){h(u("reservations.toast.paymentInvalid","âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù‚ÙŠÙ…Ø© Ø¯ÙØ¹Ø© ØµØ­ÙŠØ­Ø©"));return}const r=an.lastResult,s=Number(r?.total)||0,i=Number(r?.paidPercent)||0,o=Number(r?.paidAmount)||0,d=u("reservations.create.summary.currency","SR");let l=null,c=null;if(t==="percent"){const g=Math.max(0,100-i);if(g<=1e-4){h(u("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const m=Math.min(a,g);if(m!==a){const f=I(m.toFixed(2));h(u("reservations.toast.paymentCappedPercent","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {value}% Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ 100%").replace("{value}",f)),a=m}c=Number(a.toFixed(2)),s>0&&(l=a/100*s)}else{const g=Math.max(0,s-o);if(g<=1e-4){h(u("reservations.toast.paymentNoRemainingBalance","âš ï¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ù…Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬Ø²ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø©"));return}const m=Math.min(a,g);if(m!==a){const f=`${I(m.toFixed(2))} ${d}`;h(u("reservations.toast.paymentCappedAmount","â„¹ï¸ ØªÙ… Ø¶Ø¨Ø· Ø§Ù„Ø¯ÙØ¹Ø© Ø¥Ù„Ù‰ {amount} Ù„Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ").replace("{amount}",f)),a=m}l=Number(a.toFixed(2)),s>0&&(c=l/s*100)}l!=null&&(l=Number(l.toFixed(2))),c!=null&&(c=Number(c.toFixed(2)));const p={type:t,value:a,amount:l,percentage:c,recordedAt:new Date().toISOString()};jr(p),Cn(Jt()),Wt(),we(),n&&(n.value=""),e&&(e.value="percent",e.dataset&&delete e.dataset.userSelected),h(u("reservations.toast.paymentAdded","âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø©"))}function Hn(){const e=document.getElementById("edit-res-payment-add");e&&!e.dataset.listenerAttached&&(e.addEventListener("click",t=>{if(wt()){t.preventDefault(),h(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}Sr()}),e.dataset.listenerAttached="true");const n=document.getElementById("edit-res-payment-history");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",t=>{const a=t.target.closest('[data-action="remove-payment"]');if(!a)return;if(wt()){t.preventDefault(),h(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error");return}const r=Number(a.dataset.index);Number.isNaN(r)||(Dr(r),Cn(Jt()),Wt(),we(),h(u("reservations.toast.paymentRemoved","ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙØ¹Ø©")))}),n.dataset.listenerAttached="true")}function kr(e){const{index:n,items:t}=ye(),{groups:a}=Bt({items:t}),r=a.find(o=>o.key===e);if(!r||r.items.some(o=>o?.type==="package"))return;let s=-1;for(let o=t.length-1;o>=0;o-=1){const d=t[o];if(Te(d)===e&&d?.type!=="package"){s=o;break}}if(s<0)return;const i=t.filter((o,d)=>d!==s);De(n,i),Be(i),we()}function wr(e){const{index:n,items:t}=ye(),{groups:a}=Bt({items:t}),r=a.find(o=>o.key===e);if(!r)return;let s=t.filter(o=>Te(o)!==e);if(r.items.some(o=>o&&o.type==="package")){const o=ke(r.packageId??r.items.find(p=>p?.type==="package")?.packageId??""),d=U(r.package_code??r.packageDisplayCode??r.barcode??"");s=s.filter(p=>{if(!p||typeof p!="object"||p.type!=="package")return!0;const g=ke(p.packageId??p.package_id??p.id??""),m=U(p.barcode??p.package_code??"");return!(o&&g===o||d&&m&&m===d)});const l=new Set,c=new Set;r.items.forEach(p=>{(Array.isArray(p?.packageItems)?p.packageItems:[]).forEach(m=>{const f=U(m?.barcode||m?.normalizedBarcode||"");f&&l.add(f);const v=m?.equipmentId??m?.equipment_id??null;v!=null&&c.add(String(v))})}),(l.size||c.size)&&(s=s.filter(p=>{const g=U(p?.barcode||""),m=p?.equipmentId??p?.id??null;return!(g&&l.has(g)||m!=null&&c.has(String(m)))}))}s.length!==t.length&&(De(n,s),Be(s),we())}function Ar(e){const{index:n,items:t}=ye(),{groups:a}=Bt({items:t}),r=a.find(b=>b.key===e);if(!r||r.items.some(b=>b?.type==="package"))return;const{start:s,end:i}=ut();if(!s||!i){h(u("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:o=[]}=ue(),d=n!=null&&o[n]||null,l=d?.id??d?.reservationId??null,c=new Set(t.map(b=>U(b.barcode))),{equipment:p=[]}=ue(),g=(p||[]).find(b=>{const C=U(b?.barcode);return!C||c.has(C)||Te({desc:b?.desc||b?.description||b?.name||"",price:Number(b?.price)||0})!==e||!Wn(b)?!1:!Ge(C,s,i,l)});if(!g){h(u("reservations.toast.noAdditionalUnits","âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹"));return}const m=U(g.barcode),f=lt(g);if(!f){h(u("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const v=[...t,{id:f,equipmentId:f,barcode:m,desc:g.desc||g.description||g.name||r.description||"",qty:1,price:Number.isFinite(Number(g.price))?Number(g.price):r.unitPrice,cost:st(g),image:yt(g)}];De(n,v),Be(v),we()}function Br(e,n,t=null){const a=Oe(n),r=Number.isFinite(a)&&a>=0?xe(a):0,{index:s,items:i}=ye();if(!Array.isArray(i))return;const d=dt(i).find(p=>p.key===e);if(!d)return;const l=Number.isInteger(t)?[t]:Array.isArray(d.itemIndices)?d.itemIndices:[];if(!l.length)return;const c=[...i];l.forEach(p=>{if(c[p]){const g={...c[p],cost:r,unit_cost:r,rental_cost:r,purchase_price:r,internal_cost:r,equipment_cost:r};c[p]=g}}),De(s,c),Be(c),we()}function _r(e,n){const t=Oe(n),a=Number.isFinite(t)&&t>=0?xe(t):0,{index:r,items:s}=ye();if(!Array.isArray(s))return;const o=dt(s).find(l=>l.key===e);if(!o||!Array.isArray(o.itemIndices))return;const d=[...s];o.itemIndices.forEach(l=>{d[l]&&(d[l]={...d[l],price:a,unit_price:a})}),De(r,d),Be(d),we()}function On(e){if(!e||e.dataset.groupListenerAttached)return;e.addEventListener("click",a=>{const r=a.target.closest("button[data-action]");if(!r)return;const{action:s,groupKey:i,itemIndex:o}=r.dataset;if(s==="decrease-edit-group"&&i){kr(i);return}if(s==="increase-edit-group"&&i){Ar(i);return}if(s==="remove-edit-group"&&i){wr(i);return}if(s==="remove-edit-item"){const d=Number(o);Number.isNaN(d)||Lr(d)}});const n=a=>{const r=a.target.closest(".reservation-unit-cost-input");if(!r)return;const s=r.dataset.groupKey;if(!s)return;const i=r.dataset.packageIndex??"",o=i!==""?Number.parseInt(i,10):null;Br(s,r.value,Number.isInteger(o)?o:null)},t=a=>{const r=a.target.closest(".reservation-unit-price-input");if(!r)return;const s=r.dataset.groupKey;s&&_r(s,r.value)};e.addEventListener("change",n),e.addEventListener("change",t),e.dataset.groupListenerAttached="true"}function wt(){return!!document.getElementById("edit-res-project")?.value}function Cr(e){if(!e||e.dataset?.linkedGuardAttached==="true")return;const n=new Set([e]);if(e.id){const a=document.querySelector(`label[for="${e.id}"]`);a&&n.add(a)}e.parentElement&&n.add(e.parentElement);const t=a=>{wt()&&(h(u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),"error"),a.stopPropagation(),a.preventDefault())};n.forEach(a=>{!a||a.dataset?.linkedGuardAttached==="true"||(["mousedown","touchstart","keydown"].forEach(r=>a.addEventListener(r,t,{capture:!0})),a.dataset.linkedGuardAttached="true")})}function Pr(e){const n=u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹."),t=document.getElementById("edit-res-tax"),a=document.getElementById("edit-res-company-share"),r=document.getElementById("edit-res-paid"),s=document.getElementById("edit-res-payment-progress-type"),i=document.getElementById("edit-res-payment-progress-value"),o=document.getElementById("edit-res-payment-add"),d=document.getElementById("edit-res-payment-history");if([t,a,r,s,i,o,d].forEach(Cr),e){if(t&&(t.checked=!1,t.disabled=!0,t.classList.add("reservation-input-disabled"),t.title=n),a&&(a.checked=!1,a.disabled=!0,a.classList.add("reservation-input-disabled"),a.title=n),r){const l=document.getElementById("edit-res-project")?.value||"";let c="unpaid";if(l)try{const g=(ue()?.projects||[]).find(f=>String(f.id)===String(l)),m=typeof g?.paymentStatus=="string"?g.paymentStatus.toLowerCase():null;m&&["paid","partial","unpaid"].includes(m)&&(c=m)}catch{}r.value=c,r.disabled=!0,r.classList.add("reservation-input-disabled"),r.title=n,r.dataset&&delete r.dataset.userSelected}s&&(s.value=s.value||"percent",s.disabled=!0,s.classList.add("reservation-input-disabled"),s.title=n),i&&(i.value="",i.disabled=!0,i.classList.add("reservation-input-disabled"),i.title=n),o&&(o.disabled=!0,o.classList.add("reservation-input-disabled"),o.title=n),d&&(d.dataset.linkedDisabled="true")}else t&&(t.disabled=!1,t.classList.remove("reservation-input-disabled"),t.title=""),a&&(a.disabled=!1,a.classList.remove("reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("reservation-input-disabled"),r.title=""),s&&(s.disabled=!1,s.classList.remove("reservation-input-disabled"),s.title=""),i&&(i.disabled=!1,i.classList.remove("reservation-input-disabled"),i.title=""),o&&(o.disabled=!1,o.classList.remove("reservation-input-disabled"),o.title=""),d&&(d.dataset.linkedDisabled="false")}function we(){const e=document.getElementById("edit-res-summary");if(!e)return;Wt();const n=document.getElementById("edit-res-discount"),t=document.getElementById("edit-res-discount-type"),a=document.getElementById("edit-res-paid");a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{a.dataset&&(a.dataset.userSelected="true"),Ce(a),we()}),a.dataset.listenerAttached="true");const r=I(n?.value||"0");n&&(n.value=r);const s=parseFloat(r)||0,i=t?.value||"percent",o=wt();Pr(o);const d=document.getElementById("edit-res-tax"),l=o?!1:d?.checked||!1,c=!o&&a?.dataset?.userSelected==="true";let p="unpaid";if(o){const T=document.getElementById("edit-res-project")?.value||"";if(T)try{const N=(ue()?.projects||[]).find(_=>String(_.id)===String(T)),y=typeof N?.paymentStatus=="string"?N.paymentStatus.toLowerCase():null;y&&["paid","partial","unpaid"].includes(y)&&(p=y)}catch{}}else p=c&&a?.value||"unpaid";let g=null;!o&&l&&(je("edit-res-company-share"),g=ct("edit-res-company-share"),(!Number.isFinite(g)||g<=0)&&(je("edit-res-company-share"),g=ct("edit-res-company-share")));const{items:m=[],payments:f=[]}=ye(),{start:v,end:b}=ut(),C=an({items:m,discount:s,discountType:i,applyTax:l,paidStatus:p,start:v,end:b,companySharePercent:g,paymentHistory:f});e.innerHTML=C;const E=an.lastResult;if(E&&a){const T=E.paymentStatus;c?Ce(a,a.value):(a.value!==T&&(a.value=T),a.dataset&&delete a.dataset.userSelected,Ce(a,T))}else a&&Ce(a,a.value)}function Lr(e){if(e==null)return;const{index:n,items:t}=ye();if(!Array.isArray(t))return;const a=t.filter((r,s)=>s!==e);De(n,a),Be(a),we()}async function qr(e){const n=e?.value??"",t=U(n)||I(String(n)).trim().toLowerCase();if(!t)return;const a=gn(t);if(!a){h(u("reservations.toast.barcodeNotInCatalog","âŒ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¶Ù…Ù† Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const r=Xe(a);if(r==="maintenance"||r==="retired"){h(ot(r));return}const s=U(t),{index:i,items:o=[]}=ye();if(o.findIndex(C=>U(C.barcode)===s)>-1){h(u("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{start:l,end:c}=ut();if(!l||!c){h(u("reservations.toast.requireDatesBeforeAdd","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® ÙˆÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{reservations:p=[]}=ue(),g=i!=null&&p[i]||null,m=g?.id??g?.reservationId??null;if(Ge(s,l,c,m)){h(u("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"));return}const f=lt(a);if(!f){h(u("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const v=typeof st=="function"?st(a):Number.isFinite(Number(a?.cost))?Number(a.cost):0,b=[...o,{id:f,equipmentId:f,barcode:s,desc:a.desc,qty:1,price:a.price,cost:v,image:a.image||a.imageUrl||a.img||null}];De(i,b),e&&(e.value=""),Be(b),we()}async function Ot(e){if(!e)return;const n=e.value.trim();if(!n)return;const t=Ba(n),a=U(t?.barcode||n)||I(String(t?.barcode||n)).trim().toLowerCase();if(!t||!a){h(u("reservations.toast.equipmentNameNotFound","âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø¹Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø®Ù„"));return}const r=Xe(t);if(r==="maintenance"||r==="retired"){h(ot(r));return}const{start:s,end:i}=ut();if(!s||!i){h(u("reservations.toast.requireOverallDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªÙˆØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¬Ø² Ù‚Ø¨Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª"));return}const{index:o,items:d=[]}=ye();if(d.some(b=>U(b.barcode)===a)){h(u("reservations.toast.equipmentDuplicate","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ø­Ø¬Ø²"));return}const{reservations:c=[]}=ue(),p=o!=null&&c[o]||null,g=p?.id??p?.reservationId??null;if(Ge(a,s,i,g)){h(u("reservations.toast.equipmentTimeConflictSimple","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù…Ø­Ø¬ÙˆØ²Ø© ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø²Ù…Ù†ÙŠØ©"));return}const m=lt(t);if(!m){h(u("reservations.toast.equipmentMissingBarcode","âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø¯Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹Ø±Ù"));return}const f=typeof st=="function"?st(t):Number.isFinite(Number(t?.cost))?Number(t.cost):0,v=[...d,{id:m,equipmentId:m,barcode:a,desc:t.desc,qty:1,price:t.price,cost:f,image:t.image||t.imageUrl||t.img||null}];De(o,v),Be(v),we(),e.value=""}function Da(){const e=document.getElementById("edit-res-equipment-description");if(e&&!e.dataset.listenerAttached){e.addEventListener("keydown",t=>{t.key==="Enter"&&(t.preventDefault(),Ot(e))});const n=()=>{_a(e.value,"edit-res-equipment-description-options")&&Ot(e)};e.addEventListener("focus",()=>{if(populateEquipmentDescriptionLists(),typeof e.showPicker=="function")try{e.showPicker()}catch{}}),e.addEventListener("input",n),e.addEventListener("change",n),e.dataset.listenerAttached="true"}}if(typeof document<"u"){document.addEventListener("language:changed",()=>{we()});const e=()=>{hr()};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",e,{once:!0}):e(),document.addEventListener("packages:changed",()=>{Nt()})}typeof window<"u"&&(window.getEditReservationDateRange=ut,window.renderEditPaymentHistory=Wt);function $r(e,n="create"){if(!(!e||!e.value.trim())){if(n==="create"){ln(e);return}Ot(e)}}function ii(){tt(),Da()}function Nr(e,n){const t=document.getElementById(e);if(t){if(t._flatpickr){if(n){const a=t._flatpickr.config?.dateFormat||"Y-m-d";t._flatpickr.setDate(n,!1,a)}else t._flatpickr.clear();return}t.value=n||""}}let ft=null,qe=[],Me=[],mn=null,fe={},Zt=!1,Un=!1;function xr(){if(!Un)try{document.addEventListener("click",e=>{const n=e.target?.closest?.("#save-reservation-changes");if(n){try{if(n.dataset.listenerAttached==="true")return}catch{}try{n.dataset.saving||(n.dataset.saving="true",setTimeout(()=>{try{delete n.dataset.saving}catch{}},1200))}catch{}try{Oa(fe).catch(t=>{console.error("âŒ [reservationsEdit] delegated saveReservationChanges failed",t)})}catch(t){console.error("âŒ [reservationsEdit] delegated saveReservationChanges threw",t)}}},!0),Un=!0}catch(e){console.warn("[reservationsEdit] failed to bind global save delegation",e)}}const Rr="__DEBUG_CREW__";function Tr(){try{if(typeof window<"u"){if(new URLSearchParams(window.location.search||"").get("debugCrew")==="1")return!0;const n=window.localStorage?.getItem(Rr);if(n&&["1","true","on","yes"].includes(String(n).toLowerCase()))return!0}}catch{}return!1}function Gn(e,n){if(Tr())try{console.log(`ğŸªµ [crew-debug:edit] ${e}`,n)}catch{}}function Et(e,{disable:n=!1}={}){const t=document.getElementById("edit-res-confirmed"),a=document.getElementById("edit-res-confirmed-btn"),r=document.getElementById("edit-res-confirmed-wrapper"),s=!!e;if(t&&(t.value=s?"true":"false"),a){const i=u("reservations.edit.confirmation.confirmLabel","âœ… ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯"),o=u("reservations.edit.confirmation.pendingLabel","â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯");a.innerHTML=s?i:o,a.dataset.state=s?"confirmed":"pending",a.classList.toggle("btn-success",s&&!n),a.classList.toggle("btn-outline-secondary",!s||n),a.disabled=n,a.setAttribute("aria-pressed",s?"true":"false")}r&&r.classList.toggle("is-disabled",n)}function bt(){return document.getElementById("edit-res-confirmed")?.value==="true"}function ye(){return{index:ft,items:qe,payments:Me}}function De(e,n,t=Me){ft=typeof e=="number"?e:null,qe=Array.isArray(n)?[...n]:[],Me=Array.isArray(t)?[...t]:[]}function Fa(){ft=null,qe=[],fs(),Me=[]}function Jt(){return[...Me]}function Cn(e){Me=Array.isArray(e)?[...e]:[]}function jr(e){e&&(Me=[...Me,e])}function Dr(e){!Number.isInteger(e)||e<0||(Me=Me.filter((n,t)=>t!==e))}function xt(e,n=1){const t=Number.parseFloat(I(String(e??"")));return!Number.isFinite(t)||t<=0?n:Math.floor(t)}function St(e,n=0){if(e==null||e==="")return n;const t=Number.parseFloat(I(String(e)));return Number.isFinite(t)?Number(t.toFixed(2)):n}function Fr(e={}){if(!e||typeof e!="object")return null;const n=e.equipmentId??e.equipment_id??e.item_id??e.itemId??e.id??null,t=e.barcode??e.normalizedBarcode??"",a=e.normalizedBarcode??(t?U(t):"");return{equipmentId:n!=null?String(n):null,barcode:t,normalizedBarcode:a,desc:e.desc??e.description??e.name??"",qty:xt(e.qty??e.quantity??e.count??1),price:St(e.price??e.unit_price??e.unitPrice??0),cost:St(e.cost??e.unit_cost??e.unitCost??e.rental_cost??e.purchase_price??0),image:e.image??e.image_url??e.imageUrl??null}}function Mr(e,n=0){if(!e||typeof e!="object")return null;const t=ke(e.packageId??e.package_id??e.package_code??e.packageCode??e.code??e.id??`pkg-${n}`)||`pkg-${n}`,a=1,s=(Array.isArray(e.packageItems)&&e.packageItems.length?e.packageItems:bn(e)).map(m=>Fr(m)).filter(Boolean),i=e.total_price??e.totalPrice??e.total??null;let o=St(e.unit_price??e.unitPrice??e.price??null,0);if((!o||o===0)&&i!=null){const m=St(i,0);m>0&&a>0&&(o=Number((m/a).toFixed(2)))}let d=St(e.unit_cost??e.unitCost??e.cost??e.rental_cost??e.purchase_price??e.internal_cost??e.equipment_cost??null,0);(!d||d===0)&&s.length&&(d=0);const l=e.package_code??e.packageCode??e.barcode??null,p=[e.name,e.desc,e.package_name,e.packageName,e.title,e.description,l,t].find(m=>m!=null&&String(m).trim()!=="")||`Package ${t}`,g=e.image??e.cover??e.thumbnail??s.find(m=>m?.image)?.image??null;return{id:e.id!=null?String(e.id):`package::${t}`,type:"package",packageId:t,package_id:t,desc:I(String(p)),name:I(String(p)),qty:a,price:o,cost:d,unit_cost:d,rental_cost:d,purchase_price:d,internal_cost:d,equipment_cost:d,barcode:l,packageItems:s,image:g}}function zr(e,n=[],t=0){!t||t<=0||n.forEach(a=>{if(!a)return;const r=e.get(a);if(r==null)return;const s=r-t;e.set(a,s>0?s:0)})}function Vr(e={},n=[]){const t=Array.isArray(n)?n.map(l=>({...l})):[],a=new Map;Array.isArray(e?.packagesRaw)&&e.packagesRaw.forEach(l=>{if(!l||typeof l!="object")return;const c=ke(l.packageId??l.package_id??l.package_code??l.packageCode??l.code??l.id??"");c&&a.set(c,l)});const s=(Array.isArray(e?.packages)?e.packages:[]).map(l=>{const c=ke(l.packageId??l.package_id??l.package_code??l.packageCode??l.code??l.id??"");if(!c||!a.has(c))return l;const p=Oe(l.unit_cost??l.unitCost??l.cost??l.rental_cost??l.purchase_price??l.internal_cost??l.equipment_cost??l.item_cost);if(Number.isFinite(p)&&p>0)return l;const g=a.get(c),m=Oe(g.unit_cost??g.unitCost??g.cost??g.package_cost??g.rental_cost??g.purchase_price??g.internal_cost??g.equipment_cost??g.item_cost);if(!Number.isFinite(m)||m<=0)return l;const f=xe(m);return{...l,unit_cost:f,unitCost:f,cost:f,rental_cost:l.rental_cost??f,purchase_price:l.purchase_price??f,internal_cost:l.internal_cost??f,equipment_cost:l.equipment_cost??f,item_cost:l.item_cost??f}});if(!s.length)return t;const i=s.map((l,c)=>Mr(l,c)).filter(Boolean);if(!i.length)return t;const o=new Map;i.forEach(l=>{const c=xt(l.qty??l.quantity??1);if(l.barcode){const p=U(l.barcode);if(p){const g=`package::${p}`;o.set(g,(o.get(g)??0)+c)}}(l.packageItems||[]).forEach(p=>{if(!p)return;const g=c*xt(p.qty??p.quantity??1),m=p.equipmentId??null,f=p.normalizedBarcode||(p.barcode?U(p.barcode):null);if(m!=null){const v=`equipment::${String(m)}`;o.set(v,(o.get(v)??0)+g)}if(f){const v=`barcode::${f}`;o.set(v,(o.get(v)??0)+g)}})});const d=[];return t.forEach(l=>{if(!l||typeof l!="object"){d.push(l);return}if(l.type==="package"){const E=ke(l.packageId??l.package_id??l.id??"");i.some(B=>B.packageId===E)||d.push({...l});return}const c=xt(l.qty??l.quantity??1),p=lt(l),g=l.barcode?U(l.barcode):null,m=[];p!=null&&m.push(`equipment::${String(p)}`),g&&m.push(`barcode::${g}`);const f=m.map(E=>o.get(E)??0).filter(E=>E>0);if(!f.length){d.push({...l});return}const v=Math.min(...f);if(v<=0){d.push({...l});return}const b=Math.min(v,c);if(zr(o,m,b),b>=c)return;const C=c-b;d.push({...l,qty:C,quantity:C})}),[...d,...i.map(l=>({...l}))]}function Hr(e,n){return e?typeof n=="function"?n(e):window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function Ma(e,n="percent"){const t=e?.value;return t==="amount"||t==="percent"?t:n}function za(e){if(!e)return null;const n=I(String(e.value||"")).replace("%","").trim();if(!n)return null;const t=Number.parseFloat(n);return!Number.isFinite(t)||t<0?null:t}function Or(e,n){if(e){e.value="";return}}function ht(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function Va(e){if(!e||typeof e!="object")return null;const n=e.type==="amount"||e.type==="percent"?e.type:null,t=Number.parseFloat(I(String(e.value??""))),a=Number.parseFloat(I(String(e.amount??""))),r=Number.parseFloat(I(String(e.percentage??""))),s=Number.isFinite(a)?a:n==="amount"&&Number.isFinite(t)?t:null,i=Number.isFinite(r)?r:n==="percent"&&Number.isFinite(t)?t:null,o=n??(Number.isFinite(s)?"amount":Number.isFinite(i)?"percent":null),d=o==="amount"?s??null:o==="percent"?i??null:Number.isFinite(t)?t:null,l=e.recordedAt??e.recorded_at??new Date().toISOString();return{type:o,value:d,amount:Number.isFinite(s)?s:null,percentage:Number.isFinite(i)?i:null,note:e.note??null,recordedAt:l}}function Ur(e=[],n=null){const t=document.getElementById("edit-res-project");if(!t)return;const a=u("reservations.create.placeholders.project","Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"),r=u("reservations.edit.project.missing","âš ï¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ØºÙŠØ± Ù…ØªÙˆÙØ± (ØªÙ… Ø­Ø°ÙÙ‡)"),s=n?.projectId?String(n.projectId):"",i=Array.isArray(e)?[...e].sort((d,l)=>String(l.createdAt||l.start||"").localeCompare(String(d.createdAt||d.start||""))):[],o=[`<option value="">${ht(a)}</option>`];i.forEach(d=>{o.push(`<option value="${ht(d.id)}">${ht(d.title||a)}</option>`)}),s&&!i.some(d=>String(d.id)===s)&&o.push(`<option value="${ht(s)}">${ht(r)}</option>`),t.innerHTML=o.join(""),s?t.value=s:t.value=""}function Ha(){const e=document.getElementById("edit-res-project"),n=document.getElementById("edit-res-tax"),t=document.getElementById("edit-res-company-share"),a=document.getElementById("edit-res-discount"),r=document.getElementById("edit-res-discount-type"),s=u("reservations.toast.linkedProjectDisabled","Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ…ÙƒÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø› ÙŠØ±Ø¬Ù‰ ØªÙ†ÙÙŠØ° Ù‡Ø°Ù‡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ù…Ù† Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.");if(!!e?.value)n&&(n.checked=!1,n.disabled=!0,n.classList.add("disabled"),n.title=s),t&&(t.checked&&(t.checked=!1),t.disabled=!0,t.classList.add("disabled"),t.title=s),a&&(a.value="0",a.disabled=!0,a.classList.add("disabled","reservation-input-disabled"),a.title=s),r&&(r.value="percent",r.disabled=!0,r.classList.add("disabled","reservation-input-disabled"),r.title=s);else{if(n){const d=n.disabled;n.disabled=!1,n.classList.remove("disabled"),n.title="",d&&(n.checked=!1)}t&&(t.disabled=!1,t.classList.remove("disabled"),t.title=""),a&&(a.disabled=!1,a.classList.remove("disabled","reservation-input-disabled"),a.title=""),r&&(r.disabled=!1,r.classList.remove("disabled","reservation-input-disabled"),r.title="")}pn("tax");const o=fe?.updateEditReservationSummary;typeof o=="function"&&o()}function pn(e){const n=document.getElementById("edit-res-tax"),t=document.getElementById("edit-res-company-share");if(!n||!t)return;const a=()=>{const s=fe?.updateEditReservationSummary;typeof s=="function"&&s()};if(Zt){a();return}Zt=!0;const r=()=>{Zt=!1,a()};if(e==="share")if(t.checked){if(t.dataset.companyShare||(t.dataset.companyShare=String(rt)),n.disabled){t.checked=!1,h(u("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©")),r();return}n.checked||(n.checked=!0),je("edit-res-company-share")}else n.checked&&!n.disabled&&(n.checked=!1);else e==="tax"&&(n.checked?je("edit-res-company-share"):t.checked&&(t.checked=!1));r()}async function Kn(e,{populateEquipmentDescriptionLists:n,setFlatpickrValue:t,splitDateTime:a,renderEditItems:r,updateEditReservationSummary:s,ensureModal:i}={}){const{customers:o,projects:d}=ue();let c=ta()?.[e];if(!c){h(u("reservations.toast.notFound","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²"));return}if(Zn(c))try{const P=await ea(c.id||c.reservationId||c.reservation_code);P&&(c=P)}catch(P){console.warn("[reservationsEdit] Failed to hydrate reservation packages",P)}fe={...fe,reservation:c,projects:d||[]},n?.(),Ur(d||[],c);const p=c.projectId&&d?.find?.(P=>String(P.id)===String(c.projectId))||null,{effectiveConfirmed:g,projectLinked:m}=At(c,p),f=c.items?c.items.map(P=>({...P,equipmentId:P.equipmentId??P.equipment_id??P.id,barcode:U(P?.barcode)})):[],v=Vr(c,f),C=(Array.isArray(c.paymentHistory)?c.paymentHistory:Array.isArray(c.payment_history)?c.payment_history:[]).map(P=>Va(P)).filter(Boolean);De(e,v,C);const E=u("reservations.list.unknownCustomer","ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"),T=o?.find?.(P=>String(P.id)===String(c.customerId));document.getElementById("edit-res-index")?.setAttribute("value",String(e));const B=document.getElementById("edit-res-id");B&&(B.value=c.reservationId||c.id);const N=document.getElementById("edit-res-customer");N&&(N.value=T?.customerName||E);const y=typeof a=="function"?a(c.start):{date:"",time:""},_=typeof a=="function"?a(c.end):{date:"",time:""};t?.("edit-res-start",y.date),t?.("edit-res-start-time",y.time),t?.("edit-res-end",_.date),t?.("edit-res-end-time",_.time);const z=(P,ce,ve)=>{if(!P&&ve)return ve;if(!P)return"";const me=ce&&ce.length?ce:"00:00";return`${P}T${me}`},L=z(y.date,y.time,c.start),se=z(_.date,_.time,c.end);try{window.__EDIT_RESERVATION_RANGE__={start:L||null,end:se||null}}catch{}const V=document.getElementById("edit-res-notes");V&&(V.value=c.notes||"");const X=document.getElementById("edit-res-discount");if(X){const P=m?0:c.discount??0;X.value=I(P)}const oe=document.getElementById("edit-res-discount-type");oe&&(oe.value=m?"percent":c.discountType||"percent");const Q=c.projectId?!1:!!c.applyTax,$=document.getElementById("edit-res-tax");$&&($.checked=Q);const R=document.getElementById("edit-res-company-share");if(R){const P=c.companySharePercent??c.company_share_percent??c.companyShare??c.company_share??null,ce=P!=null?Number.parseFloat(I(String(P).replace("%","").trim())):NaN,ve=c.companyShareEnabled??c.company_share_enabled??c.companyShareApplied??c.company_share_applied??null,me=ve!=null?ve===!0||ve===1||ve==="1"||String(ve).toLowerCase()==="true":Number.isFinite(ce)&&ce>0,mt=me&&Number.isFinite(ce)&&ce>0?ce:rt,Ie=Q||me;R.checked=Ie,R.dataset.companyShare=String(mt)}Et(g,{disable:m});const F=document.getElementById("edit-res-close-btn"),G=document.getElementById("edit-res-reopen-btn");F&&(F.disabled=!(g&&!m)||String(c.status||"").toLowerCase()==="completed"),G&&(G.disabled=String(c.status||"").toLowerCase()!=="completed");const Y=document.getElementById("edit-res-paid"),q=c.paidStatus??(c.paid===!0||c.paid==="paid"?"paid":"unpaid");Y&&(Y.value=q,Y.dataset&&delete Y.dataset.userSelected);const O=document.getElementById("edit-res-payment-progress-type"),re=document.getElementById("edit-res-payment-progress-value");O?.dataset?.userSelected&&delete O.dataset.userSelected,O&&(O.value="percent"),Or(re);const K=document.getElementById("edit-res-cancelled");if(K){const P=String(c?.status||c?.reservationStatus||"").toLowerCase();K.checked=["cancelled","canceled"].includes(P),K.checked&&Et(g,{disable:!0})}let ee=Array.isArray(c.crewAssignments)&&c.crewAssignments.length?c.crewAssignments:Array.isArray(c.techniciansDetails)&&c.techniciansDetails.length?c.techniciansDetails:(c.technicians||[]).map(P=>String(P));if(!Array.isArray(ee)||ee.length===0){const P=ds(c.id??c.reservationId??c.reservation_code??null);Array.isArray(P)&&P.length&&(ee=P)}try{await da()}catch(P){console.warn("[reservationsEdit] positions load failed (non-fatal)",P)}if(ls(ee),r?.(v),typeof window<"u"){const P=window?.renderEditPaymentHistory;typeof P=="function"&&P()}Ha(),s?.();const Le=document.getElementById("editReservationModal");mn=Hr(Le,i),mn?.show?.();try{Gr?.(fe)}catch(P){console.warn("[reservationsEdit] setupEditReservationModalEvents failed (non-fatal)",P)}xr()}async function Oa({combineDateTime:e,hasEquipmentConflict:n,hasPackageConflict:t,hasTechnicianConflict:a,updateEditReservationSummary:r,renderReservations:s,populateEquipmentDescriptionLists:i,handleReservationsMutation:o}={}){if(ft===null){console.warn("âš ï¸ [reservationsEdit.js] No reservation selected for editing");return}const d=document.getElementById("edit-res-start")?.value?.trim(),l=document.getElementById("edit-res-start-time")?.value?.trim()||"00:00",c=document.getElementById("edit-res-end")?.value?.trim(),p=document.getElementById("edit-res-end-time")?.value?.trim()||"00:00",g=document.getElementById("edit-res-notes")?.value||"",m=I(document.getElementById("edit-res-discount")?.value||"0");let f=parseFloat(m)||0,v=document.getElementById("edit-res-discount-type")?.value||"percent";const b=bt(),C=document.getElementById("edit-res-paid"),E=C?.dataset?.userSelected==="true",T=E&&C?.value||"unpaid",B=document.getElementById("edit-res-payment-progress-type"),N=document.getElementById("edit-res-payment-progress-value"),y=Ma(B),_=za(N),z=document.getElementById("edit-res-project")?.value||"",se=document.getElementById("edit-res-cancelled")?.checked===!0,V=us();V.map(S=>S?.technicianId).filter(Boolean);const X=document.getElementById("edit-res-company-share"),oe=document.getElementById("edit-res-tax");if(!d||!c){h(u("reservations.toast.requireDates","âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const Q=typeof e=="function"?e:(S,x)=>`${S}T${x||"00:00"}`,$=Q(d,l),R=Q(c,p);if($&&R&&new Date($)>new Date(R)){h(u("reservations.toast.invalidDateOrder","âš ï¸ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©"));return}const G=ta()?.[ft];if(!G){h(u("reservations.toast.reservationMissing","âš ï¸ ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø² Ø§Ù„Ù…Ø·Ù„ÙˆØ¨"));return}if(!Array.isArray(qe)||qe.length===0&&V.length===0){h(u("reservations.toast.updateNoItems","âš ï¸ ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø¯Ø© Ø£Ùˆ Ø¹Ø¶Ùˆ ÙˆØ§Ø­Ø¯ Ù…Ù† Ø§Ù„Ø·Ø§Ù‚Ù… Ø§Ù„ÙÙ†ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø­Ø¬Ø²"));return}const Y=typeof n=="function"?n:()=>!1,q=G.id??G.reservationId;for(const S of qe){if(S?.type==="package"&&Array.isArray(S.packageItems)){for(const k of S.packageItems){const j=k?.barcode??k?.normalizedBarcode??"";if(!j)continue;const ie=Xe(j);if(ie!=="reserved"&&ie!=="available"){h(ot(ie));return}}continue}const x=Xe(S.barcode);if(x!=="reserved"&&x!=="available"){h(ot(x));return}}{const S=typeof t=="function"?t:()=>!1;for(const x of qe){if(x?.type!=="package")continue;const k=x.packageId??x.package_id??null,j=x.desc||x.packageName||u("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");if(k&&S(k,$,R,q)){const ie=Array.isArray(x?.packageItems)?x.packageItems.map(Z=>U(Z?.barcode??Z?.normalizedBarcode??"")).filter(Boolean):[];let ne=qn(ie,$,R,q);if(!ne.length)try{const Z=new URLSearchParams;Z.set("type","package"),Z.set("id",String(k)),Z.set("start",$),Z.set("end",R),q!=null&&Z.set("ignore",String(q));const H=await Je(`/reservations/availability.php?${Z.toString()}`),le=Array.isArray(H?.conflicts)?H.conflicts:[];ne=Array.from(new Set(le.map(ae=>ae?.reservation_code||(ae?.reservation_id!=null?`#${ae.reservation_id}`:null)).filter(Boolean)))}catch{}const W=ne.length?` (${ne.join("ØŒ ")})`:"";h(u("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${I(String(j))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+W,"warning",-1);return}if(Array.isArray(x?.packageItems)&&x.packageItems.length){const ie=(x.packageItems||[]).map(Z=>U(Z?.barcode??Z?.normalizedBarcode??"")).filter(Boolean),ne=ie.length,W=ie.filter(Z=>Y(Z,$,R,q)).length;if(ne>0&&W>=ne){const Z=(x.packageItems||[]).map(ae=>U(ae?.barcode??ae?.normalizedBarcode??"")).filter(Boolean);let H=qn(Z,$,R,q);if(!H.length)try{const ae=new URLSearchParams;ae.set("type","package"),k!=null&&ae.set("id",String(k)),ae.set("start",$),ae.set("end",R),q!=null&&ae.set("ignore",String(q));const vt=await Je(`/reservations/availability.php?${ae.toString()}`),Xa=Array.isArray(vt?.conflicts)?vt.conflicts:[];H=Array.from(new Set(Xa.map(Qt=>Qt?.reservation_code||(Qt?.reservation_id!=null?`#${Qt.reservation_id}`:null)).filter(Boolean)))}catch{}const le=H.length?` (${H.join("ØŒ ")})`:"";h(u("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${I(String(j))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+le,"warning",6e3);return}}}}const O=[];for(const S of qe){if(S?.type==="package"&&Array.isArray(S.packageItems)){for(const k of S.packageItems){const j=U(k?.barcode??k?.normalizedBarcode??"");if(j&&Y(j,$,R,q)){const ie=k?.desc||k?.barcode||u("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");O.push({label:I(String(ie)),barcode:j})}}continue}const x=U(S.barcode);if(Y(x,$,R,q)){const k=S?.desc||S?.name||S?.barcode||u("reservations.create.packages.unnamedItem","Ù…Ø¹Ø¯Ø© Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…");O.push({label:I(String(k)),barcode:x})}}if(O.length){const S=u("reservations.toast.updateEquipmentConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø£Ø­Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª");let x=null;try{const j=Array.from(new Set(O.map(ne=>ne.barcode).filter(Boolean))),ie=new Map;await Promise.all(j.map(async ne=>{const W=new URLSearchParams;W.set("type","equipment"),W.set("id",ne),W.set("start",$),W.set("end",R),q!=null&&W.set("ignore",String(q));const Z=await Je(`/reservations/availability.php?${W.toString()}`),H=Array.isArray(Z?.conflicts)?Z.conflicts:[],le=Array.from(new Set(H.map(ae=>ae?.reservation_code||(ae?.reservation_id!=null?`#${ae.reservation_id}`:null)).filter(Boolean)));ie.set(ne,le)})),x=O.map(({label:ne,barcode:W})=>{const Z=ie.get(W)||[];return Z.length?`${ne} (${Z.join("ØŒ ")})`:ne}).join("ØŒ ")}catch{}const k=x||O.map(j=>j.label).filter(Boolean).map(String).join("ØŒ ");h(`${S}: ${k}`,"warning",6e3);return}const re=typeof t=="function"?t:()=>!1;for(const S of qe){if(S?.type!=="package")continue;const x=S.packageId??S.package_id??null;if(x&&re(x,$,R,q)){const k=S.desc||S.packageName||u("reservations.create.packages.genericName","Ø§Ù„Ø­Ø²Ù…Ø©");try{const j=new URLSearchParams;j.set("type","package"),j.set("id",String(x)),j.set("start",$),j.set("end",R),q!=null&&j.set("ignore",String(q));const ie=await Je(`/reservations/availability.php?${j.toString()}`),ne=Array.isArray(ie?.conflicts)?ie.conflicts:[],W=Array.from(new Set(ne.map(H=>H?.reservation_code||(H?.reservation_id!=null?`#${H.reservation_id}`:null)).filter(Boolean))),Z=W.length?` (${W.join("ØŒ ")})`:"";h(u("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${I(String(k))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`)+Z,"warning",6e3)}catch{h(u("reservations.toast.packageTimeConflict",`âš ï¸ Ø§Ù„Ø­Ø²Ù…Ø© ${I(String(k))} Ù…Ø­Ø¬ÙˆØ²Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©`),"warning",6e3)}return}}const K=typeof a=="function"?a:()=>!1,ee=[];for(const S of V){if(!S?.technicianId||!K(S.technicianId,$,R,q))continue;const x=S?.technicianName||S?.positionLabel||String(S.technicianId);let k=[];try{k=ia(S.technicianId,$,R,q)}catch{}ee.push({label:I(String(x)),codes:k})}if(ee.length){const S=u("reservations.toast.updateCrewConflict","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¨Ø³Ø¨Ø¨ ØªØ¹Ø§Ø±Ø¶ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø·Ø§Ù‚Ù…"),x=ee.map(({label:k,codes:j})=>j&&j.length?`${k} (${j.join("ØŒ ")})`:k).join("ØŒ ");h(`${S}: ${x}`,"warning",6e3);return}const Le=Array.isArray(fe.projects)&&fe.projects.length?fe.projects:ue().projects||[],P=z&&Le.find(S=>String(S.id)===String(z))||null,ce={...G,projectId:z?String(z):null,confirmed:b},{effectiveConfirmed:ve,projectLinked:me,projectStatus:mt}=At(ce,P);let Ie=!!X?.checked,he=!!oe?.checked;if(me&&(Ie&&(X.checked=!1,Ie=!1),he=!1),!me&&Ie!==he){h(u("reservations.toast.companyShareRequiresTax","âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙØ¹ÙŠÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© Ø¨Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©"));return}he&&(je("edit-res-company-share"),Ie=!!X?.checked);let Ae=Ie?getCompanySharePercent("edit-res-company-share"):null;Ie&&(!Number.isFinite(Ae)||Ae<=0)&&(je("edit-res-company-share"),Ae=getCompanySharePercent("edit-res-company-share"));const We=Ie&&he&&Number.isFinite(Ae)&&Ae>0,ze=me?!1:he;me&&(f=0,v="percent");const Ve=Jn(qe,f,v,ze,V,{start:$,end:R,companySharePercent:We?Ae:0});let Fe=Jt();if(Number.isFinite(_)&&_>0){const S=Ve;let x=null,k=null;y==="amount"?(x=_,S>0&&(k=_/S*100)):(k=_,S>0&&(x=_/100*S));const j=Va({type:y,value:_,amount:x,percentage:k,recordedAt:new Date().toISOString()});j&&(Fe=[...Fe,j],Cn(Fe)),N&&(N.value="")}const w=Tt({totalAmount:Ve,history:Fe}),D=new Map,A=new Map,M=new Map,de=document.getElementById("editReservationModal")||document,te=S=>{const x=ke(S.packageId??S.package_id??S.package_code??S.packageCode??S.barcode??S.id??null);if(x)return x;const k=S.package_code??S.packageCode??S.barcode??null;return k?I(String(k)).trim().toLowerCase():null};de.querySelectorAll(".reservation-unit-cost-input[data-group-key]").forEach(S=>{const x=Oe(S.value),k=Number.isFinite(x)&&x>=0?xe(x):null;if(k===null)return;const j=S.dataset.packageIndex;if(j!==void 0&&j!==""){const W=Number.parseInt(j,10);if(Number.isInteger(W)&&W>=0){A.set(W,k);const Z=qe[W];if(Z){const H=te(Z);H&&M.set(H,k)}}}const ie=S.dataset.packageIdentity;if(ie){const W=ke(ie)||I(String(ie)).trim().toLowerCase();W&&M.set(W,k)}const ne=S.dataset.groupKey;ne&&D.set(ne,k)});const Se=qe.map((S,x)=>{let k=A.has(x)?A.get(x):void 0;if(k===void 0){const j=Te(S);j&&(k=D.get(j))}return k===void 0?S:{...S,cost:k,unit_cost:k,rental_cost:k,purchase_price:k,internal_cost:k,equipment_cost:k}}),_e=jt({manualStatus:T,paidAmount:w.paidAmount,paidPercent:w.paidPercent,totalAmount:Ve});C&&!E&&(C.value=_e,C.dataset&&delete C.dataset.userSelected);let ge=G.status??"pending";me?ge=P?.status??mt??ge:se?ge="cancelled":["completed","cancelled"].includes(String(ge).toLowerCase())||(ge=b?"confirmed":"pending");const Lt=(()=>{const S=[];Se.forEach((k,j)=>{if(String(k?.type||"").toLowerCase()!=="package")return;const ie=Number.isFinite(Number(k.qty??k.quantity))?Number(k.qty??k.quantity):1,ne=Number.isFinite(Number(k.unit_price??k.price))?Number(k.unit_price??k.price):0;let W=Number.isFinite(Number(k.unit_cost??k.cost))?Number(k.unit_cost??k.cost):0;const Z=Te(k),H=te(k),le=(A.has(j)?A.get(j):void 0)??(H?M.get(H):void 0)??(Z!==void 0?D.get(Z):void 0);le!==void 0&&Number.isFinite(le)&&(W=xe(le));const ae=le!==void 0?2:Number.isFinite(W)&&W>0?1:0;S.push({__dedupeKey:H??`pkg-${j}`,__priority:ae,package_code:k.package_code??k.packageCode??k.barcode??k.code??null,name:k.name??k.desc??k.package_name??null,quantity:ie,unit_price:ne,unit_cost:W,package_cost:W,packageCost:W,cost:W,items:Array.isArray(k.packageItems)?k.packageItems:[]})});const x=new Map;return S.forEach(k=>{const j=k.__dedupeKey;(!x.has(j)||(k.__priority??0)>=(x.get(j).__priority??0))&&x.set(j,k)}),Array.from(x.values()).map(k=>{const{__dedupeKey:j,__priority:ie,...ne}=k;return ne})})(),He=Qn({reservationCode:G.reservationCode??G.reservationId??null,customerId:G.customerId,start:$,end:R,status:ge,title:G.title??null,location:G.location??null,notes:g,projectId:z?String(z):null,totalAmount:Ve,discount:f,discountType:v,applyTax:ze,paidStatus:_e,confirmed:ve,items:Se.map(S=>({...S,equipmentId:S.equipmentId??S.id})),crewAssignments:V,companySharePercent:We?Ae:null,companyShareEnabled:We,paidAmount:w.paidAmount,paidPercentage:w.paidPercent,paymentProgressType:w.paymentProgressType,paymentProgressValue:w.paymentProgressValue,paymentHistory:Fe,packages:Lt});try{Gn("about to submit",{editingIndex:ft,crewAssignments:V,techniciansPayload:He?.technicians,payload:He});const S=await ms(G.id||G.reservationId,He);Gn("server response",{reservation:S?.id??S?.reservationId??S?.reservation_code,technicians:S?.technicians,crewAssignments:S?.crewAssignments,techniciansDetails:S?.techniciansDetails}),await ps(),In(),kt(),Bs(),h(u("reservations.toast.updated","âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¬Ø²")),r?.(),Fa(),o?.({type:"updated",reservation:S}),s?.(),i?.(),mn?.hide?.()}catch(S){console.error("âŒ [reservationsEdit] Failed to update reservation",S);const x=Yn(S)?S.message:u("reservations.toast.updateFailed","ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¬Ø²");h(x,"error")}}function Gr(e={}){fe={...e};const{updateEditReservationSummary:n,addEquipmentToEditingReservation:t,addEquipmentByDescription:a,renderEditItems:r}=fe,s=document.getElementById("edit-res-discount");s&&!s.dataset.listenerAttached&&(s.addEventListener("input",()=>{s.value=I(s.value),n?.()}),s.dataset.listenerAttached="true");const i=document.getElementById("edit-res-discount-type");i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>n?.()),i.dataset.listenerAttached="true");const o=document.getElementById("edit-res-tax");o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{pn("tax")}),o.dataset.listenerAttached="true");const d=document.getElementById("edit-res-company-share");d&&!d.dataset.listenerAttached&&(d.addEventListener("change",()=>{pn("share")}),d.dataset.listenerAttached="true");const l=document.getElementById("edit-res-payment-progress-type");l&&!l.dataset.listenerAttached&&(l.addEventListener("change",()=>{l.dataset.userSelected="true",n?.()}),l.dataset.listenerAttached="true");const c=document.getElementById("edit-res-payment-progress-value");c&&!c.dataset.listenerAttached&&(c.addEventListener("input",()=>{c.value=I(c.value)}),c.dataset.listenerAttached="true");const p=["edit-res-start","edit-res-end"],g=["edit-res-start-time","edit-res-end-time"],m=y=>{const _=document.getElementById(y);if(!_||_.dataset.editDateListenerAttached==="true")return;const z=()=>{try{n?.()}catch{}try{const L=typeof ye=="function"?ye().items:[];r?.(L)}catch{}};_.addEventListener("input",z),_.addEventListener("change",z),_.dataset.editDateListenerAttached="true"};p.forEach(m),g.forEach(m),typeof window<"u"&&typeof window.renderEditPaymentHistory=="function"&&window.renderEditPaymentHistory();const f=document.getElementById("edit-res-project");f&&!f.dataset.listenerAttached&&(f.addEventListener("change",()=>{Ha();const y=Array.isArray(fe.projects)&&fe.projects.length?fe.projects:ue().projects||[],_=f.value&&y.find(X=>String(X.id)===String(f.value))||null,L={...fe?.reservation??{},projectId:f.value||null,confirmed:bt()},{effectiveConfirmed:se,projectLinked:V}=At(L,_);Et(se,{disable:V}),n?.()}),f.dataset.listenerAttached="true");const v=document.getElementById("edit-res-confirmed-btn");v&&!v.dataset.listenerAttached&&(v.addEventListener("click",()=>{if(v.disabled)return;const y=!bt();Et(y);const _=document.getElementById("edit-res-close-btn");_&&(_.disabled=!y),n?.()}),v.dataset.listenerAttached="true");const b=document.getElementById("edit-res-cancelled");b&&!b.dataset.listenerAttached&&(b.addEventListener("change",()=>{document.getElementById("edit-res-confirmed-btn")&&Et(bt(),{disable:b.checked});const _=document.getElementById("edit-res-close-btn");_&&(_.disabled=b.checked||!bt()),n?.()}),b.dataset.listenerAttached="true");const C=document.getElementById("save-reservation-changes");C&&!C.dataset.listenerAttached&&(C.addEventListener("click",()=>{Oa(fe).catch(y=>{console.error("âŒ [reservationsEdit] saveReservationChanges failed",y)})}),C.dataset.listenerAttached="true");const E=document.getElementById("edit-res-close-btn");E&&!E.dataset.listenerAttached&&(E.addEventListener("click",()=>{try{const{index:y}=ye(),_=document.getElementById("closeReservationModal"),z=document.getElementById("close-reservation-notes"),L=document.getElementById("close-reservation-submit"),se=document.getElementById("edit-res-notes")?.value||"";if(z&&(z.value=se),L&&L.__tmpCloseListener&&(L.removeEventListener("click",L.__tmpCloseListener),L.__tmpCloseListener=null),L){const V=async()=>{const X=z?.value||"";try{await ua(y,X,{onAfterChange:fe?.handleReservationsMutation})}finally{try{((window.bootstrap?.Modal||bootstrap?.Modal)?.getInstance?.(_)||(window.bootstrap?.Modal||bootstrap?.Modal)?.getOrCreateInstance?.(_))?.hide?.()}catch{}}};L.__tmpCloseListener=V,L.addEventListener("click",V,{once:!0})}_&&(window.bootstrap?.Modal||typeof bootstrap<"u"&&bootstrap?.Modal)&&(window.bootstrap?.Modal||bootstrap.Modal).getOrCreateInstance(_).show()}catch(y){console.warn("[reservationsEdit] failed to open close modal",y)}}),E.dataset.listenerAttached="true");const T=document.getElementById("edit-res-reopen-btn");T&&!T.dataset.listenerAttached&&(T.addEventListener("click",async()=>{try{const{index:y}=ye();await ma(y,{onAfterChange:fe?.handleReservationsMutation});try{document.getElementById("edit-res-close-btn").disabled=!1}catch{}try{T.disabled=!0}catch{}}catch(y){console.warn("[reservationsEdit] failed to reopen reservation",y)}}),T.dataset.listenerAttached="true");const B=document.getElementById("edit-res-equipment-barcode");if(B&&!B.dataset.listenerAttached){let y=null;const _=()=>{B.value?.trim()&&(clearTimeout(y),y=null,t?.(B))};B.addEventListener("keydown",L=>{L.key==="Enter"&&(L.preventDefault(),_())});const z=()=>{if(clearTimeout(y),!B.value?.trim())return;const{start:L,end:se}=getEditReservationDateRange();!L||!se||(y=setTimeout(()=>{_()},150))};B.addEventListener("input",z),B.addEventListener("change",_),B.dataset.listenerAttached="true"}Da?.();const N=document.getElementById("editReservationModal");N&&!N.dataset.cleanupAttached&&(N.addEventListener("hidden.bs.modal",()=>{Fa(),n?.(),r?.([])}),N.dataset.cleanupAttached="true")}function oi(){return xs().catch(e=>{console.warn("âš ï¸ [reservations/controller] Failed to refresh projects before loading form",e)}).finally(()=>{const{technicians:e}=ue()||{};gs(e||[]),ja()})}function Pt(e=null){ja(),Ua(),typeof window.refreshCustomerReservationsViews=="function"&&window.refreshCustomerReservationsViews(),typeof window.refreshTechnicianReservationsViews=="function"&&window.refreshTechnicianReservationsViews();const n=e!=null?{detail:e}:{};document.dispatchEvent(new CustomEvent("reservations:changed",n))}function Kr(e){return e?window?.bootstrap?.Modal?window.bootstrap.Modal.getOrCreateInstance(e):typeof bootstrap<"u"&&bootstrap?.Modal?bootstrap.Modal.getOrCreateInstance(e):null:null}function fn(){return{populateEquipmentDescriptionLists:tt,setFlatpickrValue:Nr,splitDateTime:oa,renderEditItems:Be,updateEditReservationSummary:we,addEquipmentByDescription:$r,addEquipmentToEditingReservation:qr,addEquipmentToEditingByDescription:Ot,combineDateTime:it,hasEquipmentConflict:Ge,hasTechnicianConflict:ra,renderReservations:Ua,handleReservationsMutation:Pt,ensureModal:Kr}}function Ua(e="reservations-list",n=null){fr({containerId:e,filters:n,onShowDetails:Ga,onConfirmReservation:Wa,onCloseReservation:Wr,onReopenReservation:Ja})}function Ga(e){return gr(e,{getEditContext:fn,onEdit:(n,{reservation:t})=>{Ya(n,t)},onDelete:Ka})}function Ka(e){return es()?window.confirm(u("reservations.toast.deleteConfirm","âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¬Ø²ØŸ"))?$s(e,{onAfterChange:Pt}):!1:(ts(),!1)}function Wa(e){return Ns(e,{onAfterChange:Pt})}function Ja(e){return ma(e,{onAfterChange:Pt})}let Rt=null;function Qa(){const e=document.getElementById("closeReservationModal"),n=document.getElementById("close-reservation-notes"),t=document.getElementById("close-reservation-submit"),a=document.getElementById("close-reservation-cancel");return{modal:e,note:n,submit:t,cancel:a}}function Wr(e){Rt=e;const{modal:n,note:t}=Qa();t&&(t.value=""),n&&(window.bootstrap?.Modal||typeof bootstrap<"u"&&bootstrap?.Modal)&&(window.bootstrap?.Modal||bootstrap.Modal).getOrCreateInstance(n).show()}function Jr(){const{modal:e,note:n,submit:t,cancel:a}=Qa();e&&(t&&!t.dataset.listenerAttached&&(t.addEventListener("click",async()=>{const r=n?.value||"";try{await ua(Rt,r,{onAfterChange:Pt})}finally{try{((window.bootstrap?.Modal||bootstrap?.Modal)?.getInstance?.(e)||(window.bootstrap?.Modal||bootstrap?.Modal)?.getOrCreateInstance?.(e))?.hide?.()}catch{}Rt=null}}),t.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("click",()=>{Rt=null}),a.dataset.listenerAttached="true"))}function Ya(e,n=null){if(document.getElementById("reservation-form")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (inline form)",s)}Kn(e,fn());return}if(document.getElementById("editReservationModal")){try{localStorage.removeItem("pendingReservationEditId"),localStorage.removeItem("pendingReservationEditIndex")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to clear pending edit id (modal)",s)}Kn(e,fn());return}const t=new URLSearchParams;if(n?.id||n?.reservationId){const s=n.id??n.reservationId;t.set("reservationEditId",String(s));try{localStorage.setItem("pendingReservationEditId",String(s)),localStorage.removeItem("pendingReservationEditIndex")}catch(i){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit id",i)}}else{t.set("reservationEditIndex",String(e));try{localStorage.setItem("pendingReservationEditIndex",String(e)),localStorage.removeItem("pendingReservationEditId")}catch(s){console.warn("âš ï¸ [reservations/controller] Unable to persist pending edit index",s)}}ns({dashboardTab:"reservations-tab",dashboardSubTab:"my-reservations-tab"}).catch(s=>{console.warn("âš ï¸ [reservations/controller] Failed to persist tab preference",s)});const a=t.toString(),r=a?`dashboard.html?${a}#reservations`:"dashboard.html#reservations";window.location.href=r}function ci(){_s({showReservationDetails:Ga,deleteReservation:Ka,confirmReservation:Wa,openReservationEditor:Ya,reopenReservation:Ja});try{Jr()}catch{}}export{ii as a,Ua as b,ja as c,J as d,Ga as e,Ka as f,fn as g,Pt as h,ri as i,Wa as j,Nr as k,oi as l,Ya as o,ci as r,Gr as s,we as u};
