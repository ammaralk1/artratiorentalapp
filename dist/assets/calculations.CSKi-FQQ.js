import{n as v,a as G,i as Q,A as tt,f as et,z as $}from"./reservationsService.tp7XXG28.js";import{t as nt,n as F,p as j}from"./auth.qvLeLYB1.js";const h={filters:{range:"all",status:"all",payment:"all",share:"all",search:"",start:null,end:null},data:{reservations:[],customers:[],equipment:[],technicians:[],projects:[],maintenance:[],projectsMap:new Map},formatters:{cachedLocale:null,numberFormatter:null},initialized:!1,languageListenerAttached:!1,searchDebounceTimer:null,loading:!1,errorMessage:"",emptyDefaults:{icon:null,title:null,subtitle:null},dataListenersAttached:!1,loadedScripts:new Map,apexChartsReady:null,html2PdfReady:null,xlsxReady:null,techniciansIndex:null,charts:{trend:null,status:null,payment:null},chartsMeta:{trend:{categoriesSig:"",theme:""},status:{labelsSig:"",theme:""},payment:{labelsSig:"",theme:""}},lastSnapshot:{filtered:[],metrics:null,trend:[],statusBreakdown:[],paymentBreakdown:[],tableRows:[],maintenance:{total:0,items:[]}},columnPreferences:{code:!0,customer:!0,date:!0,status:!0,payment:!0,total:!0,share:!0,net:!0},exportHandlersBound:!1,columnControlsBound:!1,drilldownBound:!1,lastTrendData:[],lastStatusData:[],lastPaymentData:[],themeListenerAttached:!1,startDatePicker:null,endDatePicker:null,startDateInputRef:null,endDateInputRef:null,callbacks:{onRender:null,onBeforeRender:null,onAfterRender:null,onTrendDrilldown:null,onStatusDrilldown:null,onPaymentDrilldown:null},sort:{key:"date",dir:"desc"},pagination:{page:1,pageSize:50}};function ut(t){h.callbacks.onRender=typeof t=="function"?t:null}function dt(t){h.callbacks.onBeforeRender=typeof t=="function"?t:null}function mt(t){h.callbacks.onAfterRender=typeof t=="function"?t:null}function pt(t){h.callbacks.onTrendDrilldown=typeof t=="function"?t:null}function ft(t){h.callbacks.onStatusDrilldown=typeof t=="function"?t:null}function ht(t){h.callbacks.onPaymentDrilldown=typeof t=="function"?t:null}function E(t){if(h.loadedScripts.has(t))return h.loadedScripts.get(t);const n=typeof document<"u"?document.querySelector(`script[src="${t}"]`):null,s=new Promise((a,o)=>{const e=()=>{n&&(n.dataset.loaded="true"),a()},r=l=>o(l);if(n){if(n.dataset.loaded==="true"){a();return}n.addEventListener("load",e,{once:!0}),n.addEventListener("error",r,{once:!0});return}const u=document.createElement("script");u.src=t,u.async=!0,u.onload=()=>{u.dataset.loaded="true",a()},u.onerror=l=>o(l),document.head.appendChild(u)});return h.loadedScripts.set(t,s),s}function gt(){return typeof window<"u"&&window.ApexCharts?Promise.resolve(window.ApexCharts):(h.apexChartsReady||(h.apexChartsReady=E("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),h.apexChartsReady)}function yt(){return typeof window<"u"&&window.html2pdf?Promise.resolve(window.html2pdf):(h.html2PdfReady||(h.html2PdfReady=E("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),h.html2PdfReady)}function wt(){return typeof window<"u"&&window.XLSX?Promise.resolve(window.XLSX):(h.xlsxReady||(h.xlsxReady=E("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),h.xlsxReady)}function bt(){return typeof window<"u"&&window.JSZip?Promise.resolve(window.JSZip):(h.jsZipReady||(h.jsZipReady=E("https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js").then(()=>window.JSZip)),h.jsZipReady)}function D(t,n,s=n){const o=j()==="en"?s??n:n;return nt(t,o)}function Dt(){h.formatters.cachedLocale=null,h.formatters.numberFormatter=null}function I(){return(j()||"ar").toLowerCase().startsWith("ar")?"ar-SA-u-ca-gregory-nu-latn":"en-US"}function K(){const t=j();if(t!==h.formatters.cachedLocale||!h.formatters.numberFormatter||!h.formatters.currencyFormatter){h.formatters.cachedLocale=t;const n=I();h.formatters.numberFormatter=new Intl.NumberFormat(n,{maximumFractionDigits:0}),h.formatters.currencyFormatter=new Intl.NumberFormat(n,{minimumFractionDigits:2,maximumFractionDigits:2})}return{numberFormatter:h.formatters.numberFormatter,currencyFormatter:h.formatters.currencyFormatter}}function St(t){const{numberFormatter:n}=K(),s=n.format(Math.round(t||0));return F(s)}function Nt(t){const{currencyFormatter:n}=K(),s=Number.isFinite(Number(t))?Number(t):0,a=n.format(s);return`${F(a)} SR`}function k(t){const n=t instanceof Date?t:new Date(t);if(!(n instanceof Date)||Number.isNaN(n.getTime()))return"";const s=n.getFullYear(),a=String(n.getMonth()+1).padStart(2,"0"),o=String(n.getDate()).padStart(2,"0");return`${s}-${a}-${o}`}function Mt(t){if(!t)return"—";const n=t instanceof Date?t:new Date(t);if(Number.isNaN(n.getTime()))return"—";const s=new Intl.DateTimeFormat(I(),{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return F(s.format(n))}function X(t){return new Intl.DateTimeFormat(I(),{month:"short"}).format(t)}const at=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"],["ملغية","cancelled"],["ملغى","cancelled"],["canceled","cancelled"]]),q=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]),L=1440*60*1e3,N={metrics:new Map,trend:new Map,status:new Map,payment:new Map,topCustomers:new Map,topEquipment:new Map};function C(t){const n=Array.isArray(t)?t.length:0;if(n===0)return"0|";const s=t[0]||{},a=t[n-1]||{},o=`${s.id??s.reservationId??""}-${s.start??""}`,e=`${a.id??a.reservationId??""}-${a.start??""}`,r=h.formatters?.cachedLocale||"ar";return`${n}|${o}|${e}|${r}`}function R(t,n){return t.get(n)}function x(t,n,s){if(t.set(n,s),t.size>64){const a=t.keys().next().value;t.delete(a)}return s}function Z(t){return F(String(t||"")).toLowerCase().trim()}function P(t){return(t||"").toString().trim()}function O(t,n){if(!t||!n)return 1;const s=new Date(t),a=new Date(n);if(Number.isNaN(s.getTime())||Number.isNaN(a.getTime()))return 1;const o=a.getTime()-s.getTime();return o<=0?1:Math.max(1,Math.ceil(o/L))}function B(t){return t?(h.techniciansIndex||(h.techniciansIndex=new Map((h.data.technicians||[]).map(n=>[String(n.id),n]))),h.techniciansIndex.get(String(t))||null):null}function Y(t={}){const n=[t.dailyWage,t.daily_rate,t.dailyRate,t.wage,t.rate];for(const s of n){if(s==null)continue;const a=Number.parseFloat(F(String(s)));if(Number.isFinite(a))return a}return 0}function V(t={}){const n=[t.dailyTotal,t.daily_total,t.totalRate,t.total,t.total_wage];for(const s of n){if(s==null)continue;const a=Number.parseFloat(F(String(s)));if(Number.isFinite(a))return a}return Y(t)}function A(t){if(!t)return{rentalDays:1,equipmentTotal:0,crewTotal:0,crewCostTotal:0,discountAmount:0,subtotalAfterDiscount:0,taxableAmount:0,taxAmount:0,finalTotal:0,companySharePercent:0,companyShareAmount:0,netProfit:0};if(t.__financials)return t.__financials;O(t.start,t.end);const n=Number(t.discount??t.discountValue??0)||0,s=t.discountType||t.discount_type||"percent",a=String(s).toLowerCase()==="amount"?"amount":"percent",o=t.applyTax===!0||t.apply_tax===!0||t.apply_tax===1||t.apply_tax==="1",e=t.companySharePercent??t.company_share_percent??t.companyShare??t.company_share??null,r=e!=null?tt(e):Number.NaN,l=(t.companyShareEnabled??t.company_share_enabled??t.companyShareApplied??t.company_share_applied??null)===!0&&Number.isFinite(r)&&r>0?r:null,d=Array.isArray(t.crewAssignments)?t.crewAssignments:[],m=d.length?d.map(y=>y?.technicianId).filter(Boolean):Array.isArray(t.technicians)?t.technicians:[],c=et({items:Array.isArray(t.items)?t.items:[],technicianIds:m,crewAssignments:d,discount:n,discountType:a,applyTax:o,start:t.start,end:t.end,companySharePercent:l}),i=Number(t.cost);let p=c.finalTotal,f=c.taxAmount;if(Number.isFinite(i)&&i>0&&(p=$(i),o)){const y=p-c.taxableAmount;Number.isFinite(y)&&y>=0&&(f=$(y))}const g={rentalDays:c.rentalDays,equipmentTotal:c.equipmentTotal,crewTotal:c.crewTotal,crewCostTotal:c.crewCostTotal,discountAmount:c.discountAmount,subtotalAfterDiscount:c.subtotalAfterDiscount,taxableAmount:c.taxableAmount,taxAmount:f,finalTotal:p,companySharePercent:c.companySharePercent,companyShareAmount:c.companyShareAmount,netProfit:c.netProfit,companyShareEnabled:c.companySharePercent>0};return t.__financials=g,g}function U(t){return t?.projectId&&h.data.projectsMap.get(String(t.projectId))||null}function z(t=""){const n=String(t).toLowerCase().trim();return n?at.get(n)||n:""}function rt(t){const n=[t?.paymentStatus,t?.payment_status,t?.payment,t?.paymentState,t?.payment_state];for(const s of n){const a=String(s||"").toLowerCase().trim();if(a&&q.has(a))return q.get(a)}return t?.paid===!0||t?.paid==="true"}function S(t){const n=U(t),s=G(t,n),a=z(s.projectStatus);let o=z(t?.status??t?.reservationStatus??t?.reservation_status??t?.state??"");s.projectLinked&&a&&o!=="cancelled"&&(o=a),o||(o=s.effectiveConfirmed?"confirmed":"pending"),o!=="cancelled"&&(Q(t)||a==="completed")&&(o="completed");let e=s.effectiveConfirmed||o==="confirmed"||o==="completed";o==="cancelled"&&(e=!1),e&&o!=="completed"&&o!=="cancelled"&&(o="confirmed");const r=rt(t),u=t?.paidStatus??t?.paid_status??(r?"paid":"unpaid");return{statusValue:o,confirmed:e,paid:r,paidStatus:u}}function Tt(t){const n=t.length;let s=0,a=0,o=0,e=0,r=0,u=0,l=0,d=0,m=0,c=0;t.forEach(p=>{const{statusValue:f,confirmed:g,paid:y}=S(p);if(f==="completed"&&(a+=1),f==="cancelled"&&(o+=1),g&&(s+=1),y&&f!=="cancelled"&&(e+=1),f!=="cancelled"){const w=A(p);r+=w.finalTotal,u+=w.companyShareAmount,l+=w.taxAmount,d+=w.crewTotal,m+=w.crewCostTotal??0,c+=w.netProfit}});const i=n?r/n:0;return{total:n,confirmed:s,completed:a,cancelled:o,activeTotal:Math.max(0,n-o),paidCount:e,revenue:r,average:i,companyShareTotal:u,taxTotal:l,crewTotal:d,crewCostTotal:m,netProfit:c}}function W({range:t,start:n,end:s}){const a=new Date;if(a.setHours(23,59,59,999),t==="custom"){const r=n?new Date(`${n}T00:00:00`):null,u=s?new Date(`${s}T23:59:59`):null;return{startDate:H(r)?r:null,endDate:H(u)?u:null}}let o=new Date(a),e=null;switch(t){case"last30":{e=new Date(a),e.setDate(e.getDate()-29);break}case"thisWeek":{const r=new Date(a),l=(r.getDay()-6+7)%7;r.setDate(r.getDate()-l),r.setHours(0,0,0,0);const d=new Date(r);d.setDate(r.getDate()+6),d.setHours(23,59,59,999),e=r,o=d;break}case"thisMonth":{e=new Date(a.getFullYear(),a.getMonth(),1),o=new Date(a.getFullYear(),a.getMonth()+1,0),o.setHours(23,59,59,999);break}case"thisQuarter":{const r=Math.floor(a.getMonth()/3);e=new Date(a.getFullYear(),r*3,1),o=new Date(a.getFullYear(),(r+1)*3,0),o.setHours(23,59,59,999);break}case"thisYear":{e=new Date(a.getFullYear(),0,1),o=new Date(a.getFullYear(),12,0),o.setHours(23,59,59,999);break}case"all":default:e=null,o=null;break}return e&&e.setHours(0,0,0,0),{startDate:e,endDate:o}}function H(t){return t instanceof Date&&!Number.isNaN(t.getTime())}function Ft(t,n){const{startDate:s,endDate:a}=W(n);let o=0;const e=[];return(t||[]).forEach(r=>{if(!r)return;const u=typeof r.repairCost=="number"?r.repairCost:Number.parseFloat(F(String(r.repairCost??"")));if(!Number.isFinite(u)||u<=0)return;const l=String(r.statusRaw??r.status??"").toLowerCase();if(!(l==="closed"||l==="completed"||l==="cancelled"))return;const m=r.resolvedAt??r.resolved_at??null,c=r.reportedAt??r.reported_at??null,i=r.createdAt??r.created_at??null,p=m?new Date(m):null,f=c?new Date(c):i?new Date(i):null,g=p&&!Number.isNaN(p.getTime())?p:f&&!Number.isNaN(f.getTime())?f:null;if(g&&(s&&g<s||a&&g>a))return;const y=Math.round(u*100)/100;o+=y,e.push({id:r.id,cost:y,date:g})}),{total:o,items:e}}function At(t,n){const s=Number.isFinite(n)?n:0;return{...t,maintenanceExpense:s,netProfit:(t.netProfit||0)-s}}function Ct(t){const n=`trend:${C(t)}`,s=R(N.trend,n);if(s)return s;const a=new Date,o=[],e=(t||[]).map(l=>l?.start?new Date(l.start):null).filter(l=>l&&!Number.isNaN(l.getTime()));let r=6,u=new Date(a.getFullYear(),a.getMonth(),1);if(e.length){const l=new Date(Math.min(...e.map(f=>f.getTime()))),d=new Date(Math.max(...e.map(f=>f.getTime()))),m=new Date(l.getFullYear(),l.getMonth(),1);u=new Date(d.getFullYear(),d.getMonth(),1);const c=u.getFullYear()-m.getFullYear(),i=u.getMonth()-m.getMonth(),p=c*12+i;r=Math.min(12,Math.max(6,p+1))}for(let l=r-1;l>=0;l-=1){const d=new Date(u.getFullYear(),u.getMonth()-l,1),m=d.getFullYear(),c=d.getMonth(),i=t.filter(M=>{const T=M?.start?new Date(M.start):null;return T&&T.getFullYear()===m&&T.getMonth()===c}).filter(M=>S(M).statusValue!=="cancelled"),p=i.length;let f=0,g=0,y=0;i.forEach(M=>{const T=A(M);f+=T.finalTotal,g+=T.netProfit,y+=T.companyShareAmount});const w=X(d),b=new Date(d.getFullYear(),d.getMonth(),1),_=new Date(d.getFullYear(),d.getMonth()+1,0);o.push({label:w,count:p,revenue:f,netProfit:g,companyShare:y,periodStart:b,periodEnd:_,startInput:k(b),endInput:k(_)})}try{const l=new Map;(t||[]).forEach(c=>{if(S(c).statusValue==="cancelled")return;const i=c?.start?new Date(c.start):null;if(!i||Number.isNaN(i.getTime()))return;const p=`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}`,f=A(c),g=l.get(p)||0;l.set(p,g+(Number(f.finalTotal)||0))});const d=o.map(c=>Number(c.revenue||0)),m=o.map((c,i)=>i<2?null:(d[i]+d[i-1]+d[i-2])/3);o.forEach((c,i)=>{const p=i>0?Number(o[i-1]?.revenue||0):null;let f=null;p!=null&&Number.isFinite(p)&&p>0&&(f=(Number(c.revenue||0)-p)/p*100);const g=c.periodStart instanceof Date?c.periodStart:null;let y=null;if(g&&!Number.isNaN(g.getTime())){const w=`${g.getFullYear()-1}-${String(g.getMonth()+1).padStart(2,"0")}`,b=l.get(w);Number.isFinite(b)&&b>0&&(y=(Number(c.revenue||0)-b)/b*100)}c.momChange=f,c.yoyChange=y,c.movingAvgRevenue=m[i]})}catch{}return x(N.trend,n,o)}function Rt(t){const n=new Date,s=(t||[]).map(r=>r?.start?new Date(r.start):null).filter(r=>r&&!Number.isNaN(r.getTime()));let a=6,o=new Date(n.getFullYear(),n.getMonth(),1);if(s.length){const r=new Date(Math.min(...s.map(i=>i.getTime()))),u=new Date(Math.max(...s.map(i=>i.getTime()))),l=new Date(r.getFullYear(),r.getMonth(),1);o=new Date(u.getFullYear(),u.getMonth(),1);const d=o.getFullYear()-l.getFullYear(),m=o.getMonth()-l.getMonth(),c=d*12+m;a=Math.min(12,Math.max(6,c+1))}const e=[];for(let r=a-1;r>=0;r-=1){const u=new Date(o.getFullYear(),o.getMonth()-r,1),l=u.getFullYear(),d=u.getMonth();let m=0,c=0;(t||[]).forEach(i=>{const p=i?.start?new Date(i.start):null;if(!p||p.getFullYear()!==l||p.getMonth()!==d)return;const{statusValue:f,confirmed:g}=S(i);f==="cancelled"?c+=1:(g||f==="confirmed"||f==="completed")&&(m+=1)}),e.push({label:X(u),confirmed:m,cancelled:c})}return e}function xt(t){const n=`status:${C(t)}`,s=R(N.status,n);if(s)return s;const a={confirmed:0,pending:0,completed:0,cancelled:0};(t||[]).forEach(m=>{const{statusValue:c,confirmed:i}=S(m);c==="completed"?a.completed+=1:c==="cancelled"?a.cancelled+=1:c==="confirmed"||i?a.confirmed+=1:a.pending+=1});const o=Math.max(1,(t||[]).length),e=a.confirmed,r=a.pending,u=a.completed,l=a.cancelled,d=[{label:D("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:e,percent:Math.round(e/o*100)||0,rawCount:e,className:"status-confirmed",filterKey:"confirmed"},{label:D("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:r,percent:Math.round(r/o*100)||0,rawCount:r,className:"status-pending",filterKey:"pending"},{label:D("reservations.reports.status.completedLabel","منتهية","Completed"),value:u,percent:Math.round(u/o*100)||0,rawCount:u,className:"status-completed",filterKey:"completed"},{label:D("reservations.reports.status.cancelledLabel","ملغاة","Cancelled"),value:l,percent:Math.round(l/o*100)||0,rawCount:l,className:"status-cancelled",filterKey:"cancelled"}];return x(N.status,n,d)}function Pt(t){const n=`payment:${C(t)}`,s=R(N.payment,n);if(s)return s;const a=t.length||1;let o=0,e=0,r=0;(t||[]).forEach(l=>{const{paidStatus:d}=S(l);d==="paid"?o+=1:d==="partial"?e+=1:r+=1});const u=[{label:D("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:o,percent:Math.round(o/a*100)||0,rawCount:o,className:"status-paid",filterKey:"paid"},{label:D("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"),value:e,percent:Math.round(e/a*100)||0,rawCount:e,className:"status-partial",filterKey:"partial"},{label:D("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:r,percent:Math.round(r/a*100)||0,rawCount:r,className:"status-unpaid",filterKey:"unpaid"}];return x(N.payment,n,u)}function Et(t,n){const s=`topCustomers:${C(t)}`,a=R(N.topCustomers,s);if(a)return a;const o=new Map,e=new Map((n||[]).map(u=>[String(u.id),u]));t.forEach(u=>{const{statusValue:l}=S(u);if(l==="cancelled")return;const d=String(u?.customerId??"unknown"),m=o.get(d)||{count:0,revenue:0},c=A(u);m.count+=1,m.revenue+=c.finalTotal,o.set(d,m)});const r=Array.from(o.entries()).map(([u,l])=>({name:e.get(u)?.customerName||D("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:l.count,revenue:l.revenue})).sort((u,l)=>l.revenue-u.revenue).slice(0,5);return x(N.topCustomers,s,r)}function _t(t,n){const s=`topEquipment:${C(t)}`,a=R(N.topEquipment,s);if(a)return a;const o=new Map,e=new Map((n||[]).map(l=>[P(l?.barcode),l])),r=D("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment");t.forEach(l=>{(l?.items||[]).forEach(d=>{const m=P(d?.barcode),c=m?e.get(m):null,i=d?.desc||d?.description||d?.name||c?.desc||c?.description||c?.name||"",p=i&&i.trim()?i:r,f=v(p)||"unknown",g=Number(d?.qty)||1,y=Number(d?.price)||0,w=g*y,b=o.get(f)||{name:p,count:0,revenue:0};b.name=p,b.count+=g,b.revenue+=w,o.set(f,b)})});const u=Array.from(o.values()).sort((l,d)=>d.count!==l.count?d.count-l.count:d.revenue-l.revenue).slice(0,5);return x(N.topEquipment,s,u)}function kt(){Object.values(N).forEach(t=>t.clear())}function ot(t,n,s,a,o){const e=[],r=t?.reservationId||t?.id;r&&e.push(r),t?.notes&&e.push(t.notes);const{statusValue:u,paidStatus:l}=S(t);u&&e.push(u);const d=t?.paymentStatus||t?.payment_status;d&&e.push(d),t?.paid!=null&&e.push(t.paid?"paid":"unpaid"),l&&e.push(l);const m=s.get(String(t?.customerId));m&&e.push(m.customerName,m.company_name||m.companyName,m.contact_person||"");const c=U(t);return c&&e.push(c.title,c.code,c.status),e.push(st(l)),(t?.items||[]).forEach(p=>{p?.desc&&e.push(p.desc),p?.barcode&&e.push(p.barcode);const f=a.get(P(p?.barcode));f&&e.push(f.desc,f.description,f.name)}),(t?.technicians||[]).forEach(p=>{const f=o.get(String(p));f&&e.push(f.name,f.role,f.department)}),Z(e.filter(Boolean).join(" ")).includes(n)}function Lt(t,n,s,a,o){const{startDate:e,endDate:r}=W(n),u=Z(n.search),l=!!u,d=new Map((s||[]).map(i=>[String(i.id),i])),m=new Map((a||[]).map(i=>[P(i?.barcode),i])),c=new Map((o||[]).map(i=>[String(i.id),i]));return(t||[]).filter(i=>{if(i&&i.projectId!=null&&String(i.projectId).trim()!=="")return!1;const p=i?.start?new Date(i.start):null;if(!p||Number.isNaN(p.getTime()))return!1;let f=i?.end?new Date(i.end):p;if(Number.isNaN(f.getTime())&&(f=p),e&&f<e||r&&p>r)return!1;const{statusValue:g,confirmed:y,paid:w,paidStatus:b}=S(i);if(n.status==="confirmed"&&!(g==="confirmed"||g==="completed"||y)||n.status==="pending"&&g!=="pending"||n.status==="completed"&&g!=="completed"||n.status==="cancelled"&&g!=="cancelled"||n.payment==="paid"&&!w||n.payment==="unpaid"&&w||n.payment==="partial"&&b!=="partial")return!1;if(n.share&&n.share!=="all"){const M=A(i).companySharePercent>0;if(n.share==="with"&&!M||n.share==="without"&&M)return!1}return!(l&&!ot(i,u,d,m,c))})}function st(t){const n=String(t??"").toLowerCase();return n==="paid"?D("reservations.reports.payment.paidLabel","مدفوعة","Paid"):n==="partial"?D("reservations.reports.payment.partialLabel","مدفوعة جزئياً","Partially paid"):D("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}function Yt(t,n){const s=new Map((n||[]).map(e=>[String(e.id),e])),a=new Map;return(t||[]).forEach(e=>{const{statusValue:r}=S(e);if(r==="cancelled")return;const u=O(e.start,e.end),l=Array.isArray(e.crewAssignments)?e.crewAssignments:[];if(l.length){l.forEach(m=>{const c=m?.technicianId!=null?String(m.technicianId):null;if(!c)return;const i=s.get(c)||B(c)||{},p=Number.isFinite(Number(m?.positionClientPrice))&&Number(m.positionClientPrice)>0?Number(m.positionClientPrice):V(i),f=Number.isFinite(Number(m?.positionCost))&&Number(m.positionCost)>0?Number(m.positionCost):Y(i),g=p*u,y=f*u,w=a.get(c)||{id:c,name:i?.name||String(c),days:0,billable:0,cost:0};w.days+=u,w.billable+=g,w.cost+=y,a.set(c,w)});return}(Array.isArray(e.technicians)?e.technicians.map(m=>String(m)):[]).forEach(m=>{const c=s.get(m)||B(m)||{},i=V(c),p=Y(c),f=i*u,g=p*u,y=a.get(m)||{id:m,name:c?.name||String(m),days:0,billable:0,cost:0};y.days+=u,y.billable+=f,y.cost+=g,a.set(m,y)})}),Array.from(a.values()).map(e=>({...e,net:e.billable-e.cost})).sort((e,r)=>r.net-e.net)}function ct(t=[]){if(!Array.isArray(t)||!t.length)return 0;let n=0;return t.forEach(s=>{const a=Number(s?.amount);Number.isFinite(a)&&a>0&&(n+=a)}),n}function J(t){const n=A(t),s=Number(n.finalTotal||0);let a=Number(t?.paidAmount);if(!Number.isFinite(a)||a<=0){const e=ct(t?.paymentHistory||t?.payment_history||[]);Number.isFinite(e)&&e>0&&(a=e)}if((!Number.isFinite(a)||a<=0)&&Number.isFinite(Number(t?.paidPercent))){const e=Number(t.paidPercent);e>0&&e<=100&&(a=e/100*s)}return Number.isFinite(a)||(a=0),Math.max(0,Math.round((s-a)*100)/100)}function jt(t,n,s=5){const a=new Map((n||[]).map(e=>[String(e.id),e])),o=[];return(t||[]).forEach(e=>{const{paidStatus:r,statusValue:u}=S(e);if(u==="cancelled"||r!=="unpaid"&&r!=="partial")return;const l=J(e);if(!Number.isFinite(l)||l<=0)return;const d=a.get(String(e.customerId));o.push({id:e.id||e.reservationId||"",code:e.reservationCode||e.reservationId||e.id||"",customer:d?.customerName||e.customerName||"",outstanding:l,paidStatus:r})}),o.sort((e,r)=>r.outstanding-e.outstanding).slice(0,s)}function It(t,{horizonDays:n=90}={}){const s=new Date,a=new Date(s.getTime()+n*L),o=new Map;return(t||[]).forEach(e=>{const{statusValue:r,paidStatus:u}=S(e);if(r==="cancelled"||u==="paid")return;const l=J(e);if(!Number.isFinite(l)||l<=0)return;const d=e?.start?new Date(e.start):null,m=e?.end?new Date(e.end):d;let c=m&&!Number.isNaN(m.getTime())?m:d;if((!c||Number.isNaN(c.getTime()))&&(c=new Date(s.getTime()+7*L)),c<s||c>a)return;const i=k(new Date(c.getFullYear(),c.getMonth(),c.getDate())),p=o.get(i)||{date:i,amount:0,count:0};p.amount+=l,p.count+=1,o.set(i,p)}),Array.from(o.values()).sort((e,r)=>e.date<r.date?-1:1)}export{It as A,jt as B,ut as C,dt as D,mt as E,pt as F,ft as G,ht as H,Dt as I,bt as J,kt as a,W as b,A as c,gt as d,yt as e,St as f,Nt as g,S as h,Mt as i,k as j,wt as k,E as l,Lt as m,Tt as n,Ft as o,st as p,At as q,h as r,Ct as s,D as t,xt as u,Rt as v,Pt as w,Et as x,_t as y,Yt as z};
