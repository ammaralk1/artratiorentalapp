import{d as w,h as ee,b as j,A as te,n as V}from"./auth.DvWRjNol.js";const ne=w()||{};let f=(ne.projects||[]).map(ae),S=!1;function l(e){if(e==null||e==="")return 0;const o=V(String(e)).replace(/[^\d.+-]/g,""),n=Number.parseFloat(o);return Number.isFinite(n)?n:0}function le(){return f}function P(e){f=Array.isArray(e)?e.map(B):[],ee({projects:f});try{const o=new CustomEvent("projects:changed");typeof window<"u"&&typeof window.dispatchEvent=="function"&&window.dispatchEvent(o),typeof document<"u"&&typeof document.dispatchEvent=="function"&&document.dispatchEvent(o)}catch(o){console.warn("⚠️ [projectsService] Failed to dispatch projects:changed event",o)}return f}async function oe(e={}){const o=new URLSearchParams;Object.entries(e).forEach(([y,d])=>{d==null||d===""||o.set(y,String(d))});const n=o.toString(),a=(await j(`/projects/${n?`?${n}`:""}`))?.data;let r=[];Array.isArray(a)?r=a:a&&typeof a=="object"&&(Array.isArray(a.items)?r=a.items:Array.isArray(a.results)?r=a.results:Array.isArray(a.data)?r=a.data:Array.isArray(a.records)&&(r=a.records));const _=r.map(D);return P(_),S=!0,f}async function ce({force:e=!1,params:o=null}={}){if(!e&&S&&f.length>0)return f;try{return await oe(o||{})}catch(n){return console.error("❌ [projectsService] Failed to load projects from API",n),f}}async function se(e){const o=await j("/projects/",{method:"POST",body:e}),n=D(o?.data??{}),c=[...f,n];return P(c),S=!0,n}async function ue(e,o){const n=await j(`/projects/?id=${encodeURIComponent(e)}`,{method:"PATCH",body:o}),c=D(n?.data??{}),a=f.map(r=>String(r.id)===String(e)?c:r);return P(a),S=!0,c}async function pe(e){await j(`/projects/?id=${encodeURIComponent(e)}`,{method:"DELETE"});const o=f.filter(n=>String(n.id)!==String(e));P(o),S=!0}function de({projectCode:e,title:o,type:n,clientId:c,clientCompany:a,description:r,start:_,end:y,applyTax:d,paymentStatus:m,equipmentEstimate:h=0,expenses:g=[],servicesClientPrice:q=0,taxAmount:b=0,totalWithTax:t=0,discount:p=0,discountType:I="percent",companyShareEnabled:N=!1,companySharePercent:x=null,companyShareAmount:k=0,paidAmount:E=null,paidPercentage:v=null,paymentProgressType:C=null,paymentProgressValue:F=null,confirmed:G=!1,technicians:L=[],equipment:$=[],payments:O,paymentHistory:J}={}){const K=Array.isArray(L)?L.map(i=>Number.parseInt(String(i),10)).filter(i=>Number.isInteger(i)&&i>0):[],Q=Array.isArray($)?$.map(i=>{const s=Number.parseInt(String(i.equipmentId??i.equipment_id??i.id??0),10),A=Number.parseInt(String(i.qty??i.quantity??0),10);return!Number.isInteger(s)||s<=0?null:{equipment_id:s,quantity:Number.isInteger(A)&&A>0?A:1}}).filter(Boolean):[],H=Array.isArray(g)?g.map(i=>{const s=l(i?.amount??i?.value??0),A=(i?.label??i?.name??"").trim();if(!A)return null;const Z=l(i?.salePrice??i?.sale_price??0),R=(i?.note??i?.notes??"").toString().trim();return{label:A,amount:Math.round(s*100)/100,sale_price:Math.max(0,Math.round(Z*100)/100),note:R||void 0,...R?{notes:R}:{}}}).filter(Boolean):[],X=H.reduce((i,s)=>i+(s?.amount??0),0),u={title:o,type:n,client_id:c?Number.parseInt(String(c),10):null,client_company:a??null,description:r??null,start_datetime:_??null,end_datetime:y||null,apply_tax:!!d,payment_status:m??"unpaid",equipment_estimate:l(h),expenses_total:Math.round(X*100)/100,services_client_price:Math.round(l(q)*100)/100,tax_amount:Math.round(l(b)*100)/100,total_with_tax:Math.round(l(t)*100)/100,confirmed:!!G,technicians:K,equipment:Q,expenses:H},Y=Math.max(0,Number.parseFloat(p)||0);u.discount=Y,u.discount_type=I==="amount"?"amount":"percent";const M=l(x),T=!!N&&Number.isFinite(M)&&M>0;u.company_share_enabled=T,u.company_share_percent=T?M:0,u.company_share_amount=T?Math.max(0,l(k)):0,E!=null&&E!==""&&(u.paid_amount=Math.max(0,l(E))),v!=null&&v!==""&&(u.paid_percentage=Math.max(0,l(v))),(C==="amount"||C==="percent")&&(u.payment_progress_type=C),F!=null&&F!==""&&(u.payment_progress_value=l(F)),e&&(u.project_code=String(e).trim());const U=O!==void 0?O:J;if(U!==void 0){const i=W(U)||[];u.payments=i.map(s=>({type:s.type,amount:s.amount!=null?s.amount:null,percentage:s.percentage!=null?s.percentage:null,value:s.value!=null?s.value:null,note:s.note??null,recorded_at:s.recordedAt??null}))}return u.end_datetime||delete u.end_datetime,u.client_company||(u.client_company=null),u}function D(e={}){return B(e)}function ae(e={}){return B(e)}function B(e={}){const o=e.id??e.projectId??e.project_id??null,n=Array.isArray(e.technicians)?e.technicians:[],c=n.map(t=>{if(t==null)return null;if(typeof t=="object"){const p=t.id??t.technician_id??t.technicianId;return p!=null?String(p):null}return String(t)}).filter(Boolean),r=(Array.isArray(e.equipment)?e.equipment:[]).map(t=>{const p=t?.equipment_id??t?.equipmentId??t?.id??null,I=t?.quantity??t?.qty??0,N=t?.barcode??t?.code??"",x=t?.description??t?.name??"";return{equipmentId:p!=null?String(p):null,qty:Number.parseInt(String(I),10)||0,barcode:N,description:x}}),y=(Array.isArray(e.expenses)?e.expenses:[]).map((t,p)=>({id:t?.id??`expense-${o??"x"}-${p}`,label:t?.label??"",amount:l(t?.amount??0),salePrice:l(t?.sale_price??t?.salePrice??0),note:t?.note??t?.notes??""})),d=l(e.company_share_percent??e.companySharePercent??0),m=e.company_share_enabled??e.companyShareEnabled,h=m!=null?m===!0||m===1||String(m).toLowerCase()==="true":d>0,g=e.payment_history??e.paymentHistory??e.payments??null,q=W(g),b=(()=>{const t=e.cancelled??e.canceled??e.is_cancelled??e.isCanceled;if(t===!0||t==="true"||t===1||t==="1")return!0;if(typeof t=="string"){const p=t.toLowerCase();return p==="yes"||p==="cancelled"||p==="canceled"}return!1})();return{id:o!=null?String(o):"",projectId:o!=null?Number(o):null,status:(()=>{const t=String(e.status??e.project_status??"").toLowerCase();if(b||t==="cancelled"||t==="canceled"||t==="ملغي"||t==="ملغى")return"cancelled";if(t==="completed"||t==="مكتمل")return"completed";if(t==="ongoing"||t==="in_progress"||t==="قيد التنفيذ")return"ongoing";if(t==="upcoming"||t==="قادم")return"upcoming"})(),cancelled:b,projectCode:e.project_code??e.projectCode??null,title:e.title??"",type:e.type??e.projectType??"",clientId:e.client_id!=null?String(e.client_id):e.clientId??null,clientCompany:e.client_company??e.clientCompany??"",description:e.description??"",start:e.start_datetime??e.start??null,end:e.end_datetime??e.end??null,applyTax:!!(e.apply_tax??e.applyTax??!1),paymentStatus:e.payment_status??e.paymentStatus??"unpaid",equipmentEstimate:l(e.equipment_estimate??e.equipmentEstimate??0),expensesTotal:l(e.expenses_total??e.expensesTotal??0),servicesClientPrice:l(e.services_client_price??e.servicesClientPrice??0),taxAmount:l(e.tax_amount??e.taxAmount??0),totalWithTax:l(e.total_with_tax??e.totalWithTax??0),discount:l(e.discount??e.discount_value??0),discountType:e.discount_type??e.discountType??"percent",companyShareEnabled:h,companySharePercent:h?d:0,companyShareAmount:l(e.company_share_amount??e.companyShareAmount??0),paidAmount:l(e.paid_amount??e.paidAmount??0),paidPercent:l(e.paid_percentage??e.paidPercent??0),paymentProgressType:e.payment_progress_type??e.paymentProgressType??null,paymentProgressValue:e.payment_progress_value??e.paymentProgressValue??null,confirmed:!!(e.confirmed??!1),createdAt:e.created_at??e.createdAt??null,updatedAt:e.updated_at??e.updatedAt??null,technicians:c,techniciansDetails:n.map(t=>typeof t=="object"?t:{id:t}),equipment:r,expenses:y,paymentHistory:q}}function me(e){return e instanceof te}function z(e){if(e==null||e==="")return null;const o=V(String(e)).replace(/[^\d.,-]/g,"").trim();if(!o)return null;let n=o;const c=n.includes(","),a=n.includes(".");c&&(n=a?n.replace(/,/g,""):n.replace(/,/g,"."));const r=Number.parseFloat(n);return Number.isFinite(r)?r:null}function re(e){if(!e||typeof e!="object")return null;const o=e.type??e.payment_type??e.paymentType??e.kind??null;let n=typeof o=="string"?o.trim().toLowerCase():null;n==="percentage"&&(n="percent");const c=z(e.value);let a=z(e.amount),r=z(e.percentage);if(n==="amount"&&a==null&&c!=null?a=c:n==="percent"&&r==null&&c!=null&&(r=c),!n)if(a!=null&&a>=0)n="amount";else if(r!=null&&r>=0)n="percent";else if(c!=null&&c>=0)n="amount",a=c;else return null;if(n==="amount"){if(a==null||!Number.isFinite(a)||a<0)return null;a=Math.round(a*100)/100}if(n==="percent"){if(r==null||!Number.isFinite(r)||r<0)return null;r=Math.min(100,Math.round(r*100)/100)}const _=e.note??e.memo??e.description??null,y=_!=null?String(_).trim():null,d=e.recordedAt??e.recorded_at??e.date??null;let m=null;if(d){const g=new Date(d);Number.isNaN(g.getTime())||(m=g.toISOString())}m||(m=new Date().toISOString());const h=n==="amount"?a:n==="percent"?r:c;return{type:n,amount:a??null,percentage:r??null,value:h!=null?Math.round(h*100)/100:null,note:y&&y.length?y.slice(0,500):null,recordedAt:m}}function W(e){if(e!==void 0)return e===null?[]:Array.isArray(e)?e.map(o=>re(o)).filter(Boolean):[]}export{de as buildProjectPayload,se as createProjectApi,pe as deleteProjectApi,ce as ensureProjectsLoaded,le as getProjectsState,me as isApiError,ae as mapLegacyProject,D as mapProjectFromApi,oe as refreshProjectsFromApi,P as setProjectsState,ue as updateProjectApi};
