const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["./pdfPages.DnFeKTMH.js","./calculations.D9-KzSHv.js","./reservationsService.Cqdx1FDo.js","./auth.BDXZMkvU.js","./auth.Dqh5RUqt.css","./state.C3hmi0TE.js","./quotePdf.C2lQPEPC.js","./canvasColorUtils.CviLtv6S.js","./preload-helper.PPVm8Dsz.js","./maintenanceService.9EEj95Kj.js","./a4Unified.JaxWGw47.js","./preview.DxoeUlhb.js"])))=>i.map(i=>d[i]);
import{_ as U}from"./preload-helper.PPVm8Dsz.js";import{r,a as pe,b as Ce,t as c,f as k,d as S,c as D,e as se,g as $e,p as me,h as he,i as Ae,j as Le,k as Pe,l as Te,m as Re,n as Me,o as Ie,q as De,s as Be,u as Ne,v as _e,w as je,x as He,y as qe,z as Fe,A as ze,B as Oe,C as Ue,D as Ve,E as re}from"./calculations.D9-KzSHv.js";import{d as We,b as H,A as Xe,n as X,p as Ye}from"./auth.BDXZMkvU.js";import{I as Ge,m as Ze}from"./reservationsService.Cqdx1FDo.js";import{m as fe}from"./state.C3hmi0TE.js";import{mapMaintenanceFromApi as ye}from"./maintenanceService.9EEj95Kj.js";import"./canvasColorUtils.CviLtv6S.js";function ge(e={}){return{id:e?.id!=null?String(e.id):"",customerName:e?.full_name??e?.customerName??e?.name??"",companyName:e?.company??e?.company_name??e?.companyName??"",phone:e?.phone??""}}function ve(e={}){const t=String(e?.barcode??"").trim(),a=e?.description??e?.name??"";return{id:e?.id!=null?String(e.id):"",barcode:t,desc:a,description:a,name:e?.name??a,category:e?.category??"",subcategory:e?.subcategory??"",status:e?.status??"",price:Number.parseFloat(e?.unit_price??e?.price??0)||0}}function be(e={}){const t=e?.title??e?.name??"",a=e?.project_code??e?.projectCode??"",o=e?.status??"",s=e?.confirmed===!0;return{id:e?.id!=null?String(e.id):"",title:t,code:a,status:o,confirmed:s}}function Je(){let e;try{e=We()}catch(f){return console.warn("âš ï¸ [reports] Failed to access cached data",f),!1}if(!e||typeof e!="object")return!1;const{reservations:t=[],customers:a=[],equipment:o=[],technicians:s=[],projects:n=[],maintenance:i=[]}=e;if(!(t.length||a.length||o.length||s.length||n.length))return!1;r.data.reservations=Array.isArray(t)?t.map(Ge):[],r.data.customers=Array.isArray(a)?a.map(ge):[],r.data.equipment=Array.isArray(o)?o.map(ve):[],r.data.technicians=Array.isArray(s)?s.map(fe):[],r.data.projects=Array.isArray(n)?n.map(be):[],r.data.projectsMap=new Map(r.data.projects.map(f=>[f.id,f])),r.data.maintenance=Array.isArray(i)?i.map(ye):[],r.techniciansIndex=new Map((r.data.technicians||[]).map(f=>[String(f.id),f]));try{pe()}catch{}return!0}async function V({silent:e=!1}={}){if(!r.loading){r.loading=!0,r.errorMessage="",e||r.callbacks.onBeforeRender?.();try{const{startDate:t,endDate:a}=Ce(r.filters||{}),o=h=>{if(!h)return null;const x=h.getFullYear(),w=String(h.getMonth()+1).padStart(2,"0"),v=String(h.getDate()).padStart(2,"0");return`${x}-${w}-${v}`},s=o(t),n=o(a),i=200;let l=0,f=[];const y=50;for(let h=0;h<y;h+=1){const x=new URLSearchParams;x.set("limit",String(i)),x.set("offset",String(l)),s&&x.set("start_date",s),n&&x.set("end_date",n);const w=r.filters||{};w?.status&&w.status!=="all"&&x.set("status",String(w.status)),w?.search&&x.set("search",String(w.search));const v=await H(`/reservations/?${x.toString()}`),C=Array.isArray(v?.data)?v.data:[];if(f=f.concat(C),C.length<i)break;l+=i}const[m,b,u,p,E]=await Promise.all([H("/customers/?limit=500"),H("/equipment/?limit=500"),H("/technicians/?limit=500"),H("/projects/?limit=500"),H("/maintenance/?limit=500")]);r.data.reservations=Array.isArray(f)?f.map(h=>Ze(h)):[],r.data.customers=Array.isArray(m?.data)?m.data.map(ge):[],r.data.equipment=Array.isArray(b?.data)?b.data.map(ve):[],r.data.technicians=Array.isArray(u?.data)?u.data.map(fe):[],r.data.projects=Array.isArray(p?.data)?p.data.map(be):[],r.data.projectsMap=new Map(r.data.projects.map(h=>[h.id,h])),r.data.maintenance=Array.isArray(E?.data)?E.data.map(ye):[],r.techniciansIndex=new Map((r.data.technicians||[]).map(h=>[String(h.id),h]));try{pe()}catch{}}catch(t){console.error("âŒ [reports] Failed to load reports data",t),r.errorMessage=t instanceof Xe?t.message:c("reservations.reports.error.fetchFailed","ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ Ø­Ø§ÙˆÙ„ Ù„Ø§Ø­Ù‚Ø§Ù‹"),(!r.data.projectsMap||!(r.data.projectsMap instanceof Map))&&(r.data.projectsMap=new Map)}finally{r.loading=!1,e||r.callbacks.onAfterRender?.()}}}function Q(e){if(r.loadedScripts.has(e))return r.loadedScripts.get(e);const t=typeof document<"u"?document.querySelector(`script[src="${e}"]`):null,a=new Promise((o,s)=>{const n=()=>{t&&(t.dataset.loaded="true"),o()},i=f=>s(f);if(t){if(t.dataset.loaded==="true"){o();return}t.addEventListener("load",n,{once:!0}),t.addEventListener("error",i,{once:!0});return}const l=document.createElement("script");l.src=e,l.async=!0,l.onload=()=>{l.dataset.loaded="true",o()},l.onerror=f=>s(f),document.head.appendChild(l)});return r.loadedScripts.set(e,a),a}function ee(){return typeof window<"u"&&window.ApexCharts?Promise.resolve(window.ApexCharts):(r.apexChartsReady||(r.apexChartsReady=Q("https://cdn.jsdelivr.net/npm/apexcharts@3.53.0").then(()=>window.ApexCharts)),r.apexChartsReady)}function Vt(){return typeof window<"u"&&window.html2pdf?Promise.resolve(window.html2pdf):(r.html2PdfReady||(r.html2PdfReady=Q("https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js").then(()=>window.html2pdf)),r.html2PdfReady)}function Ke(){return typeof window<"u"&&window.XLSX?Promise.resolve(window.XLSX):(r.xlsxReady||(r.xlsxReady=Q("https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js").then(()=>window.XLSX)),r.xlsxReady)}function Wt(){return typeof window<"u"&&window.JSZip?Promise.resolve(window.JSZip):(r.jsZipReady||(r.jsZipReady=Q("https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js").then(()=>window.JSZip)),r.jsZipReady)}function _(){const e=document.documentElement;return e.classList.contains("dark")||e.dataset.theme==="dark"?"dark":"light"}function B(e,t){const a=document.getElementById(e);if(a){if(!t||t.length===0){a.innerHTML=`<div class="text-sm text-base-content/60">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</div>`;return}a.innerHTML=t.map(o=>{const s=Math.min(Math.max(o.percent??0,0),100),n=c("reservations.reports.progress.meta","{count} Ø­Ø¬Ø²","{count} reservations").replace("{count}",k(o.rawCount??o.value??0)),i=o.className?`reports-progress-fill ${o.className}`:"reports-progress-fill";return`
        <div class="reports-progress-row">
          <div class="reports-progress-top">
            <span>${o.label}</span>
            <span class="reports-progress-value">${k(o.percent??0)}%</span>
          </div>
          <div class="reports-progress-bar">
            <div class="${i}" style="width: ${s}%;"></div>
          </div>
          <div class="reports-progress-meta">${n}</div>
        </div>
      `}).join("")}}function L(e,t){const a=document.querySelector(`[data-chart-loading="${e}"]`);a&&(a.style.display=t?"":"none")}async function Qe(e){const t=document.getElementById("reports-volume-chart");if(!t)return;const a=Array.isArray(e)?e:[];if(r.lastTrendData=a,L("volume",!0),!a.length){r.charts.trend&&(r.charts.trend.destroy(),r.charts.trend=null),t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,L("volume",!1);return}try{const o=await ee();if(!o){t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,L("volume",!1);return}const s=a.map(v=>v.label),n=a.map(v=>Math.round(v.count||0)),i=a.map(v=>Number(v.revenue||0)),l=a.map(v=>Number(v.netProfit||0)),f=a.map(v=>v.movingAvgRevenue!=null?Number(v.movingAvgRevenue):null),y=n.reduce((v,C)=>v+(Number.isFinite(C)?C:0),0),m=i.reduce((v,C)=>v+(Number.isFinite(C)?C:0),0),b=l.reduce((v,C)=>v+(Number.isFinite(C)?C:0),0);if(y===0&&m===0&&b===0){r.charts.trend&&(r.charts.trend.destroy(),r.charts.trend=null),t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}const u=[{name:c("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),type:"column",data:n},{name:c("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),type:"line",data:i,yAxisIndex:1},{name:c("reservations.reports.chart.volume.series.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ (SR)","Net profit (SR)"),type:"line",data:l,yAxisIndex:1},{name:c("reservations.reports.chart.volume.series.movingAvg","Ù…ØªÙˆØ³Ø· Ù…ØªØ­Ø±Ùƒ (Ù£ Ø£Ø´Ù‡Ø±)","3-mo Moving Avg"),type:"line",data:f,yAxisIndex:1}],p={chart:{type:"line",height:320,stacked:!1,toolbar:{show:!1},background:"transparent",fontFamily:"Tajawal, sans-serif",animations:{enabled:!0},events:{dataPointSelection:(v,C,I)=>{if(I?.dataPointIndex!=null){const R=r.lastTrendData[I.dataPointIndex];r.callbacks.onTrendDrilldown?.(R,I.dataPointIndex)}}}},theme:{mode:_()},stroke:{width:[0,4,4],curve:"smooth"},markers:{size:[0,4,4,0]},colors:["#6366f1","#22c55e","#f97316","#0ea5e9"],dataLabels:{enabled:!1},fill:{type:"solid",opacity:1},stroke:{curve:"smooth",width:[0,2,2,2],dashArray:[0,0,0,6]},xaxis:{categories:s,labels:{style:{colors:_()==="dark"?"#cbd5f5":"#475569"}}},yaxis:[{seriesName:c("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#6366f1"},labels:{style:{colors:"#6366f1"},formatter:v=>k(v)},title:{text:c("reservations.reports.chart.volume.series.reservations","Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations"),style:{color:"#6366f1"}}},{opposite:!0,seriesName:c("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),axisTicks:{show:!0},axisBorder:{show:!0,color:"#22c55e"},labels:{style:{colors:"#22c55e"},formatter:v=>S(v)},title:{text:c("reservations.reports.chart.volume.series.revenue","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª (SR)","Revenue (SR)"),style:{color:"#22c55e"}}}],legend:{position:"bottom"},tooltip:{shared:!0,intersect:!1,custom:({series:v,dataPointIndex:C,w:I})=>{const R=r.lastTrendData?.[C]||{},Y=s?.[C]||"",N=[],G=v?.[0]?.[C];G!=null&&N.push(`<div><span>ğŸ“¦</span> ${k(G)}</div>`);const P=v?.[1]?.[C];if(P!=null){const te=Number.isFinite(R.yoyChange)?`${R.yoyChange>=0?"+":""}${k(Math.round(R.yoyChange))}% YoY`:"",Ee=Number.isFinite(R.momChange)?`${R.momChange>=0?"+":""}${k(Math.round(R.momChange))}% MoM`:"",ce=[te,Ee].filter(Boolean).join(" Â· ");N.push(`<div><span>ğŸ’°</span> ${S(P)}${ce?` <small class="text-base-content/60">(${ce})</small>`:""}</div>`)}const j=v?.[2]?.[C];j!=null&&N.push(`<div><span>ğŸ§®</span> ${S(j)}</div>`);const Z=v?.[3]?.[C];return Z!=null&&N.push(`<div><span>ğŸ“ˆ</span> ${S(Z)}</div>`),`
            <div class="apex-tooltip">
              <div class="mb-1 font-semibold">${Y}</div>
              ${N.join("")}
            </div>
          `}}},E=_(),h=String(s.join("|")),x=r.chartsMeta.trend,w=r.charts.trend&&x.theme===E&&x.categoriesSig===h;r.charts.trend&&w?r.charts.trend.updateSeries(u,!0):r.charts.trend?(r.charts.trend.updateOptions({...p},!0,!0),r.charts.trend.updateSeries(u,!0)):(t.innerHTML="",r.charts.trend=new o(t,{...p,series:u}),r.charts.trend.render()),r.chartsMeta.trend={categoriesSig:h,theme:E},L("volume",!1)}catch(o){console.error("âš ï¸ [reports] Failed to render trend chart",o),t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,L("volume",!1)}}async function et(e){const t=document.getElementById("reports-status-chart"),a="reports-status-breakdown";if(!t)return;const o=Array.isArray(e)?e:[];r.lastStatusData=o,L("status",!0);const s=o.map(i=>Math.max(0,i.value||0)),n=s.reduce((i,l)=>i+l,0);if(!o.length||n===0){r.charts.status&&(r.charts.status.destroy(),r.charts.status=null),B(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,L("status",!1);return}try{const i=await ee();if(!i){B(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,L("status",!1);return}const l=o.map(p=>p.label),f={chart:{type:"donut",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(p,E,h)=>{if(h?.dataPointIndex!=null){const x=r.lastStatusData[h.dataPointIndex];x?.filterKey&&r.callbacks.onStatusDrilldown?.(x,h.dataPointIndex)}}}},theme:{mode:_()},labels:l,series:s,colors:["#22c55e","#f97316","#6366f1","#ef4444"],legend:{position:"bottom"},dataLabels:{formatter:p=>`${Math.round(p)}%`},plotOptions:{pie:{donut:{size:"68%",labels:{show:!0,total:{show:!0,label:c("reservations.reports.chart.status.title","ğŸ§¾ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª","Status distribution"),formatter:()=>k(s.reduce((p,E)=>p+E,0))}}}}},tooltip:{y:{formatter:(p,E)=>{const h=r.lastStatusData?.[E?.seriesIndex||0],x=h?`${k(h.percent)}%`:`${k(p)}%`;return`${h?k(h.rawCount??h.value??0):k(p)} / ${x}`}}}},y=_(),m=String(l.join("|")),b=r.chartsMeta.status,u=r.charts.status&&b.theme===y&&b.labelsSig===m;r.charts.status&&u?r.charts.status.updateSeries(s,!0):r.charts.status?(r.charts.status.updateOptions({...f},!0,!0),r.charts.status.updateSeries(s,!0)):(t.innerHTML="",r.charts.status=new i(t,{...f,series:s}),r.charts.status.render()),B(a,o),r.chartsMeta.status={labelsSig:m,theme:y},L("status",!1)}catch(i){console.error("âš ï¸ [reports] Failed to render status chart",i),B(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,L("status",!1)}}async function tt(e){const t=document.getElementById("reports-payment-chart"),a="reports-payment-breakdown";if(!t)return;const o=Array.isArray(e)?e:[];r.lastPaymentData=o,L("payment",!0);const s=o.map(i=>Math.max(0,i.value||0)),n=s.reduce((i,l)=>i+l,0);if(!o.length||n===0){r.charts.payment&&(r.charts.payment.destroy(),r.charts.payment=null),B(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,L("payment",!1);return}try{const i=await ee();if(!i){B(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,L("payment",!1);return}const l=o.map(p=>p.label),f={chart:{type:"pie",height:300,fontFamily:"Tajawal, sans-serif",toolbar:{show:!1},background:"transparent",events:{dataPointSelection:(p,E,h)=>{if(h?.dataPointIndex!=null){const x=r.lastPaymentData[h.dataPointIndex];x?.filterKey&&r.callbacks.onPaymentDrilldown?.(x,h.dataPointIndex)}}}},theme:{mode:_()},labels:l,series:s,colors:["#00ac69","#f59e0b","#f43f5e"],legend:{position:"bottom"},dataLabels:{formatter:p=>`${Math.round(p)}%`},tooltip:{y:{formatter:(p,E)=>{const h=r.lastPaymentData?.[E?.seriesIndex||0],x=h?`${k(h.percent)}%`:`${k(p)}%`;return`${h?k(h.rawCount??h.value??0):k(p)} / ${x}`}}}},y=_(),m=String(l.join("|")),b=r.chartsMeta.payment,u=r.charts.payment&&b.theme===y&&b.labelsSig===m;r.charts.payment&&u?r.charts.payment.updateSeries(s,!0):r.charts.payment?(r.charts.payment.updateOptions({...f},!0,!0),r.charts.payment.updateSeries(s,!0)):(t.innerHTML="",r.charts.payment=new i(t,{...f,series:s}),r.charts.payment.render()),B(a,o),r.chartsMeta.payment={labelsSig:m,theme:y},L("payment",!1)}catch(i){console.error("âš ï¸ [reports] Failed to render payment chart",i),B(a,[]),t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`,L("payment",!1)}}async function rt(e){const t=document.getElementById("reports-status-stacked-chart");if(!t)return;const a=Array.isArray(e)?e:[];if(!a.length){t.innerHTML=`<p class="text-base-content/60 text-sm">${c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.")}</p>`;return}try{const o=await ee(),s=a.map(m=>m.label),n=a.map(m=>m.confirmed||0),i=a.map(m=>m.cancelled||0),l=[{name:c("reservations.reports.status.confirmedLabel","Ù…Ø¤ÙƒØ¯Ø©","Confirmed"),data:n},{name:c("reservations.reports.status.cancelledLabel","Ù…Ù„ØºØ§Ø©","Cancelled"),data:i}],f={chart:{type:"bar",height:320,stacked:!0,toolbar:{show:!1}},series:l,xaxis:{categories:s},plotOptions:{bar:{columnWidth:"55%",borderRadius:6}},colors:["#22c55e","#ef4444"],dataLabels:{enabled:!1},legend:{position:"bottom"}};t.innerHTML="",new o(t,f).render()}catch(o){console.error("[reports] failed to render stacked status chart",o)}}function at(e){const t=document.getElementById("reports-kpi-total"),a=document.getElementById("reports-kpi-total-meta"),o=document.getElementById("reports-kpi-revenue"),s=document.getElementById("reports-kpi-revenue-meta"),n=document.getElementById("reservations-revenue-breakdown"),i=document.getElementById("reports-kpi-confirmed"),l=document.getElementById("reports-kpi-confirmed-meta"),f=document.getElementById("reports-kpi-paid"),y=document.getElementById("reports-kpi-paid-meta"),m=e.total||0,b=e.cancelled||0,u=e.activeTotal!=null?e.activeTotal:Math.max(0,m-b),p=e.revenue||0,E=e.confirmed||0,h=e.paidCount||0,x=e.average||0,w=e.companyShareTotal||0,v=e.taxTotal||0,C=e.crewTotal||0,I=e.crewCostTotal||0,R=e.netProfit||0,Y=e.maintenanceExpense||0,N=m?Math.round(E/m*100):0,G=u?Math.round(h/u*100):0;if(t&&(t.textContent=k(m)),a){const P=c("reservations.reports.kpi.total.dynamicMeta","Ù…Ù†Ù‡Ø§ {count} Ù…Ù†ØªÙ‡ÙŠØ©","Includes {count} completed").replace("{count}",k(e.completed||0)),j=b>0?" "+c("reservations.reports.kpi.total.cancelledPart","â€¢ {count} Ù…Ù„ØºØ§Ø©","â€¢ {count} cancelled").replace("{count}",k(b)):"";a.textContent=P+j}if(o&&(o.textContent=S(p)),s)if(m===0)s.textContent=c("reservations.reports.progress.empty","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§.","No data to display.");else{const P=c("reservations.reports.kpi.revenue.meta","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ {net} â€¢ Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© {share} â€¢ Ù…ØªÙˆØ³Ø· Ø§Ù„Ø­Ø¬Ø² {average}","Net profit {net} â€¢ Company share {share} â€¢ Average reservation {average}");s.textContent=P.replace("{net}",S(R)).replace("{share}",S(w)).replace("{average}",S(x))}if(n)if(p>0){const P=[{label:c("reservations.reports.kpi.revenue.details.gross","Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ÙƒÙ„ÙŠ","Gross revenue"),value:S(p),hint:c("reservations.reports.kpi.revenue.details.grossHint","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‚ÙŠÙ…Ø© Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª (Ù‚Ø¨Ù„ Ø§Ù„Ø®ØµÙˆÙ…Ø§Øª)","Total bookings value (before discounts)")},{label:c("reservations.reports.kpi.revenue.details.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),value:S(w),hint:c("reservations.reports.kpi.revenue.details.shareHint","ØªÙØ­Ø³Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ…ØŒ ÙˆØªÙØ¶Ø§Ù Ù„Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Applied after discount and added to total")},{label:c("reservations.reports.kpi.revenue.details.tax","Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©","Tax"),value:S(v),hint:c("reservations.reports.kpi.revenue.details.taxHint","Ø¶Ø±ÙŠØ¨Ø© 15% Ø¹Ù„Ù‰ (Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø®ØµÙ… + Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©)","15% VAT on (after-discount total + company share)")},{label:c("reservations.reports.kpi.revenue.details.crewGross","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ø§Ù‚Ù…","Crew total"),value:S(C),hint:c("reservations.reports.kpi.revenue.details.crewGrossHint","Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ø§Ù‚Ù… Ù„Ù„Ø¹Ù…ÙŠÙ„","Crew price billed to client")},{label:c("reservations.reports.kpi.revenue.details.crew","ØªÙƒÙ„ÙØ© Ø§Ù„Ø·Ø§Ù‚Ù…","Crew cost"),value:S(I),hint:c("reservations.reports.kpi.revenue.details.crewHint","ØªÙƒÙ„ÙØ© Ø§Ù„Ø·Ø§Ù‚Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø±ÙƒØ©","Crew cost to company")}];Y>0&&P.push({label:c("reservations.reports.kpi.revenue.details.maintenance","Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØµÙŠØ§Ù†Ø©","Maintenance expenses"),value:`âˆ’${S(Y)}`}),P.push({label:c("reservations.reports.kpi.revenue.details.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit"),value:S(R)}),n.innerHTML=P.map(({label:j,value:Z,hint:te})=>`
          <div class="reports-kpi-detail-row" title="${te||""}">
            <span class="reports-kpi-detail-label">${j}</span>
            <span class="reports-kpi-detail-value">${Z}</span>
          </div>
        `).join(""),n.classList.remove("hidden")}else n.innerHTML="",n.classList.add("hidden");if(i&&(i.textContent=`${N}%`),l){const P=c("reservations.reports.kpi.confirmed.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¤ÙƒØ¯Ø©","{count} confirmed reservations").replace("{count}",k(E));l.textContent=P}if(f&&(f.textContent=`${G}%`),y){const P=c("reservations.reports.kpi.paid.detail","{count} Ø­Ø¬ÙˆØ²Ø§Øª Ù…Ø¯ÙÙˆØ¹Ø©","{count} paid reservations").replace("{count}",k(h));y.textContent=P}}function A(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function O(e=""){return String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function nt(e,t,a){const o=document.getElementById("reports-reservations-body");if(!o)return[];if(!e||e.length===0)return o.innerHTML=`<tr><td colspan="8" class="text-base-content/60">${c("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`,[];const s=new Map((t||[]).map(u=>[String(u.id),u]));new Map((a||[]).map(u=>[String(u.id),u]));const n={code:c("reservations.reports.results.headers.id","Ø§Ù„Ø­Ø¬Ø²","Reservation"),customer:c("reservations.reports.results.headers.customer","Ø§Ù„Ø¹Ù…ÙŠÙ„","Customer"),company:c("reservations.reports.results.headers.company","Ø§Ù„Ø´Ø±ÙƒØ©","Company"),phone:c("reservations.reports.results.headers.phone","Ø§Ù„Ù‡Ø§ØªÙ","Phone"),date:c("reservations.reports.results.headers.date","Ø§Ù„ØªØ§Ø±ÙŠØ®","Date"),status:c("reservations.reports.results.headers.status","Ø§Ù„Ø­Ø§Ù„Ø©","Status"),payment:c("reservations.reports.results.headers.payment","Ø§Ù„Ø¯ÙØ¹","Payment"),paymentsCount:c("reservations.reports.results.headers.paymentsCount","Ø¹Ø¯Ø¯ Ø§Ù„Ø¯ÙØ¹Ø§Øª","Payments count"),days:c("reservations.reports.results.headers.days","Ø§Ù„Ø£ÙŠØ§Ù…","Days"),equipment:c("reservations.reports.results.headers.equipment","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ø§Øª","Equipment"),crewGross:c("reservations.reports.results.headers.crewGross","Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ø§Ù‚Ù…","Crew total"),crewCost:c("reservations.reports.results.headers.crewCost","ØªÙƒÙ„ÙØ© Ø§Ù„Ø·Ø§Ù‚Ù…","Crew cost"),discount:c("reservations.reports.results.headers.discount","Ø§Ù„Ø®ØµÙ…","Discount"),tax:c("reservations.reports.results.headers.tax","Ø§Ù„Ø¶Ø±ÙŠØ¨Ø©","Tax"),total:c("reservations.reports.results.headers.total","Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ","Total"),share:c("reservations.reports.results.headers.share","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share"),sharePercent:c("reservations.reports.results.headers.sharePercent","Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ© %","Company share %"),shareAmount:c("reservations.reports.results.headers.shareAmount","Ù…Ø¨Ù„Øº Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","Company share amount"),net:c("reservations.reports.results.headers.net","ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­","Net profit")},i=ot([...e]),{page:l,pageSize:f}=r.pagination,y=Math.max(0,(l-1)*f),b=i.slice(y,y+f).map(u=>{const p=lt(u,s),E=s.get(String(u?.customerId)),x=(Array.isArray(u.paymentHistory)?u.paymentHistory:Array.isArray(u.payment_history)?u.payment_history:[]).length,w=D(u),v={[n.code]:p.code.text,[n.customer]:p.customer.text,[n.company]:E?.companyName||"",[n.phone]:E?.phone||"",[n.date]:p.date.text,[n.status]:p.status.text,[n.payment]:p.payment.text,[n.paymentsCount]:String(x),[n.days]:String(w.rentalDays??0),[n.equipment]:S(w.equipmentTotal),[n.crewGross]:S(w.crewTotal),[n.crewCost]:S(w.crewCostTotal??0),[n.discount]:S(w.discountAmount??0),[n.tax]:S(w.taxAmount??0),[n.total]:p.total.text,[n.share]:p.share.text,[n.sharePercent]:`${k(w.companySharePercent??0)}%`,[n.shareAmount]:S(w.companyShareAmount??0),[n.net]:p.net.text};return{formatted:p,exportRow:v}});return o.innerHTML=b.map(({formatted:u})=>`
      <tr data-drilldown="reservation" data-search="${O(u.code.text)}">
        <td data-report-column="code">${u.code.html}</td>
        <td data-report-column="customer">${u.customer.html}</td>
        <td data-report-column="date">${u.date.html}</td>
        <td data-report-column="status">${u.status.html}</td>
        <td data-report-column="payment">${u.payment.html}</td>
        <td data-report-column="total">${u.total.html}</td>
        <td data-report-column="share">${u.share.html}</td>
        <td data-report-column="net">${u.net.html}</td>
      </tr>
    `).join(""),ct(i.length),st(),b.map(({exportRow:u})=>u)}function st(){const e=document.querySelector("#reports-reservations-table thead");e&&e.querySelectorAll("th.sortable").forEach(t=>{t.dataset.sortBound!=="true"&&(t.addEventListener("click",()=>{const a=t.dataset.sortKey;a&&(r.sort.key===a?r.sort.dir=r.sort.dir==="asc"?"desc":"asc":(r.sort.key=a,r.sort.dir="asc"),r.pagination.page=1,r.callbacks.onRender?.())}),t.dataset.sortBound="true")})}function ot(e){const{key:t,dir:a}=r.sort||{key:"date",dir:"desc"},o=a==="asc"?1:-1;return e.sort((s,n)=>o*it(s,n,t))}function it(e,t,a){switch(a){case"code":return String(e?.reservationId??e?.id??"").localeCompare(String(t?.reservationId??t?.id??""),"ar",{numeric:!0});case"customer":return String(e?.customerName??e?.customerId??"").localeCompare(String(t?.customerName??t?.customerId??""),"ar",{numeric:!0});case"date":return new Date(e?.start||0)-new Date(t?.start||0);case"status":{const o=se(e)?.statusValue||"",s=se(t)?.statusValue||"";return String(o).localeCompare(String(s),"ar")}case"total":{const o=D(e)?.finalTotal||0,s=D(t)?.finalTotal||0;return o-s}case"share":{const o=D(e)?.companyShareAmount||0,s=D(t)?.companyShareAmount||0;return o-s}case"net":{const o=D(e)?.netProfit||0,s=D(t)?.netProfit||0;return o-s}default:return new Date(e?.start||0)-new Date(t?.start||0)}}function ct(e){const t=document.getElementById("reports-table-pagination");if(!t)return;const{page:a,pageSize:o}=r.pagination,s=Math.max(1,Math.ceil(e/o)),n=a<=1?"disabled":"",i=a>=s?"disabled":"",l=e===0?0:(a-1)*o+1,f=Math.min(a*o,e);if(e<=o){t.innerHTML=`<div class="page-info">${k(l)}â€“${k(f)} / ${k(e)}</div>`;return}t.innerHTML=`
    <div class="pager">
      <button type="button" ${n} data-page="prev">â—€</button>
      <button type="button" ${i} data-page="next">â–¶</button>
    </div>
    <div class="page-info">${k(l)}â€“${k(f)} / ${k(e)}</div>
    <div class="pager page-size">
      <label>${c("reservations.reports.pageSize","Ù„ÙƒÙ„ ØµÙØ­Ø©","Per page")}</label>
      <button type="button" data-size="25">25</button>
      <button type="button" data-size="50">50</button>
      <button type="button" data-size="100">100</button>
    </div>
  `,t.querySelector('[data-page="prev"]')?.addEventListener("click",()=>{r.pagination.page>1&&(r.pagination.page-=1,r.callbacks.onRender?.())}),t.querySelector('[data-page="next"]')?.addEventListener("click",()=>{const y=Math.max(1,Math.ceil(e/r.pagination.pageSize));r.pagination.page<y&&(r.pagination.page+=1,r.callbacks.onRender?.())}),t.querySelectorAll("[data-size]")?.forEach(y=>{y.addEventListener("click",()=>{const m=Number(y.dataset.size);Number.isFinite(m)&&m>0&&(r.pagination.pageSize=m,r.pagination.page=1,r.callbacks.onRender?.())})})}function lt(e,t,a){const o=e?.reservationId||e?.id||"â€”",s=X(String(o)),i=t.get(String(e?.customerId))?.customerName||c("reservations.reports.topCustomers.unknown","Ø¹Ù…ÙŠÙ„ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ","Unknown customer"),l=se(e),f=dt(l.statusValue),y=ut(l.statusValue,f),m=Array.isArray(e.paymentHistory)?e.paymentHistory:Array.isArray(e.payment_history)?e.payment_history:[],b=pt(l.paidStatus,m),u=m.length;let p=b.html;if(u>0){const I=c("reservations.paymentHistory.countLabel","{count} Ø¯ÙØ¹Ø©","{count} payments").replace("{count}",k(u));p=`<div class="reports-payment-cell">${b.html}<small class="reports-payment-subtext">${A(I)}</small></div>`}const E=$e(e?.start),h=D(e),x=S(h.finalTotal),w=h.companySharePercent>0?`${k(h.companySharePercent)}% (${S(h.companyShareAmount)})`:c("reservations.reports.results.share.none","Ø¨Ø¯ÙˆÙ† Ù†Ø³Ø¨Ø© Ø§Ù„Ø´Ø±ÙƒØ©","No company share"),v=S(h.netProfit),C=A(i);return{code:{html:A(s),text:s},customer:{html:C,text:i},date:{html:A(E),text:E},status:y,payment:{html:p,text:b.text},total:{html:A(x),text:x},share:{html:A(w),text:w},net:{html:A(v),text:v}}}function dt(e){switch(e){case"completed":return W(c("reservations.list.status.completed","ğŸ“ Ù…Ù†ØªÙ‡ÙŠ","Completed"));case"confirmed":return W(c("reservations.list.status.confirmed","âœ… Ù…Ø¤ÙƒØ¯","Confirmed"));case"pending":return W(c("reservations.list.status.pending","â³ ØºÙŠØ± Ù…Ø¤ÙƒØ¯","Pending"));case"cancelled":return W(c("reservations.list.status.cancelled","âŒ Ù…Ù„ØºÙŠ","Cancelled"));default:return X(e||"â€”")}}function ut(e,t){const a=W(t);return{html:`<span class="reservation-chip status-${["completed","confirmed","pending","cancelled"].includes(e)?e:"info"}">${A(a)}</span>`,text:a}}function pt(e,t=[]){const a=me(e),o=String(e??"").toLowerCase(),s=o==="paid"?"paid":o==="partial"?"partial":"unpaid";let n="";const i=c("reservations.create.summary.currency","Ø±ÙŠØ§Ù„","SR");Array.isArray(t)&&t.length&&(n=t.map(y=>{const m=y?.recordedAt?he(y.recordedAt):"â€”",b=Number.isFinite(Number(y?.amount))&&Number(y.amount)>0?`${X(Number(y.amount).toFixed(2))} ${i}`:"",u=Number.isFinite(Number(y?.percentage))&&Number(y.percentage)>0?`${X(Number(y.percentage).toFixed(2))}%`:"",p=[m];return b&&p.push(b),u&&p.push(u),p.filter(Boolean).join(" â€¢ ")}).join(`
`));const l=n?` title="${O(n)}"`:"";return{html:`<span class="reservation-chip status-${s}"${l}>${A(a)}</span>`,text:a}}function W(e){return X(String(e??"")).replace(/^[^A-Za-z0-9\u0600-\u06FF]+/,"").trim()||"â€”"}function xe(e){const t=he(new Date).replace(/-/g,"");return`${c("reservations.reports.export.filePrefix","ØªÙ‚Ø±ÙŠØ±-Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","reservations-report")}-${t}.${e}`}function mt(e,t,a){const o=new Blob([e],{type:a}),s=URL.createObjectURL(o),n=document.createElement("a");n.href=s,n.download=t,document.body.appendChild(n),n.click(),document.body.removeChild(n),setTimeout(()=>URL.revokeObjectURL(s),4e3)}function oe(e){if(!e||!e.length)return;const t=Object.keys(e[0]),a=[t.join(",")];e.forEach(s=>{const n=t.map(i=>`"${String(s[i]??"").replace(/"/g,'""')}"`);a.push(n.join(","))});const o=`\uFEFF${a.join(`\r
`)}\r
`;mt(o,xe("csv"),"text/csv;charset=utf-8;")}async function ht(e){try{const t=await Ke();if(!t){oe(e);return}const a=t.utils.json_to_sheet(e),o=t.utils.book_new(),s=c("reservations.reports.export.sheetName","Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª","Reservations");t.utils.book_append_sheet(o,a,s),t.writeFile(o,xe("xlsx"))}catch(t){console.error("âš ï¸ [reports] Excel export failed, falling back to CSV",t),oe(e)}}async function ft(e=[],t={}){const{exportReportsPdf:a}=await U(async()=>{const{exportReportsPdf:s}=await import("./pdfPages.DnFeKTMH.js");return{exportReportsPdf:s}},__vite__mapDeps([0,1,2,3,4,5,6,7,8,9]),import.meta.url),o=t?.action==="print"?"print":"save";await a(e,{action:o})}async function yt(e,t){switch(e){case"pdf":await ft(t);break;case"excel":await ht(t);break;case"csv":default:oe(t);break}}function gt(e){const t=document.getElementById("reports-top-customers");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${c("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(a=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="customer" data-search="${O(a.name)}">
        <td>${A(a.name)}</td>
        <td>${k(a.count)}</td>
        <td>${S(a.revenue)}</td>
      </tr>
    `).join("")}}function vt(e){const t=document.getElementById("reports-top-equipment");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${c("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(a=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="equipment" data-search="${O(a.name)}">
        <td>${A(a.name)}</td>
        <td>${k(a.count)}</td>
        <td>${S(a.revenue)}</td>
      </tr>
    `).join("")}}function bt(e){const t=document.getElementById("reports-crew-work");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="5" class="text-base-content/60">${c("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(a=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="technician" data-search="${O(a.name)}">
        <td>${A(a.name)}</td>
        <td>${k(a.days)}</td>
        <td>${S(a.billable)}</td>
        <td>${S(a.cost)}</td>
        <td>${S(a.billable-a.cost)}</td>
      </tr>
    `).join("")}}function xt(e){const t=document.getElementById("reports-payment-forecast");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${c("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(a=>`
      <tr>
        <td>${a.date}</td>
        <td>${c("reservations.reports.forecast.count","{count} Ø­Ø¬ÙˆØ²Ø§Øª","{count} reservations").replace("{count}",String(a.count||0))}</td>
        <td>${S(a.amount||0)}</td>
      </tr>
    `).join("")}}function kt(e){const t=document.getElementById("reports-top-outstanding");if(t){if(!e||e.length===0){t.innerHTML=`<tr><td colspan="3" class="text-base-content/60">${c("reservations.reports.table.emptyPeriod","Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.","No data for this period.")}</td></tr>`;return}t.innerHTML=e.map(a=>`
      <tr class="hover:bg-base-200 cursor-pointer" data-drilldown="reservation" data-search="${O(a.code)}">
        <td>#${A(String(a.code))} â€” ${A(a.customer||"")}</td>
        <td>${A(me(a.paidStatus))}</td>
        <td>${S(a.outstanding)}</td>
      </tr>
    `).join("")}}const g=r.filters;function St(e){if(r.columnControlsBound)return;const t=document.getElementById("reports-column-controls");t&&(t.querySelectorAll("input[data-column-toggle]").forEach(a=>{const o=a.dataset.columnToggle;o&&(a.checked=r.columnPreferences[o]!==!1,a.addEventListener("change",()=>{r.columnPreferences[o]=a.checked,e()}))}),r.columnControlsBound=!0,e())}function ke(){Object.entries(r.columnPreferences).forEach(([e,t])=>{document.querySelectorAll(`[data-report-column="${e}"]`).forEach(a=>{a.classList.toggle("hidden",!t)})})}function wt(e){if(r.exportHandlersBound)return;const t=document.querySelectorAll("[data-export]");t.length&&(t.forEach(a=>{a.addEventListener("click",async()=>{const{export:o=""}=a.dataset;if(o){a.disabled=!0;try{await e(o)}catch(s){console.error("âš ï¸ [reports] export failed",s)}finally{a.disabled=!1}}})}),r.exportHandlersBound=!0)}function Et(e,t){r.searchDebounceTimer&&(clearTimeout(r.searchDebounceTimer),r.searchDebounceTimer=null),r.searchDebounceTimer=setTimeout(()=>{g.search=e||"",t()},220)}function Ct(e,t){e&&(g.range="custom",g.start=e.startInput||null,g.end=e.endInput||null,t())}function $t(e,t){e&&(g.status=g.status===e?"all":e,t())}function At(e,t){e&&(g.payment=g.payment===e?"all":e,t())}function Lt(e,t){e&&(g.search=e,t())}function Pt({onClear:e}={}){const t=document.getElementById("reservations-active-filters");if(!t)return;const a=[],o=(s,n,i)=>{a.push(`<span class="filter-chip" data-chip="${s}">${n} <button type="button" aria-label="clear" data-clear="${s}">âœ•</button></span>`)};if(g.range&&g.range!=="all"){let s="";switch(g.range){case"last30":s=c("reservations.reports.filters.range.last30","Ø¢Ø®Ø± 30 ÙŠÙˆÙ…","Last 30 days");break;case"thisWeek":s=c("reservations.reports.filters.range.thisWeek","Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹","This week");break;case"thisMonth":s=c("reservations.reports.filters.range.thisMonth","Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±","This month");break;case"thisQuarter":s=c("reservations.reports.filters.range.thisQuarter","Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¨Ø¹","This quarter");break;case"thisYear":s=c("reservations.reports.filters.range.thisYear","Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø§Ù…","This year");break;case"custom":s=`${c("reservations.reports.filters.range.custom","Ù…Ø®ØµØµ","Custom")} (${g.start||"â€”"} â†’ ${g.end||"â€”"})`;break;default:s=g.range}o("range",s)}if(g.status&&g.status!=="all"){const s=c(`reservations.reports.filters.status.${g.status}`,g.status,g.status);o("status",s)}if(g.payment&&g.payment!=="all"){const s=c(`reservations.reports.filters.payment.${g.payment}`,g.payment,g.payment);o("payment",s)}if(g.share&&g.share!=="all"){const s=c(`reservations.reports.filters.share.${g.share}`,g.share,g.share);o("share",s)}g.search&&g.search.trim().length&&o("search",`ğŸ” ${g.search.trim()}`),t.innerHTML=a.join(""),t.querySelectorAll("[data-clear]").forEach(s=>{s.addEventListener("click",()=>{const n=s.dataset.clear;n&&(n==="range"?(g.range="all",g.start=null,g.end=null):n in g&&(n==="search"?g.search="":g[n]="all"),e?.(n))})})}function Tt(e=[],t=[]){const a=document.getElementById("reports-quick-chips");if(!a)return;const o=Array.isArray(e)?e:[],s=Array.isArray(t)?t:[],n=g.status||"all",i=g.payment||"all",l=(u,p,E,h,x)=>`<button type="button" class="${`chip ${x?"chip-active":""}`}" data-quick-${h}="${u}" title="${p}">${p} <span class="chip-count">${E}</span></button>`,f=(u,p)=>u.find(E=>(E.filterKey||"").toLowerCase()===p),y=[];["confirmed","pending","completed","cancelled"].forEach(u=>{const p=f(o,u)||{label:u,rawCount:0};y.push(l(u,p.label||u,p.rawCount||0,"status",n===u))}),y.push('<span style="padding:0 6px;opacity:.6;">|</span>'),["paid","partial","unpaid"].forEach(u=>{const p=f(s,u)||{label:u,rawCount:0};y.push(l(u,p.label||u,p.rawCount||0,"payment",i===u))}),a.innerHTML=y.join("")}const d=r.filters;function z(){try{const e=document.querySelector(".dashboard-header"),t=Math.max(0,Math.round(e?.getBoundingClientRect()?.height||64));document.documentElement.style.setProperty("--reports-sticky-offset",`${t}px`)}catch{}}const Se="reports.presets.v1";function J(){try{const e=JSON.parse(localStorage.getItem(Se)||"[]");return Array.isArray(e)?e:[]}catch{return[]}}function le(e){try{localStorage.setItem(Se,JSON.stringify(Array.isArray(e)?e:[]))}catch{}}function Rt(e){if(!e||!e.filters)return;const t=e.filters;d.range=t.range??d.range,d.status=t.status??d.status,d.payment=t.payment??d.payment,d.share=t.share??d.share,d.search=t.search??"",d.start=t.start??null,d.end=t.end??null,M(),T(),$()}function ae(){const e=document.getElementById("reports-preset-select");if(!e)return;const t=J();e.innerHTML='<option value="">â€”</option>'+t.map((a,o)=>`<option value="${o}">${a.name||"Preset"}</option>`).join("")}function Mt(){const e=document.getElementById("reports-preset-select"),t=document.getElementById("reports-preset-save"),a=document.getElementById("reports-preset-delete"),o=document.getElementById("reports-preset-share");!e||e.dataset.bound||(ae(),e.addEventListener("change",()=>{const s=Number(e.value),n=J();Number.isInteger(s)&&s>=0&&s<n.length&&Rt(n[s])}),t?.addEventListener("click",()=>{const s=window.prompt(c("reservations.reports.presets.savePrompt","Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù‚Ø§Ù„Ø¨","Enter preset name"),"Ù‚Ø§Ù„Ø¨");if(!s)return;const n=J(),i={range:d.range,status:d.status,payment:d.payment,share:d.share,search:d.search||"",start:d.start||null,end:d.end||null},l=n.findIndex(f=>(f.name||"").toLowerCase()===s.toLowerCase());l>=0?n[l]={name:s,filters:i}:n.push({name:s,filters:i}),le(n),ae()}),a?.addEventListener("click",()=>{const s=Number(e.value),n=J();!Number.isInteger(s)||s<0||s>=n.length||window.confirm(c("reservations.reports.presets.deleteConfirm","Ø­Ø°Ù Ø§Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø±ØŸ","Delete selected preset?"))&&(n.splice(s,1),le(n),ae(),e.value="")}),o?.addEventListener("click",async()=>{try{T(),await new Promise(n=>setTimeout(n,140));const s=window.location.href;await(navigator.clipboard?.writeText?navigator.clipboard.writeText(s):Promise.reject()),console.log("[reports] Link copied")}catch{try{const n=document.createElement("a");n.href=window.location.href,n.target="_blank",document.body.appendChild(n),n.click(),n.remove()}catch{}}}),e.dataset.bound="true")}function de(){re(),$(),setTimeout(()=>{re(),$(),K(),z()},0),setTimeout(()=>{re(),$(),K(),z()},60),K(),z()}function F(){d.range==="custom"&&$()}function K(e,t){if(!window.flatpickr)return;e&&(r.startDateInputRef=e),t&&(r.endDateInputRef=t);const a=r.startDateInputRef,o=r.endDateInputRef;if(!a&&!o)return;const s=It(),n=i=>{const l={dateFormat:"Y-m-d",allowInput:!0,disableMobile:!0,...i};return s&&(l.locale=s),l};if(r.startDatePicker&&(r.startDatePicker.destroy(),r.startDatePicker=null),r.endDatePicker&&(r.endDatePicker.destroy(),r.endDatePicker=null),a&&(r.startDatePicker=window.flatpickr(a,n({onChange(i,l){d.start=l||null,r.endDatePicker&&(i?.length?r.endDatePicker.set("minDate",i[0]):r.endDatePicker.set("minDate",null)),F()},onValueUpdate(i,l){d.start=l||null,F()}}))),o&&(r.endDatePicker=window.flatpickr(o,n({onChange(i,l){d.end=l||null,r.startDatePicker&&(i?.length?r.startDatePicker.set("maxDate",i[0]):r.startDatePicker.set("maxDate",null)),F()},onValueUpdate(i,l){d.end=l||null,F()}}))),r.startDatePicker&&a){r.startDatePicker.setDate(a.value,!1);const i=r.endDatePicker?.selectedDates?.[0]||r.endDateInputRef?.value;i&&r.startDatePicker.set("maxDate",i)}if(r.endDatePicker&&o){r.endDatePicker.setDate(o.value,!1);const i=r.startDatePicker?.selectedDates?.[0]||r.startDateInputRef?.value;i&&r.endDatePicker.set("minDate",i)}}function It(){return(Ye()||"ar").toLowerCase().startsWith("ar")?window.flatpickr?.l10ns?.ar?"ar":null:window.flatpickr?.l10ns?.en?"en":null}function ie(e,t){e&&(e.classList.toggle("active",!!t),e.classList.toggle("hidden",!t))}function M(){const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),a=document.getElementById("reports-payment-filter"),o=document.getElementById("reports-share-filter"),s=document.getElementById("reports-search"),n=document.getElementById("reports-start"),i=document.getElementById("reports-end"),l=document.getElementById("reports-custom-range");e&&e.value!==d.range&&(e.value=d.range),t&&t.value!==d.status&&(t.value=d.status),a&&a.value!==d.payment&&(a.value=d.payment),o&&o.value!==d.share&&(o.value=d.share),s&&s.value!==d.search&&(s.value=d.search||""),n&&n.value!==(d.start||"")&&(n.value=d.start||""),i&&i.value!==(d.end||"")&&(i.value=d.end||""),ie(l,d.range==="custom")}function Dt(){try{const e=new URLSearchParams(window.location.search),t=o=>e.get(o),a=o=>o==null||o===""?null:o;d.range=t("range")||d.range,d.status=t("status")||d.status,d.payment=t("payment")||d.payment,d.share=t("share")||d.share,d.search=t("search")||"",d.start=a(t("start")),d.end=a(t("end")),d.range!=="custom"&&(d.start=null,d.end=null)}catch{}}let ne=null;function T(){ne&&clearTimeout(ne),ne=setTimeout(()=>{try{const e=new URLSearchParams,t=(s,n,i)=>{n!=null&&n!==""&&n!==i&&e.set(s,n)};t("range",d.range,"all"),t("status",d.status,"all"),t("payment",d.payment,"all"),t("share",d.share,"all"),t("search",d.search,""),d.range==="custom"&&(t("start",d.start,null),t("end",d.end,null));const a=e.toString(),o=a?`${location.pathname}?${a}`:location.pathname;window.history.replaceState({},"",o)}catch{}},120)}function we({active:e,icon:t,title:a,subtitle:o}){const s=document.getElementById("reports-empty-state");if(!s)return;const n=s.querySelector(".reports-empty-icon"),i=s.querySelector("h4"),l=s.querySelector("p");r.emptyDefaults.icon===null&&n&&(r.emptyDefaults.icon=n.textContent),r.emptyDefaults.title===null&&i&&(r.emptyDefaults.title=i.textContent),r.emptyDefaults.subtitle===null&&l&&(r.emptyDefaults.subtitle=l.textContent),s.classList.toggle("active",!!e),s.classList.toggle("hidden",!e),!(!n||!i||!l)&&(e?(n.textContent=t!==void 0?t:r.emptyDefaults.icon??n.textContent,i.textContent=a!==void 0?a:r.emptyDefaults.title??i.textContent,l.textContent=o!==void 0?o:r.emptyDefaults.subtitle??l.textContent):(n.textContent=r.emptyDefaults.icon??n.textContent,i.textContent=r.emptyDefaults.title??i.textContent,l.textContent=r.emptyDefaults.subtitle??l.textContent))}function Bt(e){we({active:!!e})}function ue(e){const t=document.getElementById("reports-kpi-skeleton"),a=document.getElementById("reservations-reports-kpis"),o=document.getElementById("reports-table-skeleton"),s=document.getElementById("reports-reservations-table"),n=document.getElementById("reservations-revenue-skeleton"),i=document.getElementById("reservations-revenue-breakdown");t&&a&&(t.style.display=e?"":"none",a.style.opacity=e?"0.4":"1"),o&&s&&(o.style.display=e?"":"none",s.style.opacity=e?"0.4":"1"),n&&i&&(n.style.display=e?"":"none",i.style.opacity=e?"0.4":"1")}function Nt(){if(r.drilldownBound)return;const e=document.getElementById("reports-top-customers"),t=document.getElementById("reports-top-equipment"),a=document.getElementById("reports-reservations-body"),o=document.getElementById("reports-quick-chips"),s=n=>{const i=n.target?.closest("[data-drilldown]");if(!i)return;const l=i.dataset.search||"";Lt(l,()=>{M(),$()})};e?.addEventListener("click",s),t?.addEventListener("click",s),a?.addEventListener("click",s),o?.addEventListener("click",n=>{const i=n.target?.closest("[data-quick-status], [data-quick-payment]");if(i){if(i.hasAttribute("data-quick-status")){const l=i.getAttribute("data-quick-status")||"all";d.status=d.status===l?"all":l}else if(i.hasAttribute("data-quick-payment")){const l=i.getAttribute("data-quick-payment")||"all";d.payment=d.payment===l?"all":l}M(),T(),$()}}),r.drilldownBound=!0}function q(){V({silent:!0}).catch(e=>{console.error("âŒ [reports] Background refresh failed",e)})}function $(){if(M(),T(),Pt({onClear:()=>{M(),T(),$()}}),r.loading){ue(!0);return}if(r.errorMessage){we({active:!0,icon:"âš ï¸",title:r.errorMessage,subtitle:c("reservations.reports.status.retry","Ø¬Ø±Ù‘Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©.")});return}ue(!1);const{reservations:e,customers:t,equipment:a,technicians:o,maintenance:s}=r.data,n=Ae(e,d,t,a,o),i=Le(n),l=Pe(s,d),f=Te(i,l.total),y=Re(n),m=Me(n),b=Ie(n),u=De(n),p=Be(n,t),E=Ne(n,a),h=_e(n,o),x=je(n),w=He(n,t,5);at(f),Qe(y),et(m),rt(b),tt(u),Tt(m,u),gt(p),vt(E),kt(w),bt(h);try{xt(x)}catch{}const v=nt(n,t,o);ke(),Bt(n.length===0),r.lastSnapshot.filtered=n,r.lastSnapshot.metrics=f,r.lastSnapshot.trend=y,r.lastSnapshot.statusBreakdown=m,r.lastSnapshot.paymentBreakdown=u,r.lastSnapshot.tableRows=v,r.lastSnapshot.maintenance=l,r.lastSnapshot.outstanding=w,r.lastSnapshot.crewWork=h,r.lastSnapshot.paymentForecast=x}function _t(){if(r.initialized)return;r.initialized=!0;const e=document.getElementById("reports-range"),t=document.getElementById("reports-status-filter"),a=document.getElementById("reports-payment-filter"),o=document.getElementById("reports-share-filter"),s=document.getElementById("reports-start"),n=document.getElementById("reports-end"),i=document.getElementById("reports-custom-range"),l=document.getElementById("reports-search");if(!e)return;Dt(),M(),z(),Je()&&$(),e.addEventListener("change",()=>{d.range=e.value,ie(i,d.range==="custom"),d.range!=="custom"&&(d.start=null,d.end=null),T(),$(),V({silent:!0}).catch(()=>{})}),t?.addEventListener("change",()=>{d.status=t.value,T(),$()}),a?.addEventListener("change",()=>{d.payment=a.value,T(),$()}),o?.addEventListener("change",()=>{d.share=o.value,T(),$()}),l?.addEventListener("input",()=>{const m=l.value||"";Et(m,()=>{M(),T(),$()})}),s?.addEventListener("change",()=>{d.start=s.value||null,T(),F(),d.range==="custom"&&V({silent:!0}).catch(()=>{})}),n?.addEventListener("change",()=>{d.end=n.value||null,T(),F(),d.range==="custom"&&V({silent:!0}).catch(()=>{})}),K(s,n),ie(i,d.range==="custom"),Mt(),r.languageListenerAttached||(document.addEventListener("language:changed",de),document.addEventListener("language:translationsReady",de),r.languageListenerAttached=!0),r.dataListenersAttached||(document.addEventListener("reservations:changed",q),document.addEventListener("customers:changed",q),document.addEventListener("equipment:changed",q),document.addEventListener("projects:changed",q),document.addEventListener("technicians:updated",q),window.addEventListener("maintenance:updated",q),r.dataListenersAttached=!0),St?.(ke),wt(async m=>{const b=r.lastSnapshot.tableRows||[];if(!b.length){console.warn("[reports] No reservation data to export");return}if(m==="pdf")try{const{exportA4ReportPdf:u}=await U(async()=>{const{exportA4ReportPdf:p}=await import("./a4Unified.JaxWGw47.js");return{exportA4ReportPdf:p}},__vite__mapDeps([10,1,2,3,4,5,8,9,7]),import.meta.url);await u(b,{action:"save",strict:!0});return}catch(u){console.warn("[reports] page-based PDF export failed, falling back to legacy",u)}else if(m==="excel")try{const{exportA4ReportExcel:u}=await U(async()=>{const{exportA4ReportExcel:p}=await import("./a4Unified.JaxWGw47.js");return{exportA4ReportExcel:p}},__vite__mapDeps([10,1,2,3,4,5,8,9,7]),import.meta.url);await u(b);return}catch(u){console.warn("[reports] A4-based Excel export failed, falling back to legacy",u)}else if(m==="csv")try{const{exportA4ReportCsv:u}=await U(async()=>{const{exportA4ReportCsv:p}=await import("./a4Unified.JaxWGw47.js");return{exportA4ReportCsv:p}},__vite__mapDeps([10,1,2,3,4,5,8,9,7]),import.meta.url);await u(b);return}catch(u){console.warn("[reports] A4-based CSV export failed, falling back to legacy",u)}await yt(m,b)});const y=document.getElementById("reports-preview-pdf");if(y&&!y.dataset.bound&&(y.addEventListener("click",async()=>{try{const m=await U(()=>import("./preview.DxoeUlhb.js"),__vite__mapDeps([11,1,2,3,4,5,10,8,9,7]),import.meta.url),b=r.lastSnapshot.tableRows||[];m.openReportsPdfPreview(b)}catch(m){console.error("âš ï¸ [reports] Failed to open PDF preview",m)}}),y.dataset.bound="true"),Nt(),r.themeListenerAttached||(document.addEventListener("theme:changed",()=>{setTimeout(()=>{$(),z()},0)}),r.themeListenerAttached=!0),!r.stickyOffsetListenerAttached){const m=()=>z();window.addEventListener("resize",m),setTimeout(m,100),setTimeout(m,500),r.stickyOffsetListenerAttached=!0}qe($),Fe(()=>{$()}),ze(()=>{$()}),Oe(m=>{Ct(m,()=>{M(),$()})}),Ue(m=>{$t(m?.filterKey,()=>{M(),$()})}),Ve(m=>{At(m?.filterKey,()=>{M(),$()})}),V().catch(m=>{console.error("âŒ [reports] Failed to initialise reports data",m)})}const Xt=Object.freeze(Object.defineProperty({__proto__:null,initReports:_t,renderReports:$},Symbol.toStringTag,{value:"Module"}));export{Ke as a,Wt as b,Vt as e,Q as l,Xt as r};
