name: Build & Deploy (rclone)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Setup rclone
        uses: rclone/rclone-action@v2

      - name: Sync project to FTP server
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
        run: |
          set -euo pipefail
          rclone config create site ftp \
            host "${FTP_SERVER}" \
            user "${FTP_USERNAME}" \
            pass "${FTP_PASSWORD}" \
            port 21 \
            tls false
          rclone sync ./ site:/ \
            --transfers 8 \
            --checkers 10 \
            --ftp-concurrency 4 \
            --exclude "/.git/**" \
            --exclude "/.github/**" \
            --exclude "/node_modules/**" \
            --exclude "/art-ratio.com/node_modules/**" \
            --exclude "/tests/**" \
            --exclude "/README.md" \
            --exclude "/package-lock.json" \
            --exclude "/package.json" \
            --exclude "/art-ratio.com/package-lock.json" \
            --exclude "/art-ratio.com/package.json" \
            --exclude "/deploy-test*.txt" \
            --exclude "/vite.config.js" \
            --exclude "/vitest.config.js" \
            --exclude "/.gitignore" \
            --exclude "/src/**" \
            --exclude "/ART RATIO APP.code-workspace" \
            --exclude "/eqouipment list for app.xlsx" \
            --exclude "/main" \
            --exclude "/public/**" \
            --exclude "/deploy-test-latest.txt"

      - name: Create backend config from secret
        env:
          BACKEND_CONFIG_PHP: ${{ secrets.BACKEND_CONFIG_PHP }}
        run: |
          set -euo pipefail
          if [ -z "${BACKEND_CONFIG_PHP:-}" ]; then
            echo "BACKEND_CONFIG_PHP secret is empty." >&2
            exit 1
          fi
          mkdir -p backend
          # Decode the Base64 config into backend/config.php
          printf '%s' "${BACKEND_CONFIG_PHP}" | base64 -d > backend/config.php

      - name: Upload backend config via FTPS
        env:
          FTP_SERVER: ${{ secrets.FTP_SERVER }}
          FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
          FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
          FTP_PORT: ${{ secrets.FTP_PORT }}
          FTP_SKIP_TLS_VERIFY: ${{ secrets.FTP_SKIP_TLS_VERIFY }}
        run: |
          set -euo pipefail
          FTP_PORT="${FTP_PORT:-21}"
          CURL_ARGS=(
            --fail --show-error --silent
            --ftp-create-dirs --ftp-method nocwd --ftp-pasv
            --ftp-ssl --ssl-reqd
            --user "${FTP_USERNAME}:${FTP_PASSWORD}"
            -T backend/config.php
            "ftp://${FTP_SERVER}:${FTP_PORT}/backend/config.php"
          )
          if [ "${FTP_SKIP_TLS_VERIFY:-false}" = "true" ]; then
            CURL_ARGS+=( --insecure )
          fi
          curl "${CURL_ARGS[@]}"
