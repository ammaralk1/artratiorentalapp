name: Deploy to cPanel via FTP (with generated config.php)

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        run: npm run build

      - name: Generate backend/config.php from GitHub Secrets
        shell: bash
        run: |
          mkdir -p backend
          cat > backend/config.php <<'PHP'
          <?php
          return [
              'app' => [
                  'timezone' => 'Asia/Riyadh',
              ],
              'db' => [
                  'host' => getenv('DB_HOST') ?: '${{ secrets.DB_HOST }}',
                  'name' => getenv('DB_NAME') ?: '${{ secrets.DB_NAME }}',
                  'user' => getenv('DB_USER') ?: '${{ secrets.DB_USER }}',
                  'pass' => getenv('DB_PASS') ?: '${{ secrets.DB_PASS }}',
                  'charset' => 'utf8mb4',
              ],
              'security' => [
                  'allowed_origins' => array_values(array_filter(array_map('trim', explode(',', getenv('ALLOWED_ORIGINS') ?: '${{ secrets.ALLOWED_ORIGINS }}')))),
                  'session_name' => 'art_ratio_session',
                  'enforce_https' => false,
              ],
              'sirv' => [
                  'client_id' => getenv('SIRV_CLIENT_ID') ?: '',
                  'client_secret' => getenv('SIRV_CLIENT_SECRET') ?: '',
                  'api_base' => 'https://api.sirv.com',
                  'cdn_base' => 'https://art-ratio.sirv.com',
                  'upload_folder' => '/art-ratio/uploads',
              ],
              'email' => [
                  'enabled' => (bool) (getenv('SMTP_ENABLED') ?: '${{ secrets.SMTP_ENABLED }}'),
                  'provider' => 'smtp',
                  'from_email' => getenv('SMTP_FROM_EMAIL') ?: '${{ secrets.SMTP_FROM_EMAIL }}',
                  'from_name' => getenv('SMTP_FROM_NAME') ?: '${{ secrets.SMTP_FROM_NAME }}',
                  'smtp_host' => getenv('SMTP_HOST') ?: '${{ secrets.SMTP_HOST }}',
                  'smtp_port' => (int) (getenv('SMTP_PORT') ?: '${{ secrets.SMTP_PORT }}'),
                  'smtp_secure' => getenv('SMTP_SECURE') ?: '${{ secrets.SMTP_SECURE }}',
                  'smtp_user' => getenv('SMTP_USER') ?: '${{ secrets.SMTP_USER }}',
                  'smtp_pass' => getenv('SMTP_PASS') ?: '${{ secrets.SMTP_PASS }}',
                  'sendgrid_api_key' => getenv('SENDGRID_API_KEY') ?: '',
              ],
              'whatsapp' => [
                  'enabled' => (bool) (getenv('WHATSAPP_ENABLED') ?: '${{ secrets.WHATSAPP_ENABLED }}'),
                  'access_token' => getenv('WHATSAPP_ACCESS_TOKEN') ?: '${{ secrets.WHATSAPP_ACCESS_TOKEN }}',
                  'phone_number_id' => getenv('WHATSAPP_PHONE_NUMBER_ID') ?: '${{ secrets.WHATSAPP_PHONE_NUMBER_ID }}',
                  'api_base' => getenv('WHATSAPP_API_BASE') ?: 'https://graph.facebook.com/v20.0',
              ],
              'notifications' => [
                  'admin_receive_all' => true,
                  'admin_only' => true,
                  'admin_emails' => array_values(array_filter(array_map('trim', explode(',', getenv('ADMIN_EMAILS') ?: '${{ secrets.ADMIN_EMAILS }}')))),
                  'admin_whatsapp_numbers' => array_values(array_filter(array_map('trim', explode(',', getenv('ADMIN_WA_NUMBERS') ?: '${{ secrets.ADMIN_WA_NUMBERS }}')))),
                  'manager_emails' => [],
                  'manager_whatsapp_numbers' => [],
              ],
          ];
          PHP

      - name: Deploy via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASS }}
          server-dir: ${{ secrets.FTP_SERVER_DIR }}
          local-dir: .
          exclude: |
            **/.git*
            **/.github/**
            **/node_modules/**
            **/tests/**
            **/.vscode/**
            **/.DS_Store
            **/*.map
            **/vitest*.*
            **/CODE_CITATIONS.md
            **/README.md
            **/untitled folder/**
            .env*
          dangerous-clean-slate: false

