name: Deploy

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js (Node 22 for Vite 7)
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
          cache: 'npm'

      - name: Install and build frontend
        run: |
          npm ci --no-audit --fund=false
          npm run build

      - name: Upload files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: |
            dist
            backend
            .htaccess
          target: ${{ secrets.SSH_TARGET_DIR }}
          overwrite: true

      - name: Run remote post-deploy tasks
        uses: appleboy/ssh-action@v1.0.3
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          SSH_TARGET_DIR: ${{ secrets.SSH_TARGET_DIR }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script_stop: false
          script: |
            set -e
            cd "$SSH_TARGET_DIR"

            # Ensure TELEGRAM_BOT_TOKEN is available to Apache-mod_php via directory env
            if [ -n "$TELEGRAM_BOT_TOKEN" ]; then
              echo "SetEnv TELEGRAM_BOT_TOKEN \"$TELEGRAM_BOT_TOKEN\"" > backend/.htaccess
            fi

            # Optional: run SQL migrations if DB secrets are provided
            if [ -n "$DB_HOST" ] && [ -n "$DB_NAME" ] && [ -n "$DB_USER" ] && [ -n "$DB_PASS" ]; then
              echo "Running DB migrations..."
              mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" < backend/sql/alter_notification_events_phase1.sql || true
              mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" < backend/sql/add_technician_telegram.sql || true
            else
              echo "DB secrets not set; skipping SQL migrations"
            fi

            # Try to reload php-fpm or apache gracefully (ignore failures)
            sudo systemctl reload php-fpm || sudo systemctl reload php8.2-fpm || sudo systemctl reload apache2 || true
