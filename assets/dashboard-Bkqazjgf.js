import{t as r,g as R,n as b,f as D,s as y}from"./utils-BcYEmFqz.js";import{l as L,s as De,i as ue,a as Ne,b as Re,r as _,c as Fe,d as G,e as me,f as He,u as je}from"./reservationsUI-Nf5UWmZI.js";import{c as Pe,l as Oe}from"./auth-CM0vrJIa.js";import{r as Ye}from"./customers-3aPFRpaL.js";let H=null,oe=!1;function Ue(e){const n=e.paid===!0||e.paid==="paid",t=e.confirmed===!0||e.confirmed==="true";return e.completed?{background:"#6c757d",border:"#565e64",text:"#fff"}:n?t?{background:"#198754",border:"#146c43",text:"#fff"}:{background:"#ffc107",border:"#cc9a06",text:"#212529"}:{background:"#dc3545",border:"#b02a37",text:"#fff"}}function ze(e){const{reservationId:n,customerName:t,paid:a,confirmed:s,completed:o}=e.event.extendedProps,c=a===!0||a==="paid",i=s===!0||s==="true",d=document.createElement("div");d.className="fc-reservation-event";const l=i?r("calendar.badges.confirmed","مؤكد"):r("calendar.badges.pending","غير مؤكد"),f=c?r("calendar.badges.paid","مدفوع"):r("calendar.badges.unpaid","غير مدفوع"),u=r("calendar.badges.completed","منتهي"),p=r("calendar.labels.unknownCustomer","غير معروف");return d.innerHTML=`
    <div class="fc-reservation-id">${n}</div>
    <div class="fc-reservation-customer">${t||p}</div>
    <div class="fc-reservation-tags">
      <span class="badge ${i?"bg-success":"bg-warning text-dark"}">${l}</span>
      <span class="badge ${c?"bg-primary":"bg-danger"}">${f}</span>
      ${o?`<span class="badge bg-secondary">${u}</span>`:""}
    </div>
  `,{domNodes:[d]}}function Ve(e){var ne;const n=document.getElementById("calendar-reservation-details");if(!n){alert(r("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"));return}const t=e.confirmed===!0||e.confirmed==="true",a=e.paid===!0||e.paid==="paid",s=!!e.completed,o=t?r("calendar.badges.confirmed","مؤكد"):r("calendar.badges.pending","غير مؤكد"),c=a?r("calendar.badges.paid","مدفوع"):r("calendar.badges.unpaid","غير مدفوع"),i=r("calendar.badges.completed","منتهي"),d=R(),l=e.items||[],f=De()||[],u=new Map(f.map(m=>[String(m.id),m])),p=(e.technicians||[]).map(m=>u.get(String(m))).filter(Boolean),h=l.reduce((m,S)=>m+(S.qty||1)*(S.price||0),0),k=(()=>{const m=parseFloat(e.discount)||0;return m?e.discountType==="amount"?m:h*(m/100):0})(),w=Math.max(0,h-k),g=e.applyTax?w*.15:0,E=e.cost??Math.round(w+g),F=r("calendar.labels.currencySuffix","ريال"),O=l.length?l.map((m,S)=>{const ae=m.image||m.imageUrl||m.img||"",Le=b(String(m.barcode||"-")),Ce=b(String(m.qty||1)),Me=b(String(m.price||0)),Ae=ae?`<img src="${ae}" alt="${m.desc||""}" class="reservation-modal-item-thumb">`:"-";return`
          <tr>
            <td>${b(String(S+1))}</td>
            <td>${Le}</td>
            <td>${m.desc||"-"}</td>
            <td>${Ce}</td>
            <td>${Me} ${F}</td>
            <td>${Ae}</td>
          </tr>
        `}).join(""):`<tr><td colspan="6" class="text-center">${r("calendar.labels.noEquipment","لا توجد معدات")}</td></tr>`,C=[`<div>${r("calendar.summary.baseCost","💵 إجمالي المعدات: <strong>{value} ريال</strong>").replace("{value}",h.toFixed(2))}</div>`];if(k>0){const m=d==="en"?"%":"٪",S=e.discountType==="percent"?`${parseFloat(e.discount||0).toFixed(2)}${m}`:`${k.toFixed(2)} ${F}`;C.push(`<div>${r("calendar.summary.discount","💸 الخصم: <strong>{value}</strong>").replace("{value}",S)}</div>`)}e.applyTax&&g>0&&C.push(`<div>${r("calendar.summary.tax","🧾 الضريبة (15%): <strong>{value} ريال</strong>").replace("{value}",g.toFixed(2))}</div>`),C.push(`<div>${r("calendar.summary.total","💰 المجموع النهائي: <strong>{value} ريال</strong>").replace("{value}",E.toFixed(2))}</div>`);const Be=b(String(e.reservationId??e.id??"")),we=e.start?b(D(e.start)):"-",Se=e.end?b(D(e.end)):"-",Te=e.notes?b(e.notes):r("calendar.labels.noNotes","لا توجد ملاحظات"),qe=e.customerName||r("calendar.labels.unknownCustomer","غير معروف"),xe=[{icon:"🆔",label:r("calendar.labels.reservationId","رقم الحجز"),value:Be},{icon:"👤",label:r("calendar.labels.customer","العميل"),value:qe},{icon:"🗓️",label:r("calendar.labels.start","بداية الحجز"),value:we},{icon:"🗓️",label:r("calendar.labels.end","نهاية الحجز"),value:Se},{icon:"📝",label:r("calendar.labels.notes","الملاحظات"),value:Te}];n.innerHTML=`
    <div class="calendar-reservation-status mb-3">
      <span class="badge ${t?"bg-success":"bg-warning text-dark"}">${o}</span>
      <span class="badge ${a?"bg-primary":"bg-danger"}">${c}</span>
      ${s?`<span class="badge bg-secondary">${i}</span>`:""}
    </div>
    <div class="calendar-reservation-info">
      ${xe.map(m=>`
        <div class="calendar-info-row">
          <span class="label">${m.icon} ${m.label}</span>
          <span class="value">${m.value}</span>
        </div>
      `).join("")}
    </div>
    <h6 class="calendar-section-title">${r("calendar.sections.crew","😎 الفريق الفني")}</h6>
    ${p.length?`<ul class="list-unstyled calendar-reservation-technicians">${p.map(m=>{const S=m.role?` — ${m.role}`:"";return`<li><strong>${m.name}</strong>${S}</li>`}).join("")}</ul>`:`<p class="calendar-empty-state">${r("calendar.emptyStates.noCrew","😎 لا يوجد فريق مرتبط بهذا الحجز.")}</p>`}
    <h6 class="calendar-section-title">${r("calendar.sections.equipment","📦 المعدات")}</h6>
    <div class="table-responsive reservation-modal-items-wrapper">
      <table class="table table-sm table-hover align-middle reservation-modal-items-table">
        <thead>
          <tr>
            <th>#</th>
            <th>${r("calendar.table.headers.barcode","الباركود")}</th>
            <th>${r("calendar.table.headers.description","الوصف")}</th>
            <th>${r("calendar.table.headers.quantity","الكمية")}</th>
            <th>${r("calendar.table.headers.price","السعر")}</th>
            <th>${r("calendar.table.headers.image","الصورة")}</th>
          </tr>
        </thead>
        <tbody>${O}</tbody>
      </table>
    </div>
    <div class="calendar-reservation-summary">
      ${C.join("")}
    </div>
  `;const te=document.getElementById("calendarReservationModal");te&&((ne=window.bootstrap)!=null&&ne.Modal)?window.bootstrap.Modal.getOrCreateInstance(te).show():alert(r("calendar.alerts.cannotOpenModal","لا يمكن فتح نافذة التفاصيل"))}function K(){console.log("✅ renderCalendar تعمل");const e=document.getElementById("calendar");if(!e)return;H&&(H.destroy(),H=null);const{reservations:n=[],customers:t=[]}=L(),a=n.map(o=>{const c=t.find(l=>String(l.id)===String(o.customerId)),i=o.end?new Date(o.end)<new Date:!1,d=Ue({...o,completed:i});return{id:o.id,title:"",start:o.start,end:o.end,backgroundColor:d.background,borderColor:d.border,textColor:d.text,display:"auto",extendedProps:{...o,customerName:(c==null?void 0:c.customerName)||r("calendar.labels.unknownCustomer","غير معروف"),completed:i}}}),s=new FullCalendar.Calendar(e,{initialView:"dayGridMonth",locale:R(),timeZone:"local",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},buttonText:{today:r("calendar.buttons.today","اليوم"),month:r("calendar.buttons.month","شهر"),week:r("calendar.buttons.week","أسبوع"),day:r("calendar.buttons.day","يوم")},events:a,eventContent:ze,eventClick:function(o){Ve(o.event.extendedProps)}});s.render(),H=s,oe||(document.addEventListener("language:changed",()=>{K()}),oe=!0)}let se=null,Y=null,U=null;const We={range:"last30",start:null,end:null};function v(e,n,t=n){const a=R()==="en"?t??n:n;return r(e,a)}function pe(){return(R()||"ar").toLowerCase().startsWith("ar")?"ar-SA":"en-US"}function fe(){const e=R();if(e!==se||!Y||!U){se=e;const n=pe();Y=new Intl.NumberFormat(n,{maximumFractionDigits:0}),U=new Intl.NumberFormat(n,{style:"currency",currency:"SAR",maximumFractionDigits:0})}return{numberFormatter:Y,currencyFormatter:U}}function _e(e){const n=pe();return new Intl.DateTimeFormat(n,{month:"short"}).format(e)}function Ge(){const{reservations:e=[],customers:n=[],equipment:t=[]}=L(),a=Ke(e,We),s=Qe(a),o=Ze(a),c=Xe(a),i=et(a),d=tt(a,n),l=nt(a,t);ct(s),at(o),ce("reports-status-breakdown",c),ce("reports-payment-breakdown",i),ot(d),st(l),rt(a.length===0)}function Ke(e,n){const{startDate:t,endDate:a}=Je(n);return(e||[]).filter(s=>{const o=s!=null&&s.start?new Date(s.start):null;return!(!o||Number.isNaN(o.getTime())||t&&o<t||a&&o>a)})}function Je({range:e,start:n,end:t}){const a=new Date;a.setHours(23,59,59,999);const s=new Date(a);let o=null;switch(e){case"last30":{o=new Date(a),o.setDate(o.getDate()-29);break}case"thisWeek":{const c=new Date(a),d=(c.getDay()-6+7)%7;c.setDate(c.getDate()-d),c.setHours(0,0,0,0);const l=new Date(c);l.setDate(c.getDate()+6),l.setHours(23,59,59,999),o=c,s.setTime(l.getTime());break}case"thisMonth":{o=new Date(a.getFullYear(),a.getMonth(),1);break}case"thisQuarter":{const c=Math.floor(a.getMonth()/3);o=new Date(a.getFullYear(),c*3,1);break}case"thisYear":{o=new Date(a.getFullYear(),0,1);break}case"all":default:o=null;break}return o&&o.setHours(0,0,0,0),{startDate:o,endDate:s}}function be(e){return(e==null?void 0:e.confirmed)===!0||(e==null?void 0:e.confirmed)==="true"}function Qe(e){const n=e.length,t=e.filter(be).length,a=e.filter(ue).length,s=e.filter(i=>i==null?void 0:i.paid).length,o=e.reduce((i,d)=>i+(Number(d==null?void 0:d.cost)||0),0),c=n?o/n:0;return{total:n,confirmed:t,completed:a,paidCount:s,revenue:o,average:c}}function Ze(e){const n=new Date,t=[];for(let a=5;a>=0;a-=1){const s=new Date(n.getFullYear(),n.getMonth()-a,1),o=s.getFullYear(),c=s.getMonth(),i=e.filter(u=>{const p=u!=null&&u.start?new Date(u.start):null;return p&&p.getFullYear()===o&&p.getMonth()===c}),d=i.length,l=i.reduce((u,p)=>u+(Number(p==null?void 0:p.cost)||0),0),f=_e(s);t.push({label:f,count:d,revenue:l})}return t}function Xe(e){const n=e.length||1,t=e.filter(be).length,a=e.length-t,s=e.filter(ue).length;return[{label:v("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:t,percent:Math.round(t/n*100)||0,rawCount:t,className:"status-confirmed"},{label:v("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:a,percent:Math.round(a/n*100)||0,rawCount:a,className:"status-pending"},{label:v("reservations.reports.status.completedLabel","منتهية","Completed"),value:s,percent:Math.round(s/n*100)||0,rawCount:s,className:"status-completed"}]}function et(e){const n=e.length||1,t=e.filter(s=>s==null?void 0:s.paid).length,a=e.length-t;return[{label:v("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:t,percent:Math.round(t/n*100)||0,rawCount:t,className:"status-paid"},{label:v("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:a,percent:Math.round(a/n*100)||0,rawCount:a,className:"status-unpaid"}]}function tt(e,n){const t=new Map,a=new Map((n||[]).map(s=>[String(s.id),s]));return e.forEach(s=>{const o=String((s==null?void 0:s.customerId)??"unknown"),c=t.get(o)||{count:0,revenue:0};c.count+=1,c.revenue+=Number(s==null?void 0:s.cost)||0,t.set(o,c)}),Array.from(t.entries()).map(([s,o])=>{const c=a.get(s);return{name:(c==null?void 0:c.customerName)||v("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:o.count,revenue:o.revenue}}).sort((s,o)=>o.revenue-s.revenue).slice(0,5)}function nt(e,n){const t=new Map,a=new Map((n||[]).map(s=>[re(s==null?void 0:s.barcode),s]));return e.forEach(s=>{((s==null?void 0:s.items)||[]).forEach(o=>{var p,h;const c=re(o==null?void 0:o.barcode),i=c||((o==null?void 0:o.desc)??"unknown"),d=(o==null?void 0:o.desc)||((p=a.get(c))==null?void 0:p.desc)||((h=a.get(c))==null?void 0:h.description)||v("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment"),l=Number(o==null?void 0:o.qty)||1,f=l*(Number(o==null?void 0:o.price)||0),u=t.get(i)||{name:d,count:0,revenue:0};u.name=d,u.count+=l,u.revenue+=f,t.set(i,u)})}),Array.from(t.values()).sort((s,o)=>o.count-s.count).slice(0,5)}function at(e){const n=document.getElementById("reports-volume-chart");if(!n)return;if(!e||e.length===0){n.innerHTML=`<p class="text-muted">${v("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const t=Math.max(1,...e.map(a=>a.count));n.innerHTML=e.map(a=>`
        <div class="reports-chart-bar">
          <div class="bar" style="height: ${Math.max(8,Math.round(a.count/t*100))}%"></div>
          <span class="value">${B(a.count)}</span>
          <span class="label">${a.label}</span>
        </div>
      `).join("")}function ce(e,n){const t=document.getElementById(e);if(t){if(!n||n.length===0){t.innerHTML=`<p class="text-muted">${v("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}t.innerHTML=n.map(a=>`
      <div class="reports-progress-row">
        <div class="reports-progress-top">
          <span>${a.label}</span>
          <span>${B(a.percent)}%</span>
        </div>
        <div class="reports-progress-bar">
          <div class="reports-progress-fill ${a.className}" style="width: ${Math.min(a.percent,100)}%"></div>
        </div>
        <div class="reports-progress-meta">${v("reservations.reports.progress.meta","{count} حجز","{count} reservations").replace("{count}",B(a.rawCount??a.value))}</div>
      </div>
    `).join("")}}function ot(e){const n=document.getElementById("reports-top-customers");if(n){if(!e||e.length===0){n.innerHTML=`<tr><td colspan="3" class="text-muted">${v("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}n.innerHTML=e.map(t=>`
      <tr>
        <td>${t.name}</td>
        <td>${B(t.count)}</td>
        <td>${j(t.revenue)}</td>
      </tr>
    `).join("")}}function st(e){const n=document.getElementById("reports-top-equipment");if(n){if(!e||e.length===0){n.innerHTML=`<tr><td colspan="3" class="text-muted">${v("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}n.innerHTML=e.map(t=>`
      <tr>
        <td>${t.name}</td>
        <td>${B(t.count)}</td>
        <td>${j(t.revenue)}</td>
      </tr>
    `).join("")}}function ct(e){const n=document.getElementById("reports-kpi-total"),t=document.getElementById("reports-kpi-total-meta"),a=document.getElementById("reports-kpi-revenue"),s=document.getElementById("reports-kpi-revenue-meta"),o=document.getElementById("reports-kpi-confirmed"),c=document.getElementById("reports-kpi-confirmed-meta"),i=document.getElementById("reports-kpi-paid"),d=document.getElementById("reports-kpi-paid-meta"),l=e.total||0,f=e.revenue||0,u=e.confirmed||0,p=e.paidCount||0,h=e.average||0,k=l?Math.round(u/l*100):0,w=l?Math.round(p/l*100):0;if(n&&(n.textContent=B(l)),t){const g=v("reservations.reports.kpi.total.dynamicMeta","منها {count} منتهية","Includes {count} completed").replace("{count}",B(e.completed||0));t.textContent=g}if(a&&(a.textContent=j(f)),s){const g=v("reservations.reports.kpi.revenue.average","متوسط قيمة الحجز {value}","Average reservation value {value}").replace("{value}",j(h));s.textContent=g}if(o&&(o.textContent=`${k}%`),c){const g=v("reservations.reports.kpi.confirmed.detail","{count} حجوزات مؤكدة","{count} confirmed reservations").replace("{count}",B(u));c.textContent=g}if(i&&(i.textContent=`${w}%`),d){const g=v("reservations.reports.kpi.paid.detail","{count} حجوزات مدفوعة","{count} paid reservations").replace("{count}",B(p));d.textContent=g}}function rt(e){const n=document.getElementById("reports-empty-state");n&&n.classList.toggle("active",!!e)}function B(e){const{numberFormatter:n}=fe(),t=n.format(Math.round(e||0));return b(t)}function j(e){const{currencyFormatter:n}=fe(),t=n.format(Math.max(0,Math.round(e||0)));return b(t)}function re(e){return(e||"").toString().trim()}let N=[],q=[],M=null;function z(){return r("maintenance.form.selectedInfo","لم يتم اختيار معدة بعد.")}function $(e){return b(String(e||"")).trim().toLowerCase()}function ie(e=""){return b(String(e)).trim().toLowerCase()}function I(){const{maintenance:e=[]}=L();return N=Array.isArray(e)?e:[],N}function J(e){N=e;try{localStorage.setItem("maintenanceList",JSON.stringify(e))}catch(n){console.warn("⚠️ [maintenance] Failed to persist maintenance tickets",n),y(r("maintenance.toast.storageError","⚠️ تعذر حفظ بيانات الصيانة. يرجى المحاولة مجدداً."))}}function Q(){const{equipment:e=[]}=L(),n=r("maintenance.table.noName","بدون اسم");return q=(e||[]).map(t=>({barcode:$(t==null?void 0:t.barcode),desc:(t==null?void 0:t.desc)||(t==null?void 0:t.description)||(t==null?void 0:t.name)||n,status:(t==null?void 0:t.status)||"متاح",price:Number(t==null?void 0:t.price)||0,category:(t==null?void 0:t.category)||""})),q.sort((t,a)=>t.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),q}function ge(){return new Set(I().filter(e=>e.status==="open").map(e=>$(e.equipmentBarcode)))}function P(e){const n=$(e);return n&&(q.length?q:Q()).find(a=>a.barcode===n)||null}function it(e){const n=ie(e);return n&&(q.length?q:Q()).find(a=>ie(a.desc).includes(n))||null}function V(e){if(!e)return!0;const n=ge();return e.status==="صيانة"||n.has(e.barcode)}function T({keepInputs:e=!1,silent:n=!1}={}){const t=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),s=document.getElementById("maintenance-equipment-search"),o=document.getElementById("maintenance-selected-info");t&&(t.value=""),e||(a&&(a.value=""),s&&(s.value="")),o&&(o.textContent=z()),M=null}function ve(e){const n=document.getElementById("maintenance-selected-info");if(!n)return;const t=r("maintenance.info.barcodeLabel","باركود"),a=r("maintenance.report.notAvailable","غير متوفر");n.innerHTML=`
    <strong>${e.desc}</strong><br>
    <span class="text-muted">${t}: ${e.barcode||a}</span>
  `}function Z(e,{silent:n=!1}={}){if(!e)return!1;if(V(e))return n||y(r("maintenance.toast.equipmentBlocked","⚠️ هذه المعدة قيد الصيانة ولا يمكن اختيارها حالياً")),!1;const t=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),s=document.getElementById("maintenance-equipment-search");return t&&(t.value=e.barcode),a&&(a.value=e.barcode),s&&(s.value=e.desc),ve(e),M=e,!0}function ye(e,{showFeedback:n=!0}={}){const t=P(e);return t?Z(t,{silent:!n}):(n&&y(r("maintenance.toast.equipmentNotFoundBarcode","❌ لم يتم العثور على معدة بهذا الباركود")),!1)}function he(e,{showFeedback:n=!0}={}){const t=it(e);return t?Z(t,{silent:!n}):(n&&y(r("maintenance.toast.equipmentNotFoundName","❌ لم يتم العثور على معدة بالاسم المدخل")),!1)}function X(){const e=document.getElementById("maintenance-equipment-options"),n=document.getElementById("maintenance-equipment-barcode"),t=document.getElementById("maintenance-equipment-search"),a=Q(),s=ge();if(e){const c=r("maintenance.form.blockedSuffix","(صيانة)");e.innerHTML=a.map(i=>{const l=i.status==="صيانة"||s.has(i.barcode)?`${i.desc} ${c}`:i.desc,f=i.desc.replace(/"/g,"&quot;"),u=l.replace(/"/g,"&quot;");return`<option value="${f}" label="${u}"></option>`}).join("")}const o=document.getElementById("maintenance-selected-barcode");if(o&&o.value){const c=P(o.value);!c||V(c)?(T({keepInputs:!0,silent:!0}),c&&V(c)&&y(r("maintenance.toast.equipmentBecameBlocked","⚠️ هذه المعدة أصبحت قيد الصيانة ولا يمكن اختيارها"))):Z(c,{silent:!0})}else T({keepInputs:!0,silent:!0});if(n&&!n.dataset.listenerAttached&&(n.addEventListener("keydown",c=>{c.key==="Enter"&&(c.preventDefault(),ye(n.value)||T({keepInputs:!0,silent:!0}))}),n.dataset.listenerAttached="true"),t&&!t.dataset.listenerAttached){const c=()=>{if(!t.value){T({keepInputs:!0,silent:!0});return}he(t.value)||T({keepInputs:!0,silent:!0})};t.addEventListener("change",c),t.addEventListener("keydown",i=>{i.key==="Enter"&&(i.preventDefault(),c())}),t.dataset.listenerAttached="true"}}function ee(e,n){const t=$(e),{equipment:a=[]}=L(),s=(a||[]).map(o=>$(o==null?void 0:o.barcode)===t?{...o,status:n}:o);Ne({equipment:s}),Re(),_(),X()}function lt(e){const n=document.getElementById("maintenance-stats");if(!n)return;const t=N.length,a=N.filter(l=>l.status==="open").length,s=t-a,o=l=>b(String(l)),c=r("maintenance.stats.open","{count} قيد الصيانة").replace("{count}",`<strong>${o(a)}</strong>`),i=r("maintenance.stats.closed","{count} مغلقة").replace("{count}",`<strong>${o(s)}</strong>`),d=r("maintenance.stats.total","{count} إجمالي التذاكر").replace("{count}",`<strong>${o(t)}</strong>`);n.innerHTML=`
    <span class="maintenance-stat">${c}</span>
    <span class="maintenance-stat">${i}</span>
    <span class="maintenance-stat">${d}</span>
  `}function dt(e){const n=document.getElementById("maintenance-table-body"),t=document.getElementById("maintenance-empty-state");if(n){if(!e||e.length===0){const a=r("maintenance.table.emptyFiltered","لا توجد تذاكر ضمن هذا الفلتر.");n.innerHTML=`<tr><td colspan="6" class="text-muted text-center">${a}</td></tr>`,t&&t.classList.add("active");return}t&&t.classList.remove("active"),n.innerHTML=e.map(a=>{const s=r("maintenance.status.open","قيد الصيانة"),o=r("maintenance.status.closed","مغلقة"),c=a.status==="open"?`<span class="badge bg-warning text-dark">${s}</span>`:`<span class="badge bg-success">${o}</span>`,i=(()=>{const F=r("maintenance.priority.high","مرتفعة"),O=r("maintenance.priority.medium","متوسطة"),C=r("maintenance.priority.low","منخفضة");switch(a.priority){case"high":return`<span class="badge bg-danger">${F}</span>`;case"low":return`<span class="badge bg-secondary">${C}</span>`;default:return`<span class="badge bg-info text-dark">${O}</span>`}})(),d=[],l=r("maintenance.actions.close","🔧 إغلاق بعد الإصلاح"),f=r("maintenance.actions.view","👁️ عرض التقرير"),u=r("maintenance.actions.delete","🗑️ حذف التذكرة");a.status==="open"?d.push(`<button class="btn btn-sm btn-success" data-action="close" data-id="${a.id}">${l}</button>`):d.push(`<button class="btn btn-sm btn-warning" data-action="view" data-id="${a.id}">${f}</button>`),d.push(`<button class="btn btn-sm btn-danger" data-action="delete" data-id="${a.id}">${u}</button>`);const p=d.join(""),h=r("maintenance.table.noBarcode","بدون باركود"),k=r("maintenance.report.none","—"),w=a.equipmentBarcode?b(a.equipmentBarcode):h,g=a.issue?b(a.issue):k,E=a.createdAt?b(D(a.createdAt)):"—";return`
        <tr>
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${w}</small>
          </td>
          <td class="maintenance-issue-text">${g}</td>
          <td>${i}</td>
          <td>${E}</td>
          <td>${c}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${p}
            </div>
          </td>
        </tr>
      `}).join("")}}function ut(e){const n=e.target.closest("button[data-action]");if(!n)return;const t=n.getAttribute("data-action"),a=Number(n.getAttribute("data-id"));a&&(t==="close"?Ee(a):t==="view"?$e(a):t==="delete"&&Ie(a))}function Ee(e){const n=I(),t=n.findIndex(o=>Number(o.id)===Number(e));if(t===-1)return;const a=prompt(r("maintenance.prompt.closeReport","أدخل تقرير الإصلاح / الإجراءات المتخذة:"));if(a===null)return;const s={...n[t]};s.status="closed",s.resolutionReport=a.trim(),s.resolvedAt=new Date().toISOString(),n[t]=s,J(n),ee(s.equipmentBarcode,"متاح"),y(r("maintenance.toast.ticketClosed","✅ تم إغلاق تذكرة الصيانة وإعادة المعدة إلى الحالة المتاحة")),x()}function $e(e){const t=I().find(p=>Number(p.id)===Number(e));if(!t)return;const a=r("maintenance.report.equipment","المعدة"),s=r("maintenance.report.barcode","الباركود"),o=r("maintenance.report.issue","الوصف"),c=r("maintenance.report.createdAt","تاريخ الإنشاء"),i=r("maintenance.report.closedAt","تاريخ الإغلاق"),d=r("maintenance.report.summary","التقرير"),l=r("maintenance.report.notAvailable","غير متوفر"),f=r("maintenance.report.none","—"),u=[`${a}: ${t.equipmentDesc}`,`${s}: ${t.equipmentBarcode?b(t.equipmentBarcode):l}`,`${o}: ${t.issue?b(t.issue):f}`,`${c}: ${t.createdAt?b(D(t.createdAt)):f}`,`${i}: ${t.resolvedAt?b(D(t.resolvedAt)):f}`,`${d}: ${t.resolutionReport?b(t.resolutionReport):f}`].join(`
`);alert(u)}function Ie(e){const n=I(),t=n.findIndex(s=>Number(s.id)===Number(e));if(t===-1)return;const a=n[t];confirm(r("maintenance.toast.ticketDeleteConfirm","⚠️ هل أنت متأكد من حذف تذكرة الصيانة؟"))&&(n.splice(t,1),J(n),a.status==="open"&&ee(a.equipmentBarcode,"متاح"),y(r("maintenance.toast.ticketDeleted","🗑️ تم حذف تذكرة الصيانة")),x())}function ke(e){e.preventDefault();try{const n=document.getElementById("maintenance-equipment-barcode"),t=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),s=document.getElementById("maintenance-issue"),o=document.getElementById("maintenance-priority");let c=M,i=$(a==null?void 0:a.value);if(!c&&i&&(c=P(i)),!c&&(n!=null&&n.value)&&ye(n.value,{showFeedback:!0})&&(c=M,i=$(c==null?void 0:c.barcode)),!c&&(t!=null&&t.value)&&he(t.value,{showFeedback:!0})&&(c=M,i=$(c==null?void 0:c.barcode)),!c||!i){y(r("maintenance.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const{equipment:d=[]}=L();let l=(d||[]).find(E=>$(E==null?void 0:E.barcode)===i);if(!l&&c&&(l={barcode:c.barcode,desc:c.desc,name:c.desc,status:c.status||"متاح"}),!l){y(r("maintenance.toast.selectedNotFound","❌ لم يتم العثور على المعدة المختارة")),T();return}if(l.status==="صيانة"){y(r("maintenance.toast.equipmentAlreadyMaintenance","⚠️ هذه المعدة بالفعل في حالة صيانة"));return}if(I().filter(E=>E.status==="open").some(E=>$(E.equipmentBarcode)===i)){y(r("maintenance.toast.ticketExists","⚠️ توجد تذكرة صيانة مفتوحة لهذه المعدة"));return}const p=r("maintenance.table.noName","بدون اسم"),h={id:Date.now(),equipmentBarcode:i,equipmentDesc:l.desc||l.description||l.name||p,issue:(s==null?void 0:s.value.trim())||"",priority:(o==null?void 0:o.value)||"medium",status:"open",createdAt:new Date().toISOString(),resolutionReport:"",resolvedAt:null},k=I(),w=[h,...k];J(w),ee(i,"صيانة"),y(r("maintenance.toast.ticketCreated","🛠️ تم إنشاء تذكرة الصيانة وإيقاف المعدة")),T(),s&&(s.value=""),o&&(o.value="medium");const g=document.getElementById("maintenance-status-filter");g&&(g.value="all"),x()}catch(n){console.error("❌ [maintenance] Failed to create ticket",n),y(r("maintenance.toast.submitError","⚠️ تعذر إنشاء تذكرة الصيانة. يرجى المحاولة مجدداً."))}}function mt(e){const n=I();return e==="all"?n:n.filter(t=>t.status===e)}function x(){I(),X();const e=document.getElementById("maintenance-status-filter");e&&!e.value&&(e.value="all");const n=(e==null?void 0:e.value)||"all",t=mt(n);lt(),dt(t)}function pt(){I(),X(),x();const e=document.getElementById("maintenance-form");e&&!e.dataset.listenerAttached&&(e.addEventListener("submit",ke),e.dataset.listenerAttached="true");const n=document.getElementById("maintenance-status-filter");n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{x()}),n.dataset.listenerAttached="true");const t=document.querySelector(".maintenance-table");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",ut),t.dataset.listenerAttached="true")}I();document.addEventListener("language:changed",()=>{const e=document.getElementById("maintenance-selected-barcode"),n=document.getElementById("maintenance-selected-info");if(e!=null&&e.value){const t=P(e.value);t?ve(t):n&&(n.textContent=z())}else n&&(n.textContent=z());x()});document.addEventListener("submit",e=>{const n=e.target;(n==null?void 0:n.id)==="maintenance-form"&&!n.dataset.listenerAttached&&ke(e)});document.addEventListener("click",e=>{const n=e.target.closest("button[data-action]");if(!n||!n.closest(".maintenance-table"))return;const t=n.dataset.action,a=Number(n.dataset.id);a&&(t==="close"?Ee(a):t==="view"?$e(a):t==="delete"&&Ie(a))});const le="dashboard-active-tab",W="dashboard-active-sub-tab",A={get(e){try{return localStorage.getItem(e)}catch(n){return console.warn("⚠️ [tabs.js] localStorage.getItem failed",{key:e,error:n}),null}},set(e,n){try{localStorage.setItem(e,n)}catch(t){console.warn("⚠️ [tabs.js] localStorage.setItem failed",{key:e,value:n,error:t})}},remove(e){try{localStorage.removeItem(e)}catch(n){console.warn("⚠️ [tabs.js] localStorage.removeItem failed",{key:e,error:n})}}};function ft(){var c;console.log("🚀 [tabs.js] setupTabs()");const e=document.querySelectorAll("[data-tab]"),n=document.querySelectorAll(".tab");console.log("📌 tabButtons:",e),console.log("📌 tabContents:",n);const t=(i,{skipStore:d=!1}={})=>{if(!i)return;const l=document.querySelector(`[data-tab="${i}"]`),f=document.getElementById(i);!l||!f||(e.forEach(u=>u.classList.remove("active")),l.classList.add("active"),n.forEach(u=>{const p=u.id===i;u.style.display=p?"block":"none",u.classList.toggle("active",p)}),d||A.set(le,i),i==="customers-tab"&&(console.log("👤 Rendering customers"),Ye()),i==="equipment-tab"&&(console.log("📦 Rendering equipment"),_()),i==="maintenance-tab"&&(console.log("🛠️ Rendering maintenance"),x()),i==="technicians-tab"&&(console.log("🛠️ Rendering technicians"),Fe()),i==="reservations-tab"&&(console.log("📅 Rendering reservations"),G(),bt()))};e.forEach(i=>{i.addEventListener("click",()=>{const d=i.getAttribute("data-tab");console.log("🖱️ Tab clicked:",d),t(d),d!=="reservations-tab"&&A.remove(W)})});const a=A.get(le),s=document.querySelector("[data-tab].active"),o=a&&document.getElementById(a)?a:s==null?void 0:s.getAttribute("data-tab");o&&(console.log("⭐ Initial tab:",o),t(o,{skipStore:!!a})),(c=document.body)==null||c.classList.remove("tabs-loading")}function bt(){console.log("🚀 [tabs.js] setupSubTabs()");const e=document.querySelectorAll(".sub-tab-button"),n=document.querySelectorAll(".sub-tab");console.log("📌 subTabButtons:",e),console.log("📌 subTabContents:",n);const t=(c,{skipStore:i=!1}={})=>{if(!c)return;const d=document.querySelector(`.sub-tab-button[data-sub-tab="${c}"]`),l=document.getElementById(c);!d||!l||(e.forEach(f=>f.classList.remove("active")),d.classList.add("active"),n.forEach(f=>{f.classList.remove("active")}),l.classList.add("active"),i||A.set(W,c),c==="my-reservations-tab"?(console.log("📋 Rendering reservations list"),setTimeout(()=>{G()},50)):c==="calendar-tab"?(console.log("📅 Rendering calendar view"),setTimeout(()=>{K()},100)):c==="reports-tab"&&(console.log("📊 Rendering reports view"),setTimeout(()=>{Ge()},50)))};e.forEach(c=>{c.addEventListener("click",()=>{const i=c.getAttribute("data-sub-tab");console.log("🖱️ Sub-tab clicked:",i),t(i)})});const a=A.get(W),s=document.querySelector(".sub-tab-button.active"),o=a&&document.getElementById(a)?a:s==null?void 0:s.getAttribute("data-sub-tab");o&&(console.log("⭐ Initial sub-tab:",o),t(o,{skipStore:!!a})),me()}function de(){var t;Pe(),ft(),_(),K(),pt(),He(),me(),G();const e=document.getElementById("excel-upload");e&&e.addEventListener("change",async a=>{const s=a.target.files&&a.target.files[0];s&&(await je(s),a.target.value="")});const n=document.getElementById("excel-upload-trigger");n&&e&&n.addEventListener("click",a=>{a.preventDefault(),e.click()}),(t=document.getElementById("logout-btn"))==null||t.addEventListener("click",Oe),gt(),vt()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",de,{once:!0}):de();function gt(){document.querySelectorAll('input[type="datetime-local"]').forEach(e=>{e.addEventListener("input",()=>{const n=e.value;if(!n.includes("T"))return;const[t,a]=n.split("T"),[s]=a.split(":"),o=`${s.padStart(2,"0")}:00`,c=`${t}T${o}`;e.value!==c&&(e.value=c,setTimeout(()=>e.blur(),150))})})}function vt(){const e=L(),n=localStorage.getItem("pendingReservationEditId"),t=localStorage.getItem("pendingReservationEdit");let a=null;if(n!==null){const o=(e.reservations||[]).findIndex(c=>String(c.id)===n||String(c.reservationId)===n);o!==-1&&(a=o),localStorage.removeItem("pendingReservationEditId")}if(a===null&&t!==null){const s=Number(t);Number.isNaN(s)||(a=s),localStorage.removeItem("pendingReservationEdit")}a===null||Number.isNaN(a)||setTimeout(()=>{const s=document.querySelector('[data-tab="reservations-tab"]');s==null||s.click(),setTimeout(()=>{var o;(o=document.querySelector('.sub-tab-button[data-sub-tab="create-tab"]'))==null||o.click(),setTimeout(()=>{const c=window.editReservation;typeof c=="function"&&c(a)},150)},150)},150)}
