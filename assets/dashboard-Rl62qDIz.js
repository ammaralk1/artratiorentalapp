import{t as l,g as H,n as b,f as A,s as $,a as Pt,i as jt}from"./theme-C7llKhek.js";import{l as q,s as Ot,i as bt,a as Yt,b as _t,r as J,c as Vt,d as Z,e as ht,f as Ut,u as zt}from"./events-gPRGQZjE.js";import{c as Gt,l as Wt}from"./auth-5W6mzyky.js";import{r as Kt}from"./customers-DKy8Oalm.js";let O=null,dt=!1;function Qt(t){const e=t.paid===!0||t.paid==="paid",n=t.confirmed===!0||t.confirmed==="true";return t.completed?{background:"#6c757d",border:"#565e64",text:"#fff"}:e?n?{background:"#198754",border:"#146c43",text:"#fff"}:{background:"#ffc107",border:"#cc9a06",text:"#212529"}:{background:"#dc3545",border:"#b02a37",text:"#fff"}}function Jt(t){const{reservationId:e,customerName:n,paid:a,confirmed:c,completed:o}=t.event.extendedProps,s=a===!0||a==="paid",r=c===!0||c==="true",u=document.createElement("div");u.className="fc-reservation-event";const d=r?l("calendar.badges.confirmed","مؤكد"):l("calendar.badges.pending","غير مؤكد"),p=s?l("calendar.badges.paid","مدفوع"):l("calendar.badges.unpaid","غير مدفوع"),m=l("calendar.badges.completed","منتهي"),i=l("calendar.labels.unknownCustomer","غير معروف");return u.innerHTML=`
    <div class="fc-reservation-id">${e}</div>
    <div class="fc-reservation-customer">${n||i}</div>
    <div class="fc-reservation-tags">
      <span class="badge ${r?"bg-success":"bg-warning text-dark"}">${d}</span>
      <span class="badge ${s?"bg-primary":"bg-danger"}">${p}</span>
      ${o?`<span class="badge bg-secondary">${m}</span>`:""}
    </div>
  `,{domNodes:[u]}}function Zt(t){var rt;const e=document.getElementById("calendar-reservation-details");if(!e){alert(l("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"));return}const n=t.confirmed===!0||t.confirmed==="true",a=t.paid===!0||t.paid==="paid",c=!!t.completed,o=n?l("calendar.badges.confirmed","مؤكد"):l("calendar.badges.pending","غير مؤكد"),s=a?l("calendar.badges.paid","مدفوع"):l("calendar.badges.unpaid","غير مدفوع"),r=l("calendar.badges.completed","منتهي"),u=H(),d=t.items||[],p=Ot()||[],m=new Map(p.map(f=>[String(f.id),f])),i=(t.technicians||[]).map(f=>m.get(String(f))).filter(Boolean),h=d.reduce((f,v)=>f+(v.qty||1)*(v.price||0),0),E=(()=>{const f=parseFloat(t.discount)||0;return f?t.discountType==="amount"?f:h*(f/100):0})(),S=Math.max(0,h-E),y=t.applyTax?S*.15:0,w=t.cost??Math.round(S+y),j=l("calendar.labels.currencySuffix","ريال"),U=d.length?d.map((f,v)=>{const lt=f.image||f.imageUrl||f.img||"",At=b(String(f.barcode||"-")),Rt=b(String(f.qty||1)),Ft=b(String(f.price||0)),Ht=lt?`<img src="${lt}" alt="${f.desc||""}" class="reservation-modal-item-thumb">`:"-";return`
          <tr>
            <td>${b(String(v+1))}</td>
            <td>${At}</td>
            <td>${f.desc||"-"}</td>
            <td>${Rt}</td>
            <td>${Ft} ${j}</td>
            <td>${Ht}</td>
          </tr>
        `}).join(""):`<tr><td colspan="6" class="text-center">${l("calendar.labels.noEquipment","لا توجد معدات")}</td></tr>`,C=[`<div>${l("calendar.summary.baseCost","💵 إجمالي المعدات: <strong>{value} ريال</strong>").replace("{value}",h.toFixed(2))}</div>`];if(E>0){const f=u==="en"?"%":"٪",v=t.discountType==="percent"?`${parseFloat(t.discount||0).toFixed(2)}${f}`:`${E.toFixed(2)} ${j}`;C.push(`<div>${l("calendar.summary.discount","💸 الخصم: <strong>{value}</strong>").replace("{value}",v)}</div>`)}t.applyTax&&y>0&&C.push(`<div>${l("calendar.summary.tax","🧾 الضريبة (15%): <strong>{value} ريال</strong>").replace("{value}",y.toFixed(2))}</div>`),C.push(`<div>${l("calendar.summary.total","💰 المجموع النهائي: <strong>{value} ريال</strong>").replace("{value}",w.toFixed(2))}</div>`);const xt=b(String(t.reservationId??t.id??"")),Mt=t.start?b(A(t.start)):"-",qt=t.end?b(A(t.end)):"-",Ct=t.notes?b(t.notes):l("calendar.labels.noNotes","لا توجد ملاحظات"),Dt=t.customerName||l("calendar.labels.unknownCustomer","غير معروف"),Nt=[{icon:"🆔",label:l("calendar.labels.reservationId","رقم الحجز"),value:xt},{icon:"👤",label:l("calendar.labels.customer","العميل"),value:Dt},{icon:"🗓️",label:l("calendar.labels.start","بداية الحجز"),value:Mt},{icon:"🗓️",label:l("calendar.labels.end","نهاية الحجز"),value:qt},{icon:"📝",label:l("calendar.labels.notes","الملاحظات"),value:Ct}];e.innerHTML=`
    <div class="calendar-reservation-status mb-3">
      <span class="badge ${n?"bg-success":"bg-warning text-dark"}">${o}</span>
      <span class="badge ${a?"bg-primary":"bg-danger"}">${s}</span>
      ${c?`<span class="badge bg-secondary">${r}</span>`:""}
    </div>
    <div class="calendar-reservation-info">
      ${Nt.map(f=>`
        <div class="calendar-info-row">
          <span class="label">${f.icon} ${f.label}</span>
          <span class="value">${f.value}</span>
        </div>
      `).join("")}
    </div>
    <h6 class="calendar-section-title">${l("calendar.sections.crew","😎 الفريق الفني")}</h6>
    ${i.length?`<ul class="list-unstyled calendar-reservation-technicians">${i.map(f=>{const v=f.role?` — ${f.role}`:"";return`<li><strong>${f.name}</strong>${v}</li>`}).join("")}</ul>`:`<p class="calendar-empty-state">${l("calendar.emptyStates.noCrew","😎 لا يوجد فريق مرتبط بهذا الحجز.")}</p>`}
    <h6 class="calendar-section-title">${l("calendar.sections.equipment","📦 المعدات")}</h6>
    <div class="table-responsive reservation-modal-items-wrapper">
      <table class="table table-sm table-hover align-middle reservation-modal-items-table">
        <thead>
          <tr>
            <th>#</th>
            <th>${l("calendar.table.headers.barcode","الباركود")}</th>
            <th>${l("calendar.table.headers.description","الوصف")}</th>
            <th>${l("calendar.table.headers.quantity","الكمية")}</th>
            <th>${l("calendar.table.headers.price","السعر")}</th>
            <th>${l("calendar.table.headers.image","الصورة")}</th>
          </tr>
        </thead>
        <tbody>${U}</tbody>
      </table>
    </div>
    <div class="calendar-reservation-summary">
      ${C.join("")}
    </div>
  `;const st=document.getElementById("calendarReservationModal");st&&((rt=window.bootstrap)!=null&&rt.Modal)?window.bootstrap.Modal.getOrCreateInstance(st).show():alert(l("calendar.alerts.cannotOpenModal","لا يمكن فتح نافذة التفاصيل"))}function X(){console.log("✅ renderCalendar تعمل");const t=document.getElementById("calendar");if(!t)return;O&&(O.destroy(),O=null);const{reservations:e=[],customers:n=[]}=q(),a=e.map(o=>{const s=n.find(d=>String(d.id)===String(o.customerId)),r=o.end?new Date(o.end)<new Date:!1,u=Qt({...o,completed:r});return{id:o.id,title:"",start:o.start,end:o.end,backgroundColor:u.background,borderColor:u.border,textColor:u.text,display:"auto",extendedProps:{...o,customerName:(s==null?void 0:s.customerName)||l("calendar.labels.unknownCustomer","غير معروف"),completed:r}}}),c=new FullCalendar.Calendar(t,{initialView:"dayGridMonth",locale:H(),timeZone:"local",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},buttonText:{today:l("calendar.buttons.today","اليوم"),month:l("calendar.buttons.month","شهر"),week:l("calendar.buttons.week","أسبوع"),day:l("calendar.buttons.day","يوم")},events:a,eventContent:Jt,eventClick:function(o){Zt(o.event.extendedProps)}});c.render(),O=c,dt||(document.addEventListener("language:changed",()=>{X()}),dt=!0)}let it=null,z=null,G=null;const Xt={range:"last30",search:"",start:null,end:null};function g(t,e,n=e){const a=H()==="en"?n??e:e;return l(t,a)}function tt(){return(H()||"ar").toLowerCase().startsWith("ar")?"ar-EG":"en-US"}function yt(){const t=H();if(t!==it||!z||!G){it=t;const e=tt();z=new Intl.NumberFormat(e,{maximumFractionDigits:0}),G=new Intl.NumberFormat(e,{style:"currency",currency:"SAR",maximumFractionDigits:0})}return{numberFormatter:z,currencyFormatter:G}}function te(t){const e=tt();return new Intl.DateTimeFormat(e,{month:"short"}).format(t)}function ee(){const{reservations:t=[],customers:e=[],equipment:n=[],technicians:a=[]}=q(),c=ne(t,Xt,e,n,a),o=le(c),s=de(c),r=ie(c),u=ue(c),d=me(c,e),p=pe(c,n);Se(o),ge(s),mt("reports-status-breakdown",r),mt("reports-payment-breakdown",u),be(d),he(p),fe(c,e,a),we(c.length===0)}function Et(t){return b(String(t||"")).toLowerCase().trim()}function ne(t,e,n,a,c){const{startDate:o,endDate:s}=oe(e),r=Et(e.search),u=!!r,d=new Map((n||[]).map(i=>[String(i.id),i])),p=new Map((a||[]).map(i=>[Y(i==null?void 0:i.barcode),i])),m=new Map((c||[]).map(i=>[String(i.id),i]));return(t||[]).filter(i=>{const h=i!=null&&i.start?new Date(i.start):null;return!(!h||Number.isNaN(h.getTime())||o&&h<o||s&&h>s||(P(i),_(i),u&&!ae(i,r,d,p,m)))})}function ae(t,e,n,a,c){const o=[],s=(t==null?void 0:t.reservationId)||(t==null?void 0:t.id);s&&o.push(s),t!=null&&t.notes&&o.push(t.notes);const r=P(t);r&&o.push(r);const u=(t==null?void 0:t.paymentStatus)||(t==null?void 0:t.payment_status);u&&o.push(u),(t==null?void 0:t.paid)!=null&&o.push(t.paid?"paid":"unpaid");const d=n.get(String(t==null?void 0:t.customerId));return d&&o.push(d.customerName,d.company_name||d.companyName,d.contact_person||""),o.push($t(t)),((t==null?void 0:t.items)||[]).forEach(m=>{m!=null&&m.desc&&o.push(m.desc),m!=null&&m.barcode&&o.push(m.barcode);const i=a.get(Y(m==null?void 0:m.barcode));i&&o.push(i.desc,i.description,i.name)}),((t==null?void 0:t.technicians)||[]).forEach(m=>{const i=c.get(String(m));i&&o.push(i.name,i.role,i.department)}),Et(o.filter(Boolean).join(" ")).includes(e)}function oe({range:t,start:e,end:n}){const a=new Date;a.setHours(23,59,59,999);const c=new Date(a);let o=null;switch(t){case"last30":{o=new Date(a),o.setDate(o.getDate()-29);break}case"thisWeek":{const s=new Date(a),u=(s.getDay()-6+7)%7;s.setDate(s.getDate()-u),s.setHours(0,0,0,0);const d=new Date(s);d.setDate(s.getDate()+6),d.setHours(23,59,59,999),o=s,c.setTime(d.getTime());break}case"thisMonth":{o=new Date(a.getFullYear(),a.getMonth(),1);const s=new Date(a.getFullYear(),a.getMonth()+1,0);c.setTime(s.setHours(23,59,59,999));break}case"thisQuarter":{const s=Math.floor(a.getMonth()/3);o=new Date(a.getFullYear(),s*3,1);const r=new Date(a.getFullYear(),(s+1)*3,0);c.setTime(r.setHours(23,59,59,999));break}case"thisYear":{o=new Date(a.getFullYear(),0,1);const s=new Date(a.getFullYear(),12,0);c.setTime(s.setHours(23,59,59,999));break}case"all":default:o=null,c=null;break}return o&&o.setHours(0,0,0,0),{startDate:o,endDate:c}}function ce(t){const e=P(t);return e==="confirmed"||e==="completed"?!0:(t==null?void 0:t.confirmed)===!0||(t==null?void 0:t.confirmed)==="true"}const se=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"]]),ut=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]);function re(t=""){const e=String(t).toLowerCase().trim();return e?se.get(e)||e:""}function _(t){const e=[t==null?void 0:t.paymentStatus,t==null?void 0:t.payment_status,t==null?void 0:t.payment,t==null?void 0:t.paymentState,t==null?void 0:t.payment_state];for(const n of e){const a=String(n||"").toLowerCase().trim();if(a&&ut.has(a))return ut.get(a)}return(t==null?void 0:t.paid)===!0||(t==null?void 0:t.paid)==="true"}function P(t){const e=[t==null?void 0:t.status,t==null?void 0:t.reservationStatus,t==null?void 0:t.reservation_status,t==null?void 0:t.state];for(const n of e){const a=re(n);if(a)return a==="cancelled"?"pending":a}return bt(t)?"completed":(t==null?void 0:t.confirmed)===!0||(t==null?void 0:t.confirmed)==="true"?"confirmed":"pending"}function le(t){const e=t.length,n=t.filter(ce).length,a=t.filter(bt).length,c=t.filter(_).length,o=t.reduce((r,u)=>r+(Number(u==null?void 0:u.cost)||0),0),s=e?o/e:0;return{total:e,confirmed:n,completed:a,paidCount:c,revenue:o,average:s}}function de(t){const e=new Date,n=[];for(let a=5;a>=0;a-=1){const c=new Date(e.getFullYear(),e.getMonth()-a,1),o=c.getFullYear(),s=c.getMonth(),r=t.filter(m=>{const i=m!=null&&m.start?new Date(m.start):null;return i&&i.getFullYear()===o&&i.getMonth()===s}),u=r.length,d=r.reduce((m,i)=>m+(Number(i==null?void 0:i.cost)||0),0),p=te(c);n.push({label:p,count:u,revenue:d})}return n}function ie(t){const e={confirmed:0,pending:0,completed:0};(t||[]).forEach(s=>{const r=P(s);r==="completed"?e.completed+=1:r==="confirmed"?e.confirmed+=1:e.pending+=1});const n=Math.max(1,(t||[]).length),a=e.confirmed,c=e.pending,o=e.completed;return[{label:g("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:a,percent:Math.round(a/n*100)||0,rawCount:a,className:"status-confirmed"},{label:g("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:c,percent:Math.round(c/n*100)||0,rawCount:c,className:"status-pending"},{label:g("reservations.reports.status.completedLabel","منتهية","Completed"),value:o,percent:Math.round(o/n*100)||0,rawCount:o,className:"status-completed"}]}function ue(t){const e=t.length||1,n=t.filter(_).length,a=t.length-n;return[{label:g("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:n,percent:Math.round(n/e*100)||0,rawCount:n,className:"status-paid"},{label:g("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:a,percent:Math.round(a/e*100)||0,rawCount:a,className:"status-unpaid"}]}function me(t,e){const n=new Map,a=new Map((e||[]).map(c=>[String(c.id),c]));return t.forEach(c=>{const o=String((c==null?void 0:c.customerId)??"unknown"),s=n.get(o)||{count:0,revenue:0};s.count+=1,s.revenue+=Number(c==null?void 0:c.cost)||0,n.set(o,s)}),Array.from(n.entries()).map(([c,o])=>{const s=a.get(c);return{name:(s==null?void 0:s.customerName)||g("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:o.count,revenue:o.revenue}}).sort((c,o)=>o.revenue-c.revenue).slice(0,5)}function pe(t,e){const n=new Map,a=new Map((e||[]).map(c=>[Y(c==null?void 0:c.barcode),c]));return t.forEach(c=>{((c==null?void 0:c.items)||[]).forEach(o=>{var i,h;const s=Y(o==null?void 0:o.barcode),r=s||((o==null?void 0:o.desc)??"unknown"),u=(o==null?void 0:o.desc)||((i=a.get(s))==null?void 0:i.desc)||((h=a.get(s))==null?void 0:h.description)||g("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment"),d=Number(o==null?void 0:o.qty)||1,p=d*(Number(o==null?void 0:o.price)||0),m=n.get(r)||{name:u,count:0,revenue:0};m.name=u,m.count+=d,m.revenue+=p,n.set(r,m)})}),Array.from(n.values()).sort((c,o)=>o.count-c.count).slice(0,5)}function fe(t,e,n){const a=document.getElementById("reports-reservations-body");if(!a)return;if(!t||t.length===0){a.innerHTML=`<tr><td colspan="6" class="text-muted">${g("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}const c=new Map((e||[]).map(r=>[String(r.id),r])),o=new Map((n||[]).map(r=>[String(r.id),r])),s=[...t].sort((r,u)=>new Date(u.start||0)-new Date(r.start||0)).slice(0,20).map(r=>ye(r,c,o));a.innerHTML=s.map(r=>`
      <tr>
        <td>${r.code}</td>
        <td>${r.customer}</td>
        <td>${r.date}</td>
        <td>${r.status}</td>
        <td>${r.payment}</td>
        <td>${r.total}</td>
      </tr>
    `).join("")}function ge(t){const e=document.getElementById("reports-volume-chart");if(!e)return;if(!t||t.length===0){e.innerHTML=`<p class="text-muted">${g("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const n=Math.max(1,...t.map(a=>a.count));e.innerHTML=t.map(a=>`
        <div class="reports-chart-bar">
          <div class="bar" style="height: ${Math.max(8,Math.round(a.count/n*100))}%"></div>
          <span class="value">${B(a.count)}</span>
          <span class="label">${a.label}</span>
        </div>
      `).join("")}function mt(t,e){const n=document.getElementById(t);if(n){if(!e||e.length===0){n.innerHTML=`<p class="text-muted">${g("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}n.innerHTML=e.map(a=>`
      <div class="reports-progress-row">
        <div class="reports-progress-top">
          <span>${a.label}</span>
          <span>${B(a.percent)}%</span>
        </div>
        <div class="reports-progress-bar">
          <div class="reports-progress-fill ${a.className}" style="width: ${Math.min(a.percent,100)}%"></div>
        </div>
        <div class="reports-progress-meta">${g("reservations.reports.progress.meta","{count} حجز","{count} reservations").replace("{count}",B(a.rawCount??a.value))}</div>
      </div>
    `).join("")}}function be(t){const e=document.getElementById("reports-top-customers");if(e){if(!t||t.length===0){e.innerHTML=`<tr><td colspan="3" class="text-muted">${g("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}e.innerHTML=t.map(n=>`
      <tr>
        <td>${n.name}</td>
        <td>${B(n.count)}</td>
        <td>${R(n.revenue)}</td>
      </tr>
    `).join("")}}function he(t){const e=document.getElementById("reports-top-equipment");if(e){if(!t||t.length===0){e.innerHTML=`<tr><td colspan="3" class="text-muted">${g("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}e.innerHTML=t.map(n=>`
      <tr>
        <td>${n.name}</td>
        <td>${B(n.count)}</td>
        <td>${R(n.revenue)}</td>
      </tr>
    `).join("")}}function ye(t,e,n){const a=(t==null?void 0:t.reservationId)||(t==null?void 0:t.id)||"—",c=e.get(String(t==null?void 0:t.customerId)),o=(c==null?void 0:c.customerName)||g("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),s=$e(t==null?void 0:t.start),r=Ee(t),u=$t(t),d=R((t==null?void 0:t.cost)||0),p=((t==null?void 0:t.technicians)||[]).map(E=>{var S;return(S=n.get(String(E)))==null?void 0:S.name}).filter(Boolean),m=g("reservations.list.crew.separator","، ",", "),i=p.map(E=>I(E)).join(I(m)),h=p.length?`${I(o)}<br><small class="text-muted">${i}</small>`:I(o);return{code:I(a),customer:h,date:I(s),status:I(r),payment:I(u),total:I(d)}}function $t(t){return _(t)?g("reservations.reports.payment.paidLabel","مدفوعة","Paid"):g("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}function Ee(t){const e=P(t);return e==="completed"?g("reservations.list.status.completed","📁 منتهي","Completed"):e==="confirmed"?g("reservations.list.status.confirmed","✅ مؤكد","Confirmed"):e==="pending"?g("reservations.list.status.pending","⏳ غير مؤكد","Pending"):I(e)}function $e(t){if(!t)return"—";const e=new Date(t);if(Number.isNaN(e.getTime()))return"—";const n=tt(),a=new Intl.DateTimeFormat(n,{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return b(a.format(e))}function Se(t){const e=document.getElementById("reports-kpi-total"),n=document.getElementById("reports-kpi-total-meta"),a=document.getElementById("reports-kpi-revenue"),c=document.getElementById("reports-kpi-revenue-meta"),o=document.getElementById("reports-kpi-confirmed"),s=document.getElementById("reports-kpi-confirmed-meta"),r=document.getElementById("reports-kpi-paid"),u=document.getElementById("reports-kpi-paid-meta"),d=t.total||0,p=t.revenue||0,m=t.confirmed||0,i=t.paidCount||0,h=t.average||0,E=d?Math.round(m/d*100):0,S=d?Math.round(i/d*100):0;if(e&&(e.textContent=B(d)),n){const y=g("reservations.reports.kpi.total.dynamicMeta","منها {count} منتهية","Includes {count} completed").replace("{count}",B(t.completed||0));n.textContent=y}if(a&&(a.textContent=R(p)),c){const y=g("reservations.reports.kpi.revenue.average","متوسط قيمة الحجز {value}","Average reservation value {value}").replace("{value}",R(h));c.textContent=y}if(o&&(o.textContent=`${E}%`),s){const y=g("reservations.reports.kpi.confirmed.detail","{count} حجوزات مؤكدة","{count} confirmed reservations").replace("{count}",B(m));s.textContent=y}if(r&&(r.textContent=`${S}%`),u){const y=g("reservations.reports.kpi.paid.detail","{count} حجوزات مدفوعة","{count} paid reservations").replace("{count}",B(i));u.textContent=y}}function we(t){const e=document.getElementById("reports-empty-state");e&&e.classList.toggle("active",!!t)}function I(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function B(t){const{numberFormatter:e}=yt(),n=e.format(Math.round(t||0));return b(n)}function R(t){const{currencyFormatter:e}=yt(),n=e.format(Math.max(0,Math.round(t||0)));return b(n)}function Y(t){return(t||"").toString().trim()}let F=[],x=[],D=null;function W(){return l("maintenance.form.selectedInfo","لم يتم اختيار معدة بعد.")}function k(t){return b(String(t||"")).trim().toLowerCase()}function pt(t=""){return b(String(t)).trim().toLowerCase()}function T(){const{maintenance:t=[]}=q();return F=Array.isArray(t)?t:[],F}function et(t){F=t;try{localStorage.setItem("maintenanceList",JSON.stringify(t))}catch(e){console.warn("⚠️ [maintenance] Failed to persist maintenance tickets",e),$(l("maintenance.toast.storageError","⚠️ تعذر حفظ بيانات الصيانة. يرجى المحاولة مجدداً."))}}function nt(){const{equipment:t=[]}=q(),e=l("maintenance.table.noName","بدون اسم");return x=(t||[]).map(n=>({barcode:k(n==null?void 0:n.barcode),desc:(n==null?void 0:n.desc)||(n==null?void 0:n.description)||(n==null?void 0:n.name)||e,status:(n==null?void 0:n.status)||"متاح",price:Number(n==null?void 0:n.price)||0,category:(n==null?void 0:n.category)||""})),x.sort((n,a)=>n.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),x}function St(){return new Set(T().filter(t=>t.status==="open").map(t=>k(t.equipmentBarcode)))}function V(t){const e=k(t);return e&&(x.length?x:nt()).find(a=>a.barcode===e)||null}function Ie(t){const e=pt(t);return e&&(x.length?x:nt()).find(a=>pt(a.desc).includes(e))||null}function K(t){if(!t)return!0;const e=St();return t.status==="صيانة"||e.has(t.barcode)}function L({keepInputs:t=!1,silent:e=!1}={}){const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),c=document.getElementById("maintenance-equipment-search"),o=document.getElementById("maintenance-selected-info");n&&(n.value=""),t||(a&&(a.value=""),c&&(c.value="")),o&&(o.textContent=W()),D=null}function wt(t){const e=document.getElementById("maintenance-selected-info");if(!e)return;const n=l("maintenance.info.barcodeLabel","باركود"),a=l("maintenance.report.notAvailable","غير متوفر");e.innerHTML=`
    <strong>${t.desc}</strong><br>
    <span class="text-muted">${n}: ${t.barcode||a}</span>
  `}function at(t,{silent:e=!1}={}){if(!t)return!1;if(K(t))return e||$(l("maintenance.toast.equipmentBlocked","⚠️ هذه المعدة قيد الصيانة ولا يمكن اختيارها حالياً")),!1;const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),c=document.getElementById("maintenance-equipment-search");return n&&(n.value=t.barcode),a&&(a.value=t.barcode),c&&(c.value=t.desc),wt(t),D=t,!0}function It(t,{showFeedback:e=!0}={}){const n=V(t);return n?at(n,{silent:!e}):(e&&$(l("maintenance.toast.equipmentNotFoundBarcode","❌ لم يتم العثور على معدة بهذا الباركود")),!1)}function kt(t,{showFeedback:e=!0}={}){const n=Ie(t);return n?at(n,{silent:!e}):(e&&$(l("maintenance.toast.equipmentNotFoundName","❌ لم يتم العثور على معدة بالاسم المدخل")),!1)}function ot(){const t=document.getElementById("maintenance-equipment-options"),e=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=nt(),c=St();if(t){const s=l("maintenance.form.blockedSuffix","(صيانة)");t.innerHTML=a.map(r=>{const d=r.status==="صيانة"||c.has(r.barcode)?`${r.desc} ${s}`:r.desc,p=r.desc.replace(/"/g,"&quot;"),m=d.replace(/"/g,"&quot;");return`<option value="${p}" label="${m}"></option>`}).join("")}const o=document.getElementById("maintenance-selected-barcode");if(o&&o.value){const s=V(o.value);!s||K(s)?(L({keepInputs:!0,silent:!0}),s&&K(s)&&$(l("maintenance.toast.equipmentBecameBlocked","⚠️ هذه المعدة أصبحت قيد الصيانة ولا يمكن اختيارها"))):at(s,{silent:!0})}else L({keepInputs:!0,silent:!0});if(e&&!e.dataset.listenerAttached&&(e.addEventListener("keydown",s=>{s.key==="Enter"&&(s.preventDefault(),It(e.value)||L({keepInputs:!0,silent:!0}))}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached){const s=()=>{if(!n.value){L({keepInputs:!0,silent:!0});return}kt(n.value)||L({keepInputs:!0,silent:!0})};n.addEventListener("change",s),n.addEventListener("keydown",r=>{r.key==="Enter"&&(r.preventDefault(),s())}),n.dataset.listenerAttached="true"}}function ct(t,e){const n=k(t),{equipment:a=[]}=q(),c=(a||[]).map(o=>k(o==null?void 0:o.barcode)===n?{...o,status:e}:o);Yt({equipment:c}),_t(),J(),ot()}function ke(t){const e=document.getElementById("maintenance-stats");if(!e)return;const n=F.length,a=F.filter(d=>d.status==="open").length,c=n-a,o=d=>b(String(d)),s=l("maintenance.stats.open","{count} قيد الصيانة").replace("{count}",`<strong>${o(a)}</strong>`),r=l("maintenance.stats.closed","{count} مغلقة").replace("{count}",`<strong>${o(c)}</strong>`),u=l("maintenance.stats.total","{count} إجمالي التذاكر").replace("{count}",`<strong>${o(n)}</strong>`);e.innerHTML=`
    <span class="maintenance-stat">${s}</span>
    <span class="maintenance-stat">${r}</span>
    <span class="maintenance-stat">${u}</span>
  `}function Te(t){const e=document.getElementById("maintenance-table-body"),n=document.getElementById("maintenance-empty-state");if(e){if(!t||t.length===0){const a=l("maintenance.table.emptyFiltered","لا توجد تذاكر ضمن هذا الفلتر.");e.innerHTML=`<tr><td colspan="6" class="text-muted text-center">${a}</td></tr>`,n&&n.classList.add("active");return}n&&n.classList.remove("active"),e.innerHTML=t.map(a=>{const c=l("maintenance.status.open","قيد الصيانة"),o=l("maintenance.status.closed","مغلقة"),s=a.status==="open"?`<span class="badge bg-warning text-dark">${c}</span>`:`<span class="badge bg-success">${o}</span>`,r=(()=>{const j=l("maintenance.priority.high","مرتفعة"),U=l("maintenance.priority.medium","متوسطة"),C=l("maintenance.priority.low","منخفضة");switch(a.priority){case"high":return`<span class="badge bg-danger">${j}</span>`;case"low":return`<span class="badge bg-secondary">${C}</span>`;default:return`<span class="badge bg-info text-dark">${U}</span>`}})(),u=[],d=l("maintenance.actions.close","🔧 إغلاق بعد الإصلاح"),p=l("maintenance.actions.view","👁️ عرض التقرير"),m=l("maintenance.actions.delete","🗑️ حذف التذكرة");a.status==="open"?u.push(`<button class="btn btn-sm btn-success" data-action="close" data-id="${a.id}">${d}</button>`):u.push(`<button class="btn btn-sm btn-warning" data-action="view" data-id="${a.id}">${p}</button>`),u.push(`<button class="btn btn-sm btn-danger" data-action="delete" data-id="${a.id}">${m}</button>`);const i=u.join(""),h=l("maintenance.table.noBarcode","بدون باركود"),E=l("maintenance.report.none","—"),S=a.equipmentBarcode?b(a.equipmentBarcode):h,y=a.issue?b(a.issue):E,w=a.createdAt?b(A(a.createdAt)):"—";return`
        <tr>
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${S}</small>
          </td>
          <td class="maintenance-issue-text">${y}</td>
          <td>${r}</td>
          <td>${w}</td>
          <td>${s}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${i}
            </div>
          </td>
        </tr>
      `}).join("")}}function Be(t){const e=t.target.closest("button[data-action]");if(!e)return;const n=e.getAttribute("data-action"),a=Number(e.getAttribute("data-id"));a&&(n==="close"?Tt(a):n==="view"?Bt(a):n==="delete"&&vt(a))}function Tt(t){const e=T(),n=e.findIndex(o=>Number(o.id)===Number(t));if(n===-1)return;const a=prompt(l("maintenance.prompt.closeReport","أدخل تقرير الإصلاح / الإجراءات المتخذة:"));if(a===null)return;const c={...e[n]};c.status="closed",c.resolutionReport=a.trim(),c.resolvedAt=new Date().toISOString(),e[n]=c,et(e),ct(c.equipmentBarcode,"متاح"),$(l("maintenance.toast.ticketClosed","✅ تم إغلاق تذكرة الصيانة وإعادة المعدة إلى الحالة المتاحة")),M()}function Bt(t){const n=T().find(i=>Number(i.id)===Number(t));if(!n)return;const a=l("maintenance.report.equipment","المعدة"),c=l("maintenance.report.barcode","الباركود"),o=l("maintenance.report.issue","الوصف"),s=l("maintenance.report.createdAt","تاريخ الإنشاء"),r=l("maintenance.report.closedAt","تاريخ الإغلاق"),u=l("maintenance.report.summary","التقرير"),d=l("maintenance.report.notAvailable","غير متوفر"),p=l("maintenance.report.none","—"),m=[`${a}: ${n.equipmentDesc}`,`${c}: ${n.equipmentBarcode?b(n.equipmentBarcode):d}`,`${o}: ${n.issue?b(n.issue):p}`,`${s}: ${n.createdAt?b(A(n.createdAt)):p}`,`${r}: ${n.resolvedAt?b(A(n.resolvedAt)):p}`,`${u}: ${n.resolutionReport?b(n.resolutionReport):p}`].join(`
`);alert(m)}function vt(t){const e=T(),n=e.findIndex(c=>Number(c.id)===Number(t));if(n===-1)return;const a=e[n];confirm(l("maintenance.toast.ticketDeleteConfirm","⚠️ هل أنت متأكد من حذف تذكرة الصيانة؟"))&&(e.splice(n,1),et(e),a.status==="open"&&ct(a.equipmentBarcode,"متاح"),$(l("maintenance.toast.ticketDeleted","🗑️ تم حذف تذكرة الصيانة")),M())}function Lt(t){t.preventDefault();try{const e=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),c=document.getElementById("maintenance-issue"),o=document.getElementById("maintenance-priority");let s=D,r=k(a==null?void 0:a.value);if(!s&&r&&(s=V(r)),!s&&(e!=null&&e.value)&&It(e.value,{showFeedback:!0})&&(s=D,r=k(s==null?void 0:s.barcode)),!s&&(n!=null&&n.value)&&kt(n.value,{showFeedback:!0})&&(s=D,r=k(s==null?void 0:s.barcode)),!s||!r){$(l("maintenance.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const{equipment:u=[]}=q();let d=(u||[]).find(w=>k(w==null?void 0:w.barcode)===r);if(!d&&s&&(d={barcode:s.barcode,desc:s.desc,name:s.desc,status:s.status||"متاح"}),!d){$(l("maintenance.toast.selectedNotFound","❌ لم يتم العثور على المعدة المختارة")),L();return}if(d.status==="صيانة"){$(l("maintenance.toast.equipmentAlreadyMaintenance","⚠️ هذه المعدة بالفعل في حالة صيانة"));return}if(T().filter(w=>w.status==="open").some(w=>k(w.equipmentBarcode)===r)){$(l("maintenance.toast.ticketExists","⚠️ توجد تذكرة صيانة مفتوحة لهذه المعدة"));return}const i=l("maintenance.table.noName","بدون اسم"),h={id:Date.now(),equipmentBarcode:r,equipmentDesc:d.desc||d.description||d.name||i,issue:(c==null?void 0:c.value.trim())||"",priority:(o==null?void 0:o.value)||"medium",status:"open",createdAt:new Date().toISOString(),resolutionReport:"",resolvedAt:null},E=T(),S=[h,...E];et(S),ct(r,"صيانة"),$(l("maintenance.toast.ticketCreated","🛠️ تم إنشاء تذكرة الصيانة وإيقاف المعدة")),L(),c&&(c.value=""),o&&(o.value="medium");const y=document.getElementById("maintenance-status-filter");y&&(y.value="all"),M()}catch(e){console.error("❌ [maintenance] Failed to create ticket",e),$(l("maintenance.toast.submitError","⚠️ تعذر إنشاء تذكرة الصيانة. يرجى المحاولة مجدداً."))}}function ve(t){const e=T();return t==="all"?e:e.filter(n=>n.status===t)}function M(){T(),ot();const t=document.getElementById("maintenance-status-filter");t&&!t.value&&(t.value="all");const e=(t==null?void 0:t.value)||"all",n=ve(e);ke(),Te(n)}function Le(){T(),ot(),M();const t=document.getElementById("maintenance-form");t&&!t.dataset.listenerAttached&&(t.addEventListener("submit",Lt),t.dataset.listenerAttached="true");const e=document.getElementById("maintenance-status-filter");e&&!e.dataset.listenerAttached&&(e.addEventListener("change",()=>{M()}),e.dataset.listenerAttached="true");const n=document.querySelector(".maintenance-table");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Be),n.dataset.listenerAttached="true")}T();document.addEventListener("language:changed",()=>{const t=document.getElementById("maintenance-selected-barcode"),e=document.getElementById("maintenance-selected-info");if(t!=null&&t.value){const n=V(t.value);n?wt(n):e&&(e.textContent=W())}else e&&(e.textContent=W());M()});document.addEventListener("submit",t=>{const e=t.target;(e==null?void 0:e.id)==="maintenance-form"&&!e.dataset.listenerAttached&&Lt(t)});document.addEventListener("click",t=>{const e=t.target.closest("button[data-action]");if(!e||!e.closest(".maintenance-table"))return;const n=e.dataset.action,a=Number(e.dataset.id);a&&(n==="close"?Tt(a):n==="view"?Bt(a):n==="delete"&&vt(a))});const ft="dashboard-active-tab",Q="dashboard-active-sub-tab",N={get(t){try{return localStorage.getItem(t)}catch(e){return console.warn("⚠️ [tabs.js] localStorage.getItem failed",{key:t,error:e}),null}},set(t,e){try{localStorage.setItem(t,e)}catch(n){console.warn("⚠️ [tabs.js] localStorage.setItem failed",{key:t,value:e,error:n})}},remove(t){try{localStorage.removeItem(t)}catch(e){console.warn("⚠️ [tabs.js] localStorage.removeItem failed",{key:t,error:e})}}};function xe(){var s;console.log("🚀 [tabs.js] setupTabs()");const t=document.querySelectorAll("[data-tab]"),e=document.querySelectorAll(".tab");console.log("📌 tabButtons:",t),console.log("📌 tabContents:",e);const n=(r,{skipStore:u=!1}={})=>{if(!r)return;const d=document.querySelector(`[data-tab="${r}"]`),p=document.getElementById(r);!d||!p||(t.forEach(m=>m.classList.remove("active")),d.classList.add("active"),e.forEach(m=>{const i=m.id===r;m.style.display=i?"block":"none",m.classList.toggle("active",i)}),u||N.set(ft,r),r==="customers-tab"&&(console.log("👤 Rendering customers"),Kt()),r==="equipment-tab"&&(console.log("📦 Rendering equipment"),J()),r==="maintenance-tab"&&(console.log("🛠️ Rendering maintenance"),M()),r==="technicians-tab"&&(console.log("🛠️ Rendering technicians"),Vt()),r==="reservations-tab"&&(console.log("📅 Rendering reservations"),Z(),Me()))};t.forEach(r=>{r.addEventListener("click",()=>{const u=r.getAttribute("data-tab");console.log("🖱️ Tab clicked:",u),n(u),u!=="reservations-tab"&&N.remove(Q)})});const a=N.get(ft),c=document.querySelector("[data-tab].active"),o=a&&document.getElementById(a)?a:c==null?void 0:c.getAttribute("data-tab");o&&(console.log("⭐ Initial tab:",o),n(o,{skipStore:!!a})),(s=document.body)==null||s.classList.remove("tabs-loading")}function Me(){console.log("🚀 [tabs.js] setupSubTabs()");const t=document.querySelectorAll(".sub-tab-button"),e=document.querySelectorAll(".sub-tab");console.log("📌 subTabButtons:",t),console.log("📌 subTabContents:",e);const n=(s,{skipStore:r=!1}={})=>{if(!s)return;const u=document.querySelector(`.sub-tab-button[data-sub-tab="${s}"]`),d=document.getElementById(s);!u||!d||(t.forEach(p=>p.classList.remove("active")),u.classList.add("active"),e.forEach(p=>{p.classList.remove("active")}),d.classList.add("active"),r||N.set(Q,s),s==="my-reservations-tab"?(console.log("📋 Rendering reservations list"),setTimeout(()=>{Z()},50)):s==="calendar-tab"?(console.log("📅 Rendering calendar view"),setTimeout(()=>{X()},100)):s==="reports-tab"&&(console.log("📊 Rendering reports view"),setTimeout(()=>{ee()},50)))};t.forEach(s=>{s.addEventListener("click",()=>{const r=s.getAttribute("data-sub-tab");console.log("🖱️ Sub-tab clicked:",r),n(r)})});const a=N.get(Q),c=document.querySelector(".sub-tab-button.active"),o=a&&document.getElementById(a)?a:c==null?void 0:c.getAttribute("data-sub-tab");o&&(console.log("⭐ Initial sub-tab:",o),n(o,{skipStore:!!a})),ht()}Pt();function gt(){var n;Gt(),xe(),jt(),J(),X(),Le(),Ut(),ht(),Z();const t=document.getElementById("excel-upload");t&&t.addEventListener("change",async a=>{const c=a.target.files&&a.target.files[0];c&&(await zt(c),a.target.value="")});const e=document.getElementById("excel-upload-trigger");e&&t&&e.addEventListener("click",a=>{a.preventDefault(),t.click()}),(n=document.getElementById("logout-btn"))==null||n.addEventListener("click",Wt),qe(),Ce()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",gt,{once:!0}):gt();function qe(){document.querySelectorAll('input[type="datetime-local"]').forEach(t=>{t.addEventListener("input",()=>{const e=t.value;if(!e.includes("T"))return;const[n,a]=e.split("T"),[c]=a.split(":"),o=`${c.padStart(2,"0")}:00`,s=`${n}T${o}`;t.value!==s&&(t.value=s,setTimeout(()=>t.blur(),150))})})}function Ce(){const t=q(),e=localStorage.getItem("pendingReservationEditId"),n=localStorage.getItem("pendingReservationEdit");let a=null;if(e!==null){const o=(t.reservations||[]).findIndex(s=>String(s.id)===e||String(s.reservationId)===e);o!==-1&&(a=o),localStorage.removeItem("pendingReservationEditId")}if(a===null&&n!==null){const c=Number(n);Number.isNaN(c)||(a=c),localStorage.removeItem("pendingReservationEdit")}a===null||Number.isNaN(a)||setTimeout(()=>{const c=document.querySelector('[data-tab="reservations-tab"]');c==null||c.click(),setTimeout(()=>{var o;(o=document.querySelector('.sub-tab-button[data-sub-tab="create-tab"]'))==null||o.click(),setTimeout(()=>{const s=window.editReservation;typeof s=="function"&&s(a)},150)},150)},150)}
