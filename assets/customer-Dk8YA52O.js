import{r as G,n as m,t as u,g as $,a as V,c as J,i as K,l as O,s as L}from"./auth-CNAfl19F.js";import{l as N,s as W}from"./storage-DOnDLvtb.js";import{a as _,b as H,c as X}from"./controller-DfdUmPnp.js";import"./projects-B5HGRUVy.js";import"./events-BbKR8R1v.js";import"./reservationsSummary-CBdNx1nm.js";G({ar:{"customerDetails.pageTitle":"معلومات العميل","customerDetails.title":"👤 بيانات العميل","customerDetails.actions.back":"⬅️ العودة","customerDetails.actions.edit":"✏️ تعديل العميل","customerDetails.filters.search":"🔍 ابحث باسم العميل أو رقم الحجز...","customerDetails.fields.name":"👤 الاسم:","customerDetails.fields.phone":"📞 الجوال:","customerDetails.fields.company":"🏢 الشركة:","customerDetails.fields.email":"📧 البريد:","customerDetails.fields.address":"📍 العنوان:","customerDetails.fields.notes":"📝 الملاحظات:","customerDetails.toast.missingRequired":"⚠️ الاسم ورقم الهاتف إلزاميان","customerDetails.toast.notFound":"⚠️ العميل غير موجود","customerDetails.toast.updateSuccess":"✅ تم تحديث بيانات العميل","customerDetails.errors.notFound":"⚠️ لم يتم العثور على هذا العميل.","customerDetails.errors.missingId":"⚠️ لا يوجد معرف عميل في الرابط.","customerDetails.edit.modalTitle":"✏️ تعديل العميل","customerProjects.title":"📁 مشاريع العميل","customerProjects.empty":"لا توجد مشاريع مرتبطة بهذا العميل."},en:{"customerDetails.pageTitle":"Customer Details","customerDetails.title":"👤 Client Profile","customerDetails.actions.back":"⬅️ Back","customerDetails.actions.edit":"✏️ Edit Client","customerDetails.filters.search":"🔍 Search by client or reservation ID...","customerDetails.fields.name":"👤 Name:","customerDetails.fields.phone":"📞 Phone:","customerDetails.fields.company":"🏢 Company:","customerDetails.fields.email":"📧 Email:","customerDetails.fields.address":"📍 Address:","customerDetails.fields.notes":"📝 Notes:","customerDetails.toast.missingRequired":"⚠️ Name and phone are required","customerDetails.toast.notFound":"⚠️ Client not found","customerDetails.toast.updateSuccess":"✅ Client information updated","customerDetails.errors.notFound":"⚠️ This client could not be found.","customerDetails.errors.missingId":"⚠️ Missing client identifier in the URL.","customerDetails.edit.modalTitle":"✏️ Edit Client","customerProjects.title":"📁 Client Projects","customerProjects.empty":"No projects are linked to this client."}});let x={},D={initialized:!1,currentId:null};function S(e=""){return m(String(e)).trim().toLowerCase()}function Z(e,s,t){if(!s||!t)return;const{startDate:a,endDate:n}=H(e);s._flatpickr?a?s._flatpickr.setDate(a,!1,"Y-m-d"):s._flatpickr.clear():s.value=a||"",t._flatpickr?n?t._flatpickr.setDate(n,!1,"Y-m-d"):t._flatpickr.clear():t.value=n||""}function P(e){if(!document.getElementById("customer-reservations"))return;const t=document.getElementById("customer-search-reservation"),a=document.getElementById("customer-filter-start-date"),n=document.getElementById("customer-filter-end-date"),o=document.getElementById("customer-reservation-date-range"),l=document.getElementById("customer-reservation-status-filter"),f=document.getElementById("customer-clear-filters");window.flatpickr&&(a&&window.flatpickr(a,{dateFormat:"Y-m-d"}),n&&window.flatpickr(n,{dateFormat:"Y-m-d"}));const g=()=>{let r=m((a==null?void 0:a.value)||"").trim(),d=m((n==null?void 0:n.value)||"").trim(),p=(o==null?void 0:o.value)||"";if(new Set(["","today","week","month"]).has(p)||(p="",o&&(o.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),n&&(n._flatpickr&&n._flatpickr.clear(),n.value=""),r="",d=""),!r&&!d&&p){const{startDate:A,endDate:T}=H(p);r=A,d=T}return{searchTerm:S((t==null?void 0:t.value)||""),startDate:r,endDate:d,status:(l==null?void 0:l.value)||"",quickRange:p,customerId:e}},c=()=>{x=g(),_("customer-reservations",x)};t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=m(t.value),c()}),t.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{o&&(o.value=""),c()}),a.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{o&&(o.value=""),c()}),n.dataset.listenerAttached="true"),o&&!o.dataset.listenerAttached&&(o.addEventListener("change",()=>{Z(o.value,a,n),c()}),o.dataset.listenerAttached="true"),l&&!l.dataset.listenerAttached&&(l.addEventListener("change",c),l.dataset.listenerAttached="true"),f&&!f.dataset.listenerAttached&&(f.addEventListener("click",()=>{t&&(t.value=""),a&&(a._flatpickr&&a._flatpickr.clear(),a.value=""),n&&(n._flatpickr&&n._flatpickr.clear(),n.value=""),o&&(o.value=""),l&&(l.value=""),c()}),f.dataset.listenerAttached="true"),window.refreshCustomerReservationsViews=()=>{_("customer-reservations",x)},c()}function j(e){D.currentId=e;const{container:s}=B();s&&(D.initialized||(ee(),document.addEventListener("projects:changed",()=>{D.currentId&&y()}),document.addEventListener("language:changed",()=>{D.currentId&&y()}),document.addEventListener("technicians:updated",()=>{D.currentId&&y()}),D.initialized=!0),y())}function B(){return{container:document.getElementById("customer-projects"),searchInput:document.getElementById("customer-project-search"),statusSelect:document.getElementById("customer-project-status-filter"),clearBtn:document.getElementById("customer-projects-clear-filters")}}function ee(){const{searchInput:e,statusSelect:s,clearBtn:t}=B();e&&!e.dataset.listenerAttached&&(e.addEventListener("input",()=>{e.value=m(e.value),y()}),e.dataset.listenerAttached="true"),s&&!s.dataset.listenerAttached&&(s.addEventListener("change",()=>{y()}),s.dataset.listenerAttached="true"),t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>{const{searchInput:a,statusSelect:n}=B();a&&(a.value=""),n&&(n.value=""),y()}),t.dataset.listenerAttached="true")}function y(){const{container:e,searchInput:s,statusSelect:t}=B();if(!e||!D.currentId)return;const a=S((s==null?void 0:s.value)||""),n=(t==null?void 0:t.value)||"",{projects:o=[],technicians:l=[]}=N(),f=new Map(l.map(r=>[String(r.id),r])),c=o.filter(r=>String(r.clientId)===String(D.currentId)).filter(r=>!(a&&!S([r.title,r.description,r.notes].filter(Boolean).join(" ")).includes(a)||n&&U(r)!==n)).sort((r,d)=>{const p=new Date(r.start||r.createdAt||0).getTime();return new Date(d.start||d.createdAt||0).getTime()-p});if(!c.length){const r=u("customerProjects.empty",e.dataset.empty||"لا توجد مشاريع مرتبطة بهذا العميل.");e.innerHTML=`<div class="col-12"><div class="alert alert-info text-center mb-0">${r}</div></div>`;return}e.innerHTML=c.map(r=>te(r,f)).join("")}function te(e,s){const t=U(e),a=u(`projects.status.${t}`,se[t]),n=ae[t]||"bg-secondary",o=(e.description||"").trim(),l=v(o?re(o,140):u("projects.fallback.noDescription","No description")),f=(e.title||"").trim()||u("projects.fallback.untitled","Untitled project"),g=Array.isArray(e.technicians)?e.technicians:[],c=g.length,r=u("projectCards.stats.crew","👥 عدد الطاقم: {count}").replace("{count}",m(String(c))),d=g.map(R=>{var b;return(b=s.get(String(R)))==null?void 0:b.name}).filter(Boolean);let p="";if(d.length){const b=d.slice(0,2),M=d.length-b.length,Y=$()==="ar"?"، ":", ",Q=b.join(Y);p=`${v(Q)}${M>0?v(` +${m(String(M))}`):""}`}const E=ie(e),A=(Number(e.equipmentEstimate)||0)+E,T=u("projectCards.stats.budget","💰 التكلفة التقديرية: {amount}").replace("{amount}",z(A)),F=E>0?u("projectCards.stats.expenses","💸 المصروفات: {amount}").replace("{amount}",z(E)):"";return`
    <div class="col-12 col-md-6 col-xl-4">
      <div class="box h-100 project-card">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <h5 class="mb-1">${v(f)}</h5>
            <span class="text-muted small">${v(ne(e.start,e.end))}</span>
          </div>
          <span class="badge ${n} text-white">${v(a)}</span>
        </div>
        <p class="text-muted small mb-3">${l}</p>
        <div class="d-flex flex-column gap-1 small text-muted">
          <span>${v(r)}</span>
          ${p?`<span>👥 ${p}</span>`:""}
          <span>${v(T)}</span>
          ${F?`<span>${v(F)}</span>`:""}
        </div>
      </div>
    </div>
  `}const se={upcoming:"Upcoming",ongoing:"In Progress",completed:"Completed"},ae={upcoming:"bg-info",ongoing:"bg-warning",completed:"bg-success"};function U(e){const s=new Date,t=e.start?new Date(e.start):null,a=e.end?new Date(e.end):null;return t&&!Number.isNaN(t.getTime())&&t>s?"upcoming":a&&!Number.isNaN(a.getTime())&&a<s?"completed":"ongoing"}function ne(e,s){if(!e)return"—";const t=q(e);return s?`${t} - ${q(s)}`:t}function q(e){if(!e)return"—";const s=new Date(e);if(Number.isNaN(s.getTime()))return"—";const a=$()==="ar"?"ar-SA":"en-GB",n=new Intl.DateTimeFormat(a,{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return m(n.format(s))}function z(e){const s=Number(e)||0,t=$(),a=t==="ar"?"ar-SA":"en-US",n=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(s)),o=t==="ar"?"ر.س":"SAR";return`${m(n)} ${o}`}function ie(e){return typeof e.expensesTotal=="number"?e.expensesTotal:Array.isArray(e.expenses)?e.expenses.reduce((s,t)=>s+(Number(t.amount)||0),0):0}function re(e,s){return e?e.length<=s?e:`${e.slice(0,s).trim()}…`:""}function v(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}V();J();K();const I=document.getElementById("logout-btn");I&&!I.dataset.listenerAttached&&(I.addEventListener("click",()=>O()),I.dataset.listenerAttached="true");window.showReservationDetails=X;const oe=new URLSearchParams(window.location.search),h=oe.get("id"),w=document.getElementById("customer-details");let i=null;function ce(e){const{customers:s}=N();return Array.isArray(s)?s.find(t=>String(t.id)===String(e)):null}function C(){if(!w)return;if(!i){w.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="customerDetails.errors.notFound">${u("customerDetails.errors.notFound","⚠️ لم يتم العثور على هذا العميل.")}</p>`;return}const e=[{key:"customerDetails.fields.name",value:i.customerName||"—"},{key:"customerDetails.fields.phone",value:i.phone?m(i.phone):"—"},{key:"customerDetails.fields.company",value:i.companyName||"—"},{key:"customerDetails.fields.email",value:i.email||"—"},{key:"customerDetails.fields.address",value:i.address||"—"},{key:"customerDetails.fields.notes",value:i.notes||"—"}].map(({key:s,value:t})=>`
        <p class="customer-detail-row">
          <strong data-i18n data-i18n-key="${s}">${u(s)}</strong>
          <span>${t}</span>
        </p>
      `).join("");w.innerHTML=`
        <div class="customer-details">
          ${e}
        </div>
        <button class="btn btn-warning mt-3" id="edit-btn" data-i18n data-i18n-key="customerDetails.actions.edit">${u("customerDetails.actions.edit","✏️ تعديل العميل")}</button>
      `,de()}function le(){document.getElementById("edit-id").value=(i==null?void 0:i.id)||"",document.getElementById("edit-name").value=(i==null?void 0:i.customerName)||"",document.getElementById("edit-phone").value=m((i==null?void 0:i.phone)||""),document.getElementById("edit-company").value=(i==null?void 0:i.companyName)||"",document.getElementById("edit-email").value=(i==null?void 0:i.email)||"",document.getElementById("edit-address").value=(i==null?void 0:i.address)||"",document.getElementById("edit-notes").value=(i==null?void 0:i.notes)||""}function de(){const e=document.getElementById("edit-btn");!e||e.dataset.listenerAttached||(e.addEventListener("click",()=>{le(),new bootstrap.Modal(document.getElementById("editCustomerModal")).show()}),e.dataset.listenerAttached="true")}const k=document.getElementById("save-edit-btn");k&&!k.dataset.listenerAttached&&(k.addEventListener("click",()=>{if(!i)return;const e=document.getElementById("edit-id").value,s=document.getElementById("edit-name").value.trim(),t=m(document.getElementById("edit-phone").value.trim()),a=document.getElementById("edit-company").value.trim(),n=document.getElementById("edit-email").value.trim(),o=document.getElementById("edit-address").value.trim(),l=document.getElementById("edit-notes").value.trim();if(!s||!t){L(u("customerDetails.toast.missingRequired","⚠️ الاسم ورقم الهاتف إلزاميان"));return}const f=N(),g=Array.isArray(f.customers)?f.customers:[],c=g.findIndex(d=>String(d.id)===String(e));if(c===-1){L(u("customerDetails.toast.notFound","⚠️ العميل غير موجود"));return}g[c]={...g[c],customerName:s,phone:t,companyName:a,email:n,address:o,notes:l},W({customers:g}),i=g[c],C(),P(h),j(h),document.dispatchEvent(new CustomEvent("customers:changed")),L(u("customerDetails.toast.updateSuccess","✅ تم تحديث بيانات العميل"));const r=bootstrap.Modal.getInstance(document.getElementById("editCustomerModal"));r==null||r.hide()}),k.dataset.listenerAttached="true");h?(i=ce(h),C(),i&&(P(h),j(h))):w&&(w.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="customerDetails.errors.missingId">${u("customerDetails.errors.missingId","⚠️ لا يوجد معرف عميل في الرابط.")}</p>`);document.addEventListener("language:changed",()=>{C(),h&&i&&(P(h),j(h))});
