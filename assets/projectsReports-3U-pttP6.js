import{t as f,n as C,f as L,g as D}from"./auth-CNAfl19F.js";/* empty css                */import{l as q}from"./storage-DOnDLvtb.js";import"./projects-B5HGRUVy.js";import"./projectsCommon-D-frPOvU.js";import{b as H}from"./reservationsSummary-CBdNx1nm.js";const z="modulepreload",G=function(t){return"/artratiorentalapp/"+t},I={},K=function(n,e,r){let l=Promise.resolve();if(e&&e.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),u=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));l=Promise.allSettled(e.map(s=>{if(s=G(s),s in I)return;I[s]=!0;const o=s.endsWith(".css"),m=o?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${s}"]${m}`))return;const p=document.createElement("link");if(p.rel=o?"stylesheet":z,o||(p.as="script"),p.crossOrigin="",p.href=s,u&&p.setAttribute("nonce",u),document.head.appendChild(p),o)return new Promise((h,v)=>{p.addEventListener("load",h),p.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${s}`)))})}))}function d(i){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=i,window.dispatchEvent(u),!u.defaultPrevented)throw i}return l.then(i=>{for(const u of i||[])u.status==="rejected"&&d(u.reason);return n().catch(d)})},R=.15,T={},c={projects:[],customers:[],reservations:[],totalProjects:0,filters:{search:"",statuses:["upcoming","ongoing","completed"],payment:"all",range:"all",startDate:"",endDate:""}},a={search:null,payment:null,dateRange:null,customRangeWrapper:null,startDate:null,endDate:null,refreshBtn:null,kpiGrid:null,statusChips:null,table:null,tableBody:null,tableMeta:null,tableEmpty:null};let y=null;const F=["upcoming","ongoing","completed"];async function Y(){await Z(),J(),A(),U(),nt(),b(),document.addEventListener("language:changed",rt),document.addEventListener("projects:changed",$),document.addEventListener("reservations:changed",$),window.addEventListener("storage",st)}document.addEventListener("DOMContentLoaded",Y);async function Z(){if(y)return y;try{y=(await K(()=>import("https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"),[])).default}catch(t){console.warn("Chart.js failed to load",t),y=null}return y}function J(){var t;a.search=document.getElementById("reports-search"),a.statusChips=document.getElementById("reports-status-chips"),a.payment=document.getElementById("reports-payment"),a.dateRange=document.getElementById("reports-date-range"),a.customRangeWrapper=document.getElementById("reports-custom-range"),a.startDate=document.getElementById("reports-start-date"),a.endDate=document.getElementById("reports-end-date"),a.refreshBtn=document.getElementById("reports-refresh"),a.kpiGrid=document.getElementById("reports-kpi-grid"),a.table=document.getElementById("reports-table"),a.tableBody=(t=a.table)==null?void 0:t.querySelector("tbody"),a.tableMeta=document.getElementById("reports-table-meta"),a.tableEmpty=document.getElementById("reports-empty")}function A(){const{projects:t=[],reservations:n=[],customers:e=[]}=q();c.customers=Array.isArray(e)?e:[],c.reservations=Array.isArray(n)?n:[];const r=new Map(c.customers.map(l=>[String(l.id),l]));c.projects=Array.isArray(t)?t.map(l=>X(l,r)):[],c.totalProjects=c.projects.length}function X(t,n){const e=t.paymentStatus==="paid"?"paid":"unpaid",r=n.get(String(t.clientId)),l=Q(t.id),d=l.reduce((_,W)=>_+j(W),0),i=tt(t),u=Number(t==null?void 0:t.equipmentEstimate)||0,s=Number((u+i).toFixed(2)),o=(t==null?void 0:t.applyTax)===!0||(t==null?void 0:t.applyTax)==="true",m=o?Number((s*R).toFixed(2)):0,p=o?Number(((s+d)*R).toFixed(2)):0,h=Number((s+d+p).toFixed(2)),v=et(t),S=t.start?new Date(t.start):null,V=t.end?new Date(t.end):null;return{raw:t,id:t.id,projectCode:t.projectCode||t.id,title:(t.title||"").trim(),clientId:t.clientId,clientName:(r==null?void 0:r.customerName)||(r==null?void 0:r.name)||"",clientCompany:t.clientCompany||(r==null?void 0:r.companyName)||"",type:t.type||t.projectType||"",description:t.description||"",paymentStatus:e,confirmed:t.confirmed===!0||t.confirmed==="true",start:S,end:V,applyTax:o,status:v,reservationsTotal:Number(d.toFixed(2)),expensesTotal:i,subtotal:s,taxAmount:m,combinedTaxAmount:p,overallTotal:h,unpaidValue:e==="paid"?0:h,reservationsCount:l.length}}function Q(t){return Array.isArray(c.reservations)?c.reservations.filter(n=>String(n.projectId)===String(t)):[]}function j(t){if(!t)return 0;const n=Array.isArray(t.items)?t.items:[],e=t.discount??0,r=Number(C(String(e)))||0,l=t.discountType||"percent",d=Array.isArray(t.technicians)?t.technicians:[],i=H(n,r,l,!1,d,{start:t.start,end:t.end});if(Number.isFinite(i))return i;const u=Number(C(String(t.cost??0)));return Number.isFinite(u)?Math.round(u):0}function tt(t){return typeof t.expensesTotal=="number"?Number(t.expensesTotal)||0:Array.isArray(t.expenses)?t.expenses.reduce((n,e)=>n+(Number(e.amount)||0),0):0}function et(t){const n=new Date,e=t.start?new Date(t.start):null,r=t.end?new Date(t.end):null;return e&&!Number.isNaN(e.getTime())&&e>n?"upcoming":r&&!Number.isNaN(r.getTime())&&r<n?"completed":"ongoing"}function nt(){if(a.search){let t;a.search.addEventListener("input",()=>{clearTimeout(t),t=setTimeout(()=>{c.filters.search=a.search.value.trim(),b()},180)})}a.payment&&(a.payment.value=c.filters.payment,a.payment.addEventListener("change",()=>{c.filters.payment=a.payment.value||"all",b()})),a.dateRange&&(a.dateRange.addEventListener("change",at),a.dateRange.value=c.filters.range),a.startDate&&a.startDate.addEventListener("change",()=>{c.filters.startDate=a.startDate.value,c.filters.range==="custom"&&b()}),a.endDate&&a.endDate.addEventListener("change",()=>{c.filters.endDate=a.endDate.value,c.filters.range==="custom"&&b()}),a.refreshBtn&&a.refreshBtn.addEventListener("click",()=>{var t,n;if(c.filters.range!=="custom"){b();return}c.filters.startDate=((t=a.startDate)==null?void 0:t.value)||"",c.filters.endDate=((n=a.endDate)==null?void 0:n.value)||"",b()})}function at(t){var e,r;const n=t.target.value;c.filters.range=n,n==="custom"?(e=a.customRangeWrapper)==null||e.classList.add("active"):((r=a.customRangeWrapper)==null||r.classList.remove("active"),c.filters.startDate="",c.filters.endDate="",a.startDate&&(a.startDate.value=""),a.endDate&&(a.endDate.value=""),b())}function $(){A(),b()}function rt(){U(),b()}function st(t){t.key&&!["projects","reservations","customers"].includes(t.key)||(A(),b())}function b(){const t=ot();w(),ut(t),dt(t),mt(t),pt(t),ft(t),gt(t)}function ot(){const{search:t,statuses:n,payment:e,range:r,startDate:l,endDate:d}=c.filters,i=O(t),u=new Date,s=Number(r);let o=null;if(r==="custom"){o=l?new Date(l):null;const m=d?new Date(d):null;return c.projects.filter(p=>!B(p,n)||!P(p,e)||!M(p,i)?!1:lt(p.start,o,m))}return r!=="all"&&Number.isFinite(s)&&(o=new Date,o.setDate(u.getDate()-s)),c.projects.filter(m=>!B(m,n)||!P(m,e)||!M(m,i)?!1:r==="all"?!0:it(m.start,o,u))}function B(t,n){return n.includes(t.status)}function P(t,n){return n==="all"?!0:t.paymentStatus===n}function M(t,n){return n?O([t.title,t.projectCode,t.clientName,t.clientCompany,t.type,t.description].filter(Boolean).join(" ")).includes(n):!0}function it(t,n,e){return!t||!(t instanceof Date)||Number.isNaN(t.getTime())?!1:n?t>=n&&t<=e:!0}function lt(t,n,e){if(!n&&!e)return!0;if(!t||Number.isNaN(t.getTime()))return!1;const r=t.getTime();return!(n&&!Number.isNaN(n.getTime())&&r<n.getTime()||e&&!Number.isNaN(e.getTime())&&r>e.getTime())}function O(t){return t?C(String(t)).toLowerCase().trim():""}function ut(t){if(!a.kpiGrid)return;const n=t.length,e=t.reduce((i,u)=>i+u.overallTotal,0),r=t.reduce((i,u)=>i+u.unpaidValue,0),l=t.reduce((i,u)=>i+u.expensesTotal,0),d=[{icon:"ðŸ“Š",label:f("projects.reports.kpi.totalProjects","Total projects"),value:k(n),meta:f("projects.reports.kpi.totalProjectsMeta","After applying the current filters")},{icon:"ðŸ’°",label:f("projects.reports.kpi.totalValue","Total value"),value:E(e),meta:f("projects.reports.kpi.totalValueMeta","Includes projects and linked reservations")},{icon:"ðŸ§¾",label:f("projects.reports.kpi.unpaidValue","Outstanding value"),value:E(r),meta:f("projects.reports.kpi.unpaidValueMeta","Projects not fully paid yet")},{icon:"ðŸ’¸",label:f("projects.reports.kpi.expenses","Total expenses"),value:E(l),meta:f("projects.reports.kpi.expensesMeta","Expenses for included projects")}];a.kpiGrid.innerHTML=d.map(({icon:i,label:u,value:s,meta:o})=>`
    <div class="reports-kpi-card">
      <div class="reports-kpi-icon">${i}</div>
      <div class="reports-kpi-content">
        <p class="reports-kpi-label">${g(u)}</p>
        <p class="reports-kpi-value">${g(s)}</p>
        <span class="reports-kpi-meta">${g(o)}</span>
      </div>
    </div>
  `).join("")}function U(){if(!a.statusChips)return;const t=F.map(n=>{const e=f(`projects.status.${n}`,n);return`<button type="button" class="reports-status-chip" data-status="${n}">${g(e)}</button>`}).join("");a.statusChips.innerHTML=t,a.statusChips.dataset.listenerAttached||(a.statusChips.addEventListener("click",ct),a.statusChips.dataset.listenerAttached="true"),w()}function ct(t){const n=t.target.closest("[data-status]");if(!n)return;const e=n.dataset.status;if(!e)return;const r=new Set(c.filters.statuses);r.has(e)?r.delete(e):r.add(e),r.size===0&&F.forEach(l=>r.add(l)),c.filters.statuses=Array.from(r),w(),b()}function w(){if(!a.statusChips)return;const t=new Set(c.filters.statuses);a.statusChips.querySelectorAll("[data-status]").forEach(n=>{n.classList.toggle("is-active",t.has(n.dataset.status))})}function dt(t){if(!y)return;const n=document.getElementById("reports-status-chart");if(!n)return;const e=["upcoming","ongoing","completed"],r=e.map(u=>t.filter(s=>s.status===u).length),d={labels:e.map(u=>f(`projects.status.${u}`,u)),datasets:[{data:r,backgroundColor:["rgba(59, 130, 246, 0.85)","rgba(250, 204, 21, 0.85)","rgba(34, 197, 94, 0.85)"],borderColor:["rgba(37, 99, 235, 1)","rgba(217, 119, 6, 1)","rgba(22, 163, 74, 1)"],borderWidth:1}]};N("status",n,"doughnut",d,{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{usePointStyle:!0}}}})}function mt(t){if(!y)return;const n=document.getElementById("reports-timeline-chart");if(!n)return;const e=new Map,r=new Intl.DateTimeFormat(yt(),{month:"short",year:"numeric"});t.forEach(o=>{if(!o.start||Number.isNaN(o.start.getTime()))return;const m=`${o.start.getFullYear()}-${o.start.getMonth()+1}`,p=e.get(m)||{total:0,label:r.format(o.start)};p.total+=o.overallTotal,e.set(m,p)});const l=Array.from(e.keys()).sort((o,m)=>{const[p,h]=o.split("-").map(Number),[v,S]=m.split("-").map(Number);return p===v?h-S:p-v}),d=l.map(o=>{var m;return((m=e.get(o))==null?void 0:m.label)||o}),i=l.map(o=>{var m;return Math.round(((m=e.get(o))==null?void 0:m.total)||0)}),u={labels:d,datasets:[{label:f("projects.reports.charts.timeline","Revenue over time"),data:i,borderColor:"rgba(76, 110, 245, 0.95)",backgroundColor:"rgba(76, 110, 245, 0.25)",fill:!0,tension:.35,pointRadius:4}]};N("timeline",n,"line",u,{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:o=>x(o)}}},plugins:{legend:{display:!1}}})}function pt(t){if(!y)return;const n=document.getElementById("reports-expense-chart");if(!n)return;const e=[...t].sort((s,o)=>o.overallTotal-s.overallTotal).slice(0,6),r=e.map(s=>s.title||s.projectCode),l=e.map(s=>Math.round(s.overallTotal)),d=e.map(s=>Math.round(s.expensesTotal)),i={labels:r,datasets:[{label:f("projects.reports.datasets.value","Total value"),data:l,backgroundColor:"rgba(76, 110, 245, 0.65)"},{label:f("projects.reports.datasets.expenses","Expenses"),data:d,backgroundColor:"rgba(244, 114, 182, 0.55)"}]};N("expenses",n,"bar",i,{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",scales:{x:{beginAtZero:!0,ticks:{callback:s=>x(s)}}},plugins:{legend:{position:"bottom",labels:{usePointStyle:!0}}}})}function ft(t){if(!y)return;const n=document.getElementById("reports-clients-chart");if(!n)return;const e=new Map;t.forEach(s=>{const o=s.clientName||s.clientCompany||f("projects.fallback.unknownClient","Unknown client"),m=e.get(o)||0;e.set(o,m+s.overallTotal)});const r=Array.from(e.entries()).sort((s,o)=>o[1]-s[1]).slice(0,6),l=r.map(([s])=>s),d=r.map(([,s])=>Math.round(s)),i={labels:l,datasets:[{label:f("projects.reports.charts.clients","Top clients"),data:d,backgroundColor:"rgba(59, 130, 246, 0.75)"}]};N("clients",n,"bar",i,{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{callback:s=>x(s)}}},plugins:{legend:{display:!1}}})}function N(t,n,e,r,l){if(!(!y||!n)){if(T[t]){T[t].data=r,T[t].options=l,T[t].update();return}T[t]=new y(n,{type:e,data:r,options:l})}}function gt(t){if(!a.table||!a.tableBody||!a.tableEmpty)return;if(!t.length){a.table.style.display="none",a.tableEmpty.classList.add("active"),a.tableMeta&&(a.tableMeta.textContent="");return}a.table.style.display="",a.tableEmpty.classList.remove("active");const n=t.map(e=>{const r=bt(e.start,e.end),l=f(`projects.status.${e.status}`,e.status),d=f(`projects.paymentStatus.${e.paymentStatus}`,e.paymentStatus),i=e.clientCompany?`${g(e.clientName)} <small class="text-muted">${g(e.clientCompany)}</small>`:g(e.clientName||f("projects.fallback.unknownClient","Unknown client"));return`
      <tr>
        <td>
          <div class="d-flex flex-column gap-1">
            <span class="fw-semibold">${g(e.title||e.projectCode)}</span>
            <small class="text-muted">${g(`#${e.projectCode}`)}</small>
          </div>
        </td>
        <td>${i}</td>
        <td>${g(l)}</td>
        <td>${g(r)}</td>
        <td>${g(E(e.overallTotal))}</td>
        <td>${g(d)}</td>
      </tr>
    `}).join("");if(a.tableBody.innerHTML=n,a.tableMeta){const e=f("projects.reports.table.meta","Showing {count} of {total} projects");a.tableMeta.textContent=e.replace("{count}",k(t.length)).replace("{total}",k(c.totalProjects))}}function bt(t,n){if(!t&&!n)return"â€”";const e=t?L(t.toISOString()):"â€”",r=n?L(n.toISOString()):"â€”";return n?`${e} â†’ ${r}`:e}function E(t){const n=Number(t)||0,e=D(),r=e==="ar"?"ar-SA":"en-US",l=new Intl.NumberFormat(r,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(n)),d=e==="ar"?"Ø±.Ø³":"SAR";return`${C(l)} ${d}`}function k(t){const e=D()==="ar"?"ar-SA":"en-US";return C(new Intl.NumberFormat(e).format(t))}function x(t){const e=D()==="ar"?"ar-SA":"en-US";return C(new Intl.NumberFormat(e,{notation:"compact",compactDisplay:"short"}).format(t))}function yt(){return D()==="ar"?"ar-SA":"en-US"}function g(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}
