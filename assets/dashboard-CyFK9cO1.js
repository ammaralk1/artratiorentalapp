import{t as l,n as g,s as h,g as Y,f as P,a as ne,c as ae,i as oe,l as se}from"./auth-EZuC3asg.js";import{l as k,s as xt}from"./storage-CJlT24HE.js";import{s as ce,c as re,i as Mt,a as le,r as ct,b as de,d as rt,e as qt,l as ie,u as ue}from"./events-msGuolqg.js";let M=null;function Dt(){document.dispatchEvent(new CustomEvent("customers:changed"))}function j(){return k().customers||[]}function nt(t){xt({customers:t})}function N(){return{form:document.getElementById("customer-form"),idInput:document.getElementById("customer-id"),nameInput:document.getElementById("customer-name"),phoneInput:document.getElementById("customer-phone"),emailInput:document.getElementById("customer-email"),addressInput:document.getElementById("customer-address"),companyInput:document.getElementById("customer-company"),notesInput:document.getElementById("customer-notes"),submitBtn:document.getElementById("submit-btn"),cancelBtn:document.getElementById("customer-cancel-btn")}}function lt(t="add"){const{submitBtn:e}=N();if(!e)return;const n=t==="update"?"customers.form.actions.update":"customers.form.actions.submit",a=t==="update"?"💾 حفظ التعديل":"➕ إضافة عميل";e.textContent=l(n,a)}function dt(t){const{cancelBtn:e}=N();e&&(t?e.classList.remove("d-none"):e.classList.add("d-none"),e.textContent=l("customers.form.actions.cancel","إلغاء التعديل"))}function it(){const t=!!M;lt(t?"update":"add"),dt(t)}function ut(){const{form:t,idInput:e,phoneInput:n}=N();t==null||t.reset(),e&&(e.value=""),n&&(n.value=n.value.trim()),M=null,lt("add"),dt(!1)}function me(t){const{idInput:e,nameInput:n,phoneInput:a,emailInput:s,addressInput:o,companyInput:c,notesInput:r}=N();!t||!n||!a||(e&&(e.value=t.id),n.value=t.customerName||"",a.value=g(t.phone||""),s&&(s.value=t.email||""),o&&(o.value=t.address||""),c&&(c.value=t.companyName||""),r&&(r.value=t.notes||""),M=t.id,lt("update"),dt(!0))}function pe(){const{idInput:t,nameInput:e,phoneInput:n,emailInput:a,addressInput:s,companyInput:o,notesInput:c}=N();if(!e||!n)return null;const r=e.value.trim(),d=g(n.value.trim());return n.value=d,!r||!d?(h(l("customers.toast.missingFields","يرجى تعبئة الاسم ورقم الهاتف"),"error"),null):{id:(t==null?void 0:t.value)||M||Date.now().toString(),customerName:r,phone:d,email:(a==null?void 0:a.value.trim())||"",address:(s==null?void 0:s.value.trim())||"",companyName:(o==null?void 0:o.value.trim())||"",notes:(c==null?void 0:c.value.trim())||""}}function fe(t){t.preventDefault();const e=pe();if(!e)return;const n=j(),a=n.findIndex(s=>String(s.id)===String(e.id));a>=0?(n[a]={...n[a],...e},nt(n),h(l("customers.toast.updateSuccess","تم تحديث بيانات العميل بنجاح"))):(n.push(e),nt(n),h(l("customers.toast.createSuccess","تمت إضافة العميل بنجاح"))),D(),ut(),Dt()}function ge(t){const e=t.target;if(e instanceof HTMLElement){if(e.classList.contains("customer-delete-btn")){const n=e.dataset.id;if(!confirm(l("customers.toast.deleteConfirm","⚠️ هل أنت متأكد من حذف هذا العميل؟")))return;const a=j().filter(s=>String(s.id)!==String(n));nt(a),D(),M===n&&ut(),h(l("customers.toast.deleteSuccess","تم حذف العميل")),Dt();return}if(e.classList.contains("customer-edit-btn")){const n=e.dataset.id,a=j().find(s=>String(s.id)===String(n));if(!a)return;me(a)}}}function be(t){const e=t.target.value.trim().toLowerCase(),a=j().filter(o=>{var i,f,m;const c=((i=o.customerName)==null?void 0:i.toLowerCase())||"",r=((f=o.phone)==null?void 0:f.toLowerCase())||"",d=((m=o.companyName)==null?void 0:m.toLowerCase())||"";return c.includes(e)||r.includes(e)||d.includes(e)}),s=e?l("customers.table.noResults","لا توجد نتائج مطابقة"):void 0;D(a,{emptyMessage:s})}function ye(){const{form:t,cancelBtn:e}=N();t&&t.addEventListener("submit",fe),e&&e.addEventListener("click",()=>{ut()});const n=document.getElementById("customers-table");n&&n.addEventListener("click",ge);const a=document.getElementById("search-customer-input");a&&a.addEventListener("input",be)}document.addEventListener("DOMContentLoaded",()=>{ye(),D(),it()});document.addEventListener("language:changed",()=>{it(),D()});document.addEventListener("customers:refreshRequested",()=>{D(),it()});function D(t,e={}){const n=Array.isArray(t)?t:j(),a=document.getElementById("customers-table");if(!a)return;if(a.innerHTML="",n.length===0){const c=e.emptyMessage||l("customers.table.empty","لا يوجد عملاء");a.innerHTML=`<tr><td colspan='6'>${c}</td></tr>`;return}const s=l("customers.actions.edit","✏️ تعديل"),o=l("customers.actions.delete","🗑️ حذف");n.forEach(c=>{const r=M&&String(M)===String(c.id),d=document.createElement("tr");r&&d.classList.add("table-info"),d.innerHTML=`
      <td><a href="customer.html?id=${c.id}" class="text-decoration-none">${c.customerName}</a></td>
      <td>${g(c.phone)}</td>
      <td>${c.companyName||""}</td>
      <td class="table-notes-cell">${c.notes||"—"}</td>
      <td class="table-actions-cell">
        <div class="table-action-buttons">
          <button class="btn btn-sm btn-warning customer-edit-btn" data-id="${c.id}">${s}</button>
          <button class="btn btn-sm btn-danger customer-delete-btn" data-id="${c.id}">${o}</button>
        </div>
      </td>
    `,a.appendChild(d)})}let K=null,St=!1;function he(t){const e=t.paid===!0||t.paid==="paid",n=t.confirmed===!0||t.confirmed==="true";return t.completed?{background:"#6c757d",border:"#565e64",text:"#fff"}:e?n?{background:"#198754",border:"#146c43",text:"#fff"}:{background:"#ffc107",border:"#cc9a06",text:"#212529"}:{background:"#dc3545",border:"#b02a37",text:"#fff"}}function Ee(t){const{reservationId:e,customerName:n,paid:a,confirmed:s,completed:o}=t.event.extendedProps,c=a===!0||a==="paid",r=s===!0||s==="true",d=document.createElement("div");d.className="fc-reservation-event";const i=r?l("calendar.badges.confirmed","مؤكد"):l("calendar.badges.pending","غير مؤكد"),f=c?l("calendar.badges.paid","مدفوع"):l("calendar.badges.unpaid","غير مدفوع"),m=l("calendar.badges.completed","منتهي"),u=l("calendar.labels.unknownCustomer","غير معروف");return d.innerHTML=`
    <div class="fc-reservation-id">${e}</div>
    <div class="fc-reservation-customer">${n||u}</div>
    <div class="fc-reservation-tags">
      <span class="badge ${r?"bg-success":"bg-warning text-dark"}">${i}</span>
      <span class="badge ${c?"bg-primary":"bg-danger"}">${f}</span>
      ${o?`<span class="badge bg-secondary">${m}</span>`:""}
    </div>
  `,{domNodes:[d]}}function $e(t){var vt;const e=document.getElementById("calendar-reservation-details");if(!e){alert(l("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"));return}const n=t.confirmed===!0||t.confirmed==="true",a=t.paid===!0||t.paid==="paid",s=!!t.completed,o=n?l("calendar.badges.confirmed","مؤكد"):l("calendar.badges.pending","غير مؤكد"),c=a?l("calendar.badges.paid","مدفوع"):l("calendar.badges.unpaid","غير مدفوع"),r=l("calendar.badges.completed","منتهي"),d=Y(),i=t.items||[],f=ce()||[],m=new Map(f.map(p=>[String(p.id),p])),u=(t.technicians||[]).map(p=>m.get(String(p))).filter(Boolean),y=re(t.start,t.end),I=i.reduce((p,$)=>p+($.qty||1)*($.price||0),0)*y,E=(p={})=>{const $=[p.dailyWage,p.daily_rate,p.dailyRate,p.wage,p.rate];for(const R of $){if(R==null)continue;const G=parseFloat(g(String(R)));if(Number.isFinite(G))return G}return 0},U=u.reduce((p,$)=>p+E($),0)*y,z=I+U,A=(()=>{const p=parseFloat(t.discount)||0;return p?t.discountType==="amount"?p:z*(p/100):0})(),Et=Math.max(0,z-A),X=t.applyTax?Et*.15:0,Ut=t.cost??Math.round(Et+X),$t=l("calendar.labels.currencySuffix","ريال"),zt=i.length?i.map((p,$)=>{const R=p.image||p.imageUrl||p.img||"",G=g(String(p.barcode||"-")),Xt=g(String(p.qty||1)),te=g(String(p.price||0)),ee=R?`<img src="${R}" alt="${p.desc||""}" class="reservation-modal-item-thumb">`:"-";return`
          <tr>
            <td>${g(String($+1))}</td>
            <td>${G}</td>
            <td>${p.desc||"-"}</td>
            <td>${Xt}</td>
            <td>${te} ${$t}</td>
            <td>${ee}</td>
          </tr>
        `}).join(""):`<tr><td colspan="6" class="text-center">${l("calendar.labels.noEquipment","لا توجد معدات")}</td></tr>`,W=[`<div>${l("calendar.summary.baseCost","💵 إجمالي المعدات: <strong>{value} ريال</strong>").replace("{value}",I.toFixed(2))}</div>`,`<div>${l("calendar.summary.crewTotal","😎 إجمالي الفريق: <strong>{value} ريال</strong>").replace("{value}",U.toFixed(2))}</div>`,`<div>${l("calendar.summary.duration","⏱️ عدد الأيام: <strong>{value}</strong>").replace("{value}",g(String(y)))}</div>`];if(A>0){const p=d==="en"?"%":"٪",$=t.discountType==="percent"?`${parseFloat(t.discount||0).toFixed(2)}${p}`:`${A.toFixed(2)} ${$t}`;W.push(`<div>${l("calendar.summary.discount","💸 الخصم: <strong>{value}</strong>").replace("{value}",$)}</div>`)}t.applyTax&&X>0&&W.push(`<div>${l("calendar.summary.tax","🧾 الضريبة (15%): <strong>{value} ريال</strong>").replace("{value}",X.toFixed(2))}</div>`),W.push(`<div>${l("calendar.summary.total","💰 المجموع النهائي: <strong>{value} ريال</strong>").replace("{value}",Ut.toFixed(2))}</div>`);const Wt=g(String(t.reservationId??t.id??"")),Gt=t.start?g(P(t.start)):"-",Kt=t.end?g(P(t.end)):"-",Qt=t.notes?g(t.notes):l("calendar.labels.noNotes","لا توجد ملاحظات"),Jt=t.customerName||l("calendar.labels.unknownCustomer","غير معروف"),Zt=[{icon:"🆔",label:l("calendar.labels.reservationId","رقم الحجز"),value:Wt},{icon:"👤",label:l("calendar.labels.customer","العميل"),value:Jt},{icon:"🗓️",label:l("calendar.labels.start","بداية الحجز"),value:Gt},{icon:"🗓️",label:l("calendar.labels.end","نهاية الحجز"),value:Kt},{icon:"📝",label:l("calendar.labels.notes","الملاحظات"),value:Qt}];e.innerHTML=`
    <div class="calendar-reservation-status mb-3">
      <span class="badge ${n?"bg-success":"bg-warning text-dark"}">${o}</span>
      <span class="badge ${a?"bg-primary":"bg-danger"}">${c}</span>
      ${s?`<span class="badge bg-secondary">${r}</span>`:""}
    </div>
    <div class="calendar-reservation-info">
      ${Zt.map(p=>`
        <div class="calendar-info-row">
          <span class="label">${p.icon} ${p.label}</span>
          <span class="value">${p.value}</span>
        </div>
      `).join("")}
    </div>
    <h6 class="calendar-section-title">${l("calendar.sections.crew","😎 الفريق الفني")}</h6>
    ${u.length?`<ul class="list-unstyled calendar-reservation-technicians">${u.map(p=>{const $=p.role?` — ${p.role}`:"";return`<li><strong>${p.name}</strong>${$}</li>`}).join("")}</ul>`:`<p class="calendar-empty-state">${l("calendar.emptyStates.noCrew","😎 لا يوجد فريق مرتبط بهذا الحجز.")}</p>`}
    <h6 class="calendar-section-title">${l("calendar.sections.equipment","📦 المعدات")}</h6>
    <div class="table-responsive reservation-modal-items-wrapper">
      <table class="table table-sm table-hover align-middle reservation-modal-items-table">
        <thead>
          <tr>
            <th>#</th>
            <th>${l("calendar.table.headers.barcode","الباركود")}</th>
            <th>${l("calendar.table.headers.description","الوصف")}</th>
            <th>${l("calendar.table.headers.quantity","الكمية")}</th>
            <th>${l("calendar.table.headers.price","السعر")}</th>
            <th>${l("calendar.table.headers.image","الصورة")}</th>
          </tr>
        </thead>
        <tbody>${zt}</tbody>
      </table>
    </div>
    <div class="calendar-reservation-summary">
      ${W.join("")}
    </div>
  `;const It=document.getElementById("calendarReservationModal");It&&((vt=window.bootstrap)!=null&&vt.Modal)?window.bootstrap.Modal.getOrCreateInstance(It).show():alert(l("calendar.alerts.cannotOpenModal","لا يمكن فتح نافذة التفاصيل"))}function mt(){console.log("✅ renderCalendar تعمل");const t=document.getElementById("calendar");if(!t)return;K&&(K.destroy(),K=null);const{reservations:e=[],customers:n=[]}=k(),a=e.map(o=>{const c=n.find(i=>String(i.id)===String(o.customerId)),r=o.end?new Date(o.end)<new Date:!1,d=he({...o,completed:r});return{id:o.id,title:"",start:o.start,end:o.end,backgroundColor:d.background,borderColor:d.border,textColor:d.text,display:"auto",extendedProps:{...o,customerName:(c==null?void 0:c.customerName)||l("calendar.labels.unknownCustomer","غير معروف"),completed:r}}}),s=new FullCalendar.Calendar(t,{initialView:"dayGridMonth",locale:Y(),timeZone:"local",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},buttonText:{today:l("calendar.buttons.today","اليوم"),month:l("calendar.buttons.month","شهر"),week:l("calendar.buttons.week","أسبوع"),day:l("calendar.buttons.day","يوم")},events:a,eventContent:Ee,eventClick:function(o){$e(o.event.extendedProps)}});s.render(),K=s,St||(document.addEventListener("language:changed",()=>{mt()}),St=!0)}let wt=null,tt=null,et=null;const Ie={range:"last30",search:"",start:null,end:null};function b(t,e,n=e){const a=Y()==="en"?n??e:e;return l(t,a)}function pt(){return(Y()||"ar").toLowerCase().startsWith("ar")?"ar-EG":"en-US"}function Nt(){const t=Y();if(t!==wt||!tt||!et){wt=t;const e=pt();tt=new Intl.NumberFormat(e,{maximumFractionDigits:0}),et=new Intl.NumberFormat(e,{style:"currency",currency:"SAR",maximumFractionDigits:0})}return{numberFormatter:tt,currencyFormatter:et}}function ve(t){const e=pt();return new Intl.DateTimeFormat(e,{month:"short"}).format(t)}function Se(){const{reservations:t=[],customers:e=[],equipment:n=[],technicians:a=[]}=k(),s=we(t,Ie,e,n,a),o=xe(s),c=Me(s),r=qe(s),d=De(s),i=Ne(s,e),f=Ae(s,n);Ye(o),Fe(c),Tt("reports-status-breakdown",r),Tt("reports-payment-breakdown",d),He(i),Pe(f),Re(s,e,a),_e(s.length===0)}function At(t){return g(String(t||"")).toLowerCase().trim()}function we(t,e,n,a,s){const{startDate:o,endDate:c}=Te(e),r=At(e.search),d=!!r,i=new Map((n||[]).map(u=>[String(u.id),u])),f=new Map((a||[]).map(u=>[Q(u==null?void 0:u.barcode),u])),m=new Map((s||[]).map(u=>[String(u.id),u]));return(t||[]).filter(u=>{const y=u!=null&&u.start?new Date(u.start):null;return!(!y||Number.isNaN(y.getTime())||o&&y<o||c&&y>c||(_(u),J(u),d&&!Be(u,r,i,f,m)))})}function Be(t,e,n,a,s){const o=[],c=(t==null?void 0:t.reservationId)||(t==null?void 0:t.id);c&&o.push(c),t!=null&&t.notes&&o.push(t.notes);const r=_(t);r&&o.push(r);const d=(t==null?void 0:t.paymentStatus)||(t==null?void 0:t.payment_status);d&&o.push(d),(t==null?void 0:t.paid)!=null&&o.push(t.paid?"paid":"unpaid");const i=n.get(String(t==null?void 0:t.customerId));return i&&o.push(i.customerName,i.company_name||i.companyName,i.contact_person||""),o.push(Rt(t)),((t==null?void 0:t.items)||[]).forEach(m=>{m!=null&&m.desc&&o.push(m.desc),m!=null&&m.barcode&&o.push(m.barcode);const u=a.get(Q(m==null?void 0:m.barcode));u&&o.push(u.desc,u.description,u.name)}),((t==null?void 0:t.technicians)||[]).forEach(m=>{const u=s.get(String(m));u&&o.push(u.name,u.role,u.department)}),At(o.filter(Boolean).join(" ")).includes(e)}function Te({range:t,start:e,end:n}){const a=new Date;a.setHours(23,59,59,999);const s=new Date(a);let o=null;switch(t){case"last30":{o=new Date(a),o.setDate(o.getDate()-29);break}case"thisWeek":{const c=new Date(a),d=(c.getDay()-6+7)%7;c.setDate(c.getDate()-d),c.setHours(0,0,0,0);const i=new Date(c);i.setDate(c.getDate()+6),i.setHours(23,59,59,999),o=c,s.setTime(i.getTime());break}case"thisMonth":{o=new Date(a.getFullYear(),a.getMonth(),1);const c=new Date(a.getFullYear(),a.getMonth()+1,0);s.setTime(c.setHours(23,59,59,999));break}case"thisQuarter":{const c=Math.floor(a.getMonth()/3);o=new Date(a.getFullYear(),c*3,1);const r=new Date(a.getFullYear(),(c+1)*3,0);s.setTime(r.setHours(23,59,59,999));break}case"thisYear":{o=new Date(a.getFullYear(),0,1);const c=new Date(a.getFullYear(),12,0);s.setTime(c.setHours(23,59,59,999));break}case"all":default:o=null,s=null;break}return o&&o.setHours(0,0,0,0),{startDate:o,endDate:s}}function Le(t){const e=_(t);return e==="confirmed"||e==="completed"?!0:(t==null?void 0:t.confirmed)===!0||(t==null?void 0:t.confirmed)==="true"}const ke=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"]]),Bt=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]);function Ce(t=""){const e=String(t).toLowerCase().trim();return e?ke.get(e)||e:""}function J(t){const e=[t==null?void 0:t.paymentStatus,t==null?void 0:t.payment_status,t==null?void 0:t.payment,t==null?void 0:t.paymentState,t==null?void 0:t.payment_state];for(const n of e){const a=String(n||"").toLowerCase().trim();if(a&&Bt.has(a))return Bt.get(a)}return(t==null?void 0:t.paid)===!0||(t==null?void 0:t.paid)==="true"}function _(t){const e=[t==null?void 0:t.status,t==null?void 0:t.reservationStatus,t==null?void 0:t.reservation_status,t==null?void 0:t.state];for(const n of e){const a=Ce(n);if(a)return a==="cancelled"?"pending":a}return Mt(t)?"completed":(t==null?void 0:t.confirmed)===!0||(t==null?void 0:t.confirmed)==="true"?"confirmed":"pending"}function xe(t){const e=t.length,n=t.filter(Le).length,a=t.filter(Mt).length,s=t.filter(J).length,o=t.reduce((r,d)=>r+(Number(d==null?void 0:d.cost)||0),0),c=e?o/e:0;return{total:e,confirmed:n,completed:a,paidCount:s,revenue:o,average:c}}function Me(t){const e=new Date,n=[];for(let a=5;a>=0;a-=1){const s=new Date(e.getFullYear(),e.getMonth()-a,1),o=s.getFullYear(),c=s.getMonth(),r=t.filter(m=>{const u=m!=null&&m.start?new Date(m.start):null;return u&&u.getFullYear()===o&&u.getMonth()===c}),d=r.length,i=r.reduce((m,u)=>m+(Number(u==null?void 0:u.cost)||0),0),f=ve(s);n.push({label:f,count:d,revenue:i})}return n}function qe(t){const e={confirmed:0,pending:0,completed:0};(t||[]).forEach(c=>{const r=_(c);r==="completed"?e.completed+=1:r==="confirmed"?e.confirmed+=1:e.pending+=1});const n=Math.max(1,(t||[]).length),a=e.confirmed,s=e.pending,o=e.completed;return[{label:b("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:a,percent:Math.round(a/n*100)||0,rawCount:a,className:"status-confirmed"},{label:b("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:s,percent:Math.round(s/n*100)||0,rawCount:s,className:"status-pending"},{label:b("reservations.reports.status.completedLabel","منتهية","Completed"),value:o,percent:Math.round(o/n*100)||0,rawCount:o,className:"status-completed"}]}function De(t){const e=t.length||1,n=t.filter(J).length,a=t.length-n;return[{label:b("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:n,percent:Math.round(n/e*100)||0,rawCount:n,className:"status-paid"},{label:b("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:a,percent:Math.round(a/e*100)||0,rawCount:a,className:"status-unpaid"}]}function Ne(t,e){const n=new Map,a=new Map((e||[]).map(s=>[String(s.id),s]));return t.forEach(s=>{const o=String((s==null?void 0:s.customerId)??"unknown"),c=n.get(o)||{count:0,revenue:0};c.count+=1,c.revenue+=Number(s==null?void 0:s.cost)||0,n.set(o,c)}),Array.from(n.entries()).map(([s,o])=>{const c=a.get(s);return{name:(c==null?void 0:c.customerName)||b("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:o.count,revenue:o.revenue}}).sort((s,o)=>o.revenue-s.revenue).slice(0,5)}function Ae(t,e){const n=new Map,a=new Map((e||[]).map(s=>[Q(s==null?void 0:s.barcode),s]));return t.forEach(s=>{((s==null?void 0:s.items)||[]).forEach(o=>{var u,y;const c=Q(o==null?void 0:o.barcode),r=c||((o==null?void 0:o.desc)??"unknown"),d=(o==null?void 0:o.desc)||((u=a.get(c))==null?void 0:u.desc)||((y=a.get(c))==null?void 0:y.description)||b("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment"),i=Number(o==null?void 0:o.qty)||1,f=i*(Number(o==null?void 0:o.price)||0),m=n.get(r)||{name:d,count:0,revenue:0};m.name=d,m.count+=i,m.revenue+=f,n.set(r,m)})}),Array.from(n.values()).sort((s,o)=>o.count-s.count).slice(0,5)}function Re(t,e,n){const a=document.getElementById("reports-reservations-body");if(!a)return;if(!t||t.length===0){a.innerHTML=`<tr><td colspan="6" class="text-muted">${b("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}const s=new Map((e||[]).map(r=>[String(r.id),r])),o=new Map((n||[]).map(r=>[String(r.id),r])),c=[...t].sort((r,d)=>new Date(d.start||0)-new Date(r.start||0)).slice(0,20).map(r=>je(r,s,o));a.innerHTML=c.map(r=>`
      <tr>
        <td>${r.code}</td>
        <td>${r.customer}</td>
        <td>${r.date}</td>
        <td>${r.status}</td>
        <td>${r.payment}</td>
        <td>${r.total}</td>
      </tr>
    `).join("")}function Fe(t){const e=document.getElementById("reports-volume-chart");if(!e)return;if(!t||t.length===0){e.innerHTML=`<p class="text-muted">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const n=Math.max(1,...t.map(a=>a.count));e.innerHTML=t.map(a=>`
        <div class="reports-chart-bar">
          <div class="bar" style="height: ${Math.max(8,Math.round(a.count/n*100))}%"></div>
          <span class="value">${L(a.count)}</span>
          <span class="label">${a.label}</span>
        </div>
      `).join("")}function Tt(t,e){const n=document.getElementById(t);if(n){if(!e||e.length===0){n.innerHTML=`<p class="text-muted">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}n.innerHTML=e.map(a=>`
      <div class="reports-progress-row">
        <div class="reports-progress-top">
          <span>${a.label}</span>
          <span>${L(a.percent)}%</span>
        </div>
        <div class="reports-progress-bar">
          <div class="reports-progress-fill ${a.className}" style="width: ${Math.min(a.percent,100)}%"></div>
        </div>
        <div class="reports-progress-meta">${b("reservations.reports.progress.meta","{count} حجز","{count} reservations").replace("{count}",L(a.rawCount??a.value))}</div>
      </div>
    `).join("")}}function He(t){const e=document.getElementById("reports-top-customers");if(e){if(!t||t.length===0){e.innerHTML=`<tr><td colspan="3" class="text-muted">${b("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}e.innerHTML=t.map(n=>`
      <tr>
        <td>${n.name}</td>
        <td>${L(n.count)}</td>
        <td>${O(n.revenue)}</td>
      </tr>
    `).join("")}}function Pe(t){const e=document.getElementById("reports-top-equipment");if(e){if(!t||t.length===0){e.innerHTML=`<tr><td colspan="3" class="text-muted">${b("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}e.innerHTML=t.map(n=>`
      <tr>
        <td>${n.name}</td>
        <td>${L(n.count)}</td>
        <td>${O(n.revenue)}</td>
      </tr>
    `).join("")}}function je(t,e,n){const a=(t==null?void 0:t.reservationId)||(t==null?void 0:t.id)||"—",s=e.get(String(t==null?void 0:t.customerId)),o=(s==null?void 0:s.customerName)||b("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),c=Ve(t==null?void 0:t.start),r=Oe(t),d=Rt(t),i=O((t==null?void 0:t.cost)||0),f=((t==null?void 0:t.technicians)||[]).map(v=>{var I;return(I=n.get(String(v)))==null?void 0:I.name}).filter(Boolean),m=b("reservations.list.crew.separator","، ",", "),u=f.map(v=>w(v)).join(w(m)),y=f.length?`${w(o)}<br><small class="text-muted">${u}</small>`:w(o);return{code:w(a),customer:y,date:w(c),status:w(r),payment:w(d),total:w(i)}}function Rt(t){return J(t)?b("reservations.reports.payment.paidLabel","مدفوعة","Paid"):b("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}function Oe(t){const e=_(t);return e==="completed"?b("reservations.list.status.completed","📁 منتهي","Completed"):e==="confirmed"?b("reservations.list.status.confirmed","✅ مؤكد","Confirmed"):e==="pending"?b("reservations.list.status.pending","⏳ غير مؤكد","Pending"):w(e)}function Ve(t){if(!t)return"—";const e=new Date(t);if(Number.isNaN(e.getTime()))return"—";const n=pt(),a=new Intl.DateTimeFormat(n,{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return g(a.format(e))}function Ye(t){const e=document.getElementById("reports-kpi-total"),n=document.getElementById("reports-kpi-total-meta"),a=document.getElementById("reports-kpi-revenue"),s=document.getElementById("reports-kpi-revenue-meta"),o=document.getElementById("reports-kpi-confirmed"),c=document.getElementById("reports-kpi-confirmed-meta"),r=document.getElementById("reports-kpi-paid"),d=document.getElementById("reports-kpi-paid-meta"),i=t.total||0,f=t.revenue||0,m=t.confirmed||0,u=t.paidCount||0,y=t.average||0,v=i?Math.round(m/i*100):0,I=i?Math.round(u/i*100):0;if(e&&(e.textContent=L(i)),n){const E=b("reservations.reports.kpi.total.dynamicMeta","منها {count} منتهية","Includes {count} completed").replace("{count}",L(t.completed||0));n.textContent=E}if(a&&(a.textContent=O(f)),s){const E=b("reservations.reports.kpi.revenue.average","متوسط قيمة الحجز {value}","Average reservation value {value}").replace("{value}",O(y));s.textContent=E}if(o&&(o.textContent=`${v}%`),c){const E=b("reservations.reports.kpi.confirmed.detail","{count} حجوزات مؤكدة","{count} confirmed reservations").replace("{count}",L(m));c.textContent=E}if(r&&(r.textContent=`${I}%`),d){const E=b("reservations.reports.kpi.paid.detail","{count} حجوزات مدفوعة","{count} paid reservations").replace("{count}",L(u));d.textContent=E}}function _e(t){const e=document.getElementById("reports-empty-state");e&&e.classList.toggle("active",!!t)}function w(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function L(t){const{numberFormatter:e}=Nt(),n=e.format(Math.round(t||0));return g(n)}function O(t){const{currencyFormatter:e}=Nt(),n=e.format(Math.max(0,Math.round(t||0)));return g(n)}function Q(t){return(t||"").toString().trim()}let V=[],x=[],F=null;function at(){return l("maintenance.form.selectedInfo","لم يتم اختيار معدة بعد.")}function B(t){return g(String(t||"")).trim().toLowerCase()}function Lt(t=""){return g(String(t)).trim().toLowerCase()}function T(){const{maintenance:t=[]}=k();return V=Array.isArray(t)?t:[],V}function ft(t){V=t;try{localStorage.setItem("maintenanceList",JSON.stringify(t))}catch(e){console.warn("⚠️ [maintenance] Failed to persist maintenance tickets",e),h(l("maintenance.toast.storageError","⚠️ تعذر حفظ بيانات الصيانة. يرجى المحاولة مجدداً."))}}function gt(){const{equipment:t=[]}=k(),e=l("maintenance.table.noName","بدون اسم");return x=(t||[]).map(n=>({barcode:B(n==null?void 0:n.barcode),desc:(n==null?void 0:n.desc)||(n==null?void 0:n.description)||(n==null?void 0:n.name)||e,status:(n==null?void 0:n.status)||"متاح",price:Number(n==null?void 0:n.price)||0,category:(n==null?void 0:n.category)||""})),x.sort((n,a)=>n.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),x}function Ft(){return new Set(T().filter(t=>t.status==="open").map(t=>B(t.equipmentBarcode)))}function Z(t){const e=B(t);return e&&(x.length?x:gt()).find(a=>a.barcode===e)||null}function Ue(t){const e=Lt(t);return e&&(x.length?x:gt()).find(a=>Lt(a.desc).includes(e))||null}function ot(t){if(!t)return!0;const e=Ft();return t.status==="صيانة"||e.has(t.barcode)}function C({keepInputs:t=!1,silent:e=!1}={}){const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),s=document.getElementById("maintenance-equipment-search"),o=document.getElementById("maintenance-selected-info");n&&(n.value=""),t||(a&&(a.value=""),s&&(s.value="")),o&&(o.textContent=at()),F=null}function Ht(t){const e=document.getElementById("maintenance-selected-info");if(!e)return;const n=l("maintenance.info.barcodeLabel","باركود"),a=l("maintenance.report.notAvailable","غير متوفر");e.innerHTML=`
    <strong>${t.desc}</strong><br>
    <span class="text-muted">${n}: ${t.barcode||a}</span>
  `}function bt(t,{silent:e=!1}={}){if(!t)return!1;if(ot(t))return e||h(l("maintenance.toast.equipmentBlocked","⚠️ هذه المعدة قيد الصيانة ولا يمكن اختيارها حالياً")),!1;const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),s=document.getElementById("maintenance-equipment-search");return n&&(n.value=t.barcode),a&&(a.value=t.barcode),s&&(s.value=t.desc),Ht(t),F=t,!0}function Pt(t,{showFeedback:e=!0}={}){const n=Z(t);return n?bt(n,{silent:!e}):(e&&h(l("maintenance.toast.equipmentNotFoundBarcode","❌ لم يتم العثور على معدة بهذا الباركود")),!1)}function jt(t,{showFeedback:e=!0}={}){const n=Ue(t);return n?bt(n,{silent:!e}):(e&&h(l("maintenance.toast.equipmentNotFoundName","❌ لم يتم العثور على معدة بالاسم المدخل")),!1)}function yt(){const t=document.getElementById("maintenance-equipment-options"),e=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=gt(),s=Ft();if(t){const c=l("maintenance.form.blockedSuffix","(صيانة)");t.innerHTML=a.map(r=>{const i=r.status==="صيانة"||s.has(r.barcode)?`${r.desc} ${c}`:r.desc,f=r.desc.replace(/"/g,"&quot;"),m=i.replace(/"/g,"&quot;");return`<option value="${f}" label="${m}"></option>`}).join("")}const o=document.getElementById("maintenance-selected-barcode");if(o&&o.value){const c=Z(o.value);!c||ot(c)?(C({keepInputs:!0,silent:!0}),c&&ot(c)&&h(l("maintenance.toast.equipmentBecameBlocked","⚠️ هذه المعدة أصبحت قيد الصيانة ولا يمكن اختيارها"))):bt(c,{silent:!0})}else C({keepInputs:!0,silent:!0});if(e&&!e.dataset.listenerAttached&&(e.addEventListener("keydown",c=>{c.key==="Enter"&&(c.preventDefault(),Pt(e.value)||C({keepInputs:!0,silent:!0}))}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached){const c=()=>{if(!n.value){C({keepInputs:!0,silent:!0});return}jt(n.value)||C({keepInputs:!0,silent:!0})};n.addEventListener("change",c),n.addEventListener("keydown",r=>{r.key==="Enter"&&(r.preventDefault(),c())}),n.dataset.listenerAttached="true"}}function ht(t,e){const n=B(t),{equipment:a=[]}=k(),s=(a||[]).map(o=>B(o==null?void 0:o.barcode)===n?{...o,status:e}:o);xt({equipment:s}),le(),ct(),yt()}function ze(t){const e=document.getElementById("maintenance-stats");if(!e)return;const n=V.length,a=V.filter(i=>i.status==="open").length,s=n-a,o=i=>g(String(i)),c=l("maintenance.stats.open","{count} قيد الصيانة").replace("{count}",`<strong>${o(a)}</strong>`),r=l("maintenance.stats.closed","{count} مغلقة").replace("{count}",`<strong>${o(s)}</strong>`),d=l("maintenance.stats.total","{count} إجمالي التذاكر").replace("{count}",`<strong>${o(n)}</strong>`);e.innerHTML=`
    <span class="maintenance-stat">${c}</span>
    <span class="maintenance-stat">${r}</span>
    <span class="maintenance-stat">${d}</span>
  `}function We(t){const e=document.getElementById("maintenance-table-body"),n=document.getElementById("maintenance-empty-state");if(e){if(!t||t.length===0){const a=l("maintenance.table.emptyFiltered","لا توجد تذاكر ضمن هذا الفلتر.");e.innerHTML=`<tr><td colspan="6" class="text-muted text-center">${a}</td></tr>`,n&&n.classList.add("active");return}n&&n.classList.remove("active"),e.innerHTML=t.map(a=>{const s=l("maintenance.status.open","قيد الصيانة"),o=l("maintenance.status.closed","مغلقة"),c=a.status==="open"?`<span class="badge bg-warning text-dark">${s}</span>`:`<span class="badge bg-success">${o}</span>`,r=(()=>{const U=l("maintenance.priority.high","مرتفعة"),z=l("maintenance.priority.medium","متوسطة"),A=l("maintenance.priority.low","منخفضة");switch(a.priority){case"high":return`<span class="badge bg-danger">${U}</span>`;case"low":return`<span class="badge bg-secondary">${A}</span>`;default:return`<span class="badge bg-info text-dark">${z}</span>`}})(),d=[],i=l("maintenance.actions.close","🔧 إغلاق بعد الإصلاح"),f=l("maintenance.actions.view","👁️ عرض التقرير"),m=l("maintenance.actions.delete","🗑️ حذف التذكرة");a.status==="open"?d.push(`<button class="btn btn-sm btn-success" data-action="close" data-id="${a.id}">${i}</button>`):d.push(`<button class="btn btn-sm btn-warning" data-action="view" data-id="${a.id}">${f}</button>`),d.push(`<button class="btn btn-sm btn-danger" data-action="delete" data-id="${a.id}">${m}</button>`);const u=d.join(""),y=l("maintenance.table.noBarcode","بدون باركود"),v=l("maintenance.report.none","—"),I=a.equipmentBarcode?g(a.equipmentBarcode):y,E=a.issue?g(a.issue):v,S=a.createdAt?g(P(a.createdAt)):"—";return`
        <tr>
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${I}</small>
          </td>
          <td class="maintenance-issue-text">${E}</td>
          <td>${r}</td>
          <td>${S}</td>
          <td>${c}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${u}
            </div>
          </td>
        </tr>
      `}).join("")}}function Ge(t){const e=t.target.closest("button[data-action]");if(!e)return;const n=e.getAttribute("data-action"),a=Number(e.getAttribute("data-id"));a&&(n==="close"?Ot(a):n==="view"?Vt(a):n==="delete"&&Yt(a))}function Ot(t){const e=T(),n=e.findIndex(o=>Number(o.id)===Number(t));if(n===-1)return;const a=prompt(l("maintenance.prompt.closeReport","أدخل تقرير الإصلاح / الإجراءات المتخذة:"));if(a===null)return;const s={...e[n]};s.status="closed",s.resolutionReport=a.trim(),s.resolvedAt=new Date().toISOString(),e[n]=s,ft(e),ht(s.equipmentBarcode,"متاح"),h(l("maintenance.toast.ticketClosed","✅ تم إغلاق تذكرة الصيانة وإعادة المعدة إلى الحالة المتاحة")),q()}function Vt(t){const n=T().find(u=>Number(u.id)===Number(t));if(!n)return;const a=l("maintenance.report.equipment","المعدة"),s=l("maintenance.report.barcode","الباركود"),o=l("maintenance.report.issue","الوصف"),c=l("maintenance.report.createdAt","تاريخ الإنشاء"),r=l("maintenance.report.closedAt","تاريخ الإغلاق"),d=l("maintenance.report.summary","التقرير"),i=l("maintenance.report.notAvailable","غير متوفر"),f=l("maintenance.report.none","—"),m=[`${a}: ${n.equipmentDesc}`,`${s}: ${n.equipmentBarcode?g(n.equipmentBarcode):i}`,`${o}: ${n.issue?g(n.issue):f}`,`${c}: ${n.createdAt?g(P(n.createdAt)):f}`,`${r}: ${n.resolvedAt?g(P(n.resolvedAt)):f}`,`${d}: ${n.resolutionReport?g(n.resolutionReport):f}`].join(`
`);alert(m)}function Yt(t){const e=T(),n=e.findIndex(s=>Number(s.id)===Number(t));if(n===-1)return;const a=e[n];confirm(l("maintenance.toast.ticketDeleteConfirm","⚠️ هل أنت متأكد من حذف تذكرة الصيانة؟"))&&(e.splice(n,1),ft(e),a.status==="open"&&ht(a.equipmentBarcode,"متاح"),h(l("maintenance.toast.ticketDeleted","🗑️ تم حذف تذكرة الصيانة")),q())}function _t(t){t.preventDefault();try{const e=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),s=document.getElementById("maintenance-issue"),o=document.getElementById("maintenance-priority");let c=F,r=B(a==null?void 0:a.value);if(!c&&r&&(c=Z(r)),!c&&(e!=null&&e.value)&&Pt(e.value,{showFeedback:!0})&&(c=F,r=B(c==null?void 0:c.barcode)),!c&&(n!=null&&n.value)&&jt(n.value,{showFeedback:!0})&&(c=F,r=B(c==null?void 0:c.barcode)),!c||!r){h(l("maintenance.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const{equipment:d=[]}=k();let i=(d||[]).find(S=>B(S==null?void 0:S.barcode)===r);if(!i&&c&&(i={barcode:c.barcode,desc:c.desc,name:c.desc,status:c.status||"متاح"}),!i){h(l("maintenance.toast.selectedNotFound","❌ لم يتم العثور على المعدة المختارة")),C();return}if(i.status==="صيانة"){h(l("maintenance.toast.equipmentAlreadyMaintenance","⚠️ هذه المعدة بالفعل في حالة صيانة"));return}if(T().filter(S=>S.status==="open").some(S=>B(S.equipmentBarcode)===r)){h(l("maintenance.toast.ticketExists","⚠️ توجد تذكرة صيانة مفتوحة لهذه المعدة"));return}const u=l("maintenance.table.noName","بدون اسم"),y={id:Date.now(),equipmentBarcode:r,equipmentDesc:i.desc||i.description||i.name||u,issue:(s==null?void 0:s.value.trim())||"",priority:(o==null?void 0:o.value)||"medium",status:"open",createdAt:new Date().toISOString(),resolutionReport:"",resolvedAt:null},v=T(),I=[y,...v];ft(I),ht(r,"صيانة"),h(l("maintenance.toast.ticketCreated","🛠️ تم إنشاء تذكرة الصيانة وإيقاف المعدة")),C(),s&&(s.value=""),o&&(o.value="medium");const E=document.getElementById("maintenance-status-filter");E&&(E.value="all"),q()}catch(e){console.error("❌ [maintenance] Failed to create ticket",e),h(l("maintenance.toast.submitError","⚠️ تعذر إنشاء تذكرة الصيانة. يرجى المحاولة مجدداً."))}}function Ke(t){const e=T();return t==="all"?e:e.filter(n=>n.status===t)}function q(){T(),yt();const t=document.getElementById("maintenance-status-filter");t&&!t.value&&(t.value="all");const e=(t==null?void 0:t.value)||"all",n=Ke(e);ze(),We(n)}function Qe(){T(),yt(),q();const t=document.getElementById("maintenance-form");t&&!t.dataset.listenerAttached&&(t.addEventListener("submit",_t),t.dataset.listenerAttached="true");const e=document.getElementById("maintenance-status-filter");e&&!e.dataset.listenerAttached&&(e.addEventListener("change",()=>{q()}),e.dataset.listenerAttached="true");const n=document.querySelector(".maintenance-table");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",Ge),n.dataset.listenerAttached="true")}T();document.addEventListener("language:changed",()=>{const t=document.getElementById("maintenance-selected-barcode"),e=document.getElementById("maintenance-selected-info");if(t!=null&&t.value){const n=Z(t.value);n?Ht(n):e&&(e.textContent=at())}else e&&(e.textContent=at());q()});document.addEventListener("submit",t=>{const e=t.target;(e==null?void 0:e.id)==="maintenance-form"&&!e.dataset.listenerAttached&&_t(t)});document.addEventListener("click",t=>{const e=t.target.closest("button[data-action]");if(!e||!e.closest(".maintenance-table"))return;const n=e.dataset.action,a=Number(e.dataset.id);a&&(n==="close"?Ot(a):n==="view"?Vt(a):n==="delete"&&Yt(a))});const kt="dashboard-active-tab",st="dashboard-active-sub-tab",H={get(t){try{return localStorage.getItem(t)}catch(e){return console.warn("⚠️ [tabs.js] localStorage.getItem failed",{key:t,error:e}),null}},set(t,e){try{localStorage.setItem(t,e)}catch(n){console.warn("⚠️ [tabs.js] localStorage.setItem failed",{key:t,value:e,error:n})}},remove(t){try{localStorage.removeItem(t)}catch(e){console.warn("⚠️ [tabs.js] localStorage.removeItem failed",{key:t,error:e})}}};function Je(){var c;console.log("🚀 [tabs.js] setupTabs()");const t=document.querySelectorAll("[data-tab]"),e=document.querySelectorAll(".tab");console.log("📌 tabButtons:",t),console.log("📌 tabContents:",e);const n=(r,{skipStore:d=!1}={})=>{if(!r)return;const i=document.querySelector(`[data-tab="${r}"]`),f=document.getElementById(r);!i||!f||(t.forEach(m=>m.classList.remove("active")),i.classList.add("active"),e.forEach(m=>{const u=m.id===r;m.style.display=u?"block":"none",m.classList.toggle("active",u)}),d||H.set(kt,r),r==="customers-tab"&&(console.log("👤 Rendering customers"),D()),r==="equipment-tab"&&(console.log("📦 Rendering equipment"),ct()),r==="maintenance-tab"&&(console.log("🛠️ Rendering maintenance"),q()),r==="technicians-tab"&&(console.log("🛠️ Rendering technicians"),de()),r==="reservations-tab"&&(console.log("📅 Rendering reservations"),rt(),Ze()))};t.forEach(r=>{r.addEventListener("click",()=>{const d=r.getAttribute("data-tab");console.log("🖱️ Tab clicked:",d),n(d),d!=="reservations-tab"&&H.remove(st)})});const a=H.get(kt),s=document.querySelector("[data-tab].active"),o=a&&document.getElementById(a)?a:s==null?void 0:s.getAttribute("data-tab");o&&(console.log("⭐ Initial tab:",o),n(o,{skipStore:!!a})),(c=document.body)==null||c.classList.remove("tabs-loading")}function Ze(){console.log("🚀 [tabs.js] setupSubTabs()");const t=document.querySelectorAll(".sub-tab-button"),e=document.querySelectorAll(".sub-tab");console.log("📌 subTabButtons:",t),console.log("📌 subTabContents:",e);const n=(c,{skipStore:r=!1}={})=>{if(!c)return;const d=document.querySelector(`.sub-tab-button[data-sub-tab="${c}"]`),i=document.getElementById(c);!d||!i||(t.forEach(f=>f.classList.remove("active")),d.classList.add("active"),e.forEach(f=>{f.classList.remove("active")}),i.classList.add("active"),r||H.set(st,c),c==="my-reservations-tab"?(console.log("📋 Rendering reservations list"),setTimeout(()=>{rt()},50)):c==="calendar-tab"?(console.log("📅 Rendering calendar view"),setTimeout(()=>{mt()},100)):c==="reports-tab"&&(console.log("📊 Rendering reports view"),setTimeout(()=>{Se()},50)))};t.forEach(c=>{c.addEventListener("click",()=>{const r=c.getAttribute("data-sub-tab");console.log("🖱️ Sub-tab clicked:",r),n(r)})});const a=H.get(st),s=document.querySelector(".sub-tab-button.active"),o=a&&document.getElementById(a)?a:s==null?void 0:s.getAttribute("data-sub-tab");o&&(console.log("⭐ Initial sub-tab:",o),n(o,{skipStore:!!a})),qt()}ne();function Ct(){var n;ae(),Je(),oe(),ct(),mt(),Qe(),ie(),qt(),rt();const t=document.getElementById("excel-upload");t&&t.addEventListener("change",async a=>{const s=a.target.files&&a.target.files[0];s&&(await ue(s),a.target.value="")});const e=document.getElementById("excel-upload-trigger");e&&t&&e.addEventListener("click",a=>{a.preventDefault(),t.click()}),(n=document.getElementById("logout-btn"))==null||n.addEventListener("click",se),Xe(),tn()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ct,{once:!0}):Ct();function Xe(){document.querySelectorAll('input[type="datetime-local"]').forEach(t=>{t.addEventListener("input",()=>{const e=t.value;if(!e.includes("T"))return;const[n,a]=e.split("T"),[s]=a.split(":"),o=`${s.padStart(2,"0")}:00`,c=`${n}T${o}`;t.value!==c&&(t.value=c,setTimeout(()=>t.blur(),150))})})}function tn(){const t=k(),e=localStorage.getItem("pendingReservationEditId"),n=localStorage.getItem("pendingReservationEdit");let a=null;if(e!==null){const o=(t.reservations||[]).findIndex(c=>String(c.id)===e||String(c.reservationId)===e);o!==-1&&(a=o),localStorage.removeItem("pendingReservationEditId")}if(a===null&&n!==null){const s=Number(n);Number.isNaN(s)||(a=s),localStorage.removeItem("pendingReservationEdit")}a===null||Number.isNaN(a)||setTimeout(()=>{const s=document.querySelector('[data-tab="reservations-tab"]');s==null||s.click(),setTimeout(()=>{var o;(o=document.querySelector('.sub-tab-button[data-sub-tab="create-tab"]'))==null||o.click(),setTimeout(()=>{const c=window.editReservation;typeof c=="function"&&c(a)},150)},150)},150)}
