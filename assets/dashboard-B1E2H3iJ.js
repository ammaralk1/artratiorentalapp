import{t as r,g as A,n as b,f as N,s as h}from"./utils-C0DqWSLe.js";import{l as x,s as Le,i as de,a as Ce,b as Me,r as G,c as Ne,d as K,e as ue,f as De,u as Ae,g as Re}from"./reservationsUI-BwO38w_2.js";import{c as Fe,l as He}from"./auth-BCGpaEK2.js";import{r as je}from"./customers-C-_eQ3rP.js";let H=null,ae=!1;function Pe(e){const n=e.paid===!0||e.paid==="paid",t=e.confirmed===!0||e.confirmed==="true";return e.completed?{background:"#6c757d",border:"#565e64",text:"#fff"}:n?t?{background:"#198754",border:"#146c43",text:"#fff"}:{background:"#ffc107",border:"#cc9a06",text:"#212529"}:{background:"#dc3545",border:"#b02a37",text:"#fff"}}function Oe(e){const{reservationId:n,customerName:t,paid:a,confirmed:s,completed:o}=e.event.extendedProps,c=a===!0||a==="paid",l=s===!0||s==="true",i=document.createElement("div");i.className="fc-reservation-event";const d=l?r("calendar.badges.confirmed","مؤكد"):r("calendar.badges.pending","غير مؤكد"),f=c?r("calendar.badges.paid","مدفوع"):r("calendar.badges.unpaid","غير مدفوع"),m=r("calendar.badges.completed","منتهي"),u=r("calendar.labels.unknownCustomer","غير معروف");return i.innerHTML=`
    <div class="fc-reservation-id">${n}</div>
    <div class="fc-reservation-customer">${t||u}</div>
    <div class="fc-reservation-tags">
      <span class="badge ${l?"bg-success":"bg-warning text-dark"}">${d}</span>
      <span class="badge ${c?"bg-primary":"bg-danger"}">${f}</span>
      ${o?`<span class="badge bg-secondary">${m}</span>`:""}
    </div>
  `,{domNodes:[i]}}function Ye(e){var te;const n=document.getElementById("calendar-reservation-details");if(!n){alert(r("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"));return}const t=e.confirmed===!0||e.confirmed==="true",a=e.paid===!0||e.paid==="paid",s=!!e.completed,o=t?r("calendar.badges.confirmed","مؤكد"):r("calendar.badges.pending","غير مؤكد"),c=a?r("calendar.badges.paid","مدفوع"):r("calendar.badges.unpaid","غير مدفوع"),l=r("calendar.badges.completed","منتهي"),i=A(),d=e.items||[],f=Le()||[],m=new Map(f.map(p=>[String(p.id),p])),u=(e.technicians||[]).map(p=>m.get(String(p))).filter(Boolean),y=d.reduce((p,w)=>p+(w.qty||1)*(w.price||0),0),I=(()=>{const p=parseFloat(e.discount)||0;return p?e.discountType==="amount"?p:y*(p/100):0})(),q=Math.max(0,y-I),g=e.applyTax?q*.15:0,E=e.cost??Math.round(q+g),F=r("calendar.labels.currencySuffix","ريال"),O=d.length?d.map((p,w)=>{const ne=p.image||p.imageUrl||p.img||"",we=b(String(p.barcode||"-")),Se=b(String(p.qty||1)),Te=b(String(p.price||0)),xe=ne?`<img src="${ne}" alt="${p.desc||""}" class="reservation-modal-item-thumb">`:"-";return`
          <tr>
            <td>${b(String(w+1))}</td>
            <td>${we}</td>
            <td>${p.desc||"-"}</td>
            <td>${Se}</td>
            <td>${Te} ${F}</td>
            <td>${xe}</td>
          </tr>
        `}).join(""):`<tr><td colspan="6" class="text-center">${r("calendar.labels.noEquipment","لا توجد معدات")}</td></tr>`,L=[`<div>${r("calendar.summary.baseCost","💵 إجمالي المعدات: <strong>{value} ريال</strong>").replace("{value}",y.toFixed(2))}</div>`];if(I>0){const p=i==="en"?"%":"٪",w=e.discountType==="percent"?`${parseFloat(e.discount||0).toFixed(2)}${p}`:`${I.toFixed(2)} ${F}`;L.push(`<div>${r("calendar.summary.discount","💸 الخصم: <strong>{value}</strong>").replace("{value}",w)}</div>`)}e.applyTax&&g>0&&L.push(`<div>${r("calendar.summary.tax","🧾 الضريبة (15%): <strong>{value} ريال</strong>").replace("{value}",g.toFixed(2))}</div>`),L.push(`<div>${r("calendar.summary.total","💰 المجموع النهائي: <strong>{value} ريال</strong>").replace("{value}",E.toFixed(2))}</div>`);const Ee=b(String(e.reservationId??e.id??"")),$e=e.start?b(N(e.start)):"-",Ie=e.end?b(N(e.end)):"-",ke=e.notes?b(e.notes):r("calendar.labels.noNotes","لا توجد ملاحظات"),Be=e.customerName||r("calendar.labels.unknownCustomer","غير معروف"),qe=[{icon:"🆔",label:r("calendar.labels.reservationId","رقم الحجز"),value:Ee},{icon:"👤",label:r("calendar.labels.customer","العميل"),value:Be},{icon:"🗓️",label:r("calendar.labels.start","بداية الحجز"),value:$e},{icon:"🗓️",label:r("calendar.labels.end","نهاية الحجز"),value:Ie},{icon:"📝",label:r("calendar.labels.notes","الملاحظات"),value:ke}];n.innerHTML=`
    <div class="calendar-reservation-status mb-3">
      <span class="badge ${t?"bg-success":"bg-warning text-dark"}">${o}</span>
      <span class="badge ${a?"bg-primary":"bg-danger"}">${c}</span>
      ${s?`<span class="badge bg-secondary">${l}</span>`:""}
    </div>
    <div class="calendar-reservation-info">
      ${qe.map(p=>`
        <div class="calendar-info-row">
          <span class="label">${p.icon} ${p.label}</span>
          <span class="value">${p.value}</span>
        </div>
      `).join("")}
    </div>
    <h6 class="calendar-section-title">${r("calendar.sections.crew","😎 الفريق الفني")}</h6>
    ${u.length?`<ul class="list-unstyled calendar-reservation-technicians">${u.map(p=>{const w=p.role?` — ${p.role}`:"";return`<li><strong>${p.name}</strong>${w}</li>`}).join("")}</ul>`:`<p class="calendar-empty-state">${r("calendar.emptyStates.noCrew","😎 لا يوجد فريق مرتبط بهذا الحجز.")}</p>`}
    <h6 class="calendar-section-title">${r("calendar.sections.equipment","📦 المعدات")}</h6>
    <div class="table-responsive reservation-modal-items-wrapper">
      <table class="table table-sm table-hover align-middle reservation-modal-items-table">
        <thead>
          <tr>
            <th>#</th>
            <th>${r("calendar.table.headers.barcode","الباركود")}</th>
            <th>${r("calendar.table.headers.description","الوصف")}</th>
            <th>${r("calendar.table.headers.quantity","الكمية")}</th>
            <th>${r("calendar.table.headers.price","السعر")}</th>
            <th>${r("calendar.table.headers.image","الصورة")}</th>
          </tr>
        </thead>
        <tbody>${O}</tbody>
      </table>
    </div>
    <div class="calendar-reservation-summary">
      ${L.join("")}
    </div>
  `;const ee=document.getElementById("calendarReservationModal");ee&&((te=window.bootstrap)!=null&&te.Modal)?window.bootstrap.Modal.getOrCreateInstance(ee).show():alert(r("calendar.alerts.cannotOpenModal","لا يمكن فتح نافذة التفاصيل"))}function W(){console.log("✅ renderCalendar تعمل");const e=document.getElementById("calendar");if(!e)return;H&&(H.destroy(),H=null);const{reservations:n=[],customers:t=[]}=x(),a=n.map(o=>{const c=t.find(d=>String(d.id)===String(o.customerId)),l=o.end?new Date(o.end)<new Date:!1,i=Pe({...o,completed:l});return{id:o.id,title:"",start:o.start,end:o.end,backgroundColor:i.background,borderColor:i.border,textColor:i.text,display:"auto",extendedProps:{...o,customerName:(c==null?void 0:c.customerName)||r("calendar.labels.unknownCustomer","غير معروف"),completed:l}}}),s=new FullCalendar.Calendar(e,{initialView:"dayGridMonth",locale:A(),timeZone:"local",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},buttonText:{today:r("calendar.buttons.today","اليوم"),month:r("calendar.buttons.month","شهر"),week:r("calendar.buttons.week","أسبوع"),day:r("calendar.buttons.day","يوم")},events:a,eventContent:Oe,eventClick:function(o){Ye(o.event.extendedProps)}});s.render(),H=s,ae||(document.addEventListener("language:changed",()=>{W()}),ae=!0)}let oe=null,Y=null,U=null;const Ue={range:"last30",start:null,end:null};function v(e,n,t=n){const a=A()==="en"?t??n:n;return r(e,a)}function me(){return(A()||"ar").toLowerCase().startsWith("ar")?"ar-SA":"en-US"}function pe(){const e=A();if(e!==oe||!Y||!U){oe=e;const n=me();Y=new Intl.NumberFormat(n,{maximumFractionDigits:0}),U=new Intl.NumberFormat(n,{style:"currency",currency:"SAR",maximumFractionDigits:0})}return{numberFormatter:Y,currencyFormatter:U}}function ze(e){const n=me();return new Intl.DateTimeFormat(n,{month:"short"}).format(e)}function Ve(){const{reservations:e=[],customers:n=[],equipment:t=[]}=x(),a=_e(e,Ue),s=Ke(a),o=We(a),c=Je(a),l=Qe(a),i=Ze(a,n),d=Xe(a,t);at(s),et(o),se("reports-status-breakdown",c),se("reports-payment-breakdown",l),tt(i),nt(d),ot(a.length===0)}function _e(e,n){const{startDate:t,endDate:a}=Ge(n);return(e||[]).filter(s=>{const o=s!=null&&s.start?new Date(s.start):null;return!(!o||Number.isNaN(o.getTime())||t&&o<t||a&&o>a)})}function Ge({range:e,start:n,end:t}){const a=new Date;a.setHours(23,59,59,999);const s=new Date(a);let o=null;switch(e){case"last30":{o=new Date(a),o.setDate(o.getDate()-29);break}case"thisMonth":{o=new Date(a.getFullYear(),a.getMonth(),1);break}case"thisQuarter":{const c=Math.floor(a.getMonth()/3);o=new Date(a.getFullYear(),c*3,1);break}case"thisYear":{o=new Date(a.getFullYear(),0,1);break}case"all":default:o=null;break}return o&&o.setHours(0,0,0,0),{startDate:o,endDate:s}}function fe(e){return(e==null?void 0:e.confirmed)===!0||(e==null?void 0:e.confirmed)==="true"}function Ke(e){const n=e.length,t=e.filter(fe).length,a=e.filter(de).length,s=e.filter(l=>l==null?void 0:l.paid).length,o=e.reduce((l,i)=>l+(Number(i==null?void 0:i.cost)||0),0),c=n?o/n:0;return{total:n,confirmed:t,completed:a,paidCount:s,revenue:o,average:c}}function We(e){const n=new Date,t=[];for(let a=5;a>=0;a-=1){const s=new Date(n.getFullYear(),n.getMonth()-a,1),o=s.getFullYear(),c=s.getMonth(),l=e.filter(m=>{const u=m!=null&&m.start?new Date(m.start):null;return u&&u.getFullYear()===o&&u.getMonth()===c}),i=l.length,d=l.reduce((m,u)=>m+(Number(u==null?void 0:u.cost)||0),0),f=ze(s);t.push({label:f,count:i,revenue:d})}return t}function Je(e){const n=e.length||1,t=e.filter(fe).length,a=e.length-t,s=e.filter(de).length;return[{label:v("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:t,percent:Math.round(t/n*100)||0,rawCount:t,className:"status-confirmed"},{label:v("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:a,percent:Math.round(a/n*100)||0,rawCount:a,className:"status-pending"},{label:v("reservations.reports.status.completedLabel","منتهية","Completed"),value:s,percent:Math.round(s/n*100)||0,rawCount:s,className:"status-completed"}]}function Qe(e){const n=e.length||1,t=e.filter(s=>s==null?void 0:s.paid).length,a=e.length-t;return[{label:v("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:t,percent:Math.round(t/n*100)||0,rawCount:t,className:"status-paid"},{label:v("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:a,percent:Math.round(a/n*100)||0,rawCount:a,className:"status-unpaid"}]}function Ze(e,n){const t=new Map,a=new Map((n||[]).map(s=>[String(s.id),s]));return e.forEach(s=>{const o=String((s==null?void 0:s.customerId)??"unknown"),c=t.get(o)||{count:0,revenue:0};c.count+=1,c.revenue+=Number(s==null?void 0:s.cost)||0,t.set(o,c)}),Array.from(t.entries()).map(([s,o])=>{const c=a.get(s);return{name:(c==null?void 0:c.customerName)||v("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:o.count,revenue:o.revenue}}).sort((s,o)=>o.revenue-s.revenue).slice(0,5)}function Xe(e,n){const t=new Map,a=new Map((n||[]).map(s=>[ce(s==null?void 0:s.barcode),s]));return e.forEach(s=>{((s==null?void 0:s.items)||[]).forEach(o=>{var u,y;const c=ce(o==null?void 0:o.barcode),l=c||((o==null?void 0:o.desc)??"unknown"),i=(o==null?void 0:o.desc)||((u=a.get(c))==null?void 0:u.desc)||((y=a.get(c))==null?void 0:y.description)||v("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment"),d=Number(o==null?void 0:o.qty)||1,f=d*(Number(o==null?void 0:o.price)||0),m=t.get(l)||{name:i,count:0,revenue:0};m.name=i,m.count+=d,m.revenue+=f,t.set(l,m)})}),Array.from(t.values()).sort((s,o)=>o.count-s.count).slice(0,5)}function et(e){const n=document.getElementById("reports-volume-chart");if(!n)return;if(!e||e.length===0){n.innerHTML=`<p class="text-muted">${v("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const t=Math.max(1,...e.map(a=>a.count));n.innerHTML=e.map(a=>`
        <div class="reports-chart-bar">
          <div class="bar" style="height: ${Math.max(8,Math.round(a.count/t*100))}%"></div>
          <span class="value">${k(a.count)}</span>
          <span class="label">${a.label}</span>
        </div>
      `).join("")}function se(e,n){const t=document.getElementById(e);if(t){if(!n||n.length===0){t.innerHTML=`<p class="text-muted">${v("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}t.innerHTML=n.map(a=>`
      <div class="reports-progress-row">
        <div class="reports-progress-top">
          <span>${a.label}</span>
          <span>${k(a.percent)}%</span>
        </div>
        <div class="reports-progress-bar">
          <div class="reports-progress-fill ${a.className}" style="width: ${Math.min(a.percent,100)}%"></div>
        </div>
        <div class="reports-progress-meta">${v("reservations.reports.progress.meta","{count} حجز","{count} reservations").replace("{count}",k(a.rawCount??a.value))}</div>
      </div>
    `).join("")}}function tt(e){const n=document.getElementById("reports-top-customers");if(n){if(!e||e.length===0){n.innerHTML=`<tr><td colspan="3" class="text-muted">${v("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}n.innerHTML=e.map(t=>`
      <tr>
        <td>${t.name}</td>
        <td>${k(t.count)}</td>
        <td>${j(t.revenue)}</td>
      </tr>
    `).join("")}}function nt(e){const n=document.getElementById("reports-top-equipment");if(n){if(!e||e.length===0){n.innerHTML=`<tr><td colspan="3" class="text-muted">${v("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}n.innerHTML=e.map(t=>`
      <tr>
        <td>${t.name}</td>
        <td>${k(t.count)}</td>
        <td>${j(t.revenue)}</td>
      </tr>
    `).join("")}}function at(e){const n=document.getElementById("reports-kpi-total"),t=document.getElementById("reports-kpi-total-meta"),a=document.getElementById("reports-kpi-revenue"),s=document.getElementById("reports-kpi-revenue-meta"),o=document.getElementById("reports-kpi-confirmed"),c=document.getElementById("reports-kpi-confirmed-meta"),l=document.getElementById("reports-kpi-paid"),i=document.getElementById("reports-kpi-paid-meta"),d=e.total||0,f=e.revenue||0,m=e.confirmed||0,u=e.paidCount||0,y=e.average||0,I=d?Math.round(m/d*100):0,q=d?Math.round(u/d*100):0;if(n&&(n.textContent=k(d)),t){const g=v("reservations.reports.kpi.total.dynamicMeta","منها {count} منتهية","Includes {count} completed").replace("{count}",k(e.completed||0));t.textContent=g}if(a&&(a.textContent=j(f)),s){const g=v("reservations.reports.kpi.revenue.average","متوسط قيمة الحجز {value}","Average reservation value {value}").replace("{value}",j(y));s.textContent=g}if(o&&(o.textContent=`${I}%`),c){const g=v("reservations.reports.kpi.confirmed.detail","{count} حجوزات مؤكدة","{count} confirmed reservations").replace("{count}",k(m));c.textContent=g}if(l&&(l.textContent=`${q}%`),i){const g=v("reservations.reports.kpi.paid.detail","{count} حجوزات مدفوعة","{count} paid reservations").replace("{count}",k(u));i.textContent=g}}function ot(e){const n=document.getElementById("reports-empty-state");n&&n.classList.toggle("active",!!e)}function k(e){const{numberFormatter:n}=pe(),t=n.format(Math.round(e||0));return b(t)}function j(e){const{currencyFormatter:n}=pe(),t=n.format(Math.max(0,Math.round(e||0)));return b(t)}function ce(e){return(e||"").toString().trim()}let D=[],T=[],C=null;function z(){return r("maintenance.form.selectedInfo","لم يتم اختيار معدة بعد.")}function $(e){return b(String(e||"")).trim().toLowerCase()}function re(e=""){return b(String(e)).trim().toLowerCase()}function B(){const{maintenance:e=[]}=x();return D=Array.isArray(e)?e:[],D}function J(e){D=e;try{localStorage.setItem("maintenanceList",JSON.stringify(e))}catch(n){console.warn("⚠️ [maintenance] Failed to persist maintenance tickets",n),h(r("maintenance.toast.storageError","⚠️ تعذر حفظ بيانات الصيانة. يرجى المحاولة مجدداً."))}}function Q(){const{equipment:e=[]}=x(),n=r("maintenance.table.noName","بدون اسم");return T=(e||[]).map(t=>({barcode:$(t==null?void 0:t.barcode),desc:(t==null?void 0:t.desc)||(t==null?void 0:t.description)||(t==null?void 0:t.name)||n,status:(t==null?void 0:t.status)||"متاح",price:Number(t==null?void 0:t.price)||0,category:(t==null?void 0:t.category)||""})),T.sort((t,a)=>t.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),T}function be(){return new Set(B().filter(e=>e.status==="open").map(e=>$(e.equipmentBarcode)))}function P(e){const n=$(e);return n&&(T.length?T:Q()).find(a=>a.barcode===n)||null}function st(e){const n=re(e);return n&&(T.length?T:Q()).find(a=>re(a.desc).includes(n))||null}function V(e){if(!e)return!0;const n=be();return e.status==="صيانة"||n.has(e.barcode)}function S({keepInputs:e=!1,silent:n=!1}={}){const t=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),s=document.getElementById("maintenance-equipment-search"),o=document.getElementById("maintenance-selected-info");t&&(t.value=""),e||(a&&(a.value=""),s&&(s.value="")),o&&(o.textContent=z()),C=null}function ge(e){const n=document.getElementById("maintenance-selected-info");if(!n)return;const t=r("maintenance.info.barcodeLabel","باركود"),a=r("maintenance.report.notAvailable","غير متوفر");n.innerHTML=`
    <strong>${e.desc}</strong><br>
    <span class="text-muted">${t}: ${e.barcode||a}</span>
  `}function Z(e,{silent:n=!1}={}){if(!e)return!1;if(V(e))return n||h(r("maintenance.toast.equipmentBlocked","⚠️ هذه المعدة قيد الصيانة ولا يمكن اختيارها حالياً")),!1;const t=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),s=document.getElementById("maintenance-equipment-search");return t&&(t.value=e.barcode),a&&(a.value=e.barcode),s&&(s.value=e.desc),ge(e),C=e,!0}function ve(e,{showFeedback:n=!0}={}){const t=P(e);return t?Z(t,{silent:!n}):(n&&h(r("maintenance.toast.equipmentNotFoundBarcode","❌ لم يتم العثور على معدة بهذا الباركود")),!1)}function ye(e,{showFeedback:n=!0}={}){const t=st(e);return t?Z(t,{silent:!n}):(n&&h(r("maintenance.toast.equipmentNotFoundName","❌ لم يتم العثور على معدة بالاسم المدخل")),!1)}function he(){const e=document.getElementById("maintenance-equipment-options"),n=document.getElementById("maintenance-equipment-barcode"),t=document.getElementById("maintenance-equipment-search"),a=Q(),s=be();if(e){const c=r("maintenance.form.blockedSuffix","(صيانة)");e.innerHTML=a.map(l=>{const d=l.status==="صيانة"||s.has(l.barcode)?`${l.desc} ${c}`:l.desc,f=l.desc.replace(/"/g,"&quot;"),m=d.replace(/"/g,"&quot;");return`<option value="${f}" label="${m}"></option>`}).join("")}const o=document.getElementById("maintenance-selected-barcode");if(o&&o.value){const c=P(o.value);!c||V(c)?(S({keepInputs:!0,silent:!0}),c&&V(c)&&h(r("maintenance.toast.equipmentBecameBlocked","⚠️ هذه المعدة أصبحت قيد الصيانة ولا يمكن اختيارها"))):Z(c,{silent:!0})}else S({keepInputs:!0,silent:!0});if(n&&!n.dataset.listenerAttached&&(n.addEventListener("keydown",c=>{c.key==="Enter"&&(c.preventDefault(),ve(n.value)||S({keepInputs:!0,silent:!0}))}),n.dataset.listenerAttached="true"),t&&!t.dataset.listenerAttached){const c=()=>{if(!t.value){S({keepInputs:!0,silent:!0});return}ye(t.value)||S({keepInputs:!0,silent:!0})};t.addEventListener("change",c),t.addEventListener("keydown",l=>{l.key==="Enter"&&(l.preventDefault(),c())}),t.dataset.listenerAttached="true"}}function X(e,n){const t=$(e),{equipment:a=[]}=x(),s=(a||[]).map(o=>$(o==null?void 0:o.barcode)===t?{...o,status:n}:o);Ce({equipment:s}),Me(),G(),he()}function ct(e){const n=document.getElementById("maintenance-stats");if(!n)return;const t=D.length,a=D.filter(d=>d.status==="open").length,s=t-a,o=d=>b(String(d)),c=r("maintenance.stats.open","{count} قيد الصيانة").replace("{count}",`<strong>${o(a)}</strong>`),l=r("maintenance.stats.closed","{count} مغلقة").replace("{count}",`<strong>${o(s)}</strong>`),i=r("maintenance.stats.total","{count} إجمالي التذاكر").replace("{count}",`<strong>${o(t)}</strong>`);n.innerHTML=`
    <span class="maintenance-stat">${c}</span>
    <span class="maintenance-stat">${l}</span>
    <span class="maintenance-stat">${i}</span>
  `}function rt(e){const n=document.getElementById("maintenance-table-body"),t=document.getElementById("maintenance-empty-state");if(n){if(!e||e.length===0){const a=r("maintenance.table.emptyFiltered","لا توجد تذاكر ضمن هذا الفلتر.");n.innerHTML=`<tr><td colspan="6" class="text-muted text-center">${a}</td></tr>`,t&&t.classList.add("active");return}t&&t.classList.remove("active"),n.innerHTML=e.map(a=>{const s=r("maintenance.status.open","قيد الصيانة"),o=r("maintenance.status.closed","مغلقة"),c=a.status==="open"?`<span class="badge bg-warning text-dark">${s}</span>`:`<span class="badge bg-success">${o}</span>`,l=(()=>{const F=r("maintenance.priority.high","مرتفعة"),O=r("maintenance.priority.medium","متوسطة"),L=r("maintenance.priority.low","منخفضة");switch(a.priority){case"high":return`<span class="badge bg-danger">${F}</span>`;case"low":return`<span class="badge bg-secondary">${L}</span>`;default:return`<span class="badge bg-info text-dark">${O}</span>`}})(),i=[],d=r("maintenance.actions.close","🔧 إغلاق بعد الإصلاح"),f=r("maintenance.actions.view","👁️ عرض التقرير"),m=r("maintenance.actions.delete","🗑️ حذف التذكرة");a.status==="open"?i.push(`<button class="btn btn-sm btn-success" data-action="close" data-id="${a.id}">${d}</button>`):i.push(`<button class="btn btn-sm btn-warning" data-action="view" data-id="${a.id}">${f}</button>`),i.push(`<button class="btn btn-sm btn-danger" data-action="delete" data-id="${a.id}">${m}</button>`);const u=i.join(""),y=r("maintenance.table.noBarcode","بدون باركود"),I=r("maintenance.report.none","—"),q=a.equipmentBarcode?b(a.equipmentBarcode):y,g=a.issue?b(a.issue):I,E=a.createdAt?b(N(a.createdAt)):"—";return`
        <tr>
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${q}</small>
          </td>
          <td class="maintenance-issue-text">${g}</td>
          <td>${l}</td>
          <td>${E}</td>
          <td>${c}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${u}
            </div>
          </td>
        </tr>
      `}).join("")}}function lt(e){const n=B(),t=n.findIndex(o=>Number(o.id)===Number(e));if(t===-1)return;const a=prompt(r("maintenance.prompt.closeReport","أدخل تقرير الإصلاح / الإجراءات المتخذة:"));if(a===null)return;const s={...n[t]};s.status="closed",s.resolutionReport=a.trim(),s.resolvedAt=new Date().toISOString(),n[t]=s,J(n),X(s.equipmentBarcode,"متاح"),h(r("maintenance.toast.ticketClosed","✅ تم إغلاق تذكرة الصيانة وإعادة المعدة إلى الحالة المتاحة")),R()}function it(e){const t=B().find(u=>Number(u.id)===Number(e));if(!t)return;const a=r("maintenance.report.equipment","المعدة"),s=r("maintenance.report.barcode","الباركود"),o=r("maintenance.report.issue","الوصف"),c=r("maintenance.report.createdAt","تاريخ الإنشاء"),l=r("maintenance.report.closedAt","تاريخ الإغلاق"),i=r("maintenance.report.summary","التقرير"),d=r("maintenance.report.notAvailable","غير متوفر"),f=r("maintenance.report.none","—"),m=[`${a}: ${t.equipmentDesc}`,`${s}: ${t.equipmentBarcode?b(t.equipmentBarcode):d}`,`${o}: ${t.issue?b(t.issue):f}`,`${c}: ${t.createdAt?b(N(t.createdAt)):f}`,`${l}: ${t.resolvedAt?b(N(t.resolvedAt)):f}`,`${i}: ${t.resolutionReport?b(t.resolutionReport):f}`].join(`
`);alert(m)}function dt(e){const n=B(),t=n.findIndex(s=>Number(s.id)===Number(e));if(t===-1)return;const a=n[t];confirm(r("maintenance.toast.ticketDeleteConfirm","⚠️ هل أنت متأكد من حذف تذكرة الصيانة؟"))&&(n.splice(t,1),J(n),a.status==="open"&&X(a.equipmentBarcode,"متاح"),h(r("maintenance.toast.ticketDeleted","🗑️ تم حذف تذكرة الصيانة")),R())}function ut(e){e.preventDefault();try{const n=document.getElementById("maintenance-equipment-barcode"),t=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),s=document.getElementById("maintenance-issue"),o=document.getElementById("maintenance-priority");let c=C,l=$(a==null?void 0:a.value);if(!c&&l&&(c=P(l)),!c&&(n!=null&&n.value)&&ve(n.value,{showFeedback:!0})&&(c=C,l=$(c==null?void 0:c.barcode)),!c&&(t!=null&&t.value)&&ye(t.value,{showFeedback:!0})&&(c=C,l=$(c==null?void 0:c.barcode)),!c||!l){h(r("maintenance.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const{equipment:i=[]}=x();let d=(i||[]).find(E=>$(E==null?void 0:E.barcode)===l);if(!d&&c&&(d={barcode:c.barcode,desc:c.desc,name:c.desc,status:c.status||"متاح"}),!d){h(r("maintenance.toast.selectedNotFound","❌ لم يتم العثور على المعدة المختارة")),S();return}if(d.status==="صيانة"){h(r("maintenance.toast.equipmentAlreadyMaintenance","⚠️ هذه المعدة بالفعل في حالة صيانة"));return}if(B().filter(E=>E.status==="open").some(E=>$(E.equipmentBarcode)===l)){h(r("maintenance.toast.ticketExists","⚠️ توجد تذكرة صيانة مفتوحة لهذه المعدة"));return}const u=r("maintenance.table.noName","بدون اسم"),y={id:Date.now(),equipmentBarcode:l,equipmentDesc:d.desc||d.description||d.name||u,issue:(s==null?void 0:s.value.trim())||"",priority:(o==null?void 0:o.value)||"medium",status:"open",createdAt:new Date().toISOString(),resolutionReport:"",resolvedAt:null},I=B(),q=[y,...I];J(q),X(l,"صيانة"),h(r("maintenance.toast.ticketCreated","🛠️ تم إنشاء تذكرة الصيانة وإيقاف المعدة")),S(),s&&(s.value=""),o&&(o.value="medium");const g=document.getElementById("maintenance-status-filter");g&&(g.value="all"),R()}catch(n){console.error("❌ [maintenance] Failed to create ticket",n),h(r("maintenance.toast.submitError","⚠️ تعذر إنشاء تذكرة الصيانة. يرجى المحاولة مجدداً."))}}function mt(e){const n=B();return e==="all"?n:n.filter(t=>t.status===e)}function R(){B(),he();const e=document.getElementById("maintenance-status-filter");e&&!e.value&&(e.value="all");const n=(e==null?void 0:e.value)||"all",t=mt(n);ct(),rt(t)}B();document.addEventListener("language:changed",()=>{const e=document.getElementById("maintenance-selected-barcode"),n=document.getElementById("maintenance-selected-info");if(e!=null&&e.value){const t=P(e.value);t?ge(t):n&&(n.textContent=z())}else n&&(n.textContent=z());R()});document.addEventListener("submit",e=>{const n=e.target;(n==null?void 0:n.id)==="maintenance-form"&&!n.dataset.listenerAttached&&ut(e)});document.addEventListener("click",e=>{const n=e.target.closest("button[data-action]");if(!n||!n.closest(".maintenance-table"))return;const t=n.dataset.action,a=Number(n.dataset.id);a&&(t==="close"?lt(a):t==="view"?it(a):t==="delete"&&dt(a))});const le="dashboard-active-tab",_="dashboard-active-sub-tab",M={get(e){try{return localStorage.getItem(e)}catch(n){return console.warn("⚠️ [tabs.js] localStorage.getItem failed",{key:e,error:n}),null}},set(e,n){try{localStorage.setItem(e,n)}catch(t){console.warn("⚠️ [tabs.js] localStorage.setItem failed",{key:e,value:n,error:t})}},remove(e){try{localStorage.removeItem(e)}catch(n){console.warn("⚠️ [tabs.js] localStorage.removeItem failed",{key:e,error:n})}}};function pt(){var c;console.log("🚀 [tabs.js] setupTabs()");const e=document.querySelectorAll("[data-tab]"),n=document.querySelectorAll(".tab");console.log("📌 tabButtons:",e),console.log("📌 tabContents:",n);const t=(l,{skipStore:i=!1}={})=>{if(!l)return;const d=document.querySelector(`[data-tab="${l}"]`),f=document.getElementById(l);!d||!f||(e.forEach(m=>m.classList.remove("active")),d.classList.add("active"),n.forEach(m=>{const u=m.id===l;m.style.display=u?"block":"none",m.classList.toggle("active",u)}),i||M.set(le,l),l==="customers-tab"&&(console.log("👤 Rendering customers"),je()),l==="equipment-tab"&&(console.log("📦 Rendering equipment"),G()),l==="maintenance-tab"&&(console.log("🛠️ Rendering maintenance"),R()),l==="technicians-tab"&&(console.log("🛠️ Rendering technicians"),Ne()),l==="reservations-tab"&&(console.log("📅 Rendering reservations"),K(),ft()))};e.forEach(l=>{l.addEventListener("click",()=>{const i=l.getAttribute("data-tab");console.log("🖱️ Tab clicked:",i),t(i),i!=="reservations-tab"&&M.remove(_)})});const a=M.get(le),s=document.querySelector("[data-tab].active"),o=a&&document.getElementById(a)?a:s==null?void 0:s.getAttribute("data-tab");o&&(console.log("⭐ Initial tab:",o),t(o,{skipStore:!!a})),(c=document.body)==null||c.classList.remove("tabs-loading")}function ft(){console.log("🚀 [tabs.js] setupSubTabs()");const e=document.querySelectorAll(".sub-tab-button"),n=document.querySelectorAll(".sub-tab");console.log("📌 subTabButtons:",e),console.log("📌 subTabContents:",n);const t=(c,{skipStore:l=!1}={})=>{if(!c)return;const i=document.querySelector(`.sub-tab-button[data-sub-tab="${c}"]`),d=document.getElementById(c);!i||!d||(e.forEach(f=>f.classList.remove("active")),i.classList.add("active"),n.forEach(f=>{f.classList.remove("active")}),d.classList.add("active"),l||M.set(_,c),c==="my-reservations-tab"?(console.log("📋 Rendering reservations list"),setTimeout(()=>{K()},50)):c==="calendar-tab"?(console.log("📅 Rendering calendar view"),setTimeout(()=>{W()},100)):c==="reports-tab"&&(console.log("📊 Rendering reports view"),setTimeout(()=>{Ve()},50)))};e.forEach(c=>{c.addEventListener("click",()=>{const l=c.getAttribute("data-sub-tab");console.log("🖱️ Sub-tab clicked:",l),t(l)})});const a=M.get(_),s=document.querySelector(".sub-tab-button.active"),o=a&&document.getElementById(a)?a:s==null?void 0:s.getAttribute("data-sub-tab");o&&(console.log("⭐ Initial sub-tab:",o),t(o,{skipStore:!!a})),ue()}function ie(){var l;Fe(),pt(),G(),W(),De(),ue(),K();const e=document.getElementById("excel-upload");e&&e.addEventListener("change",async i=>{const d=i.target.files&&i.target.files[0];d&&(await Ae(d),i.target.value="")});const n=document.getElementById("excel-upload-trigger");n&&e&&n.addEventListener("click",i=>{i.preventDefault(),e.click()});const t=document.getElementById("search-equipment"),a=document.getElementById("filter-status"),s=document.getElementById("filter-category"),o=document.getElementById("equipment-list");function c(){const i=t.value.trim(),d=a.value,f=s.value,m=Re(i,d,f);o.innerHTML=m.length?m.map((u,y)=>`
        <div class="border-bottom py-2">
          🏷️ <strong>${u.desc}</strong> (${u.category} - ${u.sub})<br>
          📦 الكمية: ${u.qty} | 💵 السعر: ${u.price}<br>
          🔖 الباركود: ${u.barcode}<br>
          ⚙️ الحالة: ${u.status}<br>
          <button class="btn btn-sm btn-warning" onclick="editEquipment(${y})">✏️ تعديل</button>
          <button class="btn btn-sm btn-danger" onclick="deleteEquipment(${y})">🗑️ حذف</button>
        </div>
      `).join(""):"<em>⚠️ لا توجد معدات مطابقة.</em>"}t==null||t.addEventListener("input",c),a==null||a.addEventListener("change",c),s==null||s.addEventListener("change",c),(l=document.getElementById("logout-btn"))==null||l.addEventListener("click",He),bt(),gt()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",ie,{once:!0}):ie();function bt(){document.querySelectorAll('input[type="datetime-local"]').forEach(e=>{e.addEventListener("input",()=>{const n=e.value;if(!n.includes("T"))return;const[t,a]=n.split("T"),[s]=a.split(":"),o=`${s.padStart(2,"0")}:00`,c=`${t}T${o}`;e.value!==c&&(e.value=c,setTimeout(()=>e.blur(),150))})})}function gt(){const e=x(),n=localStorage.getItem("pendingReservationEditId"),t=localStorage.getItem("pendingReservationEdit");let a=null;if(n!==null){const o=(e.reservations||[]).findIndex(c=>String(c.id)===n||String(c.reservationId)===n);o!==-1&&(a=o),localStorage.removeItem("pendingReservationEditId")}if(a===null&&t!==null){const s=Number(t);Number.isNaN(s)||(a=s),localStorage.removeItem("pendingReservationEdit")}a===null||Number.isNaN(a)||setTimeout(()=>{const s=document.querySelector('[data-tab="reservations-tab"]');s==null||s.click(),setTimeout(()=>{var o;(o=document.querySelector('.sub-tab-button[data-sub-tab="create-tab"]'))==null||o.click(),setTimeout(()=>{const c=window.editReservation;typeof c=="function"&&c(a)},150)},150)},150)}
