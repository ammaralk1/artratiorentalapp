import{a as le,c as de,i as ue,l as pe,t as r,n as j,s as T,d as Vt,g as Ut}from"./auth-CNAfl19F.js";/* empty css                */import{m as me,l as Tt,s as pt}from"./storage-DOnDLvtb.js";import{d as fe,p as ut,i as be}from"./controller-DfdUmPnp.js";import"./projects-B5HGRUVy.js";import"./customers-JnWiO8yC.js";import{b as ge}from"./reservationsSummary-CBdNx1nm.js";le();me();de();fe();const l={customers:[],technicians:[],equipment:[],reservations:[],projects:[],selectedTechnicians:[],selectedEquipment:[],expenses:[],filters:{search:""},visibleProjects:[],editingProjectId:null},s={},ve="pendingReservationProjectContext",Lt="pendingProjectDetailId",qt=60*60*1e3,jt=.15,At=6,Wt="projects.activeTab",zt="projects.activeSubTab",St={create:"create-project-tab",list:"projects-list-tab"};function rt(t){if(!(t!=null&&t.start))return Number.NaN;const e=new Date(t.start).getTime();return Number.isFinite(e)?e:Number.NaN}function kt(t){if(t!=null&&t.createdAt){const n=new Date(t.createdAt).getTime();if(Number.isFinite(n))return n}const e=rt(t);return Number.isFinite(e)?e:Number.NEGATIVE_INFINITY}function xt(t,e){if(!t)return"";const n=e&&/\d{1,2}:\d{2}/.test(e)?e:"00:00",[a="00",o="00"]=n.split(":"),i=a.padStart(2,"0"),u=o.padStart(2,"0");return`${t}T${i}:${u}`}function Kt(){["startDate","startTime","endDate","endTime"].forEach(t=>{const e=s[t];e&&(e._flatpickr?e._flatpickr.clear():e.value="")})}function je(){return typeof window<"u"&&typeof window.flatpickr=="function"?window.flatpickr.bind(window):typeof globalThis<"u"&&typeof globalThis.flatpickr=="function"?globalThis.flatpickr.bind(globalThis):null}function ye(){const t=je();if(!t)return;const e=[["#project-start-date",{dateFormat:"Y-m-d"}],["#project-end-date",{dateFormat:"Y-m-d"}]],n=[["#project-start-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0}],["#project-end-time",{enableTime:!0,noCalendar:!0,dateFormat:"H:i",altInput:!0,altFormat:"h:i K",time_24hr:!1,defaultHour:9,defaultMinute:0}]];[...e,...n].forEach(([a,o])=>{document.querySelector(a)&&t(a,o)})}document.addEventListener("DOMContentLoaded",()=>{he(),Et(),ye(),ue(),Ce(),we(),Ae(),Be(),Ie(),Me(),qe(),ke(),Fe(),an(),sn()});document.addEventListener("language:changed",()=>{yt(),dt(),z(),st(),ct(),Et()});document.addEventListener("language:translationsReady",()=>{yt(),dt(),z(),st(),ct(),Et()});document.addEventListener("customers:changed",Re);document.addEventListener("technicians:updated",He);document.addEventListener("reservations:changed",Oe);function he(){var t;s.form=document.getElementById("project-form"),s.title=document.getElementById("project-title"),s.type=document.getElementById("project-type"),s.client=document.getElementById("project-client"),s.clientSuggestions=document.getElementById("project-customer-suggestions"),s.clientCompany=document.getElementById("project-client-company"),s.paymentStatus=document.getElementById("project-payment-status"),s.startDate=document.getElementById("project-start-date"),s.startTime=document.getElementById("project-start-time"),s.endDate=document.getElementById("project-end-date"),s.endTime=document.getElementById("project-end-time"),s.description=document.getElementById("project-description"),s.technicianSelect=document.getElementById("project-technician-select"),s.addTechnicianBtn=document.getElementById("add-technician-btn"),s.technicianList=document.getElementById("project-technician-list"),s.equipmentSelect=document.getElementById("project-equipment-select"),s.equipmentQty=document.getElementById("project-equipment-qty"),s.addEquipmentBtn=document.getElementById("add-equipment-btn"),s.equipmentList=document.getElementById("project-equipment-list"),s.expenseLabel=document.getElementById("project-expense-label"),s.expenseAmount=document.getElementById("project-expense-amount"),s.addExpenseBtn=document.getElementById("add-expense-btn"),s.expenseList=document.getElementById("project-expense-list"),s.taxCheckbox=document.getElementById("project-tax"),s.submitBtn=(t=s.form)==null?void 0:t.querySelector('[type="submit"]'),s.projectsTableBody=document.getElementById("project-table-body"),s.projectsCount=document.getElementById("projects-count"),s.projectsUpcoming=document.getElementById("projects-upcoming"),s.projectsExpenses=document.getElementById("projects-expenses"),s.projectsBudget=document.getElementById("projects-budget"),s.tableCount=document.getElementById("project-table-count"),s.search=document.getElementById("project-search"),s.detailsModalEl=document.getElementById("projectDetailsModal"),s.detailsBody=document.getElementById("project-details-body"),s.tabButtons=Array.from(document.querySelectorAll(".tab-button[data-tab-target]")),s.tabPanes=Array.from(document.querySelectorAll("[data-tab-pane]")),s.projectSubTabButtons=Array.from(document.querySelectorAll(".sub-tab-button[data-project-subtab-target]")),s.projectSubTabPanes=Array.from(document.querySelectorAll("[data-project-subtab]")),s.timeline=document.getElementById("project-timeline"),s.focusCards=document.getElementById("project-focus-cards"),s.detailsModalEl&&!s.detailsModalEl.dataset.projectListenerAttached&&(s.detailsModalEl.addEventListener("hidden.bs.modal",()=>{s.detailsBody&&(s.detailsBody.dataset.projectId="")}),s.detailsModalEl.dataset.projectListenerAttached="true")}function Jt(t,e){if(t)try{window.localStorage.setItem(t,e)}catch{}}function Yt(t){if(!t)return"";try{return window.localStorage.getItem(t)||""}catch{return""}}function Se(t){t&&Jt(Wt,t)}function xe(){return Yt(Wt)}function Gt(t){t&&Jt(zt,t)}function Te(){return Yt(zt)}function Bt(t){if(!t)return"";const e=String(t).trim();if(!e)return"";const n=e.toLowerCase();return St[n]?St[n]:t in St?St[t]:!s.projectSubTabButtons||!s.projectSubTabButtons.length||s.projectSubTabButtons.some(o=>o.dataset.projectSubtabTarget===e)?e:""}function $e(){if(typeof window>"u")return"";const{hash:t,search:e}=window.location;if(t){const n=t.replace("#","").trim();if(n){if(n.toLowerCase().startsWith("tab=")){const[,o]=n.split("="),i=Bt(o);if(i)return i}const a=Bt(n);if(a)return a}}try{const a=new URLSearchParams(e||"").get("tab");if(a){const o=Bt(a);if(o)return o}}catch{}return""}function Ee(){if(!Array.isArray(l.projects)||l.projects.length===0)return;let t=!1;const e=l.projects.map(n=>{if(n.projectCode)return n;const a=Vt();return t=!0,{...n,projectCode:a}});t&&(l.projects=e,pt({projects:l.projects}))}function Ce(){if(!s.tabButtons||!s.tabButtons.length)return;s.tabButtons.forEach(o=>{o.dataset.listenerAttached||(o.addEventListener("click",i=>{i.preventDefault();const u=o.dataset.tabTarget;u&&(Mt(u,o),u==="customers-section"?document.dispatchEvent(new CustomEvent("customers:refreshRequested")):u==="technicians-section"&&document.dispatchEvent(new CustomEvent("technicians:refreshRequested")))}),o.dataset.listenerAttached="true")});const t=xe(),e=s.tabButtons.find(o=>o.dataset.tabTarget===t),n=s.tabButtons.find(o=>o.classList.contains("active")),a=e||n||s.tabButtons[0];if(a){const o=a.dataset.tabTarget;o&&Mt(o,a)}}function Mt(t,e){s.tabButtons.forEach(n=>{n.classList.toggle("active",n===e)}),t&&Se(t),!(!s.tabPanes||!s.tabPanes.length)&&(s.tabPanes.forEach(n=>{const a=n.id===t;n.classList.toggle("d-none",!a),n.classList.toggle("active",a)}),t==="projects-section"&&Le())}function we(){!s.projectSubTabButtons||!s.projectSubTabButtons.length||s.projectSubTabButtons.forEach(t=>{t.dataset.listenerAttached||(t.addEventListener("click",e=>{e.preventDefault();const n=t.dataset.projectSubtabTarget;n&&Qt(n,t)}),t.dataset.listenerAttached="true")})}function mt(t){if(!t)return r("projects.form.types.unknown","نوع غير محدد");const e={commercial:"projects.form.types.commercial",coverage:"projects.form.types.coverage",photography:"projects.form.types.photography",social:"projects.form.types.social"}[t]||"projects.form.types.unknown";return r(e,t)}function lt(t){if(!s.clientCompany)return;const e=(t==null?void 0:t.companyName)||(t==null?void 0:t.company)||"";s.clientCompany.value=e}function Qt(t,e){s.projectSubTabButtons.forEach(n=>{n.classList.toggle("active",n===e)}),!(!s.projectSubTabPanes||!s.projectSubTabPanes.length)&&(s.projectSubTabPanes.forEach(n=>{const a=n.id===t;n.classList.toggle("d-none",!a),n.classList.toggle("active",a)}),t&&Gt(t),t==="projects-list-tab"?(z(),s.search&&window.requestAnimationFrame(()=>{var n;return(n=s.search)==null?void 0:n.focus()})):t==="create-project-tab"&&ct())}function Le(){if(!s.projectSubTabButtons||!s.projectSubTabButtons.length)return;const t=$e(),e=Te(),n=t||e,a=n?s.projectSubTabButtons.find(d=>d.dataset.projectSubtabTarget===n):null,o=s.projectSubTabButtons.find(d=>d.classList.contains("active")),i=a||o||s.projectSubTabButtons[0];if(!i)return;const u=i.dataset.projectSubtabTarget;u&&(t&&t!==e&&Gt(u),Qt(u,i))}function Ae(){const t=document.getElementById("logout-btn");t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>pe()),t.dataset.listenerAttached="true")}function Be(){const{customers:t,technicians:e,equipment:n,reservations:a,projects:o}=Tt();l.customers=Array.isArray(t)?t:[],l.technicians=Array.isArray(e)?e:[],l.equipment=Array.isArray(n)?n:[],l.reservations=Array.isArray(a)?a:[],l.projects=Array.isArray(o)?o.map(i=>({...i,type:i.type||i.projectType||"",clientCompany:i.clientCompany||i.company||"",paymentStatus:i.paymentStatus==="paid"?"paid":"unpaid",confirmed:i.confirmed===!0||i.confirmed==="true"})):[],Ee(),yt(),dt(),z(),st(),ct()}function yt(){if(Ne(),s.technicianSelect){const t=s.technicianSelect.value,e=c(r("projects.form.selectTechnician","اختر عضو الطاقم"));s.technicianSelect.innerHTML=`<option value="">${e}</option>`+l.technicians.map(n=>{const a=r("projects.fallback.technicianName","عضو {id}"),o=n.name||a.replace("{id}",j(String(n.id||"")));return`<option value="${n.id}">${c(o)}</option>`}).join(""),t&&(s.technicianSelect.value=t)}if(s.equipmentSelect){const t=s.equipmentSelect.value,e=c(r("projects.form.selectEquipment","اختر المعدة"));s.equipmentSelect.innerHTML=`<option value="">${e}</option>`+l.equipment.map(n=>{const a=n.desc||n.description||n.name||r("projects.fallback.unknownEquipment","معدة");return`<option value="${c(n.barcode||"")}">${c(a)}</option>`}).join(""),t&&(s.equipmentSelect.value=t)}}function Ne(){var e;if(!s.client)return;Pe();const t=(e=s.client.dataset)==null?void 0:e.customerId;if(t){const n=l.customers.find(a=>String(a.id)===String(t));n?lt(n):(s.client.dataset.customerId="",lt(null))}else lt(null);document.activeElement===s.client&&Pt()}function Pe(){!s.client||!s.clientSuggestions||s.client.dataset.autocompleteAttached!=="true"&&(s.client.addEventListener("input",()=>{s.client.dataset.customerId="",Pt(),lt(null)}),s.client.addEventListener("focus",()=>{Pt()}),s.client.addEventListener("blur",()=>{window.setTimeout(()=>gt(),150)}),s.client.dataset.autocompleteAttached="true")}function gt(){s.clientSuggestions&&(s.clientSuggestions.style.display="none",s.clientSuggestions.innerHTML="")}function Pt(){if(!s.client||!s.clientSuggestions)return;const t=_e(),e=ut(s.client.value||""),n=e?t.filter(a=>{const o=ut(a.name).includes(e),i=ut(a.company||"").includes(e);return o||i}).slice(0,10):t.slice(0,10);if(!n.length){gt();return}s.clientSuggestions.innerHTML=n.map(a=>{const o=a.company?`<div class="suggestion-item__meta">${c(a.company)}</div>`:"";return`
        <div class="suggestion-item" data-id="${c(String(a.id))}" data-name="${c(a.name)}" data-company="${c(a.company||"")}">
          <div class="suggestion-item__primary">${c(a.name)}</div>
          ${o}
        </div>
      `}).join(""),s.clientSuggestions.style.display="block",s.clientSuggestions.querySelectorAll(".suggestion-item").forEach(a=>{a.addEventListener("mousedown",o=>{o.preventDefault();const{id:i,name:u}=o.currentTarget.dataset;s.client&&(s.client.value=u||"",s.client.dataset.customerId=i||"");const d=o.currentTarget.dataset.company||"";lt({companyName:d}),gt()})})}function _e(){return Array.isArray(l.customers)?l.customers.map(t=>{const e=(t.customerName||t.name||"").trim();return e?{id:t.id,name:e,company:(t.companyName||t.company||"").trim()}:null}).filter(Boolean):[]}function De(t,e=""){if(!Array.isArray(l.customers)||l.customers.length===0)return null;if(e){const o=l.customers.find(i=>String(i.id)===String(e));if(o)return o}const n=ut(t||"");if(!n)return null;const a=l.customers.find(o=>ut(o.customerName||o.name||"")===n);return a||l.customers.find(o=>ut(o.customerName||o.name||"").includes(n))||null}function Ie(){s.form&&!s.form.dataset.listenerAttached&&(s.form.addEventListener("submit",ze),s.form.dataset.listenerAttached="true"),s.form&&!s.form.dataset.resetListenerAttached&&(s.form.addEventListener("reset",()=>{s.client&&(s.client.dataset.customerId=""),gt(),Kt(),s.type&&(s.type.value=""),lt(null),Xt()}),s.form.dataset.resetListenerAttached="true"),s.search&&!s.search.dataset.listenerAttached&&(s.search.addEventListener("input",()=>{l.filters.search=j(s.search.value||"").trim().toLowerCase(),z()}),s.search.dataset.listenerAttached="true")}function Xt(){l.selectedTechnicians=[],l.selectedEquipment=[],l.expenses=[],l.editingProjectId=null,s.form&&(delete s.form.dataset.editingId,s.form.dataset.mode="create"),dt(),s.expenseLabel&&(s.expenseLabel.value=""),s.expenseAmount&&(s.expenseAmount.value=""),s.taxCheckbox&&(s.taxCheckbox.checked=!1),s.paymentStatus&&(s.paymentStatus.value="unpaid"),Et()}function qe(){s.addTechnicianBtn&&!s.addTechnicianBtn.dataset.listenerAttached&&(s.addTechnicianBtn.addEventListener("click",Ve),s.addTechnicianBtn.dataset.listenerAttached="true"),s.addEquipmentBtn&&!s.addEquipmentBtn.dataset.listenerAttached&&(s.addEquipmentBtn.addEventListener("click",Ue),s.addEquipmentBtn.dataset.listenerAttached="true")}function ke(){Nt(s.technicianList,t=>{if(t.matches('[data-action="remove-technician"]')){const e=t.dataset.id;l.selectedTechnicians=l.selectedTechnicians.filter(n=>n!==e),Zt()}}),Nt(s.equipmentList,t=>{if(t.matches('[data-action="remove-equipment"]')){const e=t.dataset.id;l.selectedEquipment=l.selectedEquipment.filter(n=>n.barcode!==e),te()}}),Nt(s.expenseList,t=>{if(t.matches('[data-action="remove-expense"]')){const e=t.dataset.id;l.expenses=l.expenses.filter(n=>String(n.id)!==String(e)),ee(),st()}})}function Nt(t,e){!t||t.dataset.listenerAttached||(t.addEventListener("click",n=>{const a=n.target;a instanceof HTMLElement&&e(a)}),t.dataset.listenerAttached="true")}function Me(){s.addExpenseBtn&&!s.addExpenseBtn.dataset.listenerAttached&&(s.addExpenseBtn.addEventListener("click",We),s.addExpenseBtn.dataset.listenerAttached="true"),s.expenseAmount&&!s.expenseAmount.dataset.normalizeAttached&&(s.expenseAmount.addEventListener("input",t=>{const e=t.target;if(!(e instanceof HTMLInputElement))return;const n=e.selectionStart,a=j(e.value||"");if(e.value=a,n!=null){const o=Math.min(a.length,n);e.setSelectionRange(o,o)}}),s.expenseAmount.dataset.normalizeAttached="true")}function Fe(){!s.projectsTableBody||s.projectsTableBody.dataset.listenerAttached||(s.projectsTableBody.addEventListener("click",t=>{const e=t.target;if(e instanceof HTMLElement){if(e.matches('[data-action="view-details"]')){const n=e.dataset.id;it(n);return}if(e.matches('[data-action="delete-project"]')){const n=e.dataset.id;bn(n)}}}),s.projectsTableBody.dataset.listenerAttached="true")}function Re(){const{customers:t}=Tt();l.customers=Array.isArray(t)?t:[],yt(),z(),ct()}function He(){const{technicians:t}=Tt();l.technicians=Array.isArray(t)?t:[],yt(),z(),ct()}function Oe(){var a;const{reservations:t}=Tt();l.reservations=Array.isArray(t)?t:[],z();const e=s.detailsModalEl&&s.detailsModalEl.classList.contains("show"),n=(a=s.detailsBody)==null?void 0:a.dataset.projectId;e&&n&&l.projects.find(i=>String(i.id)===String(n))&&it(n)}function $t(t){return t?l.reservations.filter(e=>String(e.projectId)===String(t)):[]}function Dt(t){if(!t)return 0;const e=Array.isArray(t.items)?t.items:[],n=t.discount??0,a=Number(j(String(n)))||0,o=t.discountType||"percent",i=Array.isArray(t.technicians)?t.technicians:[],u=ge(e,a,o,!1,i,{start:t.start,end:t.end});if(Number.isFinite(u))return u;const d=Number(j(String(t.cost??0)));return Number.isFinite(d)?Math.round(d):0}function Ve(){var e;const t=(e=s.technicianSelect)==null?void 0:e.value;if(!t){T(r("projects.toast.selectTechnician","⚠️ يرجى اختيار عضو الطاقم"));return}if(l.selectedTechnicians.includes(t)){T(r("projects.toast.technicianAlreadyAdded","⚠️ العضو مضاف بالفعل"));return}l.selectedTechnicians.push(t),dt(),T(r("projects.toast.technicianAdded","✅ تمت إضافة عضو الطاقم"))}function Ue(){var a,o;const t=(a=s.equipmentSelect)==null?void 0:a.value;if(!t){T(r("projects.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const e=Math.max(1,parseInt(((o=s.equipmentQty)==null?void 0:o.value)||"1",10)||1),n=l.selectedEquipment.find(i=>i.barcode===t);n?n.qty+=e:l.selectedEquipment.push({barcode:t,qty:e}),dt(),T(r("projects.toast.equipmentAdded","✅ تمت إضافة المعدة للمشروع"))}function We(){var a,o;const t=(((a=s.expenseLabel)==null?void 0:a.value)||"").trim(),e=j(((o=s.expenseAmount)==null?void 0:o.value)||"0"),n=Number(e);if(!t){T(r("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف"));return}if(!Number.isFinite(n)||n<0){T(r("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح"));return}l.expenses.push({id:Date.now(),label:t,amount:n}),s.expenseLabel&&(s.expenseLabel.value=""),s.expenseAmount&&(s.expenseAmount.value=j(String(e))),dt(),st()}function dt(){Zt(),te(),ee()}function Zt(){ne(s.technicianList,l.selectedTechnicians,t=>{const e=l.technicians.find(u=>String(u.id)===String(t)),n=r("projects.fallback.technicianName","عضو {id}"),a=(e==null?void 0:e.name)||n.replace("{id}",j(String(t))),o=e!=null&&e.role?`<small class="text-muted">${c(e.role)}</small>`:"",i=c(r("actions.remove","إزالة"));return`
      <span class="tag-chip">
        <span>${c(a)}</span>
        ${o}
        <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-technician" data-id="${t}" aria-label="${i}">✖</button>
      </span>
    `})}function te(){ne(s.equipmentList,l.selectedEquipment,t=>{const e=l.equipment.find(i=>String(i.barcode||"")===String(t.barcode)),n=(e==null?void 0:e.desc)||(e==null?void 0:e.description)||(e==null?void 0:e.name)||t.barcode,a=r("projects.details.quantity","{qty} قطعة").replace("{qty}",j(String(t.qty||0))),o=c(r("actions.remove","إزالة"));return`
      <span class="tag-chip">
        <span>${c(n)}</span>
        <small class="text-muted">${c(a)}</small>
        <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-equipment" data-id="${c(t.barcode)}" aria-label="${o}">✖</button>
      </span>
    `})}function ee(){if(s.expenseList){if(!l.expenses.length){const t=c(ce(s.expenseList));s.expenseList.innerHTML=`<span class="text-muted">${t}</span>`;return}s.expenseList.innerHTML=l.expenses.map(t=>`
      <div class="expense-item">
        <span>${c(t.label)}</span>
        <span>${A(t.amount)}</span>
        <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${t.id}" aria-label="${c(r("actions.remove","إزالة"))}">✖</button>
      </div>
    `).join("")}}function ne(t,e,n){if(t){if(!e||e.length===0){const a=c(ce(t));t.innerHTML=`<span class="text-muted">${a}</span>`;return}t.innerHTML=e.map(a=>n(a)).join("")}}function ze(t){var P,R,H,_,O,D,U,J,q,Z,Y,tt,at,ot,et,nt,F,$;t.preventDefault();const e=(P=s.title)==null?void 0:P.value.trim(),n=((R=s.type)==null?void 0:R.value)||"",a=((_=(H=s.client)==null?void 0:H.value)==null?void 0:_.trim())||"",o=((D=(O=s.client)==null?void 0:O.dataset)==null?void 0:D.customerId)||"",i=((J=(U=s.startDate)==null?void 0:U.value)==null?void 0:J.trim())||"",u=((Z=(q=s.startTime)==null?void 0:q.value)==null?void 0:Z.trim())||"";if(!e||!n||!i){T(r("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة"));return}const d=De(a,o);if(!d){T(r("projects.toast.customerNotFound","⚠️ لم يتم العثور على العميل بالاسم المدخل")),(Y=s.client)==null||Y.focus();return}const g=String(d.id);s.client&&(s.client.dataset.customerId=g,s.client.value=d.customerName||d.name||s.client.value),lt(d);const y=((at=(tt=s.endDate)==null?void 0:tt.value)==null?void 0:at.trim())||"",x=((et=(ot=s.endTime)==null?void 0:ot.value)==null?void 0:et.trim())||"",m=xt(i,u),f=y?xt(y,x):"",h=new Date(m),S=f?new Date(f):null;if(S&&h>S){T(r("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية"));return}s.expenseAmount&&(s.expenseAmount.value=j(s.expenseAmount.value||""));const p=un(),b=pn(),v=((nt=s.taxCheckbox)==null?void 0:nt.checked)===!0,w=(((F=s.paymentStatus)==null?void 0:F.value)||"unpaid")==="paid"?"paid":"unpaid",L=b+p,I=v?Number((L*jt).toFixed(2)):0,V=Number((L+I).toFixed(2)),C=!!l.editingProjectId,B=C?l.editingProjectId:Date.now(),N=d.companyName||d.company||"",M=(($=s.description)==null?void 0:$.value.trim())||"";if(C){const k=l.projects.findIndex(Q=>String(Q.id)===String(B));if(k===-1){T(r("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const ft={...l.projects[k],title:e,type:n,clientId:g,clientCompany:N,description:M,start:m,end:f||null,technicians:[...l.selectedTechnicians],equipment:l.selectedEquipment.map(Q=>({...Q})),expenses:l.expenses.map(Q=>({...Q})),expensesTotal:p,equipmentEstimate:b,applyTax:v,taxAmount:I,totalWithTax:V,paymentStatus:w,updatedAt:new Date().toISOString()};l.projects[k]=ft;const W=_t(B,w),K=W?{projects:l.projects,reservations:l.reservations}:{projects:l.projects};pt(K),W&&document.dispatchEvent(new CustomEvent("reservations:changed")),T(r("projects.toast.updated","✅ تم تحديث المشروع بنجاح"))}else{const k=Vt(),G={id:B,projectCode:k,title:e,type:n,clientId:g,clientCompany:N,description:M,start:m,end:f||null,technicians:[...l.selectedTechnicians],equipment:l.selectedEquipment.map(K=>({...K})),expenses:l.expenses.map(K=>({...K})),expensesTotal:p,equipmentEstimate:b,applyTax:v,taxAmount:I,totalWithTax:V,paymentStatus:w,createdAt:new Date().toISOString(),confirmed:!1};l.projects.push(G);const ft=_t(B,w),W=ft?{projects:l.projects,reservations:l.reservations}:{projects:l.projects};pt(W),ft&&document.dispatchEvent(new CustomEvent("reservations:changed")),T(r("projects.toast.saved","✅ تم حفظ المشروع بنجاح"))}l.editingProjectId=null,s.form.reset(),Xt(),Kt(),gt(),s.client&&(s.client.dataset.customerId=""),s.type&&(s.type.value=""),z(),st(),document.dispatchEvent(new CustomEvent("projects:changed"))}function z(){if(!s.projectsTableBody)return;const t=l.filters.search,e=l.projects.filter(a=>{if(!t)return!0;const o=l.customers.find(u=>String(u.id)===String(a.clientId));return j([a.title,a.description,o==null?void 0:o.customerName,a.clientCompany,mt(a.type),a.id,a.projectCode].filter(Boolean).join(" ")).toLowerCase().includes(t)});if(!e.length){const a=l.projects.length===0?"projects.table.emptyInitial":"projects.table.emptyFiltered",o=l.projects.length===0?"لم يتم إنشاء مشاريع بعد.":"لا توجد مشاريع مطابقة.",i=c(r(a,o));s.projectsTableBody.innerHTML=`<tr class="projects-table-empty-row"><td colspan="8" class="text-center text-muted">${i}</td></tr>`,Ot(0),l.visibleProjects=[],Ft([]);return}const n=[...e].sort((a,o)=>new Date(o.start||0)-new Date(a.start||0));l.visibleProjects=n,Ot(n.length),s.projectsTableBody.innerHTML=n.map(a=>Ke(a)).join(""),Ft(n),ct()}function Ke(t){var v;const e=l.customers.find(E=>String(E.id)===String(t.clientId)),n=(e==null?void 0:e.customerName)||r("projects.fallback.unknownClient","عميل غير معروف"),a=(t.clientCompany||(e==null?void 0:e.companyName)||"").trim(),o=((v=t.technicians)==null?void 0:v.length)||0,i=(t.equipment||[]).reduce((E,w)=>E+(w.qty||0),0),{expensesTotal:u,totalWithTax:d}=vt(t),y=$t(t.id).length,m=r("projects.table.reservationsCount","{count} حجوزات").replace("{count}",j(String(y))),f=y?`<span class="badge rounded-pill project-reservations-chip">${c(m)}</span>`:"",S=`<span class="badge project-type-badge">${c(mt(t.type))}</span>`,p=t.projectCode||`PRJ-${j(String(t.id))}`,b=`<span class="project-code-badge">#${c(p)}</span>`;return`
    <tr data-project-id="${t.id}">
      <td>
        <div class="d-flex flex-column gap-1">
          <div class="fw-bold">${c(t.title)}</div>
          <div class="d-flex flex-wrap gap-2 align-items-center project-row-meta">
            ${b}
            ${S}
          </div>
        </div>
        ${f}
      </td>
      <td>
        ${a?`<div class="d-flex flex-column"><span>${c(n)}</span><small class="text-muted">${c(a)}</small></div>`:c(n)}
      </td>
      <td>${re(t.start,t.end)}</td>
      <td>${j(String(o))}</td>
      <td>${j(String(i))}</td>
      <td>${A(d)}</td>
      <td>${A(u)}</td>
      <td class="text-end">
        <button class="btn btn-sm btn-outline-primary" data-action="view-details" data-id="${t.id}">${c(r("actions.view","عرض"))}</button>
        <button class="btn btn-sm btn-outline-danger" data-action="delete-project" data-id="${t.id}">${c(r("actions.delete","حذف"))}</button>
      </td>
    </tr>
  `}function Ft(t){if(!s.timeline)return;const n=(Array.isArray(t)?t:l.visibleProjects.length?l.visibleProjects:l.projects).map(m=>{if(!(m!=null&&m.start))return null;const f=new Date(m.start);if(Number.isNaN(f.getTime()))return null;let h=m.end?new Date(m.end):new Date(f);return Number.isNaN(h.getTime())&&(h=new Date(f)),h<=f&&(h=new Date(f.getTime()+qt)),{project:m,startDate:f,endDate:h}}).filter(Boolean).sort((m,f)=>m.startDate-f.startDate);if(!n.length){const m=c(r("projects.timeline.empty",s.timeline.dataset.empty||"لا توجد مشاريع ببيانات زمنية صالحة."));s.timeline.innerHTML=`<div class="project-timeline__empty text-muted">${m}</div>`;return}const a=n[0].startDate.getTime(),o=Math.max(...n.map(m=>m.endDate.getTime()));let i=o-a;i<=0&&(i=qt);const u=Je(n),d=r("projects.timeline.range","{start} → {end}"),g=r("projects.timeline.conflict","Scheduling conflict"),y=n.map(m=>{const{project:f,startDate:h,endDate:S}=m,p=S.getTime()-h.getTime();let b=(h.getTime()-a)/i*100;b=Math.max(0,Math.min(b,100));let v=p/i*100;v=Math.max(v,2.5),b+v>100&&(v=Math.max(1.5,100-b));const w=`project-timeline__item--${It(f)}`,L=u.has(f.id),I=(f.title||"").trim()||r("projects.fallback.untitled","Untitled project"),V=oe(I,26),C=l.customers.find(U=>String(U.id)===String(f.clientId)),B=(C==null?void 0:C.customerName)||r("projects.fallback.unknownClient","Unknown client"),N=(f.clientCompany||(C==null?void 0:C.companyName)||"").trim(),M=mt(f.type),P=X(h.toISOString()),R=X(S.toISOString()),H=d.replace("{start}",P).replace("{end}",R),_=N?`${B} (${N})`:B,O=`${I} • ${M} • ${_} | ${H}`,D=L?`<span class="project-timeline__item-conflict" title="${c(g)}">⚠️</span>`:"";return`
        <div class="project-timeline__item ${w}${L?" project-timeline__item--conflict":""}" style="left:${b}%;width:${v}%;" title="${c(O)}">
          <span class="project-timeline__item-label">${c(V)}</span>
          ${D}
        </div>
      `}).join(""),x=`
    <div class="project-timeline__scale">
      <span>${c(X(new Date(a).toISOString()))}</span>
      <span>${c(X(new Date(o).toISOString()))}</span>
    </div>
  `;s.timeline.innerHTML=`
    ${x}
    <div class="project-timeline__track">
      ${y}
    </div>
  `}function Je(t){const e=new Set;for(let n=0;n<t.length;n+=1)for(let a=n+1;a<t.length;a+=1){const o=t[n],i=t[a];o.startDate<i.endDate&&i.startDate<o.endDate&&(e.add(o.project.id),e.add(i.project.id))}return e}function ct(){if(!s.focusCards)return;const t=Ye();if(!t.length){const e=c(r("projects.focus.empty",s.focusCards.dataset.empty||"لا توجد مشاريع لليوم أو هذا الأسبوع."));s.focusCards.innerHTML=`<div class="col-12"><div class="alert alert-info mb-0 text-center">${e}</div></div>`;return}s.focusCards.innerHTML=t.join("")}function Ye(){if(!Array.isArray(l.projects)||!l.projects.length)return[];const t=l.projects.filter(Rt),e=l.projects.filter(i=>!Rt(i)&&ln(i)),n=[],a=new Set,o=(i,u)=>{!i||a.has(i.id)||n.length>=At||(a.add(i.id),n.push(Ge(i,u)))};if(t.sort((i,u)=>rt(i)-rt(u)).forEach(i=>o(i,"today")),e.sort((i,u)=>rt(i)-rt(u)).forEach(i=>o(i,"thisWeek")),n.length<At){const i=Date.now();[...l.projects].filter(d=>!a.has(d.id)).filter(d=>{const g=rt(d);return Number.isFinite(g)&&g>=i}).sort((d,g)=>rt(d)-rt(g)).forEach(d=>o(d,"upcoming"))}return n.length<At&&[...l.projects].filter(u=>!a.has(u.id)).sort((u,d)=>kt(d)-kt(u)).forEach(u=>o(u,"recent")),n}function Ge(t,e){const n=l.customers.find(W=>String(W.id)===String(t.clientId)),a=(n==null?void 0:n.customerName)||r("projects.fallback.unknownClient","Unknown client"),o=(t.clientCompany||(n==null?void 0:n.companyName)||"").trim();Array.isArray(t.technicians)&&t.technicians.length;const i=$t(t.id);i.length;const u=ae(t),{subtotal:d,applyTax:g}=vt(t),y=(t.description||"").trim(),x=mt(t.type),m=t.paymentStatus==="paid"?"paid":"unpaid",f=r(`projects.paymentStatus.${m}`,m==="paid"?"Paid":"Unpaid"),h=m==="paid"?"status-paid":"status-unpaid",S=m==="paid"?"project-focus-card--paid":"project-focus-card--unpaid",p=t.confirmed===!0||t.confirmed==="true",b=c(String(t.id)),v=t.projectCode||`PRJ-${j(String(t.id))}`,E=j(v),w={today:"projects.focus.today",thisWeek:"projects.focus.thisWeek",upcoming:"projects.focus.upcoming",recent:"projects.focus.recent"},L={today:"Today's Projects",thisWeek:"This Week",upcoming:"Upcoming Projects",recent:"Latest Projects"},I=w[e]||w.recent,V=r(I,L[e]||L.recent),C=It(t),B=r(`projects.status.${C}`,se[C]),N=dn[C]||"bg-secondary",M=(t.title||"").trim()||r("projects.fallback.untitled","Untitled project"),P=[S];p&&P.push("project-focus-card--confirmed");const R=r("projects.focus.actions.confirm","✔️ تأكيد المشروع"),H=r("projects.focus.confirmed","✅ مشروع مؤكد"),_=i.reduce((W,K)=>{const Q=Dt(K),Ct=(K.items||[]).reduce((wt,bt)=>wt+(Number(bt==null?void 0:bt.qty)||1),0),ht=(K.technicians||[]).length;return{total:W.total+Q,equipment:W.equipment+Ct,crew:W.crew+ht}},{total:0,equipment:0,crew:0}),O=Number(_.total.toFixed(2)),D=_.equipment,U=_.crew,J=g?Number(((d+O)*jt).toFixed(2)):0,q=Number((d+O+J).toFixed(2)),Z=`<span class="project-code-badge project-focus-card__code">#${c(E)}</span>`,Y=`<span class="badge project-focus-card__badge ${N}">${c(V)}</span>`,tt=`<span class="project-focus-card__status-chip ${N}">${c(B)}</span>`,at=`<span class="reservation-chip ${h} project-focus-card__payment-chip">${c(f)}</span>`,ot=[{icon:"📦",label:r("projectCards.stats.equipmentCount","عدد المعدات"),value:j(String(D))},{icon:"😎",label:r("projectCards.stats.crewCount","عدد الطاقم"),value:j(String(U))},{icon:"💵",label:r("projectCards.stats.reservationValue","إجمالي الحجوزات"),value:A(O)}],et=[{icon:"💳",label:r("projectCards.stats.paymentStatus","حالة الدفع"),value:f},{icon:"💸",label:r("projectCards.stats.expensesTotal","إجمالي المصاريف"),value:A(u)},{icon:"💵",label:r("projectCards.stats.reservationTotal","إجمالي الحجز"),value:A(O)},{icon:"🧾",label:r("projectCards.stats.taxTotal","الضريبة"),value:A(J)},{icon:"💰",label:r("projectCards.stats.overallTotal","المجموع الكلي"),value:A(q)}],nt=c(y?oe(y,110):r("projects.fallback.noDescription","No description")),F=[{icon:"🆔",label:r("projectCards.meta.code","رقم المشروع"),value:`#${E}`},{icon:"👤",label:r("projectCards.meta.client","العميل"),value:a},o?{icon:"🏢",label:r("projectCards.meta.company","شركة العميل"),value:o}:null,{icon:"🏷️",label:r("projectCards.meta.type","نوع المشروع"),value:x},{icon:"📅",label:r("projectCards.meta.startDate","تاريخ البداية"),value:X(t.start)},{icon:"📅",label:r("projectCards.meta.endDate","تاريخ النهاية"),value:t.end?X(t.end):"—"}].filter(Boolean),$=(W,K,Q=[])=>{if(!Q.length)return"";const Ct=Q.map(({icon:ht,label:wt,value:bt})=>`
          <div class="project-focus-card__row">
            <span class="project-focus-card__row-label">${ht?`<span class="project-focus-card__row-icon">${c(ht)}</span>`:""}${c(wt)}</span>
            <span class="project-focus-card__row-value">${c(bt)}</span>
          </div>
        `).join("");return`
      <div class="project-focus-card__section">
        <span class="project-focus-card__section-title">${c(r(W,K))}</span>
        <div class="project-focus-card__section-box">
          ${Ct}
        </div>
      </div>
    `},k=[$("projectCards.groups.meta","بيانات المشروع",F),$("projectCards.groups.reservations","موجز الحجز",ot),$("projectCards.groups.payment","ملخص الدفع",et)].join(""),G=p?`<div class="project-focus-card__actions"><span class="reservation-chip status-confirmed project-focus-card__confirm-indicator">${c(H)}</span></div>`:`<div class="project-focus-card__actions"><button type="button" class="btn btn-sm btn-success project-focus-card__confirm-btn" data-action="confirm-project" data-id="${b}">${c(R)}</button></div>`;return`
    <div class="col-12 col-md-6 col-xl-4">
      <article class="${["project-focus-card",...P].join(" ")}" data-project-id="${b}" data-category="${c(String(e))}">
        <div class="project-focus-card__accent"></div>
        <div class="project-focus-card__top">
          ${Z}
          ${Y}
          ${tt}
          ${at}
        </div>
        <h6 class="project-focus-card__title">${c(M)}</h6>
        <p class="project-focus-card__description">${nt}</p>
        <div class="project-focus-card__sections">
          ${k}
        </div>
        ${G}
      </article>
    </div>
  `}function Qe(t,e){const n=j(String(t.reservationId||t.id||"-")),a=re(t.start,t.end),o=Dt(t),i=A(o),u=j(String((t.items||[]).length)),d=j(String((t.technicians||[]).length)),g=r("projects.details.reservations.itemsCount","{count} معدة").replace("{count}",u),y=r("projects.details.reservations.crewCount","{count} من الطاقم").replace("{count}",d),x=r("projects.details.reservations.view","عرض الحجز"),m=t.confirmed===!0||t.confirmed==="true",f=m?r("reservations.list.status.confirmed","✅ مؤكد"):r("reservations.list.status.pending","⏳ غير مؤكد"),h=m?"project-reservation-card__badge--confirmed":"project-reservation-card__badge--pending",S=t.paid===!0||t.paid==="paid"?r("reservations.list.payment.paid","💳 مدفوع"):r("reservations.list.payment.unpaid","💳 غير مدفوع"),p=t.paid===!0||t.paid==="paid"?"project-reservation-card__badge--paid":"project-reservation-card__badge--unpaid",v=be(t)?`<span class="badge project-reservation-card__badge project-reservation-card__badge--completed">${c(r("reservations.list.status.completed","📁 منتهي"))}</span>`:"",E=Number.isInteger(e)&&e>=0?`<button type="button" class="btn btn-sm btn-outline-primary" data-action="view-reservation" data-index="${e}">${c(x)}</button>`:"";return`
    <article class="project-reservation-card" data-reservation-index="${e}">
      <div class="project-reservation-card__header">
        <span class="project-reservation-card__id">#${c(n)}</span>
        <div class="project-reservation-card__badges">
          <span class="badge project-reservation-card__badge ${h}">${c(f)}</span>
          <span class="badge project-reservation-card__badge ${p}">${c(S)}</span>
          ${v}
        </div>
      </div>
      <div class="project-reservation-card__body">
        <div class="project-reservation-card__range">${c(a)}</div>
        <div class="project-reservation-card__meta">
          <span>💵 ${c(i)}</span>
          <span>📦 ${c(g)}</span>
          <span>😎 ${c(y)}</span>
        </div>
      </div>
      <div class="project-reservation-card__footer">
        ${E}
      </div>
    </article>
  `}function Xe(t){const e=$t(t.id).map(p=>({reservation:p,index:l.reservations.findIndex(b=>b===p)})).filter(({index:p})=>Number.isInteger(p)&&p>=0).sort((p,b)=>{const v=p.reservation.start?new Date(p.reservation.start).getTime():0;return(b.reservation.start?new Date(b.reservation.start).getTime():0)-v}),n=r("projects.details.reservations.title","الحجوزات المرتبطة"),a=r("projects.details.reservations.create","➕ إنشاء حجز مرتبط"),o=r("projects.details.reservations.empty","لا توجد حجوزات مرتبطة بهذا المشروع بعد."),i=r("projects.details.reservations.count","{count} حجوزات"),u=e.length?`<span class="badge project-reservations-count">${c(i.replace("{count}",j(String(e.length))))}</span>`:"",d=e.length>0,g=c(String(t.id)),y=['type="button"','class="btn btn-sm btn-primary"','data-action="create-reservation"',`data-project-id="${g}"`];d&&y.push("disabled",'aria-disabled="true"');const x=`<button ${y.join(" ")}>${c(a)}</button>`,m=r("projects.details.actions.edit","✏️ تعديل المشروع"),f=`<button type="button" class="btn btn-sm btn-warning" data-action="edit-project" data-project-id="${g}">${c(m)}</button>`,h=`<div class="d-flex flex-wrap gap-2">${x}${f}</div>`,S=e.length?`<div class="project-reservations-list">${e.map(({reservation:p,index:b})=>Qe(p,b)).join("")}</div>`:`<div class="alert alert-info project-reservations-empty mb-0">${c(o)}</div>`;return`
    <section class="project-reservations-section">
      <div class="project-reservations-header d-flex justify-content-between align-items-center gap-2 flex-wrap">
        <div class="d-flex align-items-center gap-2">
          <h6 class="mb-0">${c(n)}</h6>
          ${u}
        </div>
        ${h}
      </div>
      ${S}
    </section>
  `}function Ze(t){var n,a;if(!t)return;const e={projectId:t.id,customerId:t.clientId||null,start:t.start||null,end:t.end||null,forceNotes:!!t.description};try{localStorage.setItem(ve,JSON.stringify(e)),localStorage.setItem("dashboard-active-tab","reservations-tab"),localStorage.setItem("dashboard-active-sub-tab","create-tab")}catch(o){console.warn("⚠️ [projects] Unable to persist pending reservation context",o)}s.detailsModalEl&&((n=window.bootstrap)!=null&&n.Modal)&&((a=window.bootstrap.Modal.getOrCreateInstance(s.detailsModalEl))==null||a.hide()),window.location.href="dashboard.html#reservations"}function tn(t){if(!t||!s.detailsBody)return;const e=l.projects.find(d=>String(d.id)===String(t.id));if(!e)return;const n=l.customers.find(d=>String(d.id)===String(e.clientId)),a=(n==null?void 0:n.customerName)||(n==null?void 0:n.name)||e.clientName||e.customerName||"",o=e.clientCompany||(n==null?void 0:n.companyName)||(n==null?void 0:n.company)||"",i=Array.isArray(e.expenses)?e.expenses.map((d,g)=>({id:(d==null?void 0:d.id)||`expense-${e.id}-${g}-${Date.now()}`,label:(d==null?void 0:d.label)||"",amount:Number(d==null?void 0:d.amount)||0})):[],u={clientName:a,clientCompany:o,expenses:i};s.detailsBody.dataset.mode="edit",s.detailsBody.innerHTML=fn(e,u),en(e,u)}function en(t,e={expenses:[]}){var h;const n=(h=s.detailsBody)==null?void 0:h.querySelector("#project-details-edit-form");if(!n)return;const a=n.querySelector('[data-action="cancel-edit"]');a&&a.addEventListener("click",S=>{S.preventDefault(),it(t.id)});const o=n.querySelector("#project-edit-expense-label"),i=n.querySelector("#project-edit-expense-amount"),u=n.querySelector('[data-action="add-expense"]'),d=n.querySelector("#project-edit-expense-list"),g=n.querySelector('[name="project-start-date"]'),y=n.querySelector('[name="project-start-time"]'),x=n.querySelector('[name="project-end-date"]'),m=n.querySelector('[name="project-end-time"]');function f(){d&&(d.innerHTML=ie(e.expenses))}f(),u&&u.addEventListener("click",S=>{S.preventDefault();const p=(o==null?void 0:o.value.trim())||"",b=j((i==null?void 0:i.value)||"0"),v=Number(b);if(!p){T(r("projects.toast.missingExpenseLabel","⚠️ يرجى إدخال وصف المصروف")),o==null||o.focus();return}if(!Number.isFinite(v)||v<=0){T(r("projects.toast.invalidExpenseAmount","⚠️ يرجى إدخال مبلغ صحيح")),i==null||i.focus();return}e.expenses.push({id:`expense-${t.id}-${Date.now()}`,label:p,amount:v}),o&&(o.value=""),i&&(i.value=""),f()}),d&&d.addEventListener("click",S=>{const p=S.target.closest('[data-action="remove-expense"]');if(!p)return;const{id:b}=p.dataset;e.expenses=e.expenses.filter(v=>String(v.id)!==String(b)),f()}),n.addEventListener("submit",S=>{S.preventDefault();const p=n.querySelector('[name="project-title"]'),b=n.querySelector('[name="project-type"]'),v=n.querySelector('[name="project-description"]'),E=n.querySelector('[name="project-payment-status"]'),w=n.querySelector('[name="project-apply-tax"]'),L=(p==null?void 0:p.value.trim())||"",I=(b==null?void 0:b.value)||"",V=(g==null?void 0:g.value.trim())||"",C=(y==null?void 0:y.value.trim())||"",B=(v==null?void 0:v.value.trim())||"",N=(E==null?void 0:E.value)==="paid"?"paid":"unpaid",M=(w==null?void 0:w.checked)===!0;if(!L||!I||!V){T(r("projects.toast.missingRequiredFields","⚠️ يرجى تعبئة البيانات المطلوبة")),p==null||p.focus();return}const P=(x==null?void 0:x.value.trim())||"",R=(m==null?void 0:m.value.trim())||"",H=xt(V,C),_=P?xt(P,R):"",O=new Date(H),D=_?new Date(_):null;if(D&&O>D){T(r("projects.toast.invalidDateRange","⚠️ تاريخ النهاية يجب أن يكون بعد تاريخ البداية")),x==null||x.focus();return}const U=l.projects.findIndex(F=>String(F.id)===String(t.id));if(U===-1){T(r("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const J=l.projects[U],q=Number(J.equipmentEstimate)||0,Z=e.expenses.reduce((F,$)=>F+(Number($.amount)||0),0),Y=q+Z,tt=M?Number((Y*jt).toFixed(2)):0,at=M?Number((Y+tt).toFixed(2)):Y,ot={...J,title:L,type:I,start:H,end:_||null,description:B,applyTax:M,taxAmount:tt,totalWithTax:at,paymentStatus:N,expenses:e.expenses.map(F=>({...F,amount:Number(F.amount)||0})),expensesTotal:Z,updatedAt:new Date().toISOString()};l.projects[U]=ot;const et=_t(t.id,N),nt=et?{projects:l.projects,reservations:l.reservations}:{projects:l.projects};pt(nt),et&&document.dispatchEvent(new CustomEvent("reservations:changed")),T(r("projects.toast.updated","✅ تم تحديث المشروع بنجاح")),z(),st(),it(t.id)})}function nn(t){if(!s.detailsBody)return;const e=s.detailsBody.querySelector('[data-action="create-reservation"]');e&&e.addEventListener("click",()=>Ze(t));const n=s.detailsBody.querySelector('[data-action="edit-project"]');n&&n.addEventListener("click",()=>tn(t)),s.detailsBody.querySelectorAll('[data-action="view-reservation"]').forEach(a=>{const o=Number(a.dataset.index);!Number.isInteger(o)||o<0||a.addEventListener("click",()=>{typeof window.showReservationDetails=="function"?window.showReservationDetails(o):window.location.href="dashboard.html#reservations"})})}function sn(){try{const t=localStorage.getItem(Lt);if(!t)return;localStorage.removeItem(Lt),l.projects.find(n=>String(n.id)===String(t))&&it(t)}catch(t){console.warn("⚠️ [projects] Unable to open pending project detail",t),localStorage.removeItem(Lt)}}function an(){!s.focusCards||s.focusCards.dataset.listenerAttached||(s.focusCards.addEventListener("click",t=>{const e=t.target.closest("[data-action]");if(e){const{action:a,id:o}=e.dataset;if(a==="confirm-project"){t.preventDefault(),t.stopPropagation(),rn(o);return}a==="view"?it(o):a==="highlight"&&on(o);return}const n=t.target.closest(".project-focus-card");n!=null&&n.dataset.projectId&&it(n.dataset.projectId)}),s.focusCards.dataset.listenerAttached="true")}function on(t){if(!s.projectsTableBody)return;const e=`tr[data-project-id="${CSS.escape(String(t))}"]`,n=s.projectsTableBody.querySelector(e);if(!n){T(r("projects.focus.toastNotFound","⚠️ تعذّر العثور على المشروع في القائمة"));return}n.classList.add("project-row-highlight"),n.scrollIntoView({behavior:"smooth",block:"center"}),window.setTimeout(()=>{n.classList.remove("project-row-highlight")},2200)}function rn(t){var d;if(!t)return;const e=l.projects.findIndex(g=>String(g.id)===String(t));if(e===-1){T(r("projects.toast.editMissing","⚠️ تعذّر العثور على المشروع المطلوب تعديله"));return}const n=l.projects[e];if(n.confirmed===!0||n.confirmed==="true"){T(r("projects.toast.alreadyConfirmed","ℹ️ المشروع مؤكّد مسبقًا"));return}const a={...n,confirmed:!0,updatedAt:new Date().toISOString()};l.projects[e]=a;const o=cn(t),i=o?{projects:l.projects,reservations:l.reservations}:{projects:l.projects};pt(i),z(),ct(),st(),s.detailsModalEl&&s.detailsModalEl.classList.contains("show")&&((d=s.detailsBody)==null?void 0:d.dataset.projectId)===String(t)&&it(t),document.dispatchEvent(new CustomEvent("projects:changed")),o&&document.dispatchEvent(new CustomEvent("reservations:changed")),T(r("projects.toast.confirmed","✅ تم تأكيد المشروع"))}function _t(t,e){if(!t)return!1;const n=e==="paid";let a=!1;return l.reservations=l.reservations.map(o=>{if(String(o.projectId)!==String(t))return o;const i=n,u=n?"paid":"unpaid",d=o.paid===!0||o.paid==="paid",g=o.paymentStatus||(d?"paid":"unpaid");return d===n&&g===u?o:(a=!0,{...o,paid:i,paymentStatus:u})}),a}function cn(t){if(!t)return!1;let e=!1;return l.reservations=l.reservations.map(n=>String(n.projectId)!==String(t)||n.confirmed===!0||n.confirmed==="true"?n:(e=!0,{...n,confirmed:!0})),e}function Rt(t){if(!(t!=null&&t.start))return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date;return e.getFullYear()===n.getFullYear()&&e.getMonth()===n.getMonth()&&e.getDate()===n.getDate()}function ln(t){if(!(t!=null&&t.start))return!1;const e=new Date(t.start);if(Number.isNaN(e.getTime()))return!1;const n=new Date,a=new Date(n);a.setHours(0,0,0,0);const o=a.getDay(),i=o===0?6:o-1;a.setDate(a.getDate()-i);const u=new Date(a);return u.setDate(u.getDate()+7),e>=a&&e<u}const se={upcoming:"Upcoming",ongoing:"In Progress",completed:"Completed"},dn={upcoming:"bg-info",ongoing:"bg-warning",completed:"bg-success"};function It(t){const e=new Date,n=t.start?new Date(t.start):null,a=t.end?new Date(t.end):null;return n&&!Number.isNaN(n.getTime())&&n>e?"upcoming":a&&!Number.isNaN(a.getTime())&&a<e?"completed":"ongoing"}function ae(t){return typeof t.expensesTotal=="number"?t.expensesTotal:Array.isArray(t.expenses)?t.expenses.reduce((e,n)=>e+(Number(n.amount)||0),0):0}function vt(t){const e=Number(t==null?void 0:t.equipmentEstimate)||0,n=ae(t),a=e+n,o=Number(a.toFixed(2)),i=(t==null?void 0:t.applyTax)===!0||(t==null?void 0:t.applyTax)==="true";let u=i?Number(t==null?void 0:t.taxAmount):0;i?(!Number.isFinite(u)||u<0)&&(u=Number((o*jt).toFixed(2))):u=0;let d=i?Number(t==null?void 0:t.totalWithTax):o;return i?(!Number.isFinite(d)||d<=0)&&(d=Number((o+u).toFixed(2))):d=o,{equipmentEstimate:e,expensesTotal:n,subtotal:o,applyTax:i,taxAmount:u,totalWithTax:d}}function oe(t,e){return t?t.length<=e?t:`${t.slice(0,e).trim()}…`:""}function st(){const t=l.projects.length,e=l.projects.filter(o=>{const i=o.start?new Date(o.start):null;return!i||Number.isNaN(i.getTime())?!1:i>new Date}).length,n=l.projects.reduce((o,i)=>o+vt(i).expensesTotal,0),a=l.projects.reduce((o,i)=>o+vt(i).totalWithTax,0);s.projectsCount&&(s.projectsCount.textContent=j(String(t))),s.projectsUpcoming&&(s.projectsUpcoming.textContent=j(String(e))),s.projectsExpenses&&(s.projectsExpenses.textContent=A(n)),s.projectsBudget&&(s.projectsBudget.textContent=A(a))}function un(){return l.expenses.reduce((t,e)=>t+(Number(e.amount)||0),0)}function pn(){return l.selectedEquipment.reduce((t,e)=>{const n=l.equipment.find(o=>String(o.barcode||"")===String(e.barcode)),a=Number((n==null?void 0:n.price)||(n==null?void 0:n.daily_rate)||(n==null?void 0:n.dailyRate)||0);return t+a*(e.qty||1)},0)}function re(t,e){if(!t)return"—";const n=X(t);return e?`${n} - ${X(e)}`:n}function Ht(t){if(!t||typeof t!="string")return{date:"",time:""};const[e="",n=""]=t.split("T"),a=n?n.slice(0,5):"";return{date:e,time:a}}function mn(t){const e=["commercial","coverage","photography","social"],n=e.map(o=>{const i=c(r(`projects.form.types.${o}`,o)),u=String(o)===String(t)?" selected":"";return`<option value="${o}"${u}>${i}</option>`});if(t&&!e.includes(t)){const o=c(mt(t));n.push(`<option value="${c(t)}" selected>${o}</option>`)}return`<option value="">${c(r("projects.form.placeholders.type","اختر نوع المشروع"))}</option>${n.join("")}`}function fn(t,e={clientName:"",clientCompany:"",expenses:[]}){const n=r("projects.form.labels.title","اسم المشروع"),a=r("projects.form.labels.type","نوع المشروع"),o=r("projects.form.labels.paymentStatus","حالة الدفع"),i=r("projects.details.labels.notes","ملاحظات المشروع"),u=r("projects.form.labels.startDate","📅 تاريخ البداية"),d=r("projects.form.labels.startTime","⏰ وقت البداية"),g=r("projects.form.labels.endDate","📅 تاريخ النهاية"),y=r("projects.form.labels.endTime","⏰ وقت النهاية"),x=r("projects.form.taxLabel","شامل الضريبة (15٪)"),m=r("projects.form.labels.client","العميل"),f=r("projects.form.labels.clientCompany","شركة العميل"),h=r("projects.form.labels.expenseLabel","اسم المصروف"),S=r("projects.form.labels.expenseAmount","المبلغ (ر.س)"),p=r("projects.form.buttons.addExpense","➕ إضافة مصروف"),b=r("projects.form.placeholders.expenseLabel","مثال: رسوم موقع التصوير"),v=r("projects.details.edit.heading","تعديل المشروع"),E=r("projects.details.edit.subheading","قم بتحديث بيانات المشروع ثم احفظ التغييرات."),w=r("projects.details.edit.save","💾 حفظ التعديلات"),L=r("projects.details.edit.cancel","إلغاء"),I=r("projects.form.paymentStatus.paid","مدفوع"),V=r("projects.form.paymentStatus.unpaid","غير مدفوع"),C=t.paymentStatus==="paid"?"paid":"unpaid",B=Ht(t.start||""),N=Ht(t.end||""),M=t.description||"",P=t.applyTax===!0||t.applyTax==="true",R=e.clientName||r("projects.fallback.unknownClient","عميل غير معروف"),H=e.clientCompany||"—",_=ie(e.expenses);return`
    <div class="project-details-edit">
      <div class="project-details-header mb-3">
        <h5 class="fw-bold mb-1">${c(v)}</h5>
        <p class="text-muted small mb-0">${c(E)}</p>
      </div>
      <form id="project-details-edit-form" class="project-details-edit-form">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label" for="project-edit-title">${c(n)}</label>
            <input type="text" class="form-control" id="project-edit-title" name="project-title" value="${c(t.title||"")}" required>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="project-edit-type">${c(a)}</label>
            <select class="form-select" id="project-edit-type" name="project-type" required>
              ${mn(t.type)}
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="project-edit-client">${c(m)}</label>
            <input type="text" class="form-control" id="project-edit-client" value="${c(R)}" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="project-edit-client-company">${c(f)}</label>
            <input type="text" class="form-control" id="project-edit-client-company" value="${c(H)}" readonly>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="project-edit-start-date">${c(u)}</label>
            <input type="date" class="form-control" id="project-edit-start-date" name="project-start-date" value="${c(B.date)}" required>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="project-edit-end-date">${c(g)}</label>
            <input type="date" class="form-control" id="project-edit-end-date" name="project-end-date" value="${c(N.date)}">
          </div>
          <div class="col-md-6">
            <label class="form-label" for="project-edit-start-time">${c(d)}</label>
            <input type="time" class="form-control" id="project-edit-start-time" name="project-start-time" value="${c(B.time)}">
          </div>
          <div class="col-md-6">
            <label class="form-label" for="project-edit-end-time">${c(y)}</label>
            <input type="time" class="form-control" id="project-edit-end-time" name="project-end-time" value="${c(N.time)}">
          </div>
          <div class="col-12">
            <label class="form-label" for="project-edit-description">${c(i)}</label>
            <textarea class="form-control" id="project-edit-description" name="project-description" rows="3">${c(M)}</textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label" for="project-edit-expense-label">${c(h)}</label>
            <input type="text" class="form-control" id="project-edit-expense-label" placeholder="${c(b)}">
          </div>
          <div class="col-md-6">
            <label class="form-label" for="project-edit-expense-amount">${c(S)}</label>
            <input type="text" class="form-control" id="project-edit-expense-amount" inputmode="decimal" placeholder="0">
          </div>
          <div class="col-12 d-flex justify-content-end">
            <button type="button" class="btn btn-sm btn-primary" data-action="add-expense">${c(p)}</button>
          </div>
          <div class="col-12">
            <div id="project-edit-expense-list" class="project-edit-expense-list">
              ${_}
            </div>
          </div>
        </div>
        <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-3 mt-4">
          <div class="project-form-status d-flex flex-column flex-sm-row align-items-start align-items-sm-center gap-3 flex-grow-1">
            <div class="project-edit-payment-select">
              <label class="form-label" for="project-edit-payment-status">${c(o)}</label>
              <select class="form-select" id="project-edit-payment-status" name="project-payment-status">
                <option value="unpaid" ${C!=="paid"?"selected":""}>${c(V)}</option>
                <option value="paid" ${C==="paid"?"selected":""}>${c(I)}</option>
              </select>
            </div>
            <div class="form-check form-switch m-0 project-edit-tax"> 
              <input class="form-check-input" type="checkbox" role="switch" id="project-edit-tax" name="project-apply-tax" ${P?"checked":""}>
              <label class="form-check-label" for="project-edit-tax">${c(x)}</label>
            </div>
          </div>
          <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-outline-secondary" data-action="cancel-edit">${c(L)}</button>
            <button type="submit" class="btn btn-sm btn-primary">${c(w)}</button>
          </div>
        </div>
      </form>
    </div>
  `}function ie(t=[]){if(!Array.isArray(t)||t.length===0)return`<div class="text-muted small" data-empty>${c(r("projects.selected.emptyExpenses","لم يتم تسجيل أي مصروف"))}</div>`;const e=c(r("actions.remove","إزالة"));return t.map(n=>{const a=c((n==null?void 0:n.label)||""),o=c(A((n==null?void 0:n.amount)||0)),i=c(String((n==null?void 0:n.id)||""));return`
        <div class="project-edit-expense-item d-flex align-items-center justify-content-between gap-3 border rounded px-3 py-2 mb-2">
          <div>
            <div class="fw-semibold">${a}</div>
            <div class="text-muted small">${o}</div>
          </div>
          <button type="button" class="btn btn-sm btn-link text-danger" data-action="remove-expense" data-id="${i}" aria-label="${e}">✖</button>
        </div>
      `}).join("")}function Et(){if(!s.submitBtn)return;const t=!!l.editingProjectId,e=t?"projects.form.buttons.update":"projects.form.buttons.save",n=t?"🔁 تحديث المشروع":"🆕 إنشاء المشروع";s.submitBtn.textContent=r(e,n)}function bn(t){const e=l.projects.findIndex(o=>String(o.id)===String(t));if(e===-1||!window.confirm(r("projects.confirm.delete","هل أنت متأكد من حذف هذا المشروع؟")))return;l.projects.splice(e,1);let n=!1;const a=l.reservations.map(o=>{if(String(o.projectId)===String(t)){n=!0;const i={...o};return delete i.projectId,i}return o});l.reservations=a,pt({projects:l.projects,reservations:a}),z(),st(),T(r("projects.toast.deleted","🗑️ تم حذف المشروع")),document.dispatchEvent(new CustomEvent("projects:changed")),n&&document.dispatchEvent(new CustomEvent("reservations:changed"))}function it(t){var nt,F;const e=l.projects.find($=>String($.id)===String(t));if(!e||!s.detailsBody)return;s.detailsBody.dataset.mode="view";const n=l.customers.find($=>String($.id)===String(e.clientId)),a=mt(e.type),i=((nt=e.description)==null?void 0:nt.trim())||r("projects.fallback.noDescription","لا يوجد وصف"),u=(n==null?void 0:n.customerName)||r("projects.fallback.unknownClient","عميل غير معروف"),d=(e.clientCompany||(n==null?void 0:n.companyName)||"").trim(),g=e.projectCode||`PRJ-${j(String(e.id))}`,y=j(g),x=$t(e.id),m=x.reduce(($,k)=>$+Dt(k),0),f=Number(m.toFixed(2)),h=x.length,{subtotal:S,applyTax:p,expensesTotal:b}=vt(e),v=S,E=p?Number(((v+f)*jt).toFixed(2)):0,w=Number((v+f+E).toFixed(2)),L=It(e),I=r(`projects.status.${L}`,se[L]||L),C={upcoming:"status-pending",ongoing:"status-confirmed",completed:"status-completed"}[L]||"status-confirmed",B=p?r("projects.details.chips.vatOn","شامل الضريبة 15٪"):r("projects.details.chips.vatOff","غير شامل الضريبة"),N=p?"status-paid":"status-unpaid",M=r("projects.details.chips.reservations","{count} حجوزات").replace("{count}",j(String(h))),P=e.paymentStatus==="paid"?"paid":"unpaid",R=r(`projects.paymentStatus.${P}`,P==="paid"?"Paid":"Unpaid"),H=P==="paid"?"status-paid":"status-unpaid",_=r("projects.focus.confirmed","✅ مشروع مؤكد"),O=e.confirmed===!0||e.confirmed==="true"?`<span class="reservation-chip status-confirmed">${c(_)}</span>`:"",D=[];D.push({icon:"💳",label:r("projects.details.summary.paymentStatus","حالة الدفع"),value:R}),D.push({icon:"💼",label:r("projects.details.summary.projectSubtotal","إجمالي المشروع"),value:A(v)});const U=A(f);D.push({icon:"🔗",label:r("projects.details.summary.reservationsTotal","إجمالي المعدات / طاقم العمل"),value:U}),D.push({icon:"🧮",label:r("projects.details.summary.combinedTax","إجمالي الضريبة الكلية (15٪)"),value:A(E)}),D.push({icon:"💰",label:r("projects.details.summary.overallTotal","الإجمالي الكلي"),value:A(w)});const J=D.map(({icon:$,label:k,value:G})=>`
    <div class="summary-details-row">
      <span class="summary-details-label">${$} ${c(k)}</span>
      <span class="summary-details-value">${c(G)}</span>
    </div>
  `).join(""),q=[];q.push({icon:"🆔",label:r("projects.details.labels.code","رقم المشروع"),value:`#${y}`}),q.push({icon:"👤",label:r("projects.details.client","العميل"),value:u}),d&&q.push({icon:"🏢",label:r("projects.details.company","شركة العميل"),value:d}),q.push({icon:"🏷️",label:r("projects.details.type","نوع المشروع"),value:a}),q.push({icon:"🗓️",label:r("projects.details.labels.start","تاريخ البداية"),value:X(e.start)}),q.push({icon:"🗓️",label:r("projects.details.labels.end","تاريخ النهاية"),value:e.end?X(e.end):"—"}),q.push({icon:"🔗",label:r("projects.details.labels.reservationsCount","عدد الحجوزات"),value:j(String(h))});const Z=($,k,G)=>`
    <div class="res-info-row">
      <span class="label">${$} ${c(k)}</span>
      <span class="separator">:</span>
      <span class="value">${c(G)}</span>
    </div>
  `,Y=q.map(({icon:$,label:k,value:G})=>Z($,k,G)).join(""),tt=r("projects.details.expenses","المصروفات ({amount})").replace("{amount}",A(b)),at=b>0?`<ul class="project-details-list">${(e.expenses||[]).map($=>`
        <li>
          <span class="project-expense-label">${c($.label)}</span>
          <span class="project-expense-amount">${A($.amount)}</span>
        </li>
      `).join("")}</ul>`:`<div class="text-muted">${c(r("projects.details.noItems","لا يوجد"))}</div>`,ot=Xe(e),et=`<span class="project-code-badge">#${c(y)}</span>`;s.detailsBody.dataset.projectId=String(e.id),s.detailsBody.innerHTML=`
    <div class="project-details-header mb-4">
      <div class="d-flex flex-column flex-lg-row justify-content-between gap-3">
        <div>
          <h5 class="mb-2 d-flex flex-wrap align-items-center gap-2">
            <span class="text-muted project-details-title-label">${c(r("projects.details.labels.projectTitle","اسم المشروع"))}:</span>
            <span class="fw-bold project-details-title-text">${c(e.title)}</span>
            ${et}
          </h5>
        </div>
        <div class="status-chips d-flex flex-wrap gap-2">
          <span class="status-chip ${C}">${c(I)}</span>
          <span class="status-chip ${N}">${c(B)}</span>
          <span class="reservation-chip ${H}">${c(R)}</span>
          <span class="reservation-chip status-confirmed">${c(M)}</span>
          ${O}
        </div>
      </div>
    </div>
    <div class="project-details-info mb-4">
      ${Y}
    </div>
    <div class="project-details-section mb-4">
      <h6>${c(r("projects.details.labels.notes","ملاحظات المشروع"))}</h6>
      <div class="project-notes">${c(i)}</div>
    </div>
    <div class="project-details-section mb-4">
      <h6>${c(tt)}</h6>
      ${at}
    </div>
    <div class="project-details-summary summary-details mb-4">
      ${J}
    </div>
    ${ot}
  `,nn(e),(F=window.bootstrap)!=null&&F.Modal&&s.detailsModalEl&&window.bootstrap.Modal.getOrCreateInstance(s.detailsModalEl).show()}function c(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function A(t){const e=Number(t)||0,n=Ut(),a=n==="ar"?"ar-SA":"en-US",o=new Intl.NumberFormat(a,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(e)),i=n==="ar"?"ر.س":"SAR";return`${j(o)} ${i}`}function X(t){if(!t)return"—";const e=new Date(t);if(Number.isNaN(e.getTime()))return"—";const n=String(e.getDate()).padStart(2,"0"),a=String(e.getMonth()+1).padStart(2,"0"),o=String(e.getFullYear()),i=String(e.getMinutes()).padStart(2,"0"),u=e.getHours(),d=u>=12?"PM":"AM",g=u%12||12,y=String(g).padStart(2,"0"),x=`${n}/${a}/${o} ${y}:${i} ${d}`;return j(x)}function gn(t){const e=Ut(),n=j(String(t));return e==="en"?`${n} ${t===1?"project":"projects"}`:`${n} مشروع`}function Ot(t){s.tableCount&&(s.tableCount.dataset.count=String(t),s.tableCount.textContent=gn(t))}function ce(t){if(!t)return"";const e=t.dataset.emptyKey,n=t.dataset.empty||"";return e?r(e,n):n}
