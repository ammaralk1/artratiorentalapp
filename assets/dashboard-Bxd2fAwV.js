import{t as l,g as P,n as g,f as R,s as E,a as Ut,c as zt,i as Wt,l as Gt}from"./auth-CNAfl19F.js";import{l as M,s as Kt}from"./storage-DOnDLvtb.js";import{i as wt,s as Qt,r as et,a as nt,l as Jt,u as Zt}from"./controller-DfdUmPnp.js";import{r as Xt}from"./customers-JnWiO8yC.js";import{s as St}from"./events-BbKR8R1v.js";import{s as te,c as ee,r as ne}from"./reservationsSummary-CBdNx1nm.js";let U=null,ft=!1;function ae(t){const e=t.paid===!0||t.paid==="paid",n=t.confirmed===!0||t.confirmed==="true";return t.completed?{background:"#6c757d",border:"#565e64",text:"#fff"}:e?n?{background:"#198754",border:"#146c43",text:"#fff"}:{background:"#ffc107",border:"#cc9a06",text:"#212529"}:{background:"#dc3545",border:"#b02a37",text:"#fff"}}function oe(t){const{reservationId:e,customerName:n,paid:a,confirmed:s,completed:o}=t.event.extendedProps,c=a===!0||a==="paid",r=s===!0||s==="true",u=document.createElement("div");u.className="fc-reservation-event";const i=r?l("calendar.badges.confirmed","مؤكد"):l("calendar.badges.pending","غير مؤكد"),f=c?l("calendar.badges.paid","مدفوع"):l("calendar.badges.unpaid","غير مدفوع"),m=l("calendar.badges.completed","منتهي"),d=l("calendar.labels.unknownCustomer","غير معروف");return u.innerHTML=`
    <div class="fc-reservation-id">${e}</div>
    <div class="fc-reservation-customer">${n||d}</div>
    <div class="fc-reservation-tags">
      <span class="badge ${r?"bg-success":"bg-warning text-dark"}">${i}</span>
      <span class="badge ${c?"bg-primary":"bg-danger"}">${f}</span>
      ${o?`<span class="badge bg-secondary">${m}</span>`:""}
    </div>
  `,{domNodes:[u]}}function se(t){var pt;const e=document.getElementById("calendar-reservation-details");if(!e){alert(l("calendar.alerts.cannotShowDetails","لا يمكن عرض تفاصيل الحجز"));return}const n=t.confirmed===!0||t.confirmed==="true",a=t.paid===!0||t.paid==="paid",s=!!t.completed,o=n?l("calendar.badges.confirmed","مؤكد"):l("calendar.badges.pending","غير مؤكد"),c=a?l("calendar.badges.paid","مدفوع"):l("calendar.badges.unpaid","غير مدفوع"),r=l("calendar.badges.completed","منتهي"),u=P(),i=t.items||[],f=te()||[],m=new Map(f.map(p=>[String(p.id),p])),d=(t.technicians||[]).map(p=>m.get(String(p))).filter(Boolean),y=ee(t.start,t.end),w=i.reduce((p,$)=>p+($.qty||1)*($.price||0),0)*y,h=(p={})=>{const $=[p.dailyWage,p.daily_rate,p.dailyRate,p.wage,p.rate];for(const D of $){if(D==null)continue;const V=parseFloat(g(String(D)));if(Number.isFinite(V))return V}return 0},O=d.reduce((p,$)=>p+h($),0)*y,Y=w+O,C=(()=>{const p=parseFloat(t.discount)||0;return p?t.discountType==="amount"?p:Y*(p/100):0})(),it=Math.max(0,Y-C),K=t.applyTax?it*.15:0,Nt=t.cost??Math.round(it+K),ut=l("calendar.labels.currencySuffix","ريال"),At=i.length?i.map((p,$)=>{const D=p.image||p.imageUrl||p.img||"",V=g(String(p.barcode||"-")),Yt=g(String(p.qty||1)),_t=g(String(p.price||0)),Vt=D?`<img src="${D}" alt="${p.desc||""}" class="reservation-modal-item-thumb">`:"-";return`
          <tr>
            <td>${g(String($+1))}</td>
            <td>${V}</td>
            <td>${p.desc||"-"}</td>
            <td>${Yt}</td>
            <td>${_t} ${ut}</td>
            <td>${Vt}</td>
          </tr>
        `}).join(""):`<tr><td colspan="6" class="text-center">${l("calendar.labels.noEquipment","لا توجد معدات")}</td></tr>`,_=[`<div>${l("calendar.summary.baseCost","💵 إجمالي المعدات: <strong>{value} ريال</strong>").replace("{value}",w.toFixed(2))}</div>`,`<div>${l("calendar.summary.crewTotal","😎 إجمالي الفريق: <strong>{value} ريال</strong>").replace("{value}",O.toFixed(2))}</div>`,`<div>${l("calendar.summary.duration","⏱️ عدد الأيام: <strong>{value}</strong>").replace("{value}",g(String(y)))}</div>`];if(C>0){const p=u==="en"?"%":"٪",$=t.discountType==="percent"?`${parseFloat(t.discount||0).toFixed(2)}${p}`:`${C.toFixed(2)} ${ut}`;_.push(`<div>${l("calendar.summary.discount","💸 الخصم: <strong>{value}</strong>").replace("{value}",$)}</div>`)}t.applyTax&&K>0&&_.push(`<div>${l("calendar.summary.tax","🧾 الضريبة (15%): <strong>{value} ريال</strong>").replace("{value}",K.toFixed(2))}</div>`),_.push(`<div>${l("calendar.summary.total","💰 المجموع النهائي: <strong>{value} ريال</strong>").replace("{value}",Nt.toFixed(2))}</div>`);const Rt=g(String(t.reservationId??t.id??"")),Ft=t.start?g(R(t.start)):"-",Ht=t.end?g(R(t.end)):"-",Pt=t.notes?g(t.notes):l("calendar.labels.noNotes","لا توجد ملاحظات"),jt=t.customerName||l("calendar.labels.unknownCustomer","غير معروف"),Ot=[{icon:"🆔",label:l("calendar.labels.reservationId","رقم الحجز"),value:Rt},{icon:"👤",label:l("calendar.labels.customer","العميل"),value:jt},{icon:"🗓️",label:l("calendar.labels.start","بداية الحجز"),value:Ft},{icon:"🗓️",label:l("calendar.labels.end","نهاية الحجز"),value:Ht},{icon:"📝",label:l("calendar.labels.notes","الملاحظات"),value:Pt}];e.innerHTML=`
    <div class="calendar-reservation-status mb-3">
      <span class="badge ${n?"bg-success":"bg-warning text-dark"}">${o}</span>
      <span class="badge ${a?"bg-primary":"bg-danger"}">${c}</span>
      ${s?`<span class="badge bg-secondary">${r}</span>`:""}
    </div>
    <div class="calendar-reservation-info">
      ${Ot.map(p=>`
        <div class="calendar-info-row">
          <span class="label">${p.icon} ${p.label}</span>
          <span class="value">${p.value}</span>
        </div>
      `).join("")}
    </div>
    <h6 class="calendar-section-title">${l("calendar.sections.crew","😎 الفريق الفني")}</h6>
    ${d.length?`<ul class="list-unstyled calendar-reservation-technicians">${d.map(p=>{const $=p.role?` — ${p.role}`:"";return`<li><strong>${p.name}</strong>${$}</li>`}).join("")}</ul>`:`<p class="calendar-empty-state">${l("calendar.emptyStates.noCrew","😎 لا يوجد فريق مرتبط بهذا الحجز.")}</p>`}
    <h6 class="calendar-section-title">${l("calendar.sections.equipment","📦 المعدات")}</h6>
    <div class="table-responsive reservation-modal-items-wrapper">
      <table class="table table-sm table-hover align-middle reservation-modal-items-table">
        <thead>
          <tr>
            <th>#</th>
            <th>${l("calendar.table.headers.barcode","الباركود")}</th>
            <th>${l("calendar.table.headers.description","الوصف")}</th>
            <th>${l("calendar.table.headers.quantity","الكمية")}</th>
            <th>${l("calendar.table.headers.price","السعر")}</th>
            <th>${l("calendar.table.headers.image","الصورة")}</th>
          </tr>
        </thead>
        <tbody>${At}</tbody>
      </table>
    </div>
    <div class="calendar-reservation-summary">
      ${_.join("")}
    </div>
  `;const mt=document.getElementById("calendarReservationModal");mt&&((pt=window.bootstrap)!=null&&pt.Modal)?window.bootstrap.Modal.getOrCreateInstance(mt).show():alert(l("calendar.alerts.cannotOpenModal","لا يمكن فتح نافذة التفاصيل"))}function at(){console.log("✅ renderCalendar تعمل");const t=document.getElementById("calendar");if(!t)return;U&&(U.destroy(),U=null);const{reservations:e=[],customers:n=[]}=M(),a=e.map(o=>{const c=n.find(i=>String(i.id)===String(o.customerId)),r=o.end?new Date(o.end)<new Date:!1,u=ae({...o,completed:r});return{id:o.id,title:"",start:o.start,end:o.end,backgroundColor:u.background,borderColor:u.border,textColor:u.text,display:"auto",extendedProps:{...o,customerName:(c==null?void 0:c.customerName)||l("calendar.labels.unknownCustomer","غير معروف"),completed:r}}}),s=new FullCalendar.Calendar(t,{initialView:"dayGridMonth",locale:P(),timeZone:"local",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek,timeGridDay"},buttonText:{today:l("calendar.buttons.today","اليوم"),month:l("calendar.buttons.month","شهر"),week:l("calendar.buttons.week","أسبوع"),day:l("calendar.buttons.day","يوم")},events:a,eventContent:oe,eventClick:function(o){se(o.event.extendedProps)}});s.render(),U=s,ft||(document.addEventListener("language:changed",()=>{at()}),ft=!0)}let gt=null,Q=null,J=null;const ce={range:"last30",search:"",start:null,end:null};function b(t,e,n=e){const a=P()==="en"?n??e:e;return l(t,a)}function ot(){return(P()||"ar").toLowerCase().startsWith("ar")?"ar-EG":"en-US"}function Tt(){const t=P();if(t!==gt||!Q||!J){gt=t;const e=ot();Q=new Intl.NumberFormat(e,{maximumFractionDigits:0}),J=new Intl.NumberFormat(e,{style:"currency",currency:"SAR",maximumFractionDigits:0})}return{numberFormatter:Q,currencyFormatter:J}}function re(t){const e=ot();return new Intl.DateTimeFormat(e,{month:"short"}).format(t)}function le(){const{reservations:t=[],customers:e=[],equipment:n=[],technicians:a=[]}=M(),s=de(t,ce,e,n,a),o=ge(s),c=be(s),r=ye(s),u=he(s),i=Ee(s,e),f=$e(s,n);Le(o),Se(c),yt("reports-status-breakdown",r),yt("reports-payment-breakdown",u),Te(i),Ie(f),we(s,e,a),qe(s.length===0)}function It(t){return g(String(t||"")).toLowerCase().trim()}function de(t,e,n,a,s){const{startDate:o,endDate:c}=ue(e),r=It(e.search),u=!!r,i=new Map((n||[]).map(d=>[String(d.id),d])),f=new Map((a||[]).map(d=>[z(d==null?void 0:d.barcode),d])),m=new Map((s||[]).map(d=>[String(d.id),d]));return(t||[]).filter(d=>{const y=d!=null&&d.start?new Date(d.start):null;return!(!y||Number.isNaN(y.getTime())||o&&y<o||c&&y>c||(j(d),W(d),u&&!ie(d,r,i,f,m)))})}function ie(t,e,n,a,s){const o=[],c=(t==null?void 0:t.reservationId)||(t==null?void 0:t.id);c&&o.push(c),t!=null&&t.notes&&o.push(t.notes);const r=j(t);r&&o.push(r);const u=(t==null?void 0:t.paymentStatus)||(t==null?void 0:t.payment_status);u&&o.push(u),(t==null?void 0:t.paid)!=null&&o.push(t.paid?"paid":"unpaid");const i=n.get(String(t==null?void 0:t.customerId));return i&&o.push(i.customerName,i.company_name||i.companyName,i.contact_person||""),o.push(kt(t)),((t==null?void 0:t.items)||[]).forEach(m=>{m!=null&&m.desc&&o.push(m.desc),m!=null&&m.barcode&&o.push(m.barcode);const d=a.get(z(m==null?void 0:m.barcode));d&&o.push(d.desc,d.description,d.name)}),((t==null?void 0:t.technicians)||[]).forEach(m=>{const d=s.get(String(m));d&&o.push(d.name,d.role,d.department)}),It(o.filter(Boolean).join(" ")).includes(e)}function ue({range:t,start:e,end:n}){const a=new Date;a.setHours(23,59,59,999);const s=new Date(a);let o=null;switch(t){case"last30":{o=new Date(a),o.setDate(o.getDate()-29);break}case"thisWeek":{const c=new Date(a),u=(c.getDay()-6+7)%7;c.setDate(c.getDate()-u),c.setHours(0,0,0,0);const i=new Date(c);i.setDate(c.getDate()+6),i.setHours(23,59,59,999),o=c,s.setTime(i.getTime());break}case"thisMonth":{o=new Date(a.getFullYear(),a.getMonth(),1);const c=new Date(a.getFullYear(),a.getMonth()+1,0);s.setTime(c.setHours(23,59,59,999));break}case"thisQuarter":{const c=Math.floor(a.getMonth()/3);o=new Date(a.getFullYear(),c*3,1);const r=new Date(a.getFullYear(),(c+1)*3,0);s.setTime(r.setHours(23,59,59,999));break}case"thisYear":{o=new Date(a.getFullYear(),0,1);const c=new Date(a.getFullYear(),12,0);s.setTime(c.setHours(23,59,59,999));break}case"all":default:o=null,s=null;break}return o&&o.setHours(0,0,0,0),{startDate:o,endDate:s}}function me(t){const e=j(t);return e==="confirmed"||e==="completed"?!0:(t==null?void 0:t.confirmed)===!0||(t==null?void 0:t.confirmed)==="true"}const pe=new Map([["confirmed","confirmed"],["مؤكد","confirmed"],["مؤكدة","confirmed"],["approved","confirmed"],["pending","pending"],["قيد التأكيد","pending"],["غير مؤكد","pending"],["in-progress","pending"],["awaiting","pending"],["completed","completed"],["منتهي","completed"],["منتهية","completed"],["done","completed"],["finished","completed"],["cancelled","cancelled"],["ملغي","cancelled"]]),bt=new Map([["paid",!0],["مدفوع",!0],["مدفوعة",!0],["تم الدفع",!0],["completed",!0],["unpaid",!1],["غير مدفوع",!1],["غير مدفوعة",!1],["pending",!1],["قيد الدفع",!1]]);function fe(t=""){const e=String(t).toLowerCase().trim();return e?pe.get(e)||e:""}function W(t){const e=[t==null?void 0:t.paymentStatus,t==null?void 0:t.payment_status,t==null?void 0:t.payment,t==null?void 0:t.paymentState,t==null?void 0:t.payment_state];for(const n of e){const a=String(n||"").toLowerCase().trim();if(a&&bt.has(a))return bt.get(a)}return(t==null?void 0:t.paid)===!0||(t==null?void 0:t.paid)==="true"}function j(t){const e=[t==null?void 0:t.status,t==null?void 0:t.reservationStatus,t==null?void 0:t.reservation_status,t==null?void 0:t.state];for(const n of e){const a=fe(n);if(a)return a==="cancelled"?"pending":a}return wt(t)?"completed":(t==null?void 0:t.confirmed)===!0||(t==null?void 0:t.confirmed)==="true"?"confirmed":"pending"}function ge(t){const e=t.length,n=t.filter(me).length,a=t.filter(wt).length,s=t.filter(W).length,o=t.reduce((r,u)=>r+(Number(u==null?void 0:u.cost)||0),0),c=e?o/e:0;return{total:e,confirmed:n,completed:a,paidCount:s,revenue:o,average:c}}function be(t){const e=new Date,n=[];for(let a=5;a>=0;a-=1){const s=new Date(e.getFullYear(),e.getMonth()-a,1),o=s.getFullYear(),c=s.getMonth(),r=t.filter(m=>{const d=m!=null&&m.start?new Date(m.start):null;return d&&d.getFullYear()===o&&d.getMonth()===c}),u=r.length,i=r.reduce((m,d)=>m+(Number(d==null?void 0:d.cost)||0),0),f=re(s);n.push({label:f,count:u,revenue:i})}return n}function ye(t){const e={confirmed:0,pending:0,completed:0};(t||[]).forEach(c=>{const r=j(c);r==="completed"?e.completed+=1:r==="confirmed"?e.confirmed+=1:e.pending+=1});const n=Math.max(1,(t||[]).length),a=e.confirmed,s=e.pending,o=e.completed;return[{label:b("reservations.reports.status.confirmedLabel","مؤكدة","Confirmed"),value:a,percent:Math.round(a/n*100)||0,rawCount:a,className:"status-confirmed"},{label:b("reservations.reports.status.pendingLabel","قيد التأكيد","Pending confirmation"),value:s,percent:Math.round(s/n*100)||0,rawCount:s,className:"status-pending"},{label:b("reservations.reports.status.completedLabel","منتهية","Completed"),value:o,percent:Math.round(o/n*100)||0,rawCount:o,className:"status-completed"}]}function he(t){const e=t.length||1,n=t.filter(W).length,a=t.length-n;return[{label:b("reservations.reports.payment.paidLabel","مدفوعة","Paid"),value:n,percent:Math.round(n/e*100)||0,rawCount:n,className:"status-paid"},{label:b("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid"),value:a,percent:Math.round(a/e*100)||0,rawCount:a,className:"status-unpaid"}]}function Ee(t,e){const n=new Map,a=new Map((e||[]).map(s=>[String(s.id),s]));return t.forEach(s=>{const o=String((s==null?void 0:s.customerId)??"unknown"),c=n.get(o)||{count:0,revenue:0};c.count+=1,c.revenue+=Number(s==null?void 0:s.cost)||0,n.set(o,c)}),Array.from(n.entries()).map(([s,o])=>{const c=a.get(s);return{name:(c==null?void 0:c.customerName)||b("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),count:o.count,revenue:o.revenue}}).sort((s,o)=>o.revenue-s.revenue).slice(0,5)}function $e(t,e){const n=new Map,a=new Map((e||[]).map(s=>[z(s==null?void 0:s.barcode),s]));return t.forEach(s=>{((s==null?void 0:s.items)||[]).forEach(o=>{var d,y;const c=z(o==null?void 0:o.barcode),r=c||((o==null?void 0:o.desc)??"unknown"),u=(o==null?void 0:o.desc)||((d=a.get(c))==null?void 0:d.desc)||((y=a.get(c))==null?void 0:y.description)||b("reservations.reports.topEquipment.unknown","معدة بدون اسم","Unnamed equipment"),i=Number(o==null?void 0:o.qty)||1,f=i*(Number(o==null?void 0:o.price)||0),m=n.get(r)||{name:u,count:0,revenue:0};m.name=u,m.count+=i,m.revenue+=f,n.set(r,m)})}),Array.from(n.values()).sort((s,o)=>o.count-s.count).slice(0,5)}function we(t,e,n){const a=document.getElementById("reports-reservations-body");if(!a)return;if(!t||t.length===0){a.innerHTML=`<tr><td colspan="6" class="text-muted">${b("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}const s=new Map((e||[]).map(r=>[String(r.id),r])),o=new Map((n||[]).map(r=>[String(r.id),r])),c=[...t].sort((r,u)=>new Date(u.start||0)-new Date(r.start||0)).slice(0,20).map(r=>ke(r,s,o));a.innerHTML=c.map(r=>`
      <tr>
        <td>${r.code}</td>
        <td>${r.customer}</td>
        <td>${r.date}</td>
        <td>${r.status}</td>
        <td>${r.payment}</td>
        <td>${r.total}</td>
      </tr>
    `).join("")}function Se(t){const e=document.getElementById("reports-volume-chart");if(!e)return;if(!t||t.length===0){e.innerHTML=`<p class="text-muted">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}const n=Math.max(1,...t.map(a=>a.count));e.innerHTML=t.map(a=>`
        <div class="reports-chart-bar">
          <div class="bar" style="height: ${Math.max(8,Math.round(a.count/n*100))}%"></div>
          <span class="value">${B(a.count)}</span>
          <span class="label">${a.label}</span>
        </div>
      `).join("")}function yt(t,e){const n=document.getElementById(t);if(n){if(!e||e.length===0){n.innerHTML=`<p class="text-muted">${b("reservations.reports.progress.empty","لا توجد بيانات لعرضها.","No data to display.")}</p>`;return}n.innerHTML=e.map(a=>`
      <div class="reports-progress-row">
        <div class="reports-progress-top">
          <span>${a.label}</span>
          <span>${B(a.percent)}%</span>
        </div>
        <div class="reports-progress-bar">
          <div class="reports-progress-fill ${a.className}" style="width: ${Math.min(a.percent,100)}%"></div>
        </div>
        <div class="reports-progress-meta">${b("reservations.reports.progress.meta","{count} حجز","{count} reservations").replace("{count}",B(a.rawCount??a.value))}</div>
      </div>
    `).join("")}}function Te(t){const e=document.getElementById("reports-top-customers");if(e){if(!t||t.length===0){e.innerHTML=`<tr><td colspan="3" class="text-muted">${b("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}e.innerHTML=t.map(n=>`
      <tr>
        <td>${n.name}</td>
        <td>${B(n.count)}</td>
        <td>${F(n.revenue)}</td>
      </tr>
    `).join("")}}function Ie(t){const e=document.getElementById("reports-top-equipment");if(e){if(!t||t.length===0){e.innerHTML=`<tr><td colspan="3" class="text-muted">${b("reservations.reports.table.emptyPeriod","لا توجد بيانات في هذه الفترة.","No data for this period.")}</td></tr>`;return}e.innerHTML=t.map(n=>`
      <tr>
        <td>${n.name}</td>
        <td>${B(n.count)}</td>
        <td>${F(n.revenue)}</td>
      </tr>
    `).join("")}}function ke(t,e,n){const a=(t==null?void 0:t.reservationId)||(t==null?void 0:t.id)||"—",s=e.get(String(t==null?void 0:t.customerId)),o=(s==null?void 0:s.customerName)||b("reservations.reports.topCustomers.unknown","عميل غير معروف","Unknown customer"),c=Be(t==null?void 0:t.start),r=ve(t),u=kt(t),i=F((t==null?void 0:t.cost)||0),f=((t==null?void 0:t.technicians)||[]).map(S=>{var w;return(w=n.get(String(S)))==null?void 0:w.name}).filter(Boolean),m=b("reservations.list.crew.separator","، ",", "),d=f.map(S=>I(S)).join(I(m)),y=f.length?`${I(o)}<br><small class="text-muted">${d}</small>`:I(o);return{code:I(a),customer:y,date:I(c),status:I(r),payment:I(u),total:I(i)}}function kt(t){return W(t)?b("reservations.reports.payment.paidLabel","مدفوعة","Paid"):b("reservations.reports.payment.unpaidLabel","غير مدفوعة","Unpaid")}function ve(t){const e=j(t);return e==="completed"?b("reservations.list.status.completed","📁 منتهي","Completed"):e==="confirmed"?b("reservations.list.status.confirmed","✅ مؤكد","Confirmed"):e==="pending"?b("reservations.list.status.pending","⏳ غير مؤكد","Pending"):I(e)}function Be(t){if(!t)return"—";const e=new Date(t);if(Number.isNaN(e.getTime()))return"—";const n=ot(),a=new Intl.DateTimeFormat(n,{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return g(a.format(e))}function Le(t){const e=document.getElementById("reports-kpi-total"),n=document.getElementById("reports-kpi-total-meta"),a=document.getElementById("reports-kpi-revenue"),s=document.getElementById("reports-kpi-revenue-meta"),o=document.getElementById("reports-kpi-confirmed"),c=document.getElementById("reports-kpi-confirmed-meta"),r=document.getElementById("reports-kpi-paid"),u=document.getElementById("reports-kpi-paid-meta"),i=t.total||0,f=t.revenue||0,m=t.confirmed||0,d=t.paidCount||0,y=t.average||0,S=i?Math.round(m/i*100):0,w=i?Math.round(d/i*100):0;if(e&&(e.textContent=B(i)),n){const h=b("reservations.reports.kpi.total.dynamicMeta","منها {count} منتهية","Includes {count} completed").replace("{count}",B(t.completed||0));n.textContent=h}if(a&&(a.textContent=F(f)),s){const h=b("reservations.reports.kpi.revenue.average","متوسط قيمة الحجز {value}","Average reservation value {value}").replace("{value}",F(y));s.textContent=h}if(o&&(o.textContent=`${S}%`),c){const h=b("reservations.reports.kpi.confirmed.detail","{count} حجوزات مؤكدة","{count} confirmed reservations").replace("{count}",B(m));c.textContent=h}if(r&&(r.textContent=`${w}%`),u){const h=b("reservations.reports.kpi.paid.detail","{count} حجوزات مدفوعة","{count} paid reservations").replace("{count}",B(d));u.textContent=h}}function qe(t){const e=document.getElementById("reports-empty-state");e&&e.classList.toggle("active",!!t)}function I(t=""){return String(t).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}function B(t){const{numberFormatter:e}=Tt(),n=e.format(Math.round(t||0));return g(n)}function F(t){const{currencyFormatter:e}=Tt(),n=e.format(Math.max(0,Math.round(t||0)));return g(n)}function z(t){return(t||"").toString().trim()}let H=[],q=[],N=null;function Z(){return l("maintenance.form.selectedInfo","لم يتم اختيار معدة بعد.")}function k(t){return g(String(t||"")).trim().toLowerCase()}function ht(t=""){return g(String(t)).trim().toLowerCase()}function v(){const{maintenance:t=[]}=M();return H=Array.isArray(t)?t:[],H}function st(t){H=t;try{localStorage.setItem("maintenanceList",JSON.stringify(t))}catch(e){console.warn("⚠️ [maintenance] Failed to persist maintenance tickets",e),E(l("maintenance.toast.storageError","⚠️ تعذر حفظ بيانات الصيانة. يرجى المحاولة مجدداً."))}}function ct(){const{equipment:t=[]}=M(),e=l("maintenance.table.noName","بدون اسم");return q=(t||[]).map(n=>({barcode:k(n==null?void 0:n.barcode),desc:(n==null?void 0:n.desc)||(n==null?void 0:n.description)||(n==null?void 0:n.name)||e,status:(n==null?void 0:n.status)||"متاح",price:Number(n==null?void 0:n.price)||0,category:(n==null?void 0:n.category)||""})),q.sort((n,a)=>n.desc.localeCompare(a.desc,"ar",{sensitivity:"base"})),q}function vt(){return new Set(v().filter(t=>t.status==="open").map(t=>k(t.equipmentBarcode)))}function G(t){const e=k(t);return e&&(q.length?q:ct()).find(a=>a.barcode===e)||null}function xe(t){const e=ht(t);return e&&(q.length?q:ct()).find(a=>ht(a.desc).includes(e))||null}function X(t){if(!t)return!0;const e=vt();return t.status==="صيانة"||e.has(t.barcode)}function L({keepInputs:t=!1,silent:e=!1}={}){const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),s=document.getElementById("maintenance-equipment-search"),o=document.getElementById("maintenance-selected-info");n&&(n.value=""),t||(a&&(a.value=""),s&&(s.value="")),o&&(o.textContent=Z()),N=null}function Bt(t){const e=document.getElementById("maintenance-selected-info");if(!e)return;const n=l("maintenance.info.barcodeLabel","باركود"),a=l("maintenance.report.notAvailable","غير متوفر");e.innerHTML=`
    <strong>${t.desc}</strong><br>
    <span class="text-muted">${n}: ${t.barcode||a}</span>
  `}function rt(t,{silent:e=!1}={}){if(!t)return!1;if(X(t))return e||E(l("maintenance.toast.equipmentBlocked","⚠️ هذه المعدة قيد الصيانة ولا يمكن اختيارها حالياً")),!1;const n=document.getElementById("maintenance-selected-barcode"),a=document.getElementById("maintenance-equipment-barcode"),s=document.getElementById("maintenance-equipment-search");return n&&(n.value=t.barcode),a&&(a.value=t.barcode),s&&(s.value=t.desc),Bt(t),N=t,!0}function Lt(t,{showFeedback:e=!0}={}){const n=G(t);return n?rt(n,{silent:!e}):(e&&E(l("maintenance.toast.equipmentNotFoundBarcode","❌ لم يتم العثور على معدة بهذا الباركود")),!1)}function qt(t,{showFeedback:e=!0}={}){const n=xe(t);return n?rt(n,{silent:!e}):(e&&E(l("maintenance.toast.equipmentNotFoundName","❌ لم يتم العثور على معدة بالاسم المدخل")),!1)}function lt(){const t=document.getElementById("maintenance-equipment-options"),e=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=ct(),s=vt();if(t){const c=l("maintenance.form.blockedSuffix","(صيانة)");t.innerHTML=a.map(r=>{const i=r.status==="صيانة"||s.has(r.barcode)?`${r.desc} ${c}`:r.desc,f=r.desc.replace(/"/g,"&quot;"),m=i.replace(/"/g,"&quot;");return`<option value="${f}" label="${m}"></option>`}).join("")}const o=document.getElementById("maintenance-selected-barcode");if(o&&o.value){const c=G(o.value);!c||X(c)?(L({keepInputs:!0,silent:!0}),c&&X(c)&&E(l("maintenance.toast.equipmentBecameBlocked","⚠️ هذه المعدة أصبحت قيد الصيانة ولا يمكن اختيارها"))):rt(c,{silent:!0})}else L({keepInputs:!0,silent:!0});if(e&&!e.dataset.listenerAttached&&(e.addEventListener("keydown",c=>{c.key==="Enter"&&(c.preventDefault(),Lt(e.value)||L({keepInputs:!0,silent:!0}))}),e.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached){const c=()=>{if(!n.value){L({keepInputs:!0,silent:!0});return}qt(n.value)||L({keepInputs:!0,silent:!0})};n.addEventListener("change",c),n.addEventListener("keydown",r=>{r.key==="Enter"&&(r.preventDefault(),c())}),n.dataset.listenerAttached="true"}}function dt(t,e){const n=k(t),{equipment:a=[]}=M(),s=(a||[]).map(o=>k(o==null?void 0:o.barcode)===n?{...o,status:e}:o);Kt({equipment:s}),Qt(),et(),lt()}function Me(t){const e=document.getElementById("maintenance-stats");if(!e)return;const n=H.length,a=H.filter(i=>i.status==="open").length,s=n-a,o=i=>g(String(i)),c=l("maintenance.stats.open","{count} قيد الصيانة").replace("{count}",`<strong>${o(a)}</strong>`),r=l("maintenance.stats.closed","{count} مغلقة").replace("{count}",`<strong>${o(s)}</strong>`),u=l("maintenance.stats.total","{count} إجمالي التذاكر").replace("{count}",`<strong>${o(n)}</strong>`);e.innerHTML=`
    <span class="maintenance-stat">${c}</span>
    <span class="maintenance-stat">${r}</span>
    <span class="maintenance-stat">${u}</span>
  `}function Ce(t){const e=document.getElementById("maintenance-table-body"),n=document.getElementById("maintenance-empty-state");if(e){if(!t||t.length===0){const a=l("maintenance.table.emptyFiltered","لا توجد تذاكر ضمن هذا الفلتر.");e.innerHTML=`<tr><td colspan="6" class="text-muted text-center">${a}</td></tr>`,n&&n.classList.add("active");return}n&&n.classList.remove("active"),e.innerHTML=t.map(a=>{const s=l("maintenance.status.open","قيد الصيانة"),o=l("maintenance.status.closed","مغلقة"),c=a.status==="open"?`<span class="badge bg-warning text-dark">${s}</span>`:`<span class="badge bg-success">${o}</span>`,r=(()=>{const O=l("maintenance.priority.high","مرتفعة"),Y=l("maintenance.priority.medium","متوسطة"),C=l("maintenance.priority.low","منخفضة");switch(a.priority){case"high":return`<span class="badge bg-danger">${O}</span>`;case"low":return`<span class="badge bg-secondary">${C}</span>`;default:return`<span class="badge bg-info text-dark">${Y}</span>`}})(),u=[],i=l("maintenance.actions.close","🔧 إغلاق بعد الإصلاح"),f=l("maintenance.actions.view","👁️ عرض التقرير"),m=l("maintenance.actions.delete","🗑️ حذف التذكرة");a.status==="open"?u.push(`<button class="btn btn-sm btn-success" data-action="close" data-id="${a.id}">${i}</button>`):u.push(`<button class="btn btn-sm btn-warning" data-action="view" data-id="${a.id}">${f}</button>`),u.push(`<button class="btn btn-sm btn-danger" data-action="delete" data-id="${a.id}">${m}</button>`);const d=u.join(""),y=l("maintenance.table.noBarcode","بدون باركود"),S=l("maintenance.report.none","—"),w=a.equipmentBarcode?g(a.equipmentBarcode):y,h=a.issue?g(a.issue):S,T=a.createdAt?g(R(a.createdAt)):"—";return`
        <tr>
          <td>
            <strong>${a.equipmentDesc}</strong><br>
            <small class="text-muted">${w}</small>
          </td>
          <td class="maintenance-issue-text">${h}</td>
          <td>${r}</td>
          <td>${T}</td>
          <td>${c}</td>
          <td class="table-actions-cell">
            <div class="table-action-buttons">
              ${d}
            </div>
          </td>
        </tr>
      `}).join("")}}function De(t){const e=t.target.closest("button[data-action]");if(!e)return;const n=e.getAttribute("data-action"),a=Number(e.getAttribute("data-id"));a&&(n==="close"?xt(a):n==="view"?Mt(a):n==="delete"&&Ct(a))}function xt(t){const e=v(),n=e.findIndex(o=>Number(o.id)===Number(t));if(n===-1)return;const a=prompt(l("maintenance.prompt.closeReport","أدخل تقرير الإصلاح / الإجراءات المتخذة:"));if(a===null)return;const s={...e[n]};s.status="closed",s.resolutionReport=a.trim(),s.resolvedAt=new Date().toISOString(),e[n]=s,st(e),dt(s.equipmentBarcode,"متاح"),E(l("maintenance.toast.ticketClosed","✅ تم إغلاق تذكرة الصيانة وإعادة المعدة إلى الحالة المتاحة")),x()}function Mt(t){const n=v().find(d=>Number(d.id)===Number(t));if(!n)return;const a=l("maintenance.report.equipment","المعدة"),s=l("maintenance.report.barcode","الباركود"),o=l("maintenance.report.issue","الوصف"),c=l("maintenance.report.createdAt","تاريخ الإنشاء"),r=l("maintenance.report.closedAt","تاريخ الإغلاق"),u=l("maintenance.report.summary","التقرير"),i=l("maintenance.report.notAvailable","غير متوفر"),f=l("maintenance.report.none","—"),m=[`${a}: ${n.equipmentDesc}`,`${s}: ${n.equipmentBarcode?g(n.equipmentBarcode):i}`,`${o}: ${n.issue?g(n.issue):f}`,`${c}: ${n.createdAt?g(R(n.createdAt)):f}`,`${r}: ${n.resolvedAt?g(R(n.resolvedAt)):f}`,`${u}: ${n.resolutionReport?g(n.resolutionReport):f}`].join(`
`);alert(m)}function Ct(t){const e=v(),n=e.findIndex(s=>Number(s.id)===Number(t));if(n===-1)return;const a=e[n];confirm(l("maintenance.toast.ticketDeleteConfirm","⚠️ هل أنت متأكد من حذف تذكرة الصيانة؟"))&&(e.splice(n,1),st(e),a.status==="open"&&dt(a.equipmentBarcode,"متاح"),E(l("maintenance.toast.ticketDeleted","🗑️ تم حذف تذكرة الصيانة")),x())}function Dt(t){t.preventDefault();try{const e=document.getElementById("maintenance-equipment-barcode"),n=document.getElementById("maintenance-equipment-search"),a=document.getElementById("maintenance-selected-barcode"),s=document.getElementById("maintenance-issue"),o=document.getElementById("maintenance-priority");let c=N,r=k(a==null?void 0:a.value);if(!c&&r&&(c=G(r)),!c&&(e!=null&&e.value)&&Lt(e.value,{showFeedback:!0})&&(c=N,r=k(c==null?void 0:c.barcode)),!c&&(n!=null&&n.value)&&qt(n.value,{showFeedback:!0})&&(c=N,r=k(c==null?void 0:c.barcode)),!c||!r){E(l("maintenance.toast.selectEquipment","⚠️ يرجى اختيار المعدة"));return}const{equipment:u=[]}=M();let i=(u||[]).find(T=>k(T==null?void 0:T.barcode)===r);if(!i&&c&&(i={barcode:c.barcode,desc:c.desc,name:c.desc,status:c.status||"متاح"}),!i){E(l("maintenance.toast.selectedNotFound","❌ لم يتم العثور على المعدة المختارة")),L();return}if(i.status==="صيانة"){E(l("maintenance.toast.equipmentAlreadyMaintenance","⚠️ هذه المعدة بالفعل في حالة صيانة"));return}if(v().filter(T=>T.status==="open").some(T=>k(T.equipmentBarcode)===r)){E(l("maintenance.toast.ticketExists","⚠️ توجد تذكرة صيانة مفتوحة لهذه المعدة"));return}const d=l("maintenance.table.noName","بدون اسم"),y={id:Date.now(),equipmentBarcode:r,equipmentDesc:i.desc||i.description||i.name||d,issue:(s==null?void 0:s.value.trim())||"",priority:(o==null?void 0:o.value)||"medium",status:"open",createdAt:new Date().toISOString(),resolutionReport:"",resolvedAt:null},S=v(),w=[y,...S];st(w),dt(r,"صيانة"),E(l("maintenance.toast.ticketCreated","🛠️ تم إنشاء تذكرة الصيانة وإيقاف المعدة")),L(),s&&(s.value=""),o&&(o.value="medium");const h=document.getElementById("maintenance-status-filter");h&&(h.value="all"),x()}catch(e){console.error("❌ [maintenance] Failed to create ticket",e),E(l("maintenance.toast.submitError","⚠️ تعذر إنشاء تذكرة الصيانة. يرجى المحاولة مجدداً."))}}function Ne(t){const e=v();return t==="all"?e:e.filter(n=>n.status===t)}function x(){v(),lt();const t=document.getElementById("maintenance-status-filter");t&&!t.value&&(t.value="all");const e=(t==null?void 0:t.value)||"all",n=Ne(e);Me(),Ce(n)}function Ae(){v(),lt(),x();const t=document.getElementById("maintenance-form");t&&!t.dataset.listenerAttached&&(t.addEventListener("submit",Dt),t.dataset.listenerAttached="true");const e=document.getElementById("maintenance-status-filter");e&&!e.dataset.listenerAttached&&(e.addEventListener("change",()=>{x()}),e.dataset.listenerAttached="true");const n=document.querySelector(".maintenance-table");n&&!n.dataset.listenerAttached&&(n.addEventListener("click",De),n.dataset.listenerAttached="true")}v();document.addEventListener("language:changed",()=>{const t=document.getElementById("maintenance-selected-barcode"),e=document.getElementById("maintenance-selected-info");if(t!=null&&t.value){const n=G(t.value);n?Bt(n):e&&(e.textContent=Z())}else e&&(e.textContent=Z());x()});document.addEventListener("submit",t=>{const e=t.target;(e==null?void 0:e.id)==="maintenance-form"&&!e.dataset.listenerAttached&&Dt(t)});document.addEventListener("click",t=>{const e=t.target.closest("button[data-action]");if(!e||!e.closest(".maintenance-table"))return;const n=e.dataset.action,a=Number(e.dataset.id);a&&(n==="close"?xt(a):n==="view"?Mt(a):n==="delete"&&Ct(a))});const Et="dashboard-active-tab",tt="dashboard-active-sub-tab",A={get(t){try{return localStorage.getItem(t)}catch(e){return console.warn("⚠️ [tabs.js] localStorage.getItem failed",{key:t,error:e}),null}},set(t,e){try{localStorage.setItem(t,e)}catch(n){console.warn("⚠️ [tabs.js] localStorage.setItem failed",{key:t,value:e,error:n})}},remove(t){try{localStorage.removeItem(t)}catch(e){console.warn("⚠️ [tabs.js] localStorage.removeItem failed",{key:t,error:e})}}};function Re(){var c;console.log("🚀 [tabs.js] setupTabs()");const t=document.querySelectorAll("[data-tab]"),e=document.querySelectorAll(".tab");console.log("📌 tabButtons:",t),console.log("📌 tabContents:",e);const n=(r,{skipStore:u=!1}={})=>{if(!r)return;const i=document.querySelector(`[data-tab="${r}"]`),f=document.getElementById(r);!i||!f||(t.forEach(m=>m.classList.remove("active")),i.classList.add("active"),e.forEach(m=>{const d=m.id===r;m.style.display=d?"block":"none",m.classList.toggle("active",d)}),u||A.set(Et,r),r==="customers-tab"&&(console.log("👤 Rendering customers"),Xt()),r==="equipment-tab"&&(console.log("📦 Rendering equipment"),et()),r==="maintenance-tab"&&(console.log("🛠️ Rendering maintenance"),x()),r==="technicians-tab"&&(console.log("🛠️ Rendering technicians"),ne()),r==="reservations-tab"&&(console.log("📅 Rendering reservations"),nt(),Fe()))};t.forEach(r=>{r.addEventListener("click",()=>{const u=r.getAttribute("data-tab");console.log("🖱️ Tab clicked:",u),n(u),u!=="reservations-tab"&&A.remove(tt)})});const a=A.get(Et),s=document.querySelector("[data-tab].active"),o=a&&document.getElementById(a)?a:s==null?void 0:s.getAttribute("data-tab");o&&(console.log("⭐ Initial tab:",o),n(o,{skipStore:!!a})),(c=document.body)==null||c.classList.remove("tabs-loading")}function Fe(){console.log("🚀 [tabs.js] setupSubTabs()");const t=document.querySelectorAll(".sub-tab-button"),e=document.querySelectorAll(".sub-tab");console.log("📌 subTabButtons:",t),console.log("📌 subTabContents:",e);const n=(c,{skipStore:r=!1}={})=>{if(!c)return;const u=document.querySelector(`.sub-tab-button[data-sub-tab="${c}"]`),i=document.getElementById(c);!u||!i||(t.forEach(f=>f.classList.remove("active")),u.classList.add("active"),e.forEach(f=>{f.classList.remove("active")}),i.classList.add("active"),r||A.set(tt,c),c==="my-reservations-tab"?(console.log("📋 Rendering reservations list"),setTimeout(()=>{nt()},50)):c==="calendar-tab"?(console.log("📅 Rendering calendar view"),setTimeout(()=>{at()},100)):c==="reports-tab"&&(console.log("📊 Rendering reports view"),setTimeout(()=>{le()},50)))};t.forEach(c=>{c.addEventListener("click",()=>{const r=c.getAttribute("data-sub-tab");console.log("🖱️ Sub-tab clicked:",r),n(r)})});const a=A.get(tt),s=document.querySelector(".sub-tab-button.active"),o=a&&document.getElementById(a)?a:s==null?void 0:s.getAttribute("data-sub-tab");o&&(console.log("⭐ Initial sub-tab:",o),n(o,{skipStore:!!a})),St()}Ut();function $t(){var n;zt(),Re(),Wt(),et(),at(),Ae(),Jt(),St(),nt();const t=document.getElementById("excel-upload");t&&t.addEventListener("change",async a=>{const s=a.target.files&&a.target.files[0];s&&(await Zt(s),a.target.value="")});const e=document.getElementById("excel-upload-trigger");e&&t&&e.addEventListener("click",a=>{a.preventDefault(),t.click()}),(n=document.getElementById("logout-btn"))==null||n.addEventListener("click",Gt),He(),Pe()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",$t,{once:!0}):$t();function He(){document.querySelectorAll('input[type="datetime-local"]').forEach(t=>{t.addEventListener("input",()=>{const e=t.value;if(!e.includes("T"))return;const[n,a]=e.split("T"),[s]=a.split(":"),o=`${s.padStart(2,"0")}:00`,c=`${n}T${o}`;t.value!==c&&(t.value=c,setTimeout(()=>t.blur(),150))})})}function Pe(){const t=M(),e=localStorage.getItem("pendingReservationEditId"),n=localStorage.getItem("pendingReservationEdit");let a=null;if(e!==null){const o=(t.reservations||[]).findIndex(c=>String(c.id)===e||String(c.reservationId)===e);o!==-1&&(a=o),localStorage.removeItem("pendingReservationEditId")}if(a===null&&n!==null){const s=Number(n);Number.isNaN(s)||(a=s),localStorage.removeItem("pendingReservationEdit")}a===null||Number.isNaN(a)||setTimeout(()=>{const s=document.querySelector('[data-tab="reservations-tab"]');s==null||s.click(),setTimeout(()=>{var o;(o=document.querySelector('.sub-tab-button[data-sub-tab="create-tab"]'))==null||o.click(),setTimeout(()=>{const c=window.editReservation;typeof c=="function"&&c(a)},150)},150)},150)}
