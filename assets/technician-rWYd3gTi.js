import{r as K,n as g,t as r,g as B,a as O,c as Q,i as W,l as G}from"./auth-CNAfl19F.js";import{l as J}from"./storage-DOnDLvtb.js";import{a as M,b as _,c as X}from"./controller-DfdUmPnp.js";import"./projects-B5HGRUVy.js";import{g as U,s as Z}from"./reservationsSummary-CBdNx1nm.js";import"./events-BbKR8R1v.js";K({ar:{"technicianDetails.pageTitle":"معلومات عضو الطاقم","technicianDetails.title":"😎 بيانات عضو الطاقم","technicianDetails.actions.back":"⬅️ العودة","technicianDetails.actions.edit":"✏️ تعديل عضو الطاقم","technicianDetails.filters.search":"🔍 ابحث باسم العميل أو رقم الحجز...","technicianDetails.fields.role":"👔 الوظيفة:","technicianDetails.fields.department":"🧩 القسم:","technicianDetails.fields.phone":"📞 الجوال:","technicianDetails.fields.wage":"💰 الأجر اليومي:","technicianDetails.fields.baseStatus":"⚙️ الحالة الأساسية:","technicianDetails.fields.notes":"📝 الملاحظات:","technicianDetails.fallback.name":"—","technicianDetails.fallback.role":"غير محدد","technicianDetails.fallback.department":"—","technicianDetails.fallback.notes":"—","technicianDetails.errors.missingId":"⚠️ لا يوجد معرف عضو طاقم في الرابط.","technicianDetails.errors.notFound":"⚠️ لم يتم العثور على هذا العضو.","technicianDetails.edit.modalTitle":"✏️ تعديل بيانات عضو الطاقم","technicians.picker.actions.apply":"تم","technicianProjects.title":"📁 مشاريع مرتبطة بالطاقم","technicianProjects.empty":"لا توجد مشاريع مرتبطة بهذا العضو."},en:{"technicianDetails.pageTitle":"Crew Member Details","technicianDetails.title":"😎 Crew Member Profile","technicianDetails.actions.back":"⬅️ Back","technicianDetails.actions.edit":"✏️ Edit Crew Member","technicianDetails.filters.search":"🔍 Search by client or reservation ID...","technicianDetails.fields.role":"👔 Role:","technicianDetails.fields.department":"🧩 Department:","technicianDetails.fields.phone":"📞 Phone:","technicianDetails.fields.wage":"💰 Daily Rate:","technicianDetails.fields.baseStatus":"⚙️ Base Status:","technicianDetails.fields.notes":"📝 Notes:","technicianDetails.fallback.name":"—","technicianDetails.fallback.role":"Not specified","technicianDetails.fallback.department":"—","technicianDetails.fallback.notes":"—","technicianDetails.errors.missingId":"⚠️ Missing crew member identifier in the URL.","technicianDetails.errors.notFound":"⚠️ Crew member not found.","technicianDetails.edit.modalTitle":"✏️ Edit Crew Member","technicians.picker.actions.apply":"Done","technicianProjects.title":"📁 Crew Projects","technicianProjects.empty":"No projects are linked to this crew member."}});let L={},D={initialized:!1,currentId:null};function x(e=""){return g(String(e)).trim().toLowerCase()}function ee(e,a,t){if(!a||!t)return;const{startDate:n,endDate:i}=_(e);a._flatpickr?n?a._flatpickr.setDate(n,!1,"Y-m-d"):a._flatpickr.clear():a.value=n||"",t._flatpickr?i?t._flatpickr.setDate(i,!1,"Y-m-d"):t._flatpickr.clear():t.value=i||""}function te(e){if(!document.getElementById("technician-reservations"))return;const t=document.getElementById("technician-search-reservation"),n=document.getElementById("technician-filter-start-date"),i=document.getElementById("technician-filter-end-date"),c=document.getElementById("technician-reservation-date-range"),l=document.getElementById("technician-reservation-status-filter"),h=document.getElementById("technician-clear-filters");window.flatpickr&&(n&&window.flatpickr(n,{dateFormat:"Y-m-d"}),i&&window.flatpickr(i,{dateFormat:"Y-m-d"}));const w=()=>{let p=g((n==null?void 0:n.value)||"").trim(),b=g((i==null?void 0:i.value)||"").trim(),d=(c==null?void 0:c.value)||"";if(new Set(["","today","week","month"]).has(d)||(d="",c&&(c.value=""),n&&(n._flatpickr&&n._flatpickr.clear(),n.value=""),i&&(i._flatpickr&&i._flatpickr.clear(),i.value=""),p="",b=""),!p&&!b&&d){const{startDate:v,endDate:T}=_(d);p=v,b=T}const u=(t==null?void 0:t.value)||"",m=x(u);return{searchTerm:m,searchReservationId:m,searchCustomerName:m,startDate:p,endDate:b,status:(l==null?void 0:l.value)||"",quickRange:d,technicianId:e}},o=()=>{L=w(),M("technician-reservations",L)};t&&!t.dataset.listenerAttached&&(t.addEventListener("input",()=>{t.value=g(t.value),o()}),t.dataset.listenerAttached="true"),n&&!n.dataset.listenerAttached&&(n.addEventListener("change",()=>{c&&(c.value=""),o()}),n.dataset.listenerAttached="true"),i&&!i.dataset.listenerAttached&&(i.addEventListener("change",()=>{c&&(c.value=""),o()}),i.dataset.listenerAttached="true"),c&&!c.dataset.listenerAttached&&(c.addEventListener("change",()=>{ee(c.value,n,i),o()}),c.dataset.listenerAttached="true"),l&&!l.dataset.listenerAttached&&(l.addEventListener("change",o),l.dataset.listenerAttached="true"),h&&!h.dataset.listenerAttached&&(h.addEventListener("click",()=>{t&&(t.value=""),n&&(n._flatpickr&&n._flatpickr.clear(),n.value=""),i&&(i._flatpickr&&i._flatpickr.clear(),i.value=""),c&&(c.value=""),l&&(l.value=""),o()}),h.dataset.listenerAttached="true"),window.refreshTechnicianReservationsViews=()=>{M("technician-reservations",L)},o()}function V(e){D.currentId=e;const{container:a}=S();a&&(D.initialized||(ne(),document.addEventListener("projects:changed",()=>{D.currentId&&y()}),document.addEventListener("language:changed",()=>{D.currentId&&y()}),document.addEventListener("customers:changed",()=>{D.currentId&&y()}),document.addEventListener("technicians:updated",()=>{D.currentId&&y()}),D.initialized=!0),y())}function S(){return{container:document.getElementById("technician-projects"),searchInput:document.getElementById("technician-project-search"),statusSelect:document.getElementById("technician-project-status-filter"),clearBtn:document.getElementById("technician-projects-clear-filters")}}function ne(){const{searchInput:e,statusSelect:a,clearBtn:t}=S();e&&!e.dataset.listenerAttached&&(e.addEventListener("input",()=>{e.value=g(e.value),y()}),e.dataset.listenerAttached="true"),a&&!a.dataset.listenerAttached&&(a.addEventListener("change",()=>{y()}),a.dataset.listenerAttached="true"),t&&!t.dataset.listenerAttached&&(t.addEventListener("click",()=>{const{searchInput:n,statusSelect:i}=S();n&&(n.value=""),i&&(i.value=""),y()}),t.dataset.listenerAttached="true")}function y(){const{container:e,searchInput:a,statusSelect:t}=S();if(!e||!D.currentId)return;const n=x((a==null?void 0:a.value)||""),i=(t==null?void 0:t.value)||"",{projects:c=[],customers:l=[],technicians:h=[]}=J(),w=new Map(l.map(s=>[String(s.id),s])),o=new Map(h.map(s=>[String(s.id),s])),p=String(D.currentId),d=c.filter(s=>Array.isArray(s.technicians)&&s.technicians.some(u=>String(u)===p)).filter(s=>{var u;if(n){const m=((u=w.get(String(s.clientId)))==null?void 0:u.customerName)||"";if(!x([s.title,s.description,m].filter(Boolean).join(" ")).includes(n))return!1}return!(i&&z(s)!==i)}).sort((s,u)=>{const m=new Date(s.start||s.createdAt||0).getTime();return new Date(u.start||u.createdAt||0).getTime()-m});if(!d.length){const s=r("technicianProjects.empty",e.dataset.empty||"لا توجد مشاريع مرتبطة بهذا العضو.");e.innerHTML=`<div class="col-12"><div class="alert alert-info text-center mb-0">${s}</div></div>`;return}e.innerHTML=d.map(s=>ae(s,w,o)).join("")}function ae(e,a,t){var N;const n=z(e),i=r(`projects.status.${n}`,ie[n]),c=se[n]||"bg-secondary",l=(e.description||"").trim(),h=f(l?le(l,140):r("projects.fallback.noDescription","No description")),w=(e.title||"").trim()||r("projects.fallback.untitled","Untitled project"),o=Array.isArray(e.technicians)?e.technicians:[],p=o.length,b=r("projectCards.stats.crew","👥 Crew members: {count}").replace("{count}",g(String(p))),d=o.map(P=>{var E;return(E=t.get(String(P)))==null?void 0:E.name}).filter(Boolean);let s="";if(d.length){const E=d.slice(0,2),j=d.length-E.length,Y=B()==="ar"?"، ":", ",q=E.join(Y);s=`${f(q)}${j>0?f(` +${g(String(j))}`):""}`}const u=((N=a.get(String(e.clientId)))==null?void 0:N.customerName)||r("projects.fallback.unknownClient","Unknown client"),m=r("projectCards.stats.client","👤 Client: {name}").replace("{name}",u),v=re(e),T=(Number(e.equipmentEstimate)||0)+v,I=r("projectCards.stats.budget","💰 Estimated budget: {amount}").replace("{amount}",F(T)),C=v>0?r("projectCards.stats.expenses","💸 Expenses: {amount}").replace("{amount}",F(v)):"";return`
    <div class="col-12 col-md-6 col-xl-4">
      <div class="box h-100 project-card">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <h5 class="mb-1">${f(w)}</h5>
            <span class="text-muted small">${f(ce(e.start,e.end))}</span>
          </div>
          <span class="badge ${c} text-white">${f(i)}</span>
        </div>
        <p class="text-muted small mb-3">${h}</p>
        <div class="d-flex flex-column gap-1 small text-muted">
          <span>${f(m)}</span>
          <span>${f(b)}</span>
          ${s?`<span>👥 ${s}</span>`:""}
          <span>${f(I)}</span>
          ${C?`<span>${f(C)}</span>`:""}
        </div>
      </div>
    </div>
  `}const ie={upcoming:"Upcoming",ongoing:"In Progress",completed:"Completed"},se={upcoming:"bg-info",ongoing:"bg-warning",completed:"bg-success"};function z(e){const a=new Date,t=e.start?new Date(e.start):null,n=e.end?new Date(e.end):null;return t&&!Number.isNaN(t.getTime())&&t>a?"upcoming":n&&!Number.isNaN(n.getTime())&&n<a?"completed":"ongoing"}function ce(e,a){if(!e)return"—";const t=R(e);return a?`${t} - ${R(a)}`:t}function R(e){if(!e)return"—";const a=new Date(e);if(Number.isNaN(a.getTime()))return"—";const n=B()==="ar"?"ar-SA":"en-GB",i=new Intl.DateTimeFormat(n,{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"});return g(i.format(a))}function F(e){const a=Number(e)||0,t=B(),n=t==="ar"?"ar-SA":"en-US",i=new Intl.NumberFormat(n,{minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.round(a)),c=t==="ar"?"ر.س":"SAR";return`${g(i)} ${c}`}function re(e){return typeof e.expensesTotal=="number"?e.expensesTotal:Array.isArray(e.expenses)?e.expenses.reduce((a,t)=>a+(Number(t.amount)||0),0):0}function le(e,a){return e?e.length<=a?e:`${e.slice(0,a).trim()}…`:""}function f(e=""){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;")}O();Q();const oe=new URLSearchParams(window.location.search),k=oe.get("id"),A=document.getElementById("technician-details");window.showReservationDetails=X;W();const $=document.getElementById("logout-btn");$&&!$.dataset.listenerAttached&&($.addEventListener("click",()=>G()),$.dataset.listenerAttached="true");function de(e){const a=Number(e??0);return Number.isFinite(a)?a.toLocaleString("en-US",{minimumFractionDigits:0,maximumFractionDigits:2}):"0"}function H(e){const a=e.name||r("technicianDetails.fallback.name","—"),t=e.status==="busy"?"technicians.status.busy":"technicians.status.available",i=`
        <span class="badge ${e.status==="busy"?"bg-danger":"bg-success"}" data-i18n data-i18n-key="${t}">
          ${r(t)}
        </span>
      `,c=e.phone?g(e.phone):`<span data-i18n data-i18n-key="reservations.details.technicians.phoneUnknown">${r("reservations.details.technicians.phoneUnknown","غير متوفر")}</span>`,l=e.role?e.role:`<span data-i18n data-i18n-key="technicianDetails.fallback.role">${r("technicianDetails.fallback.role","غير محدد")}</span>`,h=e.department?e.department:`<span data-i18n data-i18n-key="technicianDetails.fallback.department">${r("technicianDetails.fallback.department","—")}</span>`,w=e.notes?e.notes:`<span data-i18n data-i18n-key="technicianDetails.fallback.notes">${r("technicianDetails.fallback.notes","—")}</span>`,p=`<span data-i18n data-i18n-key="reservations.create.summary.currency">${r("reservations.create.summary.currency","ريال")}</span>`,b=`${de(e.dailyWage)} ${p}`,s=(e.baseStatus||e.status||"available")==="busy"?"technicians.status.busy":"technicians.status.available",u=`<span data-i18n data-i18n-key="${s}">${r(s)}</span>`,m=r("technicianDetails.actions.edit","✏️ تعديل عضو الطاقم"),v=[{key:"technicianDetails.fields.role",value:l},{key:"technicianDetails.fields.department",value:h},{key:"technicianDetails.fields.phone",value:c},{key:"technicianDetails.fields.wage",value:b},{key:"technicianDetails.fields.baseStatus",value:u},{key:"technicianDetails.fields.notes",value:w}].map(({key:T,value:I})=>`
        <p class="technician-detail-row">
          <strong data-i18n data-i18n-key="${T}">${r(T)}</strong>
          <span>${I}</span>
        </p>
      `).join("");A.innerHTML=`
        <div class="technician-details">
          <div class="d-flex align-items-center gap-2 technician-header">
            <h3 class="mb-0 technician-name">${a}</h3>
            ${i}
          </div>
          <div class="technician-details-body">
            ${v}
          </div>
          <div class="d-flex justify-content-start mt-3 gap-2">
            <button type="button" class="btn btn-warning" id="edit-technician-btn" data-i18n data-i18n-key="technicianDetails.actions.edit">${m}</button>
          </div>
        </div>
      `}function ue(){if(!k){A.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.missingId">${r("technicianDetails.errors.missingId","⚠️ لا يوجد معرف عضو طاقم في الرابط.")}</p>`;return}Z();const e=U(k);if(!e)A.innerHTML=`<p class="text-danger" data-i18n data-i18n-key="technicianDetails.errors.notFound">${r("technicianDetails.errors.notFound","⚠️ لم يتم العثور على هذا العضو.")}</p>`;else{H(e),te(k),V(k);const a=document.getElementById("edit-technician-btn");a&&(a.onclick=()=>{var n;const t=document.getElementById("editTechnicianModal");document.dispatchEvent(new CustomEvent("technician:prefill",{detail:e})),t&&((n=window.bootstrap)!=null&&n.Modal)&&window.bootstrap.Modal.getOrCreateInstance(t).show()})}}document.addEventListener("technicians:updated",()=>{if(!k)return;const e=U(k);if(!e)return;H(e),typeof window.refreshTechnicianReservationsViews=="function"&&window.refreshTechnicianReservationsViews(),V(k);const a=document.getElementById("edit-technician-btn");a&&e&&(a.onclick=()=>{var n;const t=document.getElementById("editTechnicianModal");document.dispatchEvent(new CustomEvent("technician:prefill",{detail:e})),t&&((n=window.bootstrap)!=null&&n.Modal)&&window.bootstrap.Modal.getOrCreateInstance(t).show()})});ue();
