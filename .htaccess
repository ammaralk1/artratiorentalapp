RewriteEngine On

# Remove www and always redirect to HTTPS
RewriteCond %{HTTP_HOST} ^www\.art-ratio\.com$ [NC]
RewriteRule ^ https://art-ratio.com%{REQUEST_URI} [L,R=301]

# Force HTTPS for the bare domain
RewriteCond %{HTTP_HOST} ^art-ratio\.com$ [NC]
RewriteCond %{HTTPS} off
RewriteRule ^ https://art-ratio.com%{REQUEST_URI} [L,R=301]

# Catch-all HTTPS redirect (covers any other host variations)
RewriteCond %{HTTPS} !=on
RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Serve clean URLs for the built static assets and pages.
RewriteRule ^assets/(.*)$ dist/assets/$1 [L,NC]
RewriteRule ^js/(.*)$ dist/js/$1 [L,NC]

RewriteRule ^(dashboard|home|login|customer|technician|projects|projects-reports|projects-expenses|users)(?:\.html)?/?$ dist/src/pages/$1.html [L,NC]
RewriteRule ^$ dist/src/pages/login.html [L]

Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
Header always set X-Content-Type-Options "nosniff"
Header always set X-Frame-Options "SAMEORIGIN"

<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresDefault "access plus 4 hours"
  ExpiresByType text/css "access plus 7 days"
  ExpiresByType text/javascript "access plus 7 days"
  ExpiresByType application/javascript "access plus 7 days"
  ExpiresByType application/json "access plus 1 day"
  ExpiresByType application/xml "access plus 1 day"
  ExpiresByType image/svg+xml "access plus 30 days"
  ExpiresByType image/png "access plus 30 days"
  ExpiresByType image/jpeg "access plus 30 days"
  ExpiresByType image/webp "access plus 30 days"
  ExpiresByType font/woff "access plus 30 days"
  ExpiresByType font/woff2 "access plus 30 days"
</IfModule>

<IfModule mod_headers.c>
  <FilesMatch "\.(css|js|json|xml|svg|png|jpe?g|webp|woff2?)$">
    Header set Cache-Control "public, max-age=604800, immutable"
  </FilesMatch>
</IfModule>

<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE text/plain text/css application/javascript text/javascript application/json application/xml image/svg+xml
  <IfModule mod_setenvif.c>
    BrowserMatch ^Mozilla/4 gzip-only-text/html
    BrowserMatch ^Mozilla/4\.0[678] no-gzip
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
  </IfModule>
  <IfModule mod_headers.c>
    Header append Vary Accept-Encoding
  </IfModule>
</IfModule>

# Serve the canonical CSP from the web server so that frame-ancestors is enforced.
# Keep any fallback <meta http-equiv="Content-Security-Policy"> definitions aligned,
# but omit frame-ancestors there to avoid browser warnings.
<IfModule mod_headers.c>
  Header always set Content-Security-Policy "default-src 'self' blob:; script-src 'self' https://cdn.jsdelivr.net https://img1.wsimg.com 'sha256-94H6wmHzcbPXq0z+knAQNqjjdZFteAhu/+clJVBM808='; connect-src 'self' https://art-ratio.com https://*.art-ratio.com https://cdn.jsdelivr.net https://img1.wsimg.com https://csp.secureserver.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com; img-src 'self' data: blob: https://art-ratio.com https://*.art-ratio.com https://cdn.jsdelivr.net https://img1.wsimg.com https://*.sirv.com; font-src 'self' https://fonts.gstatic.com data:; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'self'; frame-src 'self'; worker-src 'self' blob:; upgrade-insecure-requests;"
</IfModule>
